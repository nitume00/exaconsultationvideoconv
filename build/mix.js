/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "../build/";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = 0);
/******/ })
/************************************************************************/
/******/ ({

/***/ "./app/scripts/app.js":
/*!****************************!*\
  !*** ./app/scripts/app.js ***!
  \****************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


__webpack_require__(/*! ../views/header.html */ "./app/views/header.html");
__webpack_require__(/*! ../views/footer.html */ "./app/views/footer.html");


angular.module('abs', [
        'ngResource',
        'ui.router.state',
        'ui.router',
        'ui.bootstrap',
        'ngSanitize',
        'satellizer',
        'ngAnimate',
	    'ngCookies',
		'sdk',		
    ])
 
    .config(['$locationProvider', function($locationProvider) {
        $locationProvider.html5Mode(false).hashPrefix('!');
    }])
    .config(function($stateProvider, $urlRouterProvider) {
   
    $urlRouterProvider.otherwise('/');
        $stateProvider.state('home', {
            url: '/',
            templateUrl: '../app/views/home.html',
            controller: 'HomeController',
    
        });


    }) ;


angular.module('abs')
.controller('HomeController', function($scope, $rootScope, $window, $filter, $state, $cookies, $location) {
        $scope.init = function () {
        };

        $scope.radioChecked = function (value) {
            $scope.placeholder= value;
            $scope.doctor= '';
            $scope.clinical_name= '';
        };
        $scope.init();
 
        $scope.specialty_id = null;
        $scope.city_id = null;
        $scope.state_id = null;
        $scope.insurance_id = null;
        $scope.doctor = null;
        $scope.search_field = 'doctor';
        
})
.controller('MainController', function($rootScope, $scope, $window, $cookies, $state, $location, $filter) {
        $rootScope.isAuth = false;
    
        $rootScope.cdate = new Date();
  
		$rootScope.rbchat = function () {
			$state.go('DoctorChat');                      
		};
		$rootScope.rbvideo = function () {
			$state.go('DoctorVideo');                      
		};	
    }
);



     

/***/ }),

/***/ "./app/views/footer.html":
/*!*******************************!*\
  !*** ./app/views/footer.html ***!
  \*******************************/
/*! no static exports found */
/***/ (function(module, exports) {

// Module
var code = "<!--footer section start-->\n<footer id=\"js-footer-hide-section\">\n    <div class=\"footer\">\n        <div class=\"container\">\n            <!-- bottom Banner start-->\n            <div banner position=\"bottomBanner\" ng-class=\"{'bottomBanner':search_footer}\">\n                <!-- bottom Banner end-->\n                <div class=\"row footer-menu\">\n                    <div class=\"col-md-2 col-sm-3\">\n                        <ul class=\"list-unstyled\">\n                            <h5 class=\" text-uppercase\">{{'Company Info' | translate}}</h5>\n                            <li>\n                                <a href=\"pages/2/about-us\" title=\"{{'About Us' | translate}}\">{{'About Us' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/12/customer-stories\" title=\"{{'Customer Stories' |translate}}\">{{'Customer Stories' |translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/7/faq\" title=\"{{'Faq' | translate}}\">{{'Faq' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/4/press\" title=\"{{'Press' | translate}}\">{{'Press' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/13/careers\" title=\"{{'Careers' | translate}}\">{{'Careers' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/8/blog\" title=\"{{'Blog' | translate}}\">{{'Blog' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/6/help\" title=\"{{'Help' | translate}}\">{{'Help' | translate}}</a>\n                            </li>\n                        </ul>\n                    </div>\n\n                    <div class=\"col-md-3 col-sm-4\">\n                        <ul class=\"list-unstyled\">\n                            <h5 class=\"text-uppercase\" title=\"{{'Legal' | translate}}\">{{'Legal' | translate}}</h5>\n                            <li>\n                                <a href=\"pages/10/terms-and-conditions\" title=\"{{'Terms and Conditions' | translate}}\">{{'Terms and Conditions' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/3/privacy-policy\" title=\"{{'Privacy Policy' | translate}}\">{{'Privacy Policy' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/16/service-providing-policy\" title=\"{{'Service Providing Policy' | translate}}\">{{'Service Providing Policy' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/14/refund-policy\" title=\"{{'Refund/Return Policy' | translate}}\">{{'Refund/Return Policy' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"pages/15/cancellation-policy\" title=\"{{'Cancellation Policy' | translate}}\">{{'Cancellation Policy' | translate}}</a>\n                            </li>\n                        </ul>\n                    </div>\n                    <div class=\"col-md-3 col-sm-4\">\n                        <ul class=\"list-unstyled\">\n                            <h5 class=\"text-uppercase\">{{'Browser Specialisations' | translate}}</h5>\n                            <li>\n                                <a href=\"search?search_field=doctor&city_id={{city_id}}\" title=\"{{'Find a Doctor' | translate}}\">{{'Find a Doctor' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"search?search_field=clinic&city_id={{city_id}}\" title=\"{{'Find a Hospital/Clinic' | translate}}\">{{'Find a Hospital/Clinic' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"search?search_field=doctor&city_id={{city_id}}\" title=\"{{'Find a Specialty' | translate}}\">{{'Find a Specialty' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"search?search_field=doctor&city_id={{city_id}}\" title=\"{{'Online Appoinment' | translate}}\">{{'Online Appoinment' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"search?search_field=doctor&city_id={{city_id}}\" title=\"{{'Corporate Wellness' | translate}}\">{{'Corporate Wellness' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"search?search_field=doctor&city_id={{city_id}}\" title=\"{{'Health Packages' | translate}}\">{{'Health Packages' | translate}}</a>\n                            </li>\n                            <li>\n                                <a href=\"search?search_field=doctor&city_id={{city_id}}\" title=\"{{'Special Hospital/Clinics' | translate}}\">{{'Special Hospital/Clinics' | translate}}</a>\n                            </li>\n                        </ul>\n                    </div>\n                    <div class=\"col-md-4 col-sm-5\">\n                        <ul class=\"list-inline\">\n                            <h5 class=\"connect text-uppercase\">{{'Connect With Us' | translate}}</h5>\n                            <li>\n                                <a href=\"{{settings.FOLLOW_FACEBOOK_URL}}\" target=\"_blank\" ng-if=\"settings.SITE_FACEBOOK_URL\">\n                                    <span class=\"fa-stack fa-2x\">\n                                        <i class=\"fa fa-circle fa-stack-2x\"></i>\n                                        <i class=\"fa fa-facebook fa-stack-1x fa-inverse\" title=\"facebook\"></i>\n                                    </span>\n                                </a>\n                            </li>\n                            <li>\n                                <a title=\"Twitter\" ng-if=\"settings.FOLLOW_TWITTER_URL\" href=\"{{settings.SITE_TWITTER_URL}}\" target=\"_blank\">\n                                    <span class=\"fa-stack fa-2x\">\n                                        <i class=\"fa fa-circle fa-stack-2x\"></i>\n                                        <i class=\"fa fa-twitter fa-stack-1x fa-inverse\" title=\"twitter\"></i>\n                                    </span>\n                                </a>\n                            </li>\n                            <li>\n                                <a title=\"Google+\" ng-if=\"settings.FOLLOW_GOOGLE_PLUS_URL\" href=\"{{settings.SITE_GOOGLEPLUS_URL}}\" target=\"_blank\">\n                                    <span class=\"fa-stack fa-2x\">\n                                        <i class=\"fa fa-circle fa-stack-2x\"></i>\n                                        <i class=\"fa fa-google-plus fa-stack-1x fa-inverse\" title=\"google-plus\"></i>\n                                    </span>\n                                </a>\n                            </li>\n                            <li>\n                                <a title=\"LinkedIn\" ng-if=\"settings.FOLLOW_LINKEDIN_URL\" href=\"{{settings.SITE_LINKEDIN_URL}}\" target=\"_blank\">\n                                    <span class=\"fa-stack fa-2x\">\n                                        <i class=\"fa fa-circle fa-stack-2x\"></i>\n                                        <i class=\"fa fa-linkedin fa-stack-1x fa-inverse\" title=\"linkedin\"></i>\n                                    </span>\n                                </a>\n                            </li>\n                            <li>\n                                <a title=\"YouTube\" ng-if=\"settings.FOLLOW_YOUTUBE_URL\" href=\"{{settings.SITE_YOUTUBE_URL}}\" target=\"_blank\">\n                                    <span class=\"fa-stack fa-2x\">\n                                        <i class=\"fa fa-circle fa-stack-2x\"></i>\n                                        <i class=\"fa fa-youtube fa-stack-1x fa-inverse\" title=\"YouTube\"></i>\n                                    </span>\n                                </a>\n                            </li>\n                        </ul>\n                        <div class=\"row\">\n                            <div class=\"col-md-9 col-sm-10\">\n                                <h5 class=\"text-uppercase\">{{'Get The App' | translate}}</h5>\n                                <div class=\"row\">\n                                    <div class=\"col-md-6\">\n                                        <a href=\"https://apps.apple.com/us/app/kwikmed/id1478495985?ls=1\" target=\"_blank\">\n                                            <img src=\"/app/images/applestore.png\" class=\"img-responsive\" alt=\"Image\" title=\"{{'Download on the Apple Store' | translate}}\">\n                                        </a>\n                                    </div>\n                                    <div class=\"col-md-6\">\n                                        <a href=\"https://play.google.com/store/apps/details?id=com.app.quickmed\" target=\"_blank\">\n                                            <img src=\"/app/images/playstore.png\" class=\"img-responsive\" alt=\"Image\" title=\"{{'ANDROID APP ON the Google Play' | translate}}\">\n                                        </a>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <hr>\n                <p class=\"text-center\">{{'Copyright'| translate}} <i class=\"fa fa-copyright\" aria-hidden=\"true\"></i> {{settings.SITE_NAME}} . {{cdate | date:'yyyy'}}\n                \n                <a\n                href=\"/\" title=\"{{$root.settings['settings.SITE_NAME']}}\" class=\"\">{{settings.SITE_NAME}}</a>, {{'All rights reserved.'|translate}}</p>\n            </div>\n        </div>\n    </div>\n</footer>";
// Exports
var _module_exports = code;;
var path = 'app/views/footer.html';
window.angular.module('ng').run(['$templateCache', function(c) { c.put(path, _module_exports) }]);
module.exports = path;

/***/ }),

/***/ "./app/views/header.html":
/*!*******************************!*\
  !*** ./app/views/header.html ***!
  \*******************************/
/*! no static exports found */
/***/ (function(module, exports) {

// Module
var code = "<header ng-class=\"{'afer-login': model.isAuthenticated()}\">\n    <!-- Navigation -->\n    <nav class=\"navbar header navbar-fixed-top\">\n        <div class=\"container-fluid\">\n            <!-- Brand and toggle get grouped for better mobile display -->\n            <a class=\"navbar-brand\" href=\"/app\">\n                <img src=\"/app/images/logo.png\" title=\"{{settings.SITE_NAME}}\" alt=\"{{settings.SITE_NAME}}\">\n            </a>\n            <div class=\"navbar-header page-scroll header-logo\">\n                <button type=\"button\" class=\"navbar-toggle x collapsed\" data-toggle=\"collapse\" data-target=\"#bs-example-navbar-collapse-1\"\n                    id=\"js-header-hide-section-btn\">\n                    <span class=\"sr-only\">Toggle navigation</span>\n                    <span class=\"icon-bar\"></span>\n                    <span class=\"icon-bar\"></span>\n                    <span class=\"icon-bar\"></span>\n                </button>\n            </div>\n            <!-- Collect the nav links, forms, and other content for toggling -->\n            <div class=\"collapse navbar-collapse\" id=\"bs-example-navbar-collapse-1\">\n                <!--START:NAVBAR-LEFT--> <!--ng-if=\"isAuth && $root.auth.role_id == $root.ConstUserType.User\"-->\n                <ul class=\"nav navbar-nav navbar-left\">\n                    <li class=\"nav-item dropdown\">\n                        <a class=\"nav-link dropdown-toggle text-uppercase\" href=\"#\" id=\"navbarDropdown\" role=\"button\" data-toggle=\"dropdown\" aria-haspopup=\"true\"\n                            aria-expanded=\"false\">\n                            {{'Our Services'| translate }}\n                            <i class=\"fa fa-angle-down\" aria-hidden=\"true\"></i>\n                        </a>\n                        <ul class=\"dropdown-menu\" aria-labelledby=\"navbarDropdown\">\n                            <li>\n                                <a class=\"dropdown-item\" href=\"search?search_field=doctor\" title=\"  {{' Book a Doctor / Hospital/Clinic' | translate}}\">\n                                    {{'Book an Appointment' | translate}}\n                                </a>\n                            </li>\n                            <li>\n                                <a class=\"dropdown-item\" href=\"search?search_field=diagnostic\">\n                                    {{'Book a Test' | translate}}\n                                </a>\n                            </li>\n                        </ul>\n                    </li>\n                    <li>\n                        <a href=\"pages/17/read-articles\" title=\"{{'READ ARTICLES' | translate}}\" class=\"text-uppercase read-article\">{{'Read Articles' | translate}}</a>\n                    </li>\n                    <li ng-if=\"isAuth && ($root.auth.role_id == $root.ConstUserType.Clinic || $root.auth.role_id == $root.ConstUserType.Hospital || $root.auth.role_id == $root.ConstUserType.Diagnostic)\">\n                        <a href=\"subscribe/plans\" title=\"{{'Subscription Plans' | translate}}\" class=\"text-uppercase read-article\">{{'Subscription Plans' | translate}}</a>\n                    </li>\n                    <li ng-if=\"isAuth && $root.auth.role_id == $root.ConstUserType.Doctor\">\n                        <a href=\"verify/proof\" title=\"{{'Get Verified' | translate}}\" class=\"text-uppercase read-article\">{{'Get Verified' | translate}}</a>\n                    </li>\n                </ul>\n                <!--END:NAVBAR-LEFT-->\n\n                <!--START:NAVBA-RIGHT-->\n                <ul class=\"nav navbar-nav navbar-right\" id=\"js-header-hide-section\">\n                    <li>\n                        <a class=\"btn  btn-default download text-uppercase\" title=\"{{'DOWNLOAD MOBILE APP' | translate}}\">\n                            <img src=\"/app/images/phone.png\" alt=\"[phone]\" class=\"pull-left\">\n                            <span>{{'Download' | translate}}</span>\n                            <span class=\"mob help-block\">{{'Mobile App' | translate}}</span>\n                        </a>\n                    </li>\n                    <!-- <li ng-if=\"!isAuth\">\n                        <a href=\"users/register/pharmacy\" class=\"btn btn-outline-success bars text-center text-uppercase\" type=\"button\">\n                            <span class=\"block\">{{'Become a' | translate}}</span>\n                            <span class=\"block\">{{'Pharmacy!' | translate}}</span>\n                        </a>\n                    </li> -->\n                    <li class=\"nav-item dropdown\" ng-if=\"!isAuth\">\n                        <a class=\"btn btn-outline-success dropdown-toggle bar\" href=\"#\" id=\"navbarDropdown\" role=\"button\" data-toggle=\"dropdown\"\n                            aria-haspopup=\"true\" aria-expanded=\"false\">\n                            <img src=\"/app/images/user-add.png\" alt=\"[user-log]\"> {{'Sign In / Sign Up' | translate}}\n                        </a>\n                        <div class=\"dropdown-menu \" aria-labelledby=\"navbarDropdown\">\n                            <div class=\"dropdown-item\">\n                                <form class=\"user-login-form\" role=\"form\" name=\"userLogin\" ng-submit=\"login(userLogin.$valid)\" novalidate>\n                                    <div class=\"form-group email row\" ng-class=\"{ 'has-error' : (userLogin.$submitted || userLogin.email.$touched) && (userLogin.email.$pristine)}\">\n                                        <div class=\"col-sm-12\">\n                                            <input type=\"text\" class=\"form-control\" placeholder=\"Email\" name=\"email\" ng-model=\"email\"\n                                                ng-required=\"true\" ng-pattern=\"/^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$/\">\n                                            <span class=\"error\" ng-show=\"userLogin.email.$error.pattern\">\n                                                {{'Enter correct email' | translate}} </span>\n                                            <span class=\"error\" ng-show=\"(userLogin.$submitted || userLogin.email.$touched) && (userLogin.email.$pristine || userLogin.email.$invalid) && (userLogin.email.$error.required)\">\n                                                {{'Required' | translate}}</span>\n                                        </div>\n                                    </div>\n                                    <div class=\"form-group\">\n                                        <input type=\"password\" ng-model=\"password\" class=\"form-control\" id=\"inputPassword3\" placeholder=\"{{'Password'|translate}}\"\n                                            autocomplete=\"off\" name=\"inputPassword3\" ng-minlength=\"6\" required>\n                                        <span class=\"error\" ng-show=\"(userLogin.$submitted || userLogin.inputPassword3.$touched) && (userLogin.inputPassword3.$pristine || userLogin.inputPassword3.$invalid) && (userLogin.inputPassword3.$error.required)\">{{'Required'| translate }}</span>\n                                        <span class=\"error\" ng-show=\"(userLogin.$submitted || userLogin.inputPassword3.$touched) && (userLogin.inputPassword3.$pristine || userLogin.inputPassword3.$invalid) && (userLogin.inputPassword3.$error.minlength)\">{{'Must have at least 6 characters'| translate }}</span>\n                                    </div>\n                                    <div class=\"form-group\">\n                                        <input type=\"checkbox\" id=\"keep-me-signed-in\">\n                                        <label for=\"keep-me-signed-in\"> {{'keep me signed in' | translate}} </label>\n                                        <button type=\"submit\" class=\"btn btn-primary btn-xs text-right\" ng-disabled=\"save_btn\">{{'Sign in'|translate}}</button>\n                                    </div>\n                                </form>\n\n                                <div class=\"patients\">\n                                    <div class=\"row\">\n                                        <div class=\"col-sm-9\">\n                                            <span class=\"text-uppercase\">{{'Client' | translate}}</span>\n                                            <span class=\"help-block text-capitalize\">\n                                                <a href=\"users/login\">{{'Sign In' | translate}} / </a>\n                                                <a href=\"users/register/patient\">{{'Sign Up' | translate}}</a>\n                                            </span>\n                                        </div>\n                                        <div class=\"col-sm-2\">\n                                            <img src=\"/app/images/patient.png\" alt=\"[hospital-2]\">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class=\"doctors\">\n                                    <div class=\"row\">\n                                        <div class=\"col-sm-9\">\n                                            <span class=\"text-uppercase\">{{'Doctors' | translate}}</span>\n                                            <span class=\"help-block text-capitalize\">\n                                                <a href=\"users/login\">{{'Sign In' | translate}} / </a>\n                                                <a href=\"users/register/doctor\">{{'Sign Up' | translate}}</a>\n                                            </span>\n                                        </div>\n                                        <div class=\"col-sm-2\">\n                                            <img src=\"/app/images/doctor-nav.png\" alt=\"[hospital-2]\">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class=\"clinics\">\n                                    <div class=\"row\">\n                                        <div class=\"col-sm-9\">\n                                            <span class=\"text-uppercase\">{{'Hospital/Clinics' | translate}}</span>\n                                            <span class=\"help-block text-capitalize\">\n                                                <a href=\"users/login\">{{'Sign In' | translate}} / </a>\n                                                <a href=\"users/register/clinic\">{{'Sign Up' | translate}}</a>\n                                            </span>\n                                        </div>\n                                        <div class=\"col-sm-2\">\n                                            <img src=\"/app/images/chemical-nav.png\" alt=\"[hospital-2]\">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class=\"diagnostics\">\n                                    <div class=\"row\">\n                                        <div class=\"col-sm-9\">\n                                            <span class=\"text-uppercase\">{{'Diagnostics Center' | translate}}</span>\n                                            <span class=\"help-block text-capitalize\">\n                                                <a href=\"users/login\">{{'Sign In' | translate}}/</a>\n                                                <a href=\"users/register/diagnostic\">{{'Sign Up' | translate}}</a>\n                                            </span>\n                                        </div>\n                                        <div class=\"col-sm-2\">\n                                            <img src=\"/app/images/hospital-devices.png\" alt=\"[hospital-devices]\">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                    </li>\n                    <li class=\"nav-item dropdown\" ng-if=\"$root.auth.role_id != $root.ConstUserType.SubAccount\">\n                        <dashboard-settings></dashboard-settings>\n                    </li>\n                    <li class=\"nav-item dropdown\" ng-if=\"$root.auth.role_id == $root.ConstUserType.SubAccount\">\n                        <subaccount-settings></subaccount-settings>\n                    </li>\n                    <li ng-translate-language-select></li> \n                    \n                    <li>\n                        <div class=\"dropdown\" id=\"final-tog\">\n                            <button class=\"btn btn-default dropdown-toggle\" type=\"button\" data-toggle=\"dropdown\" aria-expanded=\"\">\n                                <img src=\"/app/images/toggle.png\" alt=\"[toggle-on]\">\n                            </button>\n                            <ul class=\"dropdown-menu\" id=\"tog-drop\">\n                                <li>\n                                    <a href=\"#\">{{ 'Customer Care' | translate }}</a>\n                                    <span class=\"help-block\">\n                                        <i class=\"fa fa-phone\" aria-hidden=\"true\"></i>{{settings.SITE_CONTACT_NUMBER}}</span>\n                                    <span class=\"help-block\">\n                                        <i class=\"fa fa-envelope-o\" aria-hidden=\"true\"></i>{{settings.SITE_CONTACT_EMAIL}}</span>\n                                </li>\n                                <li>\n                                    <a href=\"pages/18/help\">{{ 'Advertise with us' | translate }}</a>\n                                </li>\n                                <li>\n                                    <a href=\"contactus\">{{ 'Help with us' | translate }}</a>\n                                </li>\n                                <li>\n                                    <a href=\"pages/7/faq\"> {{' FAQ ' | translate }}'{{'s' | translate }} </a>\n                                </li>\n                            </ul>\n                        </div>\n                    </li>\n                </ul>\n                <!--END:NAVBA-RIGHT-->\n                </div>\n                <!-- /.navbar-collapse -->\n            </div>\n        </div>\n        <!-- /.container-fluid -->\n    </nav>\n    <!--<div subscription-alert ></div>-->\n</header>";
// Exports
var _module_exports = code;;
var path = 'app/views/header.html';
window.angular.module('ng').run(['$templateCache', function(c) { c.put(path, _module_exports) }]);
module.exports = path;

/***/ }),

/***/ "./copyres.js":
/*!********************!*\
  !*** ./copyres.js ***!
  \********************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

function requireAll(r) { r.keys().forEach(r); }
requireAll(__webpack_require__("./video/res sync recursive ^\\.\\/.*$"));

/***/ }),

/***/ "./node_modules/css-loader/dist/cjs.js!./video/src/videostyles.css":
/*!*************************************************************************!*\
  !*** ./node_modules/css-loader/dist/cjs.js!./video/src/videostyles.css ***!
  \*************************************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

// Imports
var ___CSS_LOADER_API_IMPORT___ = __webpack_require__(/*! ../../node_modules/css-loader/dist/runtime/api.js */ "./node_modules/css-loader/dist/runtime/api.js");
exports = ___CSS_LOADER_API_IMPORT___(false);
// Module
exports.push([module.i, "html {\n    height: 100%;\n}\n\nbody {\n\theight: 100%;\n\tmargin-top: 65px;\n\tfont-family: 'Open Sans';\n\tbackground: #f1f1f1;\n}\n\n.app-banner {\n\theight: 48px;\n\twidth: 100%;\n\tbackground: #F44336;\n\tdisplay: flex;\n\tflex-wrap: wrap;\n}\n\n.app-banner-logo {\n\tposition: relative;\n\tmargin-top: 8px;\n\tmargin-left: 8px;\n\twidth: 32px;\n}\n\n.app-banner-title {\n    line-height: 48px;\n    margin-left: 8px;\n    font-size: 12px;\n    color: #eee;\t\n}\n\n.app-banner-copyright {\n  \tline-height: 48px;\n    margin-left: auto;\n    margin-right: 8px;\n    font-size: 12px;\n    color: #eee;\n    align-self: stretch;\n}\n\n.app-container {\n    margin-left: 10px;\n    margin-right: 220px;\n    height: calc(100% - 30px);\n}\n\n.app-user {\n\tfloat: right;\n\twidth: 200px;\n}\n\n\r\ndiv.connectionCmp-area {\n    position: relative;\n    overflow: hidden;\n    border: 1px solid #E9E9E9;\n    margin-top: 5px;\n\tmargin-right: 0px;\n    background: #fff;\n    padding: 4px;\n}\n\ndiv.connectionCmp-title {\n    width: 100%;\n    text-align: center;\n    font-size: 12px;\n    height: 24px;\n    line-height: 24px;\n    background: #9e9e9e;\n    font-weight: 700;\n    color: #eee;\n}\n\nform.connectionCmp-form {\n    position: relative;\n    padding: 8px;\n    border-radius: 4px;\n    height: 170px;\n    text-align: center;\n}\n\nbutton.connectionCmp-btn {\n    margin-top: 3px;\n    border: none;\n    width: 79px;\n    height: 30px;\n    line-height: 30px;\n    text-align: center;\n    border-radius: 6px;\n    font-size: 11px;\n    font-weight: 300;\n}\n\nbutton.connectionCmp-btn:enabled {\n    color: white;\n    background: #0087cf;\n    cursor: pointer;\n}\n\nbutton.connectionCmp-btn:disabled {\n    color: white;\n    background: #656565;\n}\n\ninput#username, input#password {\n    margin-bottom: 5px;\n    width: 153px;\n    height: 24px;\n    padding: 5px;\n    border: 1px solid rgba(73, 98, 171, 0.22);\n    color: #656565;\n    background: #FBFBFB;\n    -webkit-transition: all 0.30s ease-in-out;\n    transition: all 0.30s ease-in-out;\n    border-radius: 6px;\n}\n\nselect#host {\n    margin-bottom: 5px;\n    width: 164px;\n    height: 34px;\n    padding: 5px;\n    border: 1px solid rgba(73, 98, 171, 0.22);\n    color: #656565;\n    background: #FBFBFB;\n    -webkit-transition: all 0.30s ease-in-out;\n    transition: all 0.30s ease-in-out;\n    border-radius: 6px;   \n}\n\ndiv.connectionCmp-state {\n    margin-bottom: 8px;\n    font-size: 10px;\n    color: #666;\n}\n\nb.connectionCmp-state-value {\n    color: #009688;\n}\n\ndiv.connectionCmp-state-result {\n    margin: 0 auto;\n    width: 100%;\n    text-align: center;\n}\n\nimg.connectionCmp-loader {\n    margin-top: 3px;\n}\n\r\ndiv.contactCmp-area {\n    position: relative;\n    overflow: hidden;\n    border: 1px solid #E9E9E9;\n    margin-top: 5px;\n    margin-right: 0px;\n    background: #fff;\n    padding: 4px;\n}\n\ndiv.contactmp-border {\n    margin: 24px auto;\n    border: 1px solid #32799f;\n    max-width: 800px;\n}\n\ndiv.contactCmp-header {\n    height: 64px;\n    display: flex;\n    border-bottom: 1px solid #32799f;\n}\n\ndiv.contactCmp-title {\n    width: 100%;\n    text-align: center;\n    font-size: 12px;\n    height: 24px;\n    line-height: 24px;\n    background: #9e9e9e;\n    font-weight: 700;\n    color: #eee;\n}\n\ndiv.contactCmp-recipient-area {\n    position: relative;\n    padding: 8px;\n    border-radius: 4px;\n    height: auto;\n    text-align: center;\n}\n\n.contactCmp-recipient-presence {\n    width: 128px;\n    margin: 6px auto;\n    height: 28px;\n    border-radius: 4px;\n}\n\n.contactCmp-recipient-presence-available {\n    background: #4CAF50;\n    color: #fff;   \n}\n\n.contactCmp-recipient-presence-busy {\n    background: #ff5722;\n    color: #fff;   \n}\n\n.contactCmp-recipient-presence-notAvailable {\n    background: #9e9e9e;\n    color: #fff;   \n}\n\n.contactCmp-recipient-photo {\n    height: 128px;\n    width: 128px;\n    background-color: #eee;\n    border-radius: 4px;\n    display: block;\n    margin: 6px auto;\n    border: 2px solid #ddd;\n\n}\n\n.contactCmp-recipient-select {\n    margin-bottom: 5px;\n    width: 164px;\n    height: 34px;\n    padding: 5px;\n    border: 1px solid rgba(73, 98, 171, 0.22);\n    color: #656565;\n    background: #FBFBFB;\n    -webkit-transition: all 0.30s ease-in-out;\n    transition: all 0.30s ease-in-out;\n    border-radius: 6px;   \n}\n\n.contactCmp-recipient-btn {\n    border: none;\n    text-align: center;\n    border-radius: 6px;\n    font-size: 12px;\n    font-weight: 400;\n}\n.contactCmp-recipient-btn:enabled {\n    cursor: pointer;\n}\n\n.contactCmp-recipient-btn:disabled {\n    cursor: not-allowed;\n}\n\r\ndiv.controllerCmp-area {\n    position: relative;\n    overflow: hidden;\n    border: 1px solid #E9E9E9;\n    margin-top: 5px;\n    margin-right: 0px;\n    background: #fff;\n    height: 630px;\n}\n\ndiv.controllerCmp-border {\n    width: 100%;\n    height: 100%;\n}\n\ndiv.controllerCmp-header {\n    height: 64px;\n    display: flex;\n    border-bottom: 1px solid #32799f;\n}\n\ndiv.controllerCmp-title {\n    width: 100%;\n    text-align: center;\n    font-size: 12px;\n    height: 24px;\n    line-height: 24px;\n    background: #9e9e9e;\n    font-weight: 700;\n    color: #eee;\n}\n\n.controllerCmp-webrtc-video {\n   position: absolute;\n    top: -50%;\n    left: -50%;\n    width: 200%;\n    height: 200%;\n}\n\n.controllerCmp-webrtc-bar {\n    text-align: center;\n    position: absolute;\n    z-index: 3;\n    bottom: 10px;\n    width: 100%;\n}\n\n.controllerCmp-webrtc-topbar {\n    text-align: right;\n    position: absolute;\n    z-index: 3;\n    top: 12px;\n    right: 8px;\n}\n\n.controllerCmp-webrtc-area {\n    height: 100%;\n    width: 100%;\n}\n\n.controllerCmp-btn {\n    cursor: pointer;\n    width: 44px;\n    margin: 0 6px;\n}\n\n.controllerCmp-btn-topbar {\n    cursor: pointer;\n    width: 44px;\n    margin: 0 6px 0 0;\n    height: 44px;\n    border-radius: 22px;\n    background-color: #0085ca;\n    color: #fff;\n    border: 1px solid #ddd;;\n}\n\n.controllerCmp-btn-topbar-icon {\n    font-size: 20px;\n    font-weight: 500;\n}\n\n#largevideo {\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    right: 0;\n    left: 0;\n    margin: auto;\n    min-height: 50%;\n    min-width: 50%;\n}\n\n#minivideo {\n    position: relative;\n    width: auto;\n    height: 12%;\n    transform: scale(-1, 1);\n    z-index: 2;\n    margin-left: calc(25% + 12px);\n    top: calc(25% + 12px);\n    border-radius: 3px;\n}\n\ndiv.controllerCmp-deviceChecker {\n    position: relative;\n    width: 200px;\n    text-align: center;\n    height: 100px;\n    background-color: #9e9e9e;\n    margin: 50px auto;\n    padding: 12px;\n    color: #fff;\n    font-size: 12px;\n    border-radius: 4px;\n}\n\ndiv.controllerCmp-deviceTitle {\n    font-weight: bold;\n    font-size: 14px;\n}\n\ndiv.controllerCmp-deviceSubtitle {\n    margin-top: 16px;\n}\n\n.controllerCmp-info {\n    font-size: 12px;\n    font-weight: 500;\n    color: #fff;\n}\n\n.controllerCmp-buttons-area {\n    background-color: #000;\n    width: 178px;\n    height: 44px;\n    margin: 0 auto;\n    padding: 8px 6px;\n    border-radius: 25px;\n}\n\n\n\r\ndiv.mediaCmp-area {\n    position: relative;\n    overflow: hidden;\n    border: 1px solid #E9E9E9;\n    margin-top: 5px;\n    margin-right: 0px;\n    background: #fff;\n    padding: 4px;\n}\n\ndiv.mediaCmp-title {\n    width: 100%;\n    text-align: center;\n    font-size: 12px;\n    height: 24px;\n    line-height: 24px;\n    background: #9e9e9e;\n    font-weight: 700;\n    color: #eee;\n}\n\nform.mediaCmp-form {\n    position: relative;\n    padding: 8px;\n    border-radius: 4px;\n    height: 180px;\n    text-align: center;\n}\n\nselect.mediaCmp-select {\n    margin-bottom: 5px;\n    width: 164px;\n    height: 34px;\n    padding: 5px;\n    border: 1px solid rgba(73, 98, 171, 0.22);\n    color: #656565;\n    background: #FBFBFB;\n    -webkit-transition: all 0.30s ease-in-out;\n    transition: all 0.30s ease-in-out;\n    border-radius: 6px;   \n}\n\nlabel.mediaCmp-label {\n    font-size: 11px;\n    color: #656565;\n}\r\n\n#canvasSound {\n    display: block;\n    margin: 0 auto;\n    padding: 6px;\n    text-align: right;\n    position: absolute;\n    z-index: 3;\n    border: 1px solid #fff;\n    background-color: #000;\n    opacity: 0.75;\n    bottom: 30px;\n    left: 24px;\n}\n.conversationsCmp-area {\n    display: flex;\n    flex-flow: row wrap;\n}\n\ndiv.conversationCmp-area {\n    position: relative;\n    overflow: hidden;\n    border: 1px solid #E9E9E9;\n    margin-top: 5px;\n    margin-left: 0px;\n    background: #fff;\n    padding: 4px;\n}\n\ndiv.conversationCmp-recipient {\n    margin: 8px;\n}\n\ndiv.conversationCmp-title {\n    width: 100%;\n    text-align: center;\n    font-size: 12px;\n    height: 24px;\n    line-height: 24px;\n    background: #9e9e9e;\n    font-weight: 700;\n    color: #eee;\n}\n\ndiv.conversationCmp-state {\n    margin-bottom: 8px;\n    margin-bottom: 16px;\n    font-size: 10px;\n    color: #666;\n}\n\nb.conversationCmp-state-value {\n    color: #009688;\n}\n\ndiv.conversationCmp-state-result {\n    margin: 0 auto;\n    width: 100%;\n    text-align: center;\n}\n\ndiv.conversationCmp-messages {\n    margin: 8px;\n    height: 550px;\n    overflow-y: auto;\n    overflow-x: hidden;\n}\n\n.conversationCmp-editor {\n    margin: 10px 8px 5px 8px;\n   \n    height: 16px;\n    padding: 5px;\n    border: 1px solid rgba(73, 98, 171, 0.22);\n    color: #656565;\n    background: #FBFBFB;\n    -webkit-transition: all 0.30s ease-in-out;\n    transition: all 0.30s ease-in-out;\n    border-radius: 6px;\n}\n\n.messageCmp-content {\n\tfont-size: 10px;\n}\n\n.messageCmp-timestamp {\n\tmargin-top: 8px;\n\tfont-size: 9px;\n}\n\n.messageCmp-area-L {\n\tbackground: #0085ca;\n    color: #fff;\n    max-width: 66%;\n    border-radius: 4px;\n    padding: 4px;\n    margin-bottom: 10px;\n}\n\n.messageCmp-area-R {\n\tbackground: #efefef;\n\tcolor: #46464a;\n    max-width: 66%;\n    border-radius: 4px;\n    padding: 4px;\n    margin-bottom: 10px;\n    margin-left:auto; \n    margin-right:0;\n}\n\n", ""]);
// Exports
module.exports = exports;


/***/ }),

/***/ "./node_modules/css-loader/dist/runtime/api.js":
/*!*****************************************************!*\
  !*** ./node_modules/css-loader/dist/runtime/api.js ***!
  \*****************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


/*
  MIT License http://www.opensource.org/licenses/mit-license.php
  Author Tobias Koppers @sokra
*/
// css base code, injected by the css-loader
// eslint-disable-next-line func-names
module.exports = function (useSourceMap) {
  var list = []; // return the list of modules as css string

  list.toString = function toString() {
    return this.map(function (item) {
      var content = cssWithMappingToString(item, useSourceMap);

      if (item[2]) {
        return "@media ".concat(item[2], " {").concat(content, "}");
      }

      return content;
    }).join('');
  }; // import a list of modules into the list
  // eslint-disable-next-line func-names


  list.i = function (modules, mediaQuery, dedupe) {
    if (typeof modules === 'string') {
      // eslint-disable-next-line no-param-reassign
      modules = [[null, modules, '']];
    }

    var alreadyImportedModules = {};

    if (dedupe) {
      for (var i = 0; i < this.length; i++) {
        // eslint-disable-next-line prefer-destructuring
        var id = this[i][0];

        if (id != null) {
          alreadyImportedModules[id] = true;
        }
      }
    }

    for (var _i = 0; _i < modules.length; _i++) {
      var item = [].concat(modules[_i]);

      if (dedupe && alreadyImportedModules[item[0]]) {
        // eslint-disable-next-line no-continue
        continue;
      }

      if (mediaQuery) {
        if (!item[2]) {
          item[2] = mediaQuery;
        } else {
          item[2] = "".concat(mediaQuery, " and ").concat(item[2]);
        }
      }

      list.push(item);
    }
  };

  return list;
};

function cssWithMappingToString(item, useSourceMap) {
  var content = item[1] || ''; // eslint-disable-next-line prefer-destructuring

  var cssMapping = item[3];

  if (!cssMapping) {
    return content;
  }

  if (useSourceMap && typeof btoa === 'function') {
    var sourceMapping = toComment(cssMapping);
    var sourceURLs = cssMapping.sources.map(function (source) {
      return "/*# sourceURL=".concat(cssMapping.sourceRoot || '').concat(source, " */");
    });
    return [content].concat(sourceURLs).concat([sourceMapping]).join('\n');
  }

  return [content].join('\n');
} // Adapted from convert-source-map (MIT)


function toComment(sourceMap) {
  // eslint-disable-next-line no-undef
  var base64 = btoa(unescape(encodeURIComponent(JSON.stringify(sourceMap))));
  var data = "sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(base64);
  return "/*# ".concat(data, " */");
}

/***/ }),

/***/ "./node_modules/rainbow-web-sdk/src/rainbow-sdk.min.js":
/*!*************************************************************!*\
  !*** ./node_modules/rainbow-web-sdk/src/rainbow-sdk.min.js ***!
  \*************************************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
var rainbowSDK=function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=423)}([function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Call=void 0;const rxjs_1=__webpack_require__(10);class Call{constructor(status,id,type,contact){this.isVm=!1,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.isError=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.subject=void 0,this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!0,this.relevantEquipmentId="unknown",this.deviceId=null,this.isOwner=void 0,this.pbxConnectionDown=void 0,this.isMuted=!1,this.duration=0,this.durationTimer=null,this.unifiedPlanActivated=!1,this.globalCallId=null,this.correlatorData=null,this.activeControl=!1,this.hasRemoteControlling=!1,this.networkQuality=0,this.sipWiseData=null,this.errorMessage=null,this.lastCause=null,this.rxSubject=new rxjs_1.Subject,this.status=status,this.type=type,this.id=id,this.conversationId=null,this.connectionId=null,this.isVm=null,this.contact=contact,this.remoteMedia=0,this.localMedia=0,this.isEscalated=!1,this.startDate=new Date,this.isInitiator=!1,this.participants=null,this.isRemoteVideoMuted=!1,this.isConference=!1,this.avatars=contact&&contact.avatar?[this.contact.avatar.src]:[],this.subject=void 0,this.currentCalled={contactPhoneNumber:"",contact:null,participantsPhoneNumbers:[],participants:[]},this.fullJid="",this.mediaPillarCall=null,this.isSecondary=!1,this.relevant=!1,this.relevantEquipmentId="unknown",this.deviceId=null,this.isOwner=void 0,this.pbxConnectionDown=void 0,this.isMuted=!1,this.duration=0,this.statusInfo=null,this.globalCallId=void 0,this.correlatorData=void 0,this.activeControl=!1,this.hasRemoteControlling=!1,this.networkQuality=0,this.sipWiseData={initCause:"",direction:"",called:{phoneNumber:"",displayName:""}}}static create(status,id,type,contact){return new Call(status,id,type,contact)}setCallId(id){this.id=id}getGlobalCallId(id){return this.globalCallId}setGlobalCallId(id){this.globalCallId=id}setConversationId(conversationId){this.conversationId=conversationId}setStatus(status){this.status=status}setCorrelatorData(correlatorData){this.correlatorData=correlatorData}setType(type){this.type=type}setIsVm(isVM){this.isVm=isVM}setContact(contact){this.contact=contact,this.avatars=[this.contact.avatar.src]}getCurrentCalled(){return this.currentCalled}setSubject(subject){this.subject=subject}setCurrentCalledContactNumber(number){this.currentCalled.contactPhoneNumber=number}setRelevantEquipmentId(relevantEquipmentId){this.relevantEquipmentId=relevantEquipmentId}setParticipants(participants){this.participants=participants,this.avatars=[];this.participants.forEach(participant=>{this.avatars.push(participant.avatar.src)})}setConnectionId(connectionId){this.connectionId=connectionId,this.id=Call.getIdFromConnectionId(connectionId)}isInConversationWithMobile(){return!!this.fullJid&&(-1!==this.fullJid.indexOf("mobile_android")||-1!==this.fullJid.indexOf("mobile_ios"))}isInConversationWithDesktopApp(){return!!this.fullJid&&-1!==this.fullJid.indexOf("desk_")}setCurrentCalled(currentCalled){currentCalled?this.contact&&this.contact.id?(this.currentCalled.contactPhoneNumber=currentCalled.contactPhoneNumber&&""!==currentCalled.contactPhoneNumber?currentCalled.contactPhoneNumber:"",this.currentCalled.contact=currentCalled.contact?currentCalled.contact:null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=currentCalled.participantsPhoneNumbers&&currentCalled.participantsPhoneNumbers.length>0?currentCalled.participantsPhoneNumbers:null,this.currentCalled.participants=currentCalled.participants&&currentCalled.participants.length>0?currentCalled.participants:null):(this.currentCalled.contactPhoneNumber="",this.currentCalled.contact=null,this.currentCalled.participantsPhoneNumbers=null,this.currentCalled.participants=null)}static getIdFromConnectionId(connectionId){return connectionId}static getCallIdFromConnectionId(connectionId){return connectionId?connectionId.split("#")[0]:null}static getDeviceIdFromConnectionId(connectionId){var deviceId=connectionId?connectionId.split("#")[1]:null;return deviceId||null}isMediaPillarCall(){return null!==this.mediaPillarCall}getMediaPillarCall(){return this.mediaPillarCall}setMediaPillarCall(mediaPillarCallContext){this.mediaPillarCall=mediaPillarCallContext||null}setDeviceIdSipWise(deviceId){this.deviceId=deviceId||null}getDeviceIdSipWise(){return this.deviceId}setConnectionIdSipWise(connectionId){this.connectionId=connectionId}getConnectionIdSipWise(){return this.connectionId}resetSipWiseData(){this.sipWiseData={initCause:"",direction:"",called:{phoneNumber:"",displayName:""}}}setInitCauseSipWiseData(cause){this.sipWiseData.initCause=cause,this.lastCause=cause}getInitCauseSipWiseData(){return this.sipWiseData.initCause}setDirectionSipWiseData(direction){this.sipWiseData.direction=direction}getDirectionSipWiseData(){return this.sipWiseData.direction}setCalledSipWiseData(called){this.sipWiseData.called=called}getCalledSipWiseData(){return this.sipWiseData.called}isHuntingGroupCallSipWise(){return"distributed"===this.sipWiseData.initCause}getHuntingGroupCalledInfo(){return this.isHuntingGroupCallSipWise()?this.getCalledSipWiseData():null}getDeviceIdFromConnectionIdFromCall(){return this.deviceId?this.deviceId:this.connectionId?this.connectionId.split("#")[1]:null}startDuration(){this.durationTimer||(this.durationTimer=rxjs_1.interval(1e3).subscribe(()=>{this.duration++}))}stopDuration(){this.durationTimer&&(this.durationTimer.unsubscribe(),this.durationTimer=null)}toString(){return"(type:"+this.type.value+", id:"+this.id+", status:"+this.status.value+(this.isConference?" conference":"")+")"}isInCallWithMediaPillar(){return this.fullJid&&-1!==this.fullJid.indexOf("mp_")}subscribe(observer){return this.rxSubject.subscribe(observer)}publish(name,value=null){this.rxSubject.next({name:name,value:value})}}exports.Call=Call,Call.Status={UNKNOWN:{key:0,value:"Unknown"},DIALING:{key:1,value:"dialing"},QUEUED_INCOMMING:{key:2,value:"queuedIncomming"},QUEUED_OUTGOING:{key:10,value:"queuedOutGoing"},RINGING_INCOMMING:{key:3,value:"incommingCall"},RINGING_OUTGOING:{key:4,value:"ringingOutgoing"},ACTIVE:{key:5,value:"active"},HOLD:{key:6,value:"held"},PUT_ON_HOLD:{key:7,value:"putOnHold"},RELEASING:{key:8,value:"releasing"},ANSWERING:{key:9,value:"answering"},CONNECTING:{key:12,value:"connecting"},ERROR:{key:11,value:"error"}},Call.Type={WEBRTC:{key:1,value:"Video"},PHONE:{key:2,value:"Phone"}},Call.Media={AUDIO:1,VIDEO:2,PHONE:4,SHARING:8}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ContactService=void 0;const event_service_1=__webpack_require__(32),main_service_1=__webpack_require__(26),logger_service_1=__webpack_require__(15),errorHelper_service_1=__webpack_require__(39),settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),i18n_service_1=__webpack_require__(37),company_service_1=__webpack_require__(58),xmpp_service_1=__webpack_require__(4),anonymizer_1=__webpack_require__(14),promiseQueue_1=__webpack_require__(49),contact_model_1=__webpack_require__(43),rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24),imageUtils_service_1=__webpack_require__(74),_escape=__webpack_require__(59),moment=__webpack_require__(3);class ContactService{constructor(){this.userContact=null,this.contacts={},this.dbContacts={},this.jtelContacts={},this.currentLanguage=null,this.eventService=event_service_1.default,this.settingsService=settings_service_1.default,this.mainService=main_service_1.default,this.logger=logger_service_1.default,this.errorHelperService=errorHelper_service_1.default,this.authService=auth_service_1.default,this.i18nService=i18n_service_1.default,this.companyService=company_service_1.default,this.xmppService=xmpp_service_1.default,this.rxSubject=new rxjs_1.Subject,this.subscriptions=[],this._displayOrder=null,this.contactLastActivityInterval=null,this.calendarPresenceEventHandlerCleaner=null,this.xmppConnectionSubscription=null,this.presentationModeEventHandlerCleaner=null,this.subscriptionPromiseQueue=promiseQueue_1.PromiseQueue.create(),this.getContactPromises=[],this.contactConfigRef=null,this.lastUpdatePresentationMode=null,this.presentationModeTimeout=null,this.presentationModeActive=!1,this.awayStateActive=!1,this.busyState={status:null,message:null},this.manualState=!1}get displayOrder(){return this._displayOrder}set displayOrder(displayOrder){this._displayOrder=displayOrder,Object.keys(this.contacts).forEach(key=>{const contact=this.contacts[key];contact.displayOrder=displayOrder,contact.computeDisplayName()})}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.contactService||(win.rainbow.contactService=new ContactService),win.rainbow.contactService}start(){return __awaiter(this,void 0,void 0,(function*(){if(this.currentLanguage=this.settingsService.getSetting("lang"),this.displayOrder=this.settingsService.getSetting("displayOrder"),this.settingsService.subscribeUpdateEvent("SETTINGS_UPDATED",()=>{this.currentLanguage=this.settingsService.getSetting("lang"),this.displayOrder=this.settingsService.getSetting("displayOrder"),this.updateContactsLastActivityMessage()}),this.subscriptions.push(this.xmppService.subscribeToContactEvents(event=>{switch(event.name){case"ON_CONTACT_PRESENCE_EVENT":this.contactPresenceChangedHandler(event.data);break;case"ON_CONTACT_UPDATE_EVENT":this.onContactChangeEvent(event.data.from,event.data.type);break;case"ON_ROSTER_CHANGED_EVENT":this.subscriptionPromiseQueue.add(()=>this.rosterChangedHandlerPromise(event.data))}})),this.xmppService.contactServiceReady=!0,this.calendarPresenceEventHandlerCleaner&&this.calendarPresenceEventHandlerCleaner(),this.calendarPresenceEventHandlerCleaner=this.eventService.subscribe("ON_CONTACT_CALENDAR_STATUS_CHANGE",(__event,contact)=>{this.updateContactCalendarPresenceInfo(contact)}),this.presentationModeEventHandlerCleaner&&this.presentationModeEventHandlerCleaner(),this.presentationModeEventHandlerCleaner=this.eventService.subscribe("ON_PRESENTATION_MODE_CHANGED_EVENT",(__event,status)=>{this.onPresentationModeChangedEvent(status)}),this.logger.info("[contactService] Create userContact ("+this.xmppService.jid+")"),this.userContact=this.createContact(),this.userContact.ask=null,this.userContact.subscription=null,this.userContact.id=this.xmppService.jid,this.userContact.jid=this.xmppService.jid,this.userContact.fullJid=this.xmppService.fullJid,this.userContact.language=this.currentLanguage,this.userContact.updateFromUserData(this.authService.loggedInUser),this.userContact.getAvatar(),this.updateContactRichStatus(this.userContact),this.dbContacts[this.userContact.dbId]=this.userContact,this.contacts[this.userContact.id]=this.userContact,this.jtelContacts[this.userContact.jidtel]=this.userContact,!this.authService.loggedInUser.language){const serverLanguageCode=this.settingsService.getAppliLanguageCodeForServer();this.updateUserContact({language:serverLanguageCode})}const settings=yield this.getUserSettings();this.manageCalendarPresencePrompt(settings),this.settingsService.setSetting("activeAlarm",settings.activeAlarm),this.settingsService.setSetting("activeNotif",settings.activeNotif),this.settingsService.setSetting("protectionAgainstMailTypeOffline",settings.protectionAgainstMailTypeOffline),this.logger.info("[contactService] Get alarm & notif data ("+settings.activeAlarm+" / "+settings.activeNotif+")"),this.logger.info("[contactService] Get mail setting data ("+settings.protectionAgainstMailTypeOffline+")"),this.userContact.company=yield this.companyService.getCompanyById(this.userContact.company.id),this.userContact.alertNotificationEnabled=yield this.companyService.getCompanyAlertNotificationState(this.userContact.company),this.attachHandlers(),yield this.getNetwork(),yield this.updateNetworkWithRosterInfo(),this.subscriptions.push(this.mainService.subscribe(appActive=>(this.logger.info("[contactService] AppActive changed : "+appActive),!appActive&&this.userContact&&"online"===this.userContact.status&&(this.awayStateActive=!0),appActive&&this.awayStateActive&&(this.awayStateActive=!1),this.updatePresence(!0),!0))),this.getMissedPresenceMessages(),this.xmppConnectionSubscription&&this.xmppConnectionSubscription.unsubscribe(),this.xmppConnectionSubscription=this.xmppService.subscribeToConnectionEvents(event=>{this.onConnectionStateChangeEvent(event)}),this.contactLastActivityInterval=setInterval(()=>{this.updateContactsLastActivityMessage()},6e4)}))}attachHandlers(){this.logger.info("[contactService] AttachHandlers"),this.contactConfigRef&&(this.xmppService.deleteHandler(this.contactConfigRef),this.contactConfigRef=null),this.contactConfigRef=this.xmppService.addHandler(stanza=>this.onUserManagementEvent(stanza),null,"message","management")}stop(){return __awaiter(this,void 0,void 0,(function*(){this.userContact=null,this.contacts={},this.dbContacts={},this.jtelContacts={},this.presentationModeActive=!1,this.awayStateActive=!1,this.busyState={status:null,message:null},this.manualState=!1,this.contactLastActivityInterval&&(clearInterval(this.contactLastActivityInterval),this.contactLastActivityInterval=null),this.subscriptions&&this.subscriptions.forEach(subscription=>{subscription.unsubscribe()}),this.xmppConnectionSubscription&&this.xmppConnectionSubscription.unsubscribe(),this.calendarPresenceEventHandlerCleaner&&(this.calendarPresenceEventHandlerCleaner(),this.calendarPresenceEventHandlerCleaner=null)}))}subscribe(handler){return this.rxSubject.subscribe(handler)}sendEvent(name,data=null){this.rxSubject.next(event_model_1.RBEvent.create(name,data))}sendUpdateEvent(contact){contact.rxSubject.next({name:"update",data:contact});const event=this.isUserContact(contact)?"ON_USER_CONTACT_UPDATED_EVENT":"ON_CONTACT_UPDATED_EVENT";this.eventService.publish(event,contact)}onConnectionStateChangeEvent(event){"ON_XMPP_DISCONNECTED"===event.name&&this.userContact&&(this.userContact.resources={},Object.keys(this.contacts).forEach(key=>{const contact=this.contacts[key];contact.isBot||(contact.resources={},"unknown"!==contact.status&&"none"!==contact.subscription&&(contact.status="offline",contact.imStatusStamp=[]))}),this.presentationModeActive=!1,this.awayStateActive=!1,this.busyState={status:null,message:null},this.manualState=!1)}createContact(jid=null,firstname=null,lastname=null,company=null,login=null){const contact=new contact_model_1.Contact(jid,null,company);return contact.login=login,contact.avatarServerURL=this.mainService.cdn?this.mainService.cdnServer:config.webservices.protocol+"://"+config.webservices.currentServer,contact.firstname=firstname,contact.lastname=lastname,contact.displayOrder=this.displayOrder,contact.computeDisplayName(),contact}createBotContact(jid,name,id,botAvatarUrl,botCapabilities){let contact=this.contacts[jid];return contact||(contact=new contact_model_1.Contact(jid),contact.botDetails="emilyDetails"),contact.displayOrder=this.displayOrder,contact.lastname=name,contact.isBot=!0,contact.status="online",contact.imStatus="online",contact.subscription="both",contact.computeDisplayName(),contact.avatar=window.rainbowSDK?null:{src:botAvatarUrl},contact.dbId=id,contact.isBotSharing=!!botCapabilities&&botCapabilities.some((function(param){return"SHARING"===param})),this.contacts[contact.id]=this.dbContacts[id]=contact,contact}isMediaPillarJid(jid){return jid&&0===jid.indexOf("mp_")}isUserContactJid(jid){return!(!this.userContact||!jid||0===jid.length)&&jid.startsWith(this.userContact.jid)}isUserContact(contact){return!(!contact||!contact.jid)&&this.isUserContactJid(contact.jid)}searchContacts(criteria){return this.getContacts().filter(contact=>(contact.roster||contact.isBot)&&!contact.isTerminated&&this.contactMatcher(contact,criteria))}contactMatcher(contact,criteria){const displayname=contact.firstname+" "+contact.lastname,queries=criteria.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/),names=displayname.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ ]+/);return queries.every(query=>names.some((name,index)=>!(!name.length||0!==name.indexOf(query))&&(names[index]="",!0)))}getContacts(){return Object.keys(this.contacts).map(key=>this.contacts[key])}getContact(jid,phoneNumber=null){const contactId=jid||phoneNumber;return this.isUserContactJid(contactId)?this.userContact:this.contacts[contactId]}getContactByJid(jid){return this.getContact(jid)}getContactById(dbId){return this.dbContacts[dbId]}getContactByEmail(email){const contactKey=Object.keys(this.contacts).find(key=>this.contacts[key].containsEmail(email));return contactKey?this.contacts[contactKey]:null}getContactByPhoneNumber(phonenumber){const contactKey=Object.keys(this.contacts).find(key=>this.contacts[key].containsPhoneNumber(phonenumber));return contactKey?this.contacts[contactKey]:null}getContactByDBId(dbId,force=!1){return __awaiter(this,void 0,void 0,(function*(){try{const existingContact=this.dbContacts[dbId];if(!force&&existingContact)return existingContact;if(!this.getContactPromises[dbId]){const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${dbId}?format=full`,response=yield fetch(url,{method:"GET",headers:this.authService.getRequestHeader()});if(!response.ok)throw response;const contactData=(yield response.json()).data,contact=existingContact||this.createBasicContact(contactData.jid_im);return contact.updateFromUserData(contactData),contact.getAvatar(),this.dbContacts[contact.dbId]=contact,this.jtelContacts[contact.jidtel]=contact,delete this.getContactPromises[dbId],this.logger.info("[contactService] GetContactByDBId ("+dbId+") -- "+contactData.jid_im+" -- success"),contact}return this.getContactPromises[dbId]}catch(error){delete this.getContactPromises[dbId];const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getContactByDBId");throw this.logger.error(errorInfo.message),errorInfo.error}}))}getContactsByEmails(emails){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[contactService] getContactsByEmails with ["+emails.join()+"]");const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails",loginEmail=emails.map(email=>email.toLowerCase()),response=yield fetch(url,{method:"POST",headers:this.authService.getPostHeader(),body:JSON.stringify({loginEmail:loginEmail})});if(!response.ok)throw response;const responseData=yield response.json(),contacts={},contactsArray=responseData.data.map(userData=>{let contact=this.dbContacts[userData.id];return contact||(contact=this.createContact(),this.contacts[contact.id]=contact,this.dbContacts[contact.dbId]=contact,this.jtelContacts[contact.jidtel]=contact),contact.updateFromUserData(userData),contact.getAvatar(),contacts[contact.loginEmail]=contact,loginEmail.splice(loginEmail.indexOf(contact.loginEmail.toLowerCase()),1),contact});return{contacts:contacts,contactsArray:contactsArray,emails:loginEmail}}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getContactsByEmails");throw this.logger.error(errorInfo.message),errorInfo.error}}))}getContactsByJids(jids){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info(`[contactService] getContactsByJids with [${jids.join()}]`);const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/jids?limit=1000",response=yield fetch(url,{method:"POST",headers:this.authService.getPostHeader(),body:JSON.stringify({jid_im:jids})});if(!response.ok)throw response;(yield response.json()).data.forEach(userData=>{let contact=this.getContact(userData.jid_im);contact||(contact=this.createContact()),contact.updateFromUserData(userData),contact.isAnonymousGuest()||(this.contacts[contact.id]=contact,this.dbContacts[contact.dbId]=contact,this.jtelContacts[contact.jidtel]=contact,contact.getAvatar(),contact.temp=!1)})}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getContactsByJids");throw this.logger.error(errorInfo.message),errorInfo.error}}))}createBasicContact(jid,phoneNumber=null,append=!0){this.logger.debug(`[contactService] CreateContact ${jid} ${anonymizer_1.default(phoneNumber)}`);const contact=this.createContact();if(!jid)return contact.id=phoneNumber,contact.initials="?",contact.displayName=phoneNumber||"Unknown contact",contact.lastname=phoneNumber||"Unknown contact",contact.firstname="",contact.phoneProCan=phoneNumber||"",contact.phonePro=contact.phoneProCan,contact.temp=!0,contact.avatar={src:"/resources/skins/rainbow/images/conversations/unknownUser.jpeg"},contact.nameUpdatePrio=contact_model_1.Contact.NameUpdatePrio.NO_UPDATE_PRIO,contact;let contactId=jid;return contactId||(contactId=phoneNumber,contact.phoneProCan=phoneNumber),contactId||(contactId="anonymous"),contact.jid=jid,contact.id=contactId,contact.ask="none",contact.subscription="none",this.updateContactRichStatus(contact),!1!==append&&(this.contacts[contact.id]=contact),contact}createEmptyContact(jid){const contact=this.createBasicContact(jid);return contact.initials="?",contact.displayName="Unknown contact",contact.lastname="Unknown contact",contact.firstname="",contact.temp=!0,contact.avatar={src:"/resources/skins/rainbow/images/conversations/unknownUser.jpeg"},contact}getOrCreateContact(jid,phoneNumber=null){if(!jid&&!phoneNumber)return Promise.reject(new Error("No jid or no phoneNumber"));const existingContact=this.getContact(jid,phoneNumber);if(existingContact)return Promise.resolve(existingContact);if(jid&&-1===jid.indexOf("@"))throw new Error("Invalid jid "+jid);const contactId=jid||phoneNumber;return jid?(this.getContactPromises[contactId]||(this.getContactPromises[contactId]=new Promise((resolve,reject)=>{const contact=this.createBasicContact(jid,phoneNumber,!1);this.updateContactFromServer(contact).then(()=>{this.contacts[contact.id]=contact,this.dbContacts[contact.dbId]=contact,this.jtelContacts[contact.jidtel]=contact,delete this.getContactPromises[contactId],resolve(contact)}).catch(error=>{this.logger.error("[contactService] getOrCreateContact -- failure -- "+error.message),delete this.getContactPromises[contactId],reject(error)})})),this.getContactPromises[contactId]):Promise.resolve(this.createBasicContact(null,phoneNumber))}updateContactFromServer(contact,shouldSkipAvatar=!1){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/jids/${contact.jid}`,response=yield fetch(url,{headers:this.authService.getRequestHeader()});if(!response.ok)throw response;const responseData=yield response.json();contact.updateFromUserData(responseData.data),this.updateContactRichStatus(contact,this.isUserContactJid(contact.jid)),shouldSkipAvatar||contact.getAvatar(),this.sendUpdateEvent(contact)}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"updateContactFromServer");throw this.logger.error(errorInfo.message),errorInfo.error}}))}getContactInfoByEmail(email){return __awaiter(this,void 0,void 0,(function*(){try{const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/loginemails?format=full",response=yield fetch(url,{method:"POST",headers:this.authService.getRequestHeader(),body:JSON.stringify({loginEmail:[email]})});if(!response.ok)throw response;return(yield response.json()).data}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getContactInfoByEmail");throw this.logger.error(errorInfo.message),errorInfo.error}}))}onContactChangeEvent(jid,type){this.logger.info("[contactService] onContactChangeEvent event: "+event+" || status: "+jid+" || type: "+type),setTimeout(()=>__awaiter(this,void 0,void 0,(function*(){const contact=this.getContact(jid);contact&&(yield this.updateContactFromServer(contact,!0),"avatar"===type&&contact.getAvatar(256,!0),this.sendUpdateEvent(contact))})),2e3)}onUserManagementEvent(stanza){try{const userSettingsElem=$(stanza).find("usersettings");if(userSettingsElem.length&&"update"===userSettingsElem.attr("action"))return this.logger.info("[contactService] onUserManagementEvent - should update the presence"),this.sendPresenceFromConfiguration(),!0;const userPasswordElem=$(stanza).find("userpassword");return!userPasswordElem.length||"update"!==userPasswordElem.attr("action")||(this.logger.info("[contactService] onUserManagementEvent - userPassword updated"),this.xmppService.changePasswordInfo||(this.xmppService.changePasswordInfo={fromThirdParty:!0}),!0)}catch(error){return!0}}sendPresenceFromConfiguration(sendAuthInfo=!1){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("(with auth info)");try{const setting=yield this.getUserSettings();let message="",presence=setting.presence;if("invisible"===presence?presence="xa":"away"===presence&&(presence="xa",message="away"),this.logger.info("[contactService] sendPresenceFromConfiguration -> getUserSettings are "+presence+" || message : "+message),this.userContact&&this.userContact.resources&&this.userContact.resources[this.userContact.fullJid]){const myRessource=this.userContact.resources[this.userContact.fullJid];if(myRessource&&(myRessource.show!==presence||"xa"===myRessource.show&&myRessource.status!==message)){if(!this.busyState||"dnd"!==this.busyState.status||this.manualState){this.logger.info("[contactService] sendPresenceFromConfiguration should update my status from "+myRessource.show+" to "+presence+" ("+message+")");const userOptions={im:this.userContact.instantMessagesEnabled,alert:this.userContact.alertNotificationEnabled};this.setUserContactStatus(presence,message,sendAuthInfo,userOptions)}}else this.eventService.publish("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT")}else{const userOptions={im:this.userContact.instantMessagesEnabled,alert:this.userContact.alertNotificationEnabled};this.logger.info("[contactService] sendPresenceFromConfiguration set initial presence "),this.setUserContactStatus(presence,message,sendAuthInfo,userOptions)}}catch(error){this.logger.info("[contactService] sendPresenceFromConfiguration failure, send online"),this.setUserContactStatus("online",null,sendAuthInfo)}}))}changeMyPresence(status){if(this.logger.info("[contactService] changeMyPresence "+status+" "+this.userContact.message),"dnd"===status&&"presentation"===this.userContact.message||"busy"===status)return;let message="";"online"===status&&(message="mode=auto"),"away"===status&&(status="xa",message="away"),this.setUserContactStatus(status,message),"online"===status&&setTimeout(()=>{this.manualState=!1,this.updatePresence()},1e3);let presence="online";"xa"===status&&"away"===message?presence="away":"dnd"===status?presence="dnd":"xa"===status&&(presence="invisible"),this.setUserSettings({presence:presence})}updateUserContact(userData){return __awaiter(this,void 0,void 0,(function*(){let responseData=null;try{this.logger.info("[contactService] updateUserContact");const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.authService.userId}`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"PUT",headers:headers,body:JSON.stringify(userData)});if(!response.ok)throw response;responseData=(yield response.json()).data,this.userContact.updateFromUserData(responseData),this.authService.loggedInUser=responseData,this.logger.info("[contactService] updateUserContact successfully")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"updateUserContact");throw this.logger.error(errorInfo.message),errorInfo.error}}))}updateUserContactFullJid(){this.userContact.fullJid=this.xmppService.fullJid,this.attachHandlers()}completeContactPhoneNumbers(contact){return __awaiter(this,void 0,void 0,(function*(){if(contact.isBot)throw new Error("No phone numbers for bot contacts");if(contact.phoneNumbersInitialized)return contact;if(contact.dbId)try{return yield this.getContactByDBId(contact.dbId,!0)}catch(error){throw new Error(error.message)}return contact}))}updateUserPassword(oldPassword,newPassword,async=!1){return new Promise((resolve,reject)=>{const login=this.userContact.loginEmail;this.xmppService.changePasswordInfo={resolve:async?resolve:null,login:login,newPassword:newPassword};const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.authService.userId}/change-password`,headers=this.authService.getPostHeader();fetch(url,{method:"PUT",headers:headers,body:JSON.stringify({oldPassword:oldPassword,newPassword:newPassword})}).then(response=>{if(!response.ok)throw response;async||resolve()}).catch(error=>__awaiter(this,void 0,void 0,(function*(){this.xmppService.changePasswordInfo=null;const errorInfo=yield this.errorHelperService.getErrorInfo(error,"updateUserPassword");this.logger.error(errorInfo.message),reject(errorInfo.error)})))})}getNetwork(){return __awaiter(this,void 0,void 0,(function*(){try{const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/networks?limit=2000&format=full",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();this.logger.info(`[contactService] GetNetwork success -- find ${responseData.data.length} contact(s)`),responseData.data.forEach(contactData=>{const contact=this.createContact();contact.updateFromUserData(contactData),this.contacts[contact.id]=contact,this.dbContacts[contact.dbId]=contact,this.jtelContacts[contact.jidtel]=contact,this.updateContactRichStatus(contact),contact.getAvatar(),this.sendUpdateEvent(contact)})}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getNetwork");throw this.logger.error(errorInfo.message),errorInfo.error}}))}updateNetworkWithRosterInfo(){return __awaiter(this,void 0,void 0,(function*(){try{const stanza=yield this.xmppService.sendIQ($iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"}));this.logger.info("[contactService] Get rosters info successfully"),$(stanza).find("item").each((__index,item)=>{const rosterElem=$(item),jid=this.xmppService.getBareJidFromJid(rosterElem.attr("jid"));if(jid&&jid.length&&!this.isTelJid(jid)){const contact=this.contacts[jid];if(contact){const ask=rosterElem.attr("ask"),subscription=rosterElem.attr("subscription");contact.ask=ask||"none",contact.subscription=subscription||"none",contact.roster=!0,this.updateContactRichStatus(contact),this.logger.info("[contactService] Update contact from roster ("+contact.ask+", "+contact.subscription+") "+jid)}}})}catch(error){throw this.logger.error("[contactService] Get rosters failure : "+error.message),new Error(error.message)}}))}getUserSettings(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.userContact.dbId}/settings`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json(),presence=responseData.data.presence&&this.userContact.changePresenceEnabled?responseData.data.presence:"online",activeAlarm=responseData.data.activeAlarm||"relax1",activeNotif=responseData.data.activeNotif||"notif1",promptForCalendarPresence=responseData.data.promptForCalendarPresence,protectionAgainstMailTypeOffline=responseData.data.protectionAgainstMailTypeOffline;return this.logger.info("[contactService] GetUserSettings success"),{presence:presence,activeAlarm:activeAlarm,activeNotif:activeNotif,promptForCalendarPresence:promptForCalendarPresence,protectionAgainstMailTypeOffline:protectionAgainstMailTypeOffline}}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getUserSettings");return this.logger.error(errorInfo.message),{presence:"online",activeAlarm:"relax1",activeNotif:"notif1",promptForCalendarPresence:!1}}}))}setUserSettings(params){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.userContact.dbId}/settings`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"PUT",headers:headers,body:JSON.stringify(params)});if(!response.ok)throw response;this.logger.info(`[contactService] SetUserSettings ${JSON.stringify(params)} -- success`)}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"setUserSettings");throw this.logger.error(errorInfo.message),errorInfo.error.errorDetailsCode&&403153===errorInfo.error.errorDetailsCode&&(this.setUserContactStatus("online","mode=auto"),this.eventService.publish("ON_OPEN_GLOBAL_POPUP",{popupTitle:"presence",popupBody:"changePresenceDisabled",okLabel:"ok"})),errorInfo.error}}))}manageCalendarPresencePrompt(settings){if(void 0!==settings.promptForCalendarPresence)this.settingsService.setSetting("disableCalendarPresence",settings.promptForCalendarPresence?"false":"true"),this.logger.info("[contactService] promptForCalendarPresence -- "+settings.promptForCalendarPresence);else{const promptForCalendarPresence="true"!==this.settingsService.getSetting("disableCalendarPresence");this.logger.info("[contactService] MIGRATION NECESSARY -- promptForCalendarPresence : "+promptForCalendarPresence),this.setUserSettings({promptForCalendarPresence:promptForCalendarPresence})}}updateContactCalendarPresenceInfo(contact){const calendarState=contact.calendarState;let calendarParams=null,calendarMessage=null;calendarState.iconId=null;let calendarLabelKey=null;if(calendarState.autoReplyOn)calendarState.iconId="calendar--busy",calendarMessage="<div style='text-align:left'>"+_escape(calendarState.autoReplyInfos.message).replace(/\n/g,"<br/>")+"</div>",calendarParams={meetingDate:calendarState.autoReplyInfos.until,message:calendarMessage},calendarLabelKey=calendarState.autoReplyInfos.until?calendarState.autoReplyInfos.untilDate?"calendarAutoReply-date":"calendarAutoReply":"calendarAutoReplySimple";else{if("busy"===calendarState.message)calendarState.iconId="calendar--ok",calendarLabelKey=calendarState.untilDate?"calendar-busy-date":"calendar-busy";else if("out_of_office"===calendarState.message)calendarState.iconId="calendar--busy",calendarLabelKey=calendarState.untilDate?"calendar-outofoffice-date":"calendar-outofoffice";else if("online"===calendarState.status){const isBusyToday=calendarState.mdate&&calendarState.mdate.isSame(moment(),"d");calendarState.tooltip=isBusyToday?this.i18nService.translate("calendar-free",{meetingDate:calendarState.until}):this.i18nService.translate("calendar-noappointment")}calendarParams={meetingDate:calendarState.until}}calendarLabelKey&&(calendarState.tooltip=this.i18nService.translate(calendarLabelKey,{meetingDate:calendarParams.meetingDate}),calendarParams.message&&(calendarParams.message=calendarParams.message.replace(/<script>/g,""),calendarParams.message=calendarParams.message.replace(/(?:<br?\/?>\s*){2,}/g,"<br/>"),calendarState.tooltip=calendarState.tooltip+" "+calendarParams.message))}isTelJid(jid){return 0===jid.indexOf("tel_")}getResourceFromJid(jid){return this.xmppService.getResourceFromJid(jid)}getImJid(jid){const bareJid=this.xmppService.getBareJidFromJid(jid);if(this.isTelJid(bareJid)){const contact=this.jtelContacts[bareJid];return contact?contact.jid:(this.logger.warn("[contactService] -- getIMJid("+jid+") -- failure -- no associated contact"),null)}return bareJid}rosterChangedHandlerPromise(attr){return __awaiter(this,void 0,void 0,(function*(){try{if(this.isTelJid(attr.jid))return void this.logger.debug("[contactService] Contact changed ("+attr.jid+") ignored");const contact=yield this.getOrCreateContact(attr.jid);"remove"===attr.subscription?(contact.ask="none",contact.subscription="none",contact.roster=!1):(contact.ask=attr.ask,contact.subscription=attr.subscription,contact.roster=!0,"both"===attr.subscription&&this.updatePresence(!0)),this.updateContactRichStatus(contact),this.sendUpdateEvent(contact),this.sendEvent("ON_CONTACT_ROSTER_UPDATE_EVENT"),this.logger.info("[contactService] rosterChangedHandler - contact "+attr.jid+" changed ("+attr.ask+", "+attr.subscription+") success")}catch(error){this.logger.error("[contactService] rosterChangedHandler - contact "+attr.jid+" failure - "+error.message)}}))}contactPresenceChangedHandler(attr){return __awaiter(this,void 0,void 0,(function*(){const resource=this.getResourceFromJid(attr.jid);if("calendar"===resource)return;const jidIm=this.getImJid(attr.jid);if(!jidIm)return;if(jidIm.startsWith("room"))return;const contact=yield this.getOrCreateContact(jidIm),isUserContact=this.isUserContact(contact);this.isTelJid(attr.jid)?(this.logger.info("[contactService] Update telephony presence ("+jidIm+") source: "+resource),this.logger.info("[contactService] Update telephony presence ("+jidIm+") msg: "+attr.message+" / status: "+attr.status),this.updateContactTelephonyStatus(contact,attr,isUserContact)):(this.logger.info("[contactService] Update im presence contact ("+jidIm+") status: "+attr.status+" "+attr.stamp),this.isUserContact(contact)&&"mode=auto"===attr.message&&"online"!==contact.status&&contact.resources.hasOwnProperty(attr.jid)&&attr.jid!==contact.fullJid&&"EVT_SERVICE_INITIATED"!==contact.telStatus&&"EVT_ESTABLISHED"!==contact.telStatus&&(contact.resources[contact.fullJid]&&"online"===contact.resources[contact.fullJid].show?this.logger.info("[contactService] Current ressource is already online, ignore message!"):(this.manualState&&(this.logger.info("[contactService] User is in manual state, leave it"),this.setUserContactStatus("online","mode=auto")),this.busyState&&"dnd"===this.busyState.status&&"busy"!==this.userContact.status&&(this.logger.info("[contactService] User is in call, re-update presence state"),setTimeout(()=>{this.updatePresence(!0)},500)))),this.updateContactIMStatus(contact,attr,this.isUserContact(contact)),this.updateLastActivity(contact)),this.sendUpdateEvent(contact)}))}getMissedPresenceMessages(){this.logger.info("[contactService] GetMissedPresenceMessages");try{const list=this.xmppService.getPresenceWaitingList();if(list.length){for(this.logger.info("[contactService] GetMissedPresenceMessages length "+list.length);list.length>0;){const item=list.pop();this.contactPresenceChangedHandler(item)}this.xmppService.resetPresenceWaitingList()}}catch(error){this.logger.error("[contactService] GetMissedPresenceMessages error "+error)}}computeStatusList(){let list=[];return this.userContact&&this.userContact.status&&(this.logger.info("[contactService] computeStatusList "+this.userContact.status+" "+this.userContact.message),list=this.userContact.changePresenceEnabled?"offline"===this.userContact.status?["online"]:"busy"===this.userContact.status?["busy"]:"dnd"===this.userContact.status&&"presentation"===this.userContact.message?["dnd"]:["online","away","xa","dnd"]:[]),list}resetBusyState(){this.logger.info("[contactService] resetBusyState"),this.setBusyState(null,null,!0),this.sendPresenceFromConfiguration()}setBusyState(status,message,noUpdate=!1){this.logger.info("[contactService] setBusyState -- "+status+" -- "+message),this.busyState={status:status,message:message},noUpdate||this.updatePresence()}contactCalendarPresenceChangedHandler(){}updateContactRichStatus(contact,isMe=!1){if("EVT_SERVICE_INITIATED"===contact.telStatus||"EVT_ESTABLISHED"===contact.telStatus)contact.status="busy",contact.message="audioPhone";else{if("subscribe"===contact.ask)contact.status="wait";else if("none"===contact.subscription||"from"===contact.subscription)contact.status="unknown";else{const calculatedStatus=this.calculateContactStatusFromResources(contact,isMe);"xa"===calculatedStatus.presence&&(""!==calculatedStatus.message||isMe?"away"===calculatedStatus.message&&(calculatedStatus.presence="away",calculatedStatus.message=""):calculatedStatus.presence="offline"),contact.status=calculatedStatus.presence,contact.message=calculatedStatus.message,this.logger.info(`[contactService] updateContactRichStatus ${isMe?"MY ":"USER"} PRESENCE : ${calculatedStatus.presence} || message : ${calculatedStatus.message}`)}this.updateContactStatusMessage(contact)}isMe&&this.eventService.publish("ON_UPDATE_MYCONTACT_EVENT"),this.eventService.publish("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",contact)}calculateContactStatusFromResources(contact,isMe){let presence="offline",message="",initStamp=null,stamp=null,fullJid=contact.fullJid,desktopPresence=!1;const allowMobiles=config.webrtcWithMobiles;for(const key in contact.resources)if(contact.resources.hasOwnProperty(key)){const resource=contact.resources[key];if("dnd"===resource.show&&"phone"===resource.status){presence="busy",message="audioPhone",desktopPresence=!0,fullJid=key;break}if("xa"===resource.show||"dnd"===resource.show&&""===resource.status){let toUpdate=!1;resource.initStamp?initStamp?resource.initStamp.getTime()>initStamp.getTime()&&(initStamp=resource.initStamp,toUpdate=!0):(initStamp=resource.initStamp,toUpdate=!0):stamp?resource.stamp.getTime()>stamp.getTime()&&(stamp=resource.stamp,initStamp=resource.stamp,toUpdate=!0):(stamp=resource.stamp,initStamp=resource.stamp,toUpdate=!0),toUpdate&&(presence=resource.show,message=resource.status)}else"xa"!==presence&&("dnd"!==presence||"dnd"===presence&&""!==message)&&"dnd"===resource.show&&""!==resource.status?("presentation"===resource.status?(presence=resource.show,message="presentation"):(presence="busy",message=resource.status),fullJid=key,desktopPresence=!0):isMe&&"online"===resource.show&&"mode=auto"===resource.status&&key===contact.fullJid?"busy"!==presence&&"dnd"!==presence&&"presentation"!==message&&(presence="online",message="",resource.status="",this.xmppService.isMobileResource(key)?presence="online-mobile":desktopPresence=!0):"online"===resource.show&&"xa"!==presence&&"dnd"!==presence&&"busy"!==presence?(message="","online-mobile"!==presence&&(presence="online"),resource.status="",this.xmppService.isMobileResource(key)?presence="online-mobile":(fullJid=key,desktopPresence=!0),allowMobiles&&(fullJid=key)):"away"===resource.show&&"offline"===presence&&(presence="away",message="",fullJid=key);"mode=auto"===resource.status&&(resource.status="")}for(const key in contact.resources)contact.resources.hasOwnProperty(key)&&"mode=auto"===contact.resources[key].status&&(contact.resources[key].status="");return isMe||contact.fullJid||(contact.fullJid=fullJid),"online-mobile"===presence&&desktopPresence?(presence="online",message=""):"online-mobile"!==presence||isMe||allowMobiles||(contact.fullJid=null,message=""),{presence:presence,message:message}}updatePresence(forced=!1){this.logger.info("[contactService] updatePresence"),this.manualState?(this.logger.info("[contactService] updatePresence manualState"),"away"===this.userContact.status&&this.busyState&&"dnd"===this.busyState.status&&(this.setUserContactStatus("online","mode=auto"),setTimeout(()=>{this.updatePresence()},1e3))):!this.presentationModeActive||this.busyState&&this.busyState.status?this.busyState&&"dnd"===this.busyState.status?(this.logger.info("[contactService] updatePresence dnd "+this.busyState.message),this.xmppService.sendPresence("dnd",this.busyState.message)):this.awayStateActive?(this.logger.info("[contactService] updatePresence away"),this.xmppService.sendPresence("away","")):this.userContact&&"online"!==this.userContact.status?(this.logger.info("[contactService] updatePresence online"),this.setUserContactStatus("online")):forced&&this.userContact&&"online"===this.userContact.status&&(this.logger.info("[contactService] updatePresence forced online"),this.setUserContactStatus("online")):(this.logger.info("[contactService] updatePresence dnd presentation"),this.xmppService.sendPresence("dnd","presentation"))}setUserContactStatus(status,message=null,withAuthInfo=!1,userOptions){try{this.logger.info("[contactService] Set userContact status : "+status+(message?"("+message+")":"")),this.xmppService.started&&("online"===status?(this.manualState=!1,this.xmppService.sendPresence(null,message,withAuthInfo,userOptions)):(this.manualState=!0,"away"===status?this.xmppService.sendPresence("away",message,withAuthInfo,userOptions):"dnd"===status?this.xmppService.sendPresence("dnd",message,withAuthInfo,userOptions):"xa"===status&&this.xmppService.sendPresence("xa",message,withAuthInfo,userOptions)))}catch(error){this.logger.error("[contactService] Set userContact status error : "+error)}}updateContactTelephonyStatus(contact,attr,isMe){const statusOrg=contact.telStatus;if("pcg2"===this.getResourceFromJid(attr.jid))switch(attr.status){case"offline":contact.telStatus="";break;case"online":contact.telStatus="EVT_CONNECTION_CLEARED";break;case"dnd":contact.telStatus="EVT_ESTABLISHED";break;default:contact.telStatus=""}else contact.telStatus=attr.message;this.updateContactRichStatus(contact,isMe),isMe&&statusOrg!==contact.telStatus&&this.eventService.publish("ON_UPDATE_MYTELEPHONY_STATUS_EVENT")}updateContactIMStatus(contact,attr,isMe){if(contact.imStatusStamp[attr.jid]&&contact.imStatusStamp[attr.jid]>attr.stamp)return void this.logger.info("[contactService] Ignore obsolete presence message for contact "+contact.jid);this.logger.info("[contactService] updateIMStatus "+JSON.stringify(attr)),contact.imStatusStamp[attr.jid]=attr.stamp,attr.status&&(contact.imStatus=attr.status);const status=attr.message?attr.message:"";if("offline"===contact.imStatus?(contact.fullJid===attr.jid&&(contact.fullJid=null),delete contact.resources[attr.jid],delete contact.imStatusStamp[attr.jid],0===contact.resources.length&&(contact.message="")):(contact.resources[attr.jid]?(contact.resources[attr.jid].show=contact.imStatus,contact.resources[attr.jid].status=status,contact.resources[attr.jid].stamp=attr.stamp):contact.resources[attr.jid]={show:contact.imStatus,status:status,initStamp:attr.stamp,stamp:attr.stamp},this.logger.info("[Contact] updateIMStatus user resources after update "+JSON.stringify(contact.resources)),this.xmppService.isMobileResource(attr.jid)||isMe||(contact.fullJid=attr.jid),!isMe&&config.webrtcWithMobiles&&(contact.fullJid=attr.jid)),this.updateContactRichStatus(contact,isMe),isMe&&this.xmppService.isMobileResource(attr.jid)&&("offline"!==attr.status&&null===contact.mobileResource&&(contact.mobileResource=attr.jid,this.logger.info("[Contact] updateIMStatus: post event ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT"),this.eventService.publish("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","started")),"offline"===attr.status)){let otherMobileResource=null;for(const key in contact.resources)if(contact.resources.hasOwnProperty(key)&&this.xmppService.isMobileResource(key)){otherMobileResource=key;break}contact.mobileResource=otherMobileResource,null===contact.mobileResource&&this.eventService.publish("ON_MOBILE_TELEPHONY_STATUS_CHANGED_EVENT","stopped")}}getContactLastActivityMessage(contact){return __awaiter(this,void 0,void 0,(function*(){try{if(contact.lastActivityMessage)return;this.xmppService.connection.lastactivity.query(contact.jid,{onResponse:stanza=>{const inactivityInMSeconds=1e3*Number.parseInt($(stanza).find("query").attr("seconds"),10),dateInMSeconds=(new Date).getTime(),lastActivityDate=new Date(dateInMSeconds-inactivityInMSeconds);this.updateContactLastActivityDate(contact,lastActivityDate)}})}catch(error){throw new Error("[contactService] getInitialContactLastActivityMessage -- Failure -- "+error.message)}}))}updateContactsLastActivityMessage(){this.contacts&&Object.keys(this.contacts).forEach(key=>{this.updateContactStatusMessage(this.contacts[key])})}updateLastActivity(contact){let lastActivityDate=null;"offline"!==contact.status&&"away"!==contact.status||Object.keys(contact.imStatusStamp).forEach(key=>{const stamp=contact.imStatusStamp[key];(!lastActivityDate||lastActivityDate<stamp)&&(lastActivityDate=stamp)}),this.updateContactLastActivityDate(contact,lastActivityDate)}updateContactLastActivityDate(contact,lastActivityDate){contact.lastActivityDate=lastActivityDate,this.updateContactStatusMessage(contact)}updateContactStatusMessage(contact){if(contact.lastActivityDate){const mdate=moment(contact.lastActivityDate);moment.locale().startsWith("de")?(contact.lastActivityMessage=mdate.fromNow(!0).replace("Tage","Tagen"),contact.lastActivityMessage=contact.lastActivityMessage.replace("eine Stunde","einer Stunde")):contact.lastActivityMessage=mdate.fromNow(!0)}else contact.lastActivityMessage="";if("unknown"===contact.status?contact.statusMessage=this.i18nService.translate("unknown"):"offline"===contact.status&&""===contact.lastActivityMessage?contact.statusMessage=this.i18nService.translate("offlineFilter"):"away"===contact.status&&""===contact.lastActivityMessage?contact.statusMessage=this.i18nService.translate("shortAway"):contact.statusMessage=this.i18nService.translate(contact.status,{offlineDate:contact.lastActivityMessage}),contact.message){let message=this.i18nService.translate(contact.message);"("!==message.charAt(0)&&(message="("+message+")"),contact.statusMessage+=" "+message}}deleteUserAccount(){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[contactService] deleteUserAccount");const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.userContact.dbId}`,response=yield fetch(url,{method:"DELETE",headers:this.authService.getRequestHeader()});if(!response.ok)throw response;yield response.json()}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"deleteUserAccount");throw this.logger.error(errorInfo.message),errorInfo.error}}))}removeContact(contact){return __awaiter(this,void 0,void 0,(function*(){try{if(!contact||!contact.dbId)throw new Error("[contactService] removeContact : wrongContact");const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/networks/${contact.dbId}`,response=yield fetch(url,{method:"DELETE",headers:this.authService.getRequestHeader()});if(!response.ok)throw response;yield response.json(),this.logger.info(`[contactService] removeContact ${contact.dbId} -- SUCCESS`)}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"removeContact");throw this.logger.error(errorInfo.message),errorInfo.error}}))}pushAvatarImage(avatarImg){return __awaiter(this,void 0,void 0,(function*(){const oldImage=this.userContact.avatar;try{this.logger.info("[contactService] Push avatar image");const resizedImage=yield imageUtils_service_1.resizeImage(avatarImg,512,512),binaryData=imageUtils_service_1.getBinaryData(resizedImage),url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.userContact.dbId}/avatar`,headers=this.authService.getPostHeader("image/"+binaryData.type),response=yield fetch(url,{method:"POST",headers:headers,body:binaryData.data});if(!response.ok)throw response;yield response.json()}catch(error){this.userContact.avatar=oldImage;const errorInfo=yield this.errorHelperService.getErrorInfo(error,"pushAvatarImage");throw this.logger.error(errorInfo.message),errorInfo.error}}))}notifyImByEmail(contact){return __awaiter(this,void 0,void 0,(function*(){let responseData=null;try{const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/notifications/emails/offline",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"POST",headers:headers,body:JSON.stringify({userId:contact.dbId})});if(!response.ok)throw response;responseData=yield response.json();let mail="";responseData.data&&responseData.data.email&&(mail=responseData.data.email.substr(0,3)+"***"+responseData.data.email.substr(-3)),this.logger.info("[contactService] notifyImByEmail "+mail+" - success")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"notifyImByEmail");throw this.logger.error(errorInfo.message),errorInfo.error}}))}myMobileAvailable(){return this.userContact?this.userContact.mobileResource:null}sendSubscribeInvitation(jid){return this.logger.info("[contactService] Send subscribe invitation to "+jid),this.xmppService.send($pres({to:jid,type:"subscribe"}))}onPresentationModeChangedEvent(status){"active"===status?this.presentationModeActive=!0:"disable"===status&&(this.presentationModeActive=!1),null===this.lastUpdatePresentationMode&&(this.logger.debug(`[contactService] onPresentationModeChangedEvent '${status}' request presence update`),this.lastUpdatePresentationMode=this.presentationModeActive,this.updatePresence()),this.startUpdatePresentationModeRefreshTimer()}startUpdatePresentationModeRefreshTimer(){this.logger.debug("[contactService] startUpdatePresentationModeRefreshTimer"),null!==this.presentationModeTimeout&&(clearTimeout(this.presentationModeTimeout),this.presentationModeTimeout=null),this.presentationModeTimeout=setTimeout(()=>{this.logger.debug("[contactService] startUpdatePresentationModeRefreshTimer interval reach"),this.lastUpdatePresentationMode!==this.presentationModeActive?(this.logger.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - request presence update"),this.lastUpdatePresentationMode=this.presentationModeActive,this.updatePresence(),this.startUpdatePresentationModeRefreshTimer()):(this.logger.debug("[contactService] startUpdatePresentationModeRefreshTimer interval - no presence update needed"),this.lastUpdatePresentationMode=null)},1e3)}}exports.ContactService=ContactService,exports.default=ContactService.getInstance()},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthService=void 0;const logger_service_1=__webpack_require__(15),settings_service_1=__webpack_require__(5),event_service_1=__webpack_require__(32),crypto_js_1=__webpack_require__(18),authSettings_model_1=__webpack_require__(300),jwtDecode=__webpack_require__(301),fetchWithTimeout_1=__webpack_require__(304),rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24);window.moduleIds.push("$$APP_PWD_PART1$$"),window.moduleIds.push("$$APP_PWD_PART2$$"),window.moduleIds.push("$$APP_PWD_PART3$$"),window.moduleIds.push("$$APP_PWD_PART4$$");class AuthService{constructor(){this.SSO_LOGIN_POPUP_WINDOW_NAME="Single Sign-On Login",this.token=null,this.appToken=null,this.login=null,this.userId=null,this.jidIm=null,this.jidTel=null,this.jidPwd=null,this.xmppDomain=null,this.companyId=null,this.firstUseNewVersion=!1,this.initialized=!1,this.isGuest=!1,this.authType="RAINBOW",this.fromSDK=!1,this.authSettings=null,this.browserFingerprint=null,this.visibilityHandlerRemoval=null,this.renewTokenInterval=null,this.renewAppTokenInterval=null,this.sdkHostForced=null,this.win=window,this.rxSubject=new rxjs_1.Subject;const storedVersion=localStorage.getItem("version"),storedMajorVersion=this.getMajorVersion(storedVersion),currentMajorVersion=this.getMajorVersion(this.win.version);config.appModuleKey||(config.appModuleKey=this.win.moduleIds?this.win.moduleIds.join(""):"default"),storedMajorVersion!==currentMajorVersion&&(this.firstUseNewVersion=!0),localStorage.setItem("version",this.win.version),this.getServerApiUrls()}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.authService||(win.rainbow.authService=new AuthService),win.rainbow.authService}subscribe(handler){return this.rxSubject.subscribe(handler)}emitEvent(eventName){this.rxSubject.next(event_model_1.RBEvent.create(eventName))}logon(login,password,rememberMe,authSettings=null){return __awaiter(this,void 0,void 0,(function*(){try{if(-1===login.indexOf("@"))throw this.createError(`Wrong login format '${login}'`,"errorUnauthorized",401500,void 0,!0);let url=config.restServerUrl+"/api/rainbow/authentication/v1.0/login";authSettings&&("RAINBOW"===authSettings.type?url=authSettings.loginUrl:authSettings.safetyUrl&&(url=authSettings.safetyUrl,this.authType=authSettings.type));const headers={};headers.Authorization="Basic "+window.btoa(unescape(encodeURIComponent(login+":"+password))),headers.Accept="application/json",this.setInformationHeaders(headers);let clientKey=null;config.rainbowApiClientKey&&(clientKey=config.rainbowApiClientKey+":"+crypto_js_1.SHA256(config.appModuleKey+password)),this.fromSDK&&this.appToken&&this.appToken.appID&&(clientKey=this.appToken.appID+":"+crypto_js_1.SHA256(this.appToken.appSecret+password)),clientKey&&(headers["x-rainbow-app-auth"]="Basic "+window.btoa(unescape(encodeURIComponent(clientKey))));const response=yield fetchWithTimeout_1.default(url,{method:"GET",headers:headers,credentials:"include"});if(!response.ok)throw response;const responseData=yield response.json();this.token=responseData.token,this.extractUserInfo(responseData.loggedInUser),rememberMe?(logger_service_1.default.info("[AuthService] Store authentication info in local storage"),localStorage.setItem("login",this.login),localStorage.setItem("id",this.userId),localStorage.setItem("token",this.token),localStorage.setItem("authType",this.authType)):this.removeCredentials(),localStorage.setItem("firstUse","false"),logger_service_1.default.info(`[AuthService] Authenticate with ${login} -- SUCCESS`),this.registerEventsHandler(),this.startTokenSurvey()}catch(error){let errorMessage=`authenticate for login ${login} -- FAILURE -- `;if(error.localError)throw logger_service_1.default.error(`[AuthService] ${errorMessage} ${error}`),error;let errorStatus="errorUltimateUnknownError",errorCode=null,errorData=null;if(0===error.status||-1===error.status)errorMessage+="No server response",errorStatus="errorNoServerResponse";else{const responseData=yield error.json();401===error.status?(this.removeCredentials(),errorMessage+=responseData.errorDetails,errorCode=responseData.errorDetailsCode,401500===responseData.errorDetailsCode?errorStatus="errorUnauthorized":401501===responseData.errorDetailsCode&&(errorStatus="errorLoginForbidden",responseData.errorDetailsData&&(errorData={delay:responseData.errorDetailsData.forbiddenDelay}))):500===error.status&&(errorMessage+=responseData.errorDetails,errorStatus="errorInternalServerError")}throw logger_service_1.default.error("[AuthService] "+errorMessage),this.createError(errorMessage,errorStatus,errorCode,errorData)}}))}logonWithToken(token=null){return __awaiter(this,void 0,void 0,(function*(){try{if(logger_service_1.default.info("[authService] logonWithToken -- "+token),token||(token=localStorage.getItem("token")),!token)throw new Error("No token");const decodedToken=jwtDecode(token);this.token=token,this.login=decodedToken.user.loginEmail,this.userId=decodedToken.user.id,this.authType="RAINBOW",decodedToken.saml&&(this.authType="SAML"),decodedToken.oidc&&(this.authType="OIDC"),localStorage.setItem("token",this.token),localStorage.setItem("login",this.login),localStorage.setItem("id",this.userId),localStorage.setItem("authType",this.authType),yield this.getUserData(),yield this.startTokenSurvey(),this.authSettings=yield this.getUserAuthenticationSettings(this.login),this.registerEventsHandler()}catch(error){const errorMessage=error?error.message:"Unknown error";throw"No token"===errorMessage?logger_service_1.default.debug("[AuthService] AuthenticateWithToken -- No available token"):logger_service_1.default.error("[AuthService] AuthenticateWithToken -- FAILURE -- "+errorMessage),new Error(errorMessage)}}))}sdkLogOn(login,password,host,appToken,token){return __awaiter(this,void 0,void 0,(function*(){return this.sdkHostForced=host,this.appToken=appToken,this.fromSDK=!0,this.getServerApiUrls(),token?this.logonWithToken(token):this.logon(login,password,!1)}))}sdkSetRenewedToken(token=null){try{return this.token=token,localStorage.setItem("token",this.token),this.startUserTokenSurvey(),void logger_service_1.default.debug("[AuthService] StartTokenSurvey -- SUCCESS")}catch(error){const newError=error&&error.message?error:new Error("Unknown error");throw logger_service_1.default.error("[AuthService] StartTokenSurvey -- FAILURE -- "+newError.message),newError}}logout(){return this.removeCredentials(),this.authSettings&&this.authSettings.logoutUrl&&"RAINBOW"!==this.authType?(logger_service_1.default.info("[authService] Logout -- "+this.authType),this.authSettings.setParameter("token",()=>this.token),this.authSettings.logoutUrl):(logger_service_1.default.info("[AuthService] Logout -- SUCCESS"),null)}getUserAuthenticationSettings(login=null,inAppAuth=!1){return __awaiter(this,void 0,void 0,(function*(){try{const defaultLoginUrl=config.restServerUrl+"/api/rainbow/authentication/v1.0/login";if(config.disableSSO&&(inAppAuth=!0),inAppAuth)return authSettings_model_1.AuthSettings.createFromData([{type:"RAINBOW",loginUrl:defaultLoginUrl}]);const url=`${config.restServerUrl}/api/rainbow/authentication/v1.0/urls?uid=${encodeURIComponent(login)}`,headers={};this.setInformationHeaders(headers);const response=yield fetchWithTimeout_1.default(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json(),authSettings=authSettings_model_1.AuthSettings.createFromData(responseData.data);return authSettings.setParameter("uid",()=>login),authSettings.setParameter("x-rainbow-app-auth",challenge=>this.getRainbowAppAuth(config.rainbowApiClientKey,config.appModuleKey,challenge)),!window||-1===window.location.href.indexOf("localhost")&&-1===window.location.href.indexOf("openrainbow.red")||authSettings.setParameter("safetyUrl",()=>defaultLoginUrl),authSettings}catch(error){let errorMessage='authenticate for login "'+login+'" failure : ',errorStatus="errorUltimateUnknownError";if(0===error.status||-1===error.status)errorMessage+="No server response",errorStatus="errorNoServerResponse";else{const responseData=yield error.json();400===error.status||404===error.status?(errorMessage+=responseData.errorDetails,errorStatus="noMatchingAccount"):500===error.status&&(errorMessage+=responseData.errorDetails,errorStatus="errorInternalServerError")}logger_service_1.default.info("[authService] "+errorMessage);const newError=new Error(errorMessage);throw newError.details=errorStatus,newError}}))}removeCredentials(){this.authType="RAINBOW",localStorage.removeItem("id"),localStorage.removeItem("token"),localStorage.removeItem("authType"),localStorage.removeItem("token"),this.isGuest&&(localStorage.removeItem("login"),this.isGuest=!1),this.resetUserEnvironment(),logger_service_1.default.debug("[AuthService] removeCredentials -- SUCCESS")}resetUserEnvironment(){config.defaultEnvironment&&(config.xmpp.currentServer=config.defaultEnvironment,config.xmpp.server=config.defaultEnvironment,config.webservices.currentServer=config.defaultEnvironment,config.webservices.server=config.defaultEnvironment)}getRequestHeader(){return{Authorization:"Bearer "+this.token,Accept:"application/json"}}getRequestHeaderWithRange(range){const header=this.getRequestHeader();return header.Range=range,header}getPostHeader(contentType=null){const header=this.getRequestHeader();return header["Content-Type"]=contentType||"application/json",header}getPostHeaderWithRange(range,contentType){const header=this.getPostHeader(contentType);return header["Content-Range"]=range,header}setInformationHeaders(headers){headers["x-rainbow-client"]=this.getInformationHeadersApp(),headers["x-rainbow-client-version"]=this.getInformationHeadersAppVersion()}getInformationHeadersApp(){return"web_sdk"}getInformationHeadersAppVersion(){const winAsAny=window;return winAsAny.sdkversion?winAsAny.sdkversion:"9.9.99"}startTokenSurvey(){return __awaiter(this,void 0,void 0,(function*(){try{yield this.startAppTokenSurvey(),yield this.startUserTokenSurvey(),logger_service_1.default.debug("[AuthService] StartTokenSurvey -- SUCCESS")}catch(error){const newError=error&&error.message?error:new Error("Unknown error");throw logger_service_1.default.error("[AuthService] StartTokenSurvey -- FAILURE -- "+newError.message),newError}}))}getRainbowAppAuth(appId,appSecret,password=null){return window.btoa(unescape(encodeURIComponent((appId||"")+":"+crypto_js_1.SHA256((appSecret||"")+(password||"")))))}registerEventsHandler(){this.visibilityHandlerRemoval&&this.visibilityHandlerRemoval(),this.visibilityHandlerRemoval=event_service_1.default.subscribe("ON_APP_VISIBLE_CHANGE_EVENT",(__event,visible)=>{visible&&this.startTokenSurvey()})}getMajorVersion(appVersion){if(!appVersion)return null;const result=/\d+\.\d+/g.exec(appVersion);return result&&result.length>0?result[0]:null}getServerApiUrls(){const server=localStorage.getItem("server");server&&"null"!==server&&"undefined"!==server?(logger_service_1.default.debug("[AuthService] getServerApiUrls -- Find server data from local storage -- "+server),config.xmpp.currentServer=config.webservices.currentServer=server,"openrainbow.net"===server&&(config.appModuleKey=config.dotNetAppModuleKey,config.rainbowApiClientKey=config.dotNetRainbowApiClientKey,config.multiEnvServer="openrainbow.net"),"openrainbow.com"===server&&(config.appModuleKey=config.dotComAppModuleKey,config.rainbowApiClientKey=config.dotComRainbowApiClientKey,config.multiEnvServer="openrainbow.com"),"openrainbow.red"===server&&(config.appModuleKey=config.dotComAppModuleKey,config.rainbowApiClientKey=config.dotComRainbowApiClientKey,config.multiEnvServer="openrainbow.com"),config.defaultEnvironment||(config.defaultEnvironment=config.xmpp.currentServer)):this.sdkHostForced?(config.xmpp.currentServer=config.webservices.currentServer=this.sdkHostForced,logger_service_1.default.debug("[AuthService] getServerApiUrls -- Use forced sdk server -- "+this.sdkHostForced)):config.xmpp&&(config.xmpp.currentServer=config.xmpp.server,config.webservices.currentServer=config.webservices.server,logger_service_1.default.debug("[AuthService] getServerApiUrls -- Use default config server -- "+config.xmpp.server)),config.webservices&&(config.restServerUrl=`${config.webservices.protocol}://${config.webservices.currentServer}:${config.webservices.port}`)}startAppTokenSurvey(){return __awaiter(this,void 0,void 0,(function*(){if(!this.appToken||"string"!=typeof this.appToken||!this.appToken.length)return void logger_service_1.default.info("[AuthService] startAppTokenSurvey -- No application token.");const decodedToken=jwtDecode(this.appToken),tokenExpirationTimestamp=1e3*decodedToken.exp,expirationDate=new Date(tokenExpirationTimestamp),tokenExpirationDuration=tokenExpirationTimestamp-(new Date).valueOf();if(this.renewAppTokenInterval&&clearTimeout(this.renewAppTokenInterval),logger_service_1.default.info("[AuthService] startAppTokenSurvey -- Extract application token info (countRenewed: "+decodedToken.countRenewed+", maxTokenRenew: "+decodedToken.maxTokenRenew+")"),tokenExpirationDuration<0)return logger_service_1.default.info("[AuthService] startAppTokenSurvey -- Application token has already expired, re-new it immediately"),void(yield this.renewAppToken());if(tokenExpirationDuration<3e4)return logger_service_1.default.info("[AuthService] startAppTokenSurvey -- Application token will expire in less 5 minutes, re-new it immediately"),void(yield this.renewAppToken());const usedExpirationDuration=tokenExpirationDuration-24e3;logger_service_1.default.info("[authService] startAppTokenSurvey -- Start application token survey (expirationDate: "+expirationDate+" tokenExpirationDuration: "+tokenExpirationDuration+"ms usedExpirationDuration: "+usedExpirationDuration+"ms)"),this.renewAppTokenInterval=setTimeout(()=>{this.renewAppToken()},usedExpirationDuration)}))}renewAppToken(){return __awaiter(this,void 0,void 0,(function*(){try{const url=config.restServerUrl+"/api/rainbow/applications/v1.0/authentication/renew",response=yield fetchWithTimeout_1.default(url,{method:"GET",headers:this.getRequestHeader()});if(!response.ok)throw response;const responseData=yield response.json();logger_service_1.default.info("[AuthService] renewAppToken -- Renew application token success"),this.appToken=responseData.token,localStorage.setItem("appToken",this.appToken),this.emitEvent("ON_APP_TOKEN_RENEW"),this.startAppTokenSurvey()}catch(error){this.renewAppTokenInterval&&clearTimeout(this.renewAppTokenInterval);const responseData=yield error.json(),errorMessage="Renew application token failure -- "+(responseData&&responseData.errorDetails?responseData.errorDetails:"no details"),newError=new Error(errorMessage);throw newError.details="APP_TOKEN_EXPIRED",logger_service_1.default.error("[AuthService] renewAppToken -- FAILURE --"+errorMessage),this.emitEvent("ON_APP_TOKEN_EXPIRE"),newError}}))}startUserTokenSurvey(){return __awaiter(this,void 0,void 0,(function*(){if(!this.token||"string"!=typeof this.token||!this.token.length)return void logger_service_1.default.info("[AuthService] No token.");const decodedToken=jwtDecode(this.token),tokenExpirationTimestamp=1e3*decodedToken.exp,halfTokenDuration=(tokenExpirationTimestamp-1e3*decodedToken.iat)/2,expirationDate=new Date(tokenExpirationTimestamp),tokenExpirationDuration=tokenExpirationTimestamp-(new Date).valueOf();if(this.renewTokenInterval&&clearTimeout(this.renewTokenInterval),logger_service_1.default.info("[AuthService] startUserTokenSurvey -- Extract auth token info (countRenewed: "+decodedToken.countRenewed+", maxTokenRenew: "+decodedToken.maxTokenRenew+", tokenExpirationDuration: "+tokenExpirationDuration+")"),tokenExpirationDuration<0)throw logger_service_1.default.info("[AuthService] startUserTokenSurvey --  Auth token has already expired send ON_AUTH_TOKEN_EXPIRE event"),this.token=null,this.emitEvent("ON_AUTH_TOKEN_EXPIRE"),new Error("Token expired");if(tokenExpirationDuration<halfTokenDuration)return logger_service_1.default.info("[AuthService] startUserTokenSurvey -- Auth token will expire in less "+halfTokenDuration/1e3+" seconds"),this.emitEvent("ON_AUTH_TOKEN_WILL_EXPIRE"),logger_service_1.default.info("[AuthService] startUserTokenSurvey send ON_AUTH_TOKEN_WILL_EXPIRE event"),void(void 0===decodedToken.oauth&&(logger_service_1.default.info("[AuthService] startUserTokenSurvey -- try to re-new it immediately"),yield this.renewAuthToken()));const usedExpirationDuration=tokenExpirationDuration-halfTokenDuration;logger_service_1.default.info("[AuthService] startUserTokenSurvey -- Start auth token survey (expirationDate: "+expirationDate+" tokenExpirationDuration: "+tokenExpirationDuration+"ms usedExpirationDuration: "+usedExpirationDuration+"ms)"),this.renewTokenInterval=setTimeout(()=>{void 0===decodedToken.oauth?this.renewAuthToken():this.startTokenSurvey()},usedExpirationDuration)}))}renewAuthToken(restartTokenSurvey=!1){return __awaiter(this,void 0,void 0,(function*(){try{const url=config.restServerUrl+"/api/rainbow/authentication/v1.0/renew",response=yield fetchWithTimeout_1.default(url,{method:"GET",headers:this.getRequestHeader()});if(!response.ok)throw response;const responseData=yield response.json();logger_service_1.default.info("[AuthService] renewAuthToken -- Renew authentication token success"),this.token=responseData.token,localStorage.setItem("token",this.token),this.emitEvent("ON_AUTH_TOKEN_RENEW"),restartTokenSurvey&&!0!==restartTokenSurvey||this.startTokenSurvey()}catch(error){this.renewTokenInterval&&clearTimeout(this.renewTokenInterval);const responseData=yield error.json(),errorMessage="Renew authentication token failure -- "+(responseData&&responseData.errorDetails?responseData.errorDetails:"no details"),newError=new Error(errorMessage);throw newError.details="AUTH_TOKEN_EXPIRED",logger_service_1.default.error("[AuthService] renewAuthToken -- FAILURE -- "+errorMessage),this.emitEvent("ON_AUTH_TOKEN_EXPIRE"),newError}}))}getUserData(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.userId}`,response=yield fetchWithTimeout_1.default(url,{method:"GET",headers:this.getRequestHeader()});if(!response.ok)throw response;const responseData=yield response.json();this.extractUserInfo(responseData.data)}catch(error){if(this.removeCredentials(),error instanceof Response)throw new Error("Wrong token -- "+error.statusText);throw new Error("Wrong token -- "+error.message)}}))}getUserEnvironments(login){return __awaiter(this,void 0,void 0,(function*(){try{if(!config.multiEnvServer)return[{environmentApiUrl:"https://"+config.xmpp.server}];config.defaultEnvironment||(config.defaultEnvironment=config.xmpp.server);const url=config.webservices.protocol+"://"+config.multiEnvServer+":"+config.webservices.port+"/api/rainbow/multienvironments/v1.0/environments?loginEmail="+encodeURIComponent(login),response=yield fetchWithTimeout_1.default(url,{method:"GET"});if(!response.ok)throw response;return(yield response.json()).data}catch(error){let errorMessage='getUserEnvironments for login "'+login+'" failure : ';if(0===error.status||-1===error.status)errorMessage+="No server response";else if(500===error.status){errorMessage+=(yield error.json()).errorDetails}return logger_service_1.default.info("[authService] "+errorMessage),logger_service_1.default.info("[authService] getUserEnvironment -- continue with default environment"),null}}))}getCompanySAMLConfiguration(companyId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/authentication/v1.0/saml/${companyId}/metadata.xml`,response=yield fetchWithTimeout_1.default(url,{method:"GET",headers:this.getRequestHeader()});if(!response.ok)throw response;return logger_service_1.default.debug("[AuthService] getCompanySAMLConfiguration -- SUCCESS"),yield response.text()}catch(error){throw logger_service_1.default.error("[AuthService] getCompanySAMLConfiguration -- FAILURE -- "+JSON.stringify(error)),new Error("getCompanySAMLConfiguration failure")}}))}getFingerPrint(){return __awaiter(this,void 0,void 0,(function*(){if(!this.browserFingerprint){const browserTests=["audio","availableScreenResolution","canvas","colorDepth","cookies","cpuClass","deviceDpi","doNotTrack","indexedDb","installedFonts","language","localStorage","pixelRatio","platform","plugins","processorCores","screenResolution","sessionStorage","timezoneOffset","touchSupport","userAgent","webGl"];this.browserFingerprint=yield imprint.test(browserTests)}return this.browserFingerprint}))}handleUserLanguage(){const userServerLanguage=this.loggedInUser.language;userServerLanguage&&settings_service_1.default.setAppliLangageCodeFromServer(userServerLanguage)}createError(message,details=null,detailsCode=null,detailsData=null,localError=!1){const error=new Error(message);return error.details=details,error.detailsCode=detailsCode,error.detailsData=detailsData,error.localError=localError,error}extractUserInfo(responseData){this.loggedInUser=responseData,this.login=this.loggedInUser.loginEmail,this.userId=this.loggedInUser.id,this.jidIm=this.loggedInUser.jid_im,this.jidPwd=this.loggedInUser.jid_password,this.jidTel=this.loggedInUser.jid_tel,this.initialized=this.loggedInUser.isInitialized,this.isGuest=this.loggedInUser.guestMode,this.companyId=this.loggedInUser.companyId,this.xmppDomain=this.jidIm.split("@")[1],this.handleUserLanguage()}}exports.AuthService=AuthService,exports.default=AuthService.getInstance()},function(module,exports,__webpack_require__){(function(module){module.exports=function(){"use strict";var hookCallback,some;function hooks(){return hookCallback.apply(null,arguments)}function isArray(input){return input instanceof Array||"[object Array]"===Object.prototype.toString.call(input)}function isObject(input){return null!=input&&"[object Object]"===Object.prototype.toString.call(input)}function hasOwnProp(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function isObjectEmpty(obj){if(Object.getOwnPropertyNames)return 0===Object.getOwnPropertyNames(obj).length;var k;for(k in obj)if(hasOwnProp(obj,k))return!1;return!0}function isUndefined(input){return void 0===input}function isNumber(input){return"number"==typeof input||"[object Number]"===Object.prototype.toString.call(input)}function isDate(input){return input instanceof Date||"[object Date]"===Object.prototype.toString.call(input)}function map(arr,fn){var i,res=[];for(i=0;i<arr.length;++i)res.push(fn(arr[i],i));return res}function extend(a,b){for(var i in b)hasOwnProp(b,i)&&(a[i]=b[i]);return hasOwnProp(b,"toString")&&(a.toString=b.toString),hasOwnProp(b,"valueOf")&&(a.valueOf=b.valueOf),a}function createUTC(input,format,locale,strict){return createLocalOrUTC(input,format,locale,strict,!0).utc()}function getParsingFlags(m){return null==m._pf&&(m._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidEra:null,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],era:null,meridiem:null,rfc2822:!1,weekdayMismatch:!1}),m._pf}function isValid(m){if(null==m._isValid){var flags=getParsingFlags(m),parsedParts=some.call(flags.parsedDateParts,(function(i){return null!=i})),isNowValid=!isNaN(m._d.getTime())&&flags.overflow<0&&!flags.empty&&!flags.invalidEra&&!flags.invalidMonth&&!flags.invalidWeekday&&!flags.weekdayMismatch&&!flags.nullInput&&!flags.invalidFormat&&!flags.userInvalidated&&(!flags.meridiem||flags.meridiem&&parsedParts);if(m._strict&&(isNowValid=isNowValid&&0===flags.charsLeftOver&&0===flags.unusedTokens.length&&void 0===flags.bigHour),null!=Object.isFrozen&&Object.isFrozen(m))return isNowValid;m._isValid=isNowValid}return m._isValid}function createInvalid(flags){var m=createUTC(NaN);return null!=flags?extend(getParsingFlags(m),flags):getParsingFlags(m).userInvalidated=!0,m}some=Array.prototype.some?Array.prototype.some:function(fun){var i,t=Object(this),len=t.length>>>0;for(i=0;i<len;i++)if(i in t&&fun.call(this,t[i],i,t))return!0;return!1};var momentProperties=hooks.momentProperties=[],updateInProgress=!1;function copyConfig(to,from){var i,prop,val;if(isUndefined(from._isAMomentObject)||(to._isAMomentObject=from._isAMomentObject),isUndefined(from._i)||(to._i=from._i),isUndefined(from._f)||(to._f=from._f),isUndefined(from._l)||(to._l=from._l),isUndefined(from._strict)||(to._strict=from._strict),isUndefined(from._tzm)||(to._tzm=from._tzm),isUndefined(from._isUTC)||(to._isUTC=from._isUTC),isUndefined(from._offset)||(to._offset=from._offset),isUndefined(from._pf)||(to._pf=getParsingFlags(from)),isUndefined(from._locale)||(to._locale=from._locale),momentProperties.length>0)for(i=0;i<momentProperties.length;i++)isUndefined(val=from[prop=momentProperties[i]])||(to[prop]=val);return to}function Moment(config){copyConfig(this,config),this._d=new Date(null!=config._d?config._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),!1===updateInProgress&&(updateInProgress=!0,hooks.updateOffset(this),updateInProgress=!1)}function isMoment(obj){return obj instanceof Moment||null!=obj&&null!=obj._isAMomentObject}function warn(msg){!1===hooks.suppressDeprecationWarnings&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+msg)}function deprecate(msg,fn){var firstTime=!0;return extend((function(){if(null!=hooks.deprecationHandler&&hooks.deprecationHandler(null,msg),firstTime){var arg,i,key,args=[];for(i=0;i<arguments.length;i++){if(arg="","object"==typeof arguments[i]){for(key in arg+="\n["+i+"] ",arguments[0])hasOwnProp(arguments[0],key)&&(arg+=key+": "+arguments[0][key]+", ");arg=arg.slice(0,-2)}else arg=arguments[i];args.push(arg)}warn(msg+"\nArguments: "+Array.prototype.slice.call(args).join("")+"\n"+(new Error).stack),firstTime=!1}return fn.apply(this,arguments)}),fn)}var keys,deprecations={};function deprecateSimple(name,msg){null!=hooks.deprecationHandler&&hooks.deprecationHandler(name,msg),deprecations[name]||(warn(msg),deprecations[name]=!0)}function isFunction(input){return"undefined"!=typeof Function&&input instanceof Function||"[object Function]"===Object.prototype.toString.call(input)}function mergeConfigs(parentConfig,childConfig){var prop,res=extend({},parentConfig);for(prop in childConfig)hasOwnProp(childConfig,prop)&&(isObject(parentConfig[prop])&&isObject(childConfig[prop])?(res[prop]={},extend(res[prop],parentConfig[prop]),extend(res[prop],childConfig[prop])):null!=childConfig[prop]?res[prop]=childConfig[prop]:delete res[prop]);for(prop in parentConfig)hasOwnProp(parentConfig,prop)&&!hasOwnProp(childConfig,prop)&&isObject(parentConfig[prop])&&(res[prop]=extend({},res[prop]));return res}function Locale(config){null!=config&&this.set(config)}function zeroFill(number,targetLength,forceSign){var absNumber=""+Math.abs(number),zerosToFill=targetLength-absNumber.length;return(number>=0?forceSign?"+":"":"-")+Math.pow(10,Math.max(0,zerosToFill)).toString().substr(1)+absNumber}hooks.suppressDeprecationWarnings=!1,hooks.deprecationHandler=null,keys=Object.keys?Object.keys:function(obj){var i,res=[];for(i in obj)hasOwnProp(obj,i)&&res.push(i);return res};var formattingTokens=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,localFormattingTokens=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,formatFunctions={},formatTokenFunctions={};function addFormatToken(token,padded,ordinal,callback){var func=callback;"string"==typeof callback&&(func=function(){return this[callback]()}),token&&(formatTokenFunctions[token]=func),padded&&(formatTokenFunctions[padded[0]]=function(){return zeroFill(func.apply(this,arguments),padded[1],padded[2])}),ordinal&&(formatTokenFunctions[ordinal]=function(){return this.localeData().ordinal(func.apply(this,arguments),token)})}function formatMoment(m,format){return m.isValid()?(format=expandFormat(format,m.localeData()),formatFunctions[format]=formatFunctions[format]||function(format){var i,length,input,array=format.match(formattingTokens);for(i=0,length=array.length;i<length;i++)formatTokenFunctions[array[i]]?array[i]=formatTokenFunctions[array[i]]:array[i]=(input=array[i]).match(/\[[\s\S]/)?input.replace(/^\[|\]$/g,""):input.replace(/\\/g,"");return function(mom){var i,output="";for(i=0;i<length;i++)output+=isFunction(array[i])?array[i].call(mom,format):array[i];return output}}(format),formatFunctions[format](m)):m.localeData().invalidDate()}function expandFormat(format,locale){var i=5;function replaceLongDateFormatTokens(input){return locale.longDateFormat(input)||input}for(localFormattingTokens.lastIndex=0;i>=0&&localFormattingTokens.test(format);)format=format.replace(localFormattingTokens,replaceLongDateFormatTokens),localFormattingTokens.lastIndex=0,i-=1;return format}var aliases={};function addUnitAlias(unit,shorthand){var lowerCase=unit.toLowerCase();aliases[lowerCase]=aliases[lowerCase+"s"]=aliases[shorthand]=unit}function normalizeUnits(units){return"string"==typeof units?aliases[units]||aliases[units.toLowerCase()]:void 0}function normalizeObjectUnits(inputObject){var normalizedProp,prop,normalizedInput={};for(prop in inputObject)hasOwnProp(inputObject,prop)&&(normalizedProp=normalizeUnits(prop))&&(normalizedInput[normalizedProp]=inputObject[prop]);return normalizedInput}var priorities={};function addUnitPriority(unit,priority){priorities[unit]=priority}function isLeapYear(year){return year%4==0&&year%100!=0||year%400==0}function absFloor(number){return number<0?Math.ceil(number)||0:Math.floor(number)}function toInt(argumentForCoercion){var coercedNumber=+argumentForCoercion,value=0;return 0!==coercedNumber&&isFinite(coercedNumber)&&(value=absFloor(coercedNumber)),value}function makeGetSet(unit,keepTime){return function(value){return null!=value?(set$1(this,unit,value),hooks.updateOffset(this,keepTime),this):get(this,unit)}}function get(mom,unit){return mom.isValid()?mom._d["get"+(mom._isUTC?"UTC":"")+unit]():NaN}function set$1(mom,unit,value){mom.isValid()&&!isNaN(value)&&("FullYear"===unit&&isLeapYear(mom.year())&&1===mom.month()&&29===mom.date()?(value=toInt(value),mom._d["set"+(mom._isUTC?"UTC":"")+unit](value,mom.month(),daysInMonth(value,mom.month()))):mom._d["set"+(mom._isUTC?"UTC":"")+unit](value))}var regexes,match1=/\d/,match2=/\d\d/,match3=/\d{3}/,match4=/\d{4}/,match6=/[+-]?\d{6}/,match1to2=/\d\d?/,match3to4=/\d\d\d\d?/,match5to6=/\d\d\d\d\d\d?/,match1to3=/\d{1,3}/,match1to4=/\d{1,4}/,match1to6=/[+-]?\d{1,6}/,matchUnsigned=/\d+/,matchSigned=/[+-]?\d+/,matchOffset=/Z|[+-]\d\d:?\d\d/gi,matchShortOffset=/Z|[+-]\d\d(?::?\d\d)?/gi,matchWord=/[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i;function addRegexToken(token,regex,strictRegex){regexes[token]=isFunction(regex)?regex:function(isStrict,localeData){return isStrict&&strictRegex?strictRegex:regex}}function getParseRegexForToken(token,config){return hasOwnProp(regexes,token)?regexes[token](config._strict,config._locale):new RegExp(regexEscape(token.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,(function(matched,p1,p2,p3,p4){return p1||p2||p3||p4}))))}function regexEscape(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}regexes={};var indexOf,tokens={};function addParseToken(token,callback){var i,func=callback;for("string"==typeof token&&(token=[token]),isNumber(callback)&&(func=function(input,array){array[callback]=toInt(input)}),i=0;i<token.length;i++)tokens[token[i]]=func}function addWeekParseToken(token,callback){addParseToken(token,(function(input,array,config,token){config._w=config._w||{},callback(input,config._w,config,token)}))}function addTimeToArrayFromToken(token,input,config){null!=input&&hasOwnProp(tokens,token)&&tokens[token](input,config._a,config,token)}function daysInMonth(year,month){if(isNaN(year)||isNaN(month))return NaN;var x,modMonth=(month%(x=12)+x)%x;return year+=(month-modMonth)/12,1===modMonth?isLeapYear(year)?29:28:31-modMonth%7%2}indexOf=Array.prototype.indexOf?Array.prototype.indexOf:function(o){var i;for(i=0;i<this.length;++i)if(this[i]===o)return i;return-1},addFormatToken("M",["MM",2],"Mo",(function(){return this.month()+1})),addFormatToken("MMM",0,0,(function(format){return this.localeData().monthsShort(this,format)})),addFormatToken("MMMM",0,0,(function(format){return this.localeData().months(this,format)})),addUnitAlias("month","M"),addUnitPriority("month",8),addRegexToken("M",match1to2),addRegexToken("MM",match1to2,match2),addRegexToken("MMM",(function(isStrict,locale){return locale.monthsShortRegex(isStrict)})),addRegexToken("MMMM",(function(isStrict,locale){return locale.monthsRegex(isStrict)})),addParseToken(["M","MM"],(function(input,array){array[1]=toInt(input)-1})),addParseToken(["MMM","MMMM"],(function(input,array,config,token){var month=config._locale.monthsParse(input,token,config._strict);null!=month?array[1]=month:getParsingFlags(config).invalidMonth=input}));var defaultLocaleMonths="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),defaultLocaleMonthsShort="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),MONTHS_IN_FORMAT=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,defaultMonthsShortRegex=matchWord,defaultMonthsRegex=matchWord;function handleStrictParse(monthName,format,strict){var i,ii,mom,llc=monthName.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],i=0;i<12;++i)mom=createUTC([2e3,i]),this._shortMonthsParse[i]=this.monthsShort(mom,"").toLocaleLowerCase(),this._longMonthsParse[i]=this.months(mom,"").toLocaleLowerCase();return strict?"MMM"===format?-1!==(ii=indexOf.call(this._shortMonthsParse,llc))?ii:null:-1!==(ii=indexOf.call(this._longMonthsParse,llc))?ii:null:"MMM"===format?-1!==(ii=indexOf.call(this._shortMonthsParse,llc))||-1!==(ii=indexOf.call(this._longMonthsParse,llc))?ii:null:-1!==(ii=indexOf.call(this._longMonthsParse,llc))||-1!==(ii=indexOf.call(this._shortMonthsParse,llc))?ii:null}function setMonth(mom,value){var dayOfMonth;if(!mom.isValid())return mom;if("string"==typeof value)if(/^\d+$/.test(value))value=toInt(value);else if(!isNumber(value=mom.localeData().monthsParse(value)))return mom;return dayOfMonth=Math.min(mom.date(),daysInMonth(mom.year(),value)),mom._d["set"+(mom._isUTC?"UTC":"")+"Month"](value,dayOfMonth),mom}function getSetMonth(value){return null!=value?(setMonth(this,value),hooks.updateOffset(this,!0),this):get(this,"Month")}function computeMonthsParse(){function cmpLenRev(a,b){return b.length-a.length}var i,mom,shortPieces=[],longPieces=[],mixedPieces=[];for(i=0;i<12;i++)mom=createUTC([2e3,i]),shortPieces.push(this.monthsShort(mom,"")),longPieces.push(this.months(mom,"")),mixedPieces.push(this.months(mom,"")),mixedPieces.push(this.monthsShort(mom,""));for(shortPieces.sort(cmpLenRev),longPieces.sort(cmpLenRev),mixedPieces.sort(cmpLenRev),i=0;i<12;i++)shortPieces[i]=regexEscape(shortPieces[i]),longPieces[i]=regexEscape(longPieces[i]);for(i=0;i<24;i++)mixedPieces[i]=regexEscape(mixedPieces[i]);this._monthsRegex=new RegExp("^("+mixedPieces.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+longPieces.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+shortPieces.join("|")+")","i")}function daysInYear(year){return isLeapYear(year)?366:365}addFormatToken("Y",0,0,(function(){var y=this.year();return y<=9999?zeroFill(y,4):"+"+y})),addFormatToken(0,["YY",2],0,(function(){return this.year()%100})),addFormatToken(0,["YYYY",4],0,"year"),addFormatToken(0,["YYYYY",5],0,"year"),addFormatToken(0,["YYYYYY",6,!0],0,"year"),addUnitAlias("year","y"),addUnitPriority("year",1),addRegexToken("Y",matchSigned),addRegexToken("YY",match1to2,match2),addRegexToken("YYYY",match1to4,match4),addRegexToken("YYYYY",match1to6,match6),addRegexToken("YYYYYY",match1to6,match6),addParseToken(["YYYYY","YYYYYY"],0),addParseToken("YYYY",(function(input,array){array[0]=2===input.length?hooks.parseTwoDigitYear(input):toInt(input)})),addParseToken("YY",(function(input,array){array[0]=hooks.parseTwoDigitYear(input)})),addParseToken("Y",(function(input,array){array[0]=parseInt(input,10)})),hooks.parseTwoDigitYear=function(input){return toInt(input)+(toInt(input)>68?1900:2e3)};var getSetYear=makeGetSet("FullYear",!0);function createDate(y,m,d,h,M,s,ms){var date;return y<100&&y>=0?(date=new Date(y+400,m,d,h,M,s,ms),isFinite(date.getFullYear())&&date.setFullYear(y)):date=new Date(y,m,d,h,M,s,ms),date}function createUTCDate(y){var date,args;return y<100&&y>=0?((args=Array.prototype.slice.call(arguments))[0]=y+400,date=new Date(Date.UTC.apply(null,args)),isFinite(date.getUTCFullYear())&&date.setUTCFullYear(y)):date=new Date(Date.UTC.apply(null,arguments)),date}function firstWeekOffset(year,dow,doy){var fwd=7+dow-doy;return-(7+createUTCDate(year,0,fwd).getUTCDay()-dow)%7+fwd-1}function dayOfYearFromWeeks(year,week,weekday,dow,doy){var resYear,resDayOfYear,dayOfYear=1+7*(week-1)+(7+weekday-dow)%7+firstWeekOffset(year,dow,doy);return dayOfYear<=0?resDayOfYear=daysInYear(resYear=year-1)+dayOfYear:dayOfYear>daysInYear(year)?(resYear=year+1,resDayOfYear=dayOfYear-daysInYear(year)):(resYear=year,resDayOfYear=dayOfYear),{year:resYear,dayOfYear:resDayOfYear}}function weekOfYear(mom,dow,doy){var resWeek,resYear,weekOffset=firstWeekOffset(mom.year(),dow,doy),week=Math.floor((mom.dayOfYear()-weekOffset-1)/7)+1;return week<1?resWeek=week+weeksInYear(resYear=mom.year()-1,dow,doy):week>weeksInYear(mom.year(),dow,doy)?(resWeek=week-weeksInYear(mom.year(),dow,doy),resYear=mom.year()+1):(resYear=mom.year(),resWeek=week),{week:resWeek,year:resYear}}function weeksInYear(year,dow,doy){var weekOffset=firstWeekOffset(year,dow,doy),weekOffsetNext=firstWeekOffset(year+1,dow,doy);return(daysInYear(year)-weekOffset+weekOffsetNext)/7}function shiftWeekdays(ws,n){return ws.slice(n,7).concat(ws.slice(0,n))}addFormatToken("w",["ww",2],"wo","week"),addFormatToken("W",["WW",2],"Wo","isoWeek"),addUnitAlias("week","w"),addUnitAlias("isoWeek","W"),addUnitPriority("week",5),addUnitPriority("isoWeek",5),addRegexToken("w",match1to2),addRegexToken("ww",match1to2,match2),addRegexToken("W",match1to2),addRegexToken("WW",match1to2,match2),addWeekParseToken(["w","ww","W","WW"],(function(input,week,config,token){week[token.substr(0,1)]=toInt(input)})),addFormatToken("d",0,"do","day"),addFormatToken("dd",0,0,(function(format){return this.localeData().weekdaysMin(this,format)})),addFormatToken("ddd",0,0,(function(format){return this.localeData().weekdaysShort(this,format)})),addFormatToken("dddd",0,0,(function(format){return this.localeData().weekdays(this,format)})),addFormatToken("e",0,0,"weekday"),addFormatToken("E",0,0,"isoWeekday"),addUnitAlias("day","d"),addUnitAlias("weekday","e"),addUnitAlias("isoWeekday","E"),addUnitPriority("day",11),addUnitPriority("weekday",11),addUnitPriority("isoWeekday",11),addRegexToken("d",match1to2),addRegexToken("e",match1to2),addRegexToken("E",match1to2),addRegexToken("dd",(function(isStrict,locale){return locale.weekdaysMinRegex(isStrict)})),addRegexToken("ddd",(function(isStrict,locale){return locale.weekdaysShortRegex(isStrict)})),addRegexToken("dddd",(function(isStrict,locale){return locale.weekdaysRegex(isStrict)})),addWeekParseToken(["dd","ddd","dddd"],(function(input,week,config,token){var weekday=config._locale.weekdaysParse(input,token,config._strict);null!=weekday?week.d=weekday:getParsingFlags(config).invalidWeekday=input})),addWeekParseToken(["d","e","E"],(function(input,week,config,token){week[token]=toInt(input)}));var defaultLocaleWeekdays="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),defaultLocaleWeekdaysShort="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),defaultLocaleWeekdaysMin="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),defaultWeekdaysRegex=matchWord,defaultWeekdaysShortRegex=matchWord,defaultWeekdaysMinRegex=matchWord;function handleStrictParse$1(weekdayName,format,strict){var i,ii,mom,llc=weekdayName.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],i=0;i<7;++i)mom=createUTC([2e3,1]).day(i),this._minWeekdaysParse[i]=this.weekdaysMin(mom,"").toLocaleLowerCase(),this._shortWeekdaysParse[i]=this.weekdaysShort(mom,"").toLocaleLowerCase(),this._weekdaysParse[i]=this.weekdays(mom,"").toLocaleLowerCase();return strict?"dddd"===format?-1!==(ii=indexOf.call(this._weekdaysParse,llc))?ii:null:"ddd"===format?-1!==(ii=indexOf.call(this._shortWeekdaysParse,llc))?ii:null:-1!==(ii=indexOf.call(this._minWeekdaysParse,llc))?ii:null:"dddd"===format?-1!==(ii=indexOf.call(this._weekdaysParse,llc))||-1!==(ii=indexOf.call(this._shortWeekdaysParse,llc))||-1!==(ii=indexOf.call(this._minWeekdaysParse,llc))?ii:null:"ddd"===format?-1!==(ii=indexOf.call(this._shortWeekdaysParse,llc))||-1!==(ii=indexOf.call(this._weekdaysParse,llc))||-1!==(ii=indexOf.call(this._minWeekdaysParse,llc))?ii:null:-1!==(ii=indexOf.call(this._minWeekdaysParse,llc))||-1!==(ii=indexOf.call(this._weekdaysParse,llc))||-1!==(ii=indexOf.call(this._shortWeekdaysParse,llc))?ii:null}function computeWeekdaysParse(){function cmpLenRev(a,b){return b.length-a.length}var i,mom,minp,shortp,longp,minPieces=[],shortPieces=[],longPieces=[],mixedPieces=[];for(i=0;i<7;i++)mom=createUTC([2e3,1]).day(i),minp=regexEscape(this.weekdaysMin(mom,"")),shortp=regexEscape(this.weekdaysShort(mom,"")),longp=regexEscape(this.weekdays(mom,"")),minPieces.push(minp),shortPieces.push(shortp),longPieces.push(longp),mixedPieces.push(minp),mixedPieces.push(shortp),mixedPieces.push(longp);minPieces.sort(cmpLenRev),shortPieces.sort(cmpLenRev),longPieces.sort(cmpLenRev),mixedPieces.sort(cmpLenRev),this._weekdaysRegex=new RegExp("^("+mixedPieces.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+longPieces.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+shortPieces.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+minPieces.join("|")+")","i")}function hFormat(){return this.hours()%12||12}function meridiem(token,lowercase){addFormatToken(token,0,0,(function(){return this.localeData().meridiem(this.hours(),this.minutes(),lowercase)}))}function matchMeridiem(isStrict,locale){return locale._meridiemParse}addFormatToken("H",["HH",2],0,"hour"),addFormatToken("h",["hh",2],0,hFormat),addFormatToken("k",["kk",2],0,(function(){return this.hours()||24})),addFormatToken("hmm",0,0,(function(){return""+hFormat.apply(this)+zeroFill(this.minutes(),2)})),addFormatToken("hmmss",0,0,(function(){return""+hFormat.apply(this)+zeroFill(this.minutes(),2)+zeroFill(this.seconds(),2)})),addFormatToken("Hmm",0,0,(function(){return""+this.hours()+zeroFill(this.minutes(),2)})),addFormatToken("Hmmss",0,0,(function(){return""+this.hours()+zeroFill(this.minutes(),2)+zeroFill(this.seconds(),2)})),meridiem("a",!0),meridiem("A",!1),addUnitAlias("hour","h"),addUnitPriority("hour",13),addRegexToken("a",matchMeridiem),addRegexToken("A",matchMeridiem),addRegexToken("H",match1to2),addRegexToken("h",match1to2),addRegexToken("k",match1to2),addRegexToken("HH",match1to2,match2),addRegexToken("hh",match1to2,match2),addRegexToken("kk",match1to2,match2),addRegexToken("hmm",match3to4),addRegexToken("hmmss",match5to6),addRegexToken("Hmm",match3to4),addRegexToken("Hmmss",match5to6),addParseToken(["H","HH"],3),addParseToken(["k","kk"],(function(input,array,config){var kInput=toInt(input);array[3]=24===kInput?0:kInput})),addParseToken(["a","A"],(function(input,array,config){config._isPm=config._locale.isPM(input),config._meridiem=input})),addParseToken(["h","hh"],(function(input,array,config){array[3]=toInt(input),getParsingFlags(config).bigHour=!0})),addParseToken("hmm",(function(input,array,config){var pos=input.length-2;array[3]=toInt(input.substr(0,pos)),array[4]=toInt(input.substr(pos)),getParsingFlags(config).bigHour=!0})),addParseToken("hmmss",(function(input,array,config){var pos1=input.length-4,pos2=input.length-2;array[3]=toInt(input.substr(0,pos1)),array[4]=toInt(input.substr(pos1,2)),array[5]=toInt(input.substr(pos2)),getParsingFlags(config).bigHour=!0})),addParseToken("Hmm",(function(input,array,config){var pos=input.length-2;array[3]=toInt(input.substr(0,pos)),array[4]=toInt(input.substr(pos))})),addParseToken("Hmmss",(function(input,array,config){var pos1=input.length-4,pos2=input.length-2;array[3]=toInt(input.substr(0,pos1)),array[4]=toInt(input.substr(pos1,2)),array[5]=toInt(input.substr(pos2))}));var globalLocale,getSetHour=makeGetSet("Hours",!0),baseConfig={calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},invalidDate:"Invalid date",ordinal:"%d",dayOfMonthOrdinalParse:/\d{1,2}/,relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",w:"a week",ww:"%d weeks",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},months:defaultLocaleMonths,monthsShort:defaultLocaleMonthsShort,week:{dow:0,doy:6},weekdays:defaultLocaleWeekdays,weekdaysMin:defaultLocaleWeekdaysMin,weekdaysShort:defaultLocaleWeekdaysShort,meridiemParse:/[ap]\.?m?\.?/i},locales={},localeFamilies={};function commonPrefix(arr1,arr2){var i,minl=Math.min(arr1.length,arr2.length);for(i=0;i<minl;i+=1)if(arr1[i]!==arr2[i])return i;return minl}function normalizeLocale(key){return key?key.toLowerCase().replace("_","-"):key}function loadLocale(name){var oldLocale=null;if(void 0===locales[name]&&void 0!==module&&module&&module.exports)try{oldLocale=globalLocale._abbr,__webpack_require__(276)("./"+name),getSetGlobalLocale(oldLocale)}catch(e){locales[name]=null}return locales[name]}function getSetGlobalLocale(key,values){var data;return key&&((data=isUndefined(values)?getLocale(key):defineLocale(key,values))?globalLocale=data:"undefined"!=typeof console&&console.warn&&console.warn("Locale "+key+" not found. Did you forget to load it?")),globalLocale._abbr}function defineLocale(name,config){if(null!==config){var locale,parentConfig=baseConfig;if(config.abbr=name,null!=locales[name])deprecateSimple("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),parentConfig=locales[name]._config;else if(null!=config.parentLocale)if(null!=locales[config.parentLocale])parentConfig=locales[config.parentLocale]._config;else{if(null==(locale=loadLocale(config.parentLocale)))return localeFamilies[config.parentLocale]||(localeFamilies[config.parentLocale]=[]),localeFamilies[config.parentLocale].push({name:name,config:config}),null;parentConfig=locale._config}return locales[name]=new Locale(mergeConfigs(parentConfig,config)),localeFamilies[name]&&localeFamilies[name].forEach((function(x){defineLocale(x.name,x.config)})),getSetGlobalLocale(name),locales[name]}return delete locales[name],null}function getLocale(key){var locale;if(key&&key._locale&&key._locale._abbr&&(key=key._locale._abbr),!key)return globalLocale;if(!isArray(key)){if(locale=loadLocale(key))return locale;key=[key]}return function(names){for(var j,next,locale,split,i=0;i<names.length;){for(j=(split=normalizeLocale(names[i]).split("-")).length,next=(next=normalizeLocale(names[i+1]))?next.split("-"):null;j>0;){if(locale=loadLocale(split.slice(0,j).join("-")))return locale;if(next&&next.length>=j&&commonPrefix(split,next)>=j-1)break;j--}i++}return globalLocale}(key)}function checkOverflow(m){var overflow,a=m._a;return a&&-2===getParsingFlags(m).overflow&&(overflow=a[1]<0||a[1]>11?1:a[2]<1||a[2]>daysInMonth(a[0],a[1])?2:a[3]<0||a[3]>24||24===a[3]&&(0!==a[4]||0!==a[5]||0!==a[6])?3:a[4]<0||a[4]>59?4:a[5]<0||a[5]>59?5:a[6]<0||a[6]>999?6:-1,getParsingFlags(m)._overflowDayOfYear&&(overflow<0||overflow>2)&&(overflow=2),getParsingFlags(m)._overflowWeeks&&-1===overflow&&(overflow=7),getParsingFlags(m)._overflowWeekday&&-1===overflow&&(overflow=8),getParsingFlags(m).overflow=overflow),m}var extendedIsoRegex=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([+-]\d\d(?::?\d\d)?|\s*Z)?)?$/,basicIsoRegex=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d|))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([+-]\d\d(?::?\d\d)?|\s*Z)?)?$/,tzRegex=/Z|[+-]\d\d(?::?\d\d)?/,isoDates=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/],["YYYYMM",/\d{6}/,!1],["YYYY",/\d{4}/,!1]],isoTimes=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],aspNetJsonRegex=/^\/?Date\((-?\d+)/i,rfc2822=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/,obsOffsets={UT:0,GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function configFromISO(config){var i,l,allowTime,dateFormat,timeFormat,tzFormat,string=config._i,match=extendedIsoRegex.exec(string)||basicIsoRegex.exec(string);if(match){for(getParsingFlags(config).iso=!0,i=0,l=isoDates.length;i<l;i++)if(isoDates[i][1].exec(match[1])){dateFormat=isoDates[i][0],allowTime=!1!==isoDates[i][2];break}if(null==dateFormat)return void(config._isValid=!1);if(match[3]){for(i=0,l=isoTimes.length;i<l;i++)if(isoTimes[i][1].exec(match[3])){timeFormat=(match[2]||" ")+isoTimes[i][0];break}if(null==timeFormat)return void(config._isValid=!1)}if(!allowTime&&null!=timeFormat)return void(config._isValid=!1);if(match[4]){if(!tzRegex.exec(match[4]))return void(config._isValid=!1);tzFormat="Z"}config._f=dateFormat+(timeFormat||"")+(tzFormat||""),configFromStringAndFormat(config)}else config._isValid=!1}function untruncateYear(yearStr){var year=parseInt(yearStr,10);return year<=49?2e3+year:year<=999?1900+year:year}function configFromRFC2822(config){var parsedArray,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr,result,match=rfc2822.exec(config._i.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s\s*/,"").replace(/\s\s*$/,""));if(match){if(yearStr=match[4],monthStr=match[3],dayStr=match[2],hourStr=match[5],minuteStr=match[6],secondStr=match[7],result=[untruncateYear(yearStr),defaultLocaleMonthsShort.indexOf(monthStr),parseInt(dayStr,10),parseInt(hourStr,10),parseInt(minuteStr,10)],secondStr&&result.push(parseInt(secondStr,10)),parsedArray=result,!function(weekdayStr,parsedInput,config){return!weekdayStr||defaultLocaleWeekdaysShort.indexOf(weekdayStr)===new Date(parsedInput[0],parsedInput[1],parsedInput[2]).getDay()||(getParsingFlags(config).weekdayMismatch=!0,config._isValid=!1,!1)}(match[1],parsedArray,config))return;config._a=parsedArray,config._tzm=function(obsOffset,militaryOffset,numOffset){if(obsOffset)return obsOffsets[obsOffset];if(militaryOffset)return 0;var hm=parseInt(numOffset,10),m=hm%100;return(hm-m)/100*60+m}(match[8],match[9],match[10]),config._d=createUTCDate.apply(null,config._a),config._d.setUTCMinutes(config._d.getUTCMinutes()-config._tzm),getParsingFlags(config).rfc2822=!0}else config._isValid=!1}function defaults(a,b,c){return null!=a?a:null!=b?b:c}function configFromArray(config){var i,date,currentDate,expectedWeekday,yearToUse,input=[];if(!config._d){for(currentDate=function(config){var nowValue=new Date(hooks.now());return config._useUTC?[nowValue.getUTCFullYear(),nowValue.getUTCMonth(),nowValue.getUTCDate()]:[nowValue.getFullYear(),nowValue.getMonth(),nowValue.getDate()]}(config),config._w&&null==config._a[2]&&null==config._a[1]&&function(config){var w,weekYear,week,weekday,dow,doy,temp,weekdayOverflow,curWeek;null!=(w=config._w).GG||null!=w.W||null!=w.E?(dow=1,doy=4,weekYear=defaults(w.GG,config._a[0],weekOfYear(createLocal(),1,4).year),week=defaults(w.W,1),((weekday=defaults(w.E,1))<1||weekday>7)&&(weekdayOverflow=!0)):(dow=config._locale._week.dow,doy=config._locale._week.doy,curWeek=weekOfYear(createLocal(),dow,doy),weekYear=defaults(w.gg,config._a[0],curWeek.year),week=defaults(w.w,curWeek.week),null!=w.d?((weekday=w.d)<0||weekday>6)&&(weekdayOverflow=!0):null!=w.e?(weekday=w.e+dow,(w.e<0||w.e>6)&&(weekdayOverflow=!0)):weekday=dow),week<1||week>weeksInYear(weekYear,dow,doy)?getParsingFlags(config)._overflowWeeks=!0:null!=weekdayOverflow?getParsingFlags(config)._overflowWeekday=!0:(temp=dayOfYearFromWeeks(weekYear,week,weekday,dow,doy),config._a[0]=temp.year,config._dayOfYear=temp.dayOfYear)}(config),null!=config._dayOfYear&&(yearToUse=defaults(config._a[0],currentDate[0]),(config._dayOfYear>daysInYear(yearToUse)||0===config._dayOfYear)&&(getParsingFlags(config)._overflowDayOfYear=!0),date=createUTCDate(yearToUse,0,config._dayOfYear),config._a[1]=date.getUTCMonth(),config._a[2]=date.getUTCDate()),i=0;i<3&&null==config._a[i];++i)config._a[i]=input[i]=currentDate[i];for(;i<7;i++)config._a[i]=input[i]=null==config._a[i]?2===i?1:0:config._a[i];24===config._a[3]&&0===config._a[4]&&0===config._a[5]&&0===config._a[6]&&(config._nextDay=!0,config._a[3]=0),config._d=(config._useUTC?createUTCDate:createDate).apply(null,input),expectedWeekday=config._useUTC?config._d.getUTCDay():config._d.getDay(),null!=config._tzm&&config._d.setUTCMinutes(config._d.getUTCMinutes()-config._tzm),config._nextDay&&(config._a[3]=24),config._w&&void 0!==config._w.d&&config._w.d!==expectedWeekday&&(getParsingFlags(config).weekdayMismatch=!0)}}function configFromStringAndFormat(config){if(config._f!==hooks.ISO_8601)if(config._f!==hooks.RFC_2822){config._a=[],getParsingFlags(config).empty=!0;var i,parsedInput,tokens,token,skipped,era,string=""+config._i,stringLength=string.length,totalParsedInputLength=0;for(tokens=expandFormat(config._f,config._locale).match(formattingTokens)||[],i=0;i<tokens.length;i++)token=tokens[i],(parsedInput=(string.match(getParseRegexForToken(token,config))||[])[0])&&((skipped=string.substr(0,string.indexOf(parsedInput))).length>0&&getParsingFlags(config).unusedInput.push(skipped),string=string.slice(string.indexOf(parsedInput)+parsedInput.length),totalParsedInputLength+=parsedInput.length),formatTokenFunctions[token]?(parsedInput?getParsingFlags(config).empty=!1:getParsingFlags(config).unusedTokens.push(token),addTimeToArrayFromToken(token,parsedInput,config)):config._strict&&!parsedInput&&getParsingFlags(config).unusedTokens.push(token);getParsingFlags(config).charsLeftOver=stringLength-totalParsedInputLength,string.length>0&&getParsingFlags(config).unusedInput.push(string),config._a[3]<=12&&!0===getParsingFlags(config).bigHour&&config._a[3]>0&&(getParsingFlags(config).bigHour=void 0),getParsingFlags(config).parsedDateParts=config._a.slice(0),getParsingFlags(config).meridiem=config._meridiem,config._a[3]=function(locale,hour,meridiem){var isPm;return null==meridiem?hour:null!=locale.meridiemHour?locale.meridiemHour(hour,meridiem):null!=locale.isPM?((isPm=locale.isPM(meridiem))&&hour<12&&(hour+=12),isPm||12!==hour||(hour=0),hour):hour}(config._locale,config._a[3],config._meridiem),null!==(era=getParsingFlags(config).era)&&(config._a[0]=config._locale.erasConvertYear(era,config._a[0])),configFromArray(config),checkOverflow(config)}else configFromRFC2822(config);else configFromISO(config)}function prepareConfig(config){var input=config._i,format=config._f;return config._locale=config._locale||getLocale(config._l),null===input||void 0===format&&""===input?createInvalid({nullInput:!0}):("string"==typeof input&&(config._i=input=config._locale.preparse(input)),isMoment(input)?new Moment(checkOverflow(input)):(isDate(input)?config._d=input:isArray(format)?function(config){var tempConfig,bestMoment,scoreToBeat,i,currentScore,validFormatFound,bestFormatIsValid=!1;if(0===config._f.length)return getParsingFlags(config).invalidFormat=!0,void(config._d=new Date(NaN));for(i=0;i<config._f.length;i++)currentScore=0,validFormatFound=!1,tempConfig=copyConfig({},config),null!=config._useUTC&&(tempConfig._useUTC=config._useUTC),tempConfig._f=config._f[i],configFromStringAndFormat(tempConfig),isValid(tempConfig)&&(validFormatFound=!0),currentScore+=getParsingFlags(tempConfig).charsLeftOver,currentScore+=10*getParsingFlags(tempConfig).unusedTokens.length,getParsingFlags(tempConfig).score=currentScore,bestFormatIsValid?currentScore<scoreToBeat&&(scoreToBeat=currentScore,bestMoment=tempConfig):(null==scoreToBeat||currentScore<scoreToBeat||validFormatFound)&&(scoreToBeat=currentScore,bestMoment=tempConfig,validFormatFound&&(bestFormatIsValid=!0));extend(config,bestMoment||tempConfig)}(config):format?configFromStringAndFormat(config):function(config){var input=config._i;isUndefined(input)?config._d=new Date(hooks.now()):isDate(input)?config._d=new Date(input.valueOf()):"string"==typeof input?function(config){var matched=aspNetJsonRegex.exec(config._i);null===matched?(configFromISO(config),!1===config._isValid&&(delete config._isValid,configFromRFC2822(config),!1===config._isValid&&(delete config._isValid,config._strict?config._isValid=!1:hooks.createFromInputFallback(config)))):config._d=new Date(+matched[1])}(config):isArray(input)?(config._a=map(input.slice(0),(function(obj){return parseInt(obj,10)})),configFromArray(config)):isObject(input)?function(config){if(!config._d){var i=normalizeObjectUnits(config._i),dayOrDate=void 0===i.day?i.date:i.day;config._a=map([i.year,i.month,dayOrDate,i.hour,i.minute,i.second,i.millisecond],(function(obj){return obj&&parseInt(obj,10)})),configFromArray(config)}}(config):isNumber(input)?config._d=new Date(input):hooks.createFromInputFallback(config)}(config),isValid(config)||(config._d=null),config))}function createLocalOrUTC(input,format,locale,strict,isUTC){var c={};return!0!==format&&!1!==format||(strict=format,format=void 0),!0!==locale&&!1!==locale||(strict=locale,locale=void 0),(isObject(input)&&isObjectEmpty(input)||isArray(input)&&0===input.length)&&(input=void 0),c._isAMomentObject=!0,c._useUTC=c._isUTC=isUTC,c._l=locale,c._i=input,c._f=format,c._strict=strict,function(config){var res=new Moment(checkOverflow(prepareConfig(config)));return res._nextDay&&(res.add(1,"d"),res._nextDay=void 0),res}(c)}function createLocal(input,format,locale,strict){return createLocalOrUTC(input,format,locale,strict,!1)}hooks.createFromInputFallback=deprecate("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",(function(config){config._d=new Date(config._i+(config._useUTC?" UTC":""))})),hooks.ISO_8601=function(){},hooks.RFC_2822=function(){};var prototypeMin=deprecate("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",(function(){var other=createLocal.apply(null,arguments);return this.isValid()&&other.isValid()?other<this?this:other:createInvalid()})),prototypeMax=deprecate("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",(function(){var other=createLocal.apply(null,arguments);return this.isValid()&&other.isValid()?other>this?this:other:createInvalid()}));function pickBy(fn,moments){var res,i;if(1===moments.length&&isArray(moments[0])&&(moments=moments[0]),!moments.length)return createLocal();for(res=moments[0],i=1;i<moments.length;++i)moments[i].isValid()&&!moments[i][fn](res)||(res=moments[i]);return res}var ordering=["year","quarter","month","week","day","hour","minute","second","millisecond"];function Duration(duration){var normalizedInput=normalizeObjectUnits(duration),years=normalizedInput.year||0,quarters=normalizedInput.quarter||0,months=normalizedInput.month||0,weeks=normalizedInput.week||normalizedInput.isoWeek||0,days=normalizedInput.day||0,hours=normalizedInput.hour||0,minutes=normalizedInput.minute||0,seconds=normalizedInput.second||0,milliseconds=normalizedInput.millisecond||0;this._isValid=function(m){var key,i,unitHasDecimal=!1;for(key in m)if(hasOwnProp(m,key)&&(-1===indexOf.call(ordering,key)||null!=m[key]&&isNaN(m[key])))return!1;for(i=0;i<ordering.length;++i)if(m[ordering[i]]){if(unitHasDecimal)return!1;parseFloat(m[ordering[i]])!==toInt(m[ordering[i]])&&(unitHasDecimal=!0)}return!0}(normalizedInput),this._milliseconds=+milliseconds+1e3*seconds+6e4*minutes+1e3*hours*60*60,this._days=+days+7*weeks,this._months=+months+3*quarters+12*years,this._data={},this._locale=getLocale(),this._bubble()}function isDuration(obj){return obj instanceof Duration}function absRound(number){return number<0?-1*Math.round(-1*number):Math.round(number)}function offset(token,separator){addFormatToken(token,0,0,(function(){var offset=this.utcOffset(),sign="+";return offset<0&&(offset=-offset,sign="-"),sign+zeroFill(~~(offset/60),2)+separator+zeroFill(~~offset%60,2)}))}offset("Z",":"),offset("ZZ",""),addRegexToken("Z",matchShortOffset),addRegexToken("ZZ",matchShortOffset),addParseToken(["Z","ZZ"],(function(input,array,config){config._useUTC=!0,config._tzm=offsetFromString(matchShortOffset,input)}));var chunkOffset=/([\+\-]|\d\d)/gi;function offsetFromString(matcher,string){var parts,minutes,matches=(string||"").match(matcher);return null===matches?null:0===(minutes=60*(parts=((matches[matches.length-1]||[])+"").match(chunkOffset)||["-",0,0])[1]+toInt(parts[2]))?0:"+"===parts[0]?minutes:-minutes}function cloneWithOffset(input,model){var res,diff;return model._isUTC?(res=model.clone(),diff=(isMoment(input)||isDate(input)?input.valueOf():createLocal(input).valueOf())-res.valueOf(),res._d.setTime(res._d.valueOf()+diff),hooks.updateOffset(res,!1),res):createLocal(input).local()}function getDateOffset(m){return-Math.round(m._d.getTimezoneOffset())}function isUtc(){return!!this.isValid()&&this._isUTC&&0===this._offset}hooks.updateOffset=function(){};var aspNetRegex=/^(-|\+)?(?:(\d*)[. ])?(\d+):(\d+)(?::(\d+)(\.\d*)?)?$/,isoRegex=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;function createDuration(input,key){var sign,ret,diffRes,base,other,res,duration=input,match=null;return isDuration(input)?duration={ms:input._milliseconds,d:input._days,M:input._months}:isNumber(input)||!isNaN(+input)?(duration={},key?duration[key]=+input:duration.milliseconds=+input):(match=aspNetRegex.exec(input))?(sign="-"===match[1]?-1:1,duration={y:0,d:toInt(match[2])*sign,h:toInt(match[3])*sign,m:toInt(match[4])*sign,s:toInt(match[5])*sign,ms:toInt(absRound(1e3*match[6]))*sign}):(match=isoRegex.exec(input))?(sign="-"===match[1]?-1:1,duration={y:parseIso(match[2],sign),M:parseIso(match[3],sign),w:parseIso(match[4],sign),d:parseIso(match[5],sign),h:parseIso(match[6],sign),m:parseIso(match[7],sign),s:parseIso(match[8],sign)}):null==duration?duration={}:"object"==typeof duration&&("from"in duration||"to"in duration)&&(base=createLocal(duration.from),other=createLocal(duration.to),diffRes=base.isValid()&&other.isValid()?(other=cloneWithOffset(other,base),base.isBefore(other)?res=positiveMomentsDifference(base,other):((res=positiveMomentsDifference(other,base)).milliseconds=-res.milliseconds,res.months=-res.months),res):{milliseconds:0,months:0},(duration={}).ms=diffRes.milliseconds,duration.M=diffRes.months),ret=new Duration(duration),isDuration(input)&&hasOwnProp(input,"_locale")&&(ret._locale=input._locale),isDuration(input)&&hasOwnProp(input,"_isValid")&&(ret._isValid=input._isValid),ret}function parseIso(inp,sign){var res=inp&&parseFloat(inp.replace(",","."));return(isNaN(res)?0:res)*sign}function positiveMomentsDifference(base,other){var res={};return res.months=other.month()-base.month()+12*(other.year()-base.year()),base.clone().add(res.months,"M").isAfter(other)&&--res.months,res.milliseconds=+other-+base.clone().add(res.months,"M"),res}function createAdder(direction,name){return function(val,period){var tmp;return null===period||isNaN(+period)||(deprecateSimple(name,"moment()."+name+"(period, number) is deprecated. Please use moment()."+name+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),tmp=val,val=period,period=tmp),addSubtract(this,createDuration(val,period),direction),this}}function addSubtract(mom,duration,isAdding,updateOffset){var milliseconds=duration._milliseconds,days=absRound(duration._days),months=absRound(duration._months);mom.isValid()&&(updateOffset=null==updateOffset||updateOffset,months&&setMonth(mom,get(mom,"Month")+months*isAdding),days&&set$1(mom,"Date",get(mom,"Date")+days*isAdding),milliseconds&&mom._d.setTime(mom._d.valueOf()+milliseconds*isAdding),updateOffset&&hooks.updateOffset(mom,days||months))}createDuration.fn=Duration.prototype,createDuration.invalid=function(){return createDuration(NaN)};var add=createAdder(1,"add"),subtract=createAdder(-1,"subtract");function isString(input){return"string"==typeof input||input instanceof String}function isMomentInput(input){return isMoment(input)||isDate(input)||isString(input)||isNumber(input)||function(input){var arrayTest=isArray(input),dataTypeTest=!1;return arrayTest&&(dataTypeTest=0===input.filter((function(item){return!isNumber(item)&&isString(input)})).length),arrayTest&&dataTypeTest}(input)||function(input){var i,property,objectTest=isObject(input)&&!isObjectEmpty(input),propertyTest=!1,properties=["years","year","y","months","month","M","days","day","d","dates","date","D","hours","hour","h","minutes","minute","m","seconds","second","s","milliseconds","millisecond","ms"];for(i=0;i<properties.length;i+=1)property=properties[i],propertyTest=propertyTest||hasOwnProp(input,property);return objectTest&&propertyTest}(input)||null==input}function isCalendarSpec(input){var i,objectTest=isObject(input)&&!isObjectEmpty(input),propertyTest=!1,properties=["sameDay","nextDay","lastDay","nextWeek","lastWeek","sameElse"];for(i=0;i<properties.length;i+=1)propertyTest=propertyTest||hasOwnProp(input,properties[i]);return objectTest&&propertyTest}function monthDiff(a,b){if(a.date()<b.date())return-monthDiff(b,a);var wholeMonthDiff=12*(b.year()-a.year())+(b.month()-a.month()),anchor=a.clone().add(wholeMonthDiff,"months");return-(wholeMonthDiff+(b-anchor<0?(b-anchor)/(anchor-a.clone().add(wholeMonthDiff-1,"months")):(b-anchor)/(a.clone().add(wholeMonthDiff+1,"months")-anchor)))||0}function locale(key){var newLocaleData;return void 0===key?this._locale._abbr:(null!=(newLocaleData=getLocale(key))&&(this._locale=newLocaleData),this)}hooks.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",hooks.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var lang=deprecate("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",(function(key){return void 0===key?this.localeData():this.locale(key)}));function localeData(){return this._locale}function mod$1(dividend,divisor){return(dividend%divisor+divisor)%divisor}function localStartOfDate(y,m,d){return y<100&&y>=0?new Date(y+400,m,d)-126227808e5:new Date(y,m,d).valueOf()}function utcStartOfDate(y,m,d){return y<100&&y>=0?Date.UTC(y+400,m,d)-126227808e5:Date.UTC(y,m,d)}function matchEraAbbr(isStrict,locale){return locale.erasAbbrRegex(isStrict)}function computeErasParse(){var i,l,abbrPieces=[],namePieces=[],narrowPieces=[],mixedPieces=[],eras=this.eras();for(i=0,l=eras.length;i<l;++i)namePieces.push(regexEscape(eras[i].name)),abbrPieces.push(regexEscape(eras[i].abbr)),narrowPieces.push(regexEscape(eras[i].narrow)),mixedPieces.push(regexEscape(eras[i].name)),mixedPieces.push(regexEscape(eras[i].abbr)),mixedPieces.push(regexEscape(eras[i].narrow));this._erasRegex=new RegExp("^("+mixedPieces.join("|")+")","i"),this._erasNameRegex=new RegExp("^("+namePieces.join("|")+")","i"),this._erasAbbrRegex=new RegExp("^("+abbrPieces.join("|")+")","i"),this._erasNarrowRegex=new RegExp("^("+narrowPieces.join("|")+")","i")}function addWeekYearFormatToken(token,getter){addFormatToken(0,[token,token.length],0,getter)}function getSetWeekYearHelper(input,week,weekday,dow,doy){var weeksTarget;return null==input?weekOfYear(this,dow,doy).year:(week>(weeksTarget=weeksInYear(input,dow,doy))&&(week=weeksTarget),setWeekAll.call(this,input,week,weekday,dow,doy))}function setWeekAll(weekYear,week,weekday,dow,doy){var dayOfYearData=dayOfYearFromWeeks(weekYear,week,weekday,dow,doy),date=createUTCDate(dayOfYearData.year,0,dayOfYearData.dayOfYear);return this.year(date.getUTCFullYear()),this.month(date.getUTCMonth()),this.date(date.getUTCDate()),this}addFormatToken("N",0,0,"eraAbbr"),addFormatToken("NN",0,0,"eraAbbr"),addFormatToken("NNN",0,0,"eraAbbr"),addFormatToken("NNNN",0,0,"eraName"),addFormatToken("NNNNN",0,0,"eraNarrow"),addFormatToken("y",["y",1],"yo","eraYear"),addFormatToken("y",["yy",2],0,"eraYear"),addFormatToken("y",["yyy",3],0,"eraYear"),addFormatToken("y",["yyyy",4],0,"eraYear"),addRegexToken("N",matchEraAbbr),addRegexToken("NN",matchEraAbbr),addRegexToken("NNN",matchEraAbbr),addRegexToken("NNNN",(function(isStrict,locale){return locale.erasNameRegex(isStrict)})),addRegexToken("NNNNN",(function(isStrict,locale){return locale.erasNarrowRegex(isStrict)})),addParseToken(["N","NN","NNN","NNNN","NNNNN"],(function(input,array,config,token){var era=config._locale.erasParse(input,token,config._strict);era?getParsingFlags(config).era=era:getParsingFlags(config).invalidEra=input})),addRegexToken("y",matchUnsigned),addRegexToken("yy",matchUnsigned),addRegexToken("yyy",matchUnsigned),addRegexToken("yyyy",matchUnsigned),addRegexToken("yo",(function(isStrict,locale){return locale._eraYearOrdinalRegex||matchUnsigned})),addParseToken(["y","yy","yyy","yyyy"],0),addParseToken(["yo"],(function(input,array,config,token){var match;config._locale._eraYearOrdinalRegex&&(match=input.match(config._locale._eraYearOrdinalRegex)),config._locale.eraYearOrdinalParse?array[0]=config._locale.eraYearOrdinalParse(input,match):array[0]=parseInt(input,10)})),addFormatToken(0,["gg",2],0,(function(){return this.weekYear()%100})),addFormatToken(0,["GG",2],0,(function(){return this.isoWeekYear()%100})),addWeekYearFormatToken("gggg","weekYear"),addWeekYearFormatToken("ggggg","weekYear"),addWeekYearFormatToken("GGGG","isoWeekYear"),addWeekYearFormatToken("GGGGG","isoWeekYear"),addUnitAlias("weekYear","gg"),addUnitAlias("isoWeekYear","GG"),addUnitPriority("weekYear",1),addUnitPriority("isoWeekYear",1),addRegexToken("G",matchSigned),addRegexToken("g",matchSigned),addRegexToken("GG",match1to2,match2),addRegexToken("gg",match1to2,match2),addRegexToken("GGGG",match1to4,match4),addRegexToken("gggg",match1to4,match4),addRegexToken("GGGGG",match1to6,match6),addRegexToken("ggggg",match1to6,match6),addWeekParseToken(["gggg","ggggg","GGGG","GGGGG"],(function(input,week,config,token){week[token.substr(0,2)]=toInt(input)})),addWeekParseToken(["gg","GG"],(function(input,week,config,token){week[token]=hooks.parseTwoDigitYear(input)})),addFormatToken("Q",0,"Qo","quarter"),addUnitAlias("quarter","Q"),addUnitPriority("quarter",7),addRegexToken("Q",match1),addParseToken("Q",(function(input,array){array[1]=3*(toInt(input)-1)})),addFormatToken("D",["DD",2],"Do","date"),addUnitAlias("date","D"),addUnitPriority("date",9),addRegexToken("D",match1to2),addRegexToken("DD",match1to2,match2),addRegexToken("Do",(function(isStrict,locale){return isStrict?locale._dayOfMonthOrdinalParse||locale._ordinalParse:locale._dayOfMonthOrdinalParseLenient})),addParseToken(["D","DD"],2),addParseToken("Do",(function(input,array){array[2]=toInt(input.match(match1to2)[0])}));var getSetDayOfMonth=makeGetSet("Date",!0);addFormatToken("DDD",["DDDD",3],"DDDo","dayOfYear"),addUnitAlias("dayOfYear","DDD"),addUnitPriority("dayOfYear",4),addRegexToken("DDD",match1to3),addRegexToken("DDDD",match3),addParseToken(["DDD","DDDD"],(function(input,array,config){config._dayOfYear=toInt(input)})),addFormatToken("m",["mm",2],0,"minute"),addUnitAlias("minute","m"),addUnitPriority("minute",14),addRegexToken("m",match1to2),addRegexToken("mm",match1to2,match2),addParseToken(["m","mm"],4);var getSetMinute=makeGetSet("Minutes",!1);addFormatToken("s",["ss",2],0,"second"),addUnitAlias("second","s"),addUnitPriority("second",15),addRegexToken("s",match1to2),addRegexToken("ss",match1to2,match2),addParseToken(["s","ss"],5);var token,getSetMillisecond,getSetSecond=makeGetSet("Seconds",!1);for(addFormatToken("S",0,0,(function(){return~~(this.millisecond()/100)})),addFormatToken(0,["SS",2],0,(function(){return~~(this.millisecond()/10)})),addFormatToken(0,["SSS",3],0,"millisecond"),addFormatToken(0,["SSSS",4],0,(function(){return 10*this.millisecond()})),addFormatToken(0,["SSSSS",5],0,(function(){return 100*this.millisecond()})),addFormatToken(0,["SSSSSS",6],0,(function(){return 1e3*this.millisecond()})),addFormatToken(0,["SSSSSSS",7],0,(function(){return 1e4*this.millisecond()})),addFormatToken(0,["SSSSSSSS",8],0,(function(){return 1e5*this.millisecond()})),addFormatToken(0,["SSSSSSSSS",9],0,(function(){return 1e6*this.millisecond()})),addUnitAlias("millisecond","ms"),addUnitPriority("millisecond",16),addRegexToken("S",match1to3,match1),addRegexToken("SS",match1to3,match2),addRegexToken("SSS",match1to3,match3),token="SSSS";token.length<=9;token+="S")addRegexToken(token,matchUnsigned);function parseMs(input,array){array[6]=toInt(1e3*("0."+input))}for(token="S";token.length<=9;token+="S")addParseToken(token,parseMs);getSetMillisecond=makeGetSet("Milliseconds",!1),addFormatToken("z",0,0,"zoneAbbr"),addFormatToken("zz",0,0,"zoneName");var proto=Moment.prototype;function preParsePostFormat(string){return string}proto.add=add,proto.calendar=function(time,formats){1===arguments.length&&(arguments[0]?isMomentInput(arguments[0])?(time=arguments[0],formats=void 0):isCalendarSpec(arguments[0])&&(formats=arguments[0],time=void 0):(time=void 0,formats=void 0));var now=time||createLocal(),sod=cloneWithOffset(now,this).startOf("day"),format=hooks.calendarFormat(this,sod)||"sameElse",output=formats&&(isFunction(formats[format])?formats[format].call(this,now):formats[format]);return this.format(output||this.localeData().calendar(format,this,createLocal(now)))},proto.clone=function(){return new Moment(this)},proto.diff=function(input,units,asFloat){var that,zoneDelta,output;if(!this.isValid())return NaN;if(!(that=cloneWithOffset(input,this)).isValid())return NaN;switch(zoneDelta=6e4*(that.utcOffset()-this.utcOffset()),units=normalizeUnits(units)){case"year":output=monthDiff(this,that)/12;break;case"month":output=monthDiff(this,that);break;case"quarter":output=monthDiff(this,that)/3;break;case"second":output=(this-that)/1e3;break;case"minute":output=(this-that)/6e4;break;case"hour":output=(this-that)/36e5;break;case"day":output=(this-that-zoneDelta)/864e5;break;case"week":output=(this-that-zoneDelta)/6048e5;break;default:output=this-that}return asFloat?output:absFloor(output)},proto.endOf=function(units){var time,startOfDate;if(void 0===(units=normalizeUnits(units))||"millisecond"===units||!this.isValid())return this;switch(startOfDate=this._isUTC?utcStartOfDate:localStartOfDate,units){case"year":time=startOfDate(this.year()+1,0,1)-1;break;case"quarter":time=startOfDate(this.year(),this.month()-this.month()%3+3,1)-1;break;case"month":time=startOfDate(this.year(),this.month()+1,1)-1;break;case"week":time=startOfDate(this.year(),this.month(),this.date()-this.weekday()+7)-1;break;case"isoWeek":time=startOfDate(this.year(),this.month(),this.date()-(this.isoWeekday()-1)+7)-1;break;case"day":case"date":time=startOfDate(this.year(),this.month(),this.date()+1)-1;break;case"hour":time=this._d.valueOf(),time+=36e5-mod$1(time+(this._isUTC?0:6e4*this.utcOffset()),36e5)-1;break;case"minute":time=this._d.valueOf(),time+=6e4-mod$1(time,6e4)-1;break;case"second":time=this._d.valueOf(),time+=1e3-mod$1(time,1e3)-1}return this._d.setTime(time),hooks.updateOffset(this,!0),this},proto.format=function(inputString){inputString||(inputString=this.isUtc()?hooks.defaultFormatUtc:hooks.defaultFormat);var output=formatMoment(this,inputString);return this.localeData().postformat(output)},proto.from=function(time,withoutSuffix){return this.isValid()&&(isMoment(time)&&time.isValid()||createLocal(time).isValid())?createDuration({to:this,from:time}).locale(this.locale()).humanize(!withoutSuffix):this.localeData().invalidDate()},proto.fromNow=function(withoutSuffix){return this.from(createLocal(),withoutSuffix)},proto.to=function(time,withoutSuffix){return this.isValid()&&(isMoment(time)&&time.isValid()||createLocal(time).isValid())?createDuration({from:this,to:time}).locale(this.locale()).humanize(!withoutSuffix):this.localeData().invalidDate()},proto.toNow=function(withoutSuffix){return this.to(createLocal(),withoutSuffix)},proto.get=function(units){return isFunction(this[units=normalizeUnits(units)])?this[units]():this},proto.invalidAt=function(){return getParsingFlags(this).overflow},proto.isAfter=function(input,units){var localInput=isMoment(input)?input:createLocal(input);return!(!this.isValid()||!localInput.isValid())&&("millisecond"===(units=normalizeUnits(units)||"millisecond")?this.valueOf()>localInput.valueOf():localInput.valueOf()<this.clone().startOf(units).valueOf())},proto.isBefore=function(input,units){var localInput=isMoment(input)?input:createLocal(input);return!(!this.isValid()||!localInput.isValid())&&("millisecond"===(units=normalizeUnits(units)||"millisecond")?this.valueOf()<localInput.valueOf():this.clone().endOf(units).valueOf()<localInput.valueOf())},proto.isBetween=function(from,to,units,inclusivity){var localFrom=isMoment(from)?from:createLocal(from),localTo=isMoment(to)?to:createLocal(to);return!!(this.isValid()&&localFrom.isValid()&&localTo.isValid())&&(("("===(inclusivity=inclusivity||"()")[0]?this.isAfter(localFrom,units):!this.isBefore(localFrom,units))&&(")"===inclusivity[1]?this.isBefore(localTo,units):!this.isAfter(localTo,units)))},proto.isSame=function(input,units){var inputMs,localInput=isMoment(input)?input:createLocal(input);return!(!this.isValid()||!localInput.isValid())&&("millisecond"===(units=normalizeUnits(units)||"millisecond")?this.valueOf()===localInput.valueOf():(inputMs=localInput.valueOf(),this.clone().startOf(units).valueOf()<=inputMs&&inputMs<=this.clone().endOf(units).valueOf()))},proto.isSameOrAfter=function(input,units){return this.isSame(input,units)||this.isAfter(input,units)},proto.isSameOrBefore=function(input,units){return this.isSame(input,units)||this.isBefore(input,units)},proto.isValid=function(){return isValid(this)},proto.lang=lang,proto.locale=locale,proto.localeData=localeData,proto.max=prototypeMax,proto.min=prototypeMin,proto.parsingFlags=function(){return extend({},getParsingFlags(this))},proto.set=function(units,value){if("object"==typeof units){var i,prioritized=function(unitsObj){var u,units=[];for(u in unitsObj)hasOwnProp(unitsObj,u)&&units.push({unit:u,priority:priorities[u]});return units.sort((function(a,b){return a.priority-b.priority})),units}(units=normalizeObjectUnits(units));for(i=0;i<prioritized.length;i++)this[prioritized[i].unit](units[prioritized[i].unit])}else if(isFunction(this[units=normalizeUnits(units)]))return this[units](value);return this},proto.startOf=function(units){var time,startOfDate;if(void 0===(units=normalizeUnits(units))||"millisecond"===units||!this.isValid())return this;switch(startOfDate=this._isUTC?utcStartOfDate:localStartOfDate,units){case"year":time=startOfDate(this.year(),0,1);break;case"quarter":time=startOfDate(this.year(),this.month()-this.month()%3,1);break;case"month":time=startOfDate(this.year(),this.month(),1);break;case"week":time=startOfDate(this.year(),this.month(),this.date()-this.weekday());break;case"isoWeek":time=startOfDate(this.year(),this.month(),this.date()-(this.isoWeekday()-1));break;case"day":case"date":time=startOfDate(this.year(),this.month(),this.date());break;case"hour":time=this._d.valueOf(),time-=mod$1(time+(this._isUTC?0:6e4*this.utcOffset()),36e5);break;case"minute":time=this._d.valueOf(),time-=mod$1(time,6e4);break;case"second":time=this._d.valueOf(),time-=mod$1(time,1e3)}return this._d.setTime(time),hooks.updateOffset(this,!0),this},proto.subtract=subtract,proto.toArray=function(){var m=this;return[m.year(),m.month(),m.date(),m.hour(),m.minute(),m.second(),m.millisecond()]},proto.toObject=function(){var m=this;return{years:m.year(),months:m.month(),date:m.date(),hours:m.hours(),minutes:m.minutes(),seconds:m.seconds(),milliseconds:m.milliseconds()}},proto.toDate=function(){return new Date(this.valueOf())},proto.toISOString=function(keepOffset){if(!this.isValid())return null;var utc=!0!==keepOffset,m=utc?this.clone().utc():this;return m.year()<0||m.year()>9999?formatMoment(m,utc?"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYYYY-MM-DD[T]HH:mm:ss.SSSZ"):isFunction(Date.prototype.toISOString)?utc?this.toDate().toISOString():new Date(this.valueOf()+60*this.utcOffset()*1e3).toISOString().replace("Z",formatMoment(m,"Z")):formatMoment(m,utc?"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYY-MM-DD[T]HH:mm:ss.SSSZ")},proto.inspect=function(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var prefix,year,suffix,func="moment",zone="";return this.isLocal()||(func=0===this.utcOffset()?"moment.utc":"moment.parseZone",zone="Z"),prefix="["+func+'("]',year=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",suffix=zone+'[")]',this.format(prefix+year+"-MM-DD[T]HH:mm:ss.SSS"+suffix)},"undefined"!=typeof Symbol&&null!=Symbol.for&&(proto[Symbol.for("nodejs.util.inspect.custom")]=function(){return"Moment<"+this.format()+">"}),proto.toJSON=function(){return this.isValid()?this.toISOString():null},proto.toString=function(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},proto.unix=function(){return Math.floor(this.valueOf()/1e3)},proto.valueOf=function(){return this._d.valueOf()-6e4*(this._offset||0)},proto.creationData=function(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}},proto.eraName=function(){var i,l,val,eras=this.localeData().eras();for(i=0,l=eras.length;i<l;++i){if(val=this.clone().startOf("day").valueOf(),eras[i].since<=val&&val<=eras[i].until)return eras[i].name;if(eras[i].until<=val&&val<=eras[i].since)return eras[i].name}return""},proto.eraNarrow=function(){var i,l,val,eras=this.localeData().eras();for(i=0,l=eras.length;i<l;++i){if(val=this.clone().startOf("day").valueOf(),eras[i].since<=val&&val<=eras[i].until)return eras[i].narrow;if(eras[i].until<=val&&val<=eras[i].since)return eras[i].narrow}return""},proto.eraAbbr=function(){var i,l,val,eras=this.localeData().eras();for(i=0,l=eras.length;i<l;++i){if(val=this.clone().startOf("day").valueOf(),eras[i].since<=val&&val<=eras[i].until)return eras[i].abbr;if(eras[i].until<=val&&val<=eras[i].since)return eras[i].abbr}return""},proto.eraYear=function(){var i,l,dir,val,eras=this.localeData().eras();for(i=0,l=eras.length;i<l;++i)if(dir=eras[i].since<=eras[i].until?1:-1,val=this.clone().startOf("day").valueOf(),eras[i].since<=val&&val<=eras[i].until||eras[i].until<=val&&val<=eras[i].since)return(this.year()-hooks(eras[i].since).year())*dir+eras[i].offset;return this.year()},proto.year=getSetYear,proto.isLeapYear=function(){return isLeapYear(this.year())},proto.weekYear=function(input){return getSetWeekYearHelper.call(this,input,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)},proto.isoWeekYear=function(input){return getSetWeekYearHelper.call(this,input,this.isoWeek(),this.isoWeekday(),1,4)},proto.quarter=proto.quarters=function(input){return null==input?Math.ceil((this.month()+1)/3):this.month(3*(input-1)+this.month()%3)},proto.month=getSetMonth,proto.daysInMonth=function(){return daysInMonth(this.year(),this.month())},proto.week=proto.weeks=function(input){var week=this.localeData().week(this);return null==input?week:this.add(7*(input-week),"d")},proto.isoWeek=proto.isoWeeks=function(input){var week=weekOfYear(this,1,4).week;return null==input?week:this.add(7*(input-week),"d")},proto.weeksInYear=function(){var weekInfo=this.localeData()._week;return weeksInYear(this.year(),weekInfo.dow,weekInfo.doy)},proto.weeksInWeekYear=function(){var weekInfo=this.localeData()._week;return weeksInYear(this.weekYear(),weekInfo.dow,weekInfo.doy)},proto.isoWeeksInYear=function(){return weeksInYear(this.year(),1,4)},proto.isoWeeksInISOWeekYear=function(){return weeksInYear(this.isoWeekYear(),1,4)},proto.date=getSetDayOfMonth,proto.day=proto.days=function(input){if(!this.isValid())return null!=input?this:NaN;var day=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=input?(input=function(input,locale){return"string"!=typeof input?input:isNaN(input)?"number"==typeof(input=locale.weekdaysParse(input))?input:null:parseInt(input,10)}(input,this.localeData()),this.add(input-day,"d")):day},proto.weekday=function(input){if(!this.isValid())return null!=input?this:NaN;var weekday=(this.day()+7-this.localeData()._week.dow)%7;return null==input?weekday:this.add(input-weekday,"d")},proto.isoWeekday=function(input){if(!this.isValid())return null!=input?this:NaN;if(null!=input){var weekday=function(input,locale){return"string"==typeof input?locale.weekdaysParse(input)%7||7:isNaN(input)?null:input}(input,this.localeData());return this.day(this.day()%7?weekday:weekday-7)}return this.day()||7},proto.dayOfYear=function(input){var dayOfYear=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==input?dayOfYear:this.add(input-dayOfYear,"d")},proto.hour=proto.hours=getSetHour,proto.minute=proto.minutes=getSetMinute,proto.second=proto.seconds=getSetSecond,proto.millisecond=proto.milliseconds=getSetMillisecond,proto.utcOffset=function(input,keepLocalTime,keepMinutes){var localAdjust,offset=this._offset||0;if(!this.isValid())return null!=input?this:NaN;if(null!=input){if("string"==typeof input){if(null===(input=offsetFromString(matchShortOffset,input)))return this}else Math.abs(input)<16&&!keepMinutes&&(input*=60);return!this._isUTC&&keepLocalTime&&(localAdjust=getDateOffset(this)),this._offset=input,this._isUTC=!0,null!=localAdjust&&this.add(localAdjust,"m"),offset!==input&&(!keepLocalTime||this._changeInProgress?addSubtract(this,createDuration(input-offset,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,hooks.updateOffset(this,!0),this._changeInProgress=null)),this}return this._isUTC?offset:getDateOffset(this)},proto.utc=function(keepLocalTime){return this.utcOffset(0,keepLocalTime)},proto.local=function(keepLocalTime){return this._isUTC&&(this.utcOffset(0,keepLocalTime),this._isUTC=!1,keepLocalTime&&this.subtract(getDateOffset(this),"m")),this},proto.parseZone=function(){if(null!=this._tzm)this.utcOffset(this._tzm,!1,!0);else if("string"==typeof this._i){var tZone=offsetFromString(matchOffset,this._i);null!=tZone?this.utcOffset(tZone):this.utcOffset(0,!0)}return this},proto.hasAlignedHourOffset=function(input){return!!this.isValid()&&(input=input?createLocal(input).utcOffset():0,(this.utcOffset()-input)%60==0)},proto.isDST=function(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()},proto.isLocal=function(){return!!this.isValid()&&!this._isUTC},proto.isUtcOffset=function(){return!!this.isValid()&&this._isUTC},proto.isUtc=isUtc,proto.isUTC=isUtc,proto.zoneAbbr=function(){return this._isUTC?"UTC":""},proto.zoneName=function(){return this._isUTC?"Coordinated Universal Time":""},proto.dates=deprecate("dates accessor is deprecated. Use date instead.",getSetDayOfMonth),proto.months=deprecate("months accessor is deprecated. Use month instead",getSetMonth),proto.years=deprecate("years accessor is deprecated. Use year instead",getSetYear),proto.zone=deprecate("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",(function(input,keepLocalTime){return null!=input?("string"!=typeof input&&(input=-input),this.utcOffset(input,keepLocalTime),this):-this.utcOffset()})),proto.isDSTShifted=deprecate("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",(function(){if(!isUndefined(this._isDSTShifted))return this._isDSTShifted;var other,c={};return copyConfig(c,this),(c=prepareConfig(c))._a?(other=c._isUTC?createUTC(c._a):createLocal(c._a),this._isDSTShifted=this.isValid()&&function(array1,array2,dontConvert){var i,len=Math.min(array1.length,array2.length),lengthDiff=Math.abs(array1.length-array2.length),diffs=0;for(i=0;i<len;i++)(dontConvert&&array1[i]!==array2[i]||!dontConvert&&toInt(array1[i])!==toInt(array2[i]))&&diffs++;return diffs+lengthDiff}(c._a,other.toArray())>0):this._isDSTShifted=!1,this._isDSTShifted}));var proto$1=Locale.prototype;function get$1(format,index,field,setter){var locale=getLocale(),utc=createUTC().set(setter,index);return locale[field](utc,format)}function listMonthsImpl(format,index,field){if(isNumber(format)&&(index=format,format=void 0),format=format||"",null!=index)return get$1(format,index,field,"month");var i,out=[];for(i=0;i<12;i++)out[i]=get$1(format,i,field,"month");return out}function listWeekdaysImpl(localeSorted,format,index,field){"boolean"==typeof localeSorted?(isNumber(format)&&(index=format,format=void 0),format=format||""):(index=format=localeSorted,localeSorted=!1,isNumber(format)&&(index=format,format=void 0),format=format||"");var i,locale=getLocale(),shift=localeSorted?locale._week.dow:0,out=[];if(null!=index)return get$1(format,(index+shift)%7,field,"day");for(i=0;i<7;i++)out[i]=get$1(format,(i+shift)%7,field,"day");return out}proto$1.calendar=function(key,mom,now){var output=this._calendar[key]||this._calendar.sameElse;return isFunction(output)?output.call(mom,now):output},proto$1.longDateFormat=function(key){var format=this._longDateFormat[key],formatUpper=this._longDateFormat[key.toUpperCase()];return format||!formatUpper?format:(this._longDateFormat[key]=formatUpper.match(formattingTokens).map((function(tok){return"MMMM"===tok||"MM"===tok||"DD"===tok||"dddd"===tok?tok.slice(1):tok})).join(""),this._longDateFormat[key])},proto$1.invalidDate=function(){return this._invalidDate},proto$1.ordinal=function(number){return this._ordinal.replace("%d",number)},proto$1.preparse=preParsePostFormat,proto$1.postformat=preParsePostFormat,proto$1.relativeTime=function(number,withoutSuffix,string,isFuture){var output=this._relativeTime[string];return isFunction(output)?output(number,withoutSuffix,string,isFuture):output.replace(/%d/i,number)},proto$1.pastFuture=function(diff,output){var format=this._relativeTime[diff>0?"future":"past"];return isFunction(format)?format(output):format.replace(/%s/i,output)},proto$1.set=function(config){var prop,i;for(i in config)hasOwnProp(config,i)&&(isFunction(prop=config[i])?this[i]=prop:this["_"+i]=prop);this._config=config,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)},proto$1.eras=function(m,format){var i,l,date,eras=this._eras||getLocale("en")._eras;for(i=0,l=eras.length;i<l;++i){switch(typeof eras[i].since){case"string":date=hooks(eras[i].since).startOf("day"),eras[i].since=date.valueOf()}switch(typeof eras[i].until){case"undefined":eras[i].until=1/0;break;case"string":date=hooks(eras[i].until).startOf("day").valueOf(),eras[i].until=date.valueOf()}}return eras},proto$1.erasParse=function(eraName,format,strict){var i,l,name,abbr,narrow,eras=this.eras();for(eraName=eraName.toUpperCase(),i=0,l=eras.length;i<l;++i)if(name=eras[i].name.toUpperCase(),abbr=eras[i].abbr.toUpperCase(),narrow=eras[i].narrow.toUpperCase(),strict)switch(format){case"N":case"NN":case"NNN":if(abbr===eraName)return eras[i];break;case"NNNN":if(name===eraName)return eras[i];break;case"NNNNN":if(narrow===eraName)return eras[i]}else if([name,abbr,narrow].indexOf(eraName)>=0)return eras[i]},proto$1.erasConvertYear=function(era,year){var dir=era.since<=era.until?1:-1;return void 0===year?hooks(era.since).year():hooks(era.since).year()+(year-era.offset)*dir},proto$1.erasAbbrRegex=function(isStrict){return hasOwnProp(this,"_erasAbbrRegex")||computeErasParse.call(this),isStrict?this._erasAbbrRegex:this._erasRegex},proto$1.erasNameRegex=function(isStrict){return hasOwnProp(this,"_erasNameRegex")||computeErasParse.call(this),isStrict?this._erasNameRegex:this._erasRegex},proto$1.erasNarrowRegex=function(isStrict){return hasOwnProp(this,"_erasNarrowRegex")||computeErasParse.call(this),isStrict?this._erasNarrowRegex:this._erasRegex},proto$1.months=function(m,format){return m?isArray(this._months)?this._months[m.month()]:this._months[(this._months.isFormat||MONTHS_IN_FORMAT).test(format)?"format":"standalone"][m.month()]:isArray(this._months)?this._months:this._months.standalone},proto$1.monthsShort=function(m,format){return m?isArray(this._monthsShort)?this._monthsShort[m.month()]:this._monthsShort[MONTHS_IN_FORMAT.test(format)?"format":"standalone"][m.month()]:isArray(this._monthsShort)?this._monthsShort:this._monthsShort.standalone},proto$1.monthsParse=function(monthName,format,strict){var i,mom,regex;if(this._monthsParseExact)return handleStrictParse.call(this,monthName,format,strict);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),i=0;i<12;i++){if(mom=createUTC([2e3,i]),strict&&!this._longMonthsParse[i]&&(this._longMonthsParse[i]=new RegExp("^"+this.months(mom,"").replace(".","")+"$","i"),this._shortMonthsParse[i]=new RegExp("^"+this.monthsShort(mom,"").replace(".","")+"$","i")),strict||this._monthsParse[i]||(regex="^"+this.months(mom,"")+"|^"+this.monthsShort(mom,""),this._monthsParse[i]=new RegExp(regex.replace(".",""),"i")),strict&&"MMMM"===format&&this._longMonthsParse[i].test(monthName))return i;if(strict&&"MMM"===format&&this._shortMonthsParse[i].test(monthName))return i;if(!strict&&this._monthsParse[i].test(monthName))return i}},proto$1.monthsRegex=function(isStrict){return this._monthsParseExact?(hasOwnProp(this,"_monthsRegex")||computeMonthsParse.call(this),isStrict?this._monthsStrictRegex:this._monthsRegex):(hasOwnProp(this,"_monthsRegex")||(this._monthsRegex=defaultMonthsRegex),this._monthsStrictRegex&&isStrict?this._monthsStrictRegex:this._monthsRegex)},proto$1.monthsShortRegex=function(isStrict){return this._monthsParseExact?(hasOwnProp(this,"_monthsRegex")||computeMonthsParse.call(this),isStrict?this._monthsShortStrictRegex:this._monthsShortRegex):(hasOwnProp(this,"_monthsShortRegex")||(this._monthsShortRegex=defaultMonthsShortRegex),this._monthsShortStrictRegex&&isStrict?this._monthsShortStrictRegex:this._monthsShortRegex)},proto$1.week=function(mom){return weekOfYear(mom,this._week.dow,this._week.doy).week},proto$1.firstDayOfYear=function(){return this._week.doy},proto$1.firstDayOfWeek=function(){return this._week.dow},proto$1.weekdays=function(m,format){var weekdays=isArray(this._weekdays)?this._weekdays:this._weekdays[m&&!0!==m&&this._weekdays.isFormat.test(format)?"format":"standalone"];return!0===m?shiftWeekdays(weekdays,this._week.dow):m?weekdays[m.day()]:weekdays},proto$1.weekdaysMin=function(m){return!0===m?shiftWeekdays(this._weekdaysMin,this._week.dow):m?this._weekdaysMin[m.day()]:this._weekdaysMin},proto$1.weekdaysShort=function(m){return!0===m?shiftWeekdays(this._weekdaysShort,this._week.dow):m?this._weekdaysShort[m.day()]:this._weekdaysShort},proto$1.weekdaysParse=function(weekdayName,format,strict){var i,mom,regex;if(this._weekdaysParseExact)return handleStrictParse$1.call(this,weekdayName,format,strict);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),i=0;i<7;i++){if(mom=createUTC([2e3,1]).day(i),strict&&!this._fullWeekdaysParse[i]&&(this._fullWeekdaysParse[i]=new RegExp("^"+this.weekdays(mom,"").replace(".","\\.?")+"$","i"),this._shortWeekdaysParse[i]=new RegExp("^"+this.weekdaysShort(mom,"").replace(".","\\.?")+"$","i"),this._minWeekdaysParse[i]=new RegExp("^"+this.weekdaysMin(mom,"").replace(".","\\.?")+"$","i")),this._weekdaysParse[i]||(regex="^"+this.weekdays(mom,"")+"|^"+this.weekdaysShort(mom,"")+"|^"+this.weekdaysMin(mom,""),this._weekdaysParse[i]=new RegExp(regex.replace(".",""),"i")),strict&&"dddd"===format&&this._fullWeekdaysParse[i].test(weekdayName))return i;if(strict&&"ddd"===format&&this._shortWeekdaysParse[i].test(weekdayName))return i;if(strict&&"dd"===format&&this._minWeekdaysParse[i].test(weekdayName))return i;if(!strict&&this._weekdaysParse[i].test(weekdayName))return i}},proto$1.weekdaysRegex=function(isStrict){return this._weekdaysParseExact?(hasOwnProp(this,"_weekdaysRegex")||computeWeekdaysParse.call(this),isStrict?this._weekdaysStrictRegex:this._weekdaysRegex):(hasOwnProp(this,"_weekdaysRegex")||(this._weekdaysRegex=defaultWeekdaysRegex),this._weekdaysStrictRegex&&isStrict?this._weekdaysStrictRegex:this._weekdaysRegex)},proto$1.weekdaysShortRegex=function(isStrict){return this._weekdaysParseExact?(hasOwnProp(this,"_weekdaysRegex")||computeWeekdaysParse.call(this),isStrict?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(hasOwnProp(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=defaultWeekdaysShortRegex),this._weekdaysShortStrictRegex&&isStrict?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)},proto$1.weekdaysMinRegex=function(isStrict){return this._weekdaysParseExact?(hasOwnProp(this,"_weekdaysRegex")||computeWeekdaysParse.call(this),isStrict?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(hasOwnProp(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=defaultWeekdaysMinRegex),this._weekdaysMinStrictRegex&&isStrict?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)},proto$1.isPM=function(input){return"p"===(input+"").toLowerCase().charAt(0)},proto$1.meridiem=function(hours,minutes,isLower){return hours>11?isLower?"pm":"PM":isLower?"am":"AM"},getSetGlobalLocale("en",{eras:[{since:"0001-01-01",until:1/0,offset:1,name:"Anno Domini",narrow:"AD",abbr:"AD"},{since:"0000-12-31",until:-1/0,offset:1,name:"Before Christ",narrow:"BC",abbr:"BC"}],dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(number){var b=number%10;return number+(1===toInt(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")}}),hooks.lang=deprecate("moment.lang is deprecated. Use moment.locale instead.",getSetGlobalLocale),hooks.langData=deprecate("moment.langData is deprecated. Use moment.localeData instead.",getLocale);var mathAbs=Math.abs;function addSubtract$1(duration,input,value,direction){var other=createDuration(input,value);return duration._milliseconds+=direction*other._milliseconds,duration._days+=direction*other._days,duration._months+=direction*other._months,duration._bubble()}function absCeil(number){return number<0?Math.floor(number):Math.ceil(number)}function daysToMonths(days){return 4800*days/146097}function monthsToDays(months){return 146097*months/4800}function makeAs(alias){return function(){return this.as(alias)}}var asMilliseconds=makeAs("ms"),asSeconds=makeAs("s"),asMinutes=makeAs("m"),asHours=makeAs("h"),asDays=makeAs("d"),asWeeks=makeAs("w"),asMonths=makeAs("M"),asQuarters=makeAs("Q"),asYears=makeAs("y");function makeGetter(name){return function(){return this.isValid()?this._data[name]:NaN}}var milliseconds=makeGetter("milliseconds"),seconds=makeGetter("seconds"),minutes=makeGetter("minutes"),hours=makeGetter("hours"),days=makeGetter("days"),months=makeGetter("months"),years=makeGetter("years"),round=Math.round,thresholds={ss:44,s:45,m:45,h:22,d:26,w:null,M:11};function substituteTimeAgo(string,number,withoutSuffix,isFuture,locale){return locale.relativeTime(number||1,!!withoutSuffix,string,isFuture)}var abs$1=Math.abs;function sign(x){return(x>0)-(x<0)||+x}function toISOString$1(){if(!this.isValid())return this.localeData().invalidDate();var minutes,hours,years,s,totalSign,ymSign,daysSign,hmsSign,seconds=abs$1(this._milliseconds)/1e3,days=abs$1(this._days),months=abs$1(this._months),total=this.asSeconds();return total?(minutes=absFloor(seconds/60),hours=absFloor(minutes/60),seconds%=60,minutes%=60,years=absFloor(months/12),months%=12,s=seconds?seconds.toFixed(3).replace(/\.?0+$/,""):"",totalSign=total<0?"-":"",ymSign=sign(this._months)!==sign(total)?"-":"",daysSign=sign(this._days)!==sign(total)?"-":"",hmsSign=sign(this._milliseconds)!==sign(total)?"-":"",totalSign+"P"+(years?ymSign+years+"Y":"")+(months?ymSign+months+"M":"")+(days?daysSign+days+"D":"")+(hours||minutes||seconds?"T":"")+(hours?hmsSign+hours+"H":"")+(minutes?hmsSign+minutes+"M":"")+(seconds?hmsSign+s+"S":"")):"P0D"}var proto$2=Duration.prototype;return proto$2.isValid=function(){return this._isValid},proto$2.abs=function(){var data=this._data;return this._milliseconds=mathAbs(this._milliseconds),this._days=mathAbs(this._days),this._months=mathAbs(this._months),data.milliseconds=mathAbs(data.milliseconds),data.seconds=mathAbs(data.seconds),data.minutes=mathAbs(data.minutes),data.hours=mathAbs(data.hours),data.months=mathAbs(data.months),data.years=mathAbs(data.years),this},proto$2.add=function(input,value){return addSubtract$1(this,input,value,1)},proto$2.subtract=function(input,value){return addSubtract$1(this,input,value,-1)},proto$2.as=function(units){if(!this.isValid())return NaN;var days,months,milliseconds=this._milliseconds;if("month"===(units=normalizeUnits(units))||"quarter"===units||"year"===units)switch(days=this._days+milliseconds/864e5,months=this._months+daysToMonths(days),units){case"month":return months;case"quarter":return months/3;case"year":return months/12}else switch(days=this._days+Math.round(monthsToDays(this._months)),units){case"week":return days/7+milliseconds/6048e5;case"day":return days+milliseconds/864e5;case"hour":return 24*days+milliseconds/36e5;case"minute":return 1440*days+milliseconds/6e4;case"second":return 86400*days+milliseconds/1e3;case"millisecond":return Math.floor(864e5*days)+milliseconds;default:throw new Error("Unknown unit "+units)}},proto$2.asMilliseconds=asMilliseconds,proto$2.asSeconds=asSeconds,proto$2.asMinutes=asMinutes,proto$2.asHours=asHours,proto$2.asDays=asDays,proto$2.asWeeks=asWeeks,proto$2.asMonths=asMonths,proto$2.asQuarters=asQuarters,proto$2.asYears=asYears,proto$2.valueOf=function(){return this.isValid()?this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*toInt(this._months/12):NaN},proto$2._bubble=function(){var seconds,minutes,hours,years,monthsFromDays,milliseconds=this._milliseconds,days=this._days,months=this._months,data=this._data;return milliseconds>=0&&days>=0&&months>=0||milliseconds<=0&&days<=0&&months<=0||(milliseconds+=864e5*absCeil(monthsToDays(months)+days),days=0,months=0),data.milliseconds=milliseconds%1e3,seconds=absFloor(milliseconds/1e3),data.seconds=seconds%60,minutes=absFloor(seconds/60),data.minutes=minutes%60,hours=absFloor(minutes/60),data.hours=hours%24,days+=absFloor(hours/24),monthsFromDays=absFloor(daysToMonths(days)),months+=monthsFromDays,days-=absCeil(monthsToDays(monthsFromDays)),years=absFloor(months/12),months%=12,data.days=days,data.months=months,data.years=years,this},proto$2.clone=function(){return createDuration(this)},proto$2.get=function(units){return units=normalizeUnits(units),this.isValid()?this[units+"s"]():NaN},proto$2.milliseconds=milliseconds,proto$2.seconds=seconds,proto$2.minutes=minutes,proto$2.hours=hours,proto$2.days=days,proto$2.weeks=function(){return absFloor(this.days()/7)},proto$2.months=months,proto$2.years=years,proto$2.humanize=function(argWithSuffix,argThresholds){if(!this.isValid())return this.localeData().invalidDate();var locale,output,withSuffix=!1,th=thresholds;return"object"==typeof argWithSuffix&&(argThresholds=argWithSuffix,argWithSuffix=!1),"boolean"==typeof argWithSuffix&&(withSuffix=argWithSuffix),"object"==typeof argThresholds&&(th=Object.assign({},thresholds,argThresholds),null!=argThresholds.s&&null==argThresholds.ss&&(th.ss=argThresholds.s-1)),locale=this.localeData(),output=function(posNegDuration,withoutSuffix,thresholds,locale){var duration=createDuration(posNegDuration).abs(),seconds=round(duration.as("s")),minutes=round(duration.as("m")),hours=round(duration.as("h")),days=round(duration.as("d")),months=round(duration.as("M")),weeks=round(duration.as("w")),years=round(duration.as("y")),a=seconds<=thresholds.ss&&["s",seconds]||seconds<thresholds.s&&["ss",seconds]||minutes<=1&&["m"]||minutes<thresholds.m&&["mm",minutes]||hours<=1&&["h"]||hours<thresholds.h&&["hh",hours]||days<=1&&["d"]||days<thresholds.d&&["dd",days];return null!=thresholds.w&&(a=a||weeks<=1&&["w"]||weeks<thresholds.w&&["ww",weeks]),(a=a||months<=1&&["M"]||months<thresholds.M&&["MM",months]||years<=1&&["y"]||["yy",years])[2]=withoutSuffix,a[3]=+posNegDuration>0,a[4]=locale,substituteTimeAgo.apply(null,a)}(this,!withSuffix,th,locale),withSuffix&&(output=locale.pastFuture(+this,output)),locale.postformat(output)},proto$2.toISOString=toISOString$1,proto$2.toString=toISOString$1,proto$2.toJSON=toISOString$1,proto$2.locale=locale,proto$2.localeData=localeData,proto$2.toIsoString=deprecate("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",toISOString$1),proto$2.lang=lang,addFormatToken("X",0,0,"unix"),addFormatToken("x",0,0,"valueOf"),addRegexToken("x",matchSigned),addRegexToken("X",/[+-]?\d+(\.\d{1,3})?/),addParseToken("X",(function(input,array,config){config._d=new Date(1e3*parseFloat(input))})),addParseToken("x",(function(input,array,config){config._d=new Date(toInt(input))})),
//! moment.js
hooks.version="2.29.1",hookCallback=createLocal,hooks.fn=proto,hooks.min=function(){var args=[].slice.call(arguments,0);return pickBy("isBefore",args)},hooks.max=function(){var args=[].slice.call(arguments,0);return pickBy("isAfter",args)},hooks.now=function(){return Date.now?Date.now():+new Date},hooks.utc=createUTC,hooks.unix=function(input){return createLocal(1e3*input)},hooks.months=function(format,index){return listMonthsImpl(format,index,"months")},hooks.isDate=isDate,hooks.locale=getSetGlobalLocale,hooks.invalid=createInvalid,hooks.duration=createDuration,hooks.isMoment=isMoment,hooks.weekdays=function(localeSorted,format,index){return listWeekdaysImpl(localeSorted,format,index,"weekdays")},hooks.parseZone=function(){return createLocal.apply(null,arguments).parseZone()},hooks.localeData=getLocale,hooks.isDuration=isDuration,hooks.monthsShort=function(format,index){return listMonthsImpl(format,index,"monthsShort")},hooks.weekdaysMin=function(localeSorted,format,index){return listWeekdaysImpl(localeSorted,format,index,"weekdaysMin")},hooks.defineLocale=defineLocale,hooks.updateLocale=function(name,config){if(null!=config){var locale,tmpLocale,parentConfig=baseConfig;null!=locales[name]&&null!=locales[name].parentLocale?locales[name].set(mergeConfigs(locales[name]._config,config)):(null!=(tmpLocale=loadLocale(name))&&(parentConfig=tmpLocale._config),config=mergeConfigs(parentConfig,config),null==tmpLocale&&(config.abbr=name),(locale=new Locale(config)).parentLocale=locales[name],locales[name]=locale),getSetGlobalLocale(name)}else null!=locales[name]&&(null!=locales[name].parentLocale?(locales[name]=locales[name].parentLocale,name===getSetGlobalLocale()&&getSetGlobalLocale(name)):null!=locales[name]&&delete locales[name]);return locales[name]},hooks.locales=function(){return keys(locales)},hooks.weekdaysShort=function(localeSorted,format,index){return listWeekdaysImpl(localeSorted,format,index,"weekdaysShort")},hooks.normalizeUnits=normalizeUnits,hooks.relativeTimeRounding=function(roundingFunction){return void 0===roundingFunction?round:"function"==typeof roundingFunction&&(round=roundingFunction,!0)},hooks.relativeTimeThreshold=function(threshold,limit){return void 0!==thresholds[threshold]&&(void 0===limit?thresholds[threshold]:(thresholds[threshold]=limit,"s"===threshold&&(thresholds.ss=limit-1),!0))},hooks.calendarFormat=function(myMoment,now){var diff=myMoment.diff(now,"days",!0);return diff<-6?"sameElse":diff<-1?"lastWeek":diff<0?"lastDay":diff<1?"sameDay":diff<2?"nextDay":diff<7?"nextWeek":"sameElse"},hooks.prototype=proto,hooks.HTML5_FMT={DATETIME_LOCAL:"YYYY-MM-DDTHH:mm",DATETIME_LOCAL_SECONDS:"YYYY-MM-DDTHH:mm:ss",DATETIME_LOCAL_MS:"YYYY-MM-DDTHH:mm:ss.SSS",DATE:"YYYY-MM-DD",TIME:"HH:mm",TIME_SECONDS:"HH:mm:ss",TIME_MS:"HH:mm:ss.SSS",WEEK:"GGGG-[W]WW",MONTH:"YYYY-MM"},hooks}()}).call(this,__webpack_require__(275)(module))},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.XmppService=void 0;const rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24),logger_service_1=__webpack_require__(15),settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),randomString_1=__webpack_require__(219),main_service_1=__webpack_require__(26),anonymizer_1=__webpack_require__(14),$=__webpack_require__(305);class XmppService{constructor(){this.rxConnectionSubject=new rxjs_1.Subject,this.rxContactSubject=new rxjs_1.Subject,this.showBodyMessage=!1,this.presenceWaitingList=[],this.xmppServerURL=null,this.stropheStatus=null,this.presenceStatus="offline",this.pingTimeout=null,this.connecting=!1,this.disconnectInfo=null,this.connectionWatcherTimout=null,this.isInitialPresenceSent=!1,this.historyHandler=null,this.bulkHistoryHandler=null,this.searchTextHandler=null,this.callLogHandler=null,this.reconnectInProgress=!1,this.reconnectionDelay=250,this.reconnectTimeout=null,this.connectivityEventSubscription=null,this.started=!1,this.connection=null,this.jid=null,this.fullJid=null,this.changePasswordInfo=null,this.contactServiceReady=!1,this.connected=!1}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.xmppService||(win.rainbow.xmppService=new XmppService),win.rainbow.xmppService}onHandleConnectivity(online){online?(logger_service_1.default.info("[xmppService] -- onHandleConnectivityEvent -- retrieve connectivity"),this.autoReconnect(!0)):(logger_service_1.default.info("[xmppService] -- onHandleConnectivityEvent -- lost connectivity"),this.stropheStatus===Strophe.Status.CONNECTED&&(this.interruptAutoReconnect(),this.disconnect("NO_NETWORK")))}start(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.connectivityEventSubscription=main_service_1.default.subscribeToConnectivityEvents(online=>{this.onHandleConnectivity(online)}),!auth_service_1.default.jidIm||!auth_service_1.default.jidPwd)throw new Error("No valid XMPP credentials");this.xmppServerURL=`${config.xmpp.protocol}://${config.xmpp.currentServer}:${config.xmpp.port}/websocket`,this.showBodyMessage=settings_service_1.default.getBooleanSetting("showBodyMessage"),this.pingTimeout=config.xmpp.pingInterval?2*parseInt(config.xmpp.pingInterval,10):12e4,yield this.connect(),this.publishConnectionEvent("ON_XMPP_CONNECTED",{reason:"LOGIN"})}catch(error){throw logger_service_1.default.error("[xmppService] start -- FAILURE -- "+error.message),error}}))}stop(){return __awaiter(this,void 0,void 0,(function*(){try{yield this.disconnect("LOGOUT")}catch(error){}this.started=!1,this.connected=!1,this.stropheStatus=null,this.presenceStatus="offline",this.fullJid=null,this.connectivityEventSubscription&&(this.connectivityEventSubscription.unsubscribe(),this.connectivityEventSubscription=null)}))}connect(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.stropheStatus===Strophe.Status.CONNECTING||this.stropheStatus===Strophe.Status.CONNECTED||this.stropheStatus===Strophe.Status.AUTHENTICATING){const error=new Error("XMPP service already connected or connecting");throw error.details=this.stropheStatus===Strophe.Status.CONNECTING?"XMPP_IN_CONNECTING_STATE":"XMPP_ALREADY_CONNECTED",error}const client=auth_service_1.default.getInformationHeadersApp(),clientVersion=auth_service_1.default.getInformationHeadersAppVersion(),xmppDomain=auth_service_1.default.xmppDomain;if(null===client||null===clientVersion||null===xmppDomain)throw new Error("XMPP service -- Missing connection data");this.connection=new Strophe.Connection(`${this.xmppServerURL}?x-rainbow-client=${client}&x-rainbow-client-version=${clientVersion}&x-rainbow-xmpp-dom=${xmppDomain}`),this.connection.rawInput=data=>{this.handleRawXmppMessage(data,"Recv: ")},this.connection.rawOutput=data=>{this.handleRawXmppMessage(data,"Sent: ")},this.jid=auth_service_1.default.jidIm,this.fullJid||(this.fullJid=this.generateRandomFullJid(this.jid)),yield this.stropheConnect(),this.connected=!0,this.connection.ping.addPingHandler(ping=>(logger_service_1.default.info(`[xmppService] -- onKeepAlivePingEvent (${new Date})`),this.connected&&this.connection.ping.pong(ping),!0)),this.addHandler(stanza=>this.onRosterChangedMessageReceived(stanza),"jabber:iq:roster","iq","set"),this.addHandler(stanza=>this.onMamMessageReceived(stanza),Strophe.NS.MAM,"message",null),this.addHandler(stanza=>this.onMamMessageReceived(stanza),Strophe.NS.MAM,"iq",null),this.addHandler(stanza=>this.onMamBulkMessageReceived(stanza),"urn:xmpp:mam:1:bulk","message",null),this.addHandler(stanza=>this.onMamBulkMessageReceived(stanza),"urn:xmpp:mam:1:bulk","iq",null),this.addHandler(stanza=>this.onSearchTextMessageReceived(stanza),"urn:xmpp:mam:tmp","message",null),this.addHandler(stanza=>this.onPresenceMessageReceived(stanza),null,"presence"),this.connection.jingle&&this.connection.jingle.attachHandlers(),this.presenceWaitingList=[];const iq=$iq({type:"set"});iq.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.sendIQ(iq),this.started=!0}catch(error){throw logger_service_1.default.error("[xmppService] connect -- FAILURE -- "+error.message),error}}))}disconnect(reason){return new Promise(resolve=>{this.connected?this.stropheStatus===Strophe.Status.CONNECTED&&(logger_service_1.default.info("[xmppService] disconnect -- "+reason),this.disconnectInfo={reason:reason,resolve:resolve},this.connection.disconnect(reason)):(logger_service_1.default.info("[xmppService] disconnect - service is not started"),resolve())})}stropheConnect(){return new Promise((resolve,reject)=>{this.connecting=!0,this.connection.connect(this.fullJid,auth_service_1.default.jidPwd,(status,reason=null)=>{switch(this.stropheStatus=status,status){case Strophe.Status.CONNECTING:this.publishConnectionEvent("ON_XMPP_CONNECTING");break;case Strophe.Status.AUTHFAIL:logger_service_1.default.error(`[xmppService] -- onAuthenticationFailureEvent -- ${reason} -- ${this.fullJid}`),this.connecting=!1,reject(new Error("Authentication failure -- "+reason));break;case Strophe.Status.CONNFAIL:if(!this.connecting)break;logger_service_1.default.error("[xmppService] -- onConnectionFailureEvent -- ConnectionFail -- "+this.fullJid),this.connecting=!1,reject(new Error("Connection failure -- "+reason));break;case Strophe.Status.CONNECTED:logger_service_1.default.info("[xmppService] -- onConnectedEvent -- "+this.fullJid),this.connecting=!1,resolve();break;case Strophe.Status.DISCONNECTED:if(this.connecting){logger_service_1.default.error("[xmppService] -- onConnectionFailureEvent -- Disconnected -- "+this.fullJid),reject(new Error("Connection failure -- "+reason));break}this.reconnectInProgress||this.onDisconnectEvent(reason)}})})}connectionWatcher(){try{if(logger_service_1.default.error("[xmppService] -- Connection watcher : so bad, no message since "+this.pingTimeout/1e3+" seconds (no ping)"),this.connection){const message=this.stropheStatus===Strophe.Status.CONNECTED?"Have lost connectivity":"Stuck in reconnecting state";logger_service_1.default.info("[xmppService] -- Connection watcher -- "+message),this.stropheStatus=null,this.connection.disconnect("No ping")}}catch(error){logger_service_1.default.error("connectionWatcher error "+error)}}generateRandomFullJid(jid){const OS=navigator.platform.toUpperCase().indexOf("MAC")>=0?"osx":"win";let platform="desk_"+OS;return main_service_1.default.isDesktopApp()||(platform=auth_service_1.default.fromSDK?"web_sdk":"web_"+OS),`${jid}/${platform}_${version}_${randomString_1.default(8)}`}handleRawXmppMessage(data,direction){if(this.connectionWatcherTimout&&clearTimeout(this.connectionWatcherTimout),this.connectionWatcherTimout=setTimeout(()=>{this.connectionWatcher()},this.pingTimeout),!(data.indexOf("<PHOTO>")>-1)){let log=direction;if(data.indexOf("urn:xmpp:mam:1:bulk")>-1)"true"===settings_service_1.default.getSetting("devMode")?log+=data:log+="Hidden content -- bulk";else if(data.indexOf("xmlns='jabber:x:bubble:conference'")>-1&&(data.indexOf("name='invitation'")>-1||data.indexOf("name='conferenceAdd'")>-1||data.indexOf("name='conferenceRemove'")>-1))log+="Hidden content";else if(data.indexOf("xmlns='urn:xmpp:jingle:1'")>-1&&(data.indexOf("displayname")>-1||data.indexOf("number")>-1))log+="Hidden content";else if(data.indexOf("urn:xmpp:janus:1")>-1&&(data.indexOf("displayName")>-1||data.indexOf("displayname")>-1||data.indexOf("number")>-1))log+="Hidden content";else if(data.indexOf("<message")>-1&&(data.indexOf("<body")>-1||data.indexOf("<content>")>-1||data.indexOf("<thumbnail")>-1))log+=this.messageBodyDiscretion(data);else{let result=data;const dataElem=$(data).find("data");if(dataElem&&"http://jabber.org/protocol/ibb"===dataElem.attr("xmlns")&&(dataElem.html("Encoded file in base 64"),log+=dataElem.html()),!this.showBodyMessage){if(-1!==data.indexOf("<identity")){const firstName=data.indexOf("firstName="),firstNameIndex=data.indexOf("'",firstName);if(-1!==firstName&&-1!==firstNameIndex){const firstNameLastIndex=data.indexOf("'",firstNameIndex+1);firstNameIndex+1!==firstNameLastIndex&&(result=data.substr(0,firstNameIndex+2)+"***"+data.substr(firstNameLastIndex))}const lastName=result.indexOf("lastName="),lastNameIndex=result.indexOf("'",lastName);if(-1!==lastName&&-1!==lastNameIndex){const lastNameLastIndex=result.indexOf("'",lastNameIndex+1);lastNameIndex+1!==lastNameLastIndex&&(result=result.substr(0,lastNameIndex+2)+"***"+result.substr(lastNameLastIndex))}}if(-1!==result.indexOf("<caller_info")||-1!==result.indexOf("<callee_info")){const number=result.indexOf("number="),numberIndex=result.indexOf("'",number);if(-1!==number&&-1!==numberIndex){const numberLastIndex=result.indexOf("'",numberIndex+1);if(numberIndex+1!==numberLastIndex){const numberText=result.substr(numberIndex+1,numberLastIndex-numberIndex-1);result=result.substr(0,numberIndex+1)+anonymizer_1.default(numberText)+result.substr(numberLastIndex)}}}if(-1!==result.indexOf("<caller>")){const caller=result.indexOf("<caller>"),endCaller=result.indexOf("</caller>",caller),numberText=result.substring(caller+8,endCaller);-1===numberText.indexOf("@")&&-1===numberText.indexOf("janus")&&(result=result.substr(0,caller+8)+anonymizer_1.default(numberText)+result.substr(endCaller))}if(-1!==result.indexOf("<callee>")){const callee=result.indexOf("<callee>"),endCallee=result.indexOf("</callee>",callee),numberText=result.substring(callee+8,endCallee);-1===numberText.indexOf("@")&&-1===numberText.indexOf("janus")&&(result=result.substr(0,callee+8)+anonymizer_1.default(numberText)+result.substr(endCallee))}if(-1!==result.indexOf("<event")){const message=result.indexOf("<message>"),endMessage=result.indexOf("</message>",message);result=result.substr(0,message+9)+"***"+result.substr(endMessage)}const endpointTel=result.indexOf("endpointTel='");if(-1!==endpointTel){const endEndpointTel=result.indexOf("'",endpointTel+13),numberText=result.substring(endpointTel+13,endEndpointTel);result=result.substr(0,endpointTel+13)+anonymizer_1.default(numberText)+result.substr(endEndpointTel)}const destination=result.indexOf("destination='");if(-1!==destination){const endDestination=result.indexOf("'",destination+13),numberText=result.substring(destination+13,endDestination);result=result.substr(0,destination+13)+anonymizer_1.default(numberText)+result.substr(endDestination)}if(-1!==result.indexOf("<name>")){const message=result.indexOf("<name>"),endMessage=result.indexOf("</name>",message);result=result.substr(0,message+6)+"***"+result.substr(endMessage)}}log+=result}logger_service_1.default.debug(log)}}messageBodyDiscretion(data){return this.showBodyMessage?data:(data=this.messageTagDiscretion("content",data),data=this.messageTagDiscretion("body",data),data=this.messageTagDiscretion("subject",data),data=this.messageTagDiscretion("filename",data))}messageTagDiscretion(tag,data){const startTagIndex=data.indexOf("<"+tag);if(-1!==startTagIndex){const endTagIndex=data.indexOf(">",startTagIndex),endEmptyTagIndex=data.indexOf("/>",startTagIndex);if(-1!==endTagIndex&&endTagIndex!==endEmptyTagIndex+1)return data.substr(0,endTagIndex+2)+"***"+data.substr(data.indexOf("</"+tag+">")-1)}return data}onDisconnectEvent(reason){return __awaiter(this,void 0,void 0,(function*(){if(this.connectionWatcherTimout&&clearTimeout(this.connectionWatcherTimout),this.isInitialPresenceSent=!1,this.started){if(this.disconnectInfo)return logger_service_1.default.info(`[xmppService] -- onDisconnectEvent -- Expected disconnection -- ${this.disconnectInfo.reason} -- ${this.fullJid}`),this.connected=!1,this.publishConnectionEvent("ON_XMPP_DISCONNECTED",{reason:this.disconnectInfo.reason}),void this.disconnectInfo.resolve();if(this.changePasswordInfo)if(this.connected=!1,this.changePasswordInfo.fromThirdParty)logger_service_1.default.error("[xmppService] -- onDisconnectEvent -- Expected disconnection -- change password from third party -- "+this.fullJid),this.publishConnectionEvent("ON_XMPP_DISCONNECTED",{reason:"3RD_PARTY_CHANGE_PWD"});else{logger_service_1.default.error("[xmppService] -- onDisconnectEvent -- Expected disconnection -- change password -- "+this.fullJid);try{yield auth_service_1.default.logon(this.changePasswordInfo.login,this.changePasswordInfo.newPassword,!0)}catch(error){this.publishConnectionEvent("ON_XMPP_DISCONNECTED",{reason:"CHANGE_PWD_ERROR"})}this.changePasswordInfo.resolve&&this.changePasswordInfo.resolve(),this.changePasswordInfo=null,this.publishConnectionEvent("ON_XMPP_DISCONNECTED",{reason:"CHANGE_PWD"}),this.autoReconnect()}else logger_service_1.default.error(`[xmppService] -- onDisconnectEvent -- Unexpected disconnection -- ${reason} -- ${this.fullJid}`),this.connected=!1,this.publishConnectionEvent("ON_XMPP_DISCONNECTED",{reason:"UNKNOWN"}),this.autoReconnect()}else logger_service_1.default.info("[xmppService] -- onDisconnectEvent -- service not started -- ignored")}))}interruptAutoReconnect(force=!1){(this.reconnectInProgress||force)&&(logger_service_1.default.info("[xmppService] interrupt auto-reconnection"),this.reconnectionDelay=250,this.reconnectInProgress=!1,this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.connectionWatcherTimout&&(logger_service_1.default.info("[xmppService] Clear connection watcher timeout"),clearTimeout(this.connectionWatcherTimout)))}autoReconnect(force=!1){return __awaiter(this,void 0,void 0,(function*(){try{this.interruptAutoReconnect(force),logger_service_1.default.info("[xmppService] autoReconnect"),this.reconnectInProgress=!0,yield auth_service_1.default.startTokenSurvey(),yield this.connect(),this.reconnectionDelay=250,this.reconnectInProgress=!1,logger_service_1.default.info("[xmppService] autoReconnect -- SUCCESS"),this.publishConnectionEvent("ON_XMPP_CONNECTED",{reason:"RECONNECTION"})}catch(errorInfo){let error=errorInfo;switch(errorInfo&&errorInfo.details||(error=new Error,error.details="UNKNOWN"),error.details){case"AUTH_TOKEN_EXPIRED":logger_service_1.default.error("[xmppService] Impossible to renew token, redirect to login page"),this.interruptAutoReconnect(),auth_service_1.default.logout(),this.reconnectInProgress=!1;break;case"XMPP_ALREADY_CONNECTED":logger_service_1.default.error("[xmppService] In auto-reconnect, but already connected -- ignore"),this.reconnectInProgress=!1;break;case"XMPP_IN_CONNECTING_STATE":logger_service_1.default.error("[xmppService] xmpp is still connecting -- wait");break;default:this.reconnectInProgress&&(this.reconnectionDelay=2*this.reconnectionDelay,this.reconnectionDelay>15e3&&(this.reconnectionDelay=15e3),logger_service_1.default.info("[xmppService] Auto-reconnection failure (next try in "+this.reconnectionDelay+"ms)"),this.reconnectTimeout=setTimeout(()=>{this.autoReconnect()},this.reconnectionDelay)),this.reconnectInProgress=!1}}}))}subscribeToContactEvents(observer){return this.rxContactSubject.subscribe(observer)}subscribeToConnectionEvents(observer){return this.rxConnectionSubject.subscribe(observer)}publishContactEvent(name,params){this.rxContactSubject.next(event_model_1.RBEvent.create(name,params))}publishConnectionEvent(name,data=null){this.rxConnectionSubject.next(event_model_1.RBEvent.create(name,data))}onRosterChangedMessageReceived(stanza){try{return $(stanza).find("item").each((__index,data)=>{const elem=$(data),jid=this.getBareJidFromJid(elem.attr("jid")),favorite="favorites"===elem.find("group").first().text(),sub=elem.attr("subscription"),ask=elem.attr("ask");this.publishContactEvent("ON_ROSTER_CHANGED_EVENT",{jid:jid,subscription:sub||"none",favorite:favorite,ask:ask||"none"})}),!0}catch(error){return!0}}sendPresence(show,message,auth=!1,userOptions){if(this.connection&&this.connection.send&&this.stropheStatus===Strophe.Status.CONNECTED)try{logger_service_1.default.info("Send presence "+show+" - "+message+" ("+this.jid+")");const presenceIq=$pres();presenceIq.c("priority").t("5"),presenceIq.up(),show&&"online"!==show&&presenceIq.c("show").t(show),!message||show&&"online"!==show?message&&presenceIq.up().c("status").t(message):presenceIq.c("status").t(message),!0===auth&&(show&&"online"!==show&&presenceIq.up(),presenceIq.c("application",{xmlns:"jabber:iq:application"}),presenceIq.c("appid").t(config.rainbowApiClientKey).up(),presenceIq.c("userid").t(auth_service_1.default.userId).up().up(),presenceIq.c("parameters",{xmlns:"jabber:iq:configuration"}),presenceIq.c("user_options",{alert:userOptions.alert,im:userOptions.im})),this.connection.send(presenceIq)}catch(error){return void logger_service_1.default.error("this.connection.send error : "+error)}else logger_service_1.default.error('[xmppService] Try to send "presence IQ" but no xmpp connection')}resetPresence(status){logger_service_1.default.info(`Reset presence to ${this.presenceStatus} (${this.jid})`),this.sendPresence(status.show,status.status)}onPresenceMessageReceived(presence){try{const pres=$(presence),fromJid=pres.attr("from"),fromBareJid=this.getBareJidFromJid(fromJid),namespace=pres.find("x").attr("xmlns"),ptype=pres.attr("type");if(namespace&&0===namespace.indexOf(Strophe.NS.MUC))return!0;if(pres.find("actor").length>0&&"jabber:iq:configuration"===pres.find("actor").attr("xmlns")&&(pres.find("avatar").length>0?this.publishContactEvent("ON_CONTACT_UPDATE_EVENT",{from:fromBareJid,type:"avatar"}):pres.find("data").length>0&&this.publishContactEvent("ON_CONTACT_UPDATE_EVENT",{from:fromBareJid,type:"data"}),pres.find("x").length&&"vcard-temp:x:update"===pres.find("x").attr("xmlns")))return!0;if("error"===ptype)logger_service_1.default.error("Receive error presence message");else if("subscribe"===ptype)logger_service_1.default.info("Receive subscribe from ("+fromBareJid+")");else{let presenceStatus="offline",presenceMessage="";if("unavailable"!==ptype){const show=pres.find("show").text();presenceMessage=pres.find("status").text(),presenceStatus=""===show||"chat"===show?"online":"dnd"===show?"dnd":"xa"===show?"xa":"away"}const stamp=pres.find("delay").attr("stamp"),presStamp=stamp?new Date(stamp):new Date;let until=pres.find("until").text();until=until?new Date(until):null;const eventAttr={jid:fromJid,status:presenceStatus,message:presenceMessage,stamp:presStamp,until:until};this.isConnectedJid(fromJid)&&!this.isInitialPresenceSent&&(this.isInitialPresenceSent=!0,this.publishConnectionEvent("ON_XMPP_CONNECTED",{reason:"PRESENCE"})),this.contactServiceReady?this.publishContactEvent("ON_CONTACT_PRESENCE_EVENT",eventAttr):(logger_service_1.default.info("[xmppService] Receive presence message but contact service is not ready yet"),this.presenceWaitingList.push(eventAttr))}return!0}catch(error){return!0}}getPresenceWaitingList(){return this.presenceWaitingList}resetPresenceWaitingList(){this.presenceWaitingList=[]}addHistoryHandler(handler){this.historyHandler=handler}addBulkHistoryHandler(handler){this.bulkHistoryHandler=handler}addSearchTextHandler(handler){this.searchTextHandler=handler}addHistoryCallLogsHandler(handler){this.callLogHandler=handler}onMamBulkMessageReceived(stanza){try{this.bulkHistoryHandler(stanza)}catch(error){return!0}return!0}onMamMessageReceived(stanza){try{let queryId=$(stanza).find("result").attr("queryid");return queryId||(queryId=$(stanza).find("fin").attr("queryid")),queryId&&(-1!==queryId.indexOf("tel_")||-1!==queryId.indexOf("cache_"))&&this.historyHandler?this.historyHandler(stanza):this.callLogHandler&&this.callLogHandler(stanza),!0}catch(error){return!0}}onSearchTextMessageReceived(stanza){try{let queryId=angular.element(stanza).find("result").attr("queryid");return queryId||(queryId=angular.element(stanza).find("fin").attr("queryid")),this.searchTextHandler&&this.searchTextHandler(queryId,stanza),!0}catch(error){return!0}}getBareJidFromJid(jid){return Strophe.getBareJidFromJid(jid)}getResourceFromJid(jid){return Strophe.getResourceFromJid(jid)}isMobileResource(jid){return-1!==jid.indexOf("mobile_")}addHandler(handler,ns,name=null,type=null){return this.connection.addHandler(handler,ns,name,type)}deleteHandler(handRef){this.connection&&this.connection.deleteHandler(handRef)}isConnectedJid(jid){return!(!jid||0===jid.length)&&jid.startsWith(this.jid)}send(stanza){return new Promise(resolve=>{try{if(!this.connection&&this.stropheStatus!==Strophe.Status.CONNECTED)throw logger_service_1.default.error('[xmppService] Try to send "stanza" but no xmpp connection'),new Error("No XMPP connection");this.connection.send(stanza)}catch(error){logger_service_1.default.error("[xmppService] this.connection.send error : "+error)}resolve()})}sendIQ(iq,timeout=null){return new Promise((resolve,reject)=>{try{if(!this.connection&&this.stropheStatus!==Strophe.Status.CONNECTED)throw logger_service_1.default.error('[xmppService] Try to send "iq" but no xmpp connection'),new Error("No XMPP connection");this.connection.sendIQ(iq,data=>{resolve(data)},error=>{reject(new Error(error?error.innerHTML:"XMPP request timeout"))},timeout&&timeout>XmppService.REQUEST_TIMEOUT?timeout:XmppService.REQUEST_TIMEOUT)}catch(error){logger_service_1.default.error("[xmppService] this.connection.sendIQ error : "+error),reject(new Error("this.connection.sendIQ error"))}})}}exports.XmppService=XmppService,XmppService.REQUEST_TIMEOUT=1e4,exports.default=XmppService.getInstance()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SettingsService=void 0;const rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24);class SettingsService{constructor(){this.redirectVoIP=!1,this.automaticHookOff=!1,this.automaticHookOffTime=0,this.languageCodes=null,this.defaultLanguage={label:"English",settingCode:"en",code:"en",isoCode:"en",codeMoment:"en",unicode:"1f1ec-1f1e7"},this.languages=[this.defaultLanguage,{label:"Franais",settingCode:"fr",code:"fr",isoCode:"fr",codeMoment:"fr",unicode:"1f1eb-1f1f7"},{label:"Catal",settingCode:"ca",code:"ca",isoCode:"ca",codeMoment:"ca",unicode:"1f1ea-1f1f8"},{label:"Deutsch",settingCode:"de",code:"de",isoCode:"de",codeMoment:"de",unicode:"1f1e9-1f1ea"},{label:"Espaol",settingCode:"es-es",code:"es-es",isoCode:"es-ES",codeMoment:"es",unicode:"1f1ea-1f1f8"},{label:"Suomi",settingCode:"fi",code:"fi",isoCode:"fi",codeMoment:"fi",unicode:"1f1eb-1f1ee"},{label:"Italiano",settingCode:"it",code:"it",isoCode:"it",codeMoment:"it",unicode:"1f1ee-1f1f9"},{label:"",settingCode:"he",code:"he",isoCode:"he",codeMoment:"he",unicode:"1f1ee-1f1f1"},{label:"",settingCode:"ja",code:"ja",isoCode:"ja",codeMoment:"ja",unicode:"1f1ef-1f1f5"},{label:"",settingCode:"ko",code:"ko",isoCode:"ko",codeMoment:"ko",unicode:"1f1f0-1f1f7"},{label:"Nederlands",settingCode:"nl",code:"nl",isoCode:"nl",codeMoment:"nl",unicode:"1F1F3-1F1F1"},{label:"Nynorsk",settingCode:"no",code:"no",isoCode:"no",codeMoment:"nn",unicode:"1F1F3-1F1F4"},{label:"Portugus do Brasil",settingCode:"pt-br",code:"pt-BR",isoCode:"pt-BR",codeMoment:"pt-br",unicode:"1F1E7-1F1F7"},{label:"Portugus",settingCode:"pt-pt",code:"pt-PT",isoCode:"pt-PT",codeMoment:"pt",unicode:"1F1F5-1F1F9"},{label:"Polski",settingCode:"pl",code:"pl",isoCode:"pl",codeMoment:"pl",unicode:"1F1F5-1F1F1"},{label:"P",settingCode:"ru",code:"ru",isoCode:"ru",codeMoment:"ru",unicode:"1F1F7 1F1FA"},{label:"Svenskt",settingCode:"sv-se",code:"sv-SE",isoCode:"sv-SE",codeMoment:"sv",unicode:"1F1F8-1F1EA"},{label:"Trke",settingCode:"tr",code:"tr",isoCode:"tr",codeMoment:"tr",unicode:"1f1f9-1f1f7"},{label:"",settingCode:"zh-cn",code:"zh-cn",isoCode:"zh-CN",codeMoment:"zh-cn",unicode:"1f1e8-1f1f3"},{label:"",settingCode:"zh-tw",code:"zh-TW",isoCode:"zh-TW",codeMoment:"zh-tw",unicode:"1F1F9-1F1FC"},{label:"",settingCode:"ar",code:"ar",isoCode:"ar",codeMoment:"ar",unicode:"060006FF"}],this.settings={init:!0,lang:"en",imSound:"true",imNotif:"true",displayOrder:"FL",nbMaxConversations:"100",microphone:"default",headsetMicrophone:null,speakerphoneMicrophone:null,customMicrophone:null,headsetDeviceName:null,speakerphoneDeviceName:null,speaker:"default",headsetSpeaker:null,speakerphoneSpeaker:null,customSpeaker:null,ringingSpeaker:"default",ringingSpeakerName:"",camera:"default",cameraUsed:"",audioProfile:"handfree",currentDevice:null,iceConfig:null,sdk:!1,userWiewOrderType:"lastname",userWiewFilterType:"all",autoStartAnimatedGif:"false",fixedLayout:"false",theme:"default",translationMsg:"false",newUI:"false",autoAcceptRoomInvite:"false",server:null,activeAlarm:"relax1",activeNotif:"stairs",devMode:"false",hasSecondRinger:"false",validationMode:"false",disableCalendarPresence:"false",deviceList:"[]",displayFilesType:"filesListCell--as-grid",displayRoomsAsGrid:"true",handFreeInputDeviceName:null,handFreeOutputDeviceName:null,customSpeakerName:null,customMicrophoneName:null,showBodyMessage:"false",bubblesFilterType:"all",bubblesOrderType:"lastActivityDate",webinarsFilterType:"all",webinarsOrderType:"lastActivityDate",displayWebinarsAsGrid:"false",protectionAgainstMailTypeOffline:!1,channelMarkdown:"false",chrisPrankMode:"true",joinSfuSound:"true",searchFilterValue:"NoFiltering",enableSingleSignOnWebAuthPopup:"false",enableSingleSignOnConfig:"false",enableUseFilePublicURL:"false",extension:"false",enableDSCP:!1,filterIce:!1,dtx:!1,simulcast:!1,debugWebRTC:!1,unifiedPlan:!1,sipWiseMode:"false",fontSize:"62.5%",lastInactiveBubbleShownDate:null,meetingsOrderType:"lastActivityDate",meetingsFilterType:"all",filesOrderBy:"date",filesFilterBy:"all",enterKeyAction:"enterSend",activeTalker:!1,forceConsoleLog:!1,sfuJoinBundle:!1,geoip:""},this.updateSubject=new rxjs_1.Subject}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.settingsService||(win.rainbow.settingsService=new SettingsService),win.rainbow.settingsService}configure(defaultLanguage=null){this.redirectVoIP="true"===localStorage.getItem("redirectVoIP"),this.languageCodes=this.languages.map(language=>language.settingCode);const localSettings=this.getLocalStorageSettings();if(localSettings.init)defaultLanguage&&(localSettings.lang=this.getMappedLanguage(defaultLanguage)),Object.keys(localSettings).forEach(key=>{null!==localSettings[key]&&(this.settings[key]=localSettings[key])});else{const browser=navigator,browserLanguage=browser.languages?browser.languages[0]:browser.language||browser.userLanguage,preferredLanguage=defaultLanguage||browserLanguage;this.settings.lang=this.getMappedLanguage(preferredLanguage),Object.keys(this.settings).forEach(key=>{localStorage.setItem(key,this.settings[key])})}this.sendUpdateEvent(event_model_1.RBEvent.create("SETTINGS_UPDATED"))}setSetting(key,value){this.settings[key]=value,localStorage.setItem(key,value)}getSetting(key){return this.settings[key]}getBooleanSetting(key){return"true"===this.settings[key]}sendUpdateEvent(event){this.updateSubject.next(event)}subscribeUpdateEvent(eventName,handler){return this.updateSubject.subscribe(event=>{event.name===eventName&&handler(event.data)})}getLocalStorageSettings(){const settings={};return Object.keys(this.settings).forEach(key=>{settings[key]=localStorage.getItem(key)}),settings.nbMaxConversations?parseInt(settings.nbMaxConversations,10)<15&&this.setSetting("nbMaxConversations","15"):settings.nbMaxConversations=this.settings.nbMaxConversations,"default"===settings.headsetMicrophone&&(settings.headsetMicrophone=null),"default"===settings.headsetSpeaker&&(settings.headsetSpeaker=null),"default"===settings.speakerphoneMicrophone&&(settings.speakerphoneMicrophone=null),"default"===settings.speakerphoneSpeaker&&(settings.speakerphoneSpeaker=null),"default"===settings.customMicrophone&&(settings.customMicrophone=null),"default"===settings.customSpeaker&&(settings.customSpeaker=null),settings}getRedirectVoIP(){return this.redirectVoIP}setRedirectVoIP(redirectVoIP){this.redirectVoIP=redirectVoIP,localStorage.setItem("redirectVoIP",redirectVoIP.toString())}isAutomaticHookOff(){return this.automaticHookOff}setAutomaticHookOff(isActivated){this.automaticHookOff=isActivated}getAutomaticHookOffTime(){return this.automaticHookOffTime}setAutomaticHookOffTime(milliseconds){this.automaticHookOffTime=milliseconds}setIceConfig(iceConfig){this.settings.iceConfig=iceConfig}getAvailableLanguages(){return this.languages}getAppliLanguage(){const language=this.languages.filter(lang=>lang.settingCode===this.settings.lang)[0];return language||this.defaultLanguage}getAppliLanguageCodeForServer(){const langArray=this.settings.lang.split("-");return 1===langArray.length?this.settings.lang:langArray[0]+"-"+langArray[1].toUpperCase()}setAppliLangageCodeFromServer(serverCode){const langArray=serverCode.split("-");let clientCode=langArray[0];clientCode&&(clientCode=clientCode.toLowerCase()),2===langArray.length&&(clientCode+="-"+langArray[1].toLowerCase()),clientCode=this.getMappedLanguage(clientCode),clientCode=this.languageCodes.indexOf(clientCode)>=0?clientCode:"en",this.setAppliLanguageCode(clientCode)}setAppliLanguageCode(lang,save=!1){save?this.setSetting("lang",lang):this.settings.lang=lang,this.sendUpdateEvent(event_model_1.RBEvent.create("LANGUAGE_UPDATED",lang))}getBestLanguageForIsoCode(isoCode){const language=this.getLanguageByIsoCode(isoCode);if(language)return language;if(-1!==isoCode.indexOf("-")){const isoLanguageWithoutCountry=isoCode.split("-")[0];return this.getLanguageByIsoCode(isoLanguageWithoutCountry)}return this.getLanguageByIsoCode("en")}getLanguageByIsoCode(isoCode){return this.languages.find(lang=>lang.isoCode===isoCode)}getMappedLanguage(codedLanguage){if(!codedLanguage)return"en";const codedLang=codedLanguage.toLowerCase();switch(codedLang.split("-")[0]){case"ar":return"ar";case"ca":return"ca";case"en":return"en";case"fr":return"fr";case"de":return"de";case"es":return"es-es";case"fi":return"fi";case"it":return"it";case"he":return"he";case"ja":return"ja";case"ko":return"ko";case"nl":return"nl";case"no":return"no";case"pt":return"pt-br"===codedLang?"pt-br":"pt-pt";case"pl":return"pl";case"ru":return"ru";case"sv":return"sv-se";case"tr":return"tr";case"zh":return["zh-cn","zh-tw"].indexOf(codedLang)>=0?codedLang:"zh-cn";default:return"en"}}}exports.SettingsService=SettingsService,exports.default=SettingsService.getInstance()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return __extends}));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};function __extends(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return Observable_Observable}));var canReportError=__webpack_require__(51),Subscriber=__webpack_require__(11),rxSubscriber=__webpack_require__(41),Observer=__webpack_require__(53);var observable=__webpack_require__(29),pipe=__webpack_require__(61),config=__webpack_require__(21),Observable_Observable=function(){function Observable(subscribe){this._isScalar=!1,subscribe&&(this._subscribe=subscribe)}return Observable.prototype.lift=function(operator){var observable=new Observable;return observable.source=this,observable.operator=operator,observable},Observable.prototype.subscribe=function(observerOrNext,error,complete){var operator=this.operator,sink=function(nextOrObserver,error,complete){if(nextOrObserver){if(nextOrObserver instanceof Subscriber.a)return nextOrObserver;if(nextOrObserver[rxSubscriber.a])return nextOrObserver[rxSubscriber.a]()}return nextOrObserver||error||complete?new Subscriber.a(nextOrObserver,error,complete):new Subscriber.a(Observer.a)}(observerOrNext,error,complete);if(operator?sink.add(operator.call(sink,this.source)):sink.add(this.source||config.a.useDeprecatedSynchronousErrorHandling&&!sink.syncErrorThrowable?this._subscribe(sink):this._trySubscribe(sink)),config.a.useDeprecatedSynchronousErrorHandling&&sink.syncErrorThrowable&&(sink.syncErrorThrowable=!1,sink.syncErrorThrown))throw sink.syncErrorValue;return sink},Observable.prototype._trySubscribe=function(sink){try{return this._subscribe(sink)}catch(err){config.a.useDeprecatedSynchronousErrorHandling&&(sink.syncErrorThrown=!0,sink.syncErrorValue=err),Object(canReportError.a)(sink)?sink.error(err):console.warn(err)}},Observable.prototype.forEach=function(next,promiseCtor){var _this=this;return new(promiseCtor=getPromiseCtor(promiseCtor))((function(resolve,reject){var subscription;subscription=_this.subscribe((function(value){try{next(value)}catch(err){reject(err),subscription&&subscription.unsubscribe()}}),reject,resolve)}))},Observable.prototype._subscribe=function(subscriber){var source=this.source;return source&&source.subscribe(subscriber)},Observable.prototype[observable.a]=function(){return this},Observable.prototype.pipe=function(){for(var operations=[],_i=0;_i<arguments.length;_i++)operations[_i]=arguments[_i];return 0===operations.length?this:Object(pipe.b)(operations)(this)},Observable.prototype.toPromise=function(promiseCtor){var _this=this;return new(promiseCtor=getPromiseCtor(promiseCtor))((function(resolve,reject){var value;_this.subscribe((function(x){return value=x}),(function(err){return reject(err)}),(function(){return resolve(value)}))}))},Observable.create=function(subscribe){return new Observable(subscribe)},Observable}();function getPromiseCtor(promiseCtor){if(promiseCtor||(promiseCtor=config.a.Promise||Promise),!promiseCtor)throw new Error("no Promise impl found");return promiseCtor}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProfileService=void 0;const auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),logger_service_1=__webpack_require__(15),rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24),offer_model_1=__webpack_require__(315),contact_service_1=__webpack_require__(1);class ProfileService{constructor(){this.FeaturesEnum={COMPANY_ADMIN_COUNT:"COMPANY_ADMIN_COUNT",COMPANY_LOGO_MODIFICATION:"COMPANY_LOGO_MODIFICATION",COMPANY_DOMAIN_NAME_MODIFICATION:"COMPANY_DOMAIN_NAME_MODIFICATION",COMPANY_DETAILS_MODIFICATION:"COMPANY_DETAILS_MODIFICATION",COMPANY_SINGLE_SIGN_ON_SAML:"COMPANY_SINGLE_SIGN_ON_SAML",COMPANY_SINGLE_SIGN_ON_OIDC:"COMPANY_SINGLE_SIGN_ON_OIDC",WEBRTC_FOR_MOBILE:"WEBRTC_FOR_MOBILE",BUBBLE_PARTICIPANT_COUNT:"BUBBLE_PARTICIPANT_COUNT",TELEPHONY_BASIC_CALL:"TELEPHONY_BASIC_CALL",TELEPHONY_SECOND_CALL:"TELEPHONY_SECOND_CALL",TELEPHONY_TRANSFER_CALL:"TELEPHONY_TRANSFER_CALL",TELEPHONY_CONFERENCE_CALL:"TELEPHONY_CONFERENCE_CALL",TELEPHONY_DEFLECT_CALL:"TELEPHONY_DEFLECT_CALL",TELEPHONY_PHONE_BOOK:"TELEPHONY_PHONE_BOOK",TELEPHONY_VOICE_MAIL:"TELEPHONY_VOICE_MAIL",TELEPHONY_CALL_FORWARD:"TELEPHONY_CALL_FORWARD",TELEPHONY_NOMADIC:"TELEPHONY_NOMADIC",CONFERENCE_PARTICIPANT_COUNT:"CONFERENCE_PARTICIPANT_COUNT",WEBRTC_CONFERENCE_ALLOWED:"WEBRTC_CONFERENCE_ALLOWED",WEBRTC_CONFERENCE_PARTICIPANT_COUNT:"WEBRTC_CONFERENCE_PARTICIPANT_COUNT",WEBRTC_PARTICIPANT_ALLOWED:"WEBRTC_PARTICIPANT_ALLOWED",CONFERENCE_ALLOWED:"CONFERENCE_ALLOWED",CONFERENCE_DIAL_OUT:"CONFERENCE_DIAL_OUT",CONFERENCE_RECORDING:"CONFERENCE_RECORDING",MSO365_CALENDAR_PRESENCE:"MSO365_CALENDAR_PRESENCE",MSO365_DIRECTORY_PROVISIONING:"MSO365_DIRECTORY_PROVISIONING",MSO365_DIRECTORY_SEARCH:"MSO365_DIRECTORY_SEARCH",MSO365_CONTACT_SEARCH:"MSO365_CONTACT_SEARCH",MS_OUTLOOK_PLUGIN:"MS_OUTLOOK_PLUGIN",MS_SKYPE_PLUGIN:"MS_SKYPE_PLUGIN",FILE_SHARING_QUOTA_GB:"FILE_SHARING_QUOTA_GB",GOOGLE_CALENDAR_PRESENCE:"GOOGLE_CALENDAR_PRESENCE",WEBRTC_P2P_RECORDING:"WEBRTC_P2P_RECORDING",BUBBLE_PROMOTE_MEMBER:"BUBBLE_PROMOTE_MEMBER",BUBBLE_GUESTS_ALLOWED:"BUBBLE_GUESTS_ALLOWED",BUBBLE_ACTIVE_SPEAKER:"BUBBLE_ACTIVE_SPEAKER",TELEPHONY_WEBRTC_GATEWAY:"TELEPHONY_WEBRTC_GATEWAY",TELEPHONY_WEBRTC_PSTN_CALLING:"TELEPHONY_WEBRTC_PSTN_CALLING",ANALYTICS_DASHBOARD_EC:"ANALYTICS_DASHBOARD_EC",ANALYTICS_DASHBOARD_BP:"ANALYTICS_DASHBOARD_BP",TELEPHONY_CALL_SUBJECT:"CALL_SUBJECT",CHANNEL_CREATE:"CHANNEL_CREATE",CHANNEL_CREATE_ADMIN_ROLE_BYPASS:"CHANNEL_CREATE_ADMIN_ROLE_BYPASS",CHANNEL_ACTIVATED:"CHANNEL_ACTIVATED",MANAGE_ANDROID_TV:"MANAGE_ANDROID_TV",USE_ANDROID_TV:"USE_ANDROID_TV",MASSPRO_USER_PROVISIONING_CSV:"MASSPRO_USER_PROVISIONING_CSV",SEARCH_BY_TAGS:"SEARCH_BY_TAGS",TELEPHONY_3DPARTY_ASSOC:"TELEPHONY_3DPARTY_ASSOC",WEBCLIENT_UI_2_0:"WEBCLIENT_UI_2_0",WEBRTC_UNIFIED_PLAN:"WEBRTC_UNIFIED_PLAN",WEBRTC_CONFERENCE_SIMULCAST:"WEBRTC_CONFERENCE_SIMULCAST",USE_CLOUD_PBX:"USE_CLOUD_PBX",USE_OXO_MANAGED_PBX:"USE_OXO_MANAGED_PBX",SOFTPHONE_MODE_ONLY:"SOFTPHONE_MODE_ONLY",GIVE_REQUEST_REMOTE_CONTROL:"GIVE_REQUEST_REMOTE_CONTROL",BUBBLE_MAX_LOAD_STARTUP:"BUBBLE_MAX_LOAD_STARTUP",BUBBLE_COUNT:"BUBBLE_COUNT",BUBBLE_MEETING_SCHEDULER:"BUBBLE_MEETING_SCHEDULER",BUBBLE_TALKING_TIME:"BUBBLE_TALKING_TIME",APP_PERMISSIONS:"APP_PERMISSIONS",FREE_UI_CUSTOMIZATION:"FREE_UI_CUSTOMIZATION",PREMIUM_UI_CUSTOMIZATION:"PREMIUM_UI_CUSTOMIZATION",TELEPHONY_MAKE_CALL_CTI_APP:"TELEPHONY_MAKE_CALL_CTI_APP",CLOUD_PBX_WELCOME:"CLOUD_PBX_WELCOME",BUBBLE_TAG_COUNT:"BUBBLE_TAG_COUNT",ALERT_NOTIFICATIONS_ALLOWED:"ALERT_NOTIFICATIONS_ALLOWED",BUBBLE_FOLDER_COUNT:"BUBBLE_FOLDER_COUNT"},this.started=!1,this.features={},this.profiles=[],this.mainOffers=[],this.thirdPartyApps=null,this.profileEventHandler=null,this.rxSubject=new rxjs_1.Subject,this.timer=null,this.contactService=contact_service_1.default}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.profileService||(win.rainbow.profileService=new ProfileService),win.rainbow.profileService}start(){return __awaiter(this,void 0,void 0,(function*(){try{logger_service_1.default.info(""),logger_service_1.default.info("[profileService] === STARTING ==="),this.attachHandlers(),yield this.getServerProfile(),this.started=!0,logger_service_1.default.info("[profileService] === STARTED ==="),this.rxSubject.next(event_model_1.RBEvent.create("ON_PROFILE_FEATURES_UPDATED"))}catch(error){throw logger_service_1.default.info("[profileService] === STARTING FAILURE === "+error.message),error}}))}stop(){return __awaiter(this,void 0,void 0,(function*(){logger_service_1.default.info("[profileService] === STOPPING ==="),this.detachHandlers(),this.started=!1,logger_service_1.default.info("[profileService] === STOPPED ===")}))}restart(){logger_service_1.default.info("[profileService] === RESTART ==="),this.attachHandlers(),this.onUserUpdateNeeded()}subscribe(handler){return this.rxSubject.subscribe(handler)}attachHandlers(){this.detachHandlers(),logger_service_1.default.info("[profileService] attachHandlers"),this.profileEventHandler=xmpp_service_1.default.addHandler(stanza=>this.onManagementMessageReceived(stanza),null,"message","management")}detachHandlers(){logger_service_1.default.info("[profileService] detachHandlers"),this.profileEventHandler&&(xmpp_service_1.default.deleteHandler(this.profileEventHandler),this.profileEventHandler=null)}onManagementMessageReceived(stanza){try{const userprofileElem=$(stanza).find("userprofile");if(logger_service_1.default.info("[profileService] onManagementMessageReceived  -- on userprofile management message received"),userprofileElem.length)switch(userprofileElem.attr("action")){case"create":case"update":case"delete":this.onUserUpdateNeeded();break;default:logger_service_1.default.info("[profileService] onManagementMessageReceived  -- unknown action")}return!0}catch(error){return logger_service_1.default.error("[profileService] onManagementMessageReceived ERROR "+error),!0}}onUserUpdateNeeded(){this.timer||(this.timer=setTimeout(()=>__awaiter(this,void 0,void 0,(function*(){try{this.getServerProfile(),this.rxSubject.next(event_model_1.RBEvent.create("ON_PROFILE_FEATURES_UPDATED")),this.timer=null}catch(error){this.timer=null,logger_service_1.default.info("[profileService] === onUserUpdateNeeded FAILURE === "+error.message)}})),3e3))}getServerProfile(){return Promise.all([this.getServerProfiles(),this.getServerProfilesFeatures()])}getServerProfiles(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/profiles`,headers=auth_service_1.default.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();this.profiles=[],this.mainOffers=[],responseData.data.forEach(profileData=>{logger_service_1.default.debug("[profileService] getServerProfiles === response === "+profileData),this.profiles.push(profileData);const offer=offer_model_1.Offer.createFromProfileData(profileData);(offer.isExclusive||offer.isDefault)&&this.mainOffers.push(offer)}),this.mainOffers.sort(offer_model_1.Offer.offerComparator)}catch(error){let errorMessage="getServerProfiles failure: no server response";throw error&&(errorMessage="getServerProfiles failure: "+JSON.stringify(error)),logger_service_1.default.error("[profileService] "+errorMessage),new Error(errorMessage)}}))}getServerProfilesFeatures(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/profiles/features`,headers=auth_service_1.default.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();this.features={},responseData.data.forEach(featureData=>{logger_service_1.default.debug("[profileService] getServerProfilesFeatures === response === "+JSON.stringify(featureData)),featureData.hasOwnProperty("featureUniqueRef")&&(this.features[featureData.featureUniqueRef]=featureData)})}catch(error){let errorMessage="getServerProfilesFeatures failure: no server response";throw error&&(errorMessage="getServerProfilesFeatures failure: "+JSON.stringify(error)),logger_service_1.default.error("[profileService] "+errorMessage),new Error(errorMessage)}}))}isFeatureEnabled(featureUniqueRef,features=null){return features||(features=this.features),!(!config.urgencyNotifReceptionForced||"ALERT_NOTIFICATIONS_ALLOWED"!==featureUniqueRef)||(this.started&&features.hasOwnProperty(featureUniqueRef)&&features[featureUniqueRef].hasOwnProperty("featureType")&&"boolean"===features[featureUniqueRef].featureType&&features[featureUniqueRef].hasOwnProperty("isEnabled")?features[featureUniqueRef].isEnabled:(logger_service_1.default.info("[profileService] isFeatureEnabled("+featureUniqueRef+"): service not started or feature not enabled"),!1))}getFeatureLimitMax(featureUniqueRef){if(this.started&&this.features.hasOwnProperty(featureUniqueRef)&&this.features[featureUniqueRef].hasOwnProperty("featureType")&&"number"===this.features[featureUniqueRef].featureType&&this.features[featureUniqueRef].hasOwnProperty("limitMax")){const limitMax=this.features[featureUniqueRef].limitMax;return logger_service_1.default.debug("[profileService] getFeatureLimitMax("+featureUniqueRef+"): "+limitMax),limitMax}return logger_service_1.default.info("[profileService] getFeatureLimitMax("+featureUniqueRef+"): service not started or feature not enabled"),0}getFeatureLimitMin(featureUniqueRef){if(this.started&&this.features.hasOwnProperty(featureUniqueRef)&&this.features[featureUniqueRef].hasOwnProperty("featureType")&&"number"===this.features[featureUniqueRef].featureType&&this.features[featureUniqueRef].hasOwnProperty("limitMin")){const limitMin=this.features[featureUniqueRef].limitMin;return logger_service_1.default.debug("[profileService] getFeatureLimitMin("+featureUniqueRef+"): "+limitMin),limitMin}return logger_service_1.default.info("[profileService] getFeatureLimitMin("+featureUniqueRef+"): service not started or feature not enabled"),0}getMyProfileOffer(){return this.mainOffers.length>0?this.mainOffers.slice(-1)[0]:null}getMyProfileName(){const profile=this.getMyProfileOffer();return profile?profile.name:null}getMyProfiles(){let profiles=[];return this.started?profiles=this.profiles:logger_service_1.default.warn("[profileService] getMyProfiles(): service not started"),profiles}getMyProfileFeatures(){const profileFeatures={};return this.started?Object.keys(this.features).forEach(featureUniqueRef=>{const originalFeature=this.features[featureUniqueRef],feature={};Object.keys(originalFeature).filter(featureProperty=>"featureUniqueRef"===featureProperty||"featureType"===featureProperty||"limitMin"===featureProperty||"limitMax"===featureProperty||"isEnabled"===featureProperty).forEach(featureProperty=>{feature[featureProperty]=originalFeature[featureProperty]}),profileFeatures[featureUniqueRef]=feature}):logger_service_1.default.warn("[profileService] getMyProfileFeatures(): service not started"),profileFeatures}getThirdPartyApps(force=!1){return __awaiter(this,void 0,void 0,(function*(){try{if(null!==this.thirdPartyApps&&!force)return logger_service_1.default.info("[profileService] getThirdPartyApps -- from cache"),this.thirdPartyApps;const url=config.restServerUrl+"/api/rainbow/authentication/v1.0/oauth/tokens?format=medium",headers=auth_service_1.default.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();return logger_service_1.default.info("[profileService] getThirdPartyApps from server -- success"),this.thirdPartyApps=responseData&&responseData.data?responseData.data:[],this.thirdPartyApps}catch(error){let errorMessage="getThirdPartyApps from server failed -- no answer from server";throw error&&(errorMessage="getThirdPartyApps from server failed -- "+JSON.stringify(error)),logger_service_1.default.error("[profileService] "+errorMessage),new Error(errorMessage)}}))}revokeThirdPartyAccess(tokenId){return __awaiter(this,void 0,void 0,(function*(){try{if(!tokenId)throw logger_service_1.default.warn("[profileService] revokeThirdPartyAccess missing token"),new Error("No tokenId");logger_service_1.default.info("[profileService] revokeThirdPartyAccess with token -- "+tokenId);const url=`${config.restServerUrl}/api/rainbow/authentication/v1.0/oauth/tokens/${tokenId}`,headers=auth_service_1.default.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();return logger_service_1.default.info("[profileService] revokeThirdPartyAccess -- success"),this.thirdPartyApps=responseData&&responseData.data?responseData.data:[],this.thirdPartyApps.forEach((app,index)=>{app.id===tokenId&&this.thirdPartyApps.splice(index,1)}),this.thirdPartyApps}catch(error){let errorMessage="revokeThirdPartyAccess from server failed -- no answer from server";throw error&&(errorMessage="revokeThirdPartyAccess from server failed -- "+JSON.stringify(error)),logger_service_1.default.error("[profileService] "+errorMessage),new Error(errorMessage)}}))}getProfilesByName(name){return this.profiles.filter(profile=>-1!==profile.profileName.toLowerCase().indexOf(name))}setUserData(params){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${contact_service_1.default.userContact.dbId}`,headers=auth_service_1.default.getPostHeader(),body=JSON.stringify(params),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const responseData=yield response.json();return logger_service_1.default.info(`[profileService] setUserData ${body} -- success`),responseData}catch(error){let errorMessage="setUserData failure: no server response";throw error&&(errorMessage="setUserData failure: "+JSON.stringify(error)),logger_service_1.default.error("[profileService] "+errorMessage),new Error(errorMessage)}}))}}exports.ProfileService=ProfileService,exports.default=ProfileService.getInstance()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.rainbowLogger=void 0;const sdkConfig_1=__webpack_require__(38);const rainbowLogger=new class{constructor(){}sdk(message){if(sdkConfig_1.sdkConfig.verboseLog){const date=(new Date).toUTCString();message=message||"",console.log("%c"+date+" | Rainbow Web SDK  | "+message,"color:green")}}webrtc(message){if(sdkConfig_1.sdkConfig.verboseLog){const date=(new Date).toUTCString();console.log("%c"+date+" | RTCWEB | "+message,"color:green")}}info(message){if(sdkConfig_1.sdkConfig.verboseLog){const date=(new Date).toUTCString();console.info("%c"+date+" | Rainbow Web SDK  | "+message,"color:green")}}error(message){if(sdkConfig_1.sdkConfig.verboseLog){const date=(new Date).toUTCString();console.error("%c"+date+" | Rainbow Web SDK  | "+message,"color:green")}}debug(message){if(sdkConfig_1.sdkConfig.verboseLog){const date=(new Date).toUTCString();console.debug("%c"+date+" | Rainbow Web SDK  | "+message,"color:green")}}time(timerName){sdkConfig_1.sdkConfig.measurePerformance&&console.time(timerName)}timeLog(timerName){sdkConfig_1.sdkConfig.measurePerformance&&console.timeLog(timerName)}timeEnd(timerName){sdkConfig_1.sdkConfig.measurePerformance&&console.timeEnd(timerName)}};exports.rainbowLogger=rainbowLogger},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Observable",(function(){return Observable.a})),__webpack_require__.d(__webpack_exports__,"ConnectableObservable",(function(){return ConnectableObservable_ConnectableObservable})),__webpack_require__.d(__webpack_exports__,"GroupedObservable",(function(){return groupBy_GroupedObservable})),__webpack_require__.d(__webpack_exports__,"observable",(function(){return symbol_observable.a})),__webpack_require__.d(__webpack_exports__,"Subject",(function(){return Subject.a})),__webpack_require__.d(__webpack_exports__,"BehaviorSubject",(function(){return BehaviorSubject.a})),__webpack_require__.d(__webpack_exports__,"ReplaySubject",(function(){return ReplaySubject_ReplaySubject})),__webpack_require__.d(__webpack_exports__,"AsyncSubject",(function(){return AsyncSubject_AsyncSubject})),__webpack_require__.d(__webpack_exports__,"asap",(function(){return asap})),__webpack_require__.d(__webpack_exports__,"asapScheduler",(function(){return asapScheduler})),__webpack_require__.d(__webpack_exports__,"async",(function(){return async_async})),__webpack_require__.d(__webpack_exports__,"asyncScheduler",(function(){return asyncScheduler})),__webpack_require__.d(__webpack_exports__,"queue",(function(){return queue})),__webpack_require__.d(__webpack_exports__,"queueScheduler",(function(){return queueScheduler})),__webpack_require__.d(__webpack_exports__,"animationFrame",(function(){return animationFrame})),__webpack_require__.d(__webpack_exports__,"animationFrameScheduler",(function(){return animationFrameScheduler})),__webpack_require__.d(__webpack_exports__,"VirtualTimeScheduler",(function(){return VirtualTimeScheduler_VirtualTimeScheduler})),__webpack_require__.d(__webpack_exports__,"VirtualAction",(function(){return VirtualTimeScheduler_VirtualAction})),__webpack_require__.d(__webpack_exports__,"Scheduler",(function(){return Scheduler})),__webpack_require__.d(__webpack_exports__,"Subscription",(function(){return Subscription.a})),__webpack_require__.d(__webpack_exports__,"Subscriber",(function(){return Subscriber.a})),__webpack_require__.d(__webpack_exports__,"Notification",(function(){return Notification_Notification})),__webpack_require__.d(__webpack_exports__,"NotificationKind",(function(){return NotificationKind})),__webpack_require__.d(__webpack_exports__,"pipe",(function(){return pipe.a})),__webpack_require__.d(__webpack_exports__,"noop",(function(){return noop})),__webpack_require__.d(__webpack_exports__,"identity",(function(){return identity.a})),__webpack_require__.d(__webpack_exports__,"isObservable",(function(){return isObservable})),__webpack_require__.d(__webpack_exports__,"ArgumentOutOfRangeError",(function(){return ArgumentOutOfRangeError})),__webpack_require__.d(__webpack_exports__,"EmptyError",(function(){return EmptyError})),__webpack_require__.d(__webpack_exports__,"ObjectUnsubscribedError",(function(){return ObjectUnsubscribedError.a})),__webpack_require__.d(__webpack_exports__,"UnsubscriptionError",(function(){return UnsubscriptionError.a})),__webpack_require__.d(__webpack_exports__,"TimeoutError",(function(){return TimeoutError})),__webpack_require__.d(__webpack_exports__,"bindCallback",(function(){return bindCallback})),__webpack_require__.d(__webpack_exports__,"bindNodeCallback",(function(){return bindNodeCallback})),__webpack_require__.d(__webpack_exports__,"combineLatest",(function(){return combineLatest})),__webpack_require__.d(__webpack_exports__,"concat",(function(){return concat})),__webpack_require__.d(__webpack_exports__,"defer",(function(){return defer})),__webpack_require__.d(__webpack_exports__,"empty",(function(){return empty})),__webpack_require__.d(__webpack_exports__,"forkJoin",(function(){return forkJoin})),__webpack_require__.d(__webpack_exports__,"from",(function(){return from})),__webpack_require__.d(__webpack_exports__,"fromEvent",(function(){return fromEvent})),__webpack_require__.d(__webpack_exports__,"fromEventPattern",(function(){return fromEventPattern})),__webpack_require__.d(__webpack_exports__,"generate",(function(){return generate})),__webpack_require__.d(__webpack_exports__,"iif",(function(){return iif})),__webpack_require__.d(__webpack_exports__,"interval",(function(){return interval})),__webpack_require__.d(__webpack_exports__,"merge",(function(){return merge})),__webpack_require__.d(__webpack_exports__,"never",(function(){return never})),__webpack_require__.d(__webpack_exports__,"of",(function(){return of})),__webpack_require__.d(__webpack_exports__,"onErrorResumeNext",(function(){return onErrorResumeNext})),__webpack_require__.d(__webpack_exports__,"pairs",(function(){return pairs})),__webpack_require__.d(__webpack_exports__,"partition",(function(){return partition})),__webpack_require__.d(__webpack_exports__,"race",(function(){return race})),__webpack_require__.d(__webpack_exports__,"range",(function(){return range})),__webpack_require__.d(__webpack_exports__,"throwError",(function(){return throwError})),__webpack_require__.d(__webpack_exports__,"timer",(function(){return timer})),__webpack_require__.d(__webpack_exports__,"using",(function(){return using})),__webpack_require__.d(__webpack_exports__,"zip",(function(){return zip})),__webpack_require__.d(__webpack_exports__,"scheduled",(function(){return scheduled})),__webpack_require__.d(__webpack_exports__,"EMPTY",(function(){return EMPTY})),__webpack_require__.d(__webpack_exports__,"NEVER",(function(){return NEVER})),__webpack_require__.d(__webpack_exports__,"config",(function(){return config.a}));var Observable=__webpack_require__(7),tslib_es6=__webpack_require__(6),Subject=__webpack_require__(23),Subscriber=__webpack_require__(11),Subscription=__webpack_require__(13);var RefCountOperator=function(){function RefCountOperator(connectable){this.connectable=connectable}return RefCountOperator.prototype.call=function(subscriber,source){var connectable=this.connectable;connectable._refCount++;var refCounter=new refCount_RefCountSubscriber(subscriber,connectable),subscription=source.subscribe(refCounter);return refCounter.closed||(refCounter.connection=connectable.connect()),subscription},RefCountOperator}(),refCount_RefCountSubscriber=function(_super){function RefCountSubscriber(destination,connectable){var _this=_super.call(this,destination)||this;return _this.connectable=connectable,_this}return tslib_es6.a(RefCountSubscriber,_super),RefCountSubscriber.prototype._unsubscribe=function(){var connectable=this.connectable;if(connectable){this.connectable=null;var refCount=connectable._refCount;if(refCount<=0)this.connection=null;else if(connectable._refCount=refCount-1,refCount>1)this.connection=null;else{var connection=this.connection,sharedConnection=connectable._connection;this.connection=null,!sharedConnection||connection&&sharedConnection!==connection||sharedConnection.unsubscribe()}}else this.connection=null},RefCountSubscriber}(Subscriber.a),ConnectableObservable_ConnectableObservable=function(_super){function ConnectableObservable(source,subjectFactory){var _this=_super.call(this)||this;return _this.source=source,_this.subjectFactory=subjectFactory,_this._refCount=0,_this._isComplete=!1,_this}return tslib_es6.a(ConnectableObservable,_super),ConnectableObservable.prototype._subscribe=function(subscriber){return this.getSubject().subscribe(subscriber)},ConnectableObservable.prototype.getSubject=function(){var subject=this._subject;return subject&&!subject.isStopped||(this._subject=this.subjectFactory()),this._subject},ConnectableObservable.prototype.connect=function(){var connection=this._connection;return connection||(this._isComplete=!1,(connection=this._connection=new Subscription.a).add(this.source.subscribe(new ConnectableObservable_ConnectableSubscriber(this.getSubject(),this))),connection.closed&&(this._connection=null,connection=Subscription.a.EMPTY)),connection},ConnectableObservable.prototype.refCount=function(){return(source=this).lift(new RefCountOperator(source));var source},ConnectableObservable}(Observable.a),ConnectableObservable_ConnectableSubscriber=function(_super){function ConnectableSubscriber(destination,connectable){var _this=_super.call(this,destination)||this;return _this.connectable=connectable,_this}return tslib_es6.a(ConnectableSubscriber,_super),ConnectableSubscriber.prototype._error=function(err){this._unsubscribe(),_super.prototype._error.call(this,err)},ConnectableSubscriber.prototype._complete=function(){this.connectable._isComplete=!0,this._unsubscribe(),_super.prototype._complete.call(this)},ConnectableSubscriber.prototype._unsubscribe=function(){var connectable=this.connectable;if(connectable){this.connectable=null;var connection=connectable._connection;connectable._refCount=0,connectable._subject=null,connectable._connection=null,connection&&connection.unsubscribe()}},ConnectableSubscriber}(Subject.b);Subscriber.a;Subscriber.a;var groupBy_GroupDurationSubscriber=function(_super){function GroupDurationSubscriber(key,group,parent){var _this=_super.call(this,group)||this;return _this.key=key,_this.group=group,_this.parent=parent,_this}return tslib_es6.a(GroupDurationSubscriber,_super),GroupDurationSubscriber.prototype._next=function(value){this.complete()},GroupDurationSubscriber.prototype._unsubscribe=function(){var parent=this.parent,key=this.key;this.key=this.parent=null,parent&&parent.removeGroup(key)},GroupDurationSubscriber}(Subscriber.a),groupBy_GroupedObservable=function(_super){function GroupedObservable(key,groupSubject,refCountSubscription){var _this=_super.call(this)||this;return _this.key=key,_this.groupSubject=groupSubject,_this.refCountSubscription=refCountSubscription,_this}return tslib_es6.a(GroupedObservable,_super),GroupedObservable.prototype._subscribe=function(subscriber){var subscription=new Subscription.a,refCountSubscription=this.refCountSubscription,groupSubject=this.groupSubject;return refCountSubscription&&!refCountSubscription.closed&&subscription.add(new groupBy_InnerRefCountSubscription(refCountSubscription)),subscription.add(groupSubject.subscribe(subscriber)),subscription},GroupedObservable}(Observable.a),groupBy_InnerRefCountSubscription=function(_super){function InnerRefCountSubscription(parent){var _this=_super.call(this)||this;return _this.parent=parent,parent.count++,_this}return tslib_es6.a(InnerRefCountSubscription,_super),InnerRefCountSubscription.prototype.unsubscribe=function(){var parent=this.parent;parent.closed||this.closed||(_super.prototype.unsubscribe.call(this),parent.count-=1,0===parent.count&&parent.attemptedToUnsubscribe&&parent.unsubscribe())},InnerRefCountSubscription}(Subscription.a),symbol_observable=__webpack_require__(29),BehaviorSubject=__webpack_require__(77),AsyncAction_AsyncAction=function(_super){function AsyncAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this.pending=!1,_this}return tslib_es6.a(AsyncAction,_super),AsyncAction.prototype.schedule=function(state,delay){if(void 0===delay&&(delay=0),this.closed)return this;this.state=state;var id=this.id,scheduler=this.scheduler;return null!=id&&(this.id=this.recycleAsyncId(scheduler,id,delay)),this.pending=!0,this.delay=delay,this.id=this.id||this.requestAsyncId(scheduler,this.id,delay),this},AsyncAction.prototype.requestAsyncId=function(scheduler,id,delay){return void 0===delay&&(delay=0),setInterval(scheduler.flush.bind(scheduler,this),delay)},AsyncAction.prototype.recycleAsyncId=function(scheduler,id,delay){if(void 0===delay&&(delay=0),null!==delay&&this.delay===delay&&!1===this.pending)return id;clearInterval(id)},AsyncAction.prototype.execute=function(state,delay){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var error=this._execute(state,delay);if(error)return error;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},AsyncAction.prototype._execute=function(state,delay){var errored=!1,errorValue=void 0;try{this.work(state)}catch(e){errored=!0,errorValue=!!e&&e||new Error(e)}if(errored)return this.unsubscribe(),errorValue},AsyncAction.prototype._unsubscribe=function(){var id=this.id,scheduler=this.scheduler,actions=scheduler.actions,index=actions.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==index&&actions.splice(index,1),null!=id&&(this.id=this.recycleAsyncId(scheduler,id,null)),this.delay=null},AsyncAction}(function(_super){function Action(scheduler,work){return _super.call(this)||this}return tslib_es6.a(Action,_super),Action.prototype.schedule=function(state,delay){return void 0===delay&&(delay=0),this},Action}(Subscription.a)),QueueAction_QueueAction=function(_super){function QueueAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this}return tslib_es6.a(QueueAction,_super),QueueAction.prototype.schedule=function(state,delay){return void 0===delay&&(delay=0),delay>0?_super.prototype.schedule.call(this,state,delay):(this.delay=delay,this.state=state,this.scheduler.flush(this),this)},QueueAction.prototype.execute=function(state,delay){return delay>0||this.closed?_super.prototype.execute.call(this,state,delay):this._execute(state,delay)},QueueAction.prototype.requestAsyncId=function(scheduler,id,delay){return void 0===delay&&(delay=0),null!==delay&&delay>0||null===delay&&this.delay>0?_super.prototype.requestAsyncId.call(this,scheduler,id,delay):scheduler.flush(this)},QueueAction}(AsyncAction_AsyncAction),Scheduler=function(){function Scheduler(SchedulerAction,now){void 0===now&&(now=Scheduler.now),this.SchedulerAction=SchedulerAction,this.now=now}return Scheduler.prototype.schedule=function(work,delay,state){return void 0===delay&&(delay=0),new this.SchedulerAction(this,work).schedule(state,delay)},Scheduler.now=function(){return Date.now()},Scheduler}(),AsyncScheduler_AsyncScheduler=function(_super){function AsyncScheduler(SchedulerAction,now){void 0===now&&(now=Scheduler.now);var _this=_super.call(this,SchedulerAction,(function(){return AsyncScheduler.delegate&&AsyncScheduler.delegate!==_this?AsyncScheduler.delegate.now():now()}))||this;return _this.actions=[],_this.active=!1,_this.scheduled=void 0,_this}return tslib_es6.a(AsyncScheduler,_super),AsyncScheduler.prototype.schedule=function(work,delay,state){return void 0===delay&&(delay=0),AsyncScheduler.delegate&&AsyncScheduler.delegate!==this?AsyncScheduler.delegate.schedule(work,delay,state):_super.prototype.schedule.call(this,work,delay,state)},AsyncScheduler.prototype.flush=function(action){var actions=this.actions;if(this.active)actions.push(action);else{var error;this.active=!0;do{if(error=action.execute(action.state,action.delay))break}while(action=actions.shift());if(this.active=!1,error){for(;action=actions.shift();)action.unsubscribe();throw error}}},AsyncScheduler}(Scheduler),queueScheduler=new(function(_super){function QueueScheduler(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_es6.a(QueueScheduler,_super),QueueScheduler}(AsyncScheduler_AsyncScheduler))(QueueAction_QueueAction),queue=queueScheduler,EMPTY=new Observable.a((function(subscriber){return subscriber.complete()}));function empty(scheduler){return scheduler?function(scheduler){return new Observable.a((function(subscriber){return scheduler.schedule((function(){return subscriber.complete()}))}))}(scheduler):EMPTY}function isScheduler(value){return value&&"function"==typeof value.schedule}var NotificationKind,subscribeToArray=function(array){return function(subscriber){for(var i=0,len=array.length;i<len&&!subscriber.closed;i++)subscriber.next(array[i]);subscriber.complete()}};function scheduleArray(input,scheduler){return new Observable.a((function(subscriber){var sub=new Subscription.a,i=0;return sub.add(scheduler.schedule((function(){i!==input.length?(subscriber.next(input[i++]),subscriber.closed||sub.add(this.schedule())):subscriber.complete()}))),sub}))}function fromArray(input,scheduler){return scheduler?scheduleArray(input,scheduler):new Observable.a(subscribeToArray(input))}function of(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var scheduler=args[args.length-1];return isScheduler(scheduler)?(args.pop(),scheduleArray(args,scheduler)):fromArray(args)}function throwError(error,scheduler){return scheduler?new Observable.a((function(subscriber){return scheduler.schedule(dispatch,0,{error:error,subscriber:subscriber})})):new Observable.a((function(subscriber){return subscriber.error(error)}))}function dispatch(_a){var error=_a.error;_a.subscriber.error(error)}NotificationKind||(NotificationKind={});var Notification_Notification=function(){function Notification(kind,value,error){this.kind=kind,this.value=value,this.error=error,this.hasValue="N"===kind}return Notification.prototype.observe=function(observer){switch(this.kind){case"N":return observer.next&&observer.next(this.value);case"E":return observer.error&&observer.error(this.error);case"C":return observer.complete&&observer.complete()}},Notification.prototype.do=function(next,error,complete){switch(this.kind){case"N":return next&&next(this.value);case"E":return error&&error(this.error);case"C":return complete&&complete()}},Notification.prototype.accept=function(nextOrObserver,error,complete){return nextOrObserver&&"function"==typeof nextOrObserver.next?this.observe(nextOrObserver):this.do(nextOrObserver,error,complete)},Notification.prototype.toObservable=function(){switch(this.kind){case"N":return of(this.value);case"E":return throwError(this.error);case"C":return empty()}throw new Error("unexpected notification kind value")},Notification.createNext=function(value){return void 0!==value?new Notification("N",value):Notification.undefinedValueNotification},Notification.createError=function(err){return new Notification("E",void 0,err)},Notification.createComplete=function(){return Notification.completeNotification},Notification.completeNotification=new Notification("C"),Notification.undefinedValueNotification=new Notification("N",void 0),Notification}();var observeOn_ObserveOnSubscriber=function(_super){function ObserveOnSubscriber(destination,scheduler,delay){void 0===delay&&(delay=0);var _this=_super.call(this,destination)||this;return _this.scheduler=scheduler,_this.delay=delay,_this}return tslib_es6.a(ObserveOnSubscriber,_super),ObserveOnSubscriber.dispatch=function(arg){var notification=arg.notification,destination=arg.destination;notification.observe(destination),this.unsubscribe()},ObserveOnSubscriber.prototype.scheduleMessage=function(notification){this.destination.add(this.scheduler.schedule(ObserveOnSubscriber.dispatch,this.delay,new ObserveOnMessage(notification,this.destination)))},ObserveOnSubscriber.prototype._next=function(value){this.scheduleMessage(Notification_Notification.createNext(value))},ObserveOnSubscriber.prototype._error=function(err){this.scheduleMessage(Notification_Notification.createError(err)),this.unsubscribe()},ObserveOnSubscriber.prototype._complete=function(){this.scheduleMessage(Notification_Notification.createComplete()),this.unsubscribe()},ObserveOnSubscriber}(Subscriber.a),ObserveOnMessage=function(){return function(notification,destination){this.notification=notification,this.destination=destination}}(),ObjectUnsubscribedError=__webpack_require__(30),SubjectSubscription=__webpack_require__(62),ReplaySubject_ReplaySubject=function(_super){function ReplaySubject(bufferSize,windowTime,scheduler){void 0===bufferSize&&(bufferSize=Number.POSITIVE_INFINITY),void 0===windowTime&&(windowTime=Number.POSITIVE_INFINITY);var _this=_super.call(this)||this;return _this.scheduler=scheduler,_this._events=[],_this._infiniteTimeWindow=!1,_this._bufferSize=bufferSize<1?1:bufferSize,_this._windowTime=windowTime<1?1:windowTime,windowTime===Number.POSITIVE_INFINITY?(_this._infiniteTimeWindow=!0,_this.next=_this.nextInfiniteTimeWindow):_this.next=_this.nextTimeWindow,_this}return tslib_es6.a(ReplaySubject,_super),ReplaySubject.prototype.nextInfiniteTimeWindow=function(value){if(!this.isStopped){var _events=this._events;_events.push(value),_events.length>this._bufferSize&&_events.shift()}_super.prototype.next.call(this,value)},ReplaySubject.prototype.nextTimeWindow=function(value){this.isStopped||(this._events.push(new ReplayEvent(this._getNow(),value)),this._trimBufferThenGetEvents()),_super.prototype.next.call(this,value)},ReplaySubject.prototype._subscribe=function(subscriber){var subscription,_infiniteTimeWindow=this._infiniteTimeWindow,_events=_infiniteTimeWindow?this._events:this._trimBufferThenGetEvents(),scheduler=this.scheduler,len=_events.length;if(this.closed)throw new ObjectUnsubscribedError.a;if(this.isStopped||this.hasError?subscription=Subscription.a.EMPTY:(this.observers.push(subscriber),subscription=new SubjectSubscription.a(this,subscriber)),scheduler&&subscriber.add(subscriber=new observeOn_ObserveOnSubscriber(subscriber,scheduler)),_infiniteTimeWindow)for(var i=0;i<len&&!subscriber.closed;i++)subscriber.next(_events[i]);else for(i=0;i<len&&!subscriber.closed;i++)subscriber.next(_events[i].value);return this.hasError?subscriber.error(this.thrownError):this.isStopped&&subscriber.complete(),subscription},ReplaySubject.prototype._getNow=function(){return(this.scheduler||queue).now()},ReplaySubject.prototype._trimBufferThenGetEvents=function(){for(var now=this._getNow(),_bufferSize=this._bufferSize,_windowTime=this._windowTime,_events=this._events,eventsCount=_events.length,spliceCount=0;spliceCount<eventsCount&&!(now-_events[spliceCount].time<_windowTime);)spliceCount++;return eventsCount>_bufferSize&&(spliceCount=Math.max(spliceCount,eventsCount-_bufferSize)),spliceCount>0&&_events.splice(0,spliceCount),_events},ReplaySubject}(Subject.a),ReplayEvent=function(){return function(time,value){this.time=time,this.value=value}}(),AsyncSubject_AsyncSubject=function(_super){function AsyncSubject(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.value=null,_this.hasNext=!1,_this.hasCompleted=!1,_this}return tslib_es6.a(AsyncSubject,_super),AsyncSubject.prototype._subscribe=function(subscriber){return this.hasError?(subscriber.error(this.thrownError),Subscription.a.EMPTY):this.hasCompleted&&this.hasNext?(subscriber.next(this.value),subscriber.complete(),Subscription.a.EMPTY):_super.prototype._subscribe.call(this,subscriber)},AsyncSubject.prototype.next=function(value){this.hasCompleted||(this.value=value,this.hasNext=!0)},AsyncSubject.prototype.error=function(error){this.hasCompleted||_super.prototype.error.call(this,error)},AsyncSubject.prototype.complete=function(){this.hasCompleted=!0,this.hasNext&&_super.prototype.next.call(this,this.value),_super.prototype.complete.call(this)},AsyncSubject}(Subject.a),nextHandle=1,RESOLVED=function(){return Promise.resolve()}(),activeHandles={};function findAndClearHandle(handle){return handle in activeHandles&&(delete activeHandles[handle],!0)}var Immediate_setImmediate=function(cb){var handle=nextHandle++;return activeHandles[handle]=!0,RESOLVED.then((function(){return findAndClearHandle(handle)&&cb()})),handle},Immediate_clearImmediate=function(handle){findAndClearHandle(handle)},AsapAction_AsapAction=function(_super){function AsapAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this}return tslib_es6.a(AsapAction,_super),AsapAction.prototype.requestAsyncId=function(scheduler,id,delay){return void 0===delay&&(delay=0),null!==delay&&delay>0?_super.prototype.requestAsyncId.call(this,scheduler,id,delay):(scheduler.actions.push(this),scheduler.scheduled||(scheduler.scheduled=Immediate_setImmediate(scheduler.flush.bind(scheduler,null))))},AsapAction.prototype.recycleAsyncId=function(scheduler,id,delay){if(void 0===delay&&(delay=0),null!==delay&&delay>0||null===delay&&this.delay>0)return _super.prototype.recycleAsyncId.call(this,scheduler,id,delay);0===scheduler.actions.length&&(Immediate_clearImmediate(id),scheduler.scheduled=void 0)},AsapAction}(AsyncAction_AsyncAction),asapScheduler=new(function(_super){function AsapScheduler(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_es6.a(AsapScheduler,_super),AsapScheduler.prototype.flush=function(action){this.active=!0,this.scheduled=void 0;var error,actions=this.actions,index=-1,count=actions.length;action=action||actions.shift();do{if(error=action.execute(action.state,action.delay))break}while(++index<count&&(action=actions.shift()));if(this.active=!1,error){for(;++index<count&&(action=actions.shift());)action.unsubscribe();throw error}},AsapScheduler}(AsyncScheduler_AsyncScheduler))(AsapAction_AsapAction),asap=asapScheduler,asyncScheduler=new AsyncScheduler_AsyncScheduler(AsyncAction_AsyncAction),async_async=asyncScheduler,AnimationFrameAction_AnimationFrameAction=function(_super){function AnimationFrameAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this}return tslib_es6.a(AnimationFrameAction,_super),AnimationFrameAction.prototype.requestAsyncId=function(scheduler,id,delay){return void 0===delay&&(delay=0),null!==delay&&delay>0?_super.prototype.requestAsyncId.call(this,scheduler,id,delay):(scheduler.actions.push(this),scheduler.scheduled||(scheduler.scheduled=requestAnimationFrame((function(){return scheduler.flush(null)}))))},AnimationFrameAction.prototype.recycleAsyncId=function(scheduler,id,delay){if(void 0===delay&&(delay=0),null!==delay&&delay>0||null===delay&&this.delay>0)return _super.prototype.recycleAsyncId.call(this,scheduler,id,delay);0===scheduler.actions.length&&(cancelAnimationFrame(id),scheduler.scheduled=void 0)},AnimationFrameAction}(AsyncAction_AsyncAction),animationFrameScheduler=new(function(_super){function AnimationFrameScheduler(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_es6.a(AnimationFrameScheduler,_super),AnimationFrameScheduler.prototype.flush=function(action){this.active=!0,this.scheduled=void 0;var error,actions=this.actions,index=-1,count=actions.length;action=action||actions.shift();do{if(error=action.execute(action.state,action.delay))break}while(++index<count&&(action=actions.shift()));if(this.active=!1,error){for(;++index<count&&(action=actions.shift());)action.unsubscribe();throw error}},AnimationFrameScheduler}(AsyncScheduler_AsyncScheduler))(AnimationFrameAction_AnimationFrameAction),animationFrame=animationFrameScheduler,VirtualTimeScheduler_VirtualTimeScheduler=function(_super){function VirtualTimeScheduler(SchedulerAction,maxFrames){void 0===SchedulerAction&&(SchedulerAction=VirtualTimeScheduler_VirtualAction),void 0===maxFrames&&(maxFrames=Number.POSITIVE_INFINITY);var _this=_super.call(this,SchedulerAction,(function(){return _this.frame}))||this;return _this.maxFrames=maxFrames,_this.frame=0,_this.index=-1,_this}return tslib_es6.a(VirtualTimeScheduler,_super),VirtualTimeScheduler.prototype.flush=function(){for(var error,action,actions=this.actions,maxFrames=this.maxFrames;(action=actions[0])&&action.delay<=maxFrames&&(actions.shift(),this.frame=action.delay,!(error=action.execute(action.state,action.delay))););if(error){for(;action=actions.shift();)action.unsubscribe();throw error}},VirtualTimeScheduler.frameTimeFactor=10,VirtualTimeScheduler}(AsyncScheduler_AsyncScheduler),VirtualTimeScheduler_VirtualAction=function(_super){function VirtualAction(scheduler,work,index){void 0===index&&(index=scheduler.index+=1);var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this.index=index,_this.active=!0,_this.index=scheduler.index=index,_this}return tslib_es6.a(VirtualAction,_super),VirtualAction.prototype.schedule=function(state,delay){if(void 0===delay&&(delay=0),!this.id)return _super.prototype.schedule.call(this,state,delay);this.active=!1;var action=new VirtualAction(this.scheduler,this.work);return this.add(action),action.schedule(state,delay)},VirtualAction.prototype.requestAsyncId=function(scheduler,id,delay){void 0===delay&&(delay=0),this.delay=scheduler.frame+delay;var actions=scheduler.actions;return actions.push(this),actions.sort(VirtualAction.sortActions),!0},VirtualAction.prototype.recycleAsyncId=function(scheduler,id,delay){void 0===delay&&(delay=0)},VirtualAction.prototype._execute=function(state,delay){if(!0===this.active)return _super.prototype._execute.call(this,state,delay)},VirtualAction.sortActions=function(a,b){return a.delay===b.delay?a.index===b.index?0:a.index>b.index?1:-1:a.delay>b.delay?1:-1},VirtualAction}(AsyncAction_AsyncAction),pipe=__webpack_require__(61);function noop(){}var identity=__webpack_require__(34);function isObservable(obj){return!!obj&&(obj instanceof Observable.a||"function"==typeof obj.lift&&"function"==typeof obj.subscribe)}var ArgumentOutOfRangeError=function(){function ArgumentOutOfRangeErrorImpl(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}return ArgumentOutOfRangeErrorImpl.prototype=Object.create(Error.prototype),ArgumentOutOfRangeErrorImpl}(),EmptyError=function(){function EmptyErrorImpl(){return Error.call(this),this.message="no elements in sequence",this.name="EmptyError",this}return EmptyErrorImpl.prototype=Object.create(Error.prototype),EmptyErrorImpl}(),UnsubscriptionError=__webpack_require__(42),TimeoutError=function(){function TimeoutErrorImpl(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}return TimeoutErrorImpl.prototype=Object.create(Error.prototype),TimeoutErrorImpl}();function map(project,thisArg){return function(source){if("function"!=typeof project)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return source.lift(new MapOperator(project,thisArg))}}var MapOperator=function(){function MapOperator(project,thisArg){this.project=project,this.thisArg=thisArg}return MapOperator.prototype.call=function(subscriber,source){return source.subscribe(new map_MapSubscriber(subscriber,this.project,this.thisArg))},MapOperator}(),map_MapSubscriber=function(_super){function MapSubscriber(destination,project,thisArg){var _this=_super.call(this,destination)||this;return _this.project=project,_this.count=0,_this.thisArg=thisArg||_this,_this}return tslib_es6.a(MapSubscriber,_super),MapSubscriber.prototype._next=function(value){var result;try{result=this.project.call(this.thisArg,value,this.count++)}catch(err){return void this.destination.error(err)}this.destination.next(result)},MapSubscriber}(Subscriber.a),canReportError=__webpack_require__(51),isArray=__webpack_require__(17);function bindCallback(callbackFunc,resultSelector,scheduler){if(resultSelector){if(!isScheduler(resultSelector))return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return bindCallback(callbackFunc,scheduler).apply(void 0,args).pipe(map((function(args){return Object(isArray.a)(args)?resultSelector.apply(void 0,args):resultSelector(args)})))};scheduler=resultSelector}return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var subject,context=this,params={context:context,subject:subject,callbackFunc:callbackFunc,scheduler:scheduler};return new Observable.a((function(subscriber){if(scheduler){var state={args:args,subscriber:subscriber,params:params};return scheduler.schedule(bindCallback_dispatch,0,state)}if(!subject){subject=new AsyncSubject_AsyncSubject;try{callbackFunc.apply(context,args.concat([function(){for(var innerArgs=[],_i=0;_i<arguments.length;_i++)innerArgs[_i]=arguments[_i];subject.next(innerArgs.length<=1?innerArgs[0]:innerArgs),subject.complete()}]))}catch(err){Object(canReportError.a)(subject)?subject.error(err):console.warn(err)}}return subject.subscribe(subscriber)}))}}function bindCallback_dispatch(state){var _this=this,args=state.args,subscriber=state.subscriber,params=state.params,callbackFunc=params.callbackFunc,context=params.context,scheduler=params.scheduler,subject=params.subject;if(!subject){subject=params.subject=new AsyncSubject_AsyncSubject;try{callbackFunc.apply(context,args.concat([function(){for(var innerArgs=[],_i=0;_i<arguments.length;_i++)innerArgs[_i]=arguments[_i];var value=innerArgs.length<=1?innerArgs[0]:innerArgs;_this.add(scheduler.schedule(dispatchNext,0,{value:value,subject:subject}))}]))}catch(err){subject.error(err)}}this.add(subject.subscribe(subscriber))}function dispatchNext(state){var value=state.value,subject=state.subject;subject.next(value),subject.complete()}function bindNodeCallback(callbackFunc,resultSelector,scheduler){if(resultSelector){if(!isScheduler(resultSelector))return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];return bindNodeCallback(callbackFunc,scheduler).apply(void 0,args).pipe(map((function(args){return Object(isArray.a)(args)?resultSelector.apply(void 0,args):resultSelector(args)})))};scheduler=resultSelector}return function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var params={subject:void 0,args:args,callbackFunc:callbackFunc,scheduler:scheduler,context:this};return new Observable.a((function(subscriber){var context=params.context,subject=params.subject;if(scheduler)return scheduler.schedule(bindNodeCallback_dispatch,0,{params:params,subscriber:subscriber,context:context});if(!subject){subject=params.subject=new AsyncSubject_AsyncSubject;try{callbackFunc.apply(context,args.concat([function(){for(var innerArgs=[],_i=0;_i<arguments.length;_i++)innerArgs[_i]=arguments[_i];var err=innerArgs.shift();err?subject.error(err):(subject.next(innerArgs.length<=1?innerArgs[0]:innerArgs),subject.complete())}]))}catch(err){Object(canReportError.a)(subject)?subject.error(err):console.warn(err)}}return subject.subscribe(subscriber)}))}}function bindNodeCallback_dispatch(state){var _this=this,params=state.params,subscriber=state.subscriber,context=state.context,callbackFunc=params.callbackFunc,args=params.args,scheduler=params.scheduler,subject=params.subject;if(!subject){subject=params.subject=new AsyncSubject_AsyncSubject;try{callbackFunc.apply(context,args.concat([function(){for(var innerArgs=[],_i=0;_i<arguments.length;_i++)innerArgs[_i]=arguments[_i];var err=innerArgs.shift();if(err)_this.add(scheduler.schedule(bindNodeCallback_dispatchError,0,{err:err,subject:subject}));else{var value=innerArgs.length<=1?innerArgs[0]:innerArgs;_this.add(scheduler.schedule(bindNodeCallback_dispatchNext,0,{value:value,subject:subject}))}}]))}catch(err){this.add(scheduler.schedule(bindNodeCallback_dispatchError,0,{err:err,subject:subject}))}}this.add(subject.subscribe(subscriber))}function bindNodeCallback_dispatchNext(arg){var value=arg.value,subject=arg.subject;subject.next(value),subject.complete()}function bindNodeCallback_dispatchError(arg){var err=arg.err;arg.subject.error(err)}var OuterSubscriber_OuterSubscriber=function(_super){function OuterSubscriber(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_es6.a(OuterSubscriber,_super),OuterSubscriber.prototype.notifyNext=function(outerValue,innerValue,outerIndex,innerIndex,innerSub){this.destination.next(innerValue)},OuterSubscriber.prototype.notifyError=function(error,innerSub){this.destination.error(error)},OuterSubscriber.prototype.notifyComplete=function(innerSub){this.destination.complete()},OuterSubscriber}(Subscriber.a),InnerSubscriber_InnerSubscriber=function(_super){function InnerSubscriber(parent,outerValue,outerIndex){var _this=_super.call(this)||this;return _this.parent=parent,_this.outerValue=outerValue,_this.outerIndex=outerIndex,_this.index=0,_this}return tslib_es6.a(InnerSubscriber,_super),InnerSubscriber.prototype._next=function(value){this.parent.notifyNext(this.outerValue,value,this.outerIndex,this.index++,this)},InnerSubscriber.prototype._error=function(error){this.parent.notifyError(error,this),this.unsubscribe()},InnerSubscriber.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},InnerSubscriber}(Subscriber.a),hostReportError=__webpack_require__(36);function getSymbolIterator(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var iterator_iterator=getSymbolIterator(),isArrayLike=function(x){return x&&"number"==typeof x.length&&"function"!=typeof x};function isPromise(value){return!!value&&"function"!=typeof value.subscribe&&"function"==typeof value.then}var isObject=__webpack_require__(50),subscribeTo=function(result){if(result&&"function"==typeof result[symbol_observable.a])return obj=result,function(subscriber){var obs=obj[symbol_observable.a]();if("function"!=typeof obs.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return obs.subscribe(subscriber)};if(isArrayLike(result))return subscribeToArray(result);if(isPromise(result))return promise=result,function(subscriber){return promise.then((function(value){subscriber.closed||(subscriber.next(value),subscriber.complete())}),(function(err){return subscriber.error(err)})).then(null,hostReportError.a),subscriber};if(result&&"function"==typeof result[iterator_iterator])return iterable=result,function(subscriber){for(var iterator=iterable[iterator_iterator]();;){var item=void 0;try{item=iterator.next()}catch(err){return subscriber.error(err),subscriber}if(item.done){subscriber.complete();break}if(subscriber.next(item.value),subscriber.closed)break}return"function"==typeof iterator.return&&subscriber.add((function(){iterator.return&&iterator.return()})),subscriber};var iterable,promise,obj,value=Object(isObject.a)(result)?"an invalid object":"'"+result+"'";throw new TypeError("You provided "+value+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function subscribeToResult(outerSubscriber,result,outerValue,outerIndex,innerSubscriber){if(void 0===innerSubscriber&&(innerSubscriber=new InnerSubscriber_InnerSubscriber(outerSubscriber,outerValue,outerIndex)),!innerSubscriber.closed)return result instanceof Observable.a?result.subscribe(innerSubscriber):subscribeTo(result)(innerSubscriber)}var NONE={};function combineLatest(){for(var observables=[],_i=0;_i<arguments.length;_i++)observables[_i]=arguments[_i];var resultSelector=void 0,scheduler=void 0;return isScheduler(observables[observables.length-1])&&(scheduler=observables.pop()),"function"==typeof observables[observables.length-1]&&(resultSelector=observables.pop()),1===observables.length&&Object(isArray.a)(observables[0])&&(observables=observables[0]),fromArray(observables,scheduler).lift(new CombineLatestOperator(resultSelector))}var CombineLatestOperator=function(){function CombineLatestOperator(resultSelector){this.resultSelector=resultSelector}return CombineLatestOperator.prototype.call=function(subscriber,source){return source.subscribe(new combineLatest_CombineLatestSubscriber(subscriber,this.resultSelector))},CombineLatestOperator}(),combineLatest_CombineLatestSubscriber=function(_super){function CombineLatestSubscriber(destination,resultSelector){var _this=_super.call(this,destination)||this;return _this.resultSelector=resultSelector,_this.active=0,_this.values=[],_this.observables=[],_this}return tslib_es6.a(CombineLatestSubscriber,_super),CombineLatestSubscriber.prototype._next=function(observable){this.values.push(NONE),this.observables.push(observable)},CombineLatestSubscriber.prototype._complete=function(){var observables=this.observables,len=observables.length;if(0===len)this.destination.complete();else{this.active=len,this.toRespond=len;for(var i=0;i<len;i++){var observable=observables[i];this.add(subscribeToResult(this,observable,void 0,i))}}},CombineLatestSubscriber.prototype.notifyComplete=function(unused){0==(this.active-=1)&&this.destination.complete()},CombineLatestSubscriber.prototype.notifyNext=function(_outerValue,innerValue,outerIndex){var values=this.values,oldVal=values[outerIndex],toRespond=this.toRespond?oldVal===NONE?--this.toRespond:this.toRespond:0;values[outerIndex]=innerValue,0===toRespond&&(this.resultSelector?this._tryResultSelector(values):this.destination.next(values.slice()))},CombineLatestSubscriber.prototype._tryResultSelector=function(values){var result;try{result=this.resultSelector.apply(this,values)}catch(err){return void this.destination.error(err)}this.destination.next(result)},CombineLatestSubscriber}(OuterSubscriber_OuterSubscriber);function scheduled(input,scheduler){if(null!=input){if(function(input){return input&&"function"==typeof input[symbol_observable.a]}(input))return function(input,scheduler){return new Observable.a((function(subscriber){var sub=new Subscription.a;return sub.add(scheduler.schedule((function(){var observable=input[symbol_observable.a]();sub.add(observable.subscribe({next:function(value){sub.add(scheduler.schedule((function(){return subscriber.next(value)})))},error:function(err){sub.add(scheduler.schedule((function(){return subscriber.error(err)})))},complete:function(){sub.add(scheduler.schedule((function(){return subscriber.complete()})))}}))}))),sub}))}(input,scheduler);if(isPromise(input))return function(input,scheduler){return new Observable.a((function(subscriber){var sub=new Subscription.a;return sub.add(scheduler.schedule((function(){return input.then((function(value){sub.add(scheduler.schedule((function(){subscriber.next(value),sub.add(scheduler.schedule((function(){return subscriber.complete()})))})))}),(function(err){sub.add(scheduler.schedule((function(){return subscriber.error(err)})))}))}))),sub}))}(input,scheduler);if(isArrayLike(input))return scheduleArray(input,scheduler);if(function(input){return input&&"function"==typeof input[iterator_iterator]}(input)||"string"==typeof input)return function(input,scheduler){if(!input)throw new Error("Iterable cannot be null");return new Observable.a((function(subscriber){var iterator,sub=new Subscription.a;return sub.add((function(){iterator&&"function"==typeof iterator.return&&iterator.return()})),sub.add(scheduler.schedule((function(){iterator=input[iterator_iterator](),sub.add(scheduler.schedule((function(){if(!subscriber.closed){var value,done;try{var result=iterator.next();value=result.value,done=result.done}catch(err){return void subscriber.error(err)}done?subscriber.complete():(subscriber.next(value),this.schedule())}})))}))),sub}))}(input,scheduler)}throw new TypeError((null!==input&&typeof input||input)+" is not observable")}function from(input,scheduler){return scheduler?scheduled(input,scheduler):input instanceof Observable.a?input:new Observable.a(subscribeTo(input))}var innerSubscribe_SimpleInnerSubscriber=function(_super){function SimpleInnerSubscriber(parent){var _this=_super.call(this)||this;return _this.parent=parent,_this}return tslib_es6.a(SimpleInnerSubscriber,_super),SimpleInnerSubscriber.prototype._next=function(value){this.parent.notifyNext(value)},SimpleInnerSubscriber.prototype._error=function(error){this.parent.notifyError(error),this.unsubscribe()},SimpleInnerSubscriber.prototype._complete=function(){this.parent.notifyComplete(),this.unsubscribe()},SimpleInnerSubscriber}(Subscriber.a),innerSubscribe_SimpleOuterSubscriber=(Subscriber.a,function(_super){function SimpleOuterSubscriber(){return null!==_super&&_super.apply(this,arguments)||this}return tslib_es6.a(SimpleOuterSubscriber,_super),SimpleOuterSubscriber.prototype.notifyNext=function(innerValue){this.destination.next(innerValue)},SimpleOuterSubscriber.prototype.notifyError=function(err){this.destination.error(err)},SimpleOuterSubscriber.prototype.notifyComplete=function(){this.destination.complete()},SimpleOuterSubscriber}(Subscriber.a));Subscriber.a;function innerSubscribe(result,innerSubscriber){if(!innerSubscriber.closed){if(result instanceof Observable.a)return result.subscribe(innerSubscriber);var subscription;try{subscription=subscribeTo(result)(innerSubscriber)}catch(error){innerSubscriber.error(error)}return subscription}}function mergeMap(project,resultSelector,concurrent){return void 0===concurrent&&(concurrent=Number.POSITIVE_INFINITY),"function"==typeof resultSelector?function(source){return source.pipe(mergeMap((function(a,i){return from(project(a,i)).pipe(map((function(b,ii){return resultSelector(a,b,i,ii)})))}),concurrent))}:("number"==typeof resultSelector&&(concurrent=resultSelector),function(source){return source.lift(new MergeMapOperator(project,concurrent))})}var MergeMapOperator=function(){function MergeMapOperator(project,concurrent){void 0===concurrent&&(concurrent=Number.POSITIVE_INFINITY),this.project=project,this.concurrent=concurrent}return MergeMapOperator.prototype.call=function(observer,source){return source.subscribe(new mergeMap_MergeMapSubscriber(observer,this.project,this.concurrent))},MergeMapOperator}(),mergeMap_MergeMapSubscriber=function(_super){function MergeMapSubscriber(destination,project,concurrent){void 0===concurrent&&(concurrent=Number.POSITIVE_INFINITY);var _this=_super.call(this,destination)||this;return _this.project=project,_this.concurrent=concurrent,_this.hasCompleted=!1,_this.buffer=[],_this.active=0,_this.index=0,_this}return tslib_es6.a(MergeMapSubscriber,_super),MergeMapSubscriber.prototype._next=function(value){this.active<this.concurrent?this._tryNext(value):this.buffer.push(value)},MergeMapSubscriber.prototype._tryNext=function(value){var result,index=this.index++;try{result=this.project(value,index)}catch(err){return void this.destination.error(err)}this.active++,this._innerSub(result)},MergeMapSubscriber.prototype._innerSub=function(ish){var innerSubscriber=new innerSubscribe_SimpleInnerSubscriber(this),destination=this.destination;destination.add(innerSubscriber);var innerSubscription=innerSubscribe(ish,innerSubscriber);innerSubscription!==innerSubscriber&&destination.add(innerSubscription)},MergeMapSubscriber.prototype._complete=function(){this.hasCompleted=!0,0===this.active&&0===this.buffer.length&&this.destination.complete(),this.unsubscribe()},MergeMapSubscriber.prototype.notifyNext=function(innerValue){this.destination.next(innerValue)},MergeMapSubscriber.prototype.notifyComplete=function(){var buffer=this.buffer;this.active--,buffer.length>0?this._next(buffer.shift()):0===this.active&&this.hasCompleted&&this.destination.complete()},MergeMapSubscriber}(innerSubscribe_SimpleOuterSubscriber);function mergeAll(concurrent){return void 0===concurrent&&(concurrent=Number.POSITIVE_INFINITY),mergeMap(identity.a,concurrent)}function concatAll(){return mergeAll(1)}function concat(){for(var observables=[],_i=0;_i<arguments.length;_i++)observables[_i]=arguments[_i];return concatAll()(of.apply(void 0,observables))}function defer(observableFactory){return new Observable.a((function(subscriber){var input;try{input=observableFactory()}catch(err){return void subscriber.error(err)}return(input?from(input):empty()).subscribe(subscriber)}))}function forkJoin(){for(var sources=[],_i=0;_i<arguments.length;_i++)sources[_i]=arguments[_i];if(1===sources.length){var first_1=sources[0];if(Object(isArray.a)(first_1))return forkJoinInternal(first_1,null);if(Object(isObject.a)(first_1)&&Object.getPrototypeOf(first_1)===Object.prototype){var keys=Object.keys(first_1);return forkJoinInternal(keys.map((function(key){return first_1[key]})),keys)}}if("function"==typeof sources[sources.length-1]){var resultSelector_1=sources.pop();return forkJoinInternal(sources=1===sources.length&&Object(isArray.a)(sources[0])?sources[0]:sources,null).pipe(map((function(args){return resultSelector_1.apply(void 0,args)})))}return forkJoinInternal(sources,null)}function forkJoinInternal(sources,keys){return new Observable.a((function(subscriber){var len=sources.length;if(0!==len)for(var values=new Array(len),completed=0,emitted=0,_loop_1=function(i){var source=from(sources[i]),hasValue=!1;subscriber.add(source.subscribe({next:function(value){hasValue||(hasValue=!0,emitted++),values[i]=value},error:function(err){return subscriber.error(err)},complete:function(){++completed!==len&&hasValue||(emitted===len&&subscriber.next(keys?keys.reduce((function(result,key,i){return result[key]=values[i],result}),{}):values),subscriber.complete())}}))},i=0;i<len;i++)_loop_1(i);else subscriber.complete()}))}var isFunction=__webpack_require__(35);function fromEvent(target,eventName,options,resultSelector){return Object(isFunction.a)(options)&&(resultSelector=options,options=void 0),resultSelector?fromEvent(target,eventName,options).pipe(map((function(args){return Object(isArray.a)(args)?resultSelector.apply(void 0,args):resultSelector(args)}))):new Observable.a((function(subscriber){!function setupSubscription(sourceObj,eventName,handler,subscriber,options){var unsubscribe;if(function(sourceObj){return sourceObj&&"function"==typeof sourceObj.addEventListener&&"function"==typeof sourceObj.removeEventListener}(sourceObj)){var source_1=sourceObj;sourceObj.addEventListener(eventName,handler,options),unsubscribe=function(){return source_1.removeEventListener(eventName,handler,options)}}else if(function(sourceObj){return sourceObj&&"function"==typeof sourceObj.on&&"function"==typeof sourceObj.off}(sourceObj)){var source_2=sourceObj;sourceObj.on(eventName,handler),unsubscribe=function(){return source_2.off(eventName,handler)}}else if(function(sourceObj){return sourceObj&&"function"==typeof sourceObj.addListener&&"function"==typeof sourceObj.removeListener}(sourceObj)){var source_3=sourceObj;sourceObj.addListener(eventName,handler),unsubscribe=function(){return source_3.removeListener(eventName,handler)}}else{if(!sourceObj||!sourceObj.length)throw new TypeError("Invalid event target");for(var i=0,len=sourceObj.length;i<len;i++)setupSubscription(sourceObj[i],eventName,handler,subscriber,options)}subscriber.add(unsubscribe)}(target,eventName,(function(e){arguments.length>1?subscriber.next(Array.prototype.slice.call(arguments)):subscriber.next(e)}),subscriber,options)}))}function fromEventPattern(addHandler,removeHandler,resultSelector){return resultSelector?fromEventPattern(addHandler,removeHandler).pipe(map((function(args){return Object(isArray.a)(args)?resultSelector.apply(void 0,args):resultSelector(args)}))):new Observable.a((function(subscriber){var retValue,handler=function(){for(var e=[],_i=0;_i<arguments.length;_i++)e[_i]=arguments[_i];return subscriber.next(1===e.length?e[0]:e)};try{retValue=addHandler(handler)}catch(err){return void subscriber.error(err)}if(Object(isFunction.a)(removeHandler))return function(){return removeHandler(handler,retValue)}}))}function generate(initialStateOrOptions,condition,iterate,resultSelectorOrObservable,scheduler){var resultSelector,initialState;if(1==arguments.length){var options=initialStateOrOptions;initialState=options.initialState,condition=options.condition,iterate=options.iterate,resultSelector=options.resultSelector||identity.a,scheduler=options.scheduler}else void 0===resultSelectorOrObservable||isScheduler(resultSelectorOrObservable)?(initialState=initialStateOrOptions,resultSelector=identity.a,scheduler=resultSelectorOrObservable):(initialState=initialStateOrOptions,resultSelector=resultSelectorOrObservable);return new Observable.a((function(subscriber){var state=initialState;if(scheduler)return scheduler.schedule(generate_dispatch,0,{subscriber:subscriber,iterate:iterate,condition:condition,resultSelector:resultSelector,state:state});for(;;){if(condition){var conditionResult=void 0;try{conditionResult=condition(state)}catch(err){return void subscriber.error(err)}if(!conditionResult){subscriber.complete();break}}var value=void 0;try{value=resultSelector(state)}catch(err){return void subscriber.error(err)}if(subscriber.next(value),subscriber.closed)break;try{state=iterate(state)}catch(err){return void subscriber.error(err)}}}))}function generate_dispatch(state){var subscriber=state.subscriber,condition=state.condition;if(!subscriber.closed){if(state.needIterate)try{state.state=state.iterate(state.state)}catch(err){return void subscriber.error(err)}else state.needIterate=!0;if(condition){var conditionResult=void 0;try{conditionResult=condition(state.state)}catch(err){return void subscriber.error(err)}if(!conditionResult)return void subscriber.complete();if(subscriber.closed)return}var value;try{value=state.resultSelector(state.state)}catch(err){return void subscriber.error(err)}if(!subscriber.closed&&(subscriber.next(value),!subscriber.closed))return this.schedule(state)}}function iif(condition,trueResult,falseResult){return void 0===trueResult&&(trueResult=EMPTY),void 0===falseResult&&(falseResult=EMPTY),defer((function(){return condition()?trueResult:falseResult}))}function isNumeric(val){return!Object(isArray.a)(val)&&val-parseFloat(val)+1>=0}function interval(period,scheduler){return void 0===period&&(period=0),void 0===scheduler&&(scheduler=async_async),(!isNumeric(period)||period<0)&&(period=0),scheduler&&"function"==typeof scheduler.schedule||(scheduler=async_async),new Observable.a((function(subscriber){return subscriber.add(scheduler.schedule(interval_dispatch,period,{subscriber:subscriber,counter:0,period:period})),subscriber}))}function interval_dispatch(state){var subscriber=state.subscriber,counter=state.counter,period=state.period;subscriber.next(counter),this.schedule({subscriber:subscriber,counter:counter+1,period:period},period)}function merge(){for(var observables=[],_i=0;_i<arguments.length;_i++)observables[_i]=arguments[_i];var concurrent=Number.POSITIVE_INFINITY,scheduler=null,last=observables[observables.length-1];return isScheduler(last)?(scheduler=observables.pop(),observables.length>1&&"number"==typeof observables[observables.length-1]&&(concurrent=observables.pop())):"number"==typeof last&&(concurrent=observables.pop()),null===scheduler&&1===observables.length&&observables[0]instanceof Observable.a?observables[0]:mergeAll(concurrent)(fromArray(observables,scheduler))}var NEVER=new Observable.a(noop);function never(){return NEVER}function onErrorResumeNext(){for(var sources=[],_i=0;_i<arguments.length;_i++)sources[_i]=arguments[_i];if(0===sources.length)return EMPTY;var first=sources[0],remainder=sources.slice(1);return 1===sources.length&&Object(isArray.a)(first)?onErrorResumeNext.apply(void 0,first):new Observable.a((function(subscriber){var subNext=function(){return subscriber.add(onErrorResumeNext.apply(void 0,remainder).subscribe(subscriber))};return from(first).subscribe({next:function(value){subscriber.next(value)},error:subNext,complete:subNext})}))}function pairs(obj,scheduler){return scheduler?new Observable.a((function(subscriber){var keys=Object.keys(obj),subscription=new Subscription.a;return subscription.add(scheduler.schedule(pairs_dispatch,0,{keys:keys,index:0,subscriber:subscriber,subscription:subscription,obj:obj})),subscription})):new Observable.a((function(subscriber){for(var keys=Object.keys(obj),i=0;i<keys.length&&!subscriber.closed;i++){var key=keys[i];obj.hasOwnProperty(key)&&subscriber.next([key,obj[key]])}subscriber.complete()}))}function pairs_dispatch(state){var keys=state.keys,index=state.index,subscriber=state.subscriber,subscription=state.subscription,obj=state.obj;if(!subscriber.closed)if(index<keys.length){var key=keys[index];subscriber.next([key,obj[key]]),subscription.add(this.schedule({keys:keys,index:index+1,subscriber:subscriber,subscription:subscription,obj:obj}))}else subscriber.complete()}function not(pred,thisArg){function notPred(){return!notPred.pred.apply(notPred.thisArg,arguments)}return notPred.pred=pred,notPred.thisArg=thisArg,notPred}function filter(predicate,thisArg){return function(source){return source.lift(new FilterOperator(predicate,thisArg))}}var FilterOperator=function(){function FilterOperator(predicate,thisArg){this.predicate=predicate,this.thisArg=thisArg}return FilterOperator.prototype.call=function(subscriber,source){return source.subscribe(new filter_FilterSubscriber(subscriber,this.predicate,this.thisArg))},FilterOperator}(),filter_FilterSubscriber=function(_super){function FilterSubscriber(destination,predicate,thisArg){var _this=_super.call(this,destination)||this;return _this.predicate=predicate,_this.thisArg=thisArg,_this.count=0,_this}return tslib_es6.a(FilterSubscriber,_super),FilterSubscriber.prototype._next=function(value){var result;try{result=this.predicate.call(this.thisArg,value,this.count++)}catch(err){return void this.destination.error(err)}result&&this.destination.next(value)},FilterSubscriber}(Subscriber.a);function partition(source,predicate,thisArg){return[filter(predicate,thisArg)(new Observable.a(subscribeTo(source))),filter(not(predicate,thisArg))(new Observable.a(subscribeTo(source)))]}function race(){for(var observables=[],_i=0;_i<arguments.length;_i++)observables[_i]=arguments[_i];if(1===observables.length){if(!Object(isArray.a)(observables[0]))return observables[0];observables=observables[0]}return fromArray(observables,void 0).lift(new RaceOperator)}var RaceOperator=function(){function RaceOperator(){}return RaceOperator.prototype.call=function(subscriber,source){return source.subscribe(new race_RaceSubscriber(subscriber))},RaceOperator}(),race_RaceSubscriber=function(_super){function RaceSubscriber(destination){var _this=_super.call(this,destination)||this;return _this.hasFirst=!1,_this.observables=[],_this.subscriptions=[],_this}return tslib_es6.a(RaceSubscriber,_super),RaceSubscriber.prototype._next=function(observable){this.observables.push(observable)},RaceSubscriber.prototype._complete=function(){var observables=this.observables,len=observables.length;if(0===len)this.destination.complete();else{for(var i=0;i<len&&!this.hasFirst;i++){var subscription=subscribeToResult(this,observables[i],void 0,i);this.subscriptions&&this.subscriptions.push(subscription),this.add(subscription)}this.observables=null}},RaceSubscriber.prototype.notifyNext=function(_outerValue,innerValue,outerIndex){if(!this.hasFirst){this.hasFirst=!0;for(var i=0;i<this.subscriptions.length;i++)if(i!==outerIndex){var subscription=this.subscriptions[i];subscription.unsubscribe(),this.remove(subscription)}this.subscriptions=null}this.destination.next(innerValue)},RaceSubscriber}(OuterSubscriber_OuterSubscriber);function range(start,count,scheduler){return void 0===start&&(start=0),new Observable.a((function(subscriber){void 0===count&&(count=start,start=0);var index=0,current=start;if(scheduler)return scheduler.schedule(range_dispatch,0,{index:index,count:count,start:start,subscriber:subscriber});for(;;){if(index++>=count){subscriber.complete();break}if(subscriber.next(current++),subscriber.closed)break}}))}function range_dispatch(state){var start=state.start,index=state.index,count=state.count,subscriber=state.subscriber;index>=count?subscriber.complete():(subscriber.next(start),subscriber.closed||(state.index=index+1,state.start=start+1,this.schedule(state)))}function timer(dueTime,periodOrScheduler,scheduler){void 0===dueTime&&(dueTime=0);var period=-1;return isNumeric(periodOrScheduler)?period=Number(periodOrScheduler)<1?1:Number(periodOrScheduler):isScheduler(periodOrScheduler)&&(scheduler=periodOrScheduler),isScheduler(scheduler)||(scheduler=async_async),new Observable.a((function(subscriber){var due=isNumeric(dueTime)?dueTime:+dueTime-scheduler.now();return scheduler.schedule(timer_dispatch,due,{index:0,period:period,subscriber:subscriber})}))}function timer_dispatch(state){var index=state.index,period=state.period,subscriber=state.subscriber;if(subscriber.next(index),!subscriber.closed){if(-1===period)return subscriber.complete();state.index=index+1,this.schedule(state,period)}}function using(resourceFactory,observableFactory){return new Observable.a((function(subscriber){var resource,result;try{resource=resourceFactory()}catch(err){return void subscriber.error(err)}try{result=observableFactory(resource)}catch(err){return void subscriber.error(err)}var subscription=(result?from(result):EMPTY).subscribe(subscriber);return function(){subscription.unsubscribe(),resource&&resource.unsubscribe()}}))}function zip(){for(var observables=[],_i=0;_i<arguments.length;_i++)observables[_i]=arguments[_i];var resultSelector=observables[observables.length-1];return"function"==typeof resultSelector&&observables.pop(),fromArray(observables,void 0).lift(new ZipOperator(resultSelector))}var ZipOperator=function(){function ZipOperator(resultSelector){this.resultSelector=resultSelector}return ZipOperator.prototype.call=function(subscriber,source){return source.subscribe(new zip_ZipSubscriber(subscriber,this.resultSelector))},ZipOperator}(),zip_ZipSubscriber=function(_super){function ZipSubscriber(destination,resultSelector,values){void 0===values&&(values=Object.create(null));var _this=_super.call(this,destination)||this;return _this.resultSelector=resultSelector,_this.iterators=[],_this.active=0,_this.resultSelector="function"==typeof resultSelector?resultSelector:void 0,_this}return tslib_es6.a(ZipSubscriber,_super),ZipSubscriber.prototype._next=function(value){var iterators=this.iterators;Object(isArray.a)(value)?iterators.push(new zip_StaticArrayIterator(value)):"function"==typeof value[iterator_iterator]?iterators.push(new StaticIterator(value[iterator_iterator]())):iterators.push(new zip_ZipBufferIterator(this.destination,this,value))},ZipSubscriber.prototype._complete=function(){var iterators=this.iterators,len=iterators.length;if(this.unsubscribe(),0!==len){this.active=len;for(var i=0;i<len;i++){var iterator=iterators[i];if(iterator.stillUnsubscribed)this.destination.add(iterator.subscribe());else this.active--}}else this.destination.complete()},ZipSubscriber.prototype.notifyInactive=function(){this.active--,0===this.active&&this.destination.complete()},ZipSubscriber.prototype.checkIterators=function(){for(var iterators=this.iterators,len=iterators.length,destination=this.destination,i=0;i<len;i++){if("function"==typeof(iterator=iterators[i]).hasValue&&!iterator.hasValue())return}var shouldComplete=!1,args=[];for(i=0;i<len;i++){var iterator,result=(iterator=iterators[i]).next();if(iterator.hasCompleted()&&(shouldComplete=!0),result.done)return void destination.complete();args.push(result.value)}this.resultSelector?this._tryresultSelector(args):destination.next(args),shouldComplete&&destination.complete()},ZipSubscriber.prototype._tryresultSelector=function(args){var result;try{result=this.resultSelector.apply(this,args)}catch(err){return void this.destination.error(err)}this.destination.next(result)},ZipSubscriber}(Subscriber.a),StaticIterator=function(){function StaticIterator(iterator){this.iterator=iterator,this.nextResult=iterator.next()}return StaticIterator.prototype.hasValue=function(){return!0},StaticIterator.prototype.next=function(){var result=this.nextResult;return this.nextResult=this.iterator.next(),result},StaticIterator.prototype.hasCompleted=function(){var nextResult=this.nextResult;return Boolean(nextResult&&nextResult.done)},StaticIterator}(),zip_StaticArrayIterator=function(){function StaticArrayIterator(array){this.array=array,this.index=0,this.length=0,this.length=array.length}return StaticArrayIterator.prototype[iterator_iterator]=function(){return this},StaticArrayIterator.prototype.next=function(value){var i=this.index++,array=this.array;return i<this.length?{value:array[i],done:!1}:{value:null,done:!0}},StaticArrayIterator.prototype.hasValue=function(){return this.array.length>this.index},StaticArrayIterator.prototype.hasCompleted=function(){return this.array.length===this.index},StaticArrayIterator}(),zip_ZipBufferIterator=function(_super){function ZipBufferIterator(destination,parent,observable){var _this=_super.call(this,destination)||this;return _this.parent=parent,_this.observable=observable,_this.stillUnsubscribed=!0,_this.buffer=[],_this.isComplete=!1,_this}return tslib_es6.a(ZipBufferIterator,_super),ZipBufferIterator.prototype[iterator_iterator]=function(){return this},ZipBufferIterator.prototype.next=function(){var buffer=this.buffer;return 0===buffer.length&&this.isComplete?{value:null,done:!0}:{value:buffer.shift(),done:!1}},ZipBufferIterator.prototype.hasValue=function(){return this.buffer.length>0},ZipBufferIterator.prototype.hasCompleted=function(){return 0===this.buffer.length&&this.isComplete},ZipBufferIterator.prototype.notifyComplete=function(){this.buffer.length>0?(this.isComplete=!0,this.parent.notifyInactive()):this.destination.complete()},ZipBufferIterator.prototype.notifyNext=function(innerValue){this.buffer.push(innerValue),this.parent.checkIterators()},ZipBufferIterator.prototype.subscribe=function(){return innerSubscribe(this.observable,new innerSubscribe_SimpleInnerSubscriber(this))},ZipBufferIterator}(innerSubscribe_SimpleOuterSubscriber),config=__webpack_require__(21)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return Subscriber}));var tslib__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6),_util_isFunction__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(35),_Observer__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(53),_Subscription__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(13),_internal_symbol_rxSubscriber__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(41),_config__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(21),_util_hostReportError__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(36),Subscriber=function(_super){function Subscriber(destinationOrNext,error,complete){var _this=_super.call(this)||this;switch(_this.syncErrorValue=null,_this.syncErrorThrown=!1,_this.syncErrorThrowable=!1,_this.isStopped=!1,arguments.length){case 0:_this.destination=_Observer__WEBPACK_IMPORTED_MODULE_2__.a;break;case 1:if(!destinationOrNext){_this.destination=_Observer__WEBPACK_IMPORTED_MODULE_2__.a;break}if("object"==typeof destinationOrNext){destinationOrNext instanceof Subscriber?(_this.syncErrorThrowable=destinationOrNext.syncErrorThrowable,_this.destination=destinationOrNext,destinationOrNext.add(_this)):(_this.syncErrorThrowable=!0,_this.destination=new SafeSubscriber(_this,destinationOrNext));break}default:_this.syncErrorThrowable=!0,_this.destination=new SafeSubscriber(_this,destinationOrNext,error,complete)}return _this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(Subscriber,_super),Subscriber.prototype[_internal_symbol_rxSubscriber__WEBPACK_IMPORTED_MODULE_4__.a]=function(){return this},Subscriber.create=function(next,error,complete){var subscriber=new Subscriber(next,error,complete);return subscriber.syncErrorThrowable=!1,subscriber},Subscriber.prototype.next=function(value){this.isStopped||this._next(value)},Subscriber.prototype.error=function(err){this.isStopped||(this.isStopped=!0,this._error(err))},Subscriber.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},Subscriber.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,_super.prototype.unsubscribe.call(this))},Subscriber.prototype._next=function(value){this.destination.next(value)},Subscriber.prototype._error=function(err){this.destination.error(err),this.unsubscribe()},Subscriber.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},Subscriber.prototype._unsubscribeAndRecycle=function(){var _parentOrParents=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=_parentOrParents,this},Subscriber}(_Subscription__WEBPACK_IMPORTED_MODULE_3__.a),SafeSubscriber=function(_super){function SafeSubscriber(_parentSubscriber,observerOrNext,error,complete){var next,_this=_super.call(this)||this;_this._parentSubscriber=_parentSubscriber;var context=_this;return Object(_util_isFunction__WEBPACK_IMPORTED_MODULE_1__.a)(observerOrNext)?next=observerOrNext:observerOrNext&&(next=observerOrNext.next,error=observerOrNext.error,complete=observerOrNext.complete,observerOrNext!==_Observer__WEBPACK_IMPORTED_MODULE_2__.a&&(context=Object.create(observerOrNext),Object(_util_isFunction__WEBPACK_IMPORTED_MODULE_1__.a)(context.unsubscribe)&&_this.add(context.unsubscribe.bind(context)),context.unsubscribe=_this.unsubscribe.bind(_this))),_this._context=context,_this._next=next,_this._error=error,_this._complete=complete,_this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(SafeSubscriber,_super),SafeSubscriber.prototype.next=function(value){if(!this.isStopped&&this._next){var _parentSubscriber=this._parentSubscriber;_config__WEBPACK_IMPORTED_MODULE_5__.a.useDeprecatedSynchronousErrorHandling&&_parentSubscriber.syncErrorThrowable?this.__tryOrSetError(_parentSubscriber,this._next,value)&&this.unsubscribe():this.__tryOrUnsub(this._next,value)}},SafeSubscriber.prototype.error=function(err){if(!this.isStopped){var _parentSubscriber=this._parentSubscriber,useDeprecatedSynchronousErrorHandling=_config__WEBPACK_IMPORTED_MODULE_5__.a.useDeprecatedSynchronousErrorHandling;if(this._error)useDeprecatedSynchronousErrorHandling&&_parentSubscriber.syncErrorThrowable?(this.__tryOrSetError(_parentSubscriber,this._error,err),this.unsubscribe()):(this.__tryOrUnsub(this._error,err),this.unsubscribe());else if(_parentSubscriber.syncErrorThrowable)useDeprecatedSynchronousErrorHandling?(_parentSubscriber.syncErrorValue=err,_parentSubscriber.syncErrorThrown=!0):Object(_util_hostReportError__WEBPACK_IMPORTED_MODULE_6__.a)(err),this.unsubscribe();else{if(this.unsubscribe(),useDeprecatedSynchronousErrorHandling)throw err;Object(_util_hostReportError__WEBPACK_IMPORTED_MODULE_6__.a)(err)}}},SafeSubscriber.prototype.complete=function(){var _this=this;if(!this.isStopped){var _parentSubscriber=this._parentSubscriber;if(this._complete){var wrappedComplete=function(){return _this._complete.call(_this._context)};_config__WEBPACK_IMPORTED_MODULE_5__.a.useDeprecatedSynchronousErrorHandling&&_parentSubscriber.syncErrorThrowable?(this.__tryOrSetError(_parentSubscriber,wrappedComplete),this.unsubscribe()):(this.__tryOrUnsub(wrappedComplete),this.unsubscribe())}else this.unsubscribe()}},SafeSubscriber.prototype.__tryOrUnsub=function(fn,value){try{fn.call(this._context,value)}catch(err){if(this.unsubscribe(),_config__WEBPACK_IMPORTED_MODULE_5__.a.useDeprecatedSynchronousErrorHandling)throw err;Object(_util_hostReportError__WEBPACK_IMPORTED_MODULE_6__.a)(err)}},SafeSubscriber.prototype.__tryOrSetError=function(parent,fn,value){if(!_config__WEBPACK_IMPORTED_MODULE_5__.a.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{fn.call(this._context,value)}catch(err){return _config__WEBPACK_IMPORTED_MODULE_5__.a.useDeprecatedSynchronousErrorHandling?(parent.syncErrorValue=err,parent.syncErrorThrown=!0,!0):(Object(_util_hostReportError__WEBPACK_IMPORTED_MODULE_6__.a)(err),!0)}return!1},SafeSubscriber.prototype._unsubscribe=function(){var _parentSubscriber=this._parentSubscriber;this._context=null,this._parentSubscriber=null,_parentSubscriber.unsubscribe()},SafeSubscriber}(Subscriber)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=CryptoJS||function(Math,undefined){var create=Object.create||function(){function F(){}return function(obj){var subtype;return F.prototype=obj,subtype=new F,F.prototype=null,subtype}}(),C={},C_lib=C.lib={},Base=C_lib.Base={extend:function(overrides){var subtype=create(this);return overrides&&subtype.mixIn(overrides),subtype.hasOwnProperty("init")&&this.init!==subtype.init||(subtype.init=function(){subtype.$super.init.apply(this,arguments)}),subtype.init.prototype=subtype,subtype.$super=this,subtype},create:function(){var instance=this.extend();return instance.init.apply(instance,arguments),instance},init:function(){},mixIn:function(properties){for(var propertyName in properties)properties.hasOwnProperty(propertyName)&&(this[propertyName]=properties[propertyName]);properties.hasOwnProperty("toString")&&(this.toString=properties.toString)},clone:function(){return this.init.prototype.extend(this)}},WordArray=C_lib.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:4*words.length},toString:function(encoder){return(encoder||Hex).stringify(this)},concat:function(wordArray){var thisWords=this.words,thatWords=wordArray.words,thisSigBytes=this.sigBytes,thatSigBytes=wordArray.sigBytes;if(this.clamp(),thisSigBytes%4)for(var i=0;i<thatSigBytes;i++){var thatByte=thatWords[i>>>2]>>>24-i%4*8&255;thisWords[thisSigBytes+i>>>2]|=thatByte<<24-(thisSigBytes+i)%4*8}else for(i=0;i<thatSigBytes;i+=4)thisWords[thisSigBytes+i>>>2]=thatWords[i>>>2];return this.sigBytes+=thatSigBytes,this},clamp:function(){var words=this.words,sigBytes=this.sigBytes;words[sigBytes>>>2]&=4294967295<<32-sigBytes%4*8,words.length=Math.ceil(sigBytes/4)},clone:function(){var clone=Base.clone.call(this);return clone.words=this.words.slice(0),clone},random:function(nBytes){for(var rcache,words=[],r=function(m_w){m_w=m_w;var m_z=987654321,mask=4294967295;return function(){var result=((m_z=36969*(65535&m_z)+(m_z>>16)&mask)<<16)+(m_w=18e3*(65535&m_w)+(m_w>>16)&mask)&mask;return result/=4294967296,(result+=.5)*(Math.random()>.5?1:-1)}},i=0;i<nBytes;i+=4){var _r=r(4294967296*(rcache||Math.random()));rcache=987654071*_r(),words.push(4294967296*_r()|0)}return new WordArray.init(words,nBytes)}}),C_enc=C.enc={},Hex=C_enc.Hex={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,hexChars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;hexChars.push((bite>>>4).toString(16)),hexChars.push((15&bite).toString(16))}return hexChars.join("")},parse:function(hexStr){for(var hexStrLength=hexStr.length,words=[],i=0;i<hexStrLength;i+=2)words[i>>>3]|=parseInt(hexStr.substr(i,2),16)<<24-i%8*4;return new WordArray.init(words,hexStrLength/2)}},Latin1=C_enc.Latin1={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,latin1Chars=[],i=0;i<sigBytes;i++){var bite=words[i>>>2]>>>24-i%4*8&255;latin1Chars.push(String.fromCharCode(bite))}return latin1Chars.join("")},parse:function(latin1Str){for(var latin1StrLength=latin1Str.length,words=[],i=0;i<latin1StrLength;i++)words[i>>>2]|=(255&latin1Str.charCodeAt(i))<<24-i%4*8;return new WordArray.init(words,latin1StrLength)}},Utf8=C_enc.Utf8={stringify:function(wordArray){try{return decodeURIComponent(escape(Latin1.stringify(wordArray)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(utf8Str){return Latin1.parse(unescape(encodeURIComponent(utf8Str)))}},BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm=Base.extend({reset:function(){this._data=new WordArray.init,this._nDataBytes=0},_append:function(data){"string"==typeof data&&(data=Utf8.parse(data)),this._data.concat(data),this._nDataBytes+=data.sigBytes},_process:function(doFlush){var data=this._data,dataWords=data.words,dataSigBytes=data.sigBytes,blockSize=this.blockSize,nBlocksReady=dataSigBytes/(4*blockSize),nWordsReady=(nBlocksReady=doFlush?Math.ceil(nBlocksReady):Math.max((0|nBlocksReady)-this._minBufferSize,0))*blockSize,nBytesReady=Math.min(4*nWordsReady,dataSigBytes);if(nWordsReady){for(var offset=0;offset<nWordsReady;offset+=blockSize)this._doProcessBlock(dataWords,offset);var processedWords=dataWords.splice(0,nWordsReady);data.sigBytes-=nBytesReady}return new WordArray.init(processedWords,nBytesReady)},clone:function(){var clone=Base.clone.call(this);return clone._data=this._data.clone(),clone},_minBufferSize:0}),C_algo=(C_lib.Hasher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),init:function(cfg){this.cfg=this.cfg.extend(cfg),this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},update:function(messageUpdate){return this._append(messageUpdate),this._process(),this},finalize:function(messageUpdate){return messageUpdate&&this._append(messageUpdate),this._doFinalize()},blockSize:16,_createHelper:function(hasher){return function(message,cfg){return new hasher.init(cfg).finalize(message)}},_createHmacHelper:function(hasher){return function(message,key){return new C_algo.HMAC.init(hasher,key).finalize(message)}}}),C.algo={});return C}(Math),CryptoJS)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return Subscription}));var _util_isArray__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),_util_isObject__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(50),_util_isFunction__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(35),_util_UnsubscriptionError__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(42),Subscription=function(){function Subscription(unsubscribe){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,unsubscribe&&(this._ctorUnsubscribe=!0,this._unsubscribe=unsubscribe)}var empty;return Subscription.prototype.unsubscribe=function(){var errors;if(!this.closed){var _parentOrParents=this._parentOrParents,_ctorUnsubscribe=this._ctorUnsubscribe,_unsubscribe=this._unsubscribe,_subscriptions=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,_parentOrParents instanceof Subscription)_parentOrParents.remove(this);else if(null!==_parentOrParents)for(var index=0;index<_parentOrParents.length;++index){_parentOrParents[index].remove(this)}if(Object(_util_isFunction__WEBPACK_IMPORTED_MODULE_2__.a)(_unsubscribe)){_ctorUnsubscribe&&(this._unsubscribe=void 0);try{_unsubscribe.call(this)}catch(e){errors=e instanceof _util_UnsubscriptionError__WEBPACK_IMPORTED_MODULE_3__.a?flattenUnsubscriptionErrors(e.errors):[e]}}if(Object(_util_isArray__WEBPACK_IMPORTED_MODULE_0__.a)(_subscriptions)){index=-1;for(var len=_subscriptions.length;++index<len;){var sub=_subscriptions[index];if(Object(_util_isObject__WEBPACK_IMPORTED_MODULE_1__.a)(sub))try{sub.unsubscribe()}catch(e){errors=errors||[],e instanceof _util_UnsubscriptionError__WEBPACK_IMPORTED_MODULE_3__.a?errors=errors.concat(flattenUnsubscriptionErrors(e.errors)):errors.push(e)}}}if(errors)throw new _util_UnsubscriptionError__WEBPACK_IMPORTED_MODULE_3__.a(errors)}},Subscription.prototype.add=function(teardown){var subscription=teardown;if(!teardown)return Subscription.EMPTY;switch(typeof teardown){case"function":subscription=new Subscription(teardown);case"object":if(subscription===this||subscription.closed||"function"!=typeof subscription.unsubscribe)return subscription;if(this.closed)return subscription.unsubscribe(),subscription;if(!(subscription instanceof Subscription)){var tmp=subscription;(subscription=new Subscription)._subscriptions=[tmp]}break;default:throw new Error("unrecognized teardown "+teardown+" added to Subscription.")}var _parentOrParents=subscription._parentOrParents;if(null===_parentOrParents)subscription._parentOrParents=this;else if(_parentOrParents instanceof Subscription){if(_parentOrParents===this)return subscription;subscription._parentOrParents=[_parentOrParents,this]}else{if(-1!==_parentOrParents.indexOf(this))return subscription;_parentOrParents.push(this)}var subscriptions=this._subscriptions;return null===subscriptions?this._subscriptions=[subscription]:subscriptions.push(subscription),subscription},Subscription.prototype.remove=function(subscription){var subscriptions=this._subscriptions;if(subscriptions){var subscriptionIndex=subscriptions.indexOf(subscription);-1!==subscriptionIndex&&subscriptions.splice(subscriptionIndex,1)}},Subscription.EMPTY=((empty=new Subscription).closed=!0,empty),Subscription}();function flattenUnsubscriptionErrors(errors){return errors.reduce((function(errs,err){return errs.concat(err instanceof _util_UnsubscriptionError__WEBPACK_IMPORTED_MODULE_3__.a?err.errors:err)}),[])}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=text=>{if(!text)return null;if(config&&config.debug)return text;let result="";return 0===text.indexOf("+")&&(result="+"),result=text.length>4?result+"*".repeat(text.length-4-result.length)+text.slice(text.length-4):text,result}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LoggerService=void 0;const settings_service_1=__webpack_require__(5);class LoggerService{constructor(){this.colors={trace:"blue",debug:"gray",info:"teal",log:"teal",warn:"red",error:"red",webrtc:"green"},this.logsBuffer=[],this.enableConsoleLog=!1,this.desktopMode=!1;window.LoggerService=this,this.computeConsoleStatus(),settings_service_1.default.subscribeUpdateEvent("SETTINGS_UPDATED",()=>{this.computeConsoleStatus()});const ua=navigator.userAgent.toLowerCase();this.desktopMode=ua.indexOf("qtwebengine")>-1||ua.indexOf("electron/")>-1}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.loggerService||(win.rainbow.loggerService=new LoggerService),win.rainbow.loggerService}computeConsoleStatus(){"true"===settings_service_1.default.getSetting("forceConsoleLog")?this.enableConsoleLog=!0:this.enableConsoleLog=window.config&&window.config.consoleLog||!1}error(message){this.logger("error",message)}warn(message){this.logger("warn",message)}info(message){this.logger("info",message)}log(message){this.logger("log",message)}debug(message){this.logger("debug",message)}getLogs(){return this.logsBuffer}logger(level,text){if(this.desktopMode)console[level](`${level.toUpperCase()} ${text}`);else{const message=`${(new Date).toISOString()} ${level.toUpperCase()} ${text}`;this.enableConsoleLog&&console[level]("%c "+message,"color:"+this.colors[level]),6e3===this.logsBuffer.length&&this.logsBuffer.shift(),this.logsBuffer.push(message+"\n")}}}exports.LoggerService=LoggerService,exports.default=LoggerService.getInstance()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnswerMessage=exports.Message=void 0;const rxjs_1=__webpack_require__(10),replaceMsg_1=__webpack_require__(222);class Message{constructor(id,type,date,from,side,data,status,fileId=null,isMarkdown=null,additionalContent=null,subject=null,fileName=null,answeredMsgId=null,answeredMsgDate=null,geoloc=null,alternativeContent=null,attention=null){this.urgencyAck=!1,this.urgencyHandler=null,this.translatedText=null,this.historyIndex=null,this.fileErrorMsg=null,this.attachedMsgId=null,this.forwardedMsg=null,this.id=id,this.type=type,this.date=date,this.from=from,this.side=side;const toShort=emojione?emojione.toShort:text=>text;this.data=toShort(data),this.status=status,this.fileId=fileId,this.isMarkdown=isMarkdown,this.additionalContent=additionalContent,this.subject=subject,this.fileName=fileName,this.answeredMsgId=answeredMsgId,this.answeredMsgDate=answeredMsgDate,this.geoloc=geoloc,this.alternativeContent=alternativeContent,this.attention=attention,this.receiptStatus=Message.ReceiptStatus.NONE,this.serverAckTimer=null,this.index=null,this.showCorrectedMessages=!1,this.replaceMsgs=[],this.rxSubject=new rxjs_1.Subject,this.isMerged=!1}static create(id,date,from,side,data,status,isMarkdown=!1,additionalContent=null,subject=null,answeredMsgId=null,answeredMsgDate=null,alternativeContent=null,attention=null){const type=additionalContent&&additionalContent["form/json"]?Message.Type.FORM:Message.Type.CHAT;return new Message(id,type,date,from,side,data,status,null,isMarkdown,additionalContent,subject,null,answeredMsgId,answeredMsgDate,null,alternativeContent,attention)}static createFromMsg(origMsg){const message=Message.create(origMsg.id,origMsg.date,origMsg.from,origMsg.side,origMsg.data,origMsg.status,origMsg.isMarkdown);return origMsg.fileId&&(message.type=Message.Type.FS,message.fileId=origMsg.fileId,message.fileName=origMsg.fileName),origMsg.geoloc&&(message.geoloc=origMsg.geoloc),message}static createFileSharingMessage(id,date,from,side,data,status,fileId,fileName,attachedInfos,geoloc,attention=null){const msg=new Message(id,Message.Type.FS,date,from,side,data,status,fileId,null,null,null,fileName,null,null,geoloc,null,attention);return attachedInfos&&(msg.attachedMsgId=attachedInfos.attachedMsgId,msg.attachIndex=attachedInfos.index,msg.attachNumber=attachedInfos.number),msg}static createFileMessage(id,date,from,side,data,status){return new Message(id,Message.Type.FILE,date,from,side,data,status)}static createWebRTCMessage(id,date,from,side,data,status){return new Message(id,Message.Type.WEBRTC,date,from,side,data,status)}static createBubbleAdminMessage(id,date,from,type){return new Message(id,Message.Type.CHAT,date,from,Message.Side.ADMIN,type+"MsgRoom",null)}static createRecordingAdminMessage(id,date,from,type,cmd){return new Message(id,Message.Type.RECORDING,date,from,Message.Side.ADMIN,cmd+"Recording",null)}sendUpdateEvent(data=null){this.rxSubject.next(data)}listenUpdateEvent(callback){return this.rxSubject.subscribe(callback)}isTextModified(){return this.replaceMsgs.length>0}isModified(){return this.replaceMsgs.length>0&&""!==this.getLastTextModified()}isDeleted(){return 0===this.getLastTextModified().length}getLastTextModified(){return this.replaceMsgs.length>0?this.replaceMsgs[this.replaceMsgs.length-1].body:this.data}addReplaceMsg(messageId,replacedMsgBody){const replacedMsg=replaceMsg_1.ReplaceMsg.create(messageId,replacedMsgBody);this.replaceMsgs.push(replacedMsg)}setReceiptStatus(receiptStatus){return this.serverAckTimer&&receiptStatus>Message.ReceiptStatus.IN_PROGRESS&&(clearTimeout(this.serverAckTimer),this.serverAckTimer=null),receiptStatus>this.receiptStatus&&(this.receiptStatus=receiptStatus),this}getInfoForLogs(){const body=this.data.length?this.data.substr(0,1)+"***"+this.data.substr(this.data.length-1):"";return"Id "+this.id+", type "+this.type.value+", side "+this.side+", date "+this.date+" and data "+body}}exports.Message=Message,Message.Type={CHAT:{key:0,value:"Chat"},FILE:{key:1,value:"File"},FS:{key:2,value:"FileSharing"},WEBRTC:{key:4,value:"WebRTC CAll"},RECORDING:{key:5,value:"Recording"},FORM:{key:6,value:"FORM"},FORWARD:{key:7,value:"FORWARD"}},Message.ReceiptStatus={NONE:0,ERROR:1,IN_PROGRESS:2,SENT:3,UNREAD:4,READ:5},Message.ReceiptStatusText=["close","info","calllog","check","done","read"],Message.Side={LEFT:"L",RIGHT:"R",ADMIN:"ADMIN"};exports.AnswerMessage=class{constructor(name,messageAnswered,answeredMessageData){this.name=name,this.messageAnswered=messageAnswered,this.answeredMessageData=answeredMessageData}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return isArray}));var isArray=function(){return Array.isArray||function(x){return x&&"number"==typeof x.length}}()},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(60),__webpack_require__(277),__webpack_require__(278),__webpack_require__(46),__webpack_require__(47),__webpack_require__(72),__webpack_require__(217),__webpack_require__(279),__webpack_require__(218),__webpack_require__(280),__webpack_require__(281),__webpack_require__(282),__webpack_require__(73),__webpack_require__(283),__webpack_require__(40),__webpack_require__(20),__webpack_require__(284),__webpack_require__(285),__webpack_require__(286),__webpack_require__(287),__webpack_require__(288),__webpack_require__(289),__webpack_require__(290),__webpack_require__(291),__webpack_require__(292),__webpack_require__(293),__webpack_require__(294),__webpack_require__(295),__webpack_require__(296),__webpack_require__(297),__webpack_require__(298),__webpack_require__(299),CryptoJS)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Company=void 0;const rxjs_1=__webpack_require__(10);class Company{constructor(data){this.logo=null,this.nameForLogs="",this.banner=null,this.office365ScopesGranted=[],this.visibility="public",Company.attributes.forEach(attribute=>{void 0!==data[attribute.name]?this[attribute.name]=data[attribute.name]:void 0!==attribute.defaultValue&&(this[attribute.name]=attribute.defaultValue)}),this.state=data.state?data.state:"USA"===data.country?"AL":"CAN"===data.country?"AB":null,this.name&&(this.filterName=this.name.toLowerCase()),this.rxSubject=new rxjs_1.Subject}static create(id,name){return new Company({id:id,name:name})}static createFromData(data){return new Company(data)}static prune(data,userContact){let dataCopy=Object.assign({},data);return delete dataCopy.dataLocation,delete dataCopy.businessSpecific,delete dataCopy.giphyEnabled,dataCopy.isBP||(delete dataCopy.bpType,delete dataCopy.bpBusinessModel,delete dataCopy.bpApplicantNumber,delete dataCopy.bpCRDid,delete dataCopy.bpHasRightToSell,delete dataCopy.bpHasRightToConnect,delete dataCopy.bpIsContractAccepted),""===dataCopy.economicActivityClassification&&delete dataCopy.economicActivityClassification,userContact&&(userContact.isSuperadmin()||userContact.isBPAdminFinance())||(delete dataCopy.bpType,delete dataCopy.adminHasRightToUpdateSubscriptions,delete dataCopy.adminAllowedUpdateSubscriptionsOps),userContact&&userContact.isSuperadmin()||delete dataCopy.superadminComment,userContact&&(userContact.isSuperadmin()||null!==dataCopy.supportEmail&&""!==dataCopy.supportEmail)||delete dataCopy.supportEmail,userContact&&(userContact.isSuperadmin()||null!==dataCopy.privateDC&&""!==dataCopy.privateDC)||delete dataCopy.privateDC,dataCopy}updateFromData(data){Company.attributes.forEach(attribute=>{void 0!==data[attribute.name]&&(this[attribute.name]=data[attribute.name])})}getNameForLogs(){return!this.nameForLogs&&this.name&&(this.nameForLogs=this.name.charAt(0)+this.name.replace(/[^\s](?=.{1,}$)/g,"*").substr(1)),this.nameForLogs}isActive(){return"active"===this.status}isInitializing(){return"initializing"===this.status}isInvited(){return"invited"===this.status}isFreemium(){return"freemium"===this.offerType}isPremium(){return"premium"===this.offerType}isVAD(){return this.isBP&&"VAD"===this.bpType}isIR(){return this.isBP&&"IR"===this.bpType}isDR(){return this.isBP&&"DR"===this.bpType}isEC(){return!this.isBP}onChange(callback){return this.rxSubject.subscribe(callback)}sendChangeEvent(type,value=null){this.rxSubject.next({type:type,value:value})}}exports.Company=Company,Company.StatusValues=["initializing","active","alerting","hold","terminated"],Company.VisibilityValuesWithOrganization=["public","private","organization","closed","isolated"],Company.VisibilityValues=["public","private","closed","isolated"],Company.SizeValues=["self-employed","1-10 employees","11-50 employees","51-200 employees","201-500 employees","501-1000 employees","1001-5000 employees","5001-10,000 employees","10,001+ employees"],Company.OfferTypes=["freemium","premium"],Company.BPTypes=["VAD","DR","IR"],Company.BPTypeLabels={IR:"Indirect Reseller",VAD:"Value Added Distributor",DR:"Direct Reseller"},Company.BPBusinessModels=["resell"],Company.BPBusinessModelLabels={resell:"Resell",referral:"Referral"},Company.adminAllowedUpdateSubscriptionsOperations=["all","increase_only"],Company.BPBusinessTypes={DEFAULT:"default",VOICE_BY_ALE:"voice_by_ale",VOICE_BY_PARTNER:"voice_by_partner",CONFERENCE:"conference"},Company.EconomicActivityClassificationTypes={NONE:"notDefined-f",A:"agriculture",B:"mining",C:"manufacturing",D:"electricity",E:"water supply",F:"construction",G:"wholesale",H:"transportation",I:"accommodation",J:"information and communication",K:"financial",L:"real estate activities",M:"professional",N:"administrative",O:"public administration",P:"education",Q:"human health",R:"arts",S:"other service activities",T:"activities of households as employer",U:"activities of extraterritorial organisations and bodies"},Company.PrivateDCValues=["HDS"],Company.attributes=[{name:"id",defaultValue:void 0},{name:"name",defaultValue:""},{name:"creationDate",defaultValue:void 0},{name:"companyContactId",defaultValue:void 0},{name:"adminEmail",defaultValue:""},{name:"supportEmail",defaultValue:void 0},{name:"status",defaultValue:"active"},{name:"economicActivityClassification",defaultValue:"NONE"},{name:"website",defaultValue:void 0},{name:"description",defaultValue:void 0},{name:"visibility",defaultValue:"private"},{name:"visibleBy",defaultValue:[]},{name:"organisationId",defaultValue:""},{name:"userSelfRegisterEnabled",defaultValue:!1},{name:"userSelfRegisterAllowedDomains",defaultValue:[]},{name:"offerType",defaultValue:"freemium"},{name:"street",defaultValue:void 0},{name:"city",defaultValue:void 0},{name:"postalCode",defaultValue:void 0},{name:"country",defaultValue:void 0},{name:"state",defaultValue:null},{name:"size",defaultValue:void 0},{name:"slogan",defaultValue:void 0},{name:"isBP",defaultValue:!1},{name:"bpType",defaultValue:void 0},{name:"bpBusinessModel",defaultValue:void 0},{name:"bpApplicantNumber",defaultValue:void 0},{name:"bpCRDid",defaultValue:void 0},{name:"bpHasRightToSell",defaultValue:void 0},{name:"bpId",defaultValue:void 0},{name:"bpHasRightToConnect",defaultValue:void 0},{name:"adminHasRightToUpdateSubscriptions",defaultValue:!1},{name:"adminAllowedUpdateSubscriptionsOps",defaultValue:"all"},{name:"externalReference",defaultValue:void 0},{name:"externalReference2",defaultValue:void 0},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"lastBannerUpdateDate",defaultValue:null},{name:"avatarShape",defaultValue:"circle"},{name:"catalogId",defaultValue:void 0},{name:"office365Tenant",defaultValue:void 0},{name:"office365ScopesGranted",defaultValue:void 0},{name:"isCentrex",defaultValue:void 0},{name:"tenantCallNumber",defaultValue:void 0},{name:"tenantName",defaultValue:void 0},{name:"numberUsers",defaultValue:void 0},{name:"dataLocation",defaultValue:void 0},{name:"privateDC",defaultValue:void 0},{name:"businessSpecific",defaultValue:void 0},{name:"superadminComment",defaultValue:void 0},{name:"bpBusinessType",defaultValue:[]},{name:"voIPSettings",defaultValue:void 0},{name:"allowUsersSelectTheme",defaultValue:!0},{name:"allowUsersSelectPublicTheme",defaultValue:!0},{name:"selectedTheme",defaultValue:void 0},{name:"tryNewUiCustomisation",defaultValue:void 0},{name:"softphoneOnlyCustomisation",defaultValue:void 0},{name:"fileSharingCustomisation",defaultValue:"enabled"},{name:"userTitleNameCustomisation",defaultValue:void 0},{name:"useRoomCustomisation",defaultValue:"enabled"},{name:"phoneMeetingCustomisation",defaultValue:"enabled"},{name:"useChannelCustomisation",defaultValue:"enabled"},{name:"useWebRTCVideoCustomisation",defaultValue:"enabled"},{name:"useWebRTCAudioCustomisation",defaultValue:"enabled"},{name:"instantMessagesCustomisation",defaultValue:"enabled"},{name:"userProfileCustomisation",defaultValue:"enabled"},{name:"fileStorageCustomisation",defaultValue:"enabled"},{name:"overridePresenceCustomisation",defaultValue:"enabled"},{name:"changeSettingsCustomisation",defaultValue:"enabled"},{name:"changeTelephonyCustomisation",defaultValue:"enabled"},{name:"recordingConversationCustomisation",defaultValue:"enabled"},{name:"useGifCustomisation",defaultValue:"enabled"},{name:"useDialOutCustomisation",defaultValue:"enabled"},{name:"selectedAppCustomisationTemplate",defaultValue:void 0},{name:"mobilePermanentConnectionMode",defaultValue:void 0}]},function(module,exports,__webpack_require__){var CryptoJS,C,C_lib,Base,WordArray,BufferedBlockAlgorithm,C_enc,Base64,EvpKDF,Cipher,C_mode,BlockCipherMode,CBC,Pkcs7,CipherParams,OpenSSLFormatter,SerializableCipher,OpenSSLKdf,PasswordBasedCipher;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(40),void(CryptoJS.lib.Cipher||(C=CryptoJS,C_lib=C.lib,Base=C_lib.Base,WordArray=C_lib.WordArray,BufferedBlockAlgorithm=C_lib.BufferedBlockAlgorithm,C_enc=C.enc,C_enc.Utf8,Base64=C_enc.Base64,EvpKDF=C.algo.EvpKDF,Cipher=C_lib.Cipher=BufferedBlockAlgorithm.extend({cfg:Base.extend(),createEncryptor:function(key,cfg){return this.create(this._ENC_XFORM_MODE,key,cfg)},createDecryptor:function(key,cfg){return this.create(this._DEC_XFORM_MODE,key,cfg)},init:function(xformMode,key,cfg){this.cfg=this.cfg.extend(cfg),this._xformMode=xformMode,this._key=key,this.reset()},reset:function(){BufferedBlockAlgorithm.reset.call(this),this._doReset()},process:function(dataUpdate){return this._append(dataUpdate),this._process()},finalize:function(dataUpdate){return dataUpdate&&this._append(dataUpdate),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(key){return"string"==typeof key?PasswordBasedCipher:SerializableCipher}return function(cipher){return{encrypt:function(message,key,cfg){return selectCipherStrategy(key).encrypt(cipher,message,key,cfg)},decrypt:function(ciphertext,key,cfg){return selectCipherStrategy(key).decrypt(cipher,ciphertext,key,cfg)}}}}()}),C_lib.StreamCipher=Cipher.extend({_doFinalize:function(){return this._process(!0)},blockSize:1}),C_mode=C.mode={},BlockCipherMode=C_lib.BlockCipherMode=Base.extend({createEncryptor:function(cipher,iv){return this.Encryptor.create(cipher,iv)},createDecryptor:function(cipher,iv){return this.Decryptor.create(cipher,iv)},init:function(cipher,iv){this._cipher=cipher,this._iv=iv}}),CBC=C_mode.CBC=function(){var CBC=BlockCipherMode.extend();function xorBlock(words,offset,blockSize){var iv=this._iv;if(iv){var block=iv;this._iv=void 0}else block=this._prevBlock;for(var i=0;i<blockSize;i++)words[offset+i]^=block[i]}return CBC.Encryptor=CBC.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize;xorBlock.call(this,words,offset,blockSize),cipher.encryptBlock(words,offset),this._prevBlock=words.slice(offset,offset+blockSize)}}),CBC.Decryptor=CBC.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,thisBlock=words.slice(offset,offset+blockSize);cipher.decryptBlock(words,offset),xorBlock.call(this,words,offset,blockSize),this._prevBlock=thisBlock}}),CBC}(),Pkcs7=(C.pad={}).Pkcs7={pad:function(data,blockSize){for(var blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-data.sigBytes%blockSizeBytes,paddingWord=nPaddingBytes<<24|nPaddingBytes<<16|nPaddingBytes<<8|nPaddingBytes,paddingWords=[],i=0;i<nPaddingBytes;i+=4)paddingWords.push(paddingWord);var padding=WordArray.create(paddingWords,nPaddingBytes);data.concat(padding)},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},C_lib.BlockCipher=Cipher.extend({cfg:Cipher.cfg.extend({mode:CBC,padding:Pkcs7}),reset:function(){Cipher.reset.call(this);var cfg=this.cfg,iv=cfg.iv,mode=cfg.mode;if(this._xformMode==this._ENC_XFORM_MODE)var modeCreator=mode.createEncryptor;else modeCreator=mode.createDecryptor,this._minBufferSize=1;this._mode&&this._mode.__creator==modeCreator?this._mode.init(this,iv&&iv.words):(this._mode=modeCreator.call(mode,this,iv&&iv.words),this._mode.__creator=modeCreator)},_doProcessBlock:function(words,offset){this._mode.processBlock(words,offset)},_doFinalize:function(){var padding=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){padding.pad(this._data,this.blockSize);var finalProcessedBlocks=this._process(!0)}else finalProcessedBlocks=this._process(!0),padding.unpad(finalProcessedBlocks);return finalProcessedBlocks},blockSize:4}),CipherParams=C_lib.CipherParams=Base.extend({init:function(cipherParams){this.mixIn(cipherParams)},toString:function(formatter){return(formatter||this.formatter).stringify(this)}}),OpenSSLFormatter=(C.format={}).OpenSSL={stringify:function(cipherParams){var ciphertext=cipherParams.ciphertext,salt=cipherParams.salt;if(salt)var wordArray=WordArray.create([1398893684,1701076831]).concat(salt).concat(ciphertext);else wordArray=ciphertext;return wordArray.toString(Base64)},parse:function(openSSLStr){var ciphertext=Base64.parse(openSSLStr),ciphertextWords=ciphertext.words;if(1398893684==ciphertextWords[0]&&1701076831==ciphertextWords[1]){var salt=WordArray.create(ciphertextWords.slice(2,4));ciphertextWords.splice(0,4),ciphertext.sigBytes-=16}return CipherParams.create({ciphertext:ciphertext,salt:salt})}},SerializableCipher=C_lib.SerializableCipher=Base.extend({cfg:Base.extend({format:OpenSSLFormatter}),encrypt:function(cipher,message,key,cfg){cfg=this.cfg.extend(cfg);var encryptor=cipher.createEncryptor(key,cfg),ciphertext=encryptor.finalize(message),cipherCfg=encryptor.cfg;return CipherParams.create({ciphertext:ciphertext,key:key,iv:cipherCfg.iv,algorithm:cipher,mode:cipherCfg.mode,padding:cipherCfg.padding,blockSize:cipher.blockSize,formatter:cfg.format})},decrypt:function(cipher,ciphertext,key,cfg){return cfg=this.cfg.extend(cfg),ciphertext=this._parse(ciphertext,cfg.format),cipher.createDecryptor(key,cfg).finalize(ciphertext.ciphertext)},_parse:function(ciphertext,format){return"string"==typeof ciphertext?format.parse(ciphertext,this):ciphertext}}),OpenSSLKdf=(C.kdf={}).OpenSSL={execute:function(password,keySize,ivSize,salt){salt||(salt=WordArray.random(8));var key=EvpKDF.create({keySize:keySize+ivSize}).compute(password,salt),iv=WordArray.create(key.words.slice(keySize),4*ivSize);return key.sigBytes=4*keySize,CipherParams.create({key:key,iv:iv,salt:salt})}},PasswordBasedCipher=C_lib.PasswordBasedCipher=SerializableCipher.extend({cfg:SerializableCipher.cfg.extend({kdf:OpenSSLKdf}),encrypt:function(cipher,message,password,cfg){var derivedParams=(cfg=this.cfg.extend(cfg)).kdf.execute(password,cipher.keySize,cipher.ivSize);cfg.iv=derivedParams.iv;var ciphertext=SerializableCipher.encrypt.call(this,cipher,message,derivedParams.key,cfg);return ciphertext.mixIn(derivedParams),ciphertext},decrypt:function(cipher,ciphertext,password,cfg){cfg=this.cfg.extend(cfg),ciphertext=this._parse(ciphertext,cfg.format);var derivedParams=cfg.kdf.execute(password,cipher.keySize,cipher.ivSize,ciphertext.salt);return cfg.iv=derivedParams.iv,SerializableCipher.decrypt.call(this,cipher,ciphertext,derivedParams.key,cfg)}}))))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return config}));var _enable_super_gross_mode_that_will_cause_bad_things=!1,config={Promise:void 0,set useDeprecatedSynchronousErrorHandling(value){value&&(new Error).stack;_enable_super_gross_mode_that_will_cause_bad_things=value},get useDeprecatedSynchronousErrorHandling(){return _enable_super_gross_mode_that_will_cause_bad_things}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.eventsService=void 0;const eventsService=new class{dispatchEvent(eventName,eventDetail=null){document.dispatchEvent(new CustomEvent(eventName,{detail:eventDetail}))}};exports.eventsService=eventsService},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"b",(function(){return SubjectSubscriber})),__webpack_require__.d(__webpack_exports__,"a",(function(){return Subject}));var tslib__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6),_Observable__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(7),_Subscriber__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(11),_Subscription__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(13),_util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(30),_SubjectSubscription__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(62),_internal_symbol_rxSubscriber__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(41),SubjectSubscriber=function(_super){function SubjectSubscriber(destination){var _this=_super.call(this,destination)||this;return _this.destination=destination,_this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(SubjectSubscriber,_super),SubjectSubscriber}(_Subscriber__WEBPACK_IMPORTED_MODULE_2__.a),Subject=function(_super){function Subject(){var _this=_super.call(this)||this;return _this.observers=[],_this.closed=!1,_this.isStopped=!1,_this.hasError=!1,_this.thrownError=null,_this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(Subject,_super),Subject.prototype[_internal_symbol_rxSubscriber__WEBPACK_IMPORTED_MODULE_6__.a]=function(){return new SubjectSubscriber(this)},Subject.prototype.lift=function(operator){var subject=new AnonymousSubject(this,this);return subject.operator=operator,subject},Subject.prototype.next=function(value){if(this.closed)throw new _util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_4__.a;if(!this.isStopped)for(var observers=this.observers,len=observers.length,copy=observers.slice(),i=0;i<len;i++)copy[i].next(value)},Subject.prototype.error=function(err){if(this.closed)throw new _util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_4__.a;this.hasError=!0,this.thrownError=err,this.isStopped=!0;for(var observers=this.observers,len=observers.length,copy=observers.slice(),i=0;i<len;i++)copy[i].error(err);this.observers.length=0},Subject.prototype.complete=function(){if(this.closed)throw new _util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_4__.a;this.isStopped=!0;for(var observers=this.observers,len=observers.length,copy=observers.slice(),i=0;i<len;i++)copy[i].complete();this.observers.length=0},Subject.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},Subject.prototype._trySubscribe=function(subscriber){if(this.closed)throw new _util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_4__.a;return _super.prototype._trySubscribe.call(this,subscriber)},Subject.prototype._subscribe=function(subscriber){if(this.closed)throw new _util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_4__.a;return this.hasError?(subscriber.error(this.thrownError),_Subscription__WEBPACK_IMPORTED_MODULE_3__.a.EMPTY):this.isStopped?(subscriber.complete(),_Subscription__WEBPACK_IMPORTED_MODULE_3__.a.EMPTY):(this.observers.push(subscriber),new _SubjectSubscription__WEBPACK_IMPORTED_MODULE_5__.a(this,subscriber))},Subject.prototype.asObservable=function(){var observable=new _Observable__WEBPACK_IMPORTED_MODULE_1__.a;return observable.source=this,observable},Subject.create=function(destination,source){return new AnonymousSubject(destination,source)},Subject}(_Observable__WEBPACK_IMPORTED_MODULE_1__.a),AnonymousSubject=function(_super){function AnonymousSubject(destination,source){var _this=_super.call(this)||this;return _this.destination=destination,_this.source=source,_this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(AnonymousSubject,_super),AnonymousSubject.prototype.next=function(value){var destination=this.destination;destination&&destination.next&&destination.next(value)},AnonymousSubject.prototype.error=function(err){var destination=this.destination;destination&&destination.error&&this.destination.error(err)},AnonymousSubject.prototype.complete=function(){var destination=this.destination;destination&&destination.complete&&this.destination.complete()},AnonymousSubject.prototype._subscribe=function(subscriber){return this.source?this.source.subscribe(subscriber):_Subscription__WEBPACK_IMPORTED_MODULE_3__.a.EMPTY},AnonymousSubject}(Subject)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RBEvent=void 0;class RBEvent{constructor(name,data){this.name=null,this.data=null,this.name=name,this.data=data}static create(name,data=null){return new RBEvent(name,data)}}exports.RBEvent=RBEvent},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileStorageService=void 0;const fileDescriptor_1=__webpack_require__(65),fileViewer_1=__webpack_require__(71),rxjs_1=__webpack_require__(10),filePublicDownload_1=__webpack_require__(330),distinctUntilChanged_1=__webpack_require__(75),logger_service_1=__webpack_require__(15),contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),event_service_1=__webpack_require__(32),errorHelper_service_1=__webpack_require__(39);class FileStorageService{constructor(){this.started=!1,this.listeners=[],this.currentOrder="date",this.voiceMessageFileDescriptors=[],this.fileDescriptors=[],this.receivedFileDescriptors=[],this.mergedFileDescriptors=[],this.contactService=contact_service_1.default,this.logger=logger_service_1.default,this.errorHelperService=errorHelper_service_1.default,this.eventService=event_service_1.default,this.deleteFileWoConfirm=!1,this.fileDescriptorsSubject=null,this.publicFileDownload=[],this.publicFileDownloadSubject=null,this.startedSubject=new rxjs_1.BehaviorSubject(!1),this.retrieveFileDescriptorPromises=[],this.authService=auth_service_1.default}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.fileStorageService||(win.rainbow.fileStorageService=new FileStorageService),win.rainbow.fileStorageService}start(){return __awaiter(this,void 0,void 0,(function*(){this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/filestorage/v1.0/files",this.fileDescriptors=[],this.receivedFileDescriptors=[],this.mergedFileDescriptors=[],this.voiceMessageFileDescriptors=[],this.fileDescriptorsSubject=new rxjs_1.Subject,this.publicFileDownload=[],this.publicFileDownloadSubject=new rxjs_1.Subject,this.contactService.userContact.fileStorageEnabledSubject.pipe(distinctUntilChanged_1.distinctUntilChanged()).subscribe(fileStorageEnabled=>__awaiter(this,void 0,void 0,(function*(){if(fileStorageEnabled){this.logger.info("[FileStorageService] === STARTING ===");try{this.consumptionData={},yield this.getFileDescriptorsFromServer(),this.started=!0,this.logger.info("[FileStorageService] === STARTED ==="),this.startedSubject.next(!0),this.contactService.userContact.fileStorageEnabledSubject.pipe(distinctUntilChanged_1.distinctUntilChanged()).subscribe(fileStorageEnable=>{fileStorageEnable||this.stop()})}catch(error){this.logger.error("[FileStorageService] === STARTING === failure -- "+error.message),this.startedSubject.next(!1)}this.retrieveUserConsumption(),this.retrieveVoiceMessageFileDescriptorsListPerOwner().then(()=>{this.logger.info("[FileStorageService] === STARTED (retrieveVoiceMessageFileDescriptorsListPerOwner)")}).catch(()=>{this.logger.error("[FileStorageService] === STARTING === failure -- (retrieveVoiceMessageFileDescriptorsListPerOwner)")}),this.listeners.push(this.eventService.subscribe("ROOM_UPDATE_EVENT",(__event,room,action)=>{action&&"remove"===action&&(this.logger.info("[FileStorageService] ROOM_UPDATE_EVENT REMOVED for roomId="+room.dbId),this.removeRoomFileViewer(room))}))}else this.logger.info("start skipped - fileStorageEnabled : false")})))}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("[FileStorageService] === STOPPING ==="),this.started&&(this.started=!1),this.listeners&&this.listeners.forEach(unregisterListener=>{unregisterListener()}),this.logger.info("[FileStorageService] === STOPPED ==="),this.startedSubject.next(!1)}))}reinit(isBlocking){return __awaiter(this,void 0,void 0,(function*(){this.contactService&&this.contactService.userContact&&!this.contactService.userContact.fileStorageEnabled?this.logger.info("reinit skipped - fileStorageEnabled : "+this.contactService.userContact.fileStorageEnabled):isBlocking?yield this.reinitInternal():this.reinitInternal()}))}reinitInternal(){return __awaiter(this,void 0,void 0,(function*(){try{yield this.retrieveFileDescriptorsListPerOwner(),yield this.retrieveReceivedFiles(this.contactService.userContact.dbId),this.orderDocuments(),this.logger.info("[FileStorageService] reinitInternal done")}catch(error){throw this.logger.error("[FileStorageService] reinitInternal failure -- "+error.message),error}}))}removeRoomFileViewer(room){if(this.contactService&&this.contactService.userContact&&!this.contactService.userContact.fileStorageEnabled)return void this.logger.info("removeRoomFileViewer skipped - fileStorageEnabled : "+this.contactService.userContact.fileStorageEnabled);let fileDesc;this.logger.info("[FileStorageService] >removeRoomFileViewer: "+room.dbId);do{if(fileDesc=this.getFileDescriptorByViewerId(room.dbId),fileDesc){const viewerFound=fileDesc.viewers.find(element=>element.viewerId===room.dbId);viewerFound&&(this.logger.info("[FileStorageService] >viewer found delete it"),fileDesc.viewers.splice(fileDesc.viewers.indexOf(viewerFound),1))}}while(fileDesc)}getNewDocuments(set){switch(set){case"mine":return this.fileDescriptors;case"received":return this.receivedFileDescriptors;default:return this.mergedFileDescriptors}}getDocuments(orderedBy,received){return this.currentOrder!==orderedBy&&(this.currentOrder=orderedBy,this.orderDocuments()),received?this.receivedFileDescriptors:this.fileDescriptors}getFileDescriptorById(id){for(const fileDescriptor of this.fileDescriptors)if(fileDescriptor.id===id)return fileDescriptor;for(const fileDescriptor of this.receivedFileDescriptors)if(fileDescriptor.id===id)return fileDescriptor;return null}getFileDescriptorByViewerId(id){for(const fileDescriptor of this.fileDescriptors)for(const viewer of fileDescriptor.viewers)if(viewer.viewerId===id)return fileDescriptor;for(const fileDescriptor of this.receivedFileDescriptors)if(fileDescriptor.id===id)return fileDescriptor;return null}getReceivedFileDescriptorsFromConversation(conversation){if(conversation.contact){const files=this.receivedFileDescriptors.filter(file=>conversation.contact.dbId===file.ownerId&&void 0!==file.viewers.find(viewer=>viewer.viewerId===this.contactService.userContact.dbId));return files||[]}if(conversation.room){const files=this.receivedFileDescriptors.filter(file=>file.ownerId!==this.contactService.userContact.dbId&&void 0!==file.viewers.find(viewer=>viewer.viewerId===conversation.room.dbId));return files||[]}return[]}getReceivedFilesFromContact(dbId){return this.receivedFileDescriptors.filter(file=>file.ownerId===dbId)}getSentFilesToContact(dbId){if(this.contactService&&this.contactService.userContact&&!this.contactService.userContact.fileStorageEnabled)return this.logger.info("getSentFilesToContact skipped - fileStorageEnabled : "+this.contactService.userContact.fileStorageEnabled),[];return this.fileDescriptors.filter(file=>{for(let i=0;i<file.viewers.length;i++)if(file.viewers[i].viewerId===dbId)return!0;return!1})}getReceivedFilesForRoom(dbId){return this.receivedFileDescriptors.filter(file=>{for(let i=0;i<file.viewers.length;i++)if(file.viewers[i].viewerId===dbId&&file.ownerId!==this.contactService.userContact.dbId)return!0;return!1})}getConsumptionData(){return this.consumptionData}getVoiceMessageFileDescriptorByMsgId(msgId){return this.voiceMessageFileDescriptors.find(file=>null!==file.tags&&file.tags.msgId===msgId)}createFileDescriptor(fileName,extension,size,viewers=[],voiceMessageData=null){return __awaiter(this,void 0,void 0,(function*(){try{const data={fileName:fileName,extension:extension,size:size,viewers:viewers};voiceMessageData&&(data.voicemessage=!0,data.encoding=!0,data.duration=voiceMessageData.duration);const url=this.portalURL,headers=this.authService.getPostHeader(),body=JSON.stringify(data),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;const fileDescriptorData=(yield response.json()).data,fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);return fileDescriptor&&this.fileDescriptors.push(fileDescriptor),this.logger.info("[FileStorageService] createFileDescriptor -- "+fileDescriptor.id+" -- success"),this.orderDocuments(),fileDescriptor}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"createFileDescriptor");throw 403153===errorInfo.error.errorDetailsCode&&(this.contactService.userContact.fileSharingEnabled=!1,this.contactService.userContact.rxSubject.next()),this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}createFileDescriptorFromData(data){if(data){let viewers=[];data.viewers&&(viewers=fileViewer_1.FileViewer.createFromData(data.viewers));let url=data.url;url||(url=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+data.id);const state=data.isUploaded?"uploaded":"not_uploaded",voiceMessage=data.tags&&"voicemail"===data.tags.purpose;let virusScanState="unknown";return virusScanState=null===data.isClean?"notScanned":!0===data.isClean?"isClean":"isInfected",fileDescriptor_1.FileDescriptor.create(data.id,url,data.ownerId,data.fileName,data.extension,data.typeMIME,data.size,data.registrationDate,data.uploadedDate,data.dateToSort,viewers,state,data.thumbnail,data.orientation,data.original_w,data.original_h,data.tags,virusScanState,voiceMessage)}return null}deleteFileDescriptor(id){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/${id}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;this.logger.info("[FileStorageService] deleteFileDescriptor -- SUCCESS"),this.deleteFileDescriptorFromCache(id),this.eventService.publish("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:id}),this.retrieveUserConsumption()}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"deleteFileDescriptor");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}deleteAllFileDescriptor(){return __awaiter(this,void 0,void 0,(function*(){try{const url=this.portalURL+"/all",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;this.logger.info("[FileStorageService] deleteAllFileDescriptor -- success"),this.deleteAllFilesDescriptorsFromCache(),this.retrieveUserConsumption()}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"deleteAllFileDescriptor");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}getFileDescriptorsFromServer(){return __awaiter(this,void 0,void 0,(function*(){try{yield Promise.all([this.retrieveFileDescriptorsListPerOwner(),this.retrieveReceivedFiles(this.contactService.userContact.dbId)]),this.orderDocuments()}catch(error){}}))}retrieveFileDescriptorsListPerOwner(){return __awaiter(this,void 0,void 0,(function*(){try{this.fileDescriptors=[];const url=this.portalURL+"?format=full&limit=1000",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const fileDescriptorsResponse=yield response.json();let fileDescriptorsData=fileDescriptorsResponse.data;if(!fileDescriptorsData)return this.fileDescriptors;const limit=fileDescriptorsResponse.limit,total=fileDescriptorsResponse.total;let getAllFileDescriptorPromise=null;if(total<=limit)getAllFileDescriptorPromise=Promise.resolve([]);else{let offset=limit;const requestCount=total/limit,requestArray=[];for(let index=1;index<requestCount;index++)requestArray.push(this.retrieveFileDescriptorsListPerOwnerwithOffset(offset,limit)),offset+=limit;getAllFileDescriptorPromise=Promise.all(requestArray)}(yield getAllFileDescriptorPromise).forEach(responseData=>{fileDescriptorsData=fileDescriptorsData.concat(responseData)});for(const fileDescriptorData of fileDescriptorsData){const fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);this.fileDescriptors.push(fileDescriptor)}return this.logger.info("[FileStorageService] retrieveFileDescriptorsListPerOwner -- success"),this.fileDescriptors}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveFileDescriptorsListPerOwner");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveFileDescriptorsListPerOwnerwithOffset(offset,limit){return __awaiter(this,void 0,void 0,(function*(){const url=`${this.portalURL}?format=full&limit=${limit}&offset=${offset}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;return(yield response.json()).data}))}retrieveVoiceMessageFileDescriptorsListPerOwner(){return __awaiter(this,void 0,void 0,(function*(){try{const url=this.portalURL+"?format=full&path=/voice-messages",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const fileDescriptorsData=(yield response.json()).data;return fileDescriptorsData?(this.voiceMessageFileDescriptors=fileDescriptorsData.reduce((fileDescriptors,fileDescriptorData)=>{const fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);return"not_uploaded"===fileDescriptor.state?(this.logger.info(`[FileStorageService] file ${fileDescriptor.fileName} not uploaded`),fileDescriptor.ownerId===this.contactService.userContact.dbId?(this.logger.info(`[FileStorageService] file ${fileDescriptor.fileName} is our property, we can delete it`),this.deleteFileDescriptor(fileDescriptor.id)):this.logger.info(`[FileStorageService] file ${fileDescriptor.fileName} is NOT our property, we CANNOT delete it`)):fileDescriptors.push(fileDescriptor),fileDescriptors},[]),this.logger.info("[FileStorageService] retrieveVoiceMessageFileDescriptorsListPerOwner -- success"),this.voiceMessageFileDescriptors):[]}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveVoiceMessageFileDescriptorsListPerOwner");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveFilesReceivedFromPeer(userId,peerId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/viewers/${userId}?ownerId=${peerId}&format=full`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const receivedFileDescriptors=(yield response.json()).data.map(fileDescriptorData=>this.createFileDescriptorFromData(fileDescriptorData));return this.logger.info("[FileStorageService] retrieveFilesReceivedFromPeer success"),receivedFileDescriptors}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveFilesReceivedFromPeer");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveSentFiles(peerId){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[FileStorageService] >retrieveSentFiles");const url=`${this.portalURL}?format=full&viewerId=${peerId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;return(yield response.json()).data.reduce((fileDescriptors,fileDescriptorData)=>{const fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);return"not_uploaded"===fileDescriptor.state?this.logger.warn(`[FileStorageService] file ${fileDescriptor.fileName} not uploaded`):fileDescriptors.push(fileDescriptor),fileDescriptors},[])}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveSentFiles");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveReceivedFilesForRoom(roomId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/viewers/${roomId}?format=full`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const fileDescriptorsData=(yield response.json()).data;return fileDescriptorsData?fileDescriptorsData.reduce((fileDescriptors,fileDescriptorData)=>{if(fileDescriptorData.ownerId!==this.contactService.userContact.dbId){fileDescriptorData.viewers=[];const newFileDesc=this.createFileDescriptorFromData(fileDescriptorData);fileDescriptors.push(newFileDesc),this.receivedFileDescriptors.find(fd=>fd.id===fileDescriptorData.id)||this.receivedFileDescriptors.push(newFileDesc)}return fileDescriptors},[]):[]}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveReceivedFilesForRoom");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveReceivedFiles(viewerId){return __awaiter(this,void 0,void 0,(function*(){try{this.receivedFileDescriptors=[];const url=`${this.portalURL}/viewers/${viewerId}?format=full&limit=1000`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const fileDescriptorsResponse=yield response.json();let fileDescriptorsData=fileDescriptorsResponse.data;if(!fileDescriptorsData)return this.receivedFileDescriptors;const limit=fileDescriptorsResponse.limit,total=fileDescriptorsResponse.total;let getReceivedFileDescriptorPromise=null;if(total<=limit)getReceivedFileDescriptorPromise=Promise.resolve([]);else{let offset=limit;const requestCount=total/limit,requestArray=[];for(let index=1;index<requestCount;index++)requestArray.push(this.retrieveReceivedFilesWithOffset(viewerId,offset,limit)),offset+=limit;getReceivedFileDescriptorPromise=Promise.all(requestArray)}return(yield getReceivedFileDescriptorPromise).forEach(responseData=>{fileDescriptorsData=fileDescriptorsData.concat(responseData)}),this.receivedFileDescriptors=fileDescriptorsData.reduce((fileDescriptors,fileDescriptorData)=>{const fileDescriptor=this.createFileDescriptorFromData(fileDescriptorData);if(fileDescriptor.ownerId!==this.contactService.userContact.dbId){const oldFileDesc=this.getFileDescriptorById(fileDescriptor.id);oldFileDesc&&(fileDescriptor.previewBlob=oldFileDesc.previewBlob,fileDescriptor.previewBlobSubject.next(URL.createObjectURL(fileDescriptor.previewBlob))),fileDescriptors.push(fileDescriptor)}return fileDescriptors},[]),this.logger.info("[FileStorageService] retrieveReceivedFiles -- success"),this.receivedFileDescriptors}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveReceivedFiles");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveReceivedFilesWithOffset(viewerId,offset,limit){return __awaiter(this,void 0,void 0,(function*(){const url=`${this.portalURL}/viewers/${viewerId}?format=full&limit=1000&limit=${limit}&offset=${offset}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});return(yield response.json()).data}))}retrieveUserConsumption(){return __awaiter(this,void 0,void 0,(function*(){try{const url=config.restServerUrl+"/api/rainbow/filestorage/v1.0/users/consumption",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;return this.consumptionData=(yield response.json()).data,this.logger.info("[FileStorageService] retrieveUserConsumption success"),this.eventService.publish("ON_CONSUMPTION_DATA_UPDATED_EVENT"),this.consumptionData}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveUserConsumption");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}deleteFileViewer(viewerId,fileId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/${fileId}/viewers/${viewerId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;this.logger.info("[FileStorageService] deleteFileViewer "+response.statusText);const fileDescriptor=this.getFileDescriptorById(fileId);if(fileDescriptor){const index=fileDescriptor.viewers.findIndex(viewer=>viewer.viewerId===viewerId);-1!==index&&fileDescriptor.viewers.splice(index,1)}}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"deleteFileViewer");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}addFileViewer(fileId,viewerId,type){return __awaiter(this,void 0,void 0,(function*(){const fileDescriptor=this.getFileDescriptorById(fileId);if(fileDescriptor){if(fileDescriptor.isAlreadyFileViewer(viewerId))return fileDescriptor;try{const url=`${this.portalURL}/${fileId}/viewers`,headers=this.authService.getPostHeader(),body=JSON.stringify({viewerId:viewerId,type:type}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;this.logger.info("[FileStorageService] addFileViewer success");const viewerAdded=fileViewer_1.FileViewer.createFromData([{viewerId:viewerId,type:type}])[0];return fileDescriptor.viewers.push(viewerAdded),fileDescriptor}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"addFileViewer");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}return null}))}copyFileToUserCloudStorage(fileId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/${fileId}/copy`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"POST",headers:headers});if(!response.ok)throw response;const responseData=(yield response.json()).data;return this.logger.info(`[FileStorageService] copyFileToUserCloudStorage | copyFile ${fileId} -- success`),yield this.retrieveAndStoreOneFileDescriptor(responseData.id,!0)}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"copyFileToUserCloudStorage");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}}))}retrieveOneFileDescriptor(fileId){return this.retrieveFileDescriptorPromises[fileId]?(this.logger.info(`[FileStorageService] retrieveOneFileDescriptor for ${fileId} already lauched`),this.retrieveFileDescriptorPromises[fileId]):(this.retrieveFileDescriptorPromises[fileId]=(()=>__awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[FileStorageService] retrieveOneFileDescriptor "+fileId);const url=`${this.portalURL}/${fileId}?format=full`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=(yield response.json()).data,fileDescriptor=this.createFileDescriptorFromData(responseData);return this.logger.info(`[FileStorageService] retrieveOneFileDescriptor ${fileId} -- success`),delete this.retrieveFileDescriptorPromises[fileId],fileDescriptor}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"retrieveOneFileDescriptor");throw this.logger.error("[fileStorageService] "+errorInfo.message),errorInfo.error}})))(),this.retrieveFileDescriptorPromises[fileId])}retrieveAndStoreOneFileDescriptor(fileId,forceRetrieve=!1){const fileDescriptor=this.getFileDescriptorById(fileId);return fileDescriptor&&!forceRetrieve?(this.logger.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- return existing fileDescriptor "+fileId),Promise.resolve(fileDescriptor)):this.retrieveOneFileDescriptor(fileId).then(retrievedFileDescriptor=>{fileDescriptor&&fileDescriptor.isImage()&&(retrievedFileDescriptor.previewBlob=fileDescriptor.previewBlob,retrievedFileDescriptor.previewBlobSubject.next(retrievedFileDescriptor.previewBlob));const currentFileDescriptor=this.fileDescriptors.find(_fileDescriptor=>_fileDescriptor.id===retrievedFileDescriptor.id);currentFileDescriptor&&currentFileDescriptor.update(retrievedFileDescriptor);const currentReceivedFileDescriptor=this.receivedFileDescriptors.find(_fileDescriptor=>_fileDescriptor.id===retrievedFileDescriptor.id);return currentReceivedFileDescriptor&&currentReceivedFileDescriptor.update(retrievedFileDescriptor),currentFileDescriptor||currentReceivedFileDescriptor||(retrievedFileDescriptor.ownerId===this.contactService.userContact.dbId?(this.fileDescriptors.push(retrievedFileDescriptor),this.logger.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+retrievedFileDescriptor.id+" -- now stored in my files")):(this.receivedFileDescriptors.push(retrievedFileDescriptor),this.logger.info("[FileStorageService] retrieveAndStoreOneFileDescriptor -- fileDescriptor "+retrievedFileDescriptor.id+" -- now stored in received files")),this.fileDescriptorsSubject.next({action:"new",fd:retrievedFileDescriptor})),this.orderDocuments(),this.eventService.publish("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:retrievedFileDescriptor.id}),Promise.resolve(retrievedFileDescriptor)}).catch(error=>(this.logger.warn("[FileStorageService] Error on getting FileDescriptor: "+error.errorDetailsCode),error.status>=400&&error.status<500&&fileDescriptor&&(404===error.status&&this.deleteFileDescriptorFromCache(fileDescriptor.id),this.orderDocuments(),this.logger.debug("[FileStorageService] Sending ON_FILE_REMOVED_FROM_STORE_EVENT"),this.eventService.publish("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:fileDescriptor.id})),Promise.reject(error)))}deleteFileDescriptorFromCache(id){this.logger.info("[FileStorageService] deleteFileDescriptorFromCache "+id);for(let index=0;index<this.receivedFileDescriptors.length;index++){const fileDescriptor=this.receivedFileDescriptors[index];if(fileDescriptor.id===id){this.receivedFileDescriptors.splice(index,1),fileDescriptor.setState("deleted");break}}for(let index=0;index<this.fileDescriptors.length;index++){const fileDescriptor=this.fileDescriptors[index];if(fileDescriptor.id===id){this.fileDescriptors.splice(index,1),fileDescriptor.setState("deleted");break}}this.orderDocuments()}deleteAllFilesDescriptorsFromCache(){this.logger.info("[FileStorageService] deleteAllFilesDesceiptorsFromCache"),this.fileDescriptors.forEach(fileDescriptor=>{fileDescriptor.setState("deleted"),this.receivedFileDescriptors.forEach((receivedFileDescriptor,index)=>{receivedFileDescriptor.id===fileDescriptor.id&&this.receivedFileDescriptors.splice(index,1)})}),this.fileDescriptors=[],this.orderDocuments(),this.fileDescriptorsSubject.next({action:"listUpdate"})}orderDocuments(set="all"){this.logger.debug("[FileStorageService] orderDocuments");let documentsSet=null;switch(set){case"mine":documentsSet=this.fileDescriptors;break;case"received":documentsSet=this.receivedFileDescriptors;break;default:this.mergedFileDescriptors=this.fileDescriptors.concat(this.receivedFileDescriptors),documentsSet=this.mergedFileDescriptors}switch(this.currentOrder){default:documentsSet.sort((fda,fdb)=>fdb.time-fda.time);break;case"name":documentsSet.sort((fda,fdb)=>fda.fileName.localeCompare(fdb.fileName));break;case"size":documentsSet.sort((fda,fdb)=>fda.size-fdb.size)}}extractFileIdFromUrl(url){const parts=url.split("/");return parts.pop()||parts.pop()}retrieveAndStoreOneVoiceMessageFileDescriptor(fileId){this.retrieveOneFileDescriptor(fileId).then(retrievedFileDescriptor=>{if(retrievedFileDescriptor.tags&&"/voice-messages"===retrievedFileDescriptor.tags.path){if(void 0!==this.voiceMessageFileDescriptors.find(file=>file.id===fileId)){const fileDescriptorIndex=this.voiceMessageFileDescriptors.findIndex(oneFileDescriptor=>oneFileDescriptor.id===retrievedFileDescriptor.id);fileDescriptorIndex>-1&&this.voiceMessageFileDescriptors.splice(fileDescriptorIndex,1,retrievedFileDescriptor),this.logger.info("[FileStorageService] getRetrieveAndStoreOneVoiceMessageFileDescriptor "+fileId+" -- success")}else this.voiceMessageFileDescriptors.push(retrievedFileDescriptor)}})}deleteVoiceMessageFileDescriptor(fileId){this.logger.info("[FileStorageService] deleteVoiceMessageFileDescriptore "+fileId);const fileDescriptorExist=this.voiceMessageFileDescriptors.find(file=>file.id===fileId);if(void 0!==fileDescriptorExist){const fileDescriptorIndex=this.voiceMessageFileDescriptors.findIndex(oneFileDescriptor=>oneFileDescriptor.id===fileDescriptorExist.id);fileDescriptorIndex>-1&&this.voiceMessageFileDescriptors.splice(fileDescriptorIndex,1)}}getPublicFileDownloads(){return this.publicFileDownload}clearPublicFileDownloads(){this.publicFileDownload=[]}findPublicFileDownload(fileUrl){return this.publicFileDownload.find(element=>element.url===fileUrl)}updatePublicFileDownloadArray(filesPublicDownload,fileSystem){this.logger.info("[FileStorageService] >updatePublicFileDownloadArray"),filesPublicDownload.forEach(element=>{const fileDownload=this.findPublicFileDownload(element.url);if(fileDownload)this.logger.info("[FileStorageService] file ("+element.url+") Found - to update"),fileDownload.receivedBytes=element.receivedBytes,fileDownload.savePath=element.savePath,fileDownload.isDownloadFinished()&&fileDownload.openFolderOnceDownloadFinished&&(this.logger.debug("[FileStorageService] showItemInFolder auto on download completion"),fileSystem.showItemInFolder(fileDownload.savePath)),this.logger.debug("[FileStorageService] fileName="+fileDownload.fileName),this.logger.debug("[FileStorageService] file receivedBytes="+fileDownload.receivedBytes),this.logger.debug("[FileStorageService] file totalBytes="+fileDownload.totalBytes),this.logger.debug("[FileStorageService] file savePath="+fileDownload.savePath),fileDownload.progressSubject.next();else{this.logger.info("[FileStorageService] file Not Found");const newFile=filePublicDownload_1.FilePublicDownload.create(element.url,element.fileName,element.totalBytes,element.receivedBytes,element.savePath);this.publicFileDownload.unshift(newFile)}this.publicFileDownloadSubject.next()})}removePublicFileDownload(file){if(!file||!file.url)return;const index=this.publicFileDownload.indexOf(file);index>=0&&(this.publicFileDownload.splice(index,1),this.publicFileDownloadSubject.next())}}exports.FileStorageService=FileStorageService,exports.default=FileStorageService.getInstance()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MainService=void 0;const rxjs_1=__webpack_require__(10),logger_service_1=__webpack_require__(15);class MainService{constructor(){this.appActive=!0,this.appActiveSubject=null,this.detectionInterval=180,this.detectionTimeout=null,this.onActivityListener=null,this.appConnectivitySubject=null,this.connectivityTimeout=null,this.connectivityUp=!1,this.cdn="",this.cdnImages="",this.cdnServer="";const win=window;win.moduleIds||(win.moduleIds=[]),win.config||(win.config={xmpp:{protocol:"wss",currentServer:null,port:"443",pingInterval:"60000"},webservices:{protocol:"https",currentServer:null,port:"443"}}),this.updateCDN(),this.appActiveSubject=new rxjs_1.Subject,this.onActivityListener=()=>{this.appActive||this.onStateChanged("active"),this.detectionTimeout&&(clearTimeout(this.detectionTimeout),this.detectionTimeout=null),window.document.removeEventListener("mousemove",this.onActivityListener),window.document.removeEventListener("keypress",this.onActivityListener),setTimeout(()=>{this.startTimer()},2e3)},this.appConnectivitySubject=new rxjs_1.Subject,this.connectivityUp=navigator.onLine,window.addEventListener("offline",()=>{logger_service_1.default.debug("[MainService] Connectivity change : down"),this.connectivityTimeout&&(clearInterval(this.connectivityTimeout),this.connectivityTimeout=null),this.connectivityUp&&(this.connectivityUp=!1,this.connectivityTimeout=setTimeout(()=>{this.appConnectivitySubject.next(!1)},2500))}),window.addEventListener("online",()=>{logger_service_1.default.debug("[MainService] Connectivity change : up"),this.connectivityTimeout&&(clearInterval(this.connectivityTimeout),this.connectivityTimeout=null),this.connectivityUp||(this.connectivityUp=!0,this.connectivityTimeout=setTimeout(()=>{this.appConnectivitySubject.next(!0)},1e3))})}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.mainService||(win.rainbow.mainService=new MainService),win.rainbow.mainService}configure(centralizedService=null){logger_service_1.default.info("[MainService] STARTED"),centralizedService&&centralizedService.isDesktopApp()?(centralizedService.idle.setDetectionInterval(this.detectionInterval),centralizedService.idle.onStateChanged.addListener(state=>{this.onStateChanged(state)})):this.startTimer()}subscribe(appActiveHandler){return this.appActiveSubject.subscribe(appActiveHandler)}subscribeToConnectivityEvents(appActiveHandler){return this.appConnectivitySubject.subscribe(appActiveHandler)}updateCDN(){}onStateChanged(state){this.appActive="active"===state,this.appActiveSubject.next(this.appActive)}startTimer(){this.detectionTimeout&&(clearTimeout(this.detectionTimeout),this.detectionTimeout=null),this.detectionTimeout=setTimeout(()=>{this.onStateChanged("idle")},1e3*this.detectionInterval),window.document.addEventListener("mousemove",this.onActivityListener),window.document.addEventListener("keypress",this.onActivityListener)}isDesktopApp(){const ua=navigator.userAgent.toLowerCase();return ua.indexOf("qtwebengine")>-1||ua.indexOf("electron/")>-1}}exports.MainService=MainService,exports.default=MainService.getInstance()},function(module,exports,__webpack_require__){var v1=__webpack_require__(310),v4=__webpack_require__(311),uuid=v4;uuid.v1=v1,uuid.v4=v4,module.exports=uuid},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SDK=void 0,exports.SDK={OK:1,ERROR:-1,ERRORUNAUTHORIZED:-2,ERRORXMPP:-4,ERRORXMPPJID:-8,ERRORBADREQUEST:-16,ERRORUNSUPPORTED:-32,ERRORNOTFOUND:-64}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return observable}));var observable=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return ObjectUnsubscribedError}));var ObjectUnsubscribedError=function(){function ObjectUnsubscribedErrorImpl(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return ObjectUnsubscribedErrorImpl.prototype=Object.create(Error.prototype),ObjectUnsubscribedErrorImpl}()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.UserInfoService=void 0;const crypto_js_1=__webpack_require__(18),crypto_js_2=__webpack_require__(18),settings_service_1=__webpack_require__(5),main_service_1=__webpack_require__(26),logger_service_1=__webpack_require__(15);class UserInfoService{constructor(){this.userColors=["#ca8741","#e44647","#c62582","#9b4ce7","#6573ee","#1b70e0","#6ec7d9","#98d1b1","#7fbd40","#b2d334","#dcd232","#f1be00"],this.userColorNames=["purple-lavender","purple-violet","red-coral","blue-jeanlouisdavid","green-mint","green-yellow","orange-jade","pink-lady","yellow-submarine","blue-teal"]}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.userInfoService||(win.rainbow.userInfoService=new UserInfoService),win.rainbow.userInfoService}getAvatarImage(objId,initials,color,size,lastAvatarUpdate){if(!(lastAvatarUpdate=void 0!==lastAvatarUpdate&&lastAvatarUpdate))return initials?this.createDefaultAvatarImage(initials,color):null;let serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;main_service_1.default.cdn&&(serverURL=main_service_1.default.cdnServer);let src=serverURL+"/api/avatar/"+objId+"?size="+(size||256);return lastAvatarUpdate&&(src+="&update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(lastAvatarUpdate)).toString(crypto_js_2.enc.Hex)),{src:src}}getNameInformation(firstName,lastName){const result={displayName:"",initials:""};return 1!==lastName.length&&2!==firstName.length?"FL"===settings_service_1.default.getSetting("displayOrder")?(result.displayName=firstName+" "+lastName,result.initials=firstName.charAt(0).toUpperCase()+lastName.charAt(0).toUpperCase()):(result.displayName=lastName+" "+firstName,result.initials=lastName.charAt(0).toUpperCase()+firstName.charAt(0).toUpperCase()):("FL"===settings_service_1.default.getSetting("displayOrder")?result.displayName=firstName+" "+lastName:result.displayName=lastName+" "+firstName,result.initials=firstName.charAt(0).toUpperCase()+firstName.charAt(1).toUpperCase()),result}createDefaultAvatarImage(initials,color){const image=new Image,canvas=document.createElement("canvas");canvas.width=image.width=225,canvas.height=image.height=225;const ctx=canvas.getContext("2d");return ctx.rect(0,0,225,225),ctx.fillStyle=color,ctx.fill(),ctx.font="bold 100px Helvetica",ctx.textAlign="center",ctx.fillStyle="white",ctx.fillText(initials,110,150),image.src=canvas.toDataURL("image/png"),image}computeUserColor(displayName){const result={colorIndex:0,color:this.userColors[0],colorName:this.userColorNames[0]};try{const upperCaseDisplayName=displayName.toUpperCase();let sum=0;for(let i=0;i<upperCaseDisplayName.length;i++)sum+=upperCaseDisplayName.charCodeAt(i);result.colorIndex=sum%12,result.color=this.userColors[result.colorIndex],result.colorName=this.userColorNames[result.colorIndex]}catch(error){logger_service_1.default.error("[UserInfoService] computeUserColor failure"),result.colorIndex=1,result.color=this.userColors[result.colorIndex],result.colorName=this.userColorNames[result.colorIndex]}return result}}exports.UserInfoService=UserInfoService,exports.default=UserInfoService.getInstance()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.EventService=void 0;class EventService{constructor(){this.$rootScope=null}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.eventService||(win.rainbow.eventService=new EventService),win.rainbow.eventService}configure($rootScope=null){this.$rootScope=$rootScope}subscribe(eventName,handler){return this.$rootScope?this.$rootScope.$on(eventName,handler):()=>{}}unsubscribe(subscription){subscription()}publish(eventName,...args){this.$rootScope&&this.$rootScope.$broadcast(eventName,...args)}publishWithApply(eventName,...args){this.$rootScope&&this.$rootScope.$apply(()=>{this.$rootScope.$broadcast(eventName,...args)})}}exports.EventService=EventService,exports.default=EventService.getInstance()},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RoomService=exports.AbstractRoomService=void 0;const crypto_js_1=__webpack_require__(18),crypto_js_2=__webpack_require__(18),room_model_1=__webpack_require__(226),rxjs_1=__webpack_require__(10),strophe_js_1=__webpack_require__(76),event_model_1=__webpack_require__(24),imageUtils_service_1=__webpack_require__(74),rxjs_2=__webpack_require__(10),settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),main_service_1=__webpack_require__(26),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),errorHelper_service_1=__webpack_require__(39),contact_service_1=__webpack_require__(1),fileStorage_service_1=__webpack_require__(25),logger_service_1=__webpack_require__(15),i18n_service_1=__webpack_require__(37),randomString_1=__webpack_require__(219),event_service_1=__webpack_require__(32);class AbstractRoomService{}exports.AbstractRoomService=AbstractRoomService;class RoomService extends AbstractRoomService{constructor(){super(),this.ROOM_UPDATE_EVENT="ROOM_UPDATE_EVENT",this.ROOM_AVATAR_UPDATE_EVENT="ROOM_AVATAR_UPDATE_EVENT",this.ROOM_HISTORY_UPDATE_EVENT="ROOM_HISTORY_UPDATE_EVENT",this.ROOM_ADMIN_MESSAGE_EVENT="ROOM_ADMIN_MESSAGE_EVENT",this.ROOM_INVITATION="ROOM_INVITATION",this.ROOM_ADD_CONF_ENDPOINT_EVENT="ROOM_ADD_CONF_ENDPOINT_EVENT",this.ROOM_REMOVE_CONF_ENDPOINT_EVENT="ROOM_REMOVE_CONF_ENDPOINT_EVENT",this.ROOM_ADD_USERS_EVENT="ROOM_ADD_USERS_EVENT",this.ROOM_DELETE_USERS_EVENT="ROOM_DELETE_USERS_EVENT",this.RoomUserStatus={INVITED:"invited",ACCEPTED:"accepted",UNSUBSCRIBED:"unsubscribed",REJECTED:"rejected",DELETED:"deleted"},this.openInviteIdByRoomIdSubject=new rxjs_1.Subject,this.portalURL=null,this.listeners=[],this.xmppConnectionSubscription=null,this.roomPresenceWaitingList=[],this.userContact=null,this.invitationCounter=0,this.meetingInvitationCounter=0,this._rooms={},this.roomsByJids={},this.roomsInProgress={},this.updateLater={},this.maxRoomsUsers=0,this.maxRoomsStartupLoad=0,this.rxSubject=new rxjs_1.Subject,this.personalAudioRoomId="",this.currentPersonalAudioRoomId="",this.openInviteIdByRoomId={},this.getRoomByJidPromises={},this._roomTags=[],this.roomPresenceRef=null,this.roomMessageRef=null,this.roomInfoMessageRef=null,this.roomMessageConfigRef=null,this.roomHistoryInfoRef=null,this.roomNotificationRef=null,this.settingsService=settings_service_1.default,this.contactService=contact_service_1.default,this.profileService=profile_service_1.default,this.authService=auth_service_1.default,this.eventService=event_service_1.default,this.logger=logger_service_1.default,this.xmppService=xmpp_service_1.default,this.fileStorageService=fileStorage_service_1.default,this.i18n=i18n_service_1.default}get rooms(){return this._rooms}set rooms(value){this._rooms=value}get roomTags(){return this._roomTags}set roomTags(value){this._roomTags=value}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.roomService||(win.rainbow.roomService=new RoomService),win.rainbow.roomService}start(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.userContact=this.contactService.userContact,this.userContact&&!this.userContact.roomsEnabled)return void this.logger.info("[roomService] === Start skipped - roomsEnabled : false");this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/",this.invitationCounter=0,this.meetingInvitationCounter=0,this.rooms={},this.roomsByJids={},this.roomsInProgress={},this.updateLater={},this.maxRoomsUsers=profile_service_1.default.getFeatureLimitMax(profile_service_1.default.FeaturesEnum.BUBBLE_PARTICIPANT_COUNT),this.maxRoomsStartupLoad=profile_service_1.default.getFeatureLimitMax(profile_service_1.default.FeaturesEnum.BUBBLE_MAX_LOAD_STARTUP),this.personalAudioRoomId="",this.currentPersonalAudioRoomId="",this.openInviteIdByRoomId={},this.getRoomByJidPromises={},this.roomTags=[],this.logger.info(""),this.logger.info("[roomService] === STARTING ==="),this.attachHandlers(),yield this.getServerRooms(),this.computeInvitationCounter(),this.retrieveOpenInviteData(),this.profileService.isFeatureEnabled(profile_service_1.default.FeaturesEnum.CONFERENCE_ALLOWED)&&(this.retrievePersonalAudioRoom(),this.retrieveCurrentPersonalAudioRoom()),this.logger.info("[roomService] === STARTED ===")}catch(error){this.logger.error("[roomService] === STARTING FAILURE === "+error.message),this.computeInvitationCounter(),this.reconnect()}}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(""),this.logger.info("[roomService] === STOPPING ==="),this.listeners.forEach(listener=>{listener()}),this.rooms={},this.roomsByJids={},this.roomPresenceWaitingList=[],this.logger.info("[roomService] === STOPPED ===")}))}attachHandlers(){this.logger.info("[roomService] attachHandlers"),this.roomPresenceRef&&(this.xmppService.connection.deleteHandler(this.roomPresenceRef),this.roomPresenceRef=null),this.roomPresenceRef=this.xmppService.connection.addHandler(stanza=>this.onRoomPresence(stanza),"http://jabber.org/protocol/muc#user","presence"),this.roomMessageRef&&(this.xmppService.connection.deleteHandler(this.roomMessageRef),this.roomMessageRef=null),this.roomMessageRef=this.xmppService.connection.addHandler(stanza=>this.onRoomMessage(stanza),"jabber:x:conference","message"),this.roomInfoMessageRef&&(this.xmppService.connection.deleteHandler(this.roomInfoMessageRef),this.roomInfoMessageRef=null),this.roomInfoMessageRef=this.xmppService.connection.addHandler(stanza=>this.onRoomInfoMessage(stanza),null,"message","groupchat"),this.roomMessageConfigRef&&(this.xmppService.connection.deleteHandler(this.roomMessageConfigRef),this.roomMessageConfigRef=null),this.roomMessageConfigRef=this.xmppService.connection.addHandler(stanza=>this.onRoomMessageConfig(stanza),null,"message","management"),this.roomHistoryInfoRef&&(this.xmppService.connection.deleteHandler(this.roomHistoryInfoRef),this.roomHistoryInfoRef=null),this.roomHistoryInfoRef=this.xmppService.connection.addHandler(stanza=>this.onRoomHistoryInfoMessage(stanza),"jabber:iq:notification","message"),this.roomNotificationRef&&(this.xmppService.connection.deleteHandler(this.roomNotificationRef),this.roomNotificationRef=null),this.roomNotificationRef=this.xmppService.connection.addHandler(stanza=>this.onRoomNotificationMessage(stanza),"jabber:x:bubble:conference","message"),this.listeners.forEach(listener=>{listener()}),this.xmppConnectionSubscription&&this.xmppConnectionSubscription.unsubscribe(),this.xmppConnectionSubscription=this.xmppService.subscribeToConnectionEvents(event=>{this.onConnectionStateChange(event)})}reconnect(attempt=0){return __awaiter(this,void 0,void 0,(function*(){if(!this.userContact||this.userContact.roomsEnabled)try{this.logger.info("[roomService] reconnect"),attempt++,this.attachHandlers(),yield this.getServerRooms(),this.computeInvitationCounter(),this.retrieveOpenInviteData(),this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED)&&(this.retrievePersonalAudioRoom(),this.retrieveCurrentPersonalAudioRoom()),this.logger.info("[roomService] reconnect success")}catch(error){this.logger.error("[roomService] reconnect failure -- "+error.message),1===attempt&&this.reconnect(attempt)}else this.logger.info("[roomService] === Reconnect skipped - roomsEnabled : false")}))}onConnectionStateChange(event){this.logger.info("[roomService] onConnectionStateChange status:"+event.name),"ON_XMPP_DISCONNECTED"===event.name&&this.rooms&&(Object.keys(this.rooms).forEach(key=>{const room=this.rooms[key];room&&(room.initPresenceAck=!1,room.initPresInterval&&(this.logger.info("[roomService] onConnectionStateChange cancel initPresence retryer for room: "+room.jid+" "+room.getNameForLogs()),room.initPresInterval.unsubscribe(),room.initPresInterval=null),room.initPresPromise&&(this.logger.info("[roomService] onConnectionStateChange remove initPresPromise for room: "+room.jid+" "+room.getNameForLogs()),room.initPresPromise=null,room.initPresPromiseResolve=null))}),this.roomPresenceWaitingList=[])}subscribe(callback){return this.rxSubject.subscribe(callback)}sendEvent(type,value){this.rxSubject.next({type:type,value:value})}getRooms(){const roomArray=[];return Object.keys(this.rooms).forEach(key=>{const room=this.rooms[key];room.conference&&room.conference.webinar||roomArray.push(this.rooms[key])}),roomArray}searchRooms(criteria){const queries=criteria.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ -]+/);return this.getRooms().filter(room=>{if(!contact_service_1.default.userContact.phoneMeetingsEnabled&&room.isMeetingRoom())return!1;if("accepted"!==room.status)return!1;room.filterName=room.name.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const names=room.filterName.split(/[ -]+/);return queries.every(query=>names.some((name,index)=>!(!name.length||-1===name.indexOf(query))&&(names[index]="",!0)))})}getRoomInvitations(){return this.getRooms().filter(room=>"invited"===room.status&&"Rainbow_OutlookCreation_InternalUseOnly"!==room.desc&&!room.isMeetingRoom())}getMeetingInvitations(){return this.getRooms().filter(room=>"invited"===room.status&&"Rainbow_OutlookCreation_InternalUseOnly"!==room.desc&&room.isMeetingRoom())}getMyRooms(){return this.getRooms().filter(room=>room.owner)}getRoomById(roomId){return this.rooms[roomId]}getRoomByJid(jid){return this.roomsByJids[jid]}getRoomsByContainerId(containerId){return this.getRooms().filter(room=>room.containerId===containerId)}computeInvitationCounter(){this.invitationCounter=0,this.meetingInvitationCounter=0,Object.keys(this.rooms).forEach(key=>{const room=this.rooms[key];"invited"===room.status&&(room.isMeetingRoom()?this.meetingInvitationCounter+=1:this.invitationCounter+=1)})}getOrderedRooms(order){const rooms=this.getRooms();switch(order){case"lastActivityDate":return rooms.sort((roomA,roomB)=>roomB.getLastActivityDate().getTime()-roomA.getLastActivityDate().getTime());case"creationDate":return rooms.sort((roomA,roomB)=>roomB.getCreationDate().getTime()-roomA.getCreationDate().getTime());default:return rooms.sort((roomA,roomB)=>roomA.name.localeCompare(roomB.name))}}getMyOrderedRooms(order){const rooms=this.getMyRooms();switch(order){case"lastActivityDate":return rooms.sort((roomA,roomB)=>roomB.getLastActivityDate().getTime()-roomA.getLastActivityDate().getTime());case"creationDate":return rooms.sort((roomA,roomB)=>roomB.getCreationDate().getTime()-roomA.getCreationDate().getTime());default:return rooms.sort((roomA,roomB)=>roomA.name.localeCompare(roomB.name))}}updateRoomFromServer(room){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(`updateRoomFromServer(${room.dbId})`);try{const response=yield fetch(`${this.portalURL}rooms/${room.dbId}?format=full`,{headers:auth_service_1.default.getRequestHeader()}),roomData=(yield response.json()).data;yield this.getAllRoomsParticipants([roomData]),this.updateRoomData(room,roomData)}catch(error){this.logger.error("updateRoomFromServer -- FAILURE -- "+error.message)}}))}updateRoomData(room,newRoomData){if(room.name=newRoomData.name,room.desc=newRoomData.topic,room.users=[],newRoomData.users.forEach(userData=>{const contact=contact_service_1.default.getContactById(userData.userId);contact&&(room.users.push({contact:contact,status:userData.status,date:new Date(userData.additionDate),privilege:userData.privilege}),contact_service_1.default.isUserContact(contact)&&(room.status=userData.status))}),this.refreshMemberAndOrganizerLists(room),room.isModerator=room.status!==this.RoomUserStatus.UNSUBSCRIBED&&room.isUserModerator(contact_service_1.default.userContact),newRoomData.lastAvatarUpdateDate&&newRoomData.lastAvatarUpdateDate!==room.lastAvatarUpdate){room.lastAvatarUpdate=newRoomData.lastAvatarUpdateDate;const avatarServerUrl=main_service_1.default.cdn?main_service_1.default.cdnServer:config.restServerUrl,updateToken=crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(room.lastAvatarUpdate)).toString(crypto_js_2.enc.Hex);room.avatar=`${avatarServerUrl}/api/room-avatar/${room.dbId}?size=512&update=${updateToken}`}room.updateAvatarInfo(),room.guestEmails=newRoomData.guestEmails,room.confEndpoints=newRoomData.confEndpoints}getServerRoom(roomId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}rooms/${roomId}?format=full`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const roomData=(yield response.json()).data;this.logger.info(`[roomService] getServerRoom(${roomId}) -- SUCCESS`);const roomsData=yield this.getAllRoomsParticipants([roomData]);return this.createRoomFromData(roomsData[0])}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getServerRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}getServerRoomByJid(roomJid){return this.logger.info(`[roomService] getServerRoomByJid(${roomJid})`),this.getRoomByJidPromises[roomJid]||(this.getRoomByJidPromises[roomJid]=(()=>__awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}rooms/jids/${roomJid}?format=full`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const roomData=(yield response.json()).data;this.logger.info(`[roomService] getServerRoomByJid(${roomJid}) -- SUCCESS`);const roomsData=yield this.getAllRoomsParticipants([roomData]);return delete this.getRoomByJidPromises[roomJid],this.createRoomFromData(roomsData[0])}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getServerRoomByJid");throw this.logger.error("[roomService] "+errorInfo.message),delete this.getRoomByJidPromises[roomJid],errorInfo.error}})))()),this.getRoomByJidPromises[roomJid]}getServerRooms(){return __awaiter(this,void 0,void 0,(function*(){const getAllRooms=(page,limit,rooms)=>__awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}rooms?format=full&userId=${this.userContact.dbId}&sortField=lastActivityDate&status=invited&status=accepted&status=unsubscribed&offset=${page}&limit=${limit}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();return rooms=rooms.concat(responseData.data),this.logger.info(`[roomService] getServerRooms retrieved ${responseData.data.length} rooms, total ${rooms.length}, existing ${responseData.total}`),rooms.length===responseData.total?(this.logger.info("[roomService] getServerRooms no need to loop again. All rooms retrieved..."),rooms):(page+=limit,this.logger.info("[roomService] getServerRooms need another loop to get more rooms... "),yield getAllRooms(page,limit,rooms))}catch(error){throw(yield errorHelper_service_1.default.getErrorInfo(error,"getSetOfRooms")).error}}));try{const limit=this.maxRoomsStartupLoad?this.maxRoomsStartupLoad:1e3,response=yield getAllRooms(0,limit,[]);this.logger.info(`[roomService] getServerRooms successfully: find ${response.length} room(s)`);try{(yield this.getAllRoomsParticipants(response)).forEach(roomData=>{this.createRoomFromData(roomData,!0)})}catch(error){this.logger.info("[roomService] getServerRooms issue while retrieving all participant"),response.forEach(roomData=>{this.createRoomFromData(roomData,!0)})}this.sendInitialPresenceForAllRooms()}catch(error){const errorMessage="getServerRooms failure: "+(error.data?error.data.errorDetails:error.message);throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}getRoomParticipants(roomData){return __awaiter(this,void 0,void 0,(function*(){try{const limit=100,roomId=roomData.id,total=roomData.activeUsersCounter;let usersData=roomData.users.concat();if(total>limit){usersData=[];const requestCount=total/limit+1;let offset=0;const requests=[];for(let i=1;i<requestCount;i++)requests.push(this.getRoomParticipantPage(roomId,offset,limit)),offset+=limit;(yield Promise.all(requests)).forEach(page=>{usersData=usersData.concat(page.data)}),roomData.users=usersData}return usersData}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getSetOfUsers");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}getRoomParticipantPage(roomId,offset,limit){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}rooms/${roomId}/users?format=full&offset=${offset}&limit=${limit}`,headers=auth_service_1.default.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;return yield response.json()}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getRoomParticipantPage");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}getAllRoomsParticipants(roomsData){return __awaiter(this,void 0,void 0,(function*(){try{const startDate=performance.now(),roomsUsersJids=(yield Promise.all(roomsData.map(roomData=>this.getRoomParticipants(roomData)))).reduce((jids,roomUsers)=>(roomUsers.forEach(roomUser=>{jids[roomUser.jid_im]||(jids[roomUser.jid_im]=!0)}),jids),{}),missingRoomsUsersJids=Object.keys(roomsUsersJids).filter(jid=>{const contact=contact_service_1.default.getContactByJid(jid);return!contact||contact.temp});missingRoomsUsersJids&&missingRoomsUsersJids.length&&(yield contact_service_1.default.getContactsByJids(missingRoomsUsersJids)),yield Promise.all(roomsData.map(roomData=>contact_service_1.default.getContactByDBId(roomData.creator)));const endDate=performance.now();return this.logger.info(`[roomService] getAllRoomsParticipants - get "${missingRoomsUsersJids.length} participants in ${Math.round(endDate-startDate)} ms`),roomsData}catch(error){throw this.logger.error("[roomService] "+error.message),error}}))}createRoomFromData(roomData,doNotSendPresence=!1){const room=room_model_1.Room.create(roomData.id,roomData.jid,roomData.name,roomData.topic,roomData.creationDate,roomData.confEndpoints,roomData.history,roomData.customData,roomData.conference,roomData.avatar,roomData.isActive,roomData.lastActivityDate,roomData.autoRegister,roomData.autoAcceptInvitation,roomData.tags,roomData.containerId,roomData.containerName),owner=contact_service_1.default.dbContacts[roomData.creator];owner?(room.ownerContact=owner,room.owner=owner.jid===contact_service_1.default.userContact.jid):this.logger.warn("[roomService] createRoomFromData -- failure -- Impossible to find owner of room "+roomData.name+" --- ignored"),roomData.users.forEach(userData=>{const contact=contact_service_1.default.getContactById(userData.userId);contact&&(room.users.push({contact:contact,status:userData.status,date:new Date(userData.additionDate),privilege:userData.privilege}),contact_service_1.default.isUserContact(contact)&&(room.status=userData.status))}),room.guestEmails=roomData.guestEmails,this.refreshMemberAndOrganizerLists(room);const ownUser=room.getUserByJid(contact_service_1.default.userContact.jid);if(room.isModerator=ownUser&&ownUser.status!==this.RoomUserStatus.UNSUBSCRIBED&&room.isUserModerator(contact_service_1.default.userContact),this.rooms[room.dbId]&&(this.rooms[room.dbId].initPresPromise&&(room.initPresPromise=this.rooms[room.dbId].initPresPromise,room.initPresInterval=this.rooms[room.dbId].initPresInterval,room.initPresPromiseResolve=this.rooms[room.dbId].initPresPromiseResolve),room.rxSubject=this.rooms[room.dbId].rxSubject,room.initPresenceAck=this.rooms[room.dbId].initPresenceAck),room.updateAvatarInfo(),roomData.lastAvatarUpdateDate){const url=main_service_1.default.cdn?main_service_1.default.cdnServer:config.restServerUrl;room.avatar=url+"/api/room-avatar/"+roomData.id+"?size=512&update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(roomData.lastAvatarUpdateDate)).toString(crypto_js_2.enc.Hex)}return this.rooms[room.dbId]=room,this.roomsByJids[room.jid]=room,this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),"accepted"!==room.status||!room.isActive||room.initPresenceAck||doNotSendPresence||this.sendInitialRoomPresenceSync(room),room}refreshMemberAndOrganizerLists(room){room.organizers=[],room.members=[],room.users.forEach(user=>{(user.status===this.RoomUserStatus.ACCEPTED||user.status===this.RoomUserStatus.INVITED||room.ownerContact&&user.contact.jid===room.ownerContact.jid)&&(user.privilege===room_model_1.Room.Privilege.MODERATOR?room.organizers.push(user):room.members.push(user))})}equalContactsArrayByDbId(contactsA,contactsB){if(contactsA===contactsB)return!0;if(null===contactsA||null===contactsB)return!1;if(contactsA.length!==contactsB.length)return!1;for(let i=0;i<contactsA.length;++i)if(contactsA[i].dbId!==contactsB[i].dbId)return!1;return!0}getOrCreateRoomWithContacts(newContacts,newEmails){return __awaiter(this,void 0,void 0,(function*(){try{let foundRoom=null;const participants=[].concat([contact_service_1.default.userContact],newContacts).sort(this.sortObjectByProperty("dbId"));if(this.getMyRooms().some(room=>!(!room||room.status!==this.RoomUserStatus.ACCEPTED||!this.equalContactsArrayByDbId(room.users.map(user=>user.contact).sort(this.sortObjectByProperty("dbId")),participants))&&(foundRoom=room,this.logger.debug("[roomService] getOrCreateRoomWithContacts - Found Room "+room.getNameForLogs()),!0)),foundRoom)return newEmails.length&&(yield this.addRoomUsers(foundRoom,null,newEmails)),foundRoom;const currentRoomsCount=yield this.retrieveRoomConsumption();if(currentRoomsCount>profile_service_1.default.getFeatureLimitMax(profile_service_1.default.FeaturesEnum.BUBBLE_COUNT))return this.eventService.publish("ON_OPEN_GLOBAL_POPUP",{popupTitle:"createBubble",popupBody:"maxCollabSpaceReached",okLabel:"ok"}),null;const roomNameRoot=contact_service_1.default.userContact.initials+" "+this.i18n.translate("new")+" "+this.i18n.translate("bubble")+" ",escalatedRooms=this.getMyRooms().filter(room=>room&&0===room.name.indexOf(roomNameRoot));let roomName=null,index=1;for(;!roomName;){const tempRoomName=roomNameRoot+index.toString();escalatedRooms.sort(this.sortObjectByProperty("name")).some(room=>room&&room.name===tempRoomName)||(roomName=tempRoomName),index++}return yield this.createRoomWithContacts(roomName,"",newContacts,newEmails)}catch(error){throw this.logger.error("[roomService] getOrCreateRoomWithContacts failure"),error}}))}createRoomWithContacts(roomName,topic,contacts,emails){return __awaiter(this,void 0,void 0,(function*(){try{const room=yield this.createRoom(roomName,topic,!0,null,!0,null,!0);return yield this.addRoomUsers(room,contacts,emails),room}catch(error){const errorMessage=error&&error.message?"createRoomWithContacts failure: "+error.message:"createRoomWithContacts failure";throw this.logger.error("[roomService] "+errorMessage),error&&error.errorDetailsLabel?error:new Error(errorMessage)}}))}setAvatarRoom(roomData,avatarImg){return __awaiter(this,void 0,void 0,(function*(){if(!avatarImg)return roomData;try{const resizedImage=yield imageUtils_service_1.resizeImage(avatarImg,512,512),binaryData=imageUtils_service_1.getBinaryData(resizedImage),url=`${this.portalURL}rooms/${roomData.id}/avatar`,headers=this.authService.getPostHeader("image/"+binaryData.type),response=yield fetch(url,{method:"POST",headers:headers,body:binaryData.data});if(!response.ok)throw response;return yield response.json(),this.logger.info("[roomService] setAvatarRoom -- SUCCESS"),roomData.avatar=`${config.restServerUrl}/api/room-avatar/${roomData.id}?size=512&rand=${randomString_1.default()}`,roomData}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"setAvatarRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}deleteAvatarRoom(roomId){return __awaiter(this,void 0,void 0,(function*(){const url=`${this.portalURL}rooms/${roomId}/avatar`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;this.logger.info("[roomService] avatar room sucessfully deleted")}))}pushContactInRoom(user,room){return __awaiter(this,void 0,void 0,(function*(){try{const contact=yield this.contactService.getContactByDBId(user.userId);room.users.push({contact:contact,status:user.status,date:new Date(user.additionDate),privilege:user.privilege}),this.contactService.isUserContact(contact)&&(room.status=user.status),this.logger.info("[roomService] pushContactInRoom success")}catch(error){this.logger.info("[roomService] pushContactInRoom failure : "+error.message)}}))}addRoomUser(room,contact,reason=null,privilege=null,withoutInvitation=!1){return __awaiter(this,void 0,void 0,(function*(){try{if(room.users.some(user=>(user.status===this.RoomUserStatus.INVITED||user.status===this.RoomUserStatus.ACCEPTED||user.status===this.RoomUserStatus.REJECTED)&&user.contact.dbId===contact.dbId))return this.logger.debug(`[roomService] user: ${contact.dbId} already invited or accepted, will not be added`),room;if(room.users.filter(user=>user.status!==this.RoomUserStatus.DELETED).length>=this.maxRoomsUsers){const profileError=new Error("addRoomUser failure - Not Allowed : Participants max limit has been reached: "+this.maxRoomsUsers);throw profileError.status=profileError.errorDetailsCode="403",this.logger.error("[roomService] "+profileError.message),profileError}const userStatus="boolean"==typeof withoutInvitation&&withoutInvitation?this.RoomUserStatus.ACCEPTED:this.RoomUserStatus.INVITED,userReason=reason||"JustForFun",userPrivilege=privilege||room_model_1.Room.Privilege.USER,url=`${this.portalURL}rooms/${room.dbId}/users`,headers=this.authService.getPostHeader(),body=JSON.stringify({userId:contact.dbId,privilege:userPrivilege,reason:userReason,status:userStatus}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;this.logger.info(`[roomService] addRoomUser ${contact.nameForLogs} to room ${room.dbId} (${room.getNameForLogs()}) success`);const userData=(yield response.json()).data,user=room.getUserByJid(userData.jid_im);return user?(user.status=userData.status,user.date=new Date,user.privilege=userData.privilege):room.users.push({contact:contact,status:userStatus,date:new Date,privilege:userPrivilege}),this.refreshMemberAndOrganizerLists(room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),room}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"addRoomUser");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}addRoomUsers(room,contacts,emails=null){return __awaiter(this,void 0,void 0,(function*(){try{const addRoomUserPromises=[];contacts.forEach(contact=>{room.users.some(user=>{if(user.contact.dbId===contact.dbId){switch(user.status){case this.RoomUserStatus.REJECTED:case this.RoomUserStatus.UNSUBSCRIBED:addRoomUserPromises.push(this.ownerReinviteRejectedUser(room,contact));break;case this.RoomUserStatus.DELETED:addRoomUserPromises.push(this.ownerReinviteDeletedUser(room,contact))}return!0}return!1})||addRoomUserPromises.push(this.addRoomUser(room,contact))}),yield Promise.all(addRoomUserPromises),this.logger.info("[roomService] addRoomUsers success"),this.eventService.publish(this.ROOM_ADD_USERS_EVENT,room),this.inviteGuestEmailToJoinRoom(room,emails)}catch(error){const errorMessage="addRoomUsers failure: "+error.message;throw this.logger.error("[roomService] "+errorMessage),error}}))}deleteRoomUsers(room,contacts){return __awaiter(this,void 0,void 0,(function*(){try{const deleteRoomUserPromises=[];return contacts.forEach(contact=>{room.users.some(user=>user.contact.dbId===contact.dbId)&&deleteRoomUserPromises.push(this.ownerDeletesUserFromRoom(room,contact))}),yield Promise.all(deleteRoomUserPromises),this.logger.info("[roomService] deleteRoomUsers success"),this.eventService.publish(this.ROOM_DELETE_USERS_EVENT,room),room}catch(error){const errorMessage="deleteRoomUsers failure: "+error.message;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}addRoomAndroidTVs(room,contactAndroidTVs){return __awaiter(this,void 0,void 0,(function*(){try{const addRoomAndroidTVPromises=[];return contactAndroidTVs.forEach(contactAndroidTV=>{null!==contactAndroidTV&&addRoomAndroidTVPromises.push(this.addRoomAndroidTV(room,contactAndroidTV))}),yield Promise.all(addRoomAndroidTVPromises),this.logger.info("[roomService] addRoomAndroidTVs success"),this.eventService.publish(this.ROOM_ADD_USERS_EVENT,room),room}catch(error){const errorMessage="addRoomAndroidTVs failure: "+error.message;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}addRoomAndroidTV(room,contact){return __awaiter(this,void 0,void 0,(function*(){try{const reason="androidtv",privilege="moderator",status="accepted",url=`${this.portalURL}rooms/${room.dbId}/users`,headers=this.authService.getPostHeader(),body=JSON.stringify({userId:contact.dbId,privilege:privilege,reason:reason,status:status}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;this.logger.info(`[roomService] addRoomAndroidTV ${contact.nameForLog} to room ${room.dbId} (${room.getNameForLogs()}) success`);const userData=(yield response.json()).data,user=room.getUserByJid(userData.jid_im);return user?(user.status=userData.status,user.date=new Date,user.privilege=userData.privilege):room.users.push({contact:contact,status:status,date:new Date,privilege:privilege}),this.refreshMemberAndOrganizerLists(room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),room}catch(error){if(error.data&&error.data.errorDetails){const errorMessage=`addRoomAndroidTV ${contact.nameForLog} to room ${room.dbId} (${room.getNameForLogs()}) failure: ${error.data.errorDetails}`;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"addRoomAndroidTV");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}sendInitialPresenceForAllRooms(){Object.keys(this.rooms).forEach(key=>{const room=this.rooms[key];room&&!room.initPresPromise&&!room.initPresenceAck&&"accepted"===room.status&&room.isActive&&this.roomPresenceWaitingList.push(room)}),this.sendInitialPresenceForRoomsByParts(15)}allSettled(promises){const wrappedPromises=promises.map(p=>Promise.resolve(p).then(val=>({status:"fulfilled",value:val}),err=>({status:"rejected",reason:err})));return Promise.all(wrappedPromises)}sendInitialPresenceForRoomsByParts(groupSize=10,extraDelay=!1){if(!this.roomPresenceWaitingList||!this.roomPresenceWaitingList.length)return;this.logger.info("[roomService] sendInitialPresenceForRoomsByParts");const arrayLength=this.roomPresenceWaitingList.length,presencePromises=[],delay=extraDelay?3e4:7500;for(let i=0;i<groupSize;i++)this.roomPresenceWaitingList[i]&&presencePromises.push(this.sendInitialRoomPresenceSync(this.roomPresenceWaitingList[i],delay));presencePromises.length&&this.allSettled(presencePromises).then(()=>{this.logger.info("[roomService] sendInitialPresenceForRoomsByParts -- done for group -- presences remaining "+this.roomPresenceWaitingList.length);const addDelay=arrayLength===this.roomPresenceWaitingList.length;this.sendInitialPresenceForRoomsByParts(15,addDelay)})}sendInitialRoomPresence(room,attempt=0){const attemptInfo=attempt?" -- attempt "+attempt:"";this.logger.info("[roomService] sendInitialRoomPresence "+attemptInfo+" -- "+room.getNameForLogs()+" -- "+room.dbId);const presenceIq=strophe_js_1.$pres({to:room.jid+"/"+this.xmppService.fullJid});presenceIq.c("x",{xmlns:"http://jabber.org/protocol/muc"}).c("history",{maxchars:"0"}),this.xmppService.send(presenceIq)}sendInitialRoomPresenceSync(room,intervalDelay=7500){return room.initPresPromise?room.initPresPromise:room.initPresenceAck?(this.logger.info(`[roomService] sendInitialRoomPresenceSync -- ${room.getNameForLogs()} -- ${room.dbId} -- room already activated`),Promise.resolve()):(room.initPresPromise=new Promise((resolve,reject)=>{room.initPresPromiseResolve=resolve,this.sendInitialRoomPresence(room,0);let attemptNumber=0;room.initPresInterval=rxjs_2.interval(intervalDelay).subscribe(()=>{attemptNumber<3?(attemptNumber+=1,this.sendInitialRoomPresence(room,attemptNumber)):(this.logger.error("[roomService] sendInitialRoomPresenceSync : no response after "+attemptNumber+" retries => clean presence promise and interval for "+room.getNameForLogs()+" -- "+room.jid),reject("[roomService] sendInitialRoomPresenceSync : no response"),room.initPresPromise=null,room.initPresInterval&&(room.initPresInterval.unsubscribe(),room.initPresInterval=null),room=this.rooms[room.dbId],this.eventService.publish(this.ROOM_UPDATE_EVENT,room))})}),room.initPresPromise)}sendUnavailableRoomPresence(room){const presenceIq=strophe_js_1.$pres({to:room.jid+"/"+contact_service_1.default.userContact.jid,type:"unavailable"});presenceIq.c("x",{xmlns:"http://jabber.org/protocol/muc"}),this.xmppService.send(presenceIq)}sendAvailableRoomPresence(room){const presenceIq=strophe_js_1.$pres({to:room.jid+"/"+contact_service_1.default.userContact.jid,type:"available"});presenceIq.c("x",{xmlns:"http://jabber.org/protocol/muc"}),this.xmppService.send(presenceIq)}createRoom(roomName,roomDesc,withHistory,roomAvatar,disableNotifications=!0,mediaType=null,createConversation=null,autoAcceptInvitation=!1,muteUponEntry=!1,disableTimeStats=!1){return __awaiter(this,void 0,void 0,(function*(){const roomNameForLogs=roomName.charAt(0)+"***"+roomName.slice(-1);try{this.logger.info('[roomService] createRoom "'+roomNameForLogs+'"'),(void 0===disableNotifications||disableNotifications&&"boolean"!=typeof disableNotifications)&&(disableNotifications=!0),createConversation=createConversation||"true";const history=withHistory?"all":"none",autoAccept=Boolean(autoAcceptInvitation),data={name:roomName,topic:roomDesc,history:history,disableNotifications:disableNotifications,mediaType:null,createConversation:createConversation,autoAcceptInvitation:autoAccept,muteUponEntry:muteUponEntry,disableTimeStats:!1};mediaType&&(data.mediaType=mediaType),disableTimeStats&&(data.disableTimeStats=disableTimeStats);const url=this.portalURL+"rooms/",headers=this.authService.getPostHeader(),body=JSON.stringify(data),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;const roomData=(yield response.json()).data;if(yield this.setAvatarRoom(roomData,roomAvatar),this.rooms[roomData.id])return this.logger.info('[roomService] createRoom -- room "'+roomNameForLogs+'" already exists'),this.rooms[roomData.id];const room=room_model_1.Room.create(roomData.id,roomData.jid,roomData.name,roomData.topic,roomData.creationDate,roomData.confEndpoints,roomData.history,roomData.customData,roomData.conference,roomData.avatar,roomData.isActive,roomData.lastActivityDate,roomData.autoRegister,roomData.autoAcceptInvitation,roomData.tags,roomData.containerId,roomData.containerName);return room.ownerContact=contact_service_1.default.userContact,room.owner=!0,room.isModerator=!0,room.status="accepted",roomData.users.forEach(userData=>{const contact=contact_service_1.default.getContactById(userData.userId);contact&&(room.users.push({contact:contact,status:userData.status,date:new Date(userData.additionDate),privilege:userData.privilege}),contact_service_1.default.isUserContact(contact)&&(room.status=userData.status))}),this.refreshMemberAndOrganizerLists(room),this.rooms[room.dbId]=room,this.roomsByJids[room.jid]=room,this.logger.info('[roomService] createRoom "'+roomNameForLogs+'" -- success'),yield this.sendInitialRoomPresenceSync(room),this.rooms[room.dbId]}catch(error){let message=error;throw error&&error.data&&(message=error.data.errorDetailsCode+" "+error.data.errorDetails),this.logger.error('[roomService] createRoom "'+roomNameForLogs+'" -- failure : '+message),error}}))}updateRoomUser(room,contact,status=null,privilege=null){return __awaiter(this,void 0,void 0,(function*(){try{const data={status:void 0,privilege:void 0};status&&(data.status=status),privilege&&(data.privilege=privilege);const url=`${this.portalURL}rooms/${room.dbId}/users/${contact.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify(data),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;this.logger.info(`[roomService] updateRoomUser ${contact.nameForLogs} to room ${room.dbId} (${room.getNameForLogs()}) success`);const userData=(yield response.json()).data;return room.users.forEach(user=>{user.contact.jid===userData.jid_im&&(user.privilege=userData.privilege,user.status=userData.status)}),this.refreshMemberAndOrganizerLists(room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),room}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="updateRoomUser "+contact.nameForLogs+" to room "+room.dbId+"("+room.getNameForLogs()+") failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"updateRoomUser");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}ownerArchiveRoom(room){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("[roomService] ownerArchiveRoom");const unsubscribeRoomUserPromises=[];room.users.forEach(user=>{contact_service_1.default.isUserContact(user.contact)||user.status===this.RoomUserStatus.DELETED||user.status===this.RoomUserStatus.REJECTED||unsubscribeRoomUserPromises.push(this.unsubscribeUserFromRoom(room,user.contact))});try{yield Promise.all(unsubscribeRoomUserPromises),this.logger.info("[roomService] unsubscribe all other users successfully"),yield this.unsubscribeMeFromRoom(room),this.logger.info("[roomService] ownerArchiveRoom successfully")}catch(error){this.logger.error("[roomService] ownerArchiveRoom failure "+error.message)}}))}unsubscribeUserFromRoom(room,contact){return this.updateRoomUser(room,contact,this.RoomUserStatus.UNSUBSCRIBED)}ownerDeletesUserFromRoom(room,contact){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] ownerDeletesUserFromRoom");const url=`${this.portalURL}rooms/${room.dbId}/users/${contact.dbId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;return this.logger.info(`[roomService] ownerDeletesUserFromRoom ${contact.dbId} from room ${room.dbId} (${room.getNameForLogs()}) success`),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),room}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="ownerDeletesUserFromRoom "+contact.dbId+" from room "+room.dbId+"("+room.getNameForLogs()+") failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerDeletesUserFromRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}ownerReinviteRejectedUser(room,contact,reason=null,privilege=null,withoutInvitation=!1){return __awaiter(this,void 0,void 0,(function*(){try{return yield this.ownerDeletesUserFromRoom(room,contact),yield this.addRoomUser(room,contact,reason,privilege,withoutInvitation),this.logger.info("[roomService] ownerReinviteRejectedUser "+contact.dbId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),room}catch(error){const errorMessage="ownerReinviteRejectedUser failure: "+error.message;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}ownerReinviteDeletedUser(room,contact,reason=null,privilege=null,withoutInvitation=!1){return __awaiter(this,void 0,void 0,(function*(){try{return yield this.addRoomUser(room,contact,reason,privilege,withoutInvitation),this.logger.info("[roomService] ownerReinviteDeletedUser "+contact.dbId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),room}catch(error){const errorMessage="ownerReinviteDeletedUser failure: "+error.message;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}ownerDeleteRoom(room){return __awaiter(this,void 0,void 0,(function*(){const roomId=room.dbId;try{if(!roomId)return this.logger.error("[roomService] ownerDeleteRoom failure because the roomId is empty ..."),null;const url=`${this.portalURL}rooms/${roomId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;return this.logger.info("[roomService] ownerDeleteRoom "+room.dbId+"("+room.getNameForLogs()+") success"),delete this.rooms[room.dbId],this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),room.rxSubject.next(),room}catch(error){let errorMessage="ownerDeleteRoom ("+roomId+") failure: unknown error occurred";throw error&&error.data&&(errorMessage="ownerDeleteRoom ("+roomId+") failure: "+error.data.errorDetails),error&&404===error.status&&(this.logger.info("[roomService] ownerDeleteRoom "+room.dbId+"("+room.getNameForLogs()+") not found, deleting it from local storage"),delete this.rooms[room.dbId],this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room)),this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}ownerUpdateRoom(roomData){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] ownerUpdateRoom");const url=`${this.portalURL}rooms/${roomData.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify({name:roomData.name,topic:roomData.desc,visibility:roomData.type?"public":"private"}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const room=(yield response.json()).data;return this.rooms[room.id].desc=room.topic,this.rooms[room.id].type="private"===room.visibility?room_model_1.Room.Type.PRIVATE:room_model_1.Room.Type.PUBLIC,this.logger.info("[roomService] ownerUpdateRoom successfully ("+room.id+", "+room.jid+")"),this.rooms[room.id]}catch(error){const errorMessage="ownerUpdateRoom failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}}))}checkPromoteOwner(room,contact){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}rooms/${room.dbId}/owners/${contact.dbId}/check`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;this.logger.info("[roomService] checkPromoteOwner "+contact.nameForLogs+" to room "+room.dbId+"("+room.getNameForLogs()+") success")}catch(error){const errorData=yield error.json();this.logger.error("[roomService] Error checkPromoteOwner");const errorDetailsCode=errorData.errorDetailsCode;let bubbleParticipantCountErrorMsg=null,bubblePromoteMemberErrorMsg=null,webRtcConfAllowedErrorMsg=null;const rberror=new RBError("");throw 409002===errorDetailsCode&&errorData.errorDetailsData&&(Array.isArray(errorData.errorDetailsData)?(errorData.errorDetailsData.forEach(errorDetails=>{"BUBBLE_PARTICIPANT_COUNT"===errorDetails.feature?bubbleParticipantCountErrorMsg=this.i18n.translate("promoteToOwnerFailureParticipantCountReached",{name:contact.displayName,maxValue:errorDetails.maxValue}):"WEBRTC_CONFERENCE_ALLOWED"===errorDetails.feature?webRtcConfAllowedErrorMsg=this.i18n.translate("promoteToOwnerFailureWebRtcConferenceAllowed",{name:contact.displayName}):"BUBBLE_PROMOTE_MEMBER"===errorDetails.feature&&(bubblePromoteMemberErrorMsg=this.i18n.translate("promoteToOwnerFailureBubblePromoteMember",{name:contact.displayName}))}),bubbleParticipantCountErrorMsg?(rberror.message=bubbleParticipantCountErrorMsg,rberror.details={promotePossible:!1}):webRtcConfAllowedErrorMsg?(rberror.message=this.i18n.translate("promoteOrganizerToOwnerMsg",{name:contact.displayName}),rberror.details={promotePossible:!0,secondMessage:webRtcConfAllowedErrorMsg}):bubblePromoteMemberErrorMsg&&(rberror.message=this.i18n.translate("promoteOrganizerToOwnerMsg",{name:contact.displayName}),rberror.details={promotePossible:!0,secondMessage:bubblePromoteMemberErrorMsg})):(rberror.message=this.i18n.translate("promoteToOwnerFailureNotInRoom",{name:contact.displayName}),rberror.details={promotePossible:!1})),rberror}}))}getCheckPromoteErrorMsg(responseData,contact){let errorMessage="";return responseData&&responseData.errorDetailsData&&responseData.errorDetailsData.length>0&&responseData.errorDetailsData.every(errorDetails=>"BUBBLE_PARTICIPANT_COUNT"===errorDetails.feature&&(errorMessage=this.i18n.translate("promoteToOwnerFailureParticipantCountReached",{name:contact.displayName}),!0)),errorMessage}changeRoomOwner(room,newOwnerContact){return __awaiter(this,void 0,void 0,(function*(){try{if(this.logger.info("[roomService] changeRoomOwner"),!room||!newOwnerContact){const msg="changeRoomOwner error: - missing room or new owner";throw this.logger.error("[roomService] "+msg),new Error(msg)}const confEndpointId=room.confEndpoints&&room.confEndpoints.length?room.confEndpoints[0].confEndpointId:"";yield this.deleteRoomConferenceEndPoint(room,confEndpointId);const url=`${this.portalURL}rooms/${room.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify({owner:newOwnerContact.dbId}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;return room.ownerContact=newOwnerContact,room.owner=newOwnerContact.jid===contact_service_1.default.userContact.jid,this.logger.info("[roomService] changeRoomOwner successfully ("+room.dbId+")"),this.rooms[room.dbId]}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="changeRoomOwner failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"changeRoomOwner");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}ownerUpdateRoomCustomData(roomData){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] ownerUpdateRoomCustomData");const url=`${this.portalURL}rooms/${roomData.dbId}/custom-data`,headers=this.authService.getPostHeader(),body=JSON.stringify({customData:roomData.customData}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const data=(yield response.json()).data;return this.logger.info("[roomService] ownerUpdateRoomCustomData successfully got ("+JSON.stringify(data,null,4)+")"),data.customData||{}}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="ownerUpdateRoomCustomData failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerUpdateRoomCustomData");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}ownerUpdateRoomNameAndDescription(roomData){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] ownerUpdateRoomNameAndDescription");const url=`${this.portalURL}rooms/${roomData.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify({name:roomData.name,topic:roomData.desc,visibility:roomData.type?"public":"private"}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const room=(yield response.json()).data;return this.rooms[room.id].desc=room.topic,this.rooms[room.id].type="private"===room.visibility?room_model_1.Room.Type.PRIVATE:room_model_1.Room.Type.PUBLIC,(room.conference||room.confEndpoints)&&(this.rooms[room.id].conference=room.conference?room.conference:null,this.rooms[room.id].confEndpoints=room.confEndpoints?room.confEndpoints:[]),this.logger.info("[roomService] ownerUpdateRoomNameAndDescription successfully ("+room.id+", "+room.jid+")"),this.rooms[room.id]}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="ownerUpdateRoomNameAndDescription failure: "+error.data.errorDetails;this.logger.error("[roomService] "+errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerUpdateRoomNameAndDescription");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}ownerUpdateAutoRegister(roomData){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] ownerUpdateAutoRegister");const url=`${this.portalURL}rooms/${roomData.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify({autoRegister:roomData.getAutoRegister()}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const room=(yield response.json()).data;return this.rooms[room.id].setAutoRegister(room.autoRegister),this.rooms[room.id].desc=room.topic,this.rooms[room.id].type="private"===room.visibility?room_model_1.Room.Type.PRIVATE:room_model_1.Room.Type.PUBLIC,(room.conference||room.confEndpoints)&&(this.rooms[room.id].conference=room.conference?room.conference:null,this.rooms[room.id].confEndpoints=room.confEndpoints?room.confEndpoints:[]),this.logger.info("[roomService] ownerUpdateAutoRegister successfully ("+room.id+", "+room.jid+")"),this.rooms[room.id]}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="ownerUpdateAutoRegister failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerUpdateAutoRegister");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}moderatorUpdateRoomConfig(roomData){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] moderatorUpdateRoomConfig");const url=`${this.portalURL}rooms/${roomData.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify({muteUponEntry:roomData.getMuteUponEntry(),disableTimeStats:roomData.getDisableTimeStats()}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const room=(yield response.json()).data;return(room.conference||room.confEndpoints)&&(this.rooms[room.id].conference=room.conference?room.conference:null,this.rooms[room.id].confEndpoints=room.confEndpoints?room.confEndpoints:[]),this.logger.info("[roomService] moderatorUpdateRoomConfig successfully ("+room.id+", "+room.jid+")"),this.rooms[room.id]}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="moderatorUpdateRoomConfig failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerUpdateAutoRegister");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}updateMyRoomUser(room,status){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}rooms/${room.dbId}/users/${contact_service_1.default.userContact.dbId}`,headers=this.authService.getPostHeader(),body=JSON.stringify({status:status}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;return this.logger.info("[roomService] updateMyRoomUser "+contact_service_1.default.userContact.nameForLogs+" to room "+room.dbId+"("+room.getNameForLogs()+") success"),room}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="updateMyRoomUser "+contact_service_1.default.userContact.nameForLogs+" to room "+room.dbId+"("+room.getNameForLogs()+") failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerUpdateAutoRegister");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}unsubscribeMeFromRoom(room){return this.updateMyRoomUser(room,this.RoomUserStatus.UNSUBSCRIBED)}participantCloseRoom(room){return __awaiter(this,void 0,void 0,(function*(){const userId=contact_service_1.default.userContact.dbId;try{this.logger.info("[roomService] participantCloseRoom");const url=`${this.portalURL}rooms/${room.dbId}/users/${userId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;return this.logger.info("[roomService] participantCloseRoom "+userId+" from room "+room.dbId+"("+room.getNameForLogs()+") success"),delete this.rooms[room.dbId],this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),room}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="participantCloseRoom "+userId+" from room "+room.dbId+"("+room.getNameForLogs()+") failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"participantCloseRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}acceptRoomInvitation(room){return this.updateMyRoomUser(room,this.RoomUserStatus.ACCEPTED)}declineRoomInvitation(room){return this.updateMyRoomUser(room,this.RoomUserStatus.REJECTED)}getRoomConferenceEndPoint(room,conferenceEndPointId){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] getRoomConferenceEndPoint");const url=`${this.portalURL}rooms/${room.dbId}/conference/${conferenceEndPointId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const conferenceData=(yield response.json()).data;return this.logger.info("[roomService] getRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"success"),conferenceData}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="getRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getRoomConferenceEndPoint");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}addRoomConferenceEndPoint(room,conferenceEndPoint,mediaType,createConversation){return __awaiter(this,void 0,void 0,(function*(){try{if(this.logger.info("[roomService] addRoomConferenceEndPoint"),!conferenceEndPoint)throw new Error("No ConferenceEndPoint to associate with Room");let alreadyAttached=!1;if(room.confEndpoints.forEach((function(endpoint){endpoint.confEndpointId===conferenceEndPoint.id&&(alreadyAttached=!0)})),alreadyAttached)return this.logger.info("[roomService] addRoomConferenceEndPoint : already attached to room !"),room;const deleteConfEndpointPromises=[];mediaType&&"pstnAudio"===mediaType&&Object.keys(this.rooms).forEach((function(key){this.rooms[key].conference&&!this.rooms[key].conference.scheduled&&this.rooms[key].getPstnConfEndpointId()===conferenceEndPoint.id&&deleteConfEndpointPromises.push(this.deleteRoomConferenceEndPoint(this.rooms[key],conferenceEndPoint.id))})),yield Promise.all(deleteConfEndpointPromises);const url=`${this.portalURL}rooms/${room.dbId}/conferences`,headers=this.authService.getPostHeader(),body=JSON.stringify({confId:conferenceEndPoint.id,createConversation:createConversation||"true"}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;const conferenceData=(yield response.json()).data;return this.logger.debug("[roomService] addRoomConferenceEndPoint response data:"+JSON.stringify(conferenceData)),room.confEndpoints.push(conferenceData),this.logger.info("[roomService] addRoomConferenceEndPoint "+conferenceEndPoint.id+" to room "+room.dbId+"success"),this.eventService.publish(this.ROOM_ADD_CONF_ENDPOINT_EVENT,room),this.sendEvent("ROOM_ADD_CONF_ENDPOINT_EVENT",room),room}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"addRoomConferenceEndPoint");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}deleteRoomConferenceEndPoint(room,conferenceEndPointId){return __awaiter(this,void 0,void 0,(function*(){try{if(this.logger.info("[roomService] deleteRoomConferenceEndPoint"),!room||!conferenceEndPointId)return void this.logger.info("[roomService] deleteRoomConferenceEndPoint : missing parameters ");let roomHasConfEndpoint=!1;if(room.confEndpoints&&room.confEndpoints.length)for(let i=0;i<room.confEndpoints.length;i++)if(room.confEndpoints[i].confEndpointId===conferenceEndPointId){roomHasConfEndpoint=!0;break}if(!roomHasConfEndpoint)return void this.logger.info("[roomService] deleteRoomConferenceEndPoint : room has no such conference attached");const url=`${this.portalURL}rooms/${room.dbId}/conferences/${conferenceEndPointId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"DELETE",headers:headers});if(!response.ok)throw response;room.confEndpoints=(yield response.json()).data,this.logger.info("[roomService] deleteRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"success"),this.eventService.publish(this.ROOM_REMOVE_CONF_ENDPOINT_EVENT,room),this.sendEvent("ROOM_REMOVE_CONF_ENDPOINT_EVENT",room)}catch(error){const errorData=(yield error.json()).data,errorMessage="deleteRoomConferenceEndPoint "+conferenceEndPointId+" from room "+room.dbId+"failure: "+errorData.errorDetails;if(this.logger.error("[roomService] "+errorMessage),404!==error.status)throw new Error(errorMessage);room.confEndpoints=[],this.eventService.publish(this.ROOM_REMOVE_CONF_ENDPOINT_EVENT,room),this.sendEvent("ROOM_REMOVE_CONF_ENDPOINT_EVENT",room)}}))}inviteGuestEmailToJoinRoom(room,emails){return __awaiter(this,void 0,void 0,(function*(){try{if(!emails||!emails.length)return null;this.logger.info("[roomService] inviteGuestEmailToJoinRoom");const url=`${this.portalURL}rooms/${room.dbId}/invitations`,headers=this.authService.getPostHeader(),body=JSON.stringify({scenario:"chat",emails:emails,lang:contact_service_1.default.userContact.language}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;return room.guestEmails=(yield response.json()).data.guestEmails,this.eventService.publish("ROOM_UPDATE_EVENT",room),room}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"inviteGuestEmailToJoinRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}ownerCancelGuestFromRoom(room,emails){return __awaiter(this,void 0,void 0,(function*(){try{if(this.logger.info("[roomService] ownerCancelGuestFromRoom"),!emails||!emails.length)return Promise.resolve(room);const data={emails:emails,scenario:"chat",lang:contact_service_1.default.userContact.language};room&&room.isMyPersonalMeetingRoom()&&room.getPstnConfEndpointId()&&(data.scenario="pstn-conference",data.confId=room.getPstnConfEndpointId());const url=`${this.portalURL}rooms/${room.dbId}/invitations/cancel`,headers=this.authService.getPostHeader(),body=JSON.stringify(data),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;return room.guestEmails=(yield response.json()).data.guestEmails,this.eventService.publish("ROOM_UPDATE_EVENT",room),room}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"ownerCancelGuestFromRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}notifyRoomUsersJoinConference(room,users,emails){return __awaiter(this,void 0,void 0,(function*(){const conferenceEndPointId=room.getPstnConfEndpointId();try{if(this.logger.info("[roomService] notifyRoomUsersJoinConference"),!conferenceEndPointId)return room;const instantMessage=room.desc,data={scenario:"pstn-conference",confId:conferenceEndPointId,noMail:"false",update:"false",users:users?users.map((function(user){return user.dbId})):void 0,emails:emails,instantMessage:instantMessage,lang:contact_service_1.default.userContact.language},url=`${this.portalURL}rooms/${room.dbId}/invitations`,headers=this.authService.getPostHeader(),body=JSON.stringify(data),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;return this.logger.info("[roomService] notifyRoomUsersJoinConference "+conferenceEndPointId+" from room "+room.dbId+"success"),this.rooms[room.dbId].guestEmails=emails,this.eventService.publish("ROOM_UPDATE_EVENT",this.rooms[room.dbId]),this.rooms[room.dbId]}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="notifyRoomUsersJoinConference "+conferenceEndPointId+" from room "+room.dbId+"failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"notifyRoomUsersJoinConference");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}notifyUsersCancelConference(room,users,emails){return __awaiter(this,void 0,void 0,(function*(){const conferenceEndPointId=room.getPstnConfEndpointId();try{if(this.logger.debug("[roomService] notifyUsersCancelConference"),!conferenceEndPointId)return room;const data={scenario:"pstn-conference",confId:conferenceEndPointId,noMail:"false",users:users?users.map((function(user){return user.dbId})):void 0,emails:emails,lang:contact_service_1.default.userContact.language},url=`${this.portalURL}rooms/${room.dbId}/invitations`,headers=this.authService.getPostHeader(),body=JSON.stringify(data),response=yield fetch(url,{method:"DELETE",headers:headers,body:body});if(!response.ok)throw response;return this.logger.info("[roomService] notifyUsersCancelConference "+conferenceEndPointId+" from room "+room.dbId+"success"),this.rooms[room.dbId].guestEmails=this.rooms[room.dbId].guestEmails.filter((function(email){return-1===emails.indexOf(email)})),this.eventService.publish("ROOM_UPDATE_EVENT",this.rooms[room.dbId]),this.rooms[room.dbId]}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="notifyUsersCancelConference "+conferenceEndPointId+" from room "+room.dbId+"failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"notifyUsersCancelConference");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}getRoomByConferenceEndpointId(conferenceEndpointId){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[roomService] getRoomFromConferenceEndpointId");const url=`${this.portalURL}rooms?userId=${contact_service_1.default.userContact.dbId}&confId=${conferenceEndpointId}&format=full`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;this.logger.info("[roomService] getRoomFromConferenceEndpointId -- "+conferenceEndpointId+" -- success");const roomData=(yield response.json()).data;if(roomData.length)return this.getRoomById(roomData[0].id)||this.createRoomFromData(roomData[0]),this.getRoomById(roomData[0].id);throw this.logger.info("[roomService] getRoomFromConferenceEndpointId -- no room with confId "+conferenceEndpointId),new Error("no room with confId "+conferenceEndpointId)}catch(error){if(error.data&&error.data.errorDetails){const errorMessage="getRoomFromConferenceEndpointId -- "+conferenceEndpointId+" -- failure: "+error.data.errorDetails;throw this.logger.error("[roomService] "+errorMessage),new Error(errorMessage)}const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getRoomByConferenceEndpointId");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}onRoomMessage(stanza){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("[roomService] onRoomMessage");try{const eventElem=$(stanza).find("event");if(eventElem.length>0){const eventName=eventElem.attr("name");if("conferenceAdd"===eventName||"conferenceRemove"===eventName||"invitation"===eventName)return!0}const roomId=$(stanza).find("x").attr("thread"),room=yield this.getServerRoom(roomId);return room.isMeetingRoom()&&this.eventService.publish("MEETING_CREATED_EVENT",room),this.computeInvitationCounter(),this.eventService.publish(this.ROOM_INVITATION,room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),!0}catch(error){return this.logger.error("[roomService] onRoomMessage error "+error),!0}}))}onRoomNotificationMessage(stanza){try{const stanzaElem=$(stanza),xElem=stanzaElem.find("x");if(stanzaElem.find("event").length&&xElem.length){const eventName=stanzaElem.find("event").attr("name");if(!eventName||"invitation"!==eventName)return!0;const roomId=$(xElem[0]).attr("roomid");if(!roomId)return this.logger.info("[roomService] onRoomNotificationMessage error -- missing roomId"),!0;this.logger.info("[roomService] onRoomNotificationMessage : room event message with roomId "+roomId+" and event name "+eventName),this.getServerRoom(roomId).then(room=>{room.isMeetingRoom()&&this.eventService.publish("MEETING_CREATED_EVENT",room),"true"===this.settingsService.getSetting("autoAcceptRoomInvite")?this.acceptRoomInvitation(room):(this.computeInvitationCounter(),this.eventService.publish(this.ROOM_INVITATION,room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),"accepted"===room.status&&room.confEndpoints&&room.confEndpoints.length?"webrtc"===room.confEndpoints[0].mediaType&&this.eventService.publish("ON_CONFERENCE_STARTED_INVITATION",room):(this.computeInvitationCounter(),this.eventService.publish(this.ROOM_INVITATION,room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),"accepted"===room.status&&room.confEndpoints&&room.confEndpoints.length&&"webrtc"===room.confEndpoints[0].mediaType&&this.eventService.publish("ON_CONFERENCE_STARTED_INVITATION",room),this.logger.info("[roomService] onRoomNotificationMessage -- get server room success for roomId "+room.dbId+" and roomJid"+room.jid+" and name "+room.getNameForLogs())))}).catch(error=>{this.logger.error("[roomService] onRoomNotificationMessage failure :  impossible to get associated room : "+error.message)})}return!0}catch(error){return this.logger.error("[roomService] onRoomNotificationMessage error "+error),!0}}onRoomInfoMessage(stanza){this.logger.info("[roomService] onRoomInfoMessage");try{if($(stanza).find("event").length>0){this.logger.info("[roomService] onRoomInfoMessage : room event message");const fromJid=$(stanza).attr("from"),roomBareJid=this.xmppService.getBareJidFromJid(fromJid),userJid=$(stanza).find("event").attr("jid"),eventName=$(stanza).find("event").attr("name"),msgId=$(stanza).attr("id");if(this.logger.info("[roomService] onRoomInfoMessage : room event message with parameters "+roomBareJid+" || "+userJid+" || "+eventName+" || "+msgId),roomBareJid&&userJid&&eventName&&msgId){const room=this.getRoomByJid(roomBareJid);if(!room)return this.manageEventForNonExistingRoom(roomBareJid,eventName,userJid),!0;const user=room.getUserByJid(userJid);switch(user&&"deleted"!==user.status&&this.eventService.publish(this.ROOM_ADMIN_MESSAGE_EVENT,roomBareJid,userJid,eventName,msgId),eventName){case"conferenceAdd":setTimeout(()=>{this.getServerRoom(room.dbId).then(updatedRoom=>{const info=updatedRoom.confEndpoints&&updatedRoom.confEndpoints[0]?updatedRoom.confEndpoints[0].confEndpointId:void 0;if(updatedRoom.getPstnConfEndpointId()&&updatedRoom.isMeetingRoom()&&(this.currentPersonalAudioRoomId=room.dbId),!updatedRoom.isMeetingRoom()&&!contact_service_1.default.userContact.webrtcAudioEnabled)return!0;this.logger.info("[roomService] onRoomInfoMessage : conferenceAdd event with conferenceObject related to room : "+info),this.eventService.publish("ROOM_UPDATE_CONFID",updatedRoom),this.eventService.publish("ROOM_ADD_CONF_ENDPOINT_EVENT",updatedRoom),this.sendEvent("ROOM_ADD_CONF_ENDPOINT_EVENT",updatedRoom),updatedRoom.rxSubject.next(event_model_1.RBEvent.create("ROOM_ADD_CONF_ENDPOINT_EVENT")),this.eventService.publish("ON_CONFERENCE_STARTED_INVITATION",updatedRoom,user)})},1e3);break;case"conferenceRemove":this.getServerRoom(room.dbId).then(updatedRoom=>{room.getPstnConfEndpointId()&&!updatedRoom.getPstnConfEndpointId()&&(this.currentPersonalAudioRoomId=""),this.logger.info("[roomService] onRoomInfoMessage : conferenceRemove event"),this.eventService.publish("ROOM_REMOVE_CONF_ENDPOINT_EVENT",updatedRoom),this.sendEvent("ROOM_REMOVE_CONF_ENDPOINT_EVENT",updatedRoom),updatedRoom.rxSubject.next(event_model_1.RBEvent.create("ROOM_REMOVE_CONF_ENDPOINT_EVENT")),this.eventService.publish("ON_CONFERENCE_ENDED_INVITATION",updatedRoom)});break;case"invitation":!room.isUserModerator(contact_service_1.default.userContact)||user&&user.status!==this.RoomUserStatus.DELETED||this.getServerRoom(room.dbId).then(updatedRoom=>{this.eventService.publish(this.ROOM_UPDATE_EVENT,updatedRoom),this.sendEvent(this.ROOM_UPDATE_EVENT,room)})}}}else if($(stanza).find("subject").length>0){const fromJid=$(stanza).attr("from"),fromBareJid=this.xmppService.getBareJidFromJid(fromJid),room=this.getRoomByJid(fromBareJid),topic=$(stanza).find("subject").text();room&&topic&&(this.logger.info("[roomService] onRoomInfoMessage : update subject of room"),room.desc=topic,this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room))}return!0}catch(error){return this.logger.error("[roomService] onRoomInfoMessage error "+error),!0}}onRoomHistoryInfoMessage(stanza){const changedElem=$(stanza).find("changed");if(changedElem.length>0){const roomId=changedElem.attr("with"),room=this.getRoomByJid(roomId);this.logger.debug("[roomService] onRoomHistoryInfoMessage with "+roomId),this.eventService.publish(this.ROOM_HISTORY_UPDATE_EVENT,room)}return!0}onRoomMessageConfig(stanza){return __awaiter(this,void 0,void 0,(function*(){try{const stanzaElem=$(stanza),roomElem=stanzaElem.find("room"),userId=roomElem.attr("userjid"),userStatus=roomElem.attr("status"),delayElem=stanzaElem.find("delay");if(delayElem.length>0&&"Offline Storage"===delayElem.text())return!0;if(roomElem.length>0){const roomId=roomElem.attr("roomid"),logMessage=`onRoomMessageConfig -- management -- ${roomId} --`,room=this.getRoomById(roomId);let serverUpdateMandatory=!1;if(room){const topic=roomElem.attr("topic"),name=roomElem.attr("name");(name||topic)&&(this.logger.info(logMessage+" update name or topic"),room.name=name,room.desc=topic||"");const guestsElem=roomElem.find("guests");guestsElem.length>0&&"update"===guestsElem.attr("action")&&(this.logger.info(logMessage+" update guests"),room.guestEmails=[],$(guestsElem).find("email").each((__index,emailElem)=>{room.guestEmails.push(emailElem.textContent)}));const customData=roomElem.attr("customData");if(customData)try{const extractedContent=this.extractHtmlContent(customData);room.customData=JSON.parse(extractedContent),this.logger.info(logMessage+" handle customData")}catch(err){this.logger.error(`${logMessage} handle customData -- FAILURE -- ${err.message}`),room.customData="{}"}const avatarElem=stanzaElem.find("avatar"),lastAvatarUpdateDate=roomElem.attr("lastAvatarUpdateDate"),avatarType=avatarElem.length>0&&"delete"===avatarElem.attr("action")?"delete":"update";if(room&&(lastAvatarUpdateDate||"delete"===avatarType)&&(this.logger.info(logMessage+" update avatar"),serverUpdateMandatory=!0),userStatus){this.logger.info(logMessage+" update user status");const user=room.getUserByJid(userId);user?this.updateUserStatus(room,user,userStatus):(this.logger.info(logMessage+" update user status -- room exists, but user not. Update the room"),serverUpdateMandatory=!0)}const privilege=roomElem.attr("privilege");if(privilege){this.logger.info(`${logMessage} update user's privilege ${privilege}`);const user=userId?room.getUserByJid(userId):null;if(serverUpdateMandatory=!0,"owner"===privilege&&user&&user.contact&&user.contact.jid===contact_service_1.default.userContact.jid){room.ownerContact=user.contact,room.owner=!0;const message=this.i18n.translate("promotedToOwner",{name:escape(room.name)});this.eventService.publish("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}user&&user.contact&&(yield contact_service_1.default.getContactByDBId(user.contact.dbId,!0))}const tagsElem=roomElem.find("tags");if(tagsElem&&tagsElem.length){this.logger.info(logMessage+" update room tags");const action=tagsElem.attr("action");this.logger.info(`${logMessage} action = ${action}`);const tagList=tagsElem.find("tag");"update"===action&&(room.tags=[],tagList&&tagList.length&&tagList.each((__index,tagElem)=>{const value=tagElem.getAttribute("value"),color=tagElem.getAttribute("color"),emoji=tagElem.getAttribute("emoji"),tagData={};value&&(tagData.tag=value),color&&(tagData.color=color),emoji&&(tagData.emoji=emoji),room.tags.push(tagData)}))}serverUpdateMandatory&&(yield this.updateRoomFromServer(room)),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),room.rxSubject.next()}else if(void 0===room&&roomId&&!this.roomsInProgress[roomId]&&"deleted"!==userStatus&&"rejected"!==userStatus){this.logger.info(logMessage+" room does not exist, create new one"),this.roomsInProgress[roomId]=!0;const newRoom=yield this.getServerRoom(roomId);delete this.roomsInProgress[roomId],this.logger.info(logMessage+" sendInitialRoomPresence to the new room"),this.sendInitialRoomPresence(newRoom),this.updateLater[roomId]&&(delete this.updateLater[roomId],this.logger.info("[roomService] onRoomMessageConfig -- later update of the new room"),this.getServerRoom(roomId).then(roomToUpdate=>{roomToUpdate.updateAvatarInfo()}))}else this.roomsInProgress[roomId]&&(this.updateLater[roomId]=roomId)}const openinviteElem=stanzaElem.find("openinvite");if(openinviteElem.length>0){this.logger.info("[roomService] onRoomMessageConfig -- openinvite");const openInviteAction=openinviteElem.attr("action"),roomId=openinviteElem.find("roomid").text(),openInviteId=openinviteElem.find("openinviteid").text(),roomType=openinviteElem.find("roomType").text();switch(openInviteAction){case"update":{let shouldDeletePreviousPersonalAudioRoomAssociation=!1;"personal_audio_room"!==roomType||roomId||(shouldDeletePreviousPersonalAudioRoomAssociation=!0),Object.keys(this.openInviteIdByRoomId).forEach((function(key){this.openInviteIdByRoomId[key]&&this.openInviteIdByRoomId[key].openInviteId===openInviteId&&key!==roomId&&(this.logger.info("[roomService] onRoomMessageConfig -- openinviteId removed from "+key),delete this.openInviteIdByRoomId[key],this.openInviteIdByRoomIdSubject.next({openInviteId:openInviteId,roomType:roomType,id:roomId,action:"deleted"})),shouldDeletePreviousPersonalAudioRoomAssociation&&"personal_audio_room"===this.openInviteIdByRoomId[key].roomType&&delete this.openInviteIdByRoomId[key]}))}case"create":roomId&&openInviteId&&(this.openInviteIdByRoomId[roomId]={},this.openInviteIdByRoomId[roomId].roomType=roomType,this.openInviteIdByRoomId[roomId].openInviteId=openInviteId,this.openInviteIdByRoomId[roomId].openInviteLink=(config.webservices.protocol+"://meet."+config.webservices.server).replace(".red",".com")+"/"+openInviteId,this.openInviteIdByRoomIdSubject.next({openInviteId:openInviteId,roomType:roomType,id:roomId,action:"updated"}),this.logger.info("[roomService] onRoomMessageConfig -- openinviteId "+openInviteId+" assigned to room "+roomId),this.eventService.publish("ON_OPEN_INVITE_ID_UPDATED_EVENT",this.rooms[roomId]),"personal_audio_room"===roomType&&this.eventService.publish("ON_PERSONAL_MEETING_OPEN_INVITE_ID_UPDATED_EVENT"));break;case"delete":Object.keys(this.openInviteIdByRoomId).forEach((function(key){this.openInviteIdByRoomId[key]&&this.openInviteIdByRoomId[key].openInviteId===openInviteId&&key===roomId&&(this.logger.info("[roomService] onRoomMessageConfig -- openinviteId removed from "+key),delete this.openInviteIdByRoomId[key],this.openInviteIdByRoomIdSubject.next({openInviteId:openInviteId,roomType:roomType,id:roomId,action:"deleted"}),this.eventService.publish("ON_OPEN_INVITE_ID_DELETED_EVENT",this.rooms[roomId]))}));break;default:this.logger.info("[roomService] onRoomMessageConfig -- openinviteId - unkown action : "+openInviteAction)}}const meetingElem=stanzaElem.find("meeting");if("management"===stanzaElem.attr("type")&&meetingElem.length>0){this.logger.debug("[roomService] onRoomMessageConfig -- management meeting event");const meetingAction=meetingElem.attr("action"),roomId=meetingElem.find("roomid").length?meetingElem.find("roomid").text():"";switch(meetingAction){case"saved":this.currentPersonalAudioRoomId="",this.logger.debug("meeting saved: "+roomId),this.sendEvent("ON_MEETING_SAVED_EVENT",roomId);break;case"deleted":this.logger.debug("meeting deleted: "+roomId),this.currentPersonalAudioRoomId="",this.sendEvent("ON_MEETING_DELETED_EVENT",roomId);break;case"created":this.logger.debug("meeting created: "+roomId),this.personalAudioRoomId=roomId,this.currentPersonalAudioRoomId=roomId,this.sendEvent("ON_MEETING_CREATED_EVENT",roomId);break;case"updated":this.logger.debug("meeting updated: "+roomId),this.personalAudioRoomId=roomId,this.currentPersonalAudioRoomId=roomId,this.sendEvent("ON_MEETING_UPDATED_EVENT",roomId)}}const roomscontainerElem=stanzaElem.find("roomscontainer");if("management"===stanzaElem.attr("type")&&roomscontainerElem.length>0){const containerId=roomscontainerElem.attr("containerid"),containerName=roomscontainerElem.attr("name");switch(roomscontainerElem.attr("action")){case"update":{const addedRooms=[],addedElem=roomscontainerElem.find("added");addedElem.length&&(addedElem.find("roomid").each((__index,roomIdElem)=>{addedRooms.push(roomIdElem.textContent)}),addedRooms.forEach(roomId=>{this.rooms[roomId]&&(this.rooms[roomId].containerId=containerId,this.rooms[roomId].containerName=containerName)}));const removedRooms=[],removedElem=roomscontainerElem.find("removed");removedElem.length&&(removedElem.find("roomid").each((__index,roomIdElem)=>{removedRooms.push(roomIdElem.textContent)}),removedRooms.forEach(roomId=>{this.rooms[roomId]&&(this.rooms[roomId].containerId="",this.rooms[roomId].containerName="")})),(addedRooms.length||removedRooms.length)&&this.sendEvent(this.ROOM_UPDATE_EVENT,null);break}case"create":{const addedRooms=[],addedElem=roomscontainerElem.find("added");addedElem.length&&(addedElem.find("roomid").each((__index,roomIdElem)=>{addedRooms.push(roomIdElem.textContent)}),addedRooms.forEach(roomId=>{this.rooms[roomId]&&(this.rooms[roomId].containerId=containerId,this.rooms[roomId].containerName=containerName)})),addedRooms.length&&this.sendEvent(this.ROOM_UPDATE_EVENT,null);break}case"delete":{const rooms=this.getRoomsByContainerId(containerId);rooms.forEach(room=>{this.rooms[room.dbId].containerId="",this.rooms[room.dbId].containerName=""}),rooms.length&&this.sendEvent(this.ROOM_UPDATE_EVENT,null);break}}}return!0}catch(error){return this.logger.info("[roomService] onRoomMessageConfig  -- failure -- "+error.message),!0}}))}extractHtmlContent(html){const parser=new DOMParser;let content="{}";try{content=parser.parseFromString(html,"text/html").documentElement.textContent}catch(error){this.logger.error("[roomService] error in extractHtmlContent:"+error.message),content="{}"}return content}onRoomPresence(stanza){try{const stanzaElem=$(stanza),fromJid=stanzaElem.attr("from"),fromRoomBareJid=this.xmppService.getBareJidFromJid(fromJid);let fromUserJid=this.xmppService.getResourceFromJid(fromJid);const statusElems=stanzaElem.find("status");let statusCode=null;statusElems.each((function(__index,statusElem){"332"===$(statusElem).attr("code")&&(statusCode="332"),"338"===$(statusElem).attr("code")&&(statusCode="338"),"339"===$(statusElem).attr("code")&&(statusCode="339")}));const room=this.getRoomByJid(fromRoomBareJid);return room&&("338"===statusCode?(this.logger.info("[roomService] onRoomPresence - "+room.dbId+"- Deactivated"),room.isActive=!1,this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room)):"339"===statusCode?(this.logger.info("[roomService] onRoomPresence - "+room.dbId+"- Reactivated"),room.initPresenceAck=!1,this.sendInitialRoomPresenceSync(room),room.isActive=!0,this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room)):(this.logger.info("[roomService] onRoomPresence -- "+room.dbId),-1!==fromUserJid.indexOf("/")&&(fromUserJid=this.xmppService.getBareJidFromJid(fromUserJid)),contact_service_1.default.isUserContactJid(fromUserJid)?"332"===statusCode?(this.logger.error("[roomService] disconnected from room "+room.getNameForLogs()+" because of a system shutdown"),room.initPresenceAck=!1,this.sendInitialRoomPresenceSync(room)):(room.initPresenceAck=!0,this.roomPresenceWaitingList&&this.roomPresenceWaitingList.length&&this.roomPresenceWaitingList.forEach((waitingListRoom,index)=>{waitingListRoom.dbId===room.dbId&&this.roomPresenceWaitingList.splice(index,1)}),room.initPresPromise&&(this.logger.info("[roomService] onRoomPresence - initPresPromise resolved"),room.initPresPromiseResolve(room),room.initPresInterval&&(room.initPresInterval.unsubscribe(),room.initPresInterval=null),room.initPresPromise=null,room.initPresPromiseResolve=null,this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room))):room.dbId&&!this.rooms[room.dbId]&&this.getServerRoom(room.dbId))),!0}catch(error){return this.logger.error("[roomService] onRoomPresence error "+error),!0}}updateUserStatus(room,user,status){if(this.logger.info("[roomService] "+user.status+" || "+status),contact_service_1.default.isUserContactJid(user.contact.jid)&&user.status!==status)switch(this.logger.info("[roomService] my new status "+status),status){case"deleted":delete this.roomsByJids[room.jid],delete this.rooms[room.dbId],this.logger.info("[roomService] deleteRoom successfully ("+room.dbId+")"),this.sendUnavailableRoomPresence(room),this.computeInvitationCounter(),room.isMeetingRoom()&&this.eventService.publish("MEETING_DELETE_EVENT",room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room,"remove"),this.sendEvent(this.ROOM_UPDATE_EVENT,room);break;case"unsubscribed":this.logger.info("[roomService] unsubscribed successfully ("+room.dbId+")"),this.sendUnavailableRoomPresence(room),room.status=this.RoomUserStatus.UNSUBSCRIBED,user.status=status,room.updateAvatarInfo(),room.isModerator=!1,room.initPresenceAck=!1,this.computeInvitationCounter(),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room);break;case"accepted":room.status=this.RoomUserStatus.ACCEPTED,user.status=status,this.fileStorageService.retrieveReceivedFilesForRoom(room.dbId).then(()=>{this.sendInitialRoomPresenceSync(room),room.updateAvatarInfo(),this.computeInvitationCounter(),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room),this.getServerRoom(room.dbId).then(updatedRoom=>{this.eventService.publish(this.ROOM_UPDATE_EVENT,updatedRoom),this.sendEvent(this.ROOM_UPDATE_EVENT,updatedRoom),updatedRoom.confEndpoints&&updatedRoom.confEndpoints.length&&"webrtc"===updatedRoom.confEndpoints[0].mediaType&&this.eventService.publish("ON_CONFERENCE_STARTED_INVITATION",updatedRoom)}).catch((function(){this.logger.warn("[roomService] getServerRoom "+room.dbId+" failed")}))});break;case"rejected":delete this.roomsByJids[room.jid],delete this.rooms[room.dbId],room.status=this.RoomUserStatus.REJECTED,user.status=status,this.computeInvitationCounter(),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room)}else user&&!contact_service_1.default.isUserContactJid(user.contact.jid)&&(this.logger.info("[roomService] Update user with status "+status),user.status===this.RoomUserStatus.DELETED&&status===this.RoomUserStatus.ACCEPTED&&(user.date=new Date,user.privilege===room_model_1.Room.Privilege.MODERATOR&&(user.privilege=room_model_1.Room.Privilege.USER)),user.status=status,room.updateAvatarInfo(),this.refreshMemberAndOrganizerLists(room),this.eventService.publish(this.ROOM_UPDATE_EVENT,room),this.sendEvent(this.ROOM_UPDATE_EVENT,room))}findRoomsWithConfId(confId){return this.getRooms().filter((function(room){return!(!room.confEndpoints||!room.confEndpoints.length)&&room.confEndpoints.some((function(confEndpoint){return confEndpoint.confEndpointId===confId}))}))}removeConfIdInAllRooms(rooms){const actionPromises=[];return rooms.forEach(room=>{room.confEndpoints&&room.confEndpoints.length>0&&actionPromises.push(this.deleteRoomConferenceEndPoint(room,room.confEndpoints[0].confEndpointId))}),Promise.all(actionPromises)}resetOpenInviteId(roomId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`{this.portalURL}users/${contact_service_1.default.userContact.dbId}"/public-links/reset`,headers=auth_service_1.default.getRequestHeader(),body=JSON.stringify({roomId:roomId}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;const openInviteData=(yield response.json()).data;return openInviteData&&openInviteData.openInviteId&&openInviteData.roomId&&(this.logger.info("[roomService] resetOpenInviteId success - openinviteId "+openInviteData.openInviteId+" bound to room "+roomId),this.openInviteIdByRoomId[openInviteData.roomId]={},this.openInviteIdByRoomId[openInviteData.roomId].roomType=openInviteData.roomType,this.openInviteIdByRoomId[openInviteData.roomId].openInviteId=openInviteData.openInviteId,this.openInviteIdByRoomId[openInviteData.roomId].openInviteLink=(config.webservices.protocol+"://meet."+config.webservices.server).replace(".red",".com")+"/"+openInviteData.openInviteId),openInviteData.openInviteId}catch(error){const errorMessage="resetOpenInviteId failure";throw this.logger.error("[contactService] "+errorMessage),new Error(errorMessage)}}))}bindOpenInviteIdToRoom(room){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}users/${contact_service_1.default.userContact.dbId}/public-links/bind`,headers=this.authService.getPostHeader(),body=JSON.stringify({roomId:room.dbId}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;const openInviteData=(yield response.json()).data;if(openInviteData&&openInviteData.roomId&&openInviteData.roomType&&openInviteData.openInviteId)return this.logger.info(`[roomService] createRoomOpenInviteId -- SUCCESS - room ${openInviteData.roomId} with type ${openInviteData.roomType} bound to openInviteId ${openInviteData.openInviteId}`),this.openInviteIdByRoomId[openInviteData.roomId]={},this.openInviteIdByRoomId[openInviteData.roomId].roomType=openInviteData.roomType,this.openInviteIdByRoomId[openInviteData.roomId].openInviteId=openInviteData.openInviteId,this.openInviteIdByRoomId[openInviteData.roomId].openInviteLink=(config.webservices.protocol+"://meet."+config.webservices.server).replace(".red",".com")+"/"+openInviteData.openInviteId,this.rooms[room.dbId];throw new Error("[roomService] No or unvalid openInviteData")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"bindOpenInviteIdToRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}unbindOpenInviteFromRoom(roomId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}users/${contact_service_1.default.userContact.dbId}/public-links/unbind`,headers=this.authService.getPostHeader(),body=JSON.stringify({roomId:roomId}),response=yield fetch(url,{method:"PUT",headers:headers,body:body});if(!response.ok)throw response;return void this.logger.info("[roomService] openInvite successfully unbound")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"unbindOpenInviteFromRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}joinRoomUsingOpenInviteId(openInviteId){return __awaiter(this,void 0,void 0,(function*(){try{const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/rooms/open-invites",headers=this.authService.getPostHeader(),body=JSON.stringify({openInviteId:openInviteId}),response=yield fetch(url,{method:"POST",headers:headers,body:body});if(!response.ok)throw response;const openInvitesData=(yield response.json()).data;if(openInvitesData&&openInvitesData.roomId)return openInvitesData.roomId;throw new Error("No roomId info in openInvitation")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"unbindOpenInviteFromRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}retrieveOpenInviteData(type=null,roomId=null){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("[roomService] retrieveOpenInviteData - type: "+type+" - roomId: "+roomId);try{let urlParams="";roomId&&(urlParams+="?roomId="+roomId),type&&(urlParams+=urlParams?"&type="+type:"?type="+type);const url=this.portalURL+"users/"+contact_service_1.default.userContact.dbId+"/public-links"+urlParams,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const openInviteData=(yield response.json()).data;openInviteData&&openInviteData.length?(this.logger.debug("[roomService] retrieveOpenInviteData -- SUCCESS - found "+openInviteData.length),openInviteData.forEach(openInvitePair=>{openInvitePair.roomId&&(this.openInviteIdByRoomId[openInvitePair.roomId]={},this.openInviteIdByRoomId[openInvitePair.roomId].roomType=openInvitePair.roomType,this.openInviteIdByRoomId[openInvitePair.roomId].openInviteId=openInvitePair.openInviteId,this.openInviteIdByRoomId[openInvitePair.roomId].openInviteLink=(config.webservices.protocol+"://meet."+config.webservices.server).replace(".red",".com")+"/"+openInvitePair.openInviteId,this.logger.debug("[roomService] retrieveOpenInviteData - openInviteId "+openInvitePair.openInviteId+" set for room "+openInvitePair.roomId))})):this.logger.debug("[roomService] retrieveOpenInviteData -- FAILURE - none found")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrieveOpenInviteData");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}retrieveOpenInviteIdForRoom(roomId){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("[roomService] retrieveOpenInviteIdForRoom - roomId: "+roomId);try{const url=`${this.portalURL}rooms/${roomId}/public-links`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const openInviteData=(yield response.json()).data;return openInviteData.openInviteId&&(this.openInviteIdByRoomId[roomId]={},this.openInviteIdByRoomId[roomId].roomType="default",this.openInviteIdByRoomId[roomId].openInviteId=openInviteData.openInviteId,this.openInviteIdByRoomId[roomId].openInviteLink=(config.webservices.protocol+"://meet."+config.webservices.server).replace(".red",".com")+"/"+openInviteData.openInviteId,this.logger.debug("[roomService] retrieveOpenInviteIdForRoom - openInviteId "+openInviteData.openInviteId+" set for room "+roomId)),openInviteData.openInviteId}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrieveOpenInviteIdForRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}updateRoomConfEndpoint(oldConfId,newConfId){const rooms=this.findRoomsWithConfId(oldConfId);rooms&&rooms.length&&rooms.forEach(room=>{room.confEndpoints.forEach(endpoint=>{endpoint.confEndpointId===oldConfId&&(endpoint.confEndpointId=newConfId)}),this.getServerRoom(room.dbId).then(servRoom=>{this.eventService.publish(this.ROOM_UPDATE_EVENT,servRoom)}),this.sendEvent("ROOM_ADD_CONF_ENDPOINT_EVENT",room)})}retrievePersonalAudioRoom(force=!1){return __awaiter(this,void 0,void 0,(function*(){if(!force&&this.personalAudioRoomId&&this.getRoomById(this.personalAudioRoomId))return this.logger.debug("[roomService] retrievePersonalAudioRoom from service data"),this.getRoomById(this.personalAudioRoomId);try{this.logger.debug("[roomService] retrievePersonalAudioRoom from server");const url=this.portalURL+"meetings/personal",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const meetingRoomData=(yield response.json()).data;if(meetingRoomData.id){this.personalAudioRoomId=meetingRoomData.id;const room=this.getRoomById(meetingRoomData.id);return room?this.updateRoomData(room,meetingRoomData):this.createRoomFromData(meetingRoomData),this.getRoomById(meetingRoomData.id)}throw new Error("Wrong data from server")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrievePersonalAudioRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}retrieveCurrentPersonalAudioRoom(force=!1){return __awaiter(this,void 0,void 0,(function*(){if(!force&&this.currentPersonalAudioRoomId&&this.getRoomById(this.currentPersonalAudioRoomId))return this.logger.debug("[roomService] retrieveCurrentPersonalAudioRoom from service data"),this.getRoomById(this.currentPersonalAudioRoomId);try{this.logger.debug("[roomService] retrieveCurrentPersonalAudioRoom from server");const url=this.portalURL+"meetings/current",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const meetingRoomData=(yield response.json()).data;if(meetingRoomData.id){this.currentPersonalAudioRoomId=meetingRoomData.id;const room=this.getRoomById(meetingRoomData.id);return room?this.updateRoomData(room,meetingRoomData):this.createRoomFromData(meetingRoomData),this.getRoomById(meetingRoomData.id)}const error=new Error("Wrong data from server");throw this.logger.info("[roomService] "+error.message),error}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrieveCurrentPersonalAudioRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}reUseMeetingRoom(roomId){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.debug("[roomService] reUseMeetingRoom - "+roomId),!roomId){const error=new Error("reUseMeetingRoom - missing parameter");throw this.logger.error(error.message),error}const room=this.getRoomById(roomId);room&&!room.isActive&&this.sendAvailableRoomPresence(room);try{const url=`${this.portalURL}meetings/${roomId}/reuse`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const meetingRoomData=(yield response.json()).data;if(meetingRoomData.id){this.currentPersonalAudioRoomId=meetingRoomData.id;const serviceRoom=this.getRoomById(meetingRoomData.id);return serviceRoom?this.updateRoomData(serviceRoom,meetingRoomData):this.createRoomFromData(meetingRoomData),this.getRoomById(meetingRoomData.id)}throw new Error("Wrong data from server")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"reUseMeetingRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}deletePersonalMeetingRoom(){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("[roomService] deletePersonalMeetingRoom");try{const url=this.portalURL+"meetings/delete",headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"PUT",headers:headers});if(!response.ok)throw response;const meetingRoomData=(yield response.json()).data;if(meetingRoomData.id){let room=this.getRoomById(meetingRoomData.id);return room?this.updateRoomData(room,meetingRoomData):this.createRoomFromData(meetingRoomData),this.currentPersonalAudioRoomId=meetingRoomData.id,this.personalAudioRoomId=meetingRoomData.id,this.eventService.publish("ON_MEETING_CREATED_EVENT",meetingRoomData.id),room=this.getRoomById(meetingRoomData.id),room}throw new Error("Wrong data from server")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"deletePersonalMeetingRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}saveCurrentPersonalMeetingRoom(name){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("[roomService] saveCurrentPersonalMeetingRoom");try{const url=this.portalURL+"meetings/save",headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"PUT",headers:headers,body:JSON.stringify({name:name})});if(!response.ok)throw response;const meetingRoomData=(yield response.json()).data;if(meetingRoomData.id){this.currentPersonalAudioRoomId=meetingRoomData.id;let room=this.getRoomById(meetingRoomData.id);return room?this.updateRoomData(room,meetingRoomData):this.createRoomFromData(meetingRoomData),this.currentPersonalAudioRoomId=meetingRoomData.id,this.personalAudioRoomId=meetingRoomData.id,this.eventService.publish("ON_MEETING_CREATED_EVENT",meetingRoomData.id),room=this.getRoomById(meetingRoomData.id),room}throw new Error("Wrong data from server")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"saveCurrentPersonalMeetingRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}getPersonalAudioRoomOpenInviteIdLink(){return this.getOpenInviteIdLinkForRoom(this.personalAudioRoomId)}getOpenInviteIdLinkForRoom(roomId){return this.openInviteIdByRoomId[roomId]?this.openInviteIdByRoomId[roomId].openInviteLink:null}getOpenInviteIdForRoom(roomId){return this.openInviteIdByRoomId[roomId]?this.openInviteIdByRoomId[roomId].openInviteId:null}getName(room){return room.name}sortObjectByProperty(property_name){return(aaa,bbb)=>aaa[property_name]<bbb[property_name]?-1:aaa[property_name]>bbb[property_name]?1:0}retrieveRoomConsumption(){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug("[roomService] retrieveRoomConsumption");try{const url=this.portalURL+"rooms/consumption",headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const roomConsumptionData=(yield response.json()).data;return this.logger.debug("[roomService] retrieveRoomConsumption -- SUCCESS -- "+roomConsumptionData.currentValue),roomConsumptionData.currentValue}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrieveRoomConsumption");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}startAdHocConference(calleeId,participantIds=[]){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug(`[roomService] startAdHocConference with ${calleeId} and ${participantIds}`);try{const url=this.portalURL+"adhoc",headers=auth_service_1.default.getPostHeader(),response=yield fetch(url,{method:"PUT",headers:headers,body:JSON.stringify({calleeId:calleeId,participantIds:participantIds})});if(!response.ok)throw response;const roomData=(yield response.json()).data;return this.logger.debug("[roomService] startAdHocConference -- SUCCESS -- "),roomData}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"startAdHocConference");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}manageEventForNonExistingRoom(roomJid,eventName,userJid){return __awaiter(this,void 0,void 0,(function*(){try{setTimeout(()=>__awaiter(this,void 0,void 0,(function*(){this.logger.debug("[roomService] manageEventForNonExistingRoom for "+roomJid);let room=this.getRoomByJid(roomJid);room||(room=yield this.getServerRoomByJid(roomJid));const user=room.getUserByJid(userJid);if("conferenceAdd"===eventName){if(!room.isMeetingRoom()&&!contact_service_1.default.userContact.webrtcAudioEnabled)return room;this.eventService.publish("ROOM_ADD_CONF_ENDPOINT_EVENT",room),this.sendEvent("ROOM_ADD_CONF_ENDPOINT_EVENT",room),this.eventService.publish("ON_CONFERENCE_STARTED_INVITATION",room,user)}return room})),4e3)}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"manageEventForNonExistingRoom");throw this.logger.error("[roomService] "+errorInfo.message),errorInfo.error}}))}}exports.RoomService=RoomService,exports.default=RoomService.getInstance()},function(module,__webpack_exports__,__webpack_require__){"use strict";function identity(x){return x}__webpack_require__.d(__webpack_exports__,"a",(function(){return identity}))},function(module,__webpack_exports__,__webpack_require__){"use strict";function isFunction(x){return"function"==typeof x}__webpack_require__.d(__webpack_exports__,"a",(function(){return isFunction}))},function(module,__webpack_exports__,__webpack_require__){"use strict";function hostReportError(err){setTimeout((function(){throw err}),0)}__webpack_require__.d(__webpack_exports__,"a",(function(){return hostReportError}))},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.I18nService=void 0;const settings_service_1=__webpack_require__(5),logger_service_1=__webpack_require__(15),moment=__webpack_require__(3),rxjs_1=__webpack_require__(10);class I18nService{constructor(){this.isInitialized=!1,this.subject=new rxjs_1.Subject,this.subscription=settings_service_1.default.subscribeUpdateEvent("LANGUAGE_UPDATED",()=>{this.updateTranslationLanguage()})}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.i18nService||(win.rainbow.i18nService=new I18nService),win.rainbow.i18nService}subscribe(observable){return this.subject.subscribe(observable)}configure(translator){return __awaiter(this,void 0,void 0,(function*(){this.translator=translator,yield this.updateTranslationLanguage()}))}translate(label,params=null){return this.translator?this.translator.instant(label,params):label}getCurrentLanguage(){return this.translator?this.translator.use():"en"}updateTranslationLanguage(){return __awaiter(this,void 0,void 0,(function*(){try{const currentLanguage=settings_service_1.default.getAppliLanguage();if(this.translator){const loadedLanguage=yield this.translator.use(currentLanguage.code);logger_service_1.default.info(`[I18nService] updateTranslationLanguage -- "${loadedLanguage}" labels are loaded`),this.isInitialized=!0,this.subject.next()}moment.locale(currentLanguage.codeMoment)}catch(error){logger_service_1.default.error("[I18nService] updateTranslationLanguage -- failure")}}))}}exports.I18nService=I18nService,exports.default=I18nService.getInstance()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.sdkConfig=void 0;exports.sdkConfig={verboseLog:!0,measurePerformance:!1,unifiedPlan:!1,credentials:{appID:"",appSecret:"",host:"openrainbow.com"},startService:{connection:!0,presence:!0,contacts:!0,conversations:!0,im:!0,telephony:!0,webRTC:!0,bubbles:!0,groups:!0,callsLog:!0,userProfile:!0,favorites:!0,fileStorage:!0,caps:!0,channels:!0,admin:!0},features:{bots:!0,channels:!0,conference:!0,telephony:!0,profileService:!0,roomService:!0,favoriteService:!0,conversationService:!0}}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ErrorHelperService=exports.ErrorHelperInfo=void 0;const i18n_service_1=__webpack_require__(37);class ErrorHelperInfo{constructor(){this.message="",this.error=null}}exports.ErrorHelperInfo=ErrorHelperInfo;class ErrorHelperService{constructor(){}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.errorHelperService||(win.rainbow.errorHelperService=new ErrorHelperService),win.rainbow.errorHelperService}getErrorInfo(error,context=null,params=null){return __awaiter(this,void 0,void 0,(function*(){const errorInfo=new ErrorHelperInfo;if(error instanceof Error&&(errorInfo.message=error.message,errorInfo.error=error),error instanceof Response){const data=yield error.json(),status=data&&data.errorDetailsCode?data.errorDetailsCode:error.status,statusText=this.getStatusText(data,error),errorText=this.getErrorText(data),portal=error.url?error.url.match(/api\/rainbow\/(\w+)\//)[1]:void 0,requestId=error.headers&&error.headers.get("x-rainbow-request-id")?` (x-rainbow-request-id:${error.headers.get("x-rainbow-request-id")})`:"";context&&(errorInfo.message=context+" -- "),errorInfo.message+=`${statusText} -- ${errorText}`,requestId&&(errorInfo.message+=requestId),errorInfo.error=new Error(errorInfo.message),errorInfo.error.status=error.status,errorInfo.error.fieldErrors=this.getBadRequestFieldErrors(data,error),errorInfo.error.errorDetailsCode=status,errorInfo.error.errorDetailsLabel=this.getErrorCodeLabel(status,portal),errorInfo.error.translatedMessage=this.getTranslatedErrorMessage(errorInfo.error,params,portal),errorInfo.error.portal=portal}return errorInfo}))}getTranslatedErrorMessage(error,params,portal){let errorMessage="";return error.errorDetailsCode&&(errorMessage=this.getLocalizedError(error.errorDetailsCode,params,portal)),errorMessage}getLocalizedError(errorCode,params,portal){let errorMessage="";const errorLabel=this.getErrorCodeLabel(errorCode,portal);if(errorLabel){const translation=i18n_service_1.default.translate(errorLabel,params);translation!==errorLabel&&(errorMessage=translation)}return errorMessage}getErrorText(data){if(!data)return"Unknow error - Something goes really wrong";let message="";return data.errorDetails?data.errorDetails instanceof Array?data.errorDetails.forEach(details=>{message+=details.msg}):data.errorDetails.msg?message+=JSON.stringify(data.errorDetails.msg):message+=data.errorDetails:data.errorMsg&&(message+=data.errorMsg),message}getStatusText(status,response){switch(status){case-1:return"Service unavailable";case 400:return"Bad request";case 401:return"Authorization failure";case 403:return"Access is forbidden";case 404:return"Resource not found";case 413:return"Request Entity Too Large";case 415:return"Unsupported Media Type";case 500:return"Internal server error";default:return response.statusText?response.statusText:"Unknown error"}}getBadRequestFieldErrors(data,response){const fieldErrors={},errorDetails=data?data.errorDetails:null;return 400===response.status&&errorDetails&&(errorDetails instanceof Array?errorDetails.forEach(details=>{fieldErrors[details.param]||(fieldErrors[details.param]={ok:!1,message:details.msg,value:details.value})}):errorDetails.param&&(fieldErrors[errorDetails.param]={ok:!1,message:errorDetails.msg,value:errorDetails.value}),data&&400511===data.errorDetailsCode&&(fieldErrors.office365Tenant={ok:!1,message:ErrorHelperService.ERROR_CODE_LABELS[400511]}),data&&400601===data.errorDetailsCode&&(fieldErrors.outgoingPrefix={ok:!1,message:ErrorHelperService.ERROR_CODE_LABELS[400601]},fieldErrors.numberingPrefix={ok:!1,message:ErrorHelperService.ERROR_CODE_LABELS[400601]})),fieldErrors}getErrorCodeLabel(errorCode,portal){return portal&&ErrorHelperService.PORTAL_ERROR_CODE_LABELS[portal]&&ErrorHelperService.PORTAL_ERROR_CODE_LABELS[portal][errorCode]?ErrorHelperService.PORTAL_ERROR_CODE_LABELS[portal][errorCode]:ErrorHelperService.ERROR_CODE_LABELS[errorCode]}}exports.ErrorHelperService=ErrorHelperService,ErrorHelperService.ERROR_CODE_LABELS={"-1":"unknownError",0:"errorNoServerResponse",400:"Bad request",4e5:"Bad request",400210:"invalidPhoneNumber",400400:"errorWrongPassword",400500:"invalidFile",400504:"companyNameAlreadyExist",400505:"BPCompanyWithoutPaymentConfigurationData",400506:"NoActiveSubscriptionToOffer",400509:"errorDecreaseSubscriptionForbidden",400511:"ActiveDirectoryDomainAlreadyUsed",400552:"BPCompanyAndECCompanyMustNotBeSame",400601:"outboundAndInternalPrefixesCantBeIdentical",400973:"noCreateUserPermission",400975:"userAlreadyExistsInOtherCompany",400983:"userAlreadyExistsInOtherCompany",400990:"noUserFound",400993:"noUserFound",401:"Authorization failure",401102:"Authorization failure",401202:"errorInvalidToken",401500:"errorUnauthorized",401501:"errorLoginForbidden",401510:"errorUnauthorized",401520:"errorUserNotActive",401521:"errorUserNotActive",403:"Forbidden",403e3:"accessDeniedNotRequiredRole",403001:"accessDeniedNotOwner",403034:"cantDeselectDefaultWebRTCGateway",403035:"cantDeleteDefaultWebRTCGateway",403060:"confLockMsg",403072:"errorIsoMd5Mismatch",403153:"notAllowedToAccessMeeting",403154:"notAllowedToAccessMeeting",403200:"notAllowedToChangeRole",403203:"notAllowedToChangeRole",403204:"notAllowedToMoveExistingUserToThisCompany",403205:"notAllowedToManageUser",403301:"notAllowedToManageCompany",403304:"notAllowedToAddAnotherAdmin",403311:"errorRemoveSyncOngoingSubscriptionForbidden",403315:"errorRemoveSubscriptionForbidden",403316:"errorRemoveAdminAllocatedSubscriptionForbidden",403317:"errorRemoveClientAllocatedSubscriptionForbidden",403400:"notAllowedDeleteAppOwner",403500:"notAllowedBlacklistedEmail",403501:"notAllowedBlacklistedEmail",403503:"NotAllowedSelfRegistrationEmail",403504:"notAllowedLoggedInUserEmail",403507:"notAllowedSupportEmail",403513:"companyNotABpCompany",403516:"companyNotABpCompany",403517:"companySeenAsTerminated",403518:"companyBpTypeIncompatible",403519:"companyAlreadyLinkedToBp",403520:"companyNotVadBp",403526:"isolatedUser",403531:"resetPasswordBlocked",403532:"resetPasswordForbidden",403608:"errorAssignSubscriptionSyncOngoing",403609:"errorAssignSubscriptionSyncOngoing",403610:"maxSubscriptionAllocationReached",403611:"notAllowedToCreateAnEquipment",403615:"maximumNumberConferenceParticipantsReach",403616:"subscriptionCompanyAdminEssentialAlreadyExists",403617:"roleCompanyAdminEssentialAlreadyExists",403620:"MaximumNumberRoomUsersReach",403621:"MaximumNumberConvUsersReach",403624:"notAllowedRemoveService",403625:"errorAllocatedSubscriptionRemoveForbidden",403626:"restrictedConvAccess",403630:"uploadErrorMaxQuotaReached",403655:"userAlreadyCompanyMember",403670:"errorOperationForbiddenOnGuest",403700:"errorDeleteSiteWithSystems",403701:"errorDeleteOrganisationLinkedCompany",403702:"errorDeleteCompanyWithSubscriptions",403703:"errorDeleteCompanyWithSites",403704:"errorDeleteCompanyWithUsers",403705:"errorDeleteCompanyStillTerminated",403706:"errorRemoveBusinessPartnerRole",403719:"externalTrunkChangeForbidden",403721:"numberingPlanCantBeUpdated",403722:"outgoingPrefixChangeForbidden",403723:"cannotRemoveCompanyPublicNumber",403724:"notAllowedDeleteCloudPbxWithPublicNumbers",403725:"notAllowedDeleteCloudPbxWithUsedExtensions",404:"resourceNotFound",404e3:"resourceNotFound",404001:"resourceNotFoundUpdateImpossible",404002:"resourceNotFoundDeleteImpossible",404116:"archivedOrDeletedConversation",404300:"noValidOfferReferenceInACTISFile",404301:"offerNotFound",409e3:"userAlreadyCreated",409005:"inviteUsersError",409011:"noMessagesToExport",409251:"DDIAlreadyAssociatedToCompany",409552:"internalNumberAlreadyUsed",409555:"publicNumberAlreadyExists",409557:"notAllowedDeleteUserAssociatedToCloudPbx",409600:"userAlreadyExist",409601:"invitationReSentConflict",409602:"userAlreadyNetworkMember",409603:"invitationReSentConflict",409620:"offerAlreadySubscribed",409623:"conferenceOfferAlreadySubscribed",409625:"errorUpdateSyncOngoingSubscriptionForbidden",409800:"companyNotIrBp",409801:"companyNotLinkedToBp",409802:"actisCompanyAdminMismatch",409803:"actisCompanyNameMismatch",413e3:"uploadErrorTooLarge",500:"errorInternalServerError",1001:"extensionNotLinkedToEquipment",1002:"extensionHasNoIdentifier",1003:"extensionDoesNotExist",1004:"extensionLookupFailure",1005:"extensionConflict",1006:"nonUniqueEquipmentForExtension",1007:"userAlreadyAssociatedToExtension",1008:"extensionAssociatedToAnotherUser",1009:"failedToAttachExtension",1010:"userHasNoExtension",1011:"userHasTooManyExtensions",1012:"failedToDetachExtension"},ErrorHelperService.PORTAL_ERROR_CODE_LABELS={massprovisioning:{4e5:"invalidValue",400501:"invalidFile",400502:"invalidColumnName",400504:"invalidFile",400506:"invalidValueInActionColumn",400600:"deviceTypeCannotBeUpdated",400601:"duplicateDeviceIds",400602:"duplicateMacAdresses",400603:"invalidDeviceTypes",400604:"missingDeviceTypeInLines",400605:"invalidEquipment",403610:"errorMaxSubscriptionReached",404600:"deviceDoesNotExist",404601:"noCloudPbxInCompany"},rvcpprovisioning:{403e3:"overflowConfigurationChangesStillInProgress",403622:"noVoiceLicenceAllocatedToUser",403728:"forbiddenOperationEquipmentHasDevices",409556:"companyHasAlreadyACloudPbx",403739:"forbiddenOperationWelcomeServiceUsed"},authentication:{401102:"Authorization failure",401103:"Authorization failure",401500:"Authorization failure",401520:"Forbidden",401521:"Forbidden",401522:"Forbidden",401523:"Forbidden",401530:"Authorization failure",401600:"Authorization failure",401700:"Authorization failure",403e3:"Authorization failure",5e5:"errorInternalServerError",503e3:"resourceNotFound"}},exports.default=ErrorHelperService.getInstance()},function(module,exports,__webpack_require__){var C,C_lib,Base,WordArray,C_algo,MD5,EvpKDF,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(72),__webpack_require__(73),C_lib=(C=CryptoJS).lib,Base=C_lib.Base,WordArray=C_lib.WordArray,C_algo=C.algo,MD5=C_algo.MD5,EvpKDF=C_algo.EvpKDF=Base.extend({cfg:Base.extend({keySize:4,hasher:MD5,iterations:1}),init:function(cfg){this.cfg=this.cfg.extend(cfg)},compute:function(password,salt){for(var cfg=this.cfg,hasher=cfg.hasher.create(),derivedKey=WordArray.create(),derivedKeyWords=derivedKey.words,keySize=cfg.keySize,iterations=cfg.iterations;derivedKeyWords.length<keySize;){block&&hasher.update(block);var block=hasher.update(password).finalize(salt);hasher.reset();for(var i=1;i<iterations;i++)block=hasher.finalize(block),hasher.reset();derivedKey.concat(block)}return derivedKey.sigBytes=4*keySize,derivedKey}}),C.EvpKDF=function(password,salt,cfg){return EvpKDF.create(cfg).compute(password,salt)},CryptoJS.EvpKDF)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return rxSubscriber}));var rxSubscriber=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return UnsubscriptionError}));var UnsubscriptionError=function(){function UnsubscriptionErrorImpl(errors){return Error.call(this),this.message=errors?errors.length+" errors occurred during unsubscription:\n"+errors.map((function(err,i){return i+1+") "+err.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=errors,this}return UnsubscriptionErrorImpl.prototype=Object.create(Error.prototype),UnsubscriptionErrorImpl}()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Contact=void 0;const rxjs_1=__webpack_require__(10),company_model_1=__webpack_require__(19),crypto_js_1=__webpack_require__(18);class Contact{constructor(jid=null,name=null,company=null){this.id=null,this.dbId=null,this.jid=null,this.fullJid=null,this.jidtel=null,this.login=null,this.temp=!1,this.roster=!1,this.initialized=!1,this.isTerminated=!1,this.ask=null,this.subscription=null,this.guest=!1,this.guestMode=!1,this.confId=null,this.conversation=null,this.personalAudioRoomOpenInviteId=null,this.personalAudioRoomOpenInviteIdSubject=null,this.capabilities=null,this.groups=null,this.nameUpdatePrio=null,this.rxSubject=new rxjs_1.Subject,this.isBot=!1,this.isBotSharing=!1,this.status=null,this.telStatus=null,this.imStatus=null,this.oldImStatus=null,this.imStatusStamp=null,this.resources=null,this.lastActivityDate=null,this.lastActivityMessage=null,this.statusMessage=null,this.message=null,this.loginEmail=null,this.lastname=null,this.firstname=null,this.initials=null,this.name=null,this.nickname=null,this.title=null,this.jobTitle=null,this.company=null,this.isInDefaultCompany=!1,this.language=null,this.country=null,this.timezone=null,this.tags=null,this._displayName=null,this.nameForLogs=null,this.displayShortName=null,this.displayOrder="FL",this._avatar=null,this.defaultAvatar=null,this.avatarSrc=null,this.calendarState=null,this.phoneProCan=null,this.pbxId=null,this.organisationId=null,this.siteId=null,this.systemId=null,this.phoneNumberId=null,this.phonePbx=null,this.phoneInternalNumber=null,this.mobilePro=null,this.mobileProCan=null,this.isMobileProShared=!1,this.phonePerso=null,this.phonePersoCan=null,this.isPhonePersoShared=!1,this.mobilePerso=null,this.mobilePersoCan=null,this.isMobilePersoShared=!1,this.isVirtualTerm=!1,this.systDeviceName=null,this.voicemailNumber=null,this.hasPhoneNumber=!1,this.hasPhoneProDdiNumber=!1,this.phoneNumbersInitialized=!1,this.emailPro=null,this.emailPerso=null,this.note1=null,this.note2=null,this.department=null,this.otherPhoneNumbers=null,this.postalCode=null,this.state=null,this.street=null,this.city=null,this.businessCompanyId=null,this.companyName=null,this.isTv=!1,this.rainbowTvData=null,this.roles=null,this.adminType=null,this.customData=null,this.userTitleNameEnabled=!1,this.alertNotificationEnabled=!1,this.giphyEnabled=!0,this.telephonySettingsEnabled=!0,this.recordConversationEnabled=!0,this.changeSettingsEnabled=!0,this.newUiEnabled=!1,this.denySelfRegister=!1,this._fileSharingEnabled=!1,this._fileStorageEnabled=!1,this._instantMessagesEnabled=!1,this._changePresenceEnabled=!1,this._phoneMeetingsEnabled=!1,this._channelsEnabled=!1,this._roomsEnabled=!1,this._webrtcAudioEnabled=!1,this._webrtcVideoEnabled=!1,this._modifyProfileEnabled=!1,this._useDialOutEnabled=!1,this.id=jid,this.dbId=null,this.jid=jid,this.fullJid=null,this.jidtel=null,this.login=null,this.temp=!1,this.roster=!1,this.initialized=!1,this.ask="none",this.subscription="none",this.guest=!1,this.confId="",this.conversation=null,this.personalAudioRoomOpenInviteId=null,this.personalAudioRoomOpenInviteIdSubject=new rxjs_1.BehaviorSubject(this.personalAudioRoomOpenInviteId),this.capabilities=null,this.groups=null,this.nameUpdatePrio=Contact.NameUpdatePrio.MAX_UPDATE_PRIO,this.status="unknown",this.telStatus="",this.imStatus="offline",this.oldImStatus=null,this.imStatusStamp=[],this.resources={},this.mobileResource=null,this.lastActivityDate=null,this.lastActivityMessage=null,this.statusMessage=null,this.message="",this.loginEmail="",this.lastname="",this.firstname="",this.initials="",this.name={value:this._displayName},this.nameForLogs="",this._displayName=name||jid,this.nickname="",this.title="",this.jobTitle="",this.company=company,this.isInDefaultCompany=!1,this.language=null,this.country="",this.timezone="",this.tags=null,this.defaultAvatar=null,this._avatar=null,this.avatarSrc=null,this.calendarState={},this.phonePro="",this.phoneProCan="",this.pbxId="",this.phonePbx="",this.phoneInternalNumber="",this.mobilePro="",this.mobileProCan="",this.isMobileProShared=!1,this.phonePerso="",this.phonePersoCan="",this.isPhonePersoShared=!1,this.mobilePerso="",this.mobilePersoCan="",this.isMobilePersoShared=!1,this.isVirtualTerm=!1,this.systDeviceName=null,this.emailPro="",this.emailPerso="",this.note1="",this.note2="",this.department="",this.otherPhoneNumbers=[],this.postalCode="",this.state="",this.street="",this.city="",this.businessCompanyId="",this.companyName="",this.isTv=!1,this.rainbowTvData={},this.roles=null,this.adminType=null,this.newUiEnabled=!1,this._fileSharingEnabled=!0,this._fileStorageEnabled=!0,this.fileStorageEnabledSubject=new rxjs_1.BehaviorSubject(!0),this._instantMessagesEnabled=!0,this._changePresenceEnabled=!0,this._phoneMeetingsEnabled=!0,this.phoneMeetingsEnabledSubject=new rxjs_1.BehaviorSubject(!0),this._channelsEnabled=!0,this._roomsEnabled=!0,this._webrtcAudioEnabled=!0,this._webrtcVideoEnabled=!0,this._modifyProfileEnabled=!0,this._useDialOutEnabled=!0,this.userTitleNameEnabled=!0,this.giphyEnabled=!0,this.denySelfRegister=!1}updateFromUserData(userData){this.dbId=userData.id,this.loginEmail=userData.loginEmail,this.firstname=userData.firstName,this.lastname=userData.lastName,this.nickname=userData.nickName?userData.nickName:"",this.title=userData.title?userData.title:"",this.jobTitle=userData.jobTitle?userData.jobTitle:"",this.organisationId=userData.organisationId,this.siteId=userData.siteId,this.country=userData.country?userData.country:"FRA",this.timezone=userData.timezone,this.roles=userData.roles,this.adminType=userData.adminType,this.isBot=!1,this.isBotSharing=!1,this.isTerminated=userData.isTerminated,this.isInDefaultCompany=userData.isInDefaultCompany,this.lastAvatarUpdateDate=userData.lastAvatarUpdateDate,this.initialized=userData.isInitialized,this.guestMode=!!userData.guestMode&&userData.guestMode,this.personalAudioRoomOpenInviteId=userData.personalAudioRoomOpenInviteId?userData.personalAudioRoomOpenInviteId:this.personalAudioRoomOpenInviteId,this.personalAudioRoomOpenInviteIdSubject.next(this.personalAudioRoomOpenInviteId),this.isTv=userData.isTv,this.tags=userData.tags,this.department=userData.department,this.customData=userData.customData,this.denySelfRegister=userData.denySelfRegister,userData.jid_im&&(this.id=userData.jid_im,this.jid=userData.jid_im,this.jidtel=userData.jid_tel),this.company&&this.company.id===userData.companyId||(this.company=company_model_1.Company.create(userData.companyId,userData.companyName)),userData.fileSharingCustomisation&&(this._fileSharingEnabled="enabled"===userData.fileSharingCustomisation),userData.fileStorageCustomisation&&(this.fileStorageEnabled="enabled"===userData.fileStorageCustomisation),userData.userTitleNameCustomisation&&(this.userTitleNameEnabled="enabled"===userData.userTitleNameCustomisation),userData.instantMessagesCustomisation&&(this._instantMessagesEnabled="enabled"===userData.instantMessagesCustomisation),userData.overridePresenceCustomisation&&(this._changePresenceEnabled="enabled"===userData.overridePresenceCustomisation),userData.phoneMeetingCustomisation&&(this.phoneMeetingsEnabled="enabled"===userData.phoneMeetingCustomisation),userData.useChannelCustomisation&&(this._channelsEnabled="enabled"===userData.useChannelCustomisation),userData.useRoomCustomisation&&(this._roomsEnabled="enabled"===userData.useRoomCustomisation),userData.useWebRTCAudioCustomisation&&(this._webrtcAudioEnabled="enabled"===userData.useWebRTCAudioCustomisation),userData.useWebRTCVideoCustomisation&&(this._webrtcVideoEnabled="enabled"===userData.useWebRTCVideoCustomisation),userData.userProfileCustomisation&&(this._modifyProfileEnabled="enabled"===userData.userProfileCustomisation),userData.useGifCustomisation&&(this.giphyEnabled="enabled"===userData.useGifCustomisation),userData.changeTelephonyCustomisation&&(this.telephonySettingsEnabled="enabled"===userData.changeTelephonyCustomisation),userData.recordingConversationCustomisation&&(this.recordConversationEnabled="enabled"===userData.recordingConversationCustomisation),userData.changeSettingsCustomisation&&(this.changeSettingsEnabled="enabled"===userData.changeSettingsCustomisation),userData.useDialOutCustomisation&&(this.useDialOutEnabled="enabled"===userData.useDialOutCustomisation),userData.tryNewUiCustomisation&&(this.newUiEnabled="enabled"===userData.tryNewUiCustomisation),this.phonePro=this.phoneProCan="",this.phonePbx="",this.phoneInternalNumber="",this.pbxId="",this.mobilePro=this.mobileProCan="",this.phonePerso=this.phonePersoCan="",this.mobilePerso=this.mobilePersoCan="",this.voicemailNumber="",this.systemId="",this.phoneNumberId="",this.hasPhoneNumber=!1,this.hasPhoneProDdiNumber=!1,this.customData||(this.customData={});var that=this;userData.emails&&(that.emailPerso="",userData.emails.forEach((function(email){switch(email.type){case"work":that.emailPro=email.email;break;case"home":that.emailPerso=email.email}}))),userData.phoneNumbers&&(userData.phoneNumbers.forEach((function(phoneNumber){var number=phoneNumber.number,numberCan=phoneNumber.numberE164,deviceType=phoneNumber.deviceType;switch(that.hasPhoneNumber=!0,phoneNumber.type){case"work":"landline"===deviceType&&(phoneNumber.isCloudPbxDDI?(that.phonePro=phoneNumber.number,that.phoneProCan=phoneNumber.numberE164,that.hasPhoneProDdiNumber=!0):that.hasPhoneProDdiNumber||(that.phonePro=number,that.phoneProCan=numberCan),phoneNumber.isFromSystem&&(that.phonePbx=phoneNumber.shortNumber,phoneNumber.internalNumber&&(that.phoneInternalNumber=phoneNumber.internalNumber,"Remote Extension"===phoneNumber.deviceName||"Any Device"===phoneNumber.deviceName||0===phoneNumber.deviceName.search("UA VIRTUAL")?that.isVirtualTerm=!0:that.isVirtualTerm=!1),that.systDeviceName=phoneNumber.deviceName?phoneNumber.deviceName:null,that.pbxId=phoneNumber.pbxId,that.voicemailNumber=phoneNumber.voiceMailNumber,that.systemId=phoneNumber.systemId,that.phoneNumberId=phoneNumber.phoneNumberId)),"mobile"===deviceType&&(that.mobilePro=number,that.isMobileProShared=phoneNumber.isVisibleByOthers,that.mobileProCan=numberCan);break;case"home":"landline"===deviceType&&(that.phonePerso=number,that.isPhonePersoShared=phoneNumber.isVisibleByOthers,that.phonePersoCan=numberCan),"mobile"===deviceType&&(that.mobilePerso=number,that.isMobilePersoShared=phoneNumber.isVisibleByOthers,that.mobilePersoCan=numberCan)}})),this.phoneNumbersInitialized=!0),this.computeDisplayName()}containsEmail(email){var lowerCaseEmail=email.toLowerCase();return!(!this.loginEmail||this.loginEmail.toLowerCase()!==lowerCaseEmail)||(!(!this.emailPro||this.emailPro.toLowerCase()!==lowerCaseEmail)||!(!this.emailPerso||this.emailPerso.toLowerCase()!==lowerCaseEmail))}containsPhoneNumber(phoneNumber){return!!phoneNumber&&[this.phonePbx,this.phoneInternalNumber,this.phonePro,this.phoneProCan,this.mobilePro,this.mobileProCan,this.phonePerso,this.phonePersoCan,this.mobilePerso,this.mobilePersoCan].includes(phoneNumber)}getGroups(){return this.groups}setGroups(groups){this.groups=groups}getPersonalAudioRoomOpenInviteId(){return this.personalAudioRoomOpenInviteId}setPersonalAudioRoomOpenInviteId(openInviteId){this.personalAudioRoomOpenInviteId=openInviteId,this.personalAudioRoomOpenInviteIdSubject.next(this.personalAudioRoomOpenInviteId)}set avatar(avatar){this._avatar=avatar}get avatar(){return this._avatar?this._avatar:this.avatarSrc?(this._avatar={src:this.avatarSrc},this.defaultAvatar=null,this.rxSubject.next({name:"avatar"}),this._avatar):this.defaultAvatar}getAvatarInBase64(){const contact=this;return new Promise(resolve=>{try{if(contact&&contact.avatar&&contact.avatar.src||resolve(),contact.avatar.src&&!contact.avatar.src.startsWith("data:image/png")){const img=new Image,canvas=document.createElement("canvas");canvas.width=120,canvas.height=120;const ctx=canvas.getContext("2d");ctx.rect(0,0,120,120),ctx.fillStyle=contact.color,ctx.fill(),img.onload=function(){ctx.drawImage(img,0,0,120,120),resolve(canvas.toDataURL("image/png"))},img.src=contact.avatar.src}else resolve(contact.avatar.src)}catch(error){resolve()}})}getAvatar(size=256,forced=!1){if(this.dbId&&this.lastAvatarUpdateDate){const update=crypto_js_1.MD5(crypto_js_1.enc.Latin1.parse(this.lastAvatarUpdateDate)).toString(crypto_js_1.enc.Hex);this.avatarSrc=`${this.avatarServerURL}/api/avatar/${this.dbId}?size=${size}&update=${update}`}this.createTextAvatarImage(),this.isTv&&(this.defaultAvatar={src:"/resources/skins/rainbow/images/misc/androidtv.svg"}),!forced&&this.lastAvatarUpdateDate||(this.avatar=null)}createTextAvatarImage(){const image=new Image,canvas=document.createElement("canvas");canvas.width=image.width=225,canvas.height=image.height=225;const ctx=canvas.getContext("2d");ctx.rect(0,0,225,225),ctx.fillStyle=this.color,ctx.fill(),ctx.font="bold 100px Helvetica",ctx.textAlign="center",ctx.fillStyle="white",ctx.fillText(this.initials,110,150),image.src=canvas.toDataURL("image/png"),this.defaultAvatar=image}get displayName(){return this._displayName}set displayName(displayName){this._displayName=displayName,this.nameForLogs=config&&config.debug?displayName:displayName.charAt(0)+displayName.replace(/[^\s](?=.{1,}$)/g,"*").substr(1),this.name.value=displayName,this.rxSubject.next({name:"displayName"})}updateName(firstName,lastName){this.firstname=firstName,this.lastname=lastName,this.computeDisplayName(),this.getAvatar()}computeDisplayName(){const firstName=this.firstname?this.firstname.charAt(0).toUpperCase()+this.firstname.slice(1):null,lastName=this.lastname?this.lastname.charAt(0).toUpperCase()+this.lastname.slice(1):null,nickName=this.nickname?this.nickname.charAt(0).toUpperCase()+this.nickname.slice(1):null;this.isTv?(this.displayName=firstName||lastName,this.initials=this.displayName.charAt(0)):lastName&&firstName?"FL"===this.displayOrder?(this.displayName=firstName+" "+lastName,this.displayShortName=firstName+" "+lastName.charAt(0),this.initials=firstName.charAt(0)+lastName.charAt(0)):(this.displayName=lastName+" "+firstName,this.displayShortName=lastName+" "+firstName.charAt(0),this.initials=lastName.charAt(0)+firstName.charAt(0)):lastName&&!firstName?(this.displayName=this.displayShortName=lastName,this.initials=lastName.charAt(0)):nickName?(this.displayName=nickName,this.displayShortName=nickName,this.initials=nickName.charAt(0)):this.loginEmail?(this.displayName=this.loginEmail,this.displayShortName=this.loginEmail,this.initials=this.loginEmail.substring(0,2).toUpperCase()):firstName?(this.displayName=firstName,this.initials=firstName.charAt(0)):(this.displayName="Anonymous",this.displayShortName="Anonymous",this.initials="A");const upperCaseDisplayName=this.displayName.toUpperCase();let sum=0;for(let i=0;i<upperCaseDisplayName.length;i++)sum+=upperCaseDisplayName.charCodeAt(i);this.colorIndex=sum%12,this.color=Contact.textAvatarColor[this.colorIndex],this.colorName=Contact.textAvatarName[this.colorIndex]}isCPaaSGuest(){return this.roles.indexOf("guest")>=0}isGuest(){return this.guestMode}isAnonymousGuest(){return"A"===this.initials||"Anonymous"===this.displayName}isBadGuest(){return this.displayName.startsWith("__guest__")||this.displayName.startsWith("__##__guest__##__")}isGuestInitialized(){return null!==this.firstname&&this.firstname.length>0&&null!==this.lastname&&this.lastname.length>0&&"__##__guest__##__"!==this.firstname}hasAdminRights(){return this.isSuperadmin()||this.isBusinessAdmin()||this.isAdmin()||this.isBPAdmin()}isSuperadmin(){return this.roles.indexOf("superadmin")>=0}isBusinessAdmin(){return this.roles.indexOf("business_admin")>=0}isOrganizationAdmin(){return this.roles.indexOf("admin")>=0&&this.adminType===Contact.AdminType.ORGANIZATION_ADMIN}isCompanyAdmin(){return this.roles.indexOf("admin")>=0&&this.adminType===Contact.AdminType.COMPANY_ADMIN}isSiteAdmin(){return this.roles.indexOf("admin")>=0&&this.adminType===Contact.AdminType.SITE_ADMIN}isAdmin(){return this.roles.indexOf("admin")>=0&&(!this.isOrganizationAdmin()||!this.isBPAdmin())}isECAdmin(){return this.company&&!this.company.isBP&&this.isAdmin()}isBPAdmin(){return this.isBPAdminOperations()||this.isBPAdminFinance()}isBPAdminOperations(){return this.company&&this.company.isBP&&this.roles.indexOf("bp_admin")>=0}isBPAdminFinance(){return this.company&&this.company.isBP&&this.roles.indexOf("bp_finance")>=0}isBPAdminDR(){return this.isBPAdmin()&&this.company.isDR()}isBPAdminVAD(){return this.isBPAdmin()&&this.company.isVAD()}isBPAdminIR(){return this.isBPAdmin()&&this.company.isIR()}isDirectoryAdmin(){return this.roles.indexOf("directory_admin")>=0}getAdminType(){return this.roles.indexOf("admin")>=0?this.adminType:Contact.AdminType.UNDEFINED}set fileSharingEnabled(fileSharingEnabled){this._fileSharingEnabled=fileSharingEnabled,this.rxSubject.next({name:"fileSharingEnabled"})}get fileSharingEnabled(){return this._fileSharingEnabled}set fileStorageEnabled(fileStorageEnabled){this._fileStorageEnabled=fileStorageEnabled,this.fileStorageEnabledSubject.next(this._fileStorageEnabled),this.rxSubject.next({name:"fileStorageEnabled"})}get fileStorageEnabled(){return this._fileStorageEnabled}set instantMessagesEnabled(instantMessagesEnabled){this._instantMessagesEnabled=instantMessagesEnabled,this.rxSubject.next({name:"instantMessagesEnabled"})}get instantMessagesEnabled(){return this._instantMessagesEnabled}set changePresenceEnabled(changePresenceEnabled){this._changePresenceEnabled=changePresenceEnabled,this.rxSubject.next({name:"changePresenceEnabled"})}get changePresenceEnabled(){return this._changePresenceEnabled}set phoneMeetingsEnabled(phoneMeetingsEnabled){this._phoneMeetingsEnabled=phoneMeetingsEnabled,this.phoneMeetingsEnabledSubject.next(this._phoneMeetingsEnabled),this.rxSubject.next({name:"phoneMeetingsEnabled"})}get phoneMeetingsEnabled(){return this._phoneMeetingsEnabled}set channelsEnabled(channelsEnabled){this._channelsEnabled=channelsEnabled,this.rxSubject.next({name:"channelsEnabled"})}get channelsEnabled(){return this._channelsEnabled}set roomsEnabled(roomsEnabled){this._roomsEnabled=roomsEnabled,this.rxSubject.next({name:"roomsEnabled"})}get roomsEnabled(){return this._roomsEnabled}set webrtcAudioEnabled(webrtcAudioEnabled){this._webrtcAudioEnabled=webrtcAudioEnabled,this.rxSubject.next({name:"webrtcAudioEnabled"})}get webrtcAudioEnabled(){return this._webrtcAudioEnabled}set webrtcVideoEnabled(webrtcVideoEnabled){this._webrtcVideoEnabled=webrtcVideoEnabled,this.rxSubject.next({name:"webrtcVideoEnabled"})}get webrtcVideoEnabled(){return this._webrtcVideoEnabled}set modifyProfileEnabled(modifyProfileEnabled){this._modifyProfileEnabled=modifyProfileEnabled,this.rxSubject.next({name:"modifyProfileEnabled"})}get modifyProfileEnabled(){return this._modifyProfileEnabled}set useDialOutEnabled(useDialOutEnabled){this._useDialOutEnabled=useDialOutEnabled,this.rxSubject.next({name:"useDialOutEnabled"})}get useDialOutEnabled(){return this._useDialOutEnabled}}exports.Contact=Contact,Contact.AdminType={ORGANIZATION_ADMIN:"organization_admin",COMPANY_ADMIN:"company_admin",SITE_ADMIN:"site_admin",UNDEFINED:"undefined"},Contact.NameUpdatePrio={NO_UPDATE_PRIO:0,OUTLOOK_UPDATE_PRIO:1,SERVER_UPDATE_PRIO:2,MAX_UPDATE_PRIO:99},Contact.textAvatarColor=["#ca8741","#e44647","#c62582","#9b4ce7","#6573ee","#1b70e0","#6ec7d9","#98d1b1","#7fbd40","#b2d334","#dcd232","#f1be00"],Contact.textAvatarName=["purple-lavender","purple-violet","red-coral","blue-jeanlouisdavid","green-mint","green-yellow","orange-jade","pink-lady","yellow-submarine","blue-teal"]},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Group=void 0;class Group{constructor(id,name,comment="",isFavorite=!1){this.isFavorite=!1,this.users=[],this.sortedUserList=[],this.id=id,this.name=name,this.comment=comment,this.isFavorite=isFavorite}static createFromData(data){return new Group(data.id,data.name,data.comment,data.isFavorite)}}exports.Group=Group},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var isArray_1=__webpack_require__(263),isObject_1=__webpack_require__(264),isFunction_1=__webpack_require__(78),UnsubscriptionError_1=__webpack_require__(265),Subscription=function(){function Subscription(unsubscribe){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,unsubscribe&&(this._ctorUnsubscribe=!0,this._unsubscribe=unsubscribe)}var empty;return Subscription.prototype.unsubscribe=function(){var errors;if(!this.closed){var _parentOrParents=this._parentOrParents,_ctorUnsubscribe=this._ctorUnsubscribe,_unsubscribe=this._unsubscribe,_subscriptions=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,_parentOrParents instanceof Subscription)_parentOrParents.remove(this);else if(null!==_parentOrParents)for(var index=0;index<_parentOrParents.length;++index){_parentOrParents[index].remove(this)}if(isFunction_1.isFunction(_unsubscribe)){_ctorUnsubscribe&&(this._unsubscribe=void 0);try{_unsubscribe.call(this)}catch(e){errors=e instanceof UnsubscriptionError_1.UnsubscriptionError?flattenUnsubscriptionErrors(e.errors):[e]}}if(isArray_1.isArray(_subscriptions)){index=-1;for(var len=_subscriptions.length;++index<len;){var sub=_subscriptions[index];if(isObject_1.isObject(sub))try{sub.unsubscribe()}catch(e){errors=errors||[],e instanceof UnsubscriptionError_1.UnsubscriptionError?errors=errors.concat(flattenUnsubscriptionErrors(e.errors)):errors.push(e)}}}if(errors)throw new UnsubscriptionError_1.UnsubscriptionError(errors)}},Subscription.prototype.add=function(teardown){var subscription=teardown;if(!teardown)return Subscription.EMPTY;switch(typeof teardown){case"function":subscription=new Subscription(teardown);case"object":if(subscription===this||subscription.closed||"function"!=typeof subscription.unsubscribe)return subscription;if(this.closed)return subscription.unsubscribe(),subscription;if(!(subscription instanceof Subscription)){var tmp=subscription;(subscription=new Subscription)._subscriptions=[tmp]}break;default:throw new Error("unrecognized teardown "+teardown+" added to Subscription.")}var _parentOrParents=subscription._parentOrParents;if(null===_parentOrParents)subscription._parentOrParents=this;else if(_parentOrParents instanceof Subscription){if(_parentOrParents===this)return subscription;subscription._parentOrParents=[_parentOrParents,this]}else{if(-1!==_parentOrParents.indexOf(this))return subscription;_parentOrParents.push(this)}var subscriptions=this._subscriptions;return null===subscriptions?this._subscriptions=[subscription]:subscriptions.push(subscription),subscription},Subscription.prototype.remove=function(subscription){var subscriptions=this._subscriptions;if(subscriptions){var subscriptionIndex=subscriptions.indexOf(subscription);-1!==subscriptionIndex&&subscriptions.splice(subscriptionIndex,1)}},Subscription.EMPTY=((empty=new Subscription).closed=!0,empty),Subscription}();function flattenUnsubscriptionErrors(errors){return errors.reduce((function(errs,err){return errs.concat(err instanceof UnsubscriptionError_1.UnsubscriptionError?err.errors:err)}),[])}exports.Subscription=Subscription},function(module,exports,__webpack_require__){var C,WordArray,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),WordArray=(C=CryptoJS).lib.WordArray,C.enc.Base64={stringify:function(wordArray){var words=wordArray.words,sigBytes=wordArray.sigBytes,map=this._map;wordArray.clamp();for(var base64Chars=[],i=0;i<sigBytes;i+=3)for(var triplet=(words[i>>>2]>>>24-i%4*8&255)<<16|(words[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|words[i+2>>>2]>>>24-(i+2)%4*8&255,j=0;j<4&&i+.75*j<sigBytes;j++)base64Chars.push(map.charAt(triplet>>>6*(3-j)&63));var paddingChar=map.charAt(64);if(paddingChar)for(;base64Chars.length%4;)base64Chars.push(paddingChar);return base64Chars.join("")},parse:function(base64Str){var base64StrLength=base64Str.length,map=this._map,reverseMap=this._reverseMap;if(!reverseMap){reverseMap=this._reverseMap=[];for(var j=0;j<map.length;j++)reverseMap[map.charCodeAt(j)]=j}var paddingChar=map.charAt(64);if(paddingChar){var paddingIndex=base64Str.indexOf(paddingChar);-1!==paddingIndex&&(base64StrLength=paddingIndex)}return function(base64Str,base64StrLength,reverseMap){for(var words=[],nBytes=0,i=0;i<base64StrLength;i++)if(i%4){var bits1=reverseMap[base64Str.charCodeAt(i-1)]<<i%4*2,bits2=reverseMap[base64Str.charCodeAt(i)]>>>6-i%4*2;words[nBytes>>>2]|=(bits1|bits2)<<24-nBytes%4*8,nBytes++}return WordArray.create(words,nBytes)}(base64Str,base64StrLength,reverseMap)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},CryptoJS.enc.Base64)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,T=[];!function(){for(var i=0;i<64;i++)T[i]=4294967296*Math.abs(Math.sin(i+1))|0}();var MD5=C_algo.MD5=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(M,offset){for(var i=0;i<16;i++){var offset_i=offset+i,M_offset_i=M[offset_i];M[offset_i]=16711935&(M_offset_i<<8|M_offset_i>>>24)|4278255360&(M_offset_i<<24|M_offset_i>>>8)}var H=this._hash.words,M_offset_0=M[offset+0],M_offset_1=M[offset+1],M_offset_2=M[offset+2],M_offset_3=M[offset+3],M_offset_4=M[offset+4],M_offset_5=M[offset+5],M_offset_6=M[offset+6],M_offset_7=M[offset+7],M_offset_8=M[offset+8],M_offset_9=M[offset+9],M_offset_10=M[offset+10],M_offset_11=M[offset+11],M_offset_12=M[offset+12],M_offset_13=M[offset+13],M_offset_14=M[offset+14],M_offset_15=M[offset+15],a=H[0],b=H[1],c=H[2],d=H[3];a=FF(a,b,c,d,M_offset_0,7,T[0]),d=FF(d,a,b,c,M_offset_1,12,T[1]),c=FF(c,d,a,b,M_offset_2,17,T[2]),b=FF(b,c,d,a,M_offset_3,22,T[3]),a=FF(a,b,c,d,M_offset_4,7,T[4]),d=FF(d,a,b,c,M_offset_5,12,T[5]),c=FF(c,d,a,b,M_offset_6,17,T[6]),b=FF(b,c,d,a,M_offset_7,22,T[7]),a=FF(a,b,c,d,M_offset_8,7,T[8]),d=FF(d,a,b,c,M_offset_9,12,T[9]),c=FF(c,d,a,b,M_offset_10,17,T[10]),b=FF(b,c,d,a,M_offset_11,22,T[11]),a=FF(a,b,c,d,M_offset_12,7,T[12]),d=FF(d,a,b,c,M_offset_13,12,T[13]),c=FF(c,d,a,b,M_offset_14,17,T[14]),a=GG(a,b=FF(b,c,d,a,M_offset_15,22,T[15]),c,d,M_offset_1,5,T[16]),d=GG(d,a,b,c,M_offset_6,9,T[17]),c=GG(c,d,a,b,M_offset_11,14,T[18]),b=GG(b,c,d,a,M_offset_0,20,T[19]),a=GG(a,b,c,d,M_offset_5,5,T[20]),d=GG(d,a,b,c,M_offset_10,9,T[21]),c=GG(c,d,a,b,M_offset_15,14,T[22]),b=GG(b,c,d,a,M_offset_4,20,T[23]),a=GG(a,b,c,d,M_offset_9,5,T[24]),d=GG(d,a,b,c,M_offset_14,9,T[25]),c=GG(c,d,a,b,M_offset_3,14,T[26]),b=GG(b,c,d,a,M_offset_8,20,T[27]),a=GG(a,b,c,d,M_offset_13,5,T[28]),d=GG(d,a,b,c,M_offset_2,9,T[29]),c=GG(c,d,a,b,M_offset_7,14,T[30]),a=HH(a,b=GG(b,c,d,a,M_offset_12,20,T[31]),c,d,M_offset_5,4,T[32]),d=HH(d,a,b,c,M_offset_8,11,T[33]),c=HH(c,d,a,b,M_offset_11,16,T[34]),b=HH(b,c,d,a,M_offset_14,23,T[35]),a=HH(a,b,c,d,M_offset_1,4,T[36]),d=HH(d,a,b,c,M_offset_4,11,T[37]),c=HH(c,d,a,b,M_offset_7,16,T[38]),b=HH(b,c,d,a,M_offset_10,23,T[39]),a=HH(a,b,c,d,M_offset_13,4,T[40]),d=HH(d,a,b,c,M_offset_0,11,T[41]),c=HH(c,d,a,b,M_offset_3,16,T[42]),b=HH(b,c,d,a,M_offset_6,23,T[43]),a=HH(a,b,c,d,M_offset_9,4,T[44]),d=HH(d,a,b,c,M_offset_12,11,T[45]),c=HH(c,d,a,b,M_offset_15,16,T[46]),a=II(a,b=HH(b,c,d,a,M_offset_2,23,T[47]),c,d,M_offset_0,6,T[48]),d=II(d,a,b,c,M_offset_7,10,T[49]),c=II(c,d,a,b,M_offset_14,15,T[50]),b=II(b,c,d,a,M_offset_5,21,T[51]),a=II(a,b,c,d,M_offset_12,6,T[52]),d=II(d,a,b,c,M_offset_3,10,T[53]),c=II(c,d,a,b,M_offset_10,15,T[54]),b=II(b,c,d,a,M_offset_1,21,T[55]),a=II(a,b,c,d,M_offset_8,6,T[56]),d=II(d,a,b,c,M_offset_15,10,T[57]),c=II(c,d,a,b,M_offset_6,15,T[58]),b=II(b,c,d,a,M_offset_13,21,T[59]),a=II(a,b,c,d,M_offset_4,6,T[60]),d=II(d,a,b,c,M_offset_11,10,T[61]),c=II(c,d,a,b,M_offset_2,15,T[62]),b=II(b,c,d,a,M_offset_9,21,T[63]),H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32;var nBitsTotalH=Math.floor(nBitsTotal/4294967296),nBitsTotalL=nBitsTotal;dataWords[15+(nBitsLeft+64>>>9<<4)]=16711935&(nBitsTotalH<<8|nBitsTotalH>>>24)|4278255360&(nBitsTotalH<<24|nBitsTotalH>>>8),dataWords[14+(nBitsLeft+64>>>9<<4)]=16711935&(nBitsTotalL<<8|nBitsTotalL>>>24)|4278255360&(nBitsTotalL<<24|nBitsTotalL>>>8),data.sigBytes=4*(dataWords.length+1),this._process();for(var hash=this._hash,H=hash.words,i=0;i<4;i++){var H_i=H[i];H[i]=16711935&(H_i<<8|H_i>>>24)|4278255360&(H_i<<24|H_i>>>8)}return hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});function FF(a,b,c,d,x,s,t){var n=a+(b&c|~b&d)+x+t;return(n<<s|n>>>32-s)+b}function GG(a,b,c,d,x,s,t){var n=a+(b&d|c&~d)+x+t;return(n<<s|n>>>32-s)+b}function HH(a,b,c,d,x,s,t){var n=a+(b^c^d)+x+t;return(n<<s|n>>>32-s)+b}function II(a,b,c,d,x,s,t){var n=a+(c^(b|~d))+x+t;return(n<<s|n>>>32-s)+b}C.MD5=Hasher._createHelper(MD5),C.HmacMD5=Hasher._createHmacHelper(MD5)}(Math),CryptoJS.MD5)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var int64_buffer_1=__webpack_require__(230),EBMLEncoder_1=__webpack_require__(231),_Buffer=__webpack_require__(56),_tools=__webpack_require__(398),_block=__webpack_require__(399);function WebPBlockFilter(elms){return elms.reduce((function(lst,elm){return"b"!==elm.type||"SimpleBlock"!==elm.name?lst:exports.ebmlBlock(elm.data).frames.some((function(frame){return"9d012a"===frame.slice(3,6).toString("hex")}))?lst.concat(elm):lst}),[])}function VP8BitStreamToRiffWebPBuffer(frame){var VP8Chunk=createRIFFChunk("VP8 ",frame);return createRIFFChunk("RIFF",concat([new exports.Buffer("WEBP","ascii"),VP8Chunk]))}function createRIFFChunk(FourCC,chunk){var chunkSize=new exports.Buffer(4);return chunkSize.writeUInt32LE(chunk.byteLength,0),concat([new exports.Buffer(FourCC.substr(0,4),"ascii"),chunkSize,chunk,new exports.Buffer(chunk.byteLength%2==0?0:1)])}function removeElement(idName,metadata){for(var start=-1,i=0;i<metadata.length;i++){var element=metadata[i];if(element.name===idName){if("m"!==element.type)return void metadata.splice(i,1);if(element.isEnd){if(-1==start)throw new Error("Detected "+idName+" closing element before finding the start");return void metadata.splice(start,i-start+1)}start=i}}}function extractElement(idName,metadata){for(var result=[],start=-1,i=0;i<metadata.length;i++){var element=metadata[i];if(element.name===idName){if("m"!==element.type){result.push(metadata[i]);break}if(element.isEnd){if(-1==start)throw new Error("Detected "+idName+" closing element before finding the start");result=metadata.slice(start,i+1);break}start=i}}return result}function encodedSizeOfEbml(refinedMetaData){var encorder=new EBMLEncoder_1.default;return refinedMetaData.reduce((function(lst,elm){return lst.concat(encorder.encode([elm]))}),[]).reduce((function(o,buf){return o+buf.byteLength}),0)}function refineMetadata(mesetadata,sizeDiff,info){var duration=info.duration,clusterPtrs=info.clusterPtrs,cues=info.cues,_metadata=mesetadata.slice(0);if("number"==typeof duration){var overwrited_1=!1;_metadata.forEach((function(elm){"f"===elm.type&&"Duration"===elm.name&&(overwrited_1=!0,elm.data=createFloatBuffer(duration,8))})),overwrited_1||insertTag(_metadata,"Info",[{name:"Duration",type:"f",data:createFloatBuffer(duration,8)}])}Array.isArray(cues)&&insertTag(_metadata,"Cues",function(cueInfos,sizeDiff){var cues=[];return cueInfos.forEach((function(_a){var CueTrack=_a.CueTrack,CueClusterPosition=_a.CueClusterPosition,CueTime=_a.CueTime;cues.push({name:"CuePoint",type:"m",isEnd:!1}),cues.push({name:"CueTime",type:"u",data:createUIntBuffer(CueTime)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!1}),cues.push({name:"CueTrack",type:"u",data:createUIntBuffer(CueTrack)}),cues.push({name:"CueClusterPosition",type:"u",data:createUIntBuffer(CueClusterPosition+sizeDiff)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!0}),cues.push({name:"CuePoint",type:"m",isEnd:!0})})),cues}(cues,sizeDiff));var seekhead_children=[];return Array.isArray(clusterPtrs)&&(console.warn("append cluster pointers to seekhead is deprecated. please use cues"),seekhead_children=function(clusterPtrs,sizeDiff){var seeks=[];return clusterPtrs.forEach((function(start){seeks.push({name:"Seek",type:"m",isEnd:!1}),seeks.push({name:"SeekID",type:"b",data:new exports.Buffer([31,67,182,117])}),seeks.push({name:"SeekPosition",type:"u",data:createUIntBuffer(start+sizeDiff)}),seeks.push({name:"Seek",type:"m",isEnd:!0})})),seeks}(clusterPtrs,sizeDiff)),insertTag(_metadata,"SeekHead",seekhead_children,!0),_metadata}function insertTag(_metadata,tagName,children,insertHead){void 0===insertHead&&(insertHead=!1);for(var idx=-1,i=0;i<_metadata.length;i++){var elm=_metadata[i];if("m"===elm.type&&elm.name===tagName&&!1===elm.isEnd){idx=i;break}}idx>=0?Array.prototype.splice.apply(_metadata,[idx+1,0].concat(children)):insertHead?[].concat([{name:tagName,type:"m",isEnd:!1}],children,[{name:tagName,type:"m",isEnd:!0}]).reverse().forEach((function(elm){_metadata.unshift(elm)})):(_metadata.push({name:tagName,type:"m",isEnd:!1}),children.forEach((function(elm){_metadata.push(elm)})),_metadata.push({name:tagName,type:"m",isEnd:!0}))}function concat(list){for(var i=0,length=0;i<list.length;++i)length+=list[i].length;var buffer=exports.Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];buf.copy(buffer,pos),pos+=buf.length}return buffer}function createUIntBuffer(value){for(var bytes=1;value>=Math.pow(2,8*bytes);bytes++);if(bytes>=7)return console.warn("7bit or more bigger uint not supported."),new int64_buffer_1.Uint64BE(value).toBuffer();var data=new exports.Buffer(bytes);return data.writeUIntBE(value,0,bytes),data}function createIntBuffer(value){for(var bytes=1;value>=Math.pow(2,8*bytes);bytes++);if(bytes>=7)return console.warn("7bit or more bigger uint not supported."),new int64_buffer_1.Int64BE(value).toBuffer();var data=new exports.Buffer(bytes);return data.writeIntBE(value,0,bytes),data}function createFloatBuffer(value,bytes){var data;if(void 0===bytes&&(bytes=8),8===bytes)return(data=new exports.Buffer(8)).writeDoubleBE(value,0),data;if(4===bytes)return(data=new exports.Buffer(4)).writeFloatBE(value,0),data;throw new Error("float type bits must 4bytes or 8bytes")}exports.Buffer=_Buffer.Buffer,exports.readVint=_tools.readVint,exports.writeVint=_tools.writeVint,exports.ebmlBlock=_block,exports.readBlock=function(buf){return exports.ebmlBlock(new exports.Buffer(buf))},exports.encodeTag=function(tagId,tagData,unknownSize){return void 0===unknownSize&&(unknownSize=!1),concat([tagId,unknownSize?new exports.Buffer("01ffffffffffffff","hex"):exports.writeVint(tagData.length),tagData])},exports.WebPFrameFilter=function(elms){return WebPBlockFilter(elms).reduce((function(lst,elm){return exports.ebmlBlock(elm.data).frames.reduce((function(lst,frame){var webpBuf=VP8BitStreamToRiffWebPBuffer(frame),webp=new Blob([webpBuf],{type:"image/webp"});return lst.concat(webp)}),lst)}),[])},exports.WebPBlockFilter=WebPBlockFilter,exports.VP8BitStreamToRiffWebPBuffer=VP8BitStreamToRiffWebPBuffer,exports.createRIFFChunk=createRIFFChunk,exports.makeMetadataSeekable=function(originalMetadata,duration,cuesInfo){var header=extractElement("EBML",originalMetadata),segmentContentStartPos=encodedSizeOfEbml(header)+12,originalMetadataSize=originalMetadata[originalMetadata.length-1].dataEnd-segmentContentStartPos,info=extractElement("Info",originalMetadata);removeElement("Duration",info),info.splice(1,0,{name:"Duration",type:"f",data:createFloatBuffer(duration,8)});for(var infoSize=encodedSizeOfEbml(info),tracks=extractElement("Tracks",originalMetadata),tracksSize=encodedSizeOfEbml(tracks),seekHeadSize=47,seekHead=[],cuesSize=5+15*cuesInfo.length,cues=[],lastSizeDifference=-1,_loop_1=function(i){var infoStart=seekHeadSize,tracksStart=infoStart+infoSize,cuesStart=tracksStart+tracksSize,sizeDifference=cuesStart+cuesSize-originalMetadataSize;if((seekHead=[]).push({name:"SeekHead",type:"m",isEnd:!1}),seekHead.push({name:"Seek",type:"m",isEnd:!1}),seekHead.push({name:"SeekID",type:"b",data:new exports.Buffer([21,73,169,102])}),seekHead.push({name:"SeekPosition",type:"u",data:createUIntBuffer(infoStart)}),seekHead.push({name:"Seek",type:"m",isEnd:!0}),seekHead.push({name:"Seek",type:"m",isEnd:!1}),seekHead.push({name:"SeekID",type:"b",data:new exports.Buffer([22,84,174,107])}),seekHead.push({name:"SeekPosition",type:"u",data:createUIntBuffer(tracksStart)}),seekHead.push({name:"Seek",type:"m",isEnd:!0}),seekHead.push({name:"Seek",type:"m",isEnd:!1}),seekHead.push({name:"SeekID",type:"b",data:new exports.Buffer([28,83,187,107])}),seekHead.push({name:"SeekPosition",type:"u",data:createUIntBuffer(cuesStart)}),seekHead.push({name:"Seek",type:"m",isEnd:!0}),seekHead.push({name:"SeekHead",type:"m",isEnd:!0}),seekHeadSize=encodedSizeOfEbml(seekHead),(cues=[]).push({name:"Cues",type:"m",isEnd:!1}),cuesInfo.forEach((function(_a){var CueTrack=_a.CueTrack,CueClusterPosition=_a.CueClusterPosition,CueTime=_a.CueTime;cues.push({name:"CuePoint",type:"m",isEnd:!1}),cues.push({name:"CueTime",type:"u",data:createUIntBuffer(CueTime)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!1}),cues.push({name:"CueTrack",type:"u",data:createUIntBuffer(CueTrack)}),CueClusterPosition-=segmentContentStartPos,CueClusterPosition+=sizeDifference,cues.push({name:"CueClusterPosition",type:"u",data:createUIntBuffer(CueClusterPosition)}),cues.push({name:"CueTrackPositions",type:"m",isEnd:!0}),cues.push({name:"CuePoint",type:"m",isEnd:!0})})),cues.push({name:"Cues",type:"m",isEnd:!0}),cuesSize=encodedSizeOfEbml(cues),lastSizeDifference===sizeDifference)return"break";if(lastSizeDifference=sizeDifference,9===i)throw new Error("Failed to converge to a stable metadata size")},i=0;i<10;i++){if("break"===_loop_1(i))break}var finalMetadata=[].concat.apply([],[header,{name:"Segment",type:"m",isEnd:!1,unknownSize:!0},seekHead,info,tracks,cues]);return(new EBMLEncoder_1.default).encode(finalMetadata)},exports.removeElement=removeElement,exports.extractElement=extractElement,exports.putRefinedMetaData=function(metadata,info){Array.isArray(info.cueInfos)&&!Array.isArray(info.cues)&&(console.warn("putRefinedMetaData: info.cueInfos property is deprecated. please use info.cues"),info.cues=info.cueInfos);for(var ebml=[],payload=[],i_1=0;i_1<metadata.length;i_1++){var elm=metadata[i_1];if("m"===elm.type&&"Segment"===elm.name){if(ebml=metadata.slice(0,i_1),payload=metadata.slice(i_1),elm.unknownSize){payload.shift();break}throw new Error("this metadata is not streaming webm file")}}if(!(payload[payload.length-1].dataEnd>0))throw new Error("metadata dataEnd has wrong number");var i,originalPayloadOffsetEnd=payload[payload.length-1].dataEnd,ebmlSize=ebml[ebml.length-1].dataEnd,offsetDiff=(new EBMLEncoder_1.default).encode(ebml).byteLength-ebmlSize,payloadSize=originalPayloadOffsetEnd-payload[0].tagStart,segmentTagBuf=(payload[0].tagStart,payload[0].tagStart,new exports.Buffer([24,83,128,103])),segmentSizeBuf=new exports.Buffer("01ffffffffffffff","hex"),_segmentSize=segmentTagBuf.byteLength+segmentSizeBuf.byteLength,newPayloadSize=payloadSize;for(i=1;i<20;i++){var refined=refineMetadata(payload,offsetDiff+(ebmlSize+_segmentSize+newPayloadSize-originalPayloadOffsetEnd),info),newNewRefinedSize=(new EBMLEncoder_1.default).encode(refined).byteLength;if(newNewRefinedSize===newPayloadSize)return(new EBMLEncoder_1.default).encode([].concat(ebml,[{type:"m",name:"Segment",isEnd:!1,unknownSize:!0}],refined));newPayloadSize=newNewRefinedSize}throw new Error("unable to refine metadata, stable size could not be found in "+i+" iterations!")},exports.concat=concat,exports.encodeValueToBuffer=function(elm){var data=new exports.Buffer(0);if("m"===elm.type)return elm;switch(elm.type){case"u":data=createUIntBuffer(elm.value);break;case"i":data=createIntBuffer(elm.value);break;case"f":data=createFloatBuffer(elm.value);break;case"s":data=new exports.Buffer(elm.value,"ascii");break;case"8":data=new exports.Buffer(elm.value,"utf8");break;case"b":data=elm.value;break;case"d":data=new int64_buffer_1.Int64BE(elm.value.getTime().toString()).toBuffer()}return Object.assign({},elm,{data:data})},exports.createUIntBuffer=createUIntBuffer,exports.createIntBuffer=createIntBuffer,exports.createFloatBuffer=createFloatBuffer,exports.convertEBMLDateToJSDate=function(int64str){return int64str instanceof Date?int64str:new Date(new Date("2001-01-01T00:00:00.000Z").getTime()+Number(int64str)/1e3/1e3)}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PromiseQueue=void 0;const logger_service_1=__webpack_require__(15);class PromiseQueue{constructor(){this.queue=[],this.started=!1}static create(){return new PromiseQueue}add(promise){this.queue.push(promise),this.started||(this.started=!0,this.execute())}execute(){const promise=this.queue.shift();if(promise)try{this.timeoutPromise(2e4,promise).then(()=>{this.execute()}).catch(error=>{const errorMessage=error&&error.message?error.message:"Unknown error";logger_service_1.default.error("[PromiseQueue] execute failure -- "+errorMessage),this.execute()})}catch(error){const errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";logger_service_1.default.error(`[PromiseQueue] execution exception  -- ${errorMessage} : ${errorStack}`),this.execute()}else this.started=!1}timeoutPromise(ms,promise){let timeoutId=null;const timeout=new Promise((__resolve,reject)=>{timeoutId=setTimeout(()=>{reject(new Error("Timed out in "+ms+"ms."))},ms)});return Promise.race([promise(),timeout]).then(value=>(clearTimeout(timeoutId),value))}}exports.PromiseQueue=PromiseQueue},function(module,__webpack_exports__,__webpack_require__){"use strict";function isObject(x){return null!==x&&"object"==typeof x}__webpack_require__.d(__webpack_exports__,"a",(function(){return isObject}))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return canReportError}));var _Subscriber__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(11);function canReportError(observer){for(;observer;){var _a=observer,closed_1=_a.closed,destination=_a.destination,isStopped=_a.isStopped;if(closed_1||isStopped)return!1;observer=destination&&destination instanceof _Subscriber__WEBPACK_IMPORTED_MODULE_0__.a?destination:null}return!0}},function(module,exports,__webpack_require__){"use strict";var SDPUtils={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};SDPUtils.localCName=SDPUtils.generateIdentifier(),SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map((function(line){return line.trim()}))},SDPUtils.splitSections=function(blob){return blob.split("\nm=").map((function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"}))},SDPUtils.getDescription=function(blob){var sections=SDPUtils.splitSections(blob);return sections&&sections[0]},SDPUtils.getMediaSections=function(blob){var sections=SDPUtils.splitSections(blob);return sections.shift(),sections},SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter((function(line){return 0===line.indexOf(prefix)}))},SDPUtils.parseCandidate=function(line){for(var parts,candidate={foundation:(parts=0===line.indexOf("a=candidate:")?line.substring(12).split(" "):line.substring(10).split(" "))[0],component:parseInt(parts[1],10),protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],address:parts[4],port:parseInt(parts[5],10),type:parts[7]},i=8;i<parts.length;i+=2)switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;case"ufrag":candidate.ufrag=parts[i+1],candidate.usernameFragment=parts[i+1];break;default:candidate[parts[i]]=parts[i+1]}return candidate},SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation),sdp.push(candidate.component),sdp.push(candidate.protocol.toUpperCase()),sdp.push(candidate.priority),sdp.push(candidate.address||candidate.ip),sdp.push(candidate.port);var type=candidate.type;return sdp.push("typ"),sdp.push(type),"host"!==type&&candidate.relatedAddress&&candidate.relatedPort&&(sdp.push("raddr"),sdp.push(candidate.relatedAddress),sdp.push("rport"),sdp.push(candidate.relatedPort)),candidate.tcpType&&"tcp"===candidate.protocol.toLowerCase()&&(sdp.push("tcptype"),sdp.push(candidate.tcpType)),(candidate.usernameFragment||candidate.ufrag)&&(sdp.push("ufrag"),sdp.push(candidate.usernameFragment||candidate.ufrag)),"candidate:"+sdp.join(" ")},SDPUtils.parseIceOptions=function(line){return line.substr(14).split(" ")},SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" "),parsed={payloadType:parseInt(parts.shift(),10)};return parts=parts[0].split("/"),parsed.name=parts[0],parsed.clockRate=parseInt(parts[1],10),parsed.channels=3===parts.length?parseInt(parts[2],10):1,parsed.numChannels=parsed.channels,parsed},SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType);var channels=codec.channels||codec.numChannels||1;return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(1!==channels?"/"+channels:"")+"\r\n"},SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),direction:parts[0].indexOf("/")>0?parts[0].split("/")[1]:"sendrecv",uri:parts[1]}},SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+(headerExtension.direction&&"sendrecv"!==headerExtension.direction?"/"+headerExtension.direction:"")+" "+headerExtension.uri+"\r\n"},SDPUtils.parseFmtp=function(line){for(var kv,parsed={},parts=line.substr(line.indexOf(" ")+1).split(";"),j=0;j<parts.length;j++)parsed[(kv=parts[j].trim().split("="))[0].trim()]=kv[1];return parsed},SDPUtils.writeFmtp=function(codec){var line="",pt=codec.payloadType;if(void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach((function(param){codec.parameters[param]?params.push(param+"="+codec.parameters[param]):params.push(param)})),line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line},SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}},SDPUtils.writeRtcpFb=function(codec){var lines="",pt=codec.payloadType;return void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.rtcpFeedback&&codec.rtcpFeedback.length&&codec.rtcpFeedback.forEach((function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"})),lines},SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" "),parts={ssrc:parseInt(line.substr(7,sp-7),10)},colon=line.indexOf(":",sp);return colon>-1?(parts.attribute=line.substr(sp+1,colon-sp-1),parts.value=line.substr(colon+1)):parts.attribute=line.substr(sp+1),parts},SDPUtils.parseSsrcGroup=function(line){var parts=line.substr(13).split(" ");return{semantics:parts.shift(),ssrcs:parts.map((function(ssrc){return parseInt(ssrc,10)}))}},SDPUtils.getMid=function(mediaSection){var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0];if(mid)return mid.substr(6)},SDPUtils.parseFingerprint=function(line){var parts=line.substr(14).split(" ");return{algorithm:parts[0].toLowerCase(),value:parts[1]}},SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){return{role:"auto",fingerprints:SDPUtils.matchPrefix(mediaSection+sessionpart,"a=fingerprint:").map(SDPUtils.parseFingerprint)}},SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";return params.fingerprints.forEach((function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"})),sdp},SDPUtils.parseCryptoLine=function(line){var parts=line.substr(9).split(" ");return{tag:parseInt(parts[0],10),cryptoSuite:parts[1],keyParams:parts[2],sessionParams:parts.slice(3)}},SDPUtils.writeCryptoLine=function(parameters){return"a=crypto:"+parameters.tag+" "+parameters.cryptoSuite+" "+("object"==typeof parameters.keyParams?SDPUtils.writeCryptoKeyParams(parameters.keyParams):parameters.keyParams)+(parameters.sessionParams?" "+parameters.sessionParams.join(" "):"")+"\r\n"},SDPUtils.parseCryptoKeyParams=function(keyParams){if(0!==keyParams.indexOf("inline:"))return null;var parts=keyParams.substr(7).split("|");return{keyMethod:"inline",keySalt:parts[0],lifeTime:parts[1],mkiValue:parts[2]?parts[2].split(":")[0]:void 0,mkiLength:parts[2]?parts[2].split(":")[1]:void 0}},SDPUtils.writeCryptoKeyParams=function(keyParams){return keyParams.keyMethod+":"+keyParams.keySalt+(keyParams.lifeTime?"|"+keyParams.lifeTime:"")+(keyParams.mkiValue&&keyParams.mkiLength?"|"+keyParams.mkiValue+":"+keyParams.mkiLength:"")},SDPUtils.getCryptoParameters=function(mediaSection,sessionpart){return SDPUtils.matchPrefix(mediaSection+sessionpart,"a=crypto:").map(SDPUtils.parseCryptoLine)},SDPUtils.getIceParameters=function(mediaSection,sessionpart){var ufrag=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=ice-ufrag:")[0],pwd=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=ice-pwd:")[0];return ufrag&&pwd?{usernameFragment:ufrag.substr(12),password:pwd.substr(10)}:null},SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\na=ice-pwd:"+params.password+"\r\n"},SDPUtils.parseRtpParameters=function(mediaSection){for(var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},mline=SDPUtils.splitLines(mediaSection)[0].split(" "),i=3;i<mline.length;i++){var pt=mline[i],rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline),fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");switch(codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{},codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb),description.codecs.push(codec),codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase())}}}return SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach((function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))})),description},SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ",sdp+=caps.codecs.length>0?"9":"0",sdp+=" UDP/TLS/RTP/SAVPF ",sdp+=caps.codecs.map((function(codec){return void 0!==codec.preferredPayloadType?codec.preferredPayloadType:codec.payloadType})).join(" ")+"\r\n",sdp+="c=IN IP4 0.0.0.0\r\n",sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n",caps.codecs.forEach((function(codec){sdp+=SDPUtils.writeRtpMap(codec),sdp+=SDPUtils.writeFmtp(codec),sdp+=SDPUtils.writeRtcpFb(codec)}));var maxptime=0;return caps.codecs.forEach((function(codec){codec.maxptime>maxptime&&(maxptime=codec.maxptime)})),maxptime>0&&(sdp+="a=maxptime:"+maxptime+"\r\n"),sdp+="a=rtcp-mux\r\n",caps.headerExtensions&&caps.headerExtensions.forEach((function(extension){sdp+=SDPUtils.writeExtmap(extension)})),sdp},SDPUtils.parseRtpEncodingParameters=function(mediaSection){var secondarySsrc,encodingParameters=[],description=SDPUtils.parseRtpParameters(mediaSection),hasRed=-1!==description.fecMechanisms.indexOf("RED"),hasUlpfec=-1!==description.fecMechanisms.indexOf("ULPFEC"),ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map((function(line){return SDPUtils.parseSsrcMedia(line)})).filter((function(parts){return"cname"===parts.attribute})),primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc,flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map((function(line){return line.substr(17).split(" ").map((function(part){return parseInt(part,10)}))}));flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc&&(secondarySsrc=flows[0][1]),description.codecs.forEach((function(codec){if("RTX"===codec.name.toUpperCase()&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10)};primarySsrc&&secondarySsrc&&(encParam.rtx={ssrc:secondarySsrc}),encodingParameters.push(encParam),hasRed&&((encParam=JSON.parse(JSON.stringify(encParam))).fec={ssrc:primarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"},encodingParameters.push(encParam))}})),0===encodingParameters.length&&primarySsrc&&encodingParameters.push({ssrc:primarySsrc});var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");return bandwidth.length&&(bandwidth=0===bandwidth[0].indexOf("b=TIAS:")?parseInt(bandwidth[0].substr(7),10):0===bandwidth[0].indexOf("b=AS:")?1e3*parseInt(bandwidth[0].substr(5),10)*.95-16e3:void 0,encodingParameters.forEach((function(params){params.maxBitrate=bandwidth}))),encodingParameters},SDPUtils.parseRtcpParameters=function(mediaSection){var rtcpParameters={},remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map((function(line){return SDPUtils.parseSsrcMedia(line)})).filter((function(obj){return"cname"===obj.attribute}))[0];remoteSsrc&&(rtcpParameters.cname=remoteSsrc.value,rtcpParameters.ssrc=remoteSsrc.ssrc);var rsize=SDPUtils.matchPrefix(mediaSection,"a=rtcp-rsize");rtcpParameters.reducedSize=rsize.length>0,rtcpParameters.compound=0===rsize.length;var mux=SDPUtils.matchPrefix(mediaSection,"a=rtcp-mux");return rtcpParameters.mux=mux.length>0,rtcpParameters},SDPUtils.parseMsid=function(mediaSection){var parts,spec=SDPUtils.matchPrefix(mediaSection,"a=msid:");if(1===spec.length)return{stream:(parts=spec[0].substr(7).split(" "))[0],track:parts[1]};var planB=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map((function(line){return SDPUtils.parseSsrcMedia(line)})).filter((function(msidParts){return"msid"===msidParts.attribute}));return planB.length>0?{stream:(parts=planB[0].value.split(" "))[0],track:parts[1]}:void 0},SDPUtils.parseSctpDescription=function(mediaSection){var maxMessageSize,mline=SDPUtils.parseMLine(mediaSection),maxSizeLine=SDPUtils.matchPrefix(mediaSection,"a=max-message-size:");maxSizeLine.length>0&&(maxMessageSize=parseInt(maxSizeLine[0].substr(19),10)),isNaN(maxMessageSize)&&(maxMessageSize=65536);var sctpPort=SDPUtils.matchPrefix(mediaSection,"a=sctp-port:");if(sctpPort.length>0)return{port:parseInt(sctpPort[0].substr(12),10),protocol:mline.fmt,maxMessageSize:maxMessageSize};if(SDPUtils.matchPrefix(mediaSection,"a=sctpmap:").length>0){var parts=SDPUtils.matchPrefix(mediaSection,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(parts[0],10),protocol:parts[1],maxMessageSize:maxMessageSize}}},SDPUtils.writeSctpDescription=function(media,sctp){var output=[];return output="DTLS/SCTP"!==media.protocol?["m="+media.kind+" 9 "+media.protocol+" "+sctp.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+sctp.port+"\r\n"]:["m="+media.kind+" 9 "+media.protocol+" "+sctp.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+sctp.port+" "+sctp.protocol+" 65535\r\n"],void 0!==sctp.maxMessageSize&&output.push("a=max-message-size:"+sctp.maxMessageSize+"\r\n"),output.join("")},SDPUtils.generateSessionId=function(){return Math.random().toString().substr(2,21)},SDPUtils.writeSessionBoilerplate=function(sessId,sessVer,sessUser){var version=void 0!==sessVer?sessVer:2;return"v=0\r\no="+(sessUser||"thisisadapterortc")+" "+(sessId||SDPUtils.generateSessionId())+" "+version+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);if(sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()),sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),"offer"===type?"actpass":"active"),sdp+="a=mid:"+transceiver.mid+"\r\n",transceiver.direction?sdp+="a="+transceiver.direction+"\r\n":transceiver.rtpSender&&transceiver.rtpReceiver?sdp+="a=sendrecv\r\n":transceiver.rtpSender?sdp+="a=sendonly\r\n":transceiver.rtpReceiver?sdp+="a=recvonly\r\n":sdp+="a=inactive\r\n",transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid,sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid,transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid,sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n",transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"),sdp},SDPUtils.getDirection=function(mediaSection,sessionpart){for(var lines=SDPUtils.splitLines(mediaSection),i=0;i<lines.length;i++)switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2)}return sessionpart?SDPUtils.getDirection(sessionpart):"sendrecv"},SDPUtils.getKind=function(mediaSection){return SDPUtils.splitLines(mediaSection)[0].split(" ")[0].substr(2)},SDPUtils.isRejected=function(mediaSection){return"0"===mediaSection.split(" ",2)[1]},SDPUtils.parseMLine=function(mediaSection){var parts=SDPUtils.splitLines(mediaSection)[0].substr(2).split(" ");return{kind:parts[0],port:parseInt(parts[1],10),protocol:parts[2],fmt:parts.slice(3).join(" ")}},SDPUtils.parseOLine=function(mediaSection){var parts=SDPUtils.matchPrefix(mediaSection,"o=")[0].substr(2).split(" ");return{username:parts[0],sessionId:parts[1],sessionVersion:parseInt(parts[2],10),netType:parts[3],addressType:parts[4],address:parts[5]}},SDPUtils.isValidSDP=function(blob){if("string"!=typeof blob||0===blob.length)return!1;for(var lines=SDPUtils.splitLines(blob),i=0;i<lines.length;i++)if(lines[i].length<2||"="!==lines[i].charAt(1))return!1;return!0},module.exports=SDPUtils},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return empty}));var _config__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(21),_util_hostReportError__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(36),empty={closed:!0,next:function(value){},error:function(err){if(_config__WEBPACK_IMPORTED_MODULE_0__.a.useDeprecatedSynchronousErrorHandling)throw err;Object(_util_hostReportError__WEBPACK_IMPORTED_MODULE_1__.a)(err)},complete:function(){}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var canReportError_1=__webpack_require__(262),toSubscriber_1=__webpack_require__(266),observable_1=__webpack_require__(267),pipe_1=__webpack_require__(268),config_1=__webpack_require__(68),Observable=function(){function Observable(subscribe){this._isScalar=!1,subscribe&&(this._subscribe=subscribe)}return Observable.prototype.lift=function(operator){var observable=new Observable;return observable.source=this,observable.operator=operator,observable},Observable.prototype.subscribe=function(observerOrNext,error,complete){var operator=this.operator,sink=toSubscriber_1.toSubscriber(observerOrNext,error,complete);if(operator?sink.add(operator.call(sink,this.source)):sink.add(this.source||config_1.config.useDeprecatedSynchronousErrorHandling&&!sink.syncErrorThrowable?this._subscribe(sink):this._trySubscribe(sink)),config_1.config.useDeprecatedSynchronousErrorHandling&&sink.syncErrorThrowable&&(sink.syncErrorThrowable=!1,sink.syncErrorThrown))throw sink.syncErrorValue;return sink},Observable.prototype._trySubscribe=function(sink){try{return this._subscribe(sink)}catch(err){config_1.config.useDeprecatedSynchronousErrorHandling&&(sink.syncErrorThrown=!0,sink.syncErrorValue=err),canReportError_1.canReportError(sink)?sink.error(err):console.warn(err)}},Observable.prototype.forEach=function(next,promiseCtor){var _this=this;return new(promiseCtor=getPromiseCtor(promiseCtor))((function(resolve,reject){var subscription;subscription=_this.subscribe((function(value){try{next(value)}catch(err){reject(err),subscription&&subscription.unsubscribe()}}),reject,resolve)}))},Observable.prototype._subscribe=function(subscriber){var source=this.source;return source&&source.subscribe(subscriber)},Observable.prototype[observable_1.observable]=function(){return this},Observable.prototype.pipe=function(){for(var operations=[],_i=0;_i<arguments.length;_i++)operations[_i]=arguments[_i];return 0===operations.length?this:pipe_1.pipeFromArray(operations)(this)},Observable.prototype.toPromise=function(promiseCtor){var _this=this;return new(promiseCtor=getPromiseCtor(promiseCtor))((function(resolve,reject){var value;_this.subscribe((function(x){return value=x}),(function(err){return reject(err)}),(function(){return resolve(value)}))}))},Observable.create=function(subscribe){return new Observable(subscribe)},Observable}();function getPromiseCtor(promiseCtor){if(promiseCtor||(promiseCtor=config_1.config.Promise||Promise),!promiseCtor)throw new Error("no Promise impl found");return promiseCtor}exports.Observable=Observable},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var isFunction_1=__webpack_require__(78),Observer_1=__webpack_require__(79),Subscription_1=__webpack_require__(45),rxSubscriber_1=__webpack_require__(69),config_1=__webpack_require__(68),hostReportError_1=__webpack_require__(80),Subscriber=function(_super){function Subscriber(destinationOrNext,error,complete){var _this=_super.call(this)||this;switch(_this.syncErrorValue=null,_this.syncErrorThrown=!1,_this.syncErrorThrowable=!1,_this.isStopped=!1,arguments.length){case 0:_this.destination=Observer_1.empty;break;case 1:if(!destinationOrNext){_this.destination=Observer_1.empty;break}if("object"==typeof destinationOrNext){destinationOrNext instanceof Subscriber?(_this.syncErrorThrowable=destinationOrNext.syncErrorThrowable,_this.destination=destinationOrNext,destinationOrNext.add(_this)):(_this.syncErrorThrowable=!0,_this.destination=new SafeSubscriber(_this,destinationOrNext));break}default:_this.syncErrorThrowable=!0,_this.destination=new SafeSubscriber(_this,destinationOrNext,error,complete)}return _this}return __extends(Subscriber,_super),Subscriber.prototype[rxSubscriber_1.rxSubscriber]=function(){return this},Subscriber.create=function(next,error,complete){var subscriber=new Subscriber(next,error,complete);return subscriber.syncErrorThrowable=!1,subscriber},Subscriber.prototype.next=function(value){this.isStopped||this._next(value)},Subscriber.prototype.error=function(err){this.isStopped||(this.isStopped=!0,this._error(err))},Subscriber.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},Subscriber.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,_super.prototype.unsubscribe.call(this))},Subscriber.prototype._next=function(value){this.destination.next(value)},Subscriber.prototype._error=function(err){this.destination.error(err),this.unsubscribe()},Subscriber.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},Subscriber.prototype._unsubscribeAndRecycle=function(){var _parentOrParents=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=_parentOrParents,this},Subscriber}(Subscription_1.Subscription);exports.Subscriber=Subscriber;var SafeSubscriber=function(_super){function SafeSubscriber(_parentSubscriber,observerOrNext,error,complete){var next,_this=_super.call(this)||this;_this._parentSubscriber=_parentSubscriber;var context=_this;return isFunction_1.isFunction(observerOrNext)?next=observerOrNext:observerOrNext&&(next=observerOrNext.next,error=observerOrNext.error,complete=observerOrNext.complete,observerOrNext!==Observer_1.empty&&(context=Object.create(observerOrNext),isFunction_1.isFunction(context.unsubscribe)&&_this.add(context.unsubscribe.bind(context)),context.unsubscribe=_this.unsubscribe.bind(_this))),_this._context=context,_this._next=next,_this._error=error,_this._complete=complete,_this}return __extends(SafeSubscriber,_super),SafeSubscriber.prototype.next=function(value){if(!this.isStopped&&this._next){var _parentSubscriber=this._parentSubscriber;config_1.config.useDeprecatedSynchronousErrorHandling&&_parentSubscriber.syncErrorThrowable?this.__tryOrSetError(_parentSubscriber,this._next,value)&&this.unsubscribe():this.__tryOrUnsub(this._next,value)}},SafeSubscriber.prototype.error=function(err){if(!this.isStopped){var _parentSubscriber=this._parentSubscriber,useDeprecatedSynchronousErrorHandling=config_1.config.useDeprecatedSynchronousErrorHandling;if(this._error)useDeprecatedSynchronousErrorHandling&&_parentSubscriber.syncErrorThrowable?(this.__tryOrSetError(_parentSubscriber,this._error,err),this.unsubscribe()):(this.__tryOrUnsub(this._error,err),this.unsubscribe());else if(_parentSubscriber.syncErrorThrowable)useDeprecatedSynchronousErrorHandling?(_parentSubscriber.syncErrorValue=err,_parentSubscriber.syncErrorThrown=!0):hostReportError_1.hostReportError(err),this.unsubscribe();else{if(this.unsubscribe(),useDeprecatedSynchronousErrorHandling)throw err;hostReportError_1.hostReportError(err)}}},SafeSubscriber.prototype.complete=function(){var _this=this;if(!this.isStopped){var _parentSubscriber=this._parentSubscriber;if(this._complete){var wrappedComplete=function(){return _this._complete.call(_this._context)};config_1.config.useDeprecatedSynchronousErrorHandling&&_parentSubscriber.syncErrorThrowable?(this.__tryOrSetError(_parentSubscriber,wrappedComplete),this.unsubscribe()):(this.__tryOrUnsub(wrappedComplete),this.unsubscribe())}else this.unsubscribe()}},SafeSubscriber.prototype.__tryOrUnsub=function(fn,value){try{fn.call(this._context,value)}catch(err){if(this.unsubscribe(),config_1.config.useDeprecatedSynchronousErrorHandling)throw err;hostReportError_1.hostReportError(err)}},SafeSubscriber.prototype.__tryOrSetError=function(parent,fn,value){if(!config_1.config.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{fn.call(this._context,value)}catch(err){return config_1.config.useDeprecatedSynchronousErrorHandling?(parent.syncErrorValue=err,parent.syncErrorThrown=!0,!0):(hostReportError_1.hostReportError(err),!0)}return!1},SafeSubscriber.prototype._unsubscribe=function(){var _parentSubscriber=this._parentSubscriber;this._context=null,this._parentSubscriber=null,_parentSubscriber.unsubscribe()},SafeSubscriber}(Subscriber);exports.SafeSubscriber=SafeSubscriber},function(module,exports,__webpack_require__){"use strict";(function(global){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var base64=__webpack_require__(385),ieee754=__webpack_require__(386),isArray=__webpack_require__(387);function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length)throw new RangeError("Invalid typed array length");return Buffer.TYPED_ARRAY_SUPPORT?(that=new Uint8Array(length)).__proto__=Buffer.prototype:(null===that&&(that=new Buffer(length)),that.length=length),that}function Buffer(arg,encodingOrOffset,length){if(!(Buffer.TYPED_ARRAY_SUPPORT||this instanceof Buffer))return new Buffer(arg,encodingOrOffset,length);if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new Error("If encoding is specified then the first argument must be a string");return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}function from(that,value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&value instanceof ArrayBuffer?function(that,array,byteOffset,length){if(array.byteLength,byteOffset<0||array.byteLength<byteOffset)throw new RangeError("'offset' is out of bounds");if(array.byteLength<byteOffset+(length||0))throw new RangeError("'length' is out of bounds");array=void 0===byteOffset&&void 0===length?new Uint8Array(array):void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length);Buffer.TYPED_ARRAY_SUPPORT?(that=array).__proto__=Buffer.prototype:that=fromArrayLike(that,array);return that}(that,value,encodingOrOffset,length):"string"==typeof value?function(that,string,encoding){"string"==typeof encoding&&""!==encoding||(encoding="utf8");if(!Buffer.isEncoding(encoding))throw new TypeError('"encoding" must be a valid string encoding');var length=0|byteLength(string,encoding),actual=(that=createBuffer(that,length)).write(string,encoding);actual!==length&&(that=that.slice(0,actual));return that}(that,value,encodingOrOffset):function(that,obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length);return 0===(that=createBuffer(that,len)).length||obj.copy(that,0,0,len),that}if(obj){if("undefined"!=typeof ArrayBuffer&&obj.buffer instanceof ArrayBuffer||"length"in obj)return"number"!=typeof obj.length||(val=obj.length)!=val?createBuffer(that,0):fromArrayLike(that,obj);if("Buffer"===obj.type&&isArray(obj.data))return fromArrayLike(that,obj.data)}var val;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(that,value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be a number');if(size<0)throw new RangeError('"size" argument must not be negative')}function allocUnsafe(that,size){if(assertSize(size),that=createBuffer(that,size<0?0:0|checked(size)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;i<size;++i)that[i]=0;return that}function fromArrayLike(that,array){var length=array.length<0?0:0|checked(array.length);that=createBuffer(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function checked(length){if(length>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|length}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer))return string.byteLength;"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case void 0:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if((void 0===start||start<0)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),end<=0)return"";if((end>>>=0)<=(start>>>=0))return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(0===buffer.length)return-1;if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),byteOffset=+byteOffset,isNaN(byteOffset)&&(byteOffset=dir?0:buffer.length-1),byteOffset<0&&(byteOffset=buffer.length+byteOffset),byteOffset>=buffer.length){if(dir)return-1;byteOffset=buffer.length-1}else if(byteOffset<0){if(!dir)return-1;byteOffset=0}if("string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(buffer,val,byteOffset,encoding,dir);if("number"==typeof val)return val&=255,Buffer.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?dir?Uint8Array.prototype.indexOf.call(buffer,val,byteOffset):Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset):arrayIndexOf(buffer,[val],byteOffset,encoding,dir);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var i,indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&("ucs2"===(encoding=String(encoding).toLowerCase())||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++)if(read(arr,i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return foundIndex*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1}else for(byteOffset+valLength>arrLength&&(byteOffset=arrLength-valLength),i=byteOffset;i>=0;i--){for(var found=!0,j=0;j<valLength;j++)if(read(arr,i+j)!==read(val,j)){found=!1;break}if(found)return i}return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length))>remaining&&(length=remaining):length=remaining;var strLen=string.length;if(strLen%2!=0)throw new TypeError("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;i<length;++i){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(function(str){for(var byteArray=[],i=0;i<str.length;++i)byteArray.push(255&str.charCodeAt(i));return byteArray}(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(function(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);++i)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&(tempCodePoint=(31&firstByte)<<6|63&secondByte)>127&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return function(codePoints){var len=codePoints.length;if(len<=4096)return String.fromCharCode.apply(String,codePoints);var res="",i=0;for(;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=4096));return res}(res)}exports.Buffer=Buffer,exports.SlowBuffer=function(length){+length!=length&&(length=0);return Buffer.alloc(+length)},exports.INSPECT_MAX_BYTES=50,Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:function(){try{var arr=new Uint8Array(1);return arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===arr.foo()&&"function"==typeof arr.subarray&&0===arr.subarray(1,1).byteLength}catch(e){return!1}}(),exports.kMaxLength=kMaxLength(),Buffer.poolSize=8192,Buffer._augment=function(arr){return arr.__proto__=Buffer.prototype,arr},Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)},Buffer.TYPED_ARRAY_SUPPORT&&(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0})),Buffer.alloc=function(size,fill,encoding){return function(that,size,fill,encoding){return assertSize(size),size<=0?createBuffer(that,size):void 0!==fill?"string"==typeof encoding?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill):createBuffer(that,size)}(null,size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)},Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;++i)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;i<len;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;i<len;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.swap64=function(){var len=this.length;if(len%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var i=0;i<len;i+=8)swap(this,i,i+7),swap(this,i+1,i+6),swap(this,i+2,i+5),swap(this,i+3,i+4);return this},Buffer.prototype.toString=function(){var length=0|this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target))throw new TypeError("Argument must be a Buffer");if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),start<0||end>target.length||thisStart<0||thisEnd>this.length)throw new RangeError("out of range index");if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(this===target)return 0;for(var x=(thisEnd>>>=0)-(thisStart>>>=0),y=(end>>>=0)-(start>>>=0),len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;i<len;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return x<y?-1:y<x?1:0},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.indexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!0)},Buffer.prototype.lastIndexOf=function(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,!1)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset|=0,isFinite(length)?(length|=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(127&buf[i]);return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;++i)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){value<0&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);i<j;++i)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){value<0&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);i<j;++i)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,0,offset,4),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,0,offset,8),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var newBuf,len=this.length;if((start=~~start)<0?(start+=len)<0&&(start=0):start>len&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):end>len&&(end=len),end<start&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)(newBuf=this.subarray(start,end)).__proto__=Buffer.prototype;else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0);for(var i=0;i<sliceLen;++i)newBuf[i]=this[i+start]}return newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){(value=+value,offset|=0,byteLength|=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){(value=+value,offset|=0,byteLength|=0,noAssert)||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength)-1,0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)value<0&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var i,len=end-start;if(this===target&&start<targetStart&&targetStart<end)for(i=len-1;i>=0;--i)target[i+targetStart]=this[i+start];else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(i=0;i<len;++i)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),1===val.length){var code=val.charCodeAt(0);code<256&&(val=code)}if(void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding)}else"number"==typeof val&&(val&=255);if(start<0||this.length<start||this.length<end)throw new RangeError("Out of range index");if(end<=start)return this;var i;if(start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0),"number"==typeof val)for(i=start;i<end;++i)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString()),len=bytes.length;for(i=0;i<end-start;++i)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;++i){if((codePoint=string.charCodeAt(i))>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function base64ToBytes(str){return base64.toByteArray(function(str){if((str=function(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}(str).replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);++i)dst[i+offset]=src[i];return i}}).call(this,__webpack_require__(64))},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PgiConferenceService=void 0;const pgi_conference_service_1=__webpack_require__(332),distinctUntilChanged_1=__webpack_require__(75),contact_service_1=__webpack_require__(1);class PgiConferenceService extends pgi_conference_service_1.NgPgiConferenceService{constructor(){super(),this.contactService=contact_service_1.ContactService.getInstance()}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.pgiConferenceService||(win.rainbow.pgiConferenceService=new PgiConferenceService),win.rainbow.pgiConferenceService}start(stats){this.contactService.userContact.phoneMeetingsEnabledSubject.pipe(distinctUntilChanged_1.distinctUntilChanged()).subscribe(phoneMeetingsEnabled=>phoneMeetingsEnabled?super.start(stats):(this.logger.info("start skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null))}makeSnapshotForConfId(confId){const _super=Object.create(null,{makeSnapshotForConfId:{get:()=>super.makeSnapshotForConfId}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("makeSnapshotForConfId skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):yield _super.makeSnapshotForConfId.call(this,confId)}))}removeConferenceSession(confId){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("removeConferenceSession skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.removeConferenceSession(confId)}updateOrCreateConferenceSession(confId,snapshotData){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("updateOrCreateConferenceSession skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.updateOrCreateConferenceSession(confId,snapshotData)}updateConference(confEndpointId,confData){const _super=Object.create(null,{updateConference:{get:()=>super.updateConference}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("updateConference skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):yield _super.updateConference.call(this,confEndpointId,confData)}))}getPstnInstantConferenceEndpoint(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("getPstnInstantConferenceEndpoint skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.getPstnInstantConferenceEndpoint()}getPstnInstantConferenceEndpointId(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("getPstnInstantConferenceEndpointId skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.getPstnInstantConferenceEndpointId()}retrievePstnConferences(){const _super=Object.create(null,{retrievePstnConferences:{get:()=>super.retrievePstnConferences}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("retrievePstnConferences skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):yield _super.retrievePstnConferences.call(this)}))}retrieveConference(confId,force=!1){const _super=Object.create(null,{retrieveConference:{get:()=>super.retrieveConference}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("retrieveConference skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):yield _super.retrieveConference.call(this,confId,force)}))}updateOrCreatePstnConferenceEndpoint(conferenceData){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("updateOrCreatePstnConferenceEndpoint skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.updateOrCreatePstnConferenceEndpoint(conferenceData)}getConferenceSessionWithConnId(connId){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("getConferenceSessionWithConnId skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.getConferenceSessionWithConnId(connId)}getConferenceSessionById(confId){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("getConferenceSessionById skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.getConferenceSessionById(confId)}subscribeToPstnSession(confId){const _super=Object.create(null,{subscribeToPstnSession:{get:()=>super.subscribeToPstnSession}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("subscribeToPstnSession skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.subscribeToPstnSession.call(this,confId)}))}unSubscribeParticipantFromPstnSession(confId,participantId){const _super=Object.create(null,{unSubscribeParticipantFromPstnSession:{get:()=>super.unSubscribeParticipantFromPstnSession}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("unSubscribeParticipantFromPstnSession skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.unSubscribeParticipantFromPstnSession.call(this,confId,participantId)}))}startPstnConference(confId){const _super=Object.create(null,{startPstnConference:{get:()=>super.startPstnConference}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("startPstnConference skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.startPstnConference.call(this,confId)}))}stopPstnConference(confId){const _super=Object.create(null,{stopPstnConference:{get:()=>super.stopPstnConference}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("stopPstnConference skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.stopPstnConference.call(this,confId)}))}joinPstnConference(confId,participantPhoneNumber,participant,country){const _super=Object.create(null,{joinPstnConference:{get:()=>super.joinPstnConference}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("joinPstnConference skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.joinPstnConference.call(this,confId,participantPhoneNumber,participant,country)}))}disconnectParticipant(confId,participantId){const _super=Object.create(null,{disconnectParticipant:{get:()=>super.disconnectParticipant}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("disconnectParticipant skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.disconnectParticipant.call(this,confId,participantId)}))}retrievePstnPhoneNumbers(shouldFormatResults=!1){const _super=Object.create(null,{retrievePstnPhoneNumbers:{get:()=>super.retrievePstnPhoneNumbers}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("retrievePstnPhoneNumbers skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.retrievePstnPhoneNumbers.call(this,shouldFormatResults)}))}resetPersonalMeetingRoom(){const _super=Object.create(null,{resetPersonalMeetingRoom:{get:()=>super.resetPersonalMeetingRoom}});return __awaiter(this,void 0,void 0,(function*(){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("resetPersonalMeetingRoom skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):_super.resetPersonalMeetingRoom.call(this)}))}subscribeToMyConferenceSessions(eventHandler){return this.contactService&&this.contactService.userContact&&!this.contactService.userContact.phoneMeetingsEnabled?(this.logger.info("subscribeToMyConferenceSessions skipped - phoneMeetingsEnabled : "+this.contactService.userContact.phoneMeetingsEnabled),null):super.subscribeToMyConferenceSessions(eventHandler)}}exports.PgiConferenceService=PgiConferenceService,exports.default=PgiConferenceService.getInstance()},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompanyService=void 0;const event_service_1=__webpack_require__(32),company_model_1=__webpack_require__(19),CryptoJS=__webpack_require__(18),crypto_js_1=__webpack_require__(18),logger_service_1=__webpack_require__(15),auth_service_1=__webpack_require__(2),main_service_1=__webpack_require__(26),userInfo_service_1=__webpack_require__(31),errorHelper_service_1=__webpack_require__(39);class CompanyService{constructor(){this.eventService=event_service_1.default,this.logger=logger_service_1.default,this.authService=auth_service_1.default,this.mainService=main_service_1.default,this.userInfoService=userInfo_service_1.default,this.companies={},this.eventService.subscribe("ON_COMPANY_CHANGE_EVENT",(__event,companyId)=>{this.getCompanyById(companyId,!0)})}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.companyService||(win.rainbow.companyService=new CompanyService),win.rainbow.companyService}getCompanyById(companyId,update=!1){return __awaiter(this,void 0,void 0,(function*(){try{if(!companyId)throw new Error("missing companyId");let company=this.companies[companyId];if(company&&!update)return this.logger.info("[companyService] getCompanyById (cache) "+companyId+" - success"),company;const headers=this.authService.getRequestHeader(),url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/companies/${companyId}`,responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw new Error(responseData.statusText);const companyData=yield responseData.json();return company?(company.updateFromData(companyData.data),this.logger.info(`getCompanyById (update) ${companyId} - success`)):(company=company_model_1.Company.createFromData(companyData.data),this.companies[company.id]=company,this.logger.info(`getCompanyById ${companyId} - success`)),this.getCompanyLogo(company),this.getCompanyBanner(company),company}catch(error){const errorMessage="getCompanyById -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}searchCompanies(searchText,hasBP=null,isBP=null,bpType=null){return __awaiter(this,void 0,void 0,(function*(){try{let url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/companies?name=${encodeURIComponent(searchText)}&format=full`;null!=hasBP&&(url+="&hasBP="+hasBP),null!=isBP&&(url+="&isBP="+isBP),bpType&&(url+="&bpType="+bpType);const headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw new Error(responseData.statusText);const companiesData=yield responseData.json(),companies=companiesData.data.reduce((result,companyData)=>{if("Default"!==companyData.name&&"Rainbow"!==companyData.name&&"active"===companyData.status){let company=this.companies[companyData.id];company||(company=company_model_1.Company.createFromData(companyData),this.companies[company.id]=company,this.getCompanyLogo(company)),result.push(company)}return result},[]);return this.logger.info("searchCompanies with criteria '"+searchText+"' - success - found "+companiesData.length+" companies : returns "+companies.length+" companies"),companies}catch(error){const errorMessage="searchCompanies -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}getCompanyAdminsData(companyId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/companies/${companyId}/administrators`,headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw new Error(responseData.statusText);return(yield responseData.json()).data}catch(error){const errorMessage="getCompanyById -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}getCompanyUsers(companyId,page,pageSize){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/search/v1.0/users?companyId=${companyId}&limit=${pageSize}`,headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw new Error(responseData.statusText);yield responseData.json()}catch(error){const errorMessage="getCompanyById -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}getCompanyLogo(company){return __awaiter(this,void 0,void 0,(function*(){try{const companyColor=this.userInfoService.computeUserColor(company.name),companyInitials=company.name.substr(0,1);return company.logo=this.userInfoService.getAvatarImage(company.id,companyInitials,companyColor.color,130,company.lastAvatarUpdateDate),this.eventService.publish("ON_COMPANY_LOGO_UPDATED",company.id),this.logger.info("[getCompanyLogo] - "+company.getNameForLogs()+" - success"),company.sendChangeEvent("logo"),company}catch(error){throw new Error("getCompanyLogo -- FAILURE -- "+error.message)}}))}getCompanyBanner(company){return __awaiter(this,void 0,void 0,(function*(){return new Promise(resolve=>{const image=new Image;image.onload=()=>{company.banner=image,this.eventService.publish("ON_COMPANY_BANNER_UPDATED",company.id),this.logger.info("[getCompanyBanner] - "+company.getNameForLogs()+" - success"),resolve(company)},image.onerror=()=>{this.logger.error("[companyService] Load banner for "+company.getNameForLogs()+" failure"),resolve(company)};let imgSrc="/cacheV2/images/company-banner-01.svg";if(company.lastBannerUpdateDate){let serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;this.mainService.cdn&&(serverURL=this.mainService.cdnServer),imgSrc=serverURL+"/api/banner/"+company.id+"?size=831",imgSrc+="&update="+crypto_js_1.MD5(CryptoJS.enc.Latin1.parse(company.lastBannerUpdateDate)).toString(CryptoJS.enc.Hex)}image.src=imgSrc})}))}getCompanyAlertNotificationState(company){return __awaiter(this,void 0,void 0,(function*(){if(config.urgencyNotifEmissionForced)return!0;try{const url=`${config.restServerUrl}/api/rainbow/subscription/v1.0/companies/${company.id}/subscriptions/features`,headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw new Error(responseData.statusText);const feature=(yield responseData.json()).data.find(feat=>"ALERT_NOTIFICATIONS_ALLOWED"===feat.featureUniqueRef);if(feature)return feature.isEnabled}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"getCompanySubscriptions");this.logger.warn("[roomService] "+errorInfo.message)}return!1}))}}exports.CompanyService=CompanyService,exports.default=CompanyService.getInstance()},function(module,exports,__webpack_require__){(function(global){function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}var reUnescapedHtml=/[&<>"'`]/g,reHasUnescapedHtml=RegExp(reUnescapedHtml.source),freeGlobal="object"==(void 0===global?"undefined":_typeof(global))&&global&&global.Object===Object&&global,freeSelf="object"==("undefined"==typeof self?"undefined":_typeof(self))&&self&&self.Object===Object&&self,root=freeGlobal||freeSelf||Function("return this")();var object,escapeHtmlChar=(object={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},function(key){return null==object?void 0:object[key]}),objectToString=Object.prototype.toString,_Symbol=root.Symbol,symbolProto=_Symbol?_Symbol.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;function baseToString(value){if("string"==typeof value)return value;if(function(value){return"symbol"==_typeof(value)||function(value){return!!value&&"object"==_typeof(value)}(value)&&"[object Symbol]"==objectToString.call(value)}(value))return symbolToString?symbolToString.call(value):"";var result=value+"";return"0"==result&&1/value==-1/0?"-0":result}try{module.exports=function(string){var value;return(string=null==(value=string)?"":baseToString(value))&&reHasUnescapedHtml.test(string)?string.replace(reUnescapedHtml,escapeHtmlChar):string}}catch(e){}}).call(this,__webpack_require__(64))},function(module,exports,__webpack_require__){var C,C_lib,Base,X32WordArray,C_x64,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),C_lib=(C=CryptoJS).lib,Base=C_lib.Base,X32WordArray=C_lib.WordArray,(C_x64=C.x64={}).Word=Base.extend({init:function(high,low){this.high=high,this.low=low}}),C_x64.WordArray=Base.extend({init:function(words,sigBytes){words=this.words=words||[],this.sigBytes=null!=sigBytes?sigBytes:8*words.length},toX32:function(){for(var x64Words=this.words,x64WordsLength=x64Words.length,x32Words=[],i=0;i<x64WordsLength;i++){var x64Word=x64Words[i];x32Words.push(x64Word.high),x32Words.push(x64Word.low)}return X32WordArray.create(x32Words,this.sigBytes)},clone:function(){for(var clone=Base.clone.call(this),words=clone.words=this.words.slice(0),wordsLength=words.length,i=0;i<wordsLength;i++)words[i]=words[i].clone();return clone}}),CryptoJS)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return pipe})),__webpack_require__.d(__webpack_exports__,"b",(function(){return pipeFromArray}));var _identity__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(34);function pipe(){for(var fns=[],_i=0;_i<arguments.length;_i++)fns[_i]=arguments[_i];return pipeFromArray(fns)}function pipeFromArray(fns){return 0===fns.length?_identity__WEBPACK_IMPORTED_MODULE_0__.a:1===fns.length?fns[0]:function(input){return fns.reduce((function(prev,fn){return fn(prev)}),input)}}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return SubjectSubscription}));var tslib__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6),SubjectSubscription=function(_super){function SubjectSubscription(subject,subscriber){var _this=_super.call(this)||this;return _this.subject=subject,_this.subscriber=subscriber,_this.closed=!1,_this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(SubjectSubscription,_super),SubjectSubscription.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var subject=this.subject,observers=subject.observers;if(this.subject=null,observers&&0!==observers.length&&!subject.isStopped&&!subject.closed){var subscriberIndex=observers.indexOf(this.subscriber);-1!==subscriberIndex&&observers.splice(subscriberIndex,1)}}},SubjectSubscription}(__webpack_require__(13).a)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CountryService=void 0;const auth_service_1=__webpack_require__(2),logger_service_1=__webpack_require__(15),i18n_service_1=__webpack_require__(37);class CountryService{constructor(){this.portalURL=null,this.datacenters=[{name:"France","alpha-3":"FRA","alpha-2":"FR",region:"Europe"},{name:"Germany","alpha-3":"DEU","alpha-2":"DE",region:"Europe"},{name:"Canada","alpha-3":"CAN","alpha-2":"CA",region:"America"},{name:"Singapore","alpha-3":"SGP","alpha-2":"SG",region:"Asia-Pacific"}],this.countries=[{name:"Australia","alpha-3":"AUS","country-code":"036","alpha-2":"AU"},{name:"Austria","alpha-3":"AUT","country-code":"040","alpha-2":"AT"},{name:"Belgium","alpha-3":"BEL","country-code":"056","alpha-2":"BE"},{name:"Brazil","alpha-3":"BRA","country-code":"076","alpha-2":"BR"},{name:"Canada","alpha-3":"CAN","country-code":"124","alpha-2":"CA"},{name:"China","alpha-3":"CHN","country-code":"156","alpha-2":"CN"},{name:"Czech Republic","alpha-3":"CZE","country-code":"203","alpha-2":"CZ"},{name:"Denmark","alpha-3":"DNK","country-code":"208","alpha-2":"DK"},{name:"Finland","alpha-3":"FIN","country-code":"246","alpha-2":"FI"},{name:"France","alpha-3":"FRA","country-code":"250",default:!0,"alpha-2":"FR"},{name:"Germany","alpha-3":"DEU","country-code":"276","alpha-2":"DE"},{name:"Hong Kong","alpha-3":"HKG","country-code":"344","alpha-2":"HK"},{name:"Ireland","alpha-3":"IRL","country-code":"372","alpha-2":"IE"},{name:"Israel","alpha-3":"ISR","country-code":"376","alpha-2":"IL"},{name:"Italy","alpha-3":"ITA","country-code":"380","alpha-2":"IT"},{name:"Mexico","alpha-3":"MEX","country-code":"484","alpha-2":"MX"},{name:"Netherlands","alpha-3":"NLD","country-code":"528","alpha-2":"NL"},{name:"Norway","alpha-3":"NOR","country-code":"578","alpha-2":"NO"},{name:"Poland","alpha-3":"POL","country-code":"616","alpha-2":"PL"},{name:"Portugal","alpha-3":"PRT","country-code":"620","alpha-2":"PT"},{name:"Russia","alpha-3":"RUS","country-code":"643","alpha-2":"RU"},{name:"South Africa","alpha-3":"ZAF","country-code":"710","alpha-2":"ZA"},{name:"South Korea","alpha-3":"KOR","country-code":"410","alpha-2":"KR"},{name:"Spain","alpha-3":"ESP","country-code":"724","alpha-2":"ES"},{name:"Sweden","alpha-3":"SWE","country-code":"752","alpha-2":"SE"},{name:"Switzerland","alpha-3":"CHE","country-code":"756","alpha-2":"CH"},{name:"Taiwan","alpha-3":"TWN","country-code":"158","alpha-2":"TW"},{name:"Turkey","alpha-3":"TUR","country-code":"792","alpha-2":"TR"},{name:"United Kingdom","alpha-3":"GBR","country-code":"826","alpha-2":"GB"},{name:"United States of America","alpha-3":"USA","country-code":"840","alpha-2":"US"},{name:"Afghanistan","alpha-3":"AFG","country-code":"004","alpha-2":"AF"},{name:"Albania","alpha-3":"ALB","country-code":"008","alpha-2":"AL"},{name:"Algeria","alpha-3":"DZA","country-code":"012","alpha-2":"DZ"},{name:"Andorra","alpha-3":"AND","country-code":"020","alpha-2":"AD"},{name:"Angola","alpha-3":"AGO","country-code":"024","alpha-2":"AO"},{name:"Anguilla","alpha-3":"AIA","country-code":"660","alpha-2":"AI"},{name:"Antigua and Barbuda","alpha-3":"ATG","country-code":"028","alpha-2":"AG"},{name:"Argentina","alpha-3":"ARG","country-code":"032","alpha-2":"AR"},{name:"Armenia","alpha-3":"ARM","country-code":"051","alpha-2":"AM"},{name:"Aruba","alpha-3":"ABW","country-code":"533","alpha-2":"AW"},{name:"Azerbaijan","alpha-3":"AZE","country-code":"031","alpha-2":"AZ"},{name:"Bahamas","alpha-3":"BHS","country-code":"044","alpha-2":"BS"},{name:"Bahrain","alpha-3":"BHR","country-code":"048","alpha-2":"BH"},{name:"Bangladesh","alpha-3":"BGD","country-code":"050","alpha-2":"BD"},{name:"Barbados","alpha-3":"BRB","country-code":"052","alpha-2":"BB"},{name:"Belarus","alpha-3":"BLR","country-code":"112","alpha-2":"BY"},{name:"Belize","alpha-3":"BLZ","country-code":"084","alpha-2":"BZ"},{name:"Benin","alpha-3":"BEN","country-code":"204","alpha-2":"BJ"},{name:"Bermuda","alpha-3":"BMU","country-code":"060","alpha-2":"BM"},{name:"Bhutan","alpha-3":"BTN","country-code":"064","alpha-2":"BT"},{name:"Bolivia","alpha-3":"BOL","country-code":"068","alpha-2":"BO"},{name:"Bosnia and Herzegovina","alpha-3":"BIH","country-code":"070","alpha-2":"BA"},{name:"Botswana","alpha-3":"BWA","country-code":"072","alpha-2":"BW"},{name:"British Virgin Islands","alpha-3":"VGB","country-code":"092","alpha-2":"VG"},{name:"Brunei Darussalam","alpha-3":"BRN","country-code":"096","alpha-2":"BN"},{name:"Bulgaria","alpha-3":"BGR","country-code":"100","alpha-2":"BG"},{name:"Burkina Faso","alpha-3":"BFA","country-code":"854","alpha-2":"BF"},{name:"Burundi","alpha-3":"BDI","country-code":"108","alpha-2":"BI"},{name:"Cambodia","alpha-3":"KHM","country-code":"116","alpha-2":"KH"},{name:"Cameroon","alpha-3":"CMR","country-code":"120","alpha-2":"CM"},{name:"Cape Verde","alpha-3":"CPV","country-code":"132","alpha-2":"CV"},{name:"Cayman Islands","alpha-3":"CYM","country-code":"136","alpha-2":"KY"},{name:"Central African Republic","alpha-3":"CAF","country-code":"140","alpha-2":"CF"},{name:"Chad","alpha-3":"TCD","country-code":"148","alpha-2":"TD"},{name:"Chile","alpha-3":"CHL","country-code":"152","alpha-2":"CL"},{name:"Colombia","alpha-3":"COL","country-code":"170","alpha-2":"CO"},{name:"Comoros","alpha-3":"COM","country-code":"174","alpha-2":"KM"},{name:"Congo","alpha-3":"COG","country-code":"178","alpha-2":"CG"},{name:"Congo, Democratic Republic of","alpha-3":"COD","country-code":"180","alpha-2":"CD"},{name:"Costa Rica","alpha-3":"CRI","country-code":"188","alpha-2":"CR"},{name:"Ivory Coast","alpha-3":"CIV","country-code":"384","alpha-2":"CI"},{name:"Croatia","alpha-3":"HRV","country-code":"191","alpha-2":"HR"},{name:"Cyprus","alpha-3":"CYP","country-code":"196","alpha-2":"CY"},{name:"Djibouti","alpha-3":"DJI","country-code":"262","alpha-2":"DJ"},{name:"Dominica","alpha-3":"DMA","country-code":"212","alpha-2":"DM"},{name:"Dominican Republic","alpha-3":"DOM","country-code":"214","alpha-2":"DO"},{name:"Ecuador","alpha-3":"ECU","country-code":"218","alpha-2":"EC"},{name:"El Salvador","alpha-3":"SLV","country-code":"222","alpha-2":"SV"},{name:"Egypt","alpha-3":"EGY","country-code":"818","alpha-2":"EG"},{name:"Eritrea","alpha-3":"ERI","country-code":"232","alpha-2":"ER"},{name:"Estonia","alpha-3":"EST","country-code":"233","alpha-2":"EE"},{name:"Ethiopia","alpha-3":"ETH","country-code":"231","alpha-2":"ET"},{name:"Fiji","alpha-3":"FJI","country-code":"242","alpha-2":"FJ"},{name:"French Guiana","alpha-3":"GUF","country-code":"254","alpha-2":"GF"},{name:"French Polynesia","alpha-3":"PYF","country-code":"258","alpha-2":"PF"},{name:"Gabon","alpha-3":"GAB","country-code":"266","alpha-2":"GA"},{name:"Gambia","alpha-3":"GMB","country-code":"270","alpha-2":"GM"},{name:"Georgia","alpha-3":"GEO","country-code":"268","alpha-2":"GE"},{name:"Ghana","alpha-3":"GHA","country-code":"288","alpha-2":"GH"},{name:"Greece","alpha-3":"GRC","country-code":"300","alpha-2":"GR"},{name:"Grenada","alpha-3":"GRD","country-code":"308","alpha-2":"GD"},{name:"Guadeloupe","alpha-3":"GLP","country-code":"312","alpha-2":"GP"},{name:"Guatemala","alpha-3":"GTM","country-code":"320","alpha-2":"GT"},{name:"Guinea","alpha-3":"GIN","country-code":"324","alpha-2":"GN"},{name:"Guyana","alpha-3":"GUY","country-code":"328","alpha-2":"GY"},{name:"Haiti","alpha-3":"HTI","country-code":"332","alpha-2":"HT"},{name:"Honduras","alpha-3":"HND","country-code":"340","alpha-2":"HN"},{name:"Hungary","alpha-3":"HUN","country-code":"348","alpha-2":"HU"},{name:"Iceland","alpha-3":"ISL","country-code":"352","alpha-2":"IS"},{name:"India","alpha-3":"IND","country-code":"356","alpha-2":"IN"},{name:"Indonesia","alpha-3":"IDN","country-code":"360","alpha-2":"ID"},{name:"Iraq","alpha-3":"IRQ","country-code":"368","alpha-2":"IQ"},{name:"Jamaica","alpha-3":"JAM","country-code":"388","alpha-2":"JM"},{name:"Japan","alpha-3":"JPN","country-code":"392","alpha-2":"JP"},{name:"Jordan","alpha-3":"JOR","country-code":"400","alpha-2":"JO"},{name:"Kazakhstan","alpha-3":"KAZ","country-code":"398","alpha-2":"KZ"},{name:"Kenya","alpha-3":"KEN","country-code":"404","alpha-2":"KE"},{name:"Kuwait","alpha-3":"KWT","country-code":"414","alpha-2":"KW"},{name:"Kyrgyzstan","alpha-3":"KGZ","country-code":"417","alpha-2":"KG"},{name:"Latvia","alpha-3":"LVA","country-code":"428","alpha-2":"LV"},{name:"Lebanon","alpha-3":"LBN","country-code":"422","alpha-2":"LB"},{name:"Lesotho","alpha-3":"LSO","country-code":"426","alpha-2":"LS"},{name:"Liberia","alpha-3":"LBR","country-code":"430","alpha-2":"LR"},{name:"Libya","alpha-3":"LBY","country-code":"434","alpha-2":"LY"},{name:"Liechtenstein","alpha-3":"LIE","country-code":"438","alpha-2":"LI"},{name:"Lithuania","alpha-3":"LTU","country-code":"440","alpha-2":"LT"},{name:"Luxembourg","alpha-3":"LUX","country-code":"442","alpha-2":"LU"},{name:"Macao","alpha-3":"MAC","country-code":"446","alpha-2":"MO"},{name:"Macedonia","alpha-3":"MKD","country-code":"807","alpha-2":"MK"},{name:"Madagascar","alpha-3":"MDG","country-code":"450","alpha-2":"MG"},{name:"Malawi","alpha-3":"MWI","country-code":"454","alpha-2":"MW"},{name:"Malaysia","alpha-3":"MYS","country-code":"458","alpha-2":"MY"},{name:"Maldives","alpha-3":"MDV","country-code":"462","alpha-2":"MV"},{name:"Mali","alpha-3":"MLI","country-code":"466","alpha-2":"ML"},{name:"Malta","alpha-3":"MLT","country-code":"470","alpha-2":"MT"},{name:"Mauritius","alpha-3":"MUS","country-code":"480","alpha-2":"MU"},{name:"Mayotte","alpha-3":"MYT","country-code":"175","alpha-2":"YT"},{name:"Moldova","alpha-3":"MDA","country-code":"498","alpha-2":"MD"},{name:"Monaco","alpha-3":"MCO","country-code":"492","alpha-2":"MC"},{name:"Mongolia","alpha-3":"MNG","country-code":"496","alpha-2":"MN"},{name:"Montenegro","alpha-3":"MNE","country-code":"499","alpha-2":"ME"},{name:"Montserrat","alpha-3":"MSR","country-code":"500","alpha-2":"MS"},{name:"Morocco","alpha-3":"MAR","country-code":"504","alpha-2":"MA"},{name:"Mozambique","alpha-3":"MOZ","country-code":"508","alpha-2":"MZ"},{name:"Myanmar","alpha-3":"MMR","country-code":"104","alpha-2":"MM"},{name:"Namibia","alpha-3":"NAM","country-code":"516","alpha-2":"NA"},{name:"Nepal","alpha-3":"NPL","country-code":"524","alpha-2":"NP"},{name:"New Zealand","alpha-3":"NZL","country-code":"554","alpha-2":"NZ"},{name:"Nicaragua","alpha-3":"NIC","country-code":"558","alpha-2":"NI"},{name:"Niger","alpha-3":"NER","country-code":"562","alpha-2":"NE"},{name:"Nigeria","alpha-3":"NGA","country-code":"566","alpha-2":"NG"},{name:"Oman","alpha-3":"OMN","country-code":"512","alpha-2":"OM"},{name:"Pakistan","alpha-3":"PAK","country-code":"586","alpha-2":"PK"},{name:"Palestine","alpha-3":"PSE","country-code":"275","alpha-2":"PS"},{name:"Panama","alpha-3":"PAN","country-code":"591","alpha-2":"PA"},{name:"Paraguay","alpha-3":"PRY","country-code":"600","alpha-2":"PY"},{name:"Peru","alpha-3":"PER","country-code":"604","alpha-2":"PE"},{name:"Philippines","alpha-3":"PHL","country-code":"608","alpha-2":"PH"},{name:"Puerto Rico","alpha-3":"PRI","country-code":"630","alpha-2":"PR"},{name:"Qatar","alpha-3":"QAT","country-code":"634","alpha-2":"QA"},{name:"Romania","alpha-3":"ROU","country-code":"642","alpha-2":"RO"},{name:"Rwanda","alpha-3":"RWA","country-code":"646","alpha-2":"RW"},{name:"Saint Kitts and Nevis","alpha-3":"KNA","country-code":"659","alpha-2":"KN"},{name:"Saint Lucia","alpha-3":"LCA","country-code":"662","alpha-2":"LC"},{name:"Saint Vincent and the Grenadines","alpha-3":"VCT","country-code":"670","alpha-2":"VC"},{name:"Saudi Arabia","alpha-3":"SAU","country-code":"682","alpha-2":"SA"},{name:"Senegal","alpha-3":"SEN","country-code":"686","alpha-2":"SN"},{name:"Serbia","alpha-3":"SRB","country-code":"688","alpha-2":"RS"},{name:"Sierra Leone","alpha-3":"SLE","country-code":"694","alpha-2":"SL"},{name:"Singapore","alpha-3":"SGP","country-code":"702","alpha-2":"SG"},{name:"Slovakia","alpha-3":"SVK","country-code":"703","alpha-2":"SK"},{name:"Slovenia","alpha-3":"SVN","country-code":"705","alpha-2":"SI"},{name:"South Sudan","alpha-3":"SSD","country-code":"728","alpha-2":"SS"},{name:"Sri Lanka","alpha-3":"LKA","country-code":"144","alpha-2":"LK"},{name:"Sudan","alpha-3":"SDN","country-code":"729","alpha-2":"SD"},{name:"Swaziland","alpha-3":"SWZ","country-code":"748","alpha-2":"SZ"},{name:"Tajikistan","alpha-3":"TJK","country-code":"762","alpha-2":"TJ"},{name:"Tanzania","alpha-3":"TZA","country-code":"834","alpha-2":"TZ"},{name:"Thailand","alpha-3":"THA","country-code":"764","alpha-2":"TH"},{name:"Togo","alpha-3":"TGO","country-code":"768","alpha-2":"TG"},{name:"Trinidad and Tobago","alpha-3":"TTO","country-code":"780","alpha-2":"TT"},{name:"Tunisia","alpha-3":"TUN","country-code":"788","alpha-2":"TN"},{name:"Turkmenistan","alpha-3":"TKM","country-code":"795","alpha-2":"TM"},{name:"Turks and Caicos Islands","alpha-3":"TCA","country-code":"796","alpha-2":"TC"},{name:"Uganda","alpha-3":"UGA","country-code":"800","alpha-2":"UG"},{name:"Ukraine","alpha-3":"UKR","country-code":"804","alpha-2":"UA"},{name:"United Arab Emirates","alpha-3":"ARE","country-code":"784","alpha-2":"AE"},{name:"Virgin Islands, US","alpha-3":"VIR","country-code":"850","alpha-2":"VI"},{name:"Uruguay","alpha-3":"URY","country-code":"858","alpha-2":"UY"},{name:"Uzbekistan","alpha-3":"UZB","country-code":"860","alpha-2":"UZ"},{name:"Venezuela","alpha-3":"VEN","country-code":"862","alpha-2":"VE"},{name:"Vietnam","alpha-3":"VNM","country-code":"704","alpha-2":"VN"},{name:"Zambia","alpha-3":"ZMB","country-code":"894","alpha-2":"ZM"},{name:"Zimbabwe","alpha-3":"ZWE","country-code":"716","alpha-2":"ZW"}],this.statesOfCanada={AB:"Alberta",BC:"British Columbia",MB:"Manitoba",NB:"New Brunswick",NL:"Newfoundland and Labrador",NS:"Nova Scotia",NT:"Northwest Territories",NU:"Nunavut",ON:"Ontario",PE:"Prince Edward Island",QC:"Quebec",SK:"Saskatchewan",YT:"Yukon"},this.statesOfAmerica={AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",AA:"Armed Forces America",AE:"Armed Forces",AP:"Armed Forces Pacific",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",GU:"Guam",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",PR:"Puerto Rico",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VI:"Virgin Islands",VA:"Virginia",WA:"Washington",DC:"Washington DC",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming"},this.countryToInternationalCallingCodeMapping={AD:"376",AE:"971",AF:"93",AG:"1268",AI:"1264",AL:"355",AM:"374",AN:"599",AO:"244",AQ:"672",AR:"54",AS:"1684",AT:"43",AU:"61",AW:"297",AZ:"994",BA:"387",BB:"1246",BD:"880",BE:"32",BF:"226",BG:"359",BH:"973",BI:"257",BJ:"229",BL:"590",BM:"1441",BN:"673",BO:"591",BR:"55",BS:"1242",BT:"975",BW:"267",BY:"375",BZ:"501",CA:"1",CC:"61",CD:"243",CF:"236",CG:"242",CH:"41",CI:"225",CK:"682",CL:"56",CM:"237",CN:"86",CO:"57",CR:"506",CU:"53",CV:"238",CX:"61",CY:"357",CZ:"420",DE:"49",DJ:"253",DK:"45",DM:"1767",DO:"1809",DZ:"213",EC:"593",EE:"372",EG:"20",ER:"291",ES:"34",ET:"251",FI:"358",FJ:"679",FK:"500",FM:"691",FO:"298",FR:"33",GA:"241",GB:"44",GD:"1473",GE:"995",GH:"233",GI:"350",GL:"299",GM:"220",GN:"224",GQ:"240",GR:"30",GT:"502",GU:"1671",GW:"245",GY:"592",HK:"852",HN:"504",HR:"385",HT:"509",HU:"36",ID:"62",IE:"353",IL:"972",IM:"44",IN:"91",IQ:"964",IR:"98",IS:"354",IT:"39",JM:"1876",JO:"962",JP:"81",KE:"254",KG:"996",KH:"855",KI:"686",KM:"269",KN:"1869",KP:"850",KR:"82",KW:"965",KY:"1345",KZ:"7",LA:"856",LB:"961",LC:"1758",LI:"423",LK:"94",LR:"231",LS:"266",LT:"370",LU:"352",LV:"371",LY:"218",MA:"212",MC:"377",MD:"373",ME:"382",MF:"1599",MG:"261",MH:"692",MK:"389",ML:"223",MM:"95",MN:"976",MO:"853",MP:"1670",MR:"222",MS:"1664",MT:"356",MU:"230",MV:"960",MW:"265",MX:"52",MY:"60",MZ:"258",NA:"264",NC:"687",NE:"227",NG:"234",NI:"505",NL:"31",NO:"47",NP:"977",NR:"674",NU:"683",NZ:"64",OM:"968",PA:"507",PE:"51",PF:"689",PG:"675",PH:"63",PK:"92",PL:"48",PM:"508",PN:"870",PR:"1",PT:"351",PW:"680",PY:"595",QA:"974",RO:"40",RS:"381",RU:"7",RW:"250",SA:"966",SB:"677",SC:"248",SD:"249",SE:"46",SG:"65",SH:"290",SI:"386",SK:"421",SL:"232",SM:"378",SN:"221",SO:"252",SR:"597",ST:"239",SV:"503",SY:"963",SZ:"268",TC:"1649",TD:"235",TG:"228",TH:"66",TJ:"992",TK:"690",TL:"670",TM:"993",TN:"216",TO:"676",TR:"90",TT:"1868",TV:"688",TW:"886",TZ:"255",UA:"380",UG:"256",US:"1",UY:"598",UZ:"998",VA:"39",VC:"1784",VE:"58",VG:"1284",VI:"1340",VN:"84",VU:"678",WF:"681",WS:"685",XK:"381",YE:"967",YT:"262",ZA:"27",ZM:"260",ZW:"263"},this.countryToLanguageMapping={ad:"ca",ae:"ar",af:"fa,ps",ag:"en",ai:"en",al:"sq",am:"hy",an:"nl,en",ao:"pt",ar:"es",as:"en,sm",at:"de",au:"en",aw:"nl,pap",ax:"sv",ba:"bs,hr,sr",bb:"en",bd:"bn",be:"nl,fr,de",bf:"fr",bh:"ar",bi:"fr",bj:"fr",bl:"fr",bm:"en",bn:"ms",bo:"es,qu,ay",br:"pt",bs:"en",bt:"dz",bv:"no",bw:"en,tn",by:"be,ru",bz:"en",ca:"en,fr",cc:"en",cd:"fr",cf:"fr",cg:"fr",ch:"de,fr,it,rm",ci:"fr",ck:"en,rar",cl:"es",cm:"fr,en",cn:"zh",co:"es",cr:"es",cu:"es",cv:"pt",cx:"en",cy:"el,tr",cz:"cs","// de":"de",dj:"fr,ar,so",dk:"da",dm:"en",do:"es",dz:"ar",ec:"es",ee:"et",eg:"ar",eh:"ar,es,fr",er:"ti,ar,en",es:"ast,ca,es,eu,gl",et:"am,om",fi:"fi,sv,se",fj:"en",fk:"en",fm:"en",ga:"fr",gb:"en,ga,cy,gd,kw",gd:"en",ge:"ka",gf:"fr",gg:"en",gh:"en",gi:"en",gl:"kl,da",gm:"en",gn:"fr",gp:"fr",gq:"es,fr,pt",gr:"el",gs:"en",gt:"es",gu:"en,ch",gw:"pt",gy:"en",hk:"zh,en",hm:"en",hn:"es",ht:"fr,ht",ie:"en,ga",il:"he",im:"en",in:"hi,en",io:"en",iq:"ar,ku",ir:"fa",it:"it,de,fr",je:"en",jm:"en",jo:"ar",jp:"ja",ke:"sw,en",kg:"ky,ru",kh:"km",ki:"en",km:"ar,fr",kn:"en",kp:"ko",kr:"ko,en",kw:"ar",ky:"en",kz:"kk,ru",la:"lo",lb:"ar,fr",lc:"en",li:"de",lk:"si,ta",lr:"en",ls:"en,st",lu:"lb,fr,de",ly:"ar",ma:"ar",mc:"fr",md:"ru,uk,ro",me:"srp,sq,bs,hr,sr",mf:"fr",mg:"mg,fr",mh:"en,mh",ml:"fr",mm:"my",mo:"zh,pt",mp:"ch",mq:"fr",mr:"ar,fr",ms:"en",mt:"mt,en",mu:"mfe,fr,en",mv:"dv",mw:"en,ny",mx:"es",my:"ms",mz:"pt",na:"en,sf,de",nc:"fr",ne:"fr",nf:"en,pih",ng:"en",ni:"es",no:"nb,nn,no,se",np:"ne",nr:"na,en",nu:"niu,en",nz:"mi,en",om:"ar",pa:"es",pe:"es",pf:"fr",pg:"en,tpi,ho",ph:"en,tl",pk:"en,ur",pm:"fr",pn:"en,pih",pr:"es,en",ps:"ar,he",pw:"en,pau,ja,sov,tox",py:"es,gn",qa:"ar",re:"fr",rs:"sr",rw:"rw,fr,en",sa:"ar",sb:"en",sc:"fr,en,crs",sd:"ar,en",se:"sv",sg:"en,ms,zh,ta",sh:"en",si:"sl",sj:"no",sl:"en",sm:"it",sn:"fr",so:"so,ar",sr:"nl",st:"pt",ss:"en",sv:"es",sy:"ar",sz:"en,ss",tc:"en",td:"fr,ar",tf:"fr",tg:"fr",tj:"tg,ru",tk:"tkl,en,sm",tl:"pt,tet",tm:"tk",tn:"ar",to:"en",tt:"en",tv:"en",tw:"zh",tz:"sw,en",ua:"uk",ug:"en,sw",um:"en",us:"en",uy:"es",uz:"uz,kaa",va:"it",vc:"en",ve:"es",vg:"en",vi:"en",vn:"vi",vu:"bi,en,fr",wf:"fr",ws:"sm,en",ye:"ar",yt:"fr",za:"zu,xh,af,st,tn,en",zm:"en",zw:"en,sn,nd "}}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.countryService||(win.rainbow.countryService=new CountryService),win.rainbow.countryService}start(){return __awaiter(this,void 0,void 0,(function*(){logger_service_1.default.info(""),logger_service_1.default.info("[countryService] === STARTING ==="),this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/";try{const availableCountries=yield this.getAvailableCountries();this.countries=availableCountries.map(country=>{const entry={name:country.fullname,"alpha-3":country.isoAlpha3Code,"alpha-2":country.isoAlpha2Code};return"FRA"===country.isoAlpha3Code&&(entry.default=!0),entry})}catch(error){logger_service_1.default.info("[countryService] === warning === "+error.message)}logger_service_1.default.info("[countryService] === STARTED  === "+this.countries.length+" countries"),logger_service_1.default.info("")}))}stop(){return __awaiter(this,void 0,void 0,(function*(){logger_service_1.default.info("[countryService] STOPPED")}))}getCountries(){const countries=this.countries.map(country=>{const label=this.getCountryLabel(country["alpha-2"]);if(label){const name=i18n_service_1.default.translate(label);name&&name!==label&&(country.name=name)}return country});return countries.sort((country1,country2)=>country1.name.localeCompare(country2.name,i18n_service_1.default.getCurrentLanguage())),countries}getCountryStates(country){return country&&"USA"===country["alpha-3"]?this.statesOfAmerica:country&&"CAN"===country["alpha-3"]?this.statesOfCanada:{}}getCountry(countryCode,defaulted=null){if(!countryCode)return defaulted?this.getDefaultCountry():null;const countries=this.countries.filter(country=>country["alpha-3"]===countryCode);return countries.length>0?countries[0]:null}getDefaultCountry(){const countries=this.countries.filter(country=>!0===country.default);return countries.length>0?countries[0]:this.countries[0]}getCountryName(countryCode){return this.getCountry(countryCode)?this.getCountry(countryCode).name:null}getCountryCode(country){return country?country["alpha-3"]:null}getStateName(country,state){return country&&state?"USA"===country?this.statesOfAmerica[state]:"CAN"===country?this.statesOfCanada[state]:"":""}getDefaultState(country){return country&&"USA"===country["alpha-3"]?"AL":country&&"CAN"===country["alpha-3"]?"AB":null}getAlpha2Code(alpha3Code){if(!alpha3Code)return null;const countries=this.countries.filter(country=>country["alpha-3"]===alpha3Code);return countries.length>0?countries[0]["alpha-2"]:null}getCountryLabel(alphaCode){let alpha2Code=null;return alpha2Code=3===alphaCode.length?this.getAlpha2Code(alphaCode):alphaCode,alpha2Code?"country"+alpha2Code:null}getDataCenterLabel(datacenterLocation,companyCountry){let label=this.getRegionLabel(datacenterLocation.name);if(datacenterLocation.country===companyCountry)label=this.getCountryLabel(datacenterLocation.country);else{const datacenter=this.datacenters.find(dc=>dc["alpha-3"]===datacenterLocation.country);datacenter&&(label=this.getRegionLabel(datacenter.region))}return label}getRegionLabel(regionName){return regionName}getInternationalCallingCode(countryAlpha2Code){if(!countryAlpha2Code)return;const countryCode=countryAlpha2Code.toUpperCase();return this.countryToInternationalCallingCodeMapping[countryCode]}mapCountryToLanguages(countryAlpha2Code){if(!countryAlpha2Code)return;const countryCode=countryAlpha2Code.toLowerCase();return void 0!==this.countryToLanguageMapping[countryCode]?this.countryToLanguageMapping[countryCode].split(","):[countryCode]}getAvailableCountries(){return __awaiter(this,void 0,void 0,(function*(){try{const response=yield fetch(this.portalURL+"/countries",{method:"GET",headers:auth_service_1.default.getRequestHeader()});if(!response.ok)throw response;return(yield response.json()).data}catch(error){const errorMessage=error.data?error.data.errorDetails||error.data.errorMsg:error.message;throw logger_service_1.default.error(`[countryService] getAvailableCountries failure -- ${errorMessage} - status ${error.status}`),new Error(errorMessage)}}))}}exports.CountryService=CountryService,exports.default=CountryService.getInstance()},function(module,exports){var g;g=function(){return this}();try{g=g||new Function("return this")()}catch(e){"object"==typeof window&&(g=window)}module.exports=g},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileDescriptor=exports.FileState=void 0;const BehaviorSubject_1=__webpack_require__(66),rxjs_1=__webpack_require__(10),_escape=__webpack_require__(59);class FileState{}exports.FileState=FileState,FileState.DELETED="deleted",FileState.UPLOADING="uploading",FileState.UPLOADED="uploaded",FileState.NOT_UPLOADED="not_uploaded",FileState.DOWNLOADING="downloading",FileState.NOT_DOWNLOADABLE="not_downloadable",FileState.UNKNOWN="unknown";class ThumbnailPlaceholder{constructor(icon,style,type){this.icon=icon,this.style=style,this.type=type}}class Thumbnail{constructor(data){data?(this.availableThumbnail=data.availableThumbnail,this.md5sum=data.md5sum,this.size=data.size,this.wantThumbnailDate=data.wantThumbnailDate):this.availableThumbnail=!1}isThumbnailAvailable(){return this.availableThumbnail}}class FileDescriptor{constructor(id=null,url=null,ownerId=null,fileName=null,extension=null,typeMIME=null,size=null,registrationDate=null,uploadedDate=null,dateToSort=null,viewers=null,state=null,thumbnail=null,orientation=0,original_w=0,original_h=0,tags=null,virusScanState=null,voiceMessage=!1){this.id=id,this.url=url,this.ownerId=ownerId,this.fileName=fileName,this.extension=extension,this.typeMIME=typeMIME,this.thumbnailPlaceholder=this.getThumbnailPlaceholderFromMimetype(typeMIME),this.size=size,this.registrationDate=registrationDate,this.uploadedDate=uploadedDate,this.dateToSort=dateToSort,this.viewers=viewers,this.state=state,this.stateSubject=new BehaviorSubject_1.BehaviorSubject(this.state),this.thumbnail=new Thumbnail(thumbnail),this.fileToSend=void 0,this.previewBlob=void 0,this.previewBlobSubject=new BehaviorSubject_1.BehaviorSubject(this.previewBlob),this.blobOrientation=void 0,this.blobOrientationSubject=new BehaviorSubject_1.BehaviorSubject(this.blobOrientation),this.previewDownloaded=!1,this.tags=tags,this.orientation=orientation||void 0,this.virusScanState=virusScanState,this.original_w=original_w||0,this.original_h=original_h||0,this.voiceMessage=voiceMessage,this.time=this.getDate().getTime(),this.progressSubject=new rxjs_1.Subject,this.loadingRef=0}static create(id,url,ownerId,fileName,extension,typeMIME,size,registrationDate,uploadedDate,dateToSort,viewers,state,thumbnail,orientation,original_w,original_h,tags,virusScanState,voiceMessage){return new FileDescriptor(id,url,ownerId,fileName,extension,typeMIME,size,registrationDate,uploadedDate,dateToSort,viewers,state,thumbnail,orientation,original_w,original_h,tags,virusScanState,voiceMessage)}isMicrosoftFile(){return["docx","doc","ppt","pptx","xls","xlsx"].some(ext=>ext===this.extension)}isThumbnailPossible(){return this.isImage()||this.isPDF()}isPDF(){return"application/pdf"===this.typeMIME}isSVG(){return"svg"===this.extension}isImage(){return this.typeMIME&&this.typeMIME.length>="image/".length&&"image/"===this.typeMIME.slice(0,"image/".length)}isAudioVideo(){return["avi","mpg","wma","mp3","wmv","mkv","mov","wav","ogg","mp4","aac"].some(ext=>ext===this.extension)}isUploaded(){return this.state&&this.state===FileState.UPLOADED}isAlreadyFileViewer(viewerId){return!(!this.ownerId||this.ownerId!==viewerId)||!!this.viewers&&this.viewers.some(viewer=>viewer.viewerId===viewerId)}getDisplayName(){return this.fileName.replace(/\.[^/.]+$/,"")}getDisplayNameTruncated(){const str=this.fileName.replace(/\.[^/.]+$/,"");return[_escape(str.substring(0,str.length-4)),_escape(str.slice(-4))]}getExtension(){return this.fileName.toUpperCase()===this.extension.toUpperCase()?"":"."+this.extension}getDuration(){return this.tags&&this.tags.duration?Math.floor(this.tags.duration):0}getThumbnailPlaceholderFromMimetype(mime){return mime?"image/vnd.adobe.photoshop"===mime||"image/photoshop"===mime||"image/x-photoshop"===mime||"image/psd"===mime||"application/photoshop"===mime||"application/psd"===mime?new ThumbnailPlaceholder("psd-type","psdStyle","psd"):0===mime.indexOf("image")?new ThumbnailPlaceholder("image-type","imageStyle","image"):"application/msword"===mime||/^application\/vnd.openxmlformats-officedocument.wordprocessingml.*$/.test(mime)||"application/vnd.oasis.opendocument.text"===mime?new ThumbnailPlaceholder("document-type","docStyle","doc"):/^application\/vnd.ms-powerpoint.*$/.test(mime)||/^application\/vnd.openxmlformats-officedocument.presentationml.*$/.test(mime)||"application/vnd.oasis.opendocument.presentation"===mime?new ThumbnailPlaceholder("powerpoint-type","pptStyle","ppt"):0===mime.indexOf("application/vnd.ms-excel")||/^application\/vnd.openxmlformats-officedocument.spreadsheetml.*$/.test(mime)?new ThumbnailPlaceholder("excel-type","xlsStyle","xls"):"application/pdf"===mime||"application/vnd.oasis.opendocument.spreadsheet"===mime?new ThumbnailPlaceholder("pdf-type","pdfStyle","pdf"):0===mime.indexOf("video/")?new ThumbnailPlaceholder("video-type","videoStyle","video"):0===mime.indexOf("audio/")?new ThumbnailPlaceholder("audio-type","audioStyle","audio"):"text/plain"===mime?new ThumbnailPlaceholder("txt-type","txtStyle","txt"):"application/zip"===mime||"application/x-rar-compressed"===mime||"application/x-7z-compressed"===mime||"application/x-tar"===mime?new ThumbnailPlaceholder("archive-type","archiveStyle","archive"):"application/illustrator"===mime||0===mime.indexOf("application/postscript")?new ThumbnailPlaceholder("ai-type","aiStyle","ai"):"text/css"===mime||"text/html"===mime||"application/javascript"===mime||"application/json"===mime||"application/typescript"===mime||"application/xml"===mime?new ThumbnailPlaceholder("code-type","codeStyle","code"):new ThumbnailPlaceholder("unknown-type","otherStyle","other"):new ThumbnailPlaceholder("unknown-type","otherStyle","other")}releaseURL(){this.localURL=void 0}setState(newState){this.state=newState,this.stateSubject.next(this.state)}setOriginalImageDimensions(width,height){this.original_w=width,this.original_h=height}update(fd){this.id=fd.id,this.url=fd.url,this.ownerId=fd.ownerId,this.fileName=fd.fileName,this.extension=fd.extension,this.typeMIME=fd.typeMIME,this.size=fd.size,this.registrationDate=fd.registrationDate,this.uploadedDate=fd.uploadedDate,this.dateToSort=fd.dateToSort,this.viewers=fd.viewers,this.setState(fd.state),this.thumbnail=fd.thumbnail,this.orientation=fd.orientation,this.time=this.getDate().getTime()}getDate(){return this.uploadedDate?new Date(this.uploadedDate):this.registrationDate?new Date(this.registrationDate):new Date(this.dateToSort)}refreshFilePercent(){let chunkPercentTotal=0;this.chunkPercentArray.forEach(chunkPercent=>{chunkPercentTotal+=chunkPercent}),this.chunkPerformedPercent=Math.floor(chunkPercentTotal/this.chunkTotalNumber)}updateProgressInfo(){this.refreshFilePercent(),this.progressSubject.next({})}isInfected(){return"isInfected"===this.virusScanState}}exports.FileDescriptor=FileDescriptor},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Subject_1=__webpack_require__(67),ObjectUnsubscribedError_1=__webpack_require__(70),BehaviorSubject=function(_super){function BehaviorSubject(_value){var _this=_super.call(this)||this;return _this._value=_value,_this}return __extends(BehaviorSubject,_super),Object.defineProperty(BehaviorSubject.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),BehaviorSubject.prototype._subscribe=function(subscriber){var subscription=_super.prototype._subscribe.call(this,subscriber);return subscription&&!subscription.closed&&subscriber.next(this._value),subscription},BehaviorSubject.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;return this._value},BehaviorSubject.prototype.next=function(value){_super.prototype.next.call(this,this._value=value)},BehaviorSubject}(Subject_1.Subject);exports.BehaviorSubject=BehaviorSubject},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=__webpack_require__(54),Subscriber_1=__webpack_require__(55),Subscription_1=__webpack_require__(45),ObjectUnsubscribedError_1=__webpack_require__(70),SubjectSubscription_1=__webpack_require__(81),rxSubscriber_1=__webpack_require__(69),SubjectSubscriber=function(_super){function SubjectSubscriber(destination){var _this=_super.call(this,destination)||this;return _this.destination=destination,_this}return __extends(SubjectSubscriber,_super),SubjectSubscriber}(Subscriber_1.Subscriber);exports.SubjectSubscriber=SubjectSubscriber;var Subject=function(_super){function Subject(){var _this=_super.call(this)||this;return _this.observers=[],_this.closed=!1,_this.isStopped=!1,_this.hasError=!1,_this.thrownError=null,_this}return __extends(Subject,_super),Subject.prototype[rxSubscriber_1.rxSubscriber]=function(){return new SubjectSubscriber(this)},Subject.prototype.lift=function(operator){var subject=new AnonymousSubject(this,this);return subject.operator=operator,subject},Subject.prototype.next=function(value){if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;if(!this.isStopped)for(var observers=this.observers,len=observers.length,copy=observers.slice(),i=0;i<len;i++)copy[i].next(value)},Subject.prototype.error=function(err){if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;this.hasError=!0,this.thrownError=err,this.isStopped=!0;for(var observers=this.observers,len=observers.length,copy=observers.slice(),i=0;i<len;i++)copy[i].error(err);this.observers.length=0},Subject.prototype.complete=function(){if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;this.isStopped=!0;for(var observers=this.observers,len=observers.length,copy=observers.slice(),i=0;i<len;i++)copy[i].complete();this.observers.length=0},Subject.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},Subject.prototype._trySubscribe=function(subscriber){if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;return _super.prototype._trySubscribe.call(this,subscriber)},Subject.prototype._subscribe=function(subscriber){if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;return this.hasError?(subscriber.error(this.thrownError),Subscription_1.Subscription.EMPTY):this.isStopped?(subscriber.complete(),Subscription_1.Subscription.EMPTY):(this.observers.push(subscriber),new SubjectSubscription_1.SubjectSubscription(this,subscriber))},Subject.prototype.asObservable=function(){var observable=new Observable_1.Observable;return observable.source=this,observable},Subject.create=function(destination,source){return new AnonymousSubject(destination,source)},Subject}(Observable_1.Observable);exports.Subject=Subject;var AnonymousSubject=function(_super){function AnonymousSubject(destination,source){var _this=_super.call(this)||this;return _this.destination=destination,_this.source=source,_this}return __extends(AnonymousSubject,_super),AnonymousSubject.prototype.next=function(value){var destination=this.destination;destination&&destination.next&&destination.next(value)},AnonymousSubject.prototype.error=function(err){var destination=this.destination;destination&&destination.error&&this.destination.error(err)},AnonymousSubject.prototype.complete=function(){var destination=this.destination;destination&&destination.complete&&this.destination.complete()},AnonymousSubject.prototype._subscribe=function(subscriber){return this.source?this.source.subscribe(subscriber):Subscription_1.Subscription.EMPTY},AnonymousSubject}(Subject);exports.AnonymousSubject=AnonymousSubject},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _enable_super_gross_mode_that_will_cause_bad_things=!1;exports.config={Promise:void 0,set useDeprecatedSynchronousErrorHandling(value){if(value){var error=new Error;console.warn("DEPRECATED! RxJS was set to use deprecated synchronous error handling behavior by code at: \n"+error.stack)}else _enable_super_gross_mode_that_will_cause_bad_things&&console.log("RxJS: Back to a better error behavior. Thank you. <3");_enable_super_gross_mode_that_will_cause_bad_things=value},get useDeprecatedSynchronousErrorHandling(){return _enable_super_gross_mode_that_will_cause_bad_things}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.rxSubscriber="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random(),exports.$$rxSubscriber=exports.rxSubscriber},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ObjectUnsubscribedErrorImpl=function(){function ObjectUnsubscribedErrorImpl(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return ObjectUnsubscribedErrorImpl.prototype=Object.create(Error.prototype),ObjectUnsubscribedErrorImpl}();exports.ObjectUnsubscribedError=ObjectUnsubscribedErrorImpl},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileViewer=void 0;class FileViewerType{}FileViewerType.USER="user",FileViewerType.ROOM="room";class FileViewer{constructor(viewerId,type){this.viewerId=null,this.type=null,this.contact=null,this.room=null,this.channel=null,this.viewerId=viewerId,this.type=type}static createFromData(data){return data.map(viewerData=>new FileViewer(viewerData.viewerId,viewerData.type))}}exports.FileViewer=FileViewer},function(module,exports,__webpack_require__){var C,C_lib,WordArray,Hasher,C_algo,W,SHA1,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),C_lib=(C=CryptoJS).lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,W=[],SHA1=C_algo.SHA1=Hasher.extend({_doReset:function(){this._hash=new WordArray.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],i=0;i<80;i++){if(i<16)W[i]=0|M[offset+i];else{var n=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=n<<1|n>>>31}var t=(a<<5|a>>>27)+e+W[i];t+=i<20?1518500249+(b&c|~b&d):i<40?1859775393+(b^c^d):i<60?(b&c|b&d|c&d)-1894007588:(b^c^d)-899497514,e=d,d=c,c=b<<30|b>>>2,b=a,a=t}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}}),C.SHA1=Hasher._createHelper(SHA1),C.HmacSHA1=Hasher._createHmacHelper(SHA1),CryptoJS.SHA1)},function(module,exports,__webpack_require__){var CryptoJS,C,Base,Utf8;module.exports=(CryptoJS=__webpack_require__(12),Base=(C=CryptoJS).lib.Base,Utf8=C.enc.Utf8,void(C.algo.HMAC=Base.extend({init:function(hasher,key){hasher=this._hasher=new hasher.init,"string"==typeof key&&(key=Utf8.parse(key));var hasherBlockSize=hasher.blockSize,hasherBlockSizeBytes=4*hasherBlockSize;key.sigBytes>hasherBlockSizeBytes&&(key=hasher.finalize(key)),key.clamp();for(var oKey=this._oKey=key.clone(),iKey=this._iKey=key.clone(),oKeyWords=oKey.words,iKeyWords=iKey.words,i=0;i<hasherBlockSize;i++)oKeyWords[i]^=1549556828,iKeyWords[i]^=909522486;oKey.sigBytes=iKey.sigBytes=hasherBlockSizeBytes,this.reset()},reset:function(){var hasher=this._hasher;hasher.reset(),hasher.update(this._iKey)},update:function(messageUpdate){return this._hasher.update(messageUpdate),this},finalize:function(messageUpdate){var hasher=this._hasher,innerHash=hasher.finalize(messageUpdate);return hasher.reset(),hasher.finalize(this._oKey.clone().concat(innerHash))}})))},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getBinaryData=exports.resizeImage=void 0,exports.resizeImage=function(avatarImg,maxWidth,maxHeight){return new Promise(resolve=>{const image=new Image;image.onload=()=>{let imageWidth=image.width,imageHeight=image.height;imageWidth>imageHeight?imageWidth>maxWidth&&(imageHeight*=maxWidth/imageWidth,imageWidth=maxWidth):imageHeight>maxHeight&&(imageWidth*=maxHeight/imageHeight,imageHeight=maxHeight);const canvas=document.createElement("canvas");canvas.width=imageWidth,canvas.height=imageHeight,image.width=imageWidth,image.height=imageHeight,image.crossOrigin="Anonymous";canvas.getContext("2d").drawImage(image,0,0,imageWidth,imageHeight);const resizedImage=new Image;resizedImage.src=canvas.toDataURL("image/png"),resolve(resizedImage)},image.src=avatarImg})},exports.getBinaryData=function(image){const typeIndex=image.src.indexOf("image/")+6,binaryIndex=image.src.indexOf(";base64,"),binaryData=image.src.slice(binaryIndex+8),imageType=image.src.slice(typeIndex,binaryIndex),binaryString=window.atob(binaryData),len=binaryString.length,bytes=new Uint8Array(len);for(let i=0;i<len;i++)bytes[i]=binaryString.charCodeAt(i);return{type:imageType,data:bytes}}},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Subscriber_1=__webpack_require__(55);exports.distinctUntilChanged=function(compare,keySelector){return function(source){return source.lift(new DistinctUntilChangedOperator(compare,keySelector))}};var DistinctUntilChangedOperator=function(){function DistinctUntilChangedOperator(compare,keySelector){this.compare=compare,this.keySelector=keySelector}return DistinctUntilChangedOperator.prototype.call=function(subscriber,source){return source.subscribe(new DistinctUntilChangedSubscriber(subscriber,this.compare,this.keySelector))},DistinctUntilChangedOperator}(),DistinctUntilChangedSubscriber=function(_super){function DistinctUntilChangedSubscriber(destination,compare,keySelector){var _this=_super.call(this,destination)||this;return _this.keySelector=keySelector,_this.hasKey=!1,"function"==typeof compare&&(_this.compare=compare),_this}return __extends(DistinctUntilChangedSubscriber,_super),DistinctUntilChangedSubscriber.prototype.compare=function(x,y){return x===y},DistinctUntilChangedSubscriber.prototype._next=function(value){var key;try{var keySelector=this.keySelector;key=keySelector?keySelector(value):value}catch(err){return this.destination.error(err)}var result=!1;if(this.hasKey)try{result=(0,this.compare)(this.key,key)}catch(err){return this.destination.error(err)}else this.hasKey=!0;result||(this.key=key,this.destination.next(value))},DistinctUntilChangedSubscriber}(Subscriber_1.Subscriber)},function(module,exports,__webpack_require__){var factory;window,factory=function(){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s="./src/strophe.js")}({"./node_modules/webpack/buildin/global.js":
/*!***********************************!*\
  !*** (webpack)/buildin/global.js ***!
  \***********************************/
/*! no static exports found */function(module,exports){var g;g=function(){return this}();try{g=g||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(g=window)}module.exports=g},"./src/bosh.js":
/*!*********************!*\
  !*** ./src/bosh.js ***!
  \*********************/
/*! no exports provided */function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var core__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(/*! core */"./src/core.js"),Strophe=core__WEBPACK_IMPORTED_MODULE_0__.default.Strophe,$build=core__WEBPACK_IMPORTED_MODULE_0__.default.$build;Strophe.Request=function(elem,func,rid,sends){this.id=++Strophe._requestId,this.xmlData=elem,this.data=Strophe.serialize(elem),this.origFunc=func,this.func=func,this.rid=rid,this.date=NaN,this.sends=sends||0,this.abort=!1,this.dead=null,this.age=function(){return this.date?(new Date-this.date)/1e3:0},this.timeDead=function(){return this.dead?(new Date-this.dead)/1e3:0},this.xhr=this._newXHR()},Strophe.Request.prototype={getResponse:function(){var node=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if("parsererror"===(node=this.xhr.responseXML.documentElement).tagName)throw Strophe.error("invalid response received"),Strophe.error("responseText: "+this.xhr.responseText),Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML)),new Error("parsererror")}else if(this.xhr.responseText){if(Strophe.debug("Got responseText but no responseXML; attempting to parse it with DOMParser..."),!(node=(new DOMParser).parseFromString(this.xhr.responseText,"application/xml").documentElement))throw new Error("Parsing produced null node");if(node.querySelector("parsererror")){Strophe.error("invalid response received: "+node.querySelector("parsererror").textContent),Strophe.error("responseText: "+this.xhr.responseText);var error=new Error;throw error.name=Strophe.ErrorCondition.BAD_FORMAT,error}}return node},_newXHR:function(){var xhr=null;return window.XMLHttpRequest?(xhr=new XMLHttpRequest).overrideMimeType&&xhr.overrideMimeType("text/xml; charset=utf-8"):window.ActiveXObject&&(xhr=new ActiveXObject("Microsoft.XMLHTTP")),xhr.onreadystatechange=this.func.bind(null,this),xhr}},Strophe.Bosh=function(connection){this._conn=connection,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.hold=1,this.wait=60,this.window=5,this.errors=0,this.inactivity=null,this.lastResponseHeaders=null,this._requests=[]},Strophe.Bosh.prototype={strip:null,_buildBody:function(){var bodyWrap=$build("body",{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});return null!==this.sid&&bodyWrap.attrs({sid:this.sid}),this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession(),bodyWrap},_reset:function(){this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.errors=0,this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_connect:function(wait,hold,route){this.wait=wait||this.wait,this.hold=hold||this.hold,this.errors=0;var body=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});route&&body.attrs({route:route});var _connect_cb=this._conn._connect_cb;this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,_connect_cb.bind(this._conn)),body.tree().getAttribute("rid"))),this._throttledRequestHandler()},_attach:function(jid,sid,rid,callback,wait,hold,wind){this._conn.jid=jid,this.sid=sid,this.rid=rid,this._conn.connect_callback=callback,this._conn.domain=Strophe.getDomainFromJid(this._conn.jid),this._conn.authenticated=!0,this._conn.connected=!0,this.wait=wait||this.wait,this.hold=hold||this.hold,this.window=wind||this.window,this._conn._changeConnectStatus(Strophe.Status.ATTACHED,null)},_restore:function(jid,callback,wait,hold,wind){var session=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(!(null!=session&&session.rid&&session.sid&&session.jid&&(null==jid||Strophe.getBareJidFromJid(session.jid)===Strophe.getBareJidFromJid(jid)||null===Strophe.getNodeFromJid(jid)&&Strophe.getDomainFromJid(session.jid)===jid))){var error=new Error("_restore: no restoreable session.");throw error.name="StropheSessionError",error}this._conn.restored=!0,this._attach(session.jid,session.sid,session.rid,callback,wait,hold,wind)},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_connect_cb:function(bodyWrap){var typ=bodyWrap.getAttribute("type");if(null!==typ&&"terminate"===typ){var cond=bodyWrap.getAttribute("condition");Strophe.error("BOSH-Connection failed: "+cond);var conflict=bodyWrap.getElementsByTagName("conflict");return null!==cond?("remote-stream-error"===cond&&conflict.length>0&&(cond="conflict"),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,cond)):this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(cond),Strophe.Status.CONNFAIL}this.sid||(this.sid=bodyWrap.getAttribute("sid"));var wind=bodyWrap.getAttribute("requests");wind&&(this.window=parseInt(wind,10));var hold=bodyWrap.getAttribute("hold");hold&&(this.hold=parseInt(hold,10));var wait=bodyWrap.getAttribute("wait");wait&&(this.wait=parseInt(wait,10));var inactivity=bodyWrap.getAttribute("inactivity");inactivity&&(this.inactivity=parseInt(inactivity,10))},_disconnect:function(pres){this._sendTerminate(pres)},_doDisconnect:function(){this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session"),this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},_callProtocolErrorHandlers:function(req){var reqStatus=this._getRequestStatus(req),err_callback=this._conn.protocolErrorHandlers.HTTP[reqStatus];err_callback&&err_callback.call(this,reqStatus)},_hitError:function(reqStatus){this.errors++,Strophe.warn("request errored, status: "+reqStatus+", number of errors: "+this.errors),this.errors>4&&this._conn._onDisconnectTimeout()},_no_auth_received:function(callback){Strophe.warn("Server did not yet offer a supported authentication mechanism. Sending a blank poll request."),callback=callback?callback.bind(this._conn):this._conn._connect_cb.bind(this._conn);var body=this._buildBody();this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,callback),body.tree().getAttribute("rid"))),this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(;this._requests.length>0;){var req=this._requests.pop();req.abort=!0,req.xhr.abort(),req.xhr.onreadystatechange=function(){}}},_onIdle:function(){var data=this._conn._data;if(this._conn.authenticated&&0===this._requests.length&&0===data.length&&!this._conn.disconnecting&&(Strophe.info("no requests during idle cycle, sending blank request"),data.push(null)),!this._conn.paused){if(this._requests.length<2&&data.length>0){for(var body=this._buildBody(),i=0;i<data.length;i++)null!==data[i]&&("restart"===data[i]?body.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH}):body.cnode(data[i]).up());delete this._conn._data,this._conn._data=[],this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),body.tree().getAttribute("rid"))),this._throttledRequestHandler()}if(this._requests.length>0){var time_elapsed=this._requests[0].age();null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait)&&(Strophe.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler())}}},_getRequestStatus:function(req,def){var reqStatus;if(4===req.xhr.readyState)try{reqStatus=req.xhr.status}catch(e){Strophe.error("Caught an error while retrieving a request's status, reqStatus: "+reqStatus)}return void 0===reqStatus&&(reqStatus="number"==typeof def?def:0),reqStatus},_onRequestStateChange:function(func,req){if(Strophe.debug("request id "+req.id+"."+req.sends+" state changed to "+req.xhr.readyState),req.abort)req.abort=!1;else if(4===req.xhr.readyState){var reqStatus=this._getRequestStatus(req);if(this.lastResponseHeaders=req.xhr.getAllResponseHeaders(),this.disconnecting&&reqStatus>=400)return this._hitError(reqStatus),void this._callProtocolErrorHandlers(req);var valid_request=reqStatus>0&&reqStatus<500,too_many_retries=req.sends>this._conn.maxRetries;if((valid_request||too_many_retries)&&(this._removeRequest(req),Strophe.debug("request id "+req.id+" should now be removed")),200===reqStatus){var reqIs0=this._requests[0]===req;(this._requests[1]===req||reqIs0&&this._requests.length>0&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(req.rid)+1),Strophe.debug("request id "+req.id+"."+req.sends+" got 200"),func(req),this.errors=0}else 0===reqStatus||reqStatus>=400&&reqStatus<600||reqStatus>=12e3?(Strophe.error("request id "+req.id+"."+req.sends+" error "+reqStatus+" happened"),this._hitError(reqStatus),this._callProtocolErrorHandlers(req),reqStatus>=400&&reqStatus<500&&(this._conn._changeConnectStatus(Strophe.Status.DISCONNECTING,null),this._conn._doDisconnect())):Strophe.error("request id "+req.id+"."+req.sends+" error "+reqStatus+" happened");valid_request||too_many_retries?too_many_retries&&!this._conn.connected&&this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"giving-up"):this._throttledRequestHandler()}},_processRequest:function(i){var _this=this,req=this._requests[i],reqStatus=this._getRequestStatus(req,-1);if(req.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var time_elapsed=req.age(),primary_timeout=!isNaN(time_elapsed)&&time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait),secondary_timeout=null!==req.dead&&req.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait),server_error=4===req.xhr.readyState&&(reqStatus<1||reqStatus>=500);if((primary_timeout||secondary_timeout||server_error)&&(secondary_timeout&&Strophe.error("Request ".concat(this._requests[i].id," timed out (secondary), restarting")),req.abort=!0,req.xhr.abort(),req.xhr.onreadystatechange=function(){},this._requests[i]=new Strophe.Request(req.xmlData,req.origFunc,req.rid,req.sends),req=this._requests[i]),0===req.xhr.readyState){Strophe.debug("request id "+req.id+"."+req.sends+" posting");try{var content_type=this._conn.options.contentType||"text/xml; charset=utf-8";req.xhr.open("POST",this._conn.service,!this._conn.options.sync),void 0!==req.xhr.setRequestHeader&&req.xhr.setRequestHeader("Content-Type",content_type),this._conn.options.withCredentials&&(req.xhr.withCredentials=!0)}catch(e2){return Strophe.error("XHR open failed: "+e2.toString()),this._conn.connected||this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-service"),void this._conn.disconnect()}var sendFunc=function(){if(req.date=new Date,_this._conn.options.customHeaders){var headers=_this._conn.options.customHeaders;for(var header in headers)Object.prototype.hasOwnProperty.call(headers,header)&&req.xhr.setRequestHeader(header,headers[header])}req.xhr.send(req.data)};if(req.sends>1){var backoff=1e3*Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(req.sends,3));setTimeout((function(){sendFunc()}),backoff)}else sendFunc();req.sends++,this._conn.xmlOutput!==Strophe.Connection.prototype.xmlOutput&&(req.xmlData.nodeName===this.strip&&req.xmlData.childNodes.length?this._conn.xmlOutput(req.xmlData.childNodes[0]):this._conn.xmlOutput(req.xmlData)),this._conn.rawOutput!==Strophe.Connection.prototype.rawOutput&&this._conn.rawOutput(req.data)}else Strophe.debug("_processRequest: "+(0===i?"first":"second")+" request has readyState of "+req.xhr.readyState)}},_removeRequest:function(req){Strophe.debug("removing request");for(var i=this._requests.length-1;i>=0;i--)req===this._requests[i]&&this._requests.splice(i,1);req.xhr.onreadystatechange=function(){},this._throttledRequestHandler()},_restartRequest:function(i){var req=this._requests[i];null===req.dead&&(req.dead=new Date),this._processRequest(i)},_reqToData:function(req){try{return req.getResponse()}catch(e){if("parsererror"!==e.message)throw e;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(pres){Strophe.info("_sendTerminate was called");var body=this._buildBody().attrs({type:"terminate"});pres&&body.cnode(pres.tree());var req=new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),body.tree().getAttribute("rid"));this._requests.push(req),this._throttledRequestHandler()},_send:function(){var _this2=this;clearTimeout(this._conn._idleTimeout),this._throttledRequestHandler(),this._conn._idleTimeout=setTimeout((function(){return _this2._conn._onIdle()}),100)},_sendRestart:function(){this._throttledRequestHandler(),clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?Strophe.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):Strophe.debug("_throttledRequestHandler called with undefined requests"),this._requests&&0!==this._requests.length&&(this._requests.length>0&&this._processRequest(0),this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}}},"./src/core.js":
/*!*********************!*\
  !*** ./src/core.js ***!
  \*********************/
/*! exports provided: Strophe, $build, $iq, $msg, $pres, SHA1, MD5, default */function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Strophe",(function(){return Strophe})),__webpack_require__.d(__webpack_exports__,"$build",(function(){return $build})),__webpack_require__.d(__webpack_exports__,"$iq",(function(){return $iq})),__webpack_require__.d(__webpack_exports__,"$msg",(function(){return $msg})),__webpack_require__.d(__webpack_exports__,"$pres",(function(){return $pres}));var md5__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(/*! md5 */"./src/md5.js");__webpack_require__.d(__webpack_exports__,"MD5",(function(){return md5__WEBPACK_IMPORTED_MODULE_0__.default}));var sha1__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(/*! sha1 */"./src/sha1.js");__webpack_require__.d(__webpack_exports__,"SHA1",(function(){return sha1__WEBPACK_IMPORTED_MODULE_1__.default}));var utils__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(/*! utils */"./src/utils.js");function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}}(arr)||function(iter){if(Symbol.iterator in Object(iter)||"[object Arguments]"===Object.prototype.toString.call(iter))return Array.from(iter)}(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function $build(name,attrs){return new Strophe.Builder(name,attrs)}function $msg(attrs){return new Strophe.Builder("message",attrs)}function $iq(attrs){return new Strophe.Builder("iq",attrs)}function $pres(attrs){return new Strophe.Builder("presence",attrs)}var Strophe={VERSION:"1.3.1",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(tag){for(var i=0;i<Strophe.XHTML.tags.length;i++)if(tag===Strophe.XHTML.tags[i])return!0;return!1},validAttribute:function(tag,attribute){if(void 0!==Strophe.XHTML.attributes[tag]&&Strophe.XHTML.attributes[tag].length>0)for(var i=0;i<Strophe.XHTML.attributes[tag].length;i++)if(attribute===Strophe.XHTML.attributes[tag][i])return!0;return!1},validCSS:function(style){for(var i=0;i<Strophe.XHTML.css.length;i++)if(style===Strophe.XHTML.css[i])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},ErrorCondition:{BAD_FORMAT:"bad-format",CONFLICT:"conflict",MISSING_JID_NODE:"x-strophe-bad-non-anon-jid",NO_AUTH_MECH:"no-auth-mech",UNKNOWN_REASON:"unknown"},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace:function(name,value){Strophe.NS[name]=value},forEachChild:function(elem,elemName,func){for(var i=0;i<elem.childNodes.length;i++){var childNode=elem.childNodes[i];childNode.nodeType!==Strophe.ElementType.NORMAL||elemName&&!this.isTagEqual(childNode,elemName)||func(childNode)}},isTagEqual:function(el,name){return el.tagName===name},_xmlGenerator:null,_makeGenerator:function(){var doc;return void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&document.documentMode<10?(doc=this._getIEXmlDom()).appendChild(doc.createElement("strophe")):doc=document.implementation.createDocument("jabber:client","strophe",null),doc},xmlGenerator:function(){return Strophe._xmlGenerator||(Strophe._xmlGenerator=Strophe._makeGenerator()),Strophe._xmlGenerator},_getIEXmlDom:function(){for(var doc=null,docStrings=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],d=0;d<docStrings.length&&null===doc;d++)try{doc=new ActiveXObject(docStrings[d])}catch(e){doc=null}return doc},xmlElement:function(name){if(!name)return null;for(var node=Strophe.xmlGenerator().createElement(name),a=1;a<arguments.length;a++){var arg=arguments[a];if(arg)if("string"==typeof arg||"number"==typeof arg)node.appendChild(Strophe.xmlTextNode(arg));else if("object"===_typeof(arg)&&"function"==typeof arg.sort)for(var i=0;i<arg.length;i++){var attr=arg[i];"object"===_typeof(attr)&&"function"==typeof attr.sort&&void 0!==attr[1]&&null!==attr[1]&&node.setAttribute(attr[0],attr[1])}else if("object"===_typeof(arg))for(var k in arg)Object.prototype.hasOwnProperty.call(arg,k)&&void 0!==arg[k]&&null!==arg[k]&&node.setAttribute(k,arg[k])}return node},xmlescape:function(text){return text=(text=(text=(text=(text=text.replace(/\&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/"/g,"&quot;")},xmlunescape:function(text){return text=(text=(text=(text=(text=text.replace(/\&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&apos;/g,"'")).replace(/&quot;/g,'"')},xmlTextNode:function(text){return Strophe.xmlGenerator().createTextNode(text)},xmlHtmlNode:function(html){var node;return DOMParser?node=(new DOMParser).parseFromString(html,"text/xml"):((node=new ActiveXObject("Microsoft.XMLDOM")).async="false",node.loadXML(html)),node},getText:function(elem){if(!elem)return null;var str="";0===elem.childNodes.length&&elem.nodeType===Strophe.ElementType.TEXT&&(str+=elem.nodeValue);for(var i=0;i<elem.childNodes.length;i++)elem.childNodes[i].nodeType===Strophe.ElementType.TEXT&&(str+=elem.childNodes[i].nodeValue);return Strophe.xmlescape(str)},copyElement:function(elem){var el;if(elem.nodeType===Strophe.ElementType.NORMAL){el=Strophe.xmlElement(elem.tagName);for(var i=0;i<elem.attributes.length;i++)el.setAttribute(elem.attributes[i].nodeName,elem.attributes[i].value);for(var _i=0;_i<elem.childNodes.length;_i++)el.appendChild(Strophe.copyElement(elem.childNodes[_i]))}else elem.nodeType===Strophe.ElementType.TEXT&&(el=Strophe.xmlGenerator().createTextNode(elem.nodeValue));return el},createHtml:function(elem){var el;if(elem.nodeType===Strophe.ElementType.NORMAL){var tag=elem.nodeName.toLowerCase();if(Strophe.XHTML.validTag(tag))try{el=Strophe.xmlElement(tag);for(var i=0;i<Strophe.XHTML.attributes[tag].length;i++){var attribute=Strophe.XHTML.attributes[tag][i],value=elem.getAttribute(attribute);if(null!=value&&""!==value&&!1!==value&&0!==value)if("style"===attribute&&"object"===_typeof(value)&&void 0!==value.cssText&&(value=value.cssText),"style"===attribute){for(var css=[],cssAttrs=value.split(";"),j=0;j<cssAttrs.length;j++){var attr=cssAttrs[j].split(":"),cssName=attr[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(Strophe.XHTML.validCSS(cssName)){var cssValue=attr[1].replace(/^\s*/,"").replace(/\s*$/,"");css.push(cssName+": "+cssValue)}}css.length>0&&(value=css.join("; "),el.setAttribute(attribute,value))}else el.setAttribute(attribute,value)}for(var _i2=0;_i2<elem.childNodes.length;_i2++)el.appendChild(Strophe.createHtml(elem.childNodes[_i2]))}catch(e){el=Strophe.xmlTextNode("")}else{el=Strophe.xmlGenerator().createDocumentFragment();for(var _i3=0;_i3<elem.childNodes.length;_i3++)el.appendChild(Strophe.createHtml(elem.childNodes[_i3]))}}else if(elem.nodeType===Strophe.ElementType.FRAGMENT){el=Strophe.xmlGenerator().createDocumentFragment();for(var _i4=0;_i4<elem.childNodes.length;_i4++)el.appendChild(Strophe.createHtml(elem.childNodes[_i4]))}else elem.nodeType===Strophe.ElementType.TEXT&&(el=Strophe.xmlTextNode(elem.nodeValue));return el},escapeNode:function(node){return"string"!=typeof node?node:node.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(node){return"string"!=typeof node?node:node.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(jid){return jid.indexOf("@")<0?null:jid.split("@")[0]},getDomainFromJid:function(jid){var bare=Strophe.getBareJidFromJid(jid);if(bare.indexOf("@")<0)return bare;var parts=bare.split("@");return parts.splice(0,1),parts.join("@")},getResourceFromJid:function(jid){var s=jid.split("/");return s.length<2?null:(s.splice(0,1),s.join("/"))},getBareJidFromJid:function(jid){return jid?jid.split("/")[0]:null},_handleError:function(e){void 0!==e.stack&&Strophe.fatal(e.stack),e.sourceURL?Strophe.fatal("error: "+this.handler+" "+e.sourceURL+":"+e.line+" - "+e.name+": "+e.message):e.fileName?Strophe.fatal("error: "+this.handler+" "+e.fileName+":"+e.lineNumber+" - "+e.name+": "+e.message):Strophe.fatal("error: "+e.message)},log:function(level,msg){level===this.LogLevel.FATAL&&"object"===_typeof(window.console)&&"function"==typeof window.console.error&&window.console.error(msg)},debug:function(msg){this.log(this.LogLevel.DEBUG,msg)},info:function(msg){this.log(this.LogLevel.INFO,msg)},warn:function(msg){this.log(this.LogLevel.WARN,msg)},error:function(msg){this.log(this.LogLevel.ERROR,msg)},fatal:function(msg){this.log(this.LogLevel.FATAL,msg)},serialize:function(elem){if(!elem)return null;"function"==typeof elem.tree&&(elem=elem.tree());var names=_toConsumableArray(Array(elem.attributes.length).keys()).map((function(i){return elem.attributes[i].nodeName}));names.sort();var result=names.reduce((function(a,n){return"".concat(a," ").concat(n,'="').concat(Strophe.xmlescape(elem.attributes.getNamedItem(n).value),'"')}),"<".concat(elem.nodeName));if(elem.childNodes.length>0){result+=">";for(var i=0;i<elem.childNodes.length;i++){var child=elem.childNodes[i];switch(child.nodeType){case Strophe.ElementType.NORMAL:result+=Strophe.serialize(child);break;case Strophe.ElementType.TEXT:result+=Strophe.xmlescape(child.nodeValue);break;case Strophe.ElementType.CDATA:result+="<![CDATA["+child.nodeValue+"]]>"}}result+="</"+elem.nodeName+">"}else result+="/>";return result},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(name,ptype){Strophe._connectionPlugins[name]=ptype},Builder:function(name,attrs){"presence"!==name&&"message"!==name&&"iq"!==name||(attrs&&!attrs.xmlns?attrs.xmlns=Strophe.NS.CLIENT:attrs||(attrs={xmlns:Strophe.NS.CLIENT})),this.nodeTree=Strophe.xmlElement(name,attrs),this.node=this.nodeTree}};Strophe.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return Strophe.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},root:function(){return this.node=this.nodeTree,this},attrs:function(moreattrs){for(var k in moreattrs)Object.prototype.hasOwnProperty.call(moreattrs,k)&&(void 0===moreattrs[k]?this.node.removeAttribute(k):this.node.setAttribute(k,moreattrs[k]));return this},c:function(name,attrs,text){var child=Strophe.xmlElement(name,attrs,text);return this.node.appendChild(child),"string"!=typeof text&&"number"!=typeof text&&(this.node=child),this},cnode:function(elem){var impNode,xmlGen=Strophe.xmlGenerator();try{impNode=void 0!==xmlGen.importNode}catch(e){impNode=!1}var newElem=impNode?xmlGen.importNode(elem,!0):Strophe.copyElement(elem);return this.node.appendChild(newElem),this.node=newElem,this},t:function(text){var child=Strophe.xmlTextNode(text);return this.node.appendChild(child),this},h:function(html){var fragment=document.createElement("body");fragment.innerHTML=html;for(var xhtml=Strophe.createHtml(fragment);xhtml.childNodes.length>0;)this.node.appendChild(xhtml.childNodes[0]);return this}},Strophe.Handler=function(handler,ns,name,type,id,from,options){this.handler=handler,this.ns=ns,this.name=name,this.type=type,this.id=id,this.options=options||{matchBareFromJid:!1,ignoreNamespaceFragment:!1},this.options.matchBare&&(Strophe.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare),this.options.matchBareFromJid?this.from=from?Strophe.getBareJidFromJid(from):null:this.from=from,this.user=!0},Strophe.Handler.prototype={getNamespace:function(elem){var elNamespace=elem.getAttribute("xmlns");return elNamespace&&this.options.ignoreNamespaceFragment&&(elNamespace=elNamespace.split("#")[0]),elNamespace},namespaceMatch:function(elem){var _this=this,nsMatch=!1;return!this.ns||(Strophe.forEachChild(elem,null,(function(elem){_this.getNamespace(elem)===_this.ns&&(nsMatch=!0)})),nsMatch||this.getNamespace(elem)===this.ns)},isMatch:function(elem){var from=elem.getAttribute("from");this.options.matchBareFromJid&&(from=Strophe.getBareJidFromJid(from));var elem_type=elem.getAttribute("type");return!(!this.namespaceMatch(elem)||this.name&&!Strophe.isTagEqual(elem,this.name)||this.type&&(Array.isArray(this.type)?-1===this.type.indexOf(elem_type):elem_type!==this.type)||this.id&&elem.getAttribute("id")!==this.id||this.from&&from!==this.from)},run:function(elem){var result=null;try{result=this.handler(elem)}catch(e){throw Strophe._handleError(e),e}return result},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}},Strophe.TimedHandler=function(period,handler){this.period=period,this.handler=handler,this.lastCalled=(new Date).getTime(),this.user=!0},Strophe.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}},Strophe.Connection=function(service,options){var _this2=this;this.service=service,this.options=options||{};var proto=this.options.protocol||"";for(var k in 0===service.indexOf("ws:")||0===service.indexOf("wss:")||0===proto.indexOf("ws")?this._proto=new Strophe.Websocket(this):this._proto=new Strophe.Bosh(this),this.jid="",this.domain=null,this.features=null,this._sasl_data={},this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.protocolErrorHandlers={HTTP:{},websocket:{}},this._idleTimeout=null,this._disconnectTimeout=null,this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.do_authentication=!0,this.paused=!1,this.restored=!1,this._data=[],this._uniqueId=0,this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout((function(){return _this2._onIdle()}),100),utils__WEBPACK_IMPORTED_MODULE_2__.default.addCookies(this.options.cookies),this.registerSASLMechanisms(this.options.mechanisms),Strophe._connectionPlugins)if(Object.prototype.hasOwnProperty.call(Strophe._connectionPlugins,k)){var F=function(){};F.prototype=Strophe._connectionPlugins[k],this[k]=new F,this[k].init(this)}},Strophe.Connection.prototype={reset:function(){this._proto._reset(),this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this.authenticated=!1,this.connected=!1,this.disconnecting=!1,this.restored=!1,this._data=[],this._requests=[],this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(suffix){var uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(c){var r=16*Math.random()|0;return("x"===c?r:3&r|8).toString(16)}));return"string"==typeof suffix||"number"==typeof suffix?uuid+":"+suffix:uuid+""},addProtocolErrorHandler:function(protocol,status_code,callback){this.protocolErrorHandlers[protocol][status_code]=callback},connect:function(jid,pass,callback,wait,hold,route,authcid){this.jid=jid,this.authzid=Strophe.getBareJidFromJid(this.jid),this.authcid=authcid||Strophe.getNodeFromJid(this.jid),this.pass=pass,this.servtype="xmpp",this.connect_callback=callback,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.domain=Strophe.getDomainFromJid(this.jid),this._changeConnectStatus(Strophe.Status.CONNECTING,null),this._proto._connect(wait,hold,route)},attach:function(jid,sid,rid,callback,wait,hold,wind){if(!(this._proto instanceof Strophe.Bosh)){var error=new Error('The "attach" method can only be used with a BOSH connection.');throw error.name="StropheSessionError",error}this._proto._attach(jid,sid,rid,callback,wait,hold,wind)},restore:function(jid,callback,wait,hold,wind){if(!this._sessionCachingSupported()){var error=new Error('The "restore" method can only be used with a BOSH connection.');throw error.name="StropheSessionError",error}this._proto._restore(jid,callback,wait,hold,wind)},_sessionCachingSupported:function(){if(this._proto instanceof Strophe.Bosh){if(!JSON)return!1;try{sessionStorage.setItem("_strophe_","_strophe_"),sessionStorage.removeItem("_strophe_")}catch(e){return!1}return!0}return!1},xmlInput:function(elem){},xmlOutput:function(elem){},rawInput:function(data){},rawOutput:function(data){},nextValidRid:function(rid){},send:function(elem){if(null!==elem){if("function"==typeof elem.sort)for(var i=0;i<elem.length;i++)this._queueData(elem[i]);else"function"==typeof elem.tree?this._queueData(elem.tree()):this._queueData(elem);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout),this._onIdle()},sendPresence:function(elem,callback,errback,timeout){var _this3=this,timeoutHandler=null;"function"==typeof elem.tree&&(elem=elem.tree());var id=elem.getAttribute("id");if(id||(id=this.getUniqueId("sendPresence"),elem.setAttribute("id",id)),"function"==typeof callback||"function"==typeof errback){var handler=this.addHandler((function(stanza){timeoutHandler&&_this3.deleteTimedHandler(timeoutHandler),"error"===stanza.getAttribute("type")?errback&&errback(stanza):callback&&callback(stanza)}),null,"presence",null,id);timeout&&(timeoutHandler=this.addTimedHandler(timeout,(function(){return _this3.deleteHandler(handler),errback&&errback(null),!1})))}return this.send(elem),id},sendIQ:function(elem,callback,errback,timeout){var _this4=this,timeoutHandler=null;"function"==typeof elem.tree&&(elem=elem.tree());var id=elem.getAttribute("id");if(id||(id=this.getUniqueId("sendIQ"),elem.setAttribute("id",id)),"function"==typeof callback||"function"==typeof errback){var handler=this.addHandler((function(stanza){timeoutHandler&&_this4.deleteTimedHandler(timeoutHandler);var iqtype=stanza.getAttribute("type");if("result"===iqtype)callback&&callback(stanza);else{if("error"!==iqtype){var error=new Error("Got bad IQ type of ".concat(iqtype));throw error.name="StropheError",error}errback&&errback(stanza)}}),null,"iq",["error","result"],id);timeout&&(timeoutHandler=this.addTimedHandler(timeout,(function(){return _this4.deleteHandler(handler),errback&&errback(null),!1})))}return this.send(elem),id},_queueData:function(element){if(null===element||!element.tagName||!element.childNodes){var error=new Error("Cannot queue non-DOMElement.");throw error.name="StropheError",error}this._data.push(element)},_sendRestart:function(){var _this5=this;this._data.push("restart"),this._proto._sendRestart(),this._idleTimeout=setTimeout((function(){return _this5._onIdle()}),100)},addTimedHandler:function(period,handler){var thand=new Strophe.TimedHandler(period,handler);return this.addTimeds.push(thand),thand},deleteTimedHandler:function(handRef){this.removeTimeds.push(handRef)},addHandler:function(handler,ns,name,type,id,from,options){var hand=new Strophe.Handler(handler,ns,name,type,id,from,options);return this.addHandlers.push(hand),hand},deleteHandler:function(handRef){this.removeHandlers.push(handRef);var i=this.addHandlers.indexOf(handRef);i>=0&&this.addHandlers.splice(i,1)},registerSASLMechanisms:function(mechanisms){this.mechanisms={},(mechanisms=mechanisms||[Strophe.SASLAnonymous,Strophe.SASLExternal,Strophe.SASLMD5,Strophe.SASLOAuthBearer,Strophe.SASLXOAuth2,Strophe.SASLPlain,Strophe.SASLSHA1]).forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(mechanism){this.mechanisms[mechanism.prototype.name]=mechanism},disconnect:function(reason){if(this._changeConnectStatus(Strophe.Status.DISCONNECTING,reason),Strophe.info("Disconnect was called because: "+reason),this.connected){var pres=!1;this.disconnecting=!0,this.authenticated&&(pres=$pres({xmlns:Strophe.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(pres)}else Strophe.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect()},_changeConnectStatus:function(status,condition,elem){for(var k in Strophe._connectionPlugins)if(Object.prototype.hasOwnProperty.call(Strophe._connectionPlugins,k)){var plugin=this[k];if(plugin.statusChanged)try{plugin.statusChanged(status,condition)}catch(err){Strophe.error("".concat(k," plugin caused an exception changing status: ").concat(err))}}if(this.connect_callback)try{this.connect_callback(status,condition,elem)}catch(e){Strophe._handleError(e),Strophe.error("User connection callback caused an exception: ".concat(e))}},_doDisconnect:function(condition){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),Strophe.info("_doDisconnect was called"),this._proto._doDisconnect(),this.authenticated=!1,this.disconnecting=!1,this.restored=!1,this.handlers=[],this.timedHandlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._changeConnectStatus(Strophe.Status.DISCONNECTED,condition),this.connected=!1},_dataRecv:function(req,raw){var _this6=this;Strophe.info("_dataRecv called");var elem=this._proto._reqToData(req);if(null!==elem){for(this.xmlInput!==Strophe.Connection.prototype.xmlInput&&(elem.nodeName===this._proto.strip&&elem.childNodes.length?this.xmlInput(elem.childNodes[0]):this.xmlInput(elem)),this.rawInput!==Strophe.Connection.prototype.rawInput&&(raw?this.rawInput(raw):this.rawInput(Strophe.serialize(elem)));this.removeHandlers.length>0;){var hand=this.removeHandlers.pop(),i=this.handlers.indexOf(hand);i>=0&&this.handlers.splice(i,1)}for(;this.addHandlers.length>0;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else{var type=elem.getAttribute("type");if(null!==type&&"terminate"===type){if(this.disconnecting)return;var cond=elem.getAttribute("condition"),conflict=elem.getElementsByTagName("conflict");return null!==cond?("remote-stream-error"===cond&&conflict.length>0&&(cond="conflict"),this._changeConnectStatus(Strophe.Status.CONNFAIL,cond)):this._changeConnectStatus(Strophe.Status.CONNFAIL,Strophe.ErrorCondition.UNKOWN_REASON),void this._doDisconnect(cond)}Strophe.forEachChild(elem,null,(function(child){var newList=_this6.handlers;_this6.handlers=[];for(var _i5=0;_i5<newList.length;_i5++){var _hand=newList[_i5];try{(!_hand.isMatch(child)||!_this6.authenticated&&_hand.user||_hand.run(child))&&_this6.handlers.push(_hand)}catch(e){Strophe.warn("Removing Strophe handlers due to uncaught exception: "+e.message)}}}))}}},mechanisms:{},_connect_cb:function(req,_callback,raw){var bodyWrap;Strophe.info("_connect_cb was called"),this.connected=!0;try{bodyWrap=this._proto._reqToData(req)}catch(e){if(e.name!==Strophe.ErrorCondition.BAD_FORMAT)throw e;this._changeConnectStatus(Strophe.Status.CONNFAIL,Strophe.ErrorCondition.BAD_FORMAT),this._doDisconnect(Strophe.ErrorCondition.BAD_FORMAT)}if(bodyWrap&&(this.xmlInput!==Strophe.Connection.prototype.xmlInput&&(bodyWrap.nodeName===this._proto.strip&&bodyWrap.childNodes.length?this.xmlInput(bodyWrap.childNodes[0]):this.xmlInput(bodyWrap)),this.rawInput!==Strophe.Connection.prototype.rawInput&&(raw?this.rawInput(raw):this.rawInput(Strophe.serialize(bodyWrap))),this._proto._connect_cb(bodyWrap)!==Strophe.Status.CONNFAIL))if(bodyWrap.getElementsByTagNameNS?bodyWrap.getElementsByTagNameNS(Strophe.NS.STREAM,"features").length>0:bodyWrap.getElementsByTagName("stream:features").length>0||bodyWrap.getElementsByTagName("features").length>0){var matched=[],mechanisms=bodyWrap.getElementsByTagName("mechanism");if(mechanisms.length>0)for(var i=0;i<mechanisms.length;i++){var mech=Strophe.getText(mechanisms[i]);this.mechanisms[mech]&&matched.push(this.mechanisms[mech])}0!==matched.length||0!==bodyWrap.getElementsByTagName("auth").length?!1!==this.do_authentication&&this.authenticate(matched):this._proto._no_auth_received(_callback)}else this._proto._no_auth_received(_callback)},sortMechanismsByPriority:function(mechanisms){for(var i=0;i<mechanisms.length-1;++i){for(var higher=i,j=i+1;j<mechanisms.length;++j)mechanisms[j].prototype.priority>mechanisms[higher].prototype.priority&&(higher=j);if(higher!==i){var swap=mechanisms[i];mechanisms[i]=mechanisms[higher],mechanisms[higher]=swap}}return mechanisms},_attemptSASLAuth:function(mechanisms){mechanisms=this.sortMechanismsByPriority(mechanisms||[]);for(var mechanism_found=!1,i=0;i<mechanisms.length;++i)if(mechanisms[i].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null),this._sasl_mechanism=new mechanisms[i],this._sasl_mechanism.onStart(this);var request_auth_exchange=$build("auth",{xmlns:Strophe.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var response=this._sasl_mechanism.onChallenge(this,null);request_auth_exchange.t(btoa(response))}this.send(request_auth_exchange.tree()),mechanism_found=!0;break}return mechanism_found},_attemptLegacyAuth:function(){null===Strophe.getNodeFromJid(this.jid)?(this._changeConnectStatus(Strophe.Status.CONNFAIL,Strophe.ErrorCondition.MISSING_JID_NODE),this.disconnect(Strophe.ErrorCondition.MISSING_JID_NODE)):(this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send($iq({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(this.jid)).tree()))},authenticate:function(matched){this._attemptSASLAuth(matched)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(elem){var challenge=atob(Strophe.getText(elem)),response=this._sasl_mechanism.onChallenge(this,challenge),stanza=$build("response",{xmlns:Strophe.NS.SASL});return""!==response&&stanza.t(btoa(response)),this.send(stanza.tree()),!0},_auth1_cb:function(elem){var iq=$iq({type:"set",id:"_auth_2"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(this.jid)).up().c("password").t(this.pass);return Strophe.getResourceFromJid(this.jid)||(this.jid=Strophe.getBareJidFromJid(this.jid)+"/strophe"),iq.up().c("resource",{}).t(Strophe.getResourceFromJid(this.jid)),this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2"),this.send(iq.tree()),!1},_sasl_success_cb:function(elem){var _this7=this;if(this._sasl_data["server-signature"]){var serverSignature,matches=atob(Strophe.getText(elem)).match(/([a-z]+)=([^,]+)(,|$)/);if("v"===matches[1]&&(serverSignature=matches[2]),serverSignature!==this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}Strophe.info("SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var streamfeature_handlers=[],wrapper=function(handlers,elem){for(;handlers.length;)_this7.deleteHandler(handlers.pop());return _this7._sasl_auth1_cb(elem),!1};return streamfeature_handlers.push(this._addSysHandler((function(elem){return wrapper(streamfeature_handlers,elem)}),null,"stream:features",null,null)),streamfeature_handlers.push(this._addSysHandler((function(elem){return wrapper(streamfeature_handlers,elem)}),Strophe.NS.STREAM,"features",null,null)),this._sendRestart(),!1},_sasl_auth1_cb:function(elem){this.features=elem;for(var i=0;i<elem.childNodes.length;i++){var child=elem.childNodes[i];"bind"===child.nodeName&&(this.do_bind=!0),"session"===child.nodeName&&(this.do_session=!0)}if(!this.do_bind)return this._changeConnectStatus(Strophe.Status.AUTHFAIL,null),!1;this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var resource=Strophe.getResourceFromJid(this.jid);return resource?this.send($iq({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:Strophe.NS.BIND}).c("resource",{}).t(resource).tree()):this.send($iq({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:Strophe.NS.BIND}).tree()),!1},_sasl_bind_cb:function(elem){var condition;if("error"===elem.getAttribute("type"))return Strophe.info("SASL binding failed."),elem.getElementsByTagName("conflict").length>0&&(condition=Strophe.ErrorCondition.CONFLICT),this._changeConnectStatus(Strophe.Status.AUTHFAIL,condition,elem),!1;var bind=elem.getElementsByTagName("bind");if(!(bind.length>0))return Strophe.info("SASL binding failed."),this._changeConnectStatus(Strophe.Status.AUTHFAIL,null,elem),!1;var jidNode=bind[0].getElementsByTagName("jid");jidNode.length>0&&(this.jid=Strophe.getText(jidNode[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send($iq({type:"set",id:"_session_auth_2"}).c("session",{xmlns:Strophe.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(Strophe.Status.CONNECTED,null)))},_sasl_session_cb:function(elem){if("result"===elem.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(Strophe.Status.CONNECTED,null);else if("error"===elem.getAttribute("type"))return Strophe.info("Session creation failed."),this._changeConnectStatus(Strophe.Status.AUTHFAIL,null,elem),!1;return!1},_sasl_failure_cb:function(elem){return this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(Strophe.Status.AUTHFAIL,null,elem),!1},_auth2_cb:function(elem){return"result"===elem.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(Strophe.Status.CONNECTED,null)):"error"===elem.getAttribute("type")&&(this._changeConnectStatus(Strophe.Status.AUTHFAIL,null,elem),this.disconnect("authentication failed")),!1},_addSysTimedHandler:function(period,handler){var thand=new Strophe.TimedHandler(period,handler);return thand.user=!1,this.addTimeds.push(thand),thand},_addSysHandler:function(handler,ns,name,type,id){var hand=new Strophe.Handler(handler,ns,name,type,id);return hand.user=!1,this.addHandlers.push(hand),hand},_onDisconnectTimeout:function(){return Strophe.info("_onDisconnectTimeout was called"),this._changeConnectStatus(Strophe.Status.CONNTIMEOUT,null),this._proto._onDisconnectTimeout(),this._doDisconnect(),!1},_onIdle:function(){for(var _this8=this;this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;){var thand=this.removeTimeds.pop(),i=this.timedHandlers.indexOf(thand);i>=0&&this.timedHandlers.splice(i,1)}for(var now=(new Date).getTime(),newList=[],_i6=0;_i6<this.timedHandlers.length;_i6++){var _thand=this.timedHandlers[_i6];!this.authenticated&&_thand.user||(_thand.lastCalled+_thand.period-now<=0?_thand.run()&&newList.push(_thand):newList.push(_thand))}this.timedHandlers=newList,clearTimeout(this._idleTimeout),this._proto._onIdle(),this.connected&&(this._idleTimeout=setTimeout((function(){return _this8._onIdle()}),100))}},Strophe.SASLMechanism=function(name,isClientFirst,priority){this.name=name,this.isClientFirst=isClientFirst,this.priority=priority},Strophe.SASLMechanism.prototype={test:function(connection){return!0},onStart:function(connection){this._connection=connection},onChallenge:function(connection,challenge){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}},Strophe.SASLAnonymous=function(){},Strophe.SASLAnonymous.prototype=new Strophe.SASLMechanism("ANONYMOUS",!1,20),Strophe.SASLAnonymous.prototype.test=function(connection){return null===connection.authcid},Strophe.SASLPlain=function(){},Strophe.SASLPlain.prototype=new Strophe.SASLMechanism("PLAIN",!0,50),Strophe.SASLPlain.prototype.test=function(connection){return null!==connection.authcid},Strophe.SASLPlain.prototype.onChallenge=function(connection){var auth_str=connection.authzid;return auth_str+="\0",auth_str+=connection.authcid,auth_str+="\0",auth_str+=connection.pass,utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(auth_str)},Strophe.SASLSHA1=function(){},Strophe.SASLSHA1.prototype=new Strophe.SASLMechanism("SCRAM-SHA-1",!0,70),Strophe.SASLSHA1.prototype.test=function(connection){return null!==connection.authcid},Strophe.SASLSHA1.prototype.onChallenge=function(connection,challenge,test_cnonce){var cnonce=test_cnonce||md5__WEBPACK_IMPORTED_MODULE_0__.default.hexdigest(1234567890*Math.random()),auth_str="n="+utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(connection.authcid);return auth_str+=",r=",auth_str+=cnonce,connection._sasl_data.cnonce=cnonce,connection._sasl_data["client-first-message-bare"]=auth_str,auth_str="n,,"+auth_str,this.onChallenge=function(connection,challenge){for(var nonce,salt,iter,Hi,U,U_old,i,k,responseText="c=biws,",authMessage="".concat(connection._sasl_data["client-first-message-bare"],",").concat(challenge,","),cnonce=connection._sasl_data.cnonce,attribMatch=/([a-z]+)=([^,]+)(,|$)/;challenge.match(attribMatch);){var matches=challenge.match(attribMatch);switch(challenge=challenge.replace(matches[0],""),matches[1]){case"r":nonce=matches[2];break;case"s":salt=matches[2];break;case"i":iter=matches[2]}}if(nonce.substr(0,cnonce.length)!==cnonce)return connection._sasl_data={},connection._sasl_failure_cb();authMessage+=responseText+="r="+nonce,salt=atob(salt),salt+="\0\0\0";var pass=utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(connection.pass);for(Hi=U_old=sha1__WEBPACK_IMPORTED_MODULE_1__.default.core_hmac_sha1(pass,salt),i=1;i<iter;i++){for(U=sha1__WEBPACK_IMPORTED_MODULE_1__.default.core_hmac_sha1(pass,sha1__WEBPACK_IMPORTED_MODULE_1__.default.binb2str(U_old)),k=0;k<5;k++)Hi[k]^=U[k];U_old=U}Hi=sha1__WEBPACK_IMPORTED_MODULE_1__.default.binb2str(Hi);var clientKey=sha1__WEBPACK_IMPORTED_MODULE_1__.default.core_hmac_sha1(Hi,"Client Key"),serverKey=sha1__WEBPACK_IMPORTED_MODULE_1__.default.str_hmac_sha1(Hi,"Server Key"),clientSignature=sha1__WEBPACK_IMPORTED_MODULE_1__.default.core_hmac_sha1(sha1__WEBPACK_IMPORTED_MODULE_1__.default.str_sha1(sha1__WEBPACK_IMPORTED_MODULE_1__.default.binb2str(clientKey)),authMessage);for(connection._sasl_data["server-signature"]=sha1__WEBPACK_IMPORTED_MODULE_1__.default.b64_hmac_sha1(serverKey,authMessage),k=0;k<5;k++)clientKey[k]^=clientSignature[k];return responseText+=",p="+btoa(sha1__WEBPACK_IMPORTED_MODULE_1__.default.binb2str(clientKey))},auth_str},Strophe.SASLMD5=function(){},Strophe.SASLMD5.prototype=new Strophe.SASLMechanism("DIGEST-MD5",!1,60),Strophe.SASLMD5.prototype.test=function(connection){return null!==connection.authcid},Strophe.SASLMD5.prototype._quote=function(str){return'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},Strophe.SASLMD5.prototype.onChallenge=function(connection,challenge,test_cnonce){for(var attribMatch=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,cnonce=test_cnonce||md5__WEBPACK_IMPORTED_MODULE_0__.default.hexdigest(""+1234567890*Math.random()),realm="",host=null,nonce="";challenge.match(attribMatch);){var matches=challenge.match(attribMatch);switch(challenge=challenge.replace(matches[0],""),matches[2]=matches[2].replace(/^"(.+)"$/,"$1"),matches[1]){case"realm":realm=matches[2];break;case"nonce":nonce=matches[2];break;case"qop":matches[2];break;case"host":host=matches[2]}}var digest_uri=connection.servtype+"/"+connection.domain;null!==host&&(digest_uri=digest_uri+"/"+host);var cred=utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(connection.authcid+":"+realm+":"+this._connection.pass),A1=md5__WEBPACK_IMPORTED_MODULE_0__.default.hash(cred)+":"+nonce+":"+cnonce,A2="AUTHENTICATE:"+digest_uri,responseText="";return responseText+="charset=utf-8,",responseText+="username="+this._quote(utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(connection.authcid))+",",responseText+="realm="+this._quote(realm)+",",responseText+="nonce="+this._quote(nonce)+",",responseText+="nc=00000001,",responseText+="cnonce="+this._quote(cnonce)+",",responseText+="digest-uri="+this._quote(digest_uri)+",",responseText+="response="+md5__WEBPACK_IMPORTED_MODULE_0__.default.hexdigest(md5__WEBPACK_IMPORTED_MODULE_0__.default.hexdigest(A1)+":"+nonce+":00000001:"+cnonce+":auth:"+md5__WEBPACK_IMPORTED_MODULE_0__.default.hexdigest(A2))+",",responseText+="qop=auth",this.onChallenge=function(){return""},responseText},Strophe.SASLOAuthBearer=function(){},Strophe.SASLOAuthBearer.prototype=new Strophe.SASLMechanism("OAUTHBEARER",!0,40),Strophe.SASLOAuthBearer.prototype.test=function(connection){return null!==connection.pass},Strophe.SASLOAuthBearer.prototype.onChallenge=function(connection){var auth_str="n,";return null!==connection.authcid&&(auth_str=auth_str+"a="+connection.authzid),auth_str+=",",auth_str+="",auth_str+="auth=Bearer ",auth_str+=connection.pass,auth_str+="",auth_str+="",utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(auth_str)},Strophe.SASLExternal=function(){},Strophe.SASLExternal.prototype=new Strophe.SASLMechanism("EXTERNAL",!0,10),Strophe.SASLExternal.prototype.onChallenge=function(connection){return connection.authcid===connection.authzid?"":connection.authzid},Strophe.SASLXOAuth2=function(){},Strophe.SASLXOAuth2.prototype=new Strophe.SASLMechanism("X-OAUTH2",!0,30),Strophe.SASLXOAuth2.prototype.test=function(connection){return null!==connection.pass},Strophe.SASLXOAuth2.prototype.onChallenge=function(connection){var auth_str="\0";return null!==connection.authcid&&(auth_str+=connection.authzid),auth_str+="\0",auth_str+=connection.pass,utils__WEBPACK_IMPORTED_MODULE_2__.default.utf16to8(auth_str)},__webpack_exports__.default={Strophe:Strophe,$build:$build,$iq:$iq,$msg:$msg,$pres:$pres,SHA1:sha1__WEBPACK_IMPORTED_MODULE_1__.default,MD5:md5__WEBPACK_IMPORTED_MODULE_0__.default,b64_hmac_sha1:sha1__WEBPACK_IMPORTED_MODULE_1__.default.b64_hmac_sha1,b64_sha1:sha1__WEBPACK_IMPORTED_MODULE_1__.default.b64_sha1,str_hmac_sha1:sha1__WEBPACK_IMPORTED_MODULE_1__.default.str_hmac_sha1,str_sha1:sha1__WEBPACK_IMPORTED_MODULE_1__.default.str_sha1}},"./src/md5.js":
/*!********************!*\
  !*** ./src/md5.js ***!
  \********************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"default",(function(){return MD5}));var safe_add=function(x,y){var lsw=(65535&x)+(65535&y);return(x>>16)+(y>>16)+(lsw>>16)<<16|65535&lsw},str2binl=function(str){for(var bin=[],i=0;i<8*str.length;i+=8)bin[i>>5]|=(255&str.charCodeAt(i/8))<<i%32;return bin},md5_cmn=function(q,a,b,x,s,t){return safe_add((num=safe_add(safe_add(a,q),safe_add(x,t)))<<(cnt=s)|num>>>32-cnt,b);var num,cnt},md5_ff=function(a,b,c,d,x,s,t){return md5_cmn(b&c|~b&d,a,b,x,s,t)},md5_gg=function(a,b,c,d,x,s,t){return md5_cmn(b&d|c&~d,a,b,x,s,t)},md5_hh=function(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)},md5_ii=function(a,b,c,d,x,s,t){return md5_cmn(c^(b|~d),a,b,x,s,t)},core_md5=function(x,len){x[len>>5]|=128<<len%32,x[14+(len+64>>>9<<4)]=len;for(var olda,oldb,oldc,oldd,a=1732584193,b=-271733879,c=-1732584194,d=271733878,i=0;i<x.length;i+=16)olda=a,oldb=b,oldc=c,oldd=d,a=md5_ff(a,b,c,d,x[i+0],7,-680876936),d=md5_ff(d,a,b,c,x[i+1],12,-389564586),c=md5_ff(c,d,a,b,x[i+2],17,606105819),b=md5_ff(b,c,d,a,x[i+3],22,-1044525330),a=md5_ff(a,b,c,d,x[i+4],7,-176418897),d=md5_ff(d,a,b,c,x[i+5],12,1200080426),c=md5_ff(c,d,a,b,x[i+6],17,-1473231341),b=md5_ff(b,c,d,a,x[i+7],22,-45705983),a=md5_ff(a,b,c,d,x[i+8],7,1770035416),d=md5_ff(d,a,b,c,x[i+9],12,-1958414417),c=md5_ff(c,d,a,b,x[i+10],17,-42063),b=md5_ff(b,c,d,a,x[i+11],22,-1990404162),a=md5_ff(a,b,c,d,x[i+12],7,1804603682),d=md5_ff(d,a,b,c,x[i+13],12,-40341101),c=md5_ff(c,d,a,b,x[i+14],17,-1502002290),b=md5_ff(b,c,d,a,x[i+15],22,1236535329),a=md5_gg(a,b,c,d,x[i+1],5,-165796510),d=md5_gg(d,a,b,c,x[i+6],9,-1069501632),c=md5_gg(c,d,a,b,x[i+11],14,643717713),b=md5_gg(b,c,d,a,x[i+0],20,-373897302),a=md5_gg(a,b,c,d,x[i+5],5,-701558691),d=md5_gg(d,a,b,c,x[i+10],9,38016083),c=md5_gg(c,d,a,b,x[i+15],14,-660478335),b=md5_gg(b,c,d,a,x[i+4],20,-405537848),a=md5_gg(a,b,c,d,x[i+9],5,568446438),d=md5_gg(d,a,b,c,x[i+14],9,-1019803690),c=md5_gg(c,d,a,b,x[i+3],14,-187363961),b=md5_gg(b,c,d,a,x[i+8],20,1163531501),a=md5_gg(a,b,c,d,x[i+13],5,-1444681467),d=md5_gg(d,a,b,c,x[i+2],9,-51403784),c=md5_gg(c,d,a,b,x[i+7],14,1735328473),b=md5_gg(b,c,d,a,x[i+12],20,-1926607734),a=md5_hh(a,b,c,d,x[i+5],4,-378558),d=md5_hh(d,a,b,c,x[i+8],11,-2022574463),c=md5_hh(c,d,a,b,x[i+11],16,1839030562),b=md5_hh(b,c,d,a,x[i+14],23,-35309556),a=md5_hh(a,b,c,d,x[i+1],4,-1530992060),d=md5_hh(d,a,b,c,x[i+4],11,1272893353),c=md5_hh(c,d,a,b,x[i+7],16,-155497632),b=md5_hh(b,c,d,a,x[i+10],23,-1094730640),a=md5_hh(a,b,c,d,x[i+13],4,681279174),d=md5_hh(d,a,b,c,x[i+0],11,-358537222),c=md5_hh(c,d,a,b,x[i+3],16,-722521979),b=md5_hh(b,c,d,a,x[i+6],23,76029189),a=md5_hh(a,b,c,d,x[i+9],4,-640364487),d=md5_hh(d,a,b,c,x[i+12],11,-421815835),c=md5_hh(c,d,a,b,x[i+15],16,530742520),b=md5_hh(b,c,d,a,x[i+2],23,-995338651),a=md5_ii(a,b,c,d,x[i+0],6,-198630844),d=md5_ii(d,a,b,c,x[i+7],10,1126891415),c=md5_ii(c,d,a,b,x[i+14],15,-1416354905),b=md5_ii(b,c,d,a,x[i+5],21,-57434055),a=md5_ii(a,b,c,d,x[i+12],6,1700485571),d=md5_ii(d,a,b,c,x[i+3],10,-1894986606),c=md5_ii(c,d,a,b,x[i+10],15,-1051523),b=md5_ii(b,c,d,a,x[i+1],21,-2054922799),a=md5_ii(a,b,c,d,x[i+8],6,1873313359),d=md5_ii(d,a,b,c,x[i+15],10,-30611744),c=md5_ii(c,d,a,b,x[i+6],15,-1560198380),b=md5_ii(b,c,d,a,x[i+13],21,1309151649),a=md5_ii(a,b,c,d,x[i+4],6,-145523070),d=md5_ii(d,a,b,c,x[i+11],10,-1120210379),c=md5_ii(c,d,a,b,x[i+2],15,718787259),b=md5_ii(b,c,d,a,x[i+9],21,-343485551),a=safe_add(a,olda),b=safe_add(b,oldb),c=safe_add(c,oldc),d=safe_add(d,oldd);return[a,b,c,d]},MD5={hexdigest:function(s){return function(binarray){for(var str="",i=0;i<4*binarray.length;i++)str+="0123456789abcdef".charAt(binarray[i>>2]>>i%4*8+4&15)+"0123456789abcdef".charAt(binarray[i>>2]>>i%4*8&15);return str}(core_md5(str2binl(s),8*s.length))},hash:function(s){return function(bin){for(var str="",i=0;i<32*bin.length;i+=8)str+=String.fromCharCode(bin[i>>5]>>>i%32&255);return str}(core_md5(str2binl(s),8*s.length))}}},"./src/sha1.js":
/*!*********************!*\
  !*** ./src/sha1.js ***!
  \*********************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";function core_sha1(x,len){x[len>>5]|=128<<24-len%32,x[15+(len+64>>9<<4)]=len;var i,j,t,olda,oldb,oldc,oldd,olde,w=new Array(80),a=1732584193,b=-271733879,c=-1732584194,d=271733878,e=-1009589776;for(i=0;i<x.length;i+=16){for(olda=a,oldb=b,oldc=c,oldd=d,olde=e,j=0;j<80;j++)w[j]=j<16?x[i+j]:rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1),t=safe_add(safe_add(rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j))),e=d,d=c,c=rol(b,30),b=a,a=t;a=safe_add(a,olda),b=safe_add(b,oldb),c=safe_add(c,oldc),d=safe_add(d,oldd),e=safe_add(e,olde)}return[a,b,c,d,e]}function sha1_ft(t,b,c,d){return t<20?b&c|~b&d:t<40?b^c^d:t<60?b&c|b&d|c&d:b^c^d}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function core_hmac_sha1(key,data){var bkey=str2binb(key);bkey.length>16&&(bkey=core_sha1(bkey,8*key.length));for(var ipad=new Array(16),opad=new Array(16),i=0;i<16;i++)ipad[i]=909522486^bkey[i],opad[i]=1549556828^bkey[i];var hash=core_sha1(ipad.concat(str2binb(data)),512+8*data.length);return core_sha1(opad.concat(hash),672)}function safe_add(x,y){var lsw=(65535&x)+(65535&y);return(x>>16)+(y>>16)+(lsw>>16)<<16|65535&lsw}function rol(num,cnt){return num<<cnt|num>>>32-cnt}function str2binb(str){for(var bin=[],i=0;i<8*str.length;i+=8)bin[i>>5]|=(255&str.charCodeAt(i/8))<<24-i%32;return bin}function binb2b64(binarray){for(var triplet,j,str="",i=0;i<4*binarray.length;i+=3)for(triplet=(binarray[i>>2]>>8*(3-i%4)&255)<<16|(binarray[i+1>>2]>>8*(3-(i+1)%4)&255)<<8|binarray[i+2>>2]>>8*(3-(i+2)%4)&255,j=0;j<4;j++)8*i+6*j>32*binarray.length?str+="=":str+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(triplet>>6*(3-j)&63);return str}function binb2str(bin){for(var str="",i=0;i<32*bin.length;i+=8)str+=String.fromCharCode(bin[i>>5]>>>24-i%32&255);return str}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"default",(function(){return SHA1}));var SHA1={b64_hmac_sha1:function(key,data){return binb2b64(core_hmac_sha1(key,data))},b64_sha1:function(s){return binb2b64(core_sha1(str2binb(s),8*s.length))},binb2str:binb2str,core_hmac_sha1:core_hmac_sha1,str_hmac_sha1:function(key,data){return binb2str(core_hmac_sha1(key,data))},str_sha1:function(s){return binb2str(core_sha1(str2binb(s),8*s.length))}}},"./src/strophe.js":
/*!************************!*\
  !*** ./src/strophe.js ***!
  \************************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),function(global){var core__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(/*! core */"./src/core.js");__webpack_require__(/*! bosh */"./src/bosh.js"),__webpack_require__(/*! websocket */"./src/websocket.js"),__webpack_require__.d(__webpack_exports__,"default",(function(){return core__WEBPACK_IMPORTED_MODULE_0__.default})),global.Strophe=core__WEBPACK_IMPORTED_MODULE_0__.default.Strophe,global.$build=core__WEBPACK_IMPORTED_MODULE_0__.default.$build,global.$iq=core__WEBPACK_IMPORTED_MODULE_0__.default.$iq,global.$msg=core__WEBPACK_IMPORTED_MODULE_0__.default.$msg,global.$pres=core__WEBPACK_IMPORTED_MODULE_0__.default.$pres}.call(this,__webpack_require__(/*! ./../node_modules/webpack/buildin/global.js */"./node_modules/webpack/buildin/global.js"))},"./src/utils.js":
/*!**********************!*\
  !*** ./src/utils.js ***!
  \**********************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"default",(function(){return utils}));var utils={utf16to8:function(str){var i,c,out="",len=str.length;for(i=0;i<len;i++)(c=str.charCodeAt(i))>=0&&c<=127?out+=str.charAt(i):c>2047?(out+=String.fromCharCode(224|c>>12&15),out+=String.fromCharCode(128|c>>6&63),out+=String.fromCharCode(128|c>>0&63)):(out+=String.fromCharCode(192|c>>6&31),out+=String.fromCharCode(128|c>>0&63));return out},addCookies:function(cookies){for(var cookieName in cookies=cookies||{})if(Object.prototype.hasOwnProperty.call(cookies,cookieName)){var expires="",domain="",path="",cookieObj=cookies[cookieName],isObj="object"===_typeof(cookieObj),cookieValue=escape(unescape(isObj?cookieObj.value:cookieObj));isObj&&(expires=cookieObj.expires?";expires="+cookieObj.expires:"",domain=cookieObj.domain?";domain="+cookieObj.domain:"",path=cookieObj.path?";path="+cookieObj.path:""),document.cookie=cookieName+"="+cookieValue+expires+domain+path}}}},"./src/websocket.js":
/*!**************************!*\
  !*** ./src/websocket.js ***!
  \**************************/
/*! no exports provided */function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var core__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(/*! core */"./src/core.js"),Strophe=core__WEBPACK_IMPORTED_MODULE_0__.default.Strophe,$build=core__WEBPACK_IMPORTED_MODULE_0__.default.$build;Strophe.Websocket=function(connection){this._conn=connection,this.strip="wrapper";var service=connection.service;if(0!==service.indexOf("ws:")&&0!==service.indexOf("wss:")){var new_service="";"ws"===connection.options.protocol&&"https:"!==window.location.protocol?new_service+="ws":new_service+="wss",new_service+="://"+window.location.host,0!==service.indexOf("/")?new_service+=window.location.pathname+service:new_service+=service,connection.service=new_service}},Strophe.Websocket.prototype={_buildStream:function(){return $build("open",{xmlns:Strophe.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(bodyWrap,connectstatus){var errors;if(0===(errors=bodyWrap.getElementsByTagNameNS?bodyWrap.getElementsByTagNameNS(Strophe.NS.STREAM,"error"):bodyWrap.getElementsByTagName("stream:error")).length)return!1;for(var error=errors[0],condition="",text="",i=0;i<error.childNodes.length;i++){var e=error.childNodes[i];if("urn:ietf:params:xml:ns:xmpp-streams"!==e.getAttribute("xmlns"))break;"text"===e.nodeName?text=e.textContent:condition=e.nodeName}var errorString="WebSocket stream error: ";return errorString+=condition||"unknown",text&&(errorString+=" - "+text),Strophe.error(errorString),this._conn._changeConnectStatus(connectstatus,condition),this._conn._doDisconnect(),!0},_reset:function(){},_connect:function(){this._closeSocket(),this.socket=new WebSocket(this._conn.service,"xmpp"),this.socket.onopen=this._onOpen.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(bodyWrap){if(this._check_streamerror(bodyWrap,Strophe.Status.CONNFAIL))return Strophe.Status.CONNFAIL},_handleStreamStart:function(message){var error=!1,ns=message.getAttribute("xmlns");"string"!=typeof ns?error="Missing xmlns in <open />":ns!==Strophe.NS.FRAMING&&(error="Wrong xmlns in <open />: "+ns);var ver=message.getAttribute("version");return"string"!=typeof ver?error="Missing version in <open />":"1.0"!==ver&&(error="Wrong version in <open />: "+ver),!error||(this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,error),this._conn._doDisconnect(),!1)},_connect_cb_wrapper:function(message){if(0===message.data.indexOf("<open ")||0===message.data.indexOf("<?xml")){var data=message.data.replace(/^(<\?.*?\?>\s*)*/,"");if(""===data)return;var streamStart=(new DOMParser).parseFromString(data,"text/xml").documentElement;this._conn.xmlInput(streamStart),this._conn.rawInput(message.data),this._handleStreamStart(streamStart)&&this._connect_cb(streamStart)}else if(0===message.data.indexOf("<close ")){var parsedMessage=(new DOMParser).parseFromString(message.data,"text/xml").documentElement;this._conn.xmlInput(parsedMessage),this._conn.rawInput(message.data);var see_uri=parsedMessage.getAttribute("see-other-uri");if(see_uri){var service=this._conn.service;(service.indexOf("wss:")>=0&&see_uri.indexOf("wss:")>=0||service.indexOf("ws:")>=0)&&(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=see_uri,this._connect())}else this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect()}else{var string=this._streamWrap(message.data),elem=(new DOMParser).parseFromString(string,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(elem,null,message.data)}},_disconnect:function(pres){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){pres&&this._conn.send(pres);var close=$build("close",{xmlns:Strophe.NS.FRAMING});this._conn.xmlOutput(close.tree());var closeString=Strophe.serialize(close);this._conn.rawOutput(closeString);try{this.socket.send(closeString)}catch(e){Strophe.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){Strophe.info("WebSockets _doDisconnect was called"),this._closeSocket()},_streamWrap:function(stanza){return"<wrapper>"+stanza+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.onerror=null,this.socket.close()}catch(e){Strophe.debug(e.message)}this.socket=null},_emptyQueue:function(){return!0},_onClose:function(e){this._conn.connected&&!this._conn.disconnecting?(Strophe.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):e&&1006===e.code&&!this._conn.connected&&this.socket?(Strophe.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):Strophe.info("Websocket closed")},_no_auth_received:function(callback){Strophe.error("Server did not offer a supported authentication mechanism"),this._changeConnectStatus(Strophe.Status.CONNFAIL,Strophe.ErrorCondition.NO_AUTH_MECH),callback&&callback.call(this._conn),this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(error){Strophe.error("Websocket error "+error),this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._disconnect()},_onIdle:function(){var data=this._conn._data;if(data.length>0&&!this._conn.paused){for(var i=0;i<data.length;i++)if(null!==data[i]){var stanza=void 0;stanza="restart"===data[i]?this._buildStream().tree():data[i];var rawStanza=Strophe.serialize(stanza);this._conn.xmlOutput(stanza),this._conn.rawOutput(rawStanza),this.socket.send(rawStanza)}this._conn._data=[]}},_onMessage:function(message){var elem,close='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(message.data===close)return this._conn.rawInput(close),this._conn.xmlInput(message),void(this._conn.disconnecting||this._conn._doDisconnect());if(0===message.data.search("<open ")){if(elem=(new DOMParser).parseFromString(message.data,"text/xml").documentElement,!this._handleStreamStart(elem))return}else{var data=this._streamWrap(message.data);elem=(new DOMParser).parseFromString(data,"text/xml").documentElement}return this._check_streamerror(elem,Strophe.Status.ERROR)?void 0:this._conn.disconnecting&&"presence"===elem.firstChild.nodeName&&"unavailable"===elem.firstChild.getAttribute("type")?(this._conn.xmlInput(elem),void this._conn.rawInput(Strophe.serialize(elem))):void this._conn._dataRecv(elem,message.data)},_onOpen:function(){Strophe.info("Websocket open");var start=this._buildStream();this._conn.xmlOutput(start.tree());var startString=Strophe.serialize(start);this._conn.rawOutput(startString),this.socket.send(startString)},_reqToData:function(stanza){return stanza},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout),this._conn._onIdle.bind(this._conn)()}}}}).default},module.exports=factory()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return BehaviorSubject}));var tslib__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(6),_Subject__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(23),_util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(30),BehaviorSubject=function(_super){function BehaviorSubject(_value){var _this=_super.call(this)||this;return _this._value=_value,_this}return tslib__WEBPACK_IMPORTED_MODULE_0__.a(BehaviorSubject,_super),Object.defineProperty(BehaviorSubject.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),BehaviorSubject.prototype._subscribe=function(subscriber){var subscription=_super.prototype._subscribe.call(this,subscriber);return subscription&&!subscription.closed&&subscriber.next(this._value),subscription},BehaviorSubject.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new _util_ObjectUnsubscribedError__WEBPACK_IMPORTED_MODULE_2__.a;return this._value},BehaviorSubject.prototype.next=function(value){_super.prototype.next.call(this,this._value=value)},BehaviorSubject}(_Subject__WEBPACK_IMPORTED_MODULE_1__.a)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isFunction=function(x){return"function"==typeof x}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var config_1=__webpack_require__(68),hostReportError_1=__webpack_require__(80);exports.empty={closed:!0,next:function(value){},error:function(err){if(config_1.config.useDeprecatedSynchronousErrorHandling)throw err;hostReportError_1.hostReportError(err)},complete:function(){}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.hostReportError=function(err){setTimeout((function(){throw err}),0)}},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var SubjectSubscription=function(_super){function SubjectSubscription(subject,subscriber){var _this=_super.call(this)||this;return _this.subject=subject,_this.subscriber=subscriber,_this.closed=!1,_this}return __extends(SubjectSubscription,_super),SubjectSubscription.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var subject=this.subject,observers=subject.observers;if(this.subject=null,observers&&0!==observers.length&&!subject.isStopped&&!subject.closed){var subscriberIndex=observers.indexOf(this.subscriber);-1!==subscriberIndex&&observers.splice(subscriberIndex,1)}}},SubjectSubscription}(__webpack_require__(45).Subscription);exports.SubjectSubscription=SubjectSubscription},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("af",{months:"Januarie_Februarie_Maart_April_Mei_Junie_Julie_Augustus_September_Oktober_November_Desember".split("_"),monthsShort:"Jan_Feb_Mrt_Apr_Mei_Jun_Jul_Aug_Sep_Okt_Nov_Des".split("_"),weekdays:"Sondag_Maandag_Dinsdag_Woensdag_Donderdag_Vrydag_Saterdag".split("_"),weekdaysShort:"Son_Maa_Din_Woe_Don_Vry_Sat".split("_"),weekdaysMin:"So_Ma_Di_Wo_Do_Vr_Sa".split("_"),meridiemParse:/vm|nm/i,isPM:function(input){return/^nm$/i.test(input)},meridiem:function(hours,minutes,isLower){return hours<12?isLower?"vm":"VM":isLower?"nm":"NM"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Vandag om] LT",nextDay:"[Mre om] LT",nextWeek:"dddd [om] LT",lastDay:"[Gister om] LT",lastWeek:"[Laas] dddd [om] LT",sameElse:"L"},relativeTime:{future:"oor %s",past:"%s gelede",s:"'n paar sekondes",ss:"%d sekondes",m:"'n minuut",mm:"%d minute",h:"'n uur",hh:"%d ure",d:"'n dag",dd:"%d dae",M:"'n maand",MM:"%d maande",y:"'n jaar",yy:"%d jaar"},dayOfMonthOrdinalParse:/\d{1,2}(ste|de)/,ordinal:function(number){return number+(1===number||8===number||number>=20?"ste":"de")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"},pluralForm=function(n){return 0===n?0:1===n?1:2===n?2:n%100>=3&&n%100<=10?3:n%100>=11?4:5},plurals={s:["  "," ",["",""],"%d ","%d ","%d "],m:["  "," ",["",""],"%d ","%d ","%d "],h:["  "," ",["",""],"%d ","%d ","%d "],d:["  "," ",["",""],"%d ","%d ","%d "],M:["  "," ",["",""],"%d ","%d ","%d "],y:["  "," ",["",""],"%d ","%d ","%d "]},pluralize=function(u){return function(number,withoutSuffix,string,isFuture){var f=pluralForm(number),str=plurals[u][pluralForm(number)];return 2===f&&(str=str[withoutSuffix?0:1]),str.replace(/%d/i,number)}},months=["","","","","","","","","","","",""];moment.defineLocale("ar",{months:months,monthsShort:months,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/M/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:pluralize("s"),ss:pluralize("s"),m:pluralize("m"),mm:pluralize("m"),h:pluralize("h"),hh:pluralize("h"),d:pluralize("d"),dd:pluralize("d"),M:pluralize("M"),MM:pluralize("M"),y:pluralize("y"),yy:pluralize("y")},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]})).replace(//g,",")},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]})).replace(/,/g,"")},week:{dow:6,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var pluralForm=function(n){return 0===n?0:1===n?1:2===n?2:n%100>=3&&n%100<=10?3:n%100>=11?4:5},plurals={s:["  "," ",["",""],"%d ","%d ","%d "],m:["  "," ",["",""],"%d ","%d ","%d "],h:["  "," ",["",""],"%d ","%d ","%d "],d:["  "," ",["",""],"%d ","%d ","%d "],M:["  "," ",["",""],"%d ","%d ","%d "],y:["  "," ",["",""],"%d ","%d ","%d "]},pluralize=function(u){return function(number,withoutSuffix,string,isFuture){var f=pluralForm(number),str=plurals[u][pluralForm(number)];return 2===f&&(str=str[withoutSuffix?0:1]),str.replace(/%d/i,number)}},months=["","","","","","","","","","","",""];moment.defineLocale("ar-dz",{months:months,monthsShort:months,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/M/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:pluralize("s"),ss:pluralize("s"),m:pluralize("m"),mm:pluralize("m"),h:pluralize("h"),hh:pluralize("h"),d:pluralize("d"),dd:pluralize("d"),M:pluralize("M"),MM:pluralize("M"),y:pluralize("y"),yy:pluralize("y")},postformat:function(string){return string.replace(/,/g,"")},week:{dow:0,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ar-kw",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},week:{dow:0,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"1",2:"2",3:"3",4:"4",5:"5",6:"6",7:"7",8:"8",9:"9",0:"0"},pluralForm=function(n){return 0===n?0:1===n?1:2===n?2:n%100>=3&&n%100<=10?3:n%100>=11?4:5},plurals={s:["  "," ",["",""],"%d ","%d ","%d "],m:["  "," ",["",""],"%d ","%d ","%d "],h:["  "," ",["",""],"%d ","%d ","%d "],d:["  "," ",["",""],"%d ","%d ","%d "],M:["  "," ",["",""],"%d ","%d ","%d "],y:["  "," ",["",""],"%d ","%d ","%d "]},pluralize=function(u){return function(number,withoutSuffix,string,isFuture){var f=pluralForm(number),str=plurals[u][pluralForm(number)];return 2===f&&(str=str[withoutSuffix?0:1]),str.replace(/%d/i,number)}},months=["","","","","","","","","","","",""];moment.defineLocale("ar-ly",{months:months,monthsShort:months,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/M/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:pluralize("s"),ss:pluralize("s"),m:pluralize("m"),mm:pluralize("m"),h:pluralize("h"),hh:pluralize("h"),d:pluralize("d"),dd:pluralize("d"),M:pluralize("M"),MM:pluralize("M"),y:pluralize("y"),yy:pluralize("y")},preparse:function(string){return string.replace(//g,",")},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]})).replace(/,/g,"")},week:{dow:6,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ar-ma",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("ar-sa",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]})).replace(//g,",")},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]})).replace(/,/g,"")},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ar-tn",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[  ] LT",nextDay:"[  ] LT",nextWeek:"dddd [ ] LT",lastDay:"[  ] LT",lastWeek:"dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var suffixes={1:"-inci",5:"-inci",8:"-inci",70:"-inci",80:"-inci",2:"-nci",7:"-nci",20:"-nci",50:"-nci",3:"-nc",4:"-nc",100:"-nc",6:"-nc",9:"-uncu",10:"-uncu",30:"-uncu",60:"-nc",90:"-nc"};moment.defineLocale("az",{months:"yanvar_fevral_mart_aprel_may_iyun_iyul_avqust_sentyabr_oktyabr_noyabr_dekabr".split("_"),monthsShort:"yan_fev_mar_apr_may_iyn_iyl_avq_sen_okt_noy_dek".split("_"),weekdays:"Bazar_Bazar ertsi_rnb axam_rnb_Cm axam_Cm_nb".split("_"),weekdaysShort:"Baz_BzE_Ax_r_CAx_Cm_n".split("_"),weekdaysMin:"Bz_BE_A__CA_C_".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[bugn saat] LT",nextDay:"[sabah saat] LT",nextWeek:"[gln hft] dddd [saat] LT",lastDay:"[dnn] LT",lastWeek:"[ken hft] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s sonra",past:"%s vvl",s:"bir ne saniy",ss:"%d saniy",m:"bir dqiq",mm:"%d dqiq",h:"bir saat",hh:"%d saat",d:"bir gn",dd:"%d gn",M:"bir ay",MM:"%d ay",y:"bir il",yy:"%d il"},meridiemParse:/gec|shr|gndz|axam/,isPM:function(input){return/^(gndz|axam)$/.test(input)},meridiem:function(hour,minute,isLower){return hour<4?"gec":hour<12?"shr":hour<17?"gndz":"axam"},dayOfMonthOrdinalParse:/\d{1,2}-(nc|inci|nci|nc|nc|uncu)/,ordinal:function(number){if(0===number)return number+"-nc";var a=number%10;return number+(suffixes[a]||suffixes[number%100-a]||suffixes[number>=100?100:null])},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function relativeTimeWithPlural(number,withoutSuffix,key){var num,forms;return"m"===key?withoutSuffix?"":"":"h"===key?withoutSuffix?"":"":number+" "+(num=+number,forms={ss:withoutSuffix?"__":"__",mm:withoutSuffix?"__":"__",hh:withoutSuffix?"__":"__",dd:"__",MM:"__",yy:"__"}[key].split("_"),num%10==1&&num%100!=11?forms[0]:num%10>=2&&num%10<=4&&(num%100<10||num%100>=20)?forms[1]:forms[2])}moment.defineLocale("be",{months:{format:"___________".split("_"),standalone:"___________".split("_")},monthsShort:"___________".split("_"),weekdays:{format:"______".split("_"),standalone:"______".split("_"),isFormat:/\[ ?[] ?(?:|)? ?\] ?dddd/},weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY .",LLL:"D MMMM YYYY ., HH:mm",LLLL:"dddd, D MMMM YYYY ., HH:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",lastDay:"[ ] LT",nextWeek:function(){return"[] dddd [] LT"},lastWeek:function(){switch(this.day()){case 0:case 3:case 5:case 6:return"[ ] dddd [] LT";case 1:case 2:case 4:return"[ ] dddd [] LT"}},sameElse:"L"},relativeTime:{future:" %s",past:"%s ",s:" ",m:relativeTimeWithPlural,mm:relativeTimeWithPlural,h:relativeTimeWithPlural,hh:relativeTimeWithPlural,d:"",dd:relativeTimeWithPlural,M:"",MM:relativeTimeWithPlural,y:"",yy:relativeTimeWithPlural},meridiemParse:/|||/,isPM:function(input){return/^(|)$/.test(input)},meridiem:function(hour,minute,isLower){return hour<4?"":hour<12?"":hour<17?"":""},dayOfMonthOrdinalParse:/\d{1,2}-(||)/,ordinal:function(number,period){switch(period){case"M":case"d":case"DDD":case"w":case"W":return number%10!=2&&number%10!=3||number%100==12||number%100==13?number+"-":number+"-";case"D":return number+"-";default:return number}},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("bg",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"D.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[] dddd [] LT";case 1:case 2:case 4:case 5:return"[] dddd [] LT"}},sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:" ",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",w:"",ww:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}-(|||||)/,ordinal:function(number){var lastDigit=number%10,last2Digits=number%100;return 0===number?number+"-":0===last2Digits?number+"-":last2Digits>10&&last2Digits<20?number+"-":1===lastDigit?number+"-":2===lastDigit?number+"-":7===lastDigit||8===lastDigit?number+"-":number+"-"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("bm",{months:"Zanwuyekalo_Fewuruyekalo_Marisikalo_Awirilikalo_Mkalo_Zuwnkalo_Zuluyekalo_Utikalo_Stanburukalo_kutburukalo_Nowanburukalo_Desanburukalo".split("_"),monthsShort:"Zan_Few_Mar_Awi_M_Zuw_Zul_Uti_St_ku_Now_Des".split("_"),weekdays:"Kari_Ntnn_Tarata_Araba_Alamisa_Juma_Sibiri".split("_"),weekdaysShort:"Kar_Nt_Tar_Ara_Ala_Jum_Sib".split("_"),weekdaysMin:"Ka_Nt_Ta_Ar_Al_Ju_Si".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"MMMM [tile] D [san] YYYY",LLL:"MMMM [tile] D [san] YYYY [lr] HH:mm",LLLL:"dddd MMMM [tile] D [san] YYYY [lr] HH:mm"},calendar:{sameDay:"[Bi lr] LT",nextDay:"[Sini lr] LT",nextWeek:"dddd [don lr] LT",lastDay:"[Kunu lr] LT",lastWeek:"dddd [tmnen lr] LT",sameElse:"L"},relativeTime:{future:"%s kn",past:"a b %s b",s:"sanga dama dama",ss:"sekondi %d",m:"miniti kelen",mm:"miniti %d",h:"lr kelen",hh:"lr %d",d:"tile kelen",dd:"tile %d",M:"kalo kelen",MM:"kalo %d",y:"san kelen",yy:"san %d"},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("bn",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem&&hour>=4||""===meridiem&&hour<5||""===meridiem?hour+12:hour},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("bn-bd",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/||||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem||""===meridiem?hour:""===meridiem?hour>=3?hour:hour+12:""===meridiem||""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<6?"":hour<12?"":hour<15?"":hour<18?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("bo",{months:"___________".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),monthsShortRegex:/^(\d{1,2})/,monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm",LTS:"A h:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm",LLLL:"dddd, D MMMM YYYY, A h:mm"},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[], LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem&&hour>=4||""===meridiem&&hour<5||""===meridiem?hour+12:hour},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function relativeTimeWithMutation(number,withoutSuffix,key){return number+" "+function(text,number){return 2===number?function(text){var mutationTable={m:"v",b:"v",d:"z"};return void 0===mutationTable[text.charAt(0)]?text:mutationTable[text.charAt(0)]+text.substring(1)}(text):text}({mm:"munutenn",MM:"miz",dd:"devezh"}[key],number)}var monthsParse=[/^gen/i,/^c[\']hwe/i,/^meu/i,/^ebr/i,/^mae/i,/^(mez|eve)/i,/^gou/i,/^eos/i,/^gwe/i,/^her/i,/^du/i,/^ker/i],monthsRegex=/^(genver|c[\']hwevrer|meurzh|ebrel|mae|mezheven|gouere|eost|gwengolo|here|du|kerzu|gen|c[\']hwe|meu|ebr|mae|eve|gou|eos|gwe|her|du|ker)/i,minWeekdaysParse=[/^Su/i,/^Lu/i,/^Me([^r]|$)/i,/^Mer/i,/^Ya/i,/^Gw/i,/^Sa/i];moment.defineLocale("br",{months:"Genver_Chwevrer_Meurzh_Ebrel_Mae_Mezheven_Gouere_Eost_Gwengolo_Here_Du_Kerzu".split("_"),monthsShort:"Gen_Chwe_Meu_Ebr_Mae_Eve_Gou_Eos_Gwe_Her_Du_Ker".split("_"),weekdays:"Sul_Lun_Meurzh_Mercher_Yaou_Gwener_Sadorn".split("_"),weekdaysShort:"Sul_Lun_Meu_Mer_Yao_Gwe_Sad".split("_"),weekdaysMin:"Su_Lu_Me_Mer_Ya_Gw_Sa".split("_"),weekdaysParse:minWeekdaysParse,fullWeekdaysParse:[/^sul/i,/^lun/i,/^meurzh/i,/^merc[\']her/i,/^yaou/i,/^gwener/i,/^sadorn/i],shortWeekdaysParse:[/^Sul/i,/^Lun/i,/^Meu/i,/^Mer/i,/^Yao/i,/^Gwe/i,/^Sad/i],minWeekdaysParse:minWeekdaysParse,monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(genver|c[\']hwevrer|meurzh|ebrel|mae|mezheven|gouere|eost|gwengolo|here|du|kerzu)/i,monthsShortStrictRegex:/^(gen|c[\']hwe|meu|ebr|mae|eve|gou|eos|gwe|her|du|ker)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D [a viz] MMMM YYYY",LLL:"D [a viz] MMMM YYYY HH:mm",LLLL:"dddd, D [a viz] MMMM YYYY HH:mm"},calendar:{sameDay:"[Hiziv da] LT",nextDay:"[Warchoazh da] LT",nextWeek:"dddd [da] LT",lastDay:"[Dech da] LT",lastWeek:"dddd [paset da] LT",sameElse:"L"},relativeTime:{future:"a-benn %s",past:"%s zo",s:"un nebeud segondenno",ss:"%d eilenn",m:"ur vunutenn",mm:relativeTimeWithMutation,h:"un eur",hh:"%d eur",d:"un devezh",dd:relativeTimeWithMutation,M:"ur miz",MM:relativeTimeWithMutation,y:"ur bloaz",yy:function(number){switch(function lastNumber(number){return number>9?lastNumber(number%10):number}(number)){case 1:case 3:case 4:case 5:case 9:return number+" bloaz";default:return number+" vloaz"}}},dayOfMonthOrdinalParse:/\d{1,2}(a|vet)/,ordinal:function(number){return number+(1===number?"a":"vet")},week:{dow:1,doy:4},meridiemParse:/a.m.|g.m./,isPM:function(token){return"g.m."===token},meridiem:function(hour,minute,isLower){return hour<12?"a.m.":"g.m."}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"ss":return result+=1===number?"sekunda":2===number||3===number||4===number?"sekunde":"sekundi";case"m":return withoutSuffix?"jedna minuta":"jedne minute";case"mm":return result+=1===number?"minuta":2===number||3===number||4===number?"minute":"minuta";case"h":return withoutSuffix?"jedan sat":"jednog sata";case"hh":return result+=1===number?"sat":2===number||3===number||4===number?"sata":"sati";case"dd":return result+=1===number?"dan":"dana";case"MM":return result+=1===number?"mjesec":2===number||3===number||4===number?"mjeseca":"mjeseci";case"yy":return result+=1===number?"godina":2===number||3===number||4===number?"godine":"godina"}}moment.defineLocale("bs",{months:"januar_februar_mart_april_maj_juni_juli_august_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj._jun._jul._aug._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedjelja_ponedjeljak_utorak_srijeda_etvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._et._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_e_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[juer u] LT",lastWeek:function(){switch(this.day()){case 0:case 3:return"[prolu] dddd [u] LT";case 6:return"[prole] [subote] [u] LT";case 1:case 2:case 4:case 5:return"[proli] dddd [u] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"par sekundi",ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:"dan",dd:translate,M:"mjesec",MM:translate,y:"godinu",yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ca",{months:{standalone:"gener_febrer_mar_abril_maig_juny_juliol_agost_setembre_octubre_novembre_desembre".split("_"),format:"de gener_de febrer_de mar_d'abril_de maig_de juny_de juliol_d'agost_de setembre_d'octubre_de novembre_de desembre".split("_"),isFormat:/D[oD]?(\s)+MMMM/},monthsShort:"gen._febr._mar_abr._maig_juny_jul._ag._set._oct._nov._des.".split("_"),monthsParseExact:!0,weekdays:"diumenge_dilluns_dimarts_dimecres_dijous_divendres_dissabte".split("_"),weekdaysShort:"dg._dl._dt._dc._dj._dv._ds.".split("_"),weekdaysMin:"dg_dl_dt_dc_dj_dv_ds".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [de] YYYY",ll:"D MMM YYYY",LLL:"D MMMM [de] YYYY [a les] H:mm",lll:"D MMM YYYY, H:mm",LLLL:"dddd D MMMM [de] YYYY [a les] H:mm",llll:"ddd D MMM YYYY, H:mm"},calendar:{sameDay:function(){return"[avui a "+(1!==this.hours()?"les":"la")+"] LT"},nextDay:function(){return"[dem a "+(1!==this.hours()?"les":"la")+"] LT"},nextWeek:function(){return"dddd [a "+(1!==this.hours()?"les":"la")+"] LT"},lastDay:function(){return"[ahir a "+(1!==this.hours()?"les":"la")+"] LT"},lastWeek:function(){return"[el] dddd [passat a "+(1!==this.hours()?"les":"la")+"] LT"},sameElse:"L"},relativeTime:{future:"d'aqu %s",past:"fa %s",s:"uns segons",ss:"%d segons",m:"un minut",mm:"%d minuts",h:"una hora",hh:"%d hores",d:"un dia",dd:"%d dies",M:"un mes",MM:"%d mesos",y:"un any",yy:"%d anys"},dayOfMonthOrdinalParse:/\d{1,2}(r|n|t||a)/,ordinal:function(number,period){var output=1===number?"r":2===number?"n":3===number?"r":4===number?"t":"";return"w"!==period&&"W"!==period||(output="a"),number+output},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var months="leden_nor_bezen_duben_kvten_erven_ervenec_srpen_z_jen_listopad_prosinec".split("_"),monthsShort="led_no_be_dub_kv_vn_vc_srp_z_j_lis_pro".split("_"),monthsParse=[/^led/i,/^no/i,/^be/i,/^dub/i,/^kv/i,/^(vn|erven$|ervna)/i,/^(vc|ervenec|ervence)/i,/^srp/i,/^z/i,/^j/i,/^lis/i,/^pro/i],monthsRegex=/^(leden|nor|bezen|duben|kvten|ervenec|ervence|erven|ervna|srpen|z|jen|listopad|prosinec|led|no|be|dub|kv|vn|vc|srp|z|j|lis|pro)/i;function plural(n){return n>1&&n<5&&1!=~~(n/10)}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"pr sekund":"pr sekundami";case"ss":return withoutSuffix||isFuture?result+(plural(number)?"sekundy":"sekund"):result+"sekundami";case"m":return withoutSuffix?"minuta":isFuture?"minutu":"minutou";case"mm":return withoutSuffix||isFuture?result+(plural(number)?"minuty":"minut"):result+"minutami";case"h":return withoutSuffix?"hodina":isFuture?"hodinu":"hodinou";case"hh":return withoutSuffix||isFuture?result+(plural(number)?"hodiny":"hodin"):result+"hodinami";case"d":return withoutSuffix||isFuture?"den":"dnem";case"dd":return withoutSuffix||isFuture?result+(plural(number)?"dny":"dn"):result+"dny";case"M":return withoutSuffix||isFuture?"msc":"mscem";case"MM":return withoutSuffix||isFuture?result+(plural(number)?"msce":"msc"):result+"msci";case"y":return withoutSuffix||isFuture?"rok":"rokem";case"yy":return withoutSuffix||isFuture?result+(plural(number)?"roky":"let"):result+"lety"}}moment.defineLocale("cs",{months:months,monthsShort:monthsShort,monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(leden|ledna|nora|nor|bezen|bezna|duben|dubna|kvten|kvtna|ervenec|ervence|erven|ervna|srpen|srpna|z|jen|jna|listopadu|listopad|prosinec|prosince)/i,monthsShortStrictRegex:/^(led|no|be|dub|kv|vn|vc|srp|z|j|lis|pro)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"nedle_pondl_ter_steda_tvrtek_ptek_sobota".split("_"),weekdaysShort:"ne_po_t_st_t_p_so".split("_"),weekdaysMin:"ne_po_t_st_t_p_so".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd D. MMMM YYYY H:mm",l:"D. M. YYYY"},calendar:{sameDay:"[dnes v] LT",nextDay:"[ztra v] LT",nextWeek:function(){switch(this.day()){case 0:return"[v nedli v] LT";case 1:case 2:return"[v] dddd [v] LT";case 3:return"[ve stedu v] LT";case 4:return"[ve tvrtek v] LT";case 5:return"[v ptek v] LT";case 6:return"[v sobotu v] LT"}},lastDay:"[vera v] LT",lastWeek:function(){switch(this.day()){case 0:return"[minulou nedli v] LT";case 1:case 2:return"[minul] dddd [v] LT";case 3:return"[minulou stedu v] LT";case 4:case 5:return"[minul] dddd [v] LT";case 6:return"[minulou sobotu v] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"ped %s",s:translate,ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("cv",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"YYYY [] MMMM [] D[-]",LLL:"YYYY [] MMMM [] D[-], HH:mm",LLLL:"dddd, YYYY [] MMMM [] D[-], HH:mm"},calendar:{sameDay:"[] LT []",nextDay:"[] LT []",lastDay:"[] LT []",nextWeek:"[] dddd LT []",lastWeek:"[] dddd LT []",sameElse:"L"},relativeTime:{future:function(output){return output+(/$/i.exec(output)?"":/$/i.exec(output)?"":"")},past:"%s ",s:"- ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}-/,ordinal:"%d-",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("cy",{months:"Ionawr_Chwefror_Mawrth_Ebrill_Mai_Mehefin_Gorffennaf_Awst_Medi_Hydref_Tachwedd_Rhagfyr".split("_"),monthsShort:"Ion_Chwe_Maw_Ebr_Mai_Meh_Gor_Aws_Med_Hyd_Tach_Rhag".split("_"),weekdays:"Dydd Sul_Dydd Llun_Dydd Mawrth_Dydd Mercher_Dydd Iau_Dydd Gwener_Dydd Sadwrn".split("_"),weekdaysShort:"Sul_Llun_Maw_Mer_Iau_Gwe_Sad".split("_"),weekdaysMin:"Su_Ll_Ma_Me_Ia_Gw_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Heddiw am] LT",nextDay:"[Yfory am] LT",nextWeek:"dddd [am] LT",lastDay:"[Ddoe am] LT",lastWeek:"dddd [diwethaf am] LT",sameElse:"L"},relativeTime:{future:"mewn %s",past:"%s yn l",s:"ychydig eiliadau",ss:"%d eiliad",m:"munud",mm:"%d munud",h:"awr",hh:"%d awr",d:"diwrnod",dd:"%d diwrnod",M:"mis",MM:"%d mis",y:"blwyddyn",yy:"%d flynedd"},dayOfMonthOrdinalParse:/\d{1,2}(fed|ain|af|il|ydd|ed|eg)/,ordinal:function(number){var output="";return number>20?output=40===number||50===number||60===number||80===number||100===number?"fed":"ain":number>0&&(output=["","af","il","ydd","ydd","ed","ed","ed","fed","fed","fed","eg","fed","eg","eg","fed","eg","eg","fed","eg","fed"][number]),number+output},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("da",{months:"januar_februar_marts_april_maj_juni_juli_august_september_oktober_november_december".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec".split("_"),weekdays:"sndag_mandag_tirsdag_onsdag_torsdag_fredag_lrdag".split("_"),weekdaysShort:"sn_man_tir_ons_tor_fre_lr".split("_"),weekdaysMin:"s_ma_ti_on_to_fr_l".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd [d.] D. MMMM YYYY [kl.] HH:mm"},calendar:{sameDay:"[i dag kl.] LT",nextDay:"[i morgen kl.] LT",nextWeek:"p dddd [kl.] LT",lastDay:"[i gr kl.] LT",lastWeek:"[i] dddd[s kl.] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s siden",s:"f sekunder",ss:"%d sekunder",m:"et minut",mm:"%d minutter",h:"en time",hh:"%d timer",d:"en dag",dd:"%d dage",M:"en mned",MM:"%d mneder",y:"et r",yy:"%d r"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={m:["eine Minute","einer Minute"],h:["eine Stunde","einer Stunde"],d:["ein Tag","einem Tag"],dd:[number+" Tage",number+" Tagen"],w:["eine Woche","einer Woche"],M:["ein Monat","einem Monat"],MM:[number+" Monate",number+" Monaten"],y:["ein Jahr","einem Jahr"],yy:[number+" Jahre",number+" Jahren"]};return withoutSuffix?format[key][0]:format[key][1]}moment.defineLocale("de",{months:"Januar_Februar_Mrz_April_Mai_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Feb._Mrz_Apr._Mai_Juni_Juli_Aug._Sep._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonntag_Montag_Dienstag_Mittwoch_Donnerstag_Freitag_Samstag".split("_"),weekdaysShort:"So._Mo._Di._Mi._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd, D. MMMM YYYY HH:mm"},calendar:{sameDay:"[heute um] LT [Uhr]",sameElse:"L",nextDay:"[morgen um] LT [Uhr]",nextWeek:"dddd [um] LT [Uhr]",lastDay:"[gestern um] LT [Uhr]",lastWeek:"[letzten] dddd [um] LT [Uhr]"},relativeTime:{future:"in %s",past:"vor %s",s:"ein paar Sekunden",ss:"%d Sekunden",m:processRelativeTime,mm:"%d Minuten",h:processRelativeTime,hh:"%d Stunden",d:processRelativeTime,dd:processRelativeTime,w:processRelativeTime,ww:"%d Wochen",M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={m:["eine Minute","einer Minute"],h:["eine Stunde","einer Stunde"],d:["ein Tag","einem Tag"],dd:[number+" Tage",number+" Tagen"],w:["eine Woche","einer Woche"],M:["ein Monat","einem Monat"],MM:[number+" Monate",number+" Monaten"],y:["ein Jahr","einem Jahr"],yy:[number+" Jahre",number+" Jahren"]};return withoutSuffix?format[key][0]:format[key][1]}moment.defineLocale("de-at",{months:"Jnner_Februar_Mrz_April_Mai_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jn._Feb._Mrz_Apr._Mai_Juni_Juli_Aug._Sep._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonntag_Montag_Dienstag_Mittwoch_Donnerstag_Freitag_Samstag".split("_"),weekdaysShort:"So._Mo._Di._Mi._Do._Fr._Sa.".split("_"),weekdaysMin:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd, D. MMMM YYYY HH:mm"},calendar:{sameDay:"[heute um] LT [Uhr]",sameElse:"L",nextDay:"[morgen um] LT [Uhr]",nextWeek:"dddd [um] LT [Uhr]",lastDay:"[gestern um] LT [Uhr]",lastWeek:"[letzten] dddd [um] LT [Uhr]"},relativeTime:{future:"in %s",past:"vor %s",s:"ein paar Sekunden",ss:"%d Sekunden",m:processRelativeTime,mm:"%d Minuten",h:processRelativeTime,hh:"%d Stunden",d:processRelativeTime,dd:processRelativeTime,w:processRelativeTime,ww:"%d Wochen",M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={m:["eine Minute","einer Minute"],h:["eine Stunde","einer Stunde"],d:["ein Tag","einem Tag"],dd:[number+" Tage",number+" Tagen"],w:["eine Woche","einer Woche"],M:["ein Monat","einem Monat"],MM:[number+" Monate",number+" Monaten"],y:["ein Jahr","einem Jahr"],yy:[number+" Jahre",number+" Jahren"]};return withoutSuffix?format[key][0]:format[key][1]}moment.defineLocale("de-ch",{months:"Januar_Februar_Mrz_April_Mai_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Feb._Mrz_Apr._Mai_Juni_Juli_Aug._Sep._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonntag_Montag_Dienstag_Mittwoch_Donnerstag_Freitag_Samstag".split("_"),weekdaysShort:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),weekdaysMin:"So_Mo_Di_Mi_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY HH:mm",LLLL:"dddd, D. MMMM YYYY HH:mm"},calendar:{sameDay:"[heute um] LT [Uhr]",sameElse:"L",nextDay:"[morgen um] LT [Uhr]",nextWeek:"dddd [um] LT [Uhr]",lastDay:"[gestern um] LT [Uhr]",lastWeek:"[letzten] dddd [um] LT [Uhr]"},relativeTime:{future:"in %s",past:"vor %s",s:"ein paar Sekunden",ss:"%d Sekunden",m:processRelativeTime,mm:"%d Minuten",h:processRelativeTime,hh:"%d Stunden",d:processRelativeTime,dd:processRelativeTime,w:processRelativeTime,ww:"%d Wochen",M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var months=["","","","","","","","","","","",""],weekdays=["","","","","","",""];moment.defineLocale("dv",{months:months,monthsShort:months,weekdays:weekdays,weekdaysShort:weekdays,weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"D/M/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd LT",lastDay:"[] LT",lastWeek:"[] dddd LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:"",ss:"d% ",m:"",mm:" %d",h:"",hh:" %d",d:"",dd:" %d",M:"",MM:" %d",y:"",yy:" %d"},preparse:function(string){return string.replace(//g,",")},postformat:function(string){return string.replace(/,/g,"")},week:{dow:7,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("el",{monthsNominativeEl:"___________".split("_"),monthsGenitiveEl:"___________".split("_"),months:function(momentToFormat,format){return momentToFormat?"string"==typeof format&&/D/.test(format.substring(0,format.indexOf("MMMM")))?this._monthsGenitiveEl[momentToFormat.month()]:this._monthsNominativeEl[momentToFormat.month()]:this._monthsNominativeEl},monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),meridiem:function(hours,minutes,isLower){return hours>11?isLower?"":"":isLower?"":""},isPM:function(input){return""===(input+"").toLowerCase()[0]},meridiemParse:/[]\.??\.?/i,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendarEl:{sameDay:"[ {}] LT",nextDay:"[ {}] LT",nextWeek:"dddd [{}] LT",lastDay:"[ {}] LT",lastWeek:function(){switch(this.day()){case 6:return"[ ] dddd [{}] LT";default:return"[ ] dddd [{}] LT"}},sameElse:"L"},calendar:function(key,mom){var input,output=this._calendarEl[key],hours=mom&&mom.hours();return input=output,("undefined"!=typeof Function&&input instanceof Function||"[object Function]"===Object.prototype.toString.call(input))&&(output=output.apply(mom)),output.replace("{}",hours%12==1?"":"")},relativeTime:{future:" %s",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-au",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:0,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-ca",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"YYYY-MM-DD",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-gb",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-ie",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-il",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-in",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-nz",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("en-sg",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("eo",{months:"januaro_februaro_marto_aprilo_majo_junio_julio_agusto_septembro_oktobro_novembro_decembro".split("_"),monthsShort:"jan_feb_mart_apr_maj_jun_jul_ag_sept_okt_nov_dec".split("_"),weekdays:"dimano_lundo_mardo_merkredo_ado_vendredo_sabato".split("_"),weekdaysShort:"dim_lun_mard_merk_a_ven_sab".split("_"),weekdaysMin:"di_lu_ma_me_a_ve_sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"[la] D[-an de] MMMM, YYYY",LLL:"[la] D[-an de] MMMM, YYYY HH:mm",LLLL:"dddd[n], [la] D[-an de] MMMM, YYYY HH:mm",llll:"ddd, [la] D[-an de] MMM, YYYY HH:mm"},meridiemParse:/[ap]\.t\.m/i,isPM:function(input){return"p"===input.charAt(0).toLowerCase()},meridiem:function(hours,minutes,isLower){return hours>11?isLower?"p.t.m.":"P.T.M.":isLower?"a.t.m.":"A.T.M."},calendar:{sameDay:"[Hodia je] LT",nextDay:"[Morga je] LT",nextWeek:"dddd[n je] LT",lastDay:"[Hiera je] LT",lastWeek:"[pasintan] dddd[n je] LT",sameElse:"L"},relativeTime:{future:"post %s",past:"anta %s",s:"kelkaj sekundoj",ss:"%d sekundoj",m:"unu minuto",mm:"%d minutoj",h:"unu horo",hh:"%d horoj",d:"unu tago",dd:"%d tagoj",M:"unu monato",MM:"%d monatoj",y:"unu jaro",yy:"%d jaroj"},dayOfMonthOrdinalParse:/\d{1,2}a/,ordinal:"%da",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortDot="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),monthsShort="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_"),monthsParse=[/^ene/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i],monthsRegex=/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i;moment.defineLocale("es",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShort[m.month()]:monthsShortDot[m.month()]:monthsShortDot},monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i,monthsShortStrictRegex:/^(ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"domingo_lunes_martes_mircoles_jueves_viernes_sbado".split("_"),weekdaysShort:"dom._lun._mar._mi._jue._vie._sb.".split("_"),weekdaysMin:"do_lu_ma_mi_ju_vi_s".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY H:mm",LLLL:"dddd, D [de] MMMM [de] YYYY H:mm"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[maana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(1!==this.hours()?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",ss:"%d segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un da",dd:"%d das",w:"una semana",ww:"%d semanas",M:"un mes",MM:"%d meses",y:"un ao",yy:"%d aos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4},invalidDate:"Fecha invlida"})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortDot="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),monthsShort="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_"),monthsParse=[/^ene/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i],monthsRegex=/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i;moment.defineLocale("es-do",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShort[m.month()]:monthsShortDot[m.month()]:monthsShortDot},monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i,monthsShortStrictRegex:/^(ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"domingo_lunes_martes_mircoles_jueves_viernes_sbado".split("_"),weekdaysShort:"dom._lun._mar._mi._jue._vie._sb.".split("_"),weekdaysMin:"do_lu_ma_mi_ju_vi_s".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY h:mm A",LLLL:"dddd, D [de] MMMM [de] YYYY h:mm A"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[maana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(1!==this.hours()?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",ss:"%d segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un da",dd:"%d das",w:"una semana",ww:"%d semanas",M:"un mes",MM:"%d meses",y:"un ao",yy:"%d aos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortDot="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),monthsShort="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_"),monthsParse=[/^ene/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i],monthsRegex=/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i;moment.defineLocale("es-mx",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShort[m.month()]:monthsShortDot[m.month()]:monthsShortDot},monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i,monthsShortStrictRegex:/^(ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"domingo_lunes_martes_mircoles_jueves_viernes_sbado".split("_"),weekdaysShort:"dom._lun._mar._mi._jue._vie._sb.".split("_"),weekdaysMin:"do_lu_ma_mi_ju_vi_s".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY H:mm",LLLL:"dddd, D [de] MMMM [de] YYYY H:mm"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[maana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(1!==this.hours()?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",ss:"%d segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un da",dd:"%d das",w:"una semana",ww:"%d semanas",M:"un mes",MM:"%d meses",y:"un ao",yy:"%d aos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:0,doy:4},invalidDate:"Fecha invlida"})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortDot="ene._feb._mar._abr._may._jun._jul._ago._sep._oct._nov._dic.".split("_"),monthsShort="ene_feb_mar_abr_may_jun_jul_ago_sep_oct_nov_dic".split("_"),monthsParse=[/^ene/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i],monthsRegex=/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre|ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i;moment.defineLocale("es-us",{months:"enero_febrero_marzo_abril_mayo_junio_julio_agosto_septiembre_octubre_noviembre_diciembre".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShort[m.month()]:monthsShortDot[m.month()]:monthsShortDot},monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i,monthsShortStrictRegex:/^(ene\.?|feb\.?|mar\.?|abr\.?|may\.?|jun\.?|jul\.?|ago\.?|sep\.?|oct\.?|nov\.?|dic\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"domingo_lunes_martes_mircoles_jueves_viernes_sbado".split("_"),weekdaysShort:"dom._lun._mar._mi._jue._vie._sb.".split("_"),weekdaysMin:"do_lu_ma_mi_ju_vi_s".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"MM/DD/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY h:mm A",LLLL:"dddd, D [de] MMMM [de] YYYY h:mm A"},calendar:{sameDay:function(){return"[hoy a la"+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[maana a la"+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd [a la"+(1!==this.hours()?"s":"")+"] LT"},lastDay:function(){return"[ayer a la"+(1!==this.hours()?"s":"")+"] LT"},lastWeek:function(){return"[el] dddd [pasado a la"+(1!==this.hours()?"s":"")+"] LT"},sameElse:"L"},relativeTime:{future:"en %s",past:"hace %s",s:"unos segundos",ss:"%d segundos",m:"un minuto",mm:"%d minutos",h:"una hora",hh:"%d horas",d:"un da",dd:"%d das",w:"una semana",ww:"%d semanas",M:"un mes",MM:"%d meses",y:"un ao",yy:"%d aos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={s:["mne sekundi","mni sekund","paar sekundit"],ss:[number+"sekundi",number+"sekundit"],m:["he minuti","ks minut"],mm:[number+" minuti",number+" minutit"],h:["he tunni","tund aega","ks tund"],hh:[number+" tunni",number+" tundi"],d:["he peva","ks pev"],M:["kuu aja","kuu aega","ks kuu"],MM:[number+" kuu",number+" kuud"],y:["he aasta","aasta","ks aasta"],yy:[number+" aasta",number+" aastat"]};return withoutSuffix?format[key][2]?format[key][2]:format[key][1]:isFuture?format[key][0]:format[key][1]}moment.defineLocale("et",{months:"jaanuar_veebruar_mrts_aprill_mai_juuni_juuli_august_september_oktoober_november_detsember".split("_"),monthsShort:"jaan_veebr_mrts_apr_mai_juuni_juuli_aug_sept_okt_nov_dets".split("_"),weekdays:"phapev_esmaspev_teisipev_kolmapev_neljapev_reede_laupev".split("_"),weekdaysShort:"P_E_T_K_N_R_L".split("_"),weekdaysMin:"P_E_T_K_N_R_L".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[Tna,] LT",nextDay:"[Homme,] LT",nextWeek:"[Jrgmine] dddd LT",lastDay:"[Eile,] LT",lastWeek:"[Eelmine] dddd LT",sameElse:"L"},relativeTime:{future:"%s prast",past:"%s tagasi",s:processRelativeTime,ss:processRelativeTime,m:processRelativeTime,mm:processRelativeTime,h:processRelativeTime,hh:processRelativeTime,d:processRelativeTime,dd:"%d peva",M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("eu",{months:"urtarrila_otsaila_martxoa_apirila_maiatza_ekaina_uztaila_abuztua_iraila_urria_azaroa_abendua".split("_"),monthsShort:"urt._ots._mar._api._mai._eka._uzt._abu._ira._urr._aza._abe.".split("_"),monthsParseExact:!0,weekdays:"igandea_astelehena_asteartea_asteazkena_osteguna_ostirala_larunbata".split("_"),weekdaysShort:"ig._al._ar._az._og._ol._lr.".split("_"),weekdaysMin:"ig_al_ar_az_og_ol_lr".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"YYYY[ko] MMMM[ren] D[a]",LLL:"YYYY[ko] MMMM[ren] D[a] HH:mm",LLLL:"dddd, YYYY[ko] MMMM[ren] D[a] HH:mm",l:"YYYY-M-D",ll:"YYYY[ko] MMM D[a]",lll:"YYYY[ko] MMM D[a] HH:mm",llll:"ddd, YYYY[ko] MMM D[a] HH:mm"},calendar:{sameDay:"[gaur] LT[etan]",nextDay:"[bihar] LT[etan]",nextWeek:"dddd LT[etan]",lastDay:"[atzo] LT[etan]",lastWeek:"[aurreko] dddd LT[etan]",sameElse:"L"},relativeTime:{future:"%s barru",past:"duela %s",s:"segundo batzuk",ss:"%d segundo",m:"minutu bat",mm:"%d minutu",h:"ordu bat",hh:"%d ordu",d:"egun bat",dd:"%d egun",M:"hilabete bat",MM:"%d hilabete",y:"urte bat",yy:"%d urte"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("fa",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},meridiemParse:/  |  /,isPM:function(input){return/  /.test(input)},meridiem:function(hour,minute,isLower){return hour<12?"  ":"  "},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:"dddd [] [] LT",sameElse:"L"},relativeTime:{future:" %s",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[-]/g,(function(match){return numberMap[match]})).replace(//g,",")},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]})).replace(/,/g,"")},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:6,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var numbersPast="nolla yksi kaksi kolme nelj viisi kuusi seitsemn kahdeksan yhdeksn".split(" "),numbersFuture=["nolla","yhden","kahden","kolmen","neljn","viiden","kuuden",numbersPast[7],numbersPast[8],numbersPast[9]];function translate(number,withoutSuffix,key,isFuture){var result="";switch(key){case"s":return isFuture?"muutaman sekunnin":"muutama sekunti";case"ss":result=isFuture?"sekunnin":"sekuntia";break;case"m":return isFuture?"minuutin":"minuutti";case"mm":result=isFuture?"minuutin":"minuuttia";break;case"h":return isFuture?"tunnin":"tunti";case"hh":result=isFuture?"tunnin":"tuntia";break;case"d":return isFuture?"pivn":"piv";case"dd":result=isFuture?"pivn":"piv";break;case"M":return isFuture?"kuukauden":"kuukausi";case"MM":result=isFuture?"kuukauden":"kuukautta";break;case"y":return isFuture?"vuoden":"vuosi";case"yy":result=isFuture?"vuoden":"vuotta"}return result=function(number,isFuture){return number<10?isFuture?numbersFuture[number]:numbersPast[number]:number}(number,isFuture)+" "+result}moment.defineLocale("fi",{months:"tammikuu_helmikuu_maaliskuu_huhtikuu_toukokuu_keskuu_heinkuu_elokuu_syyskuu_lokakuu_marraskuu_joulukuu".split("_"),monthsShort:"tammi_helmi_maalis_huhti_touko_kes_hein_elo_syys_loka_marras_joulu".split("_"),weekdays:"sunnuntai_maanantai_tiistai_keskiviikko_torstai_perjantai_lauantai".split("_"),weekdaysShort:"su_ma_ti_ke_to_pe_la".split("_"),weekdaysMin:"su_ma_ti_ke_to_pe_la".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD.MM.YYYY",LL:"Do MMMM[ta] YYYY",LLL:"Do MMMM[ta] YYYY, [klo] HH.mm",LLLL:"dddd, Do MMMM[ta] YYYY, [klo] HH.mm",l:"D.M.YYYY",ll:"Do MMM YYYY",lll:"Do MMM YYYY, [klo] HH.mm",llll:"ddd, Do MMM YYYY, [klo] HH.mm"},calendar:{sameDay:"[tnn] [klo] LT",nextDay:"[huomenna] [klo] LT",nextWeek:"dddd [klo] LT",lastDay:"[eilen] [klo] LT",lastWeek:"[viime] dddd[na] [klo] LT",sameElse:"L"},relativeTime:{future:"%s pst",past:"%s sitten",s:translate,ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("fil",{months:"Enero_Pebrero_Marso_Abril_Mayo_Hunyo_Hulyo_Agosto_Setyembre_Oktubre_Nobyembre_Disyembre".split("_"),monthsShort:"Ene_Peb_Mar_Abr_May_Hun_Hul_Ago_Set_Okt_Nob_Dis".split("_"),weekdays:"Linggo_Lunes_Martes_Miyerkules_Huwebes_Biyernes_Sabado".split("_"),weekdaysShort:"Lin_Lun_Mar_Miy_Huw_Biy_Sab".split("_"),weekdaysMin:"Li_Lu_Ma_Mi_Hu_Bi_Sab".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"MM/D/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY HH:mm",LLLL:"dddd, MMMM DD, YYYY HH:mm"},calendar:{sameDay:"LT [ngayong araw]",nextDay:"[Bukas ng] LT",nextWeek:"LT [sa susunod na] dddd",lastDay:"LT [kahapon]",lastWeek:"LT [noong nakaraang] dddd",sameElse:"L"},relativeTime:{future:"sa loob ng %s",past:"%s ang nakalipas",s:"ilang segundo",ss:"%d segundo",m:"isang minuto",mm:"%d minuto",h:"isang oras",hh:"%d oras",d:"isang araw",dd:"%d araw",M:"isang buwan",MM:"%d buwan",y:"isang taon",yy:"%d taon"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:function(number){return number},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("fo",{months:"januar_februar_mars_aprl_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan_feb_mar_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_"),weekdays:"sunnudagur_mnadagur_tsdagur_mikudagur_hsdagur_frggjadagur_leygardagur".split("_"),weekdaysShort:"sun_mn_ts_mik_hs_fr_ley".split("_"),weekdaysMin:"su_m_t_mi_h_fr_le".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D. MMMM, YYYY HH:mm"},calendar:{sameDay:"[ dag kl.] LT",nextDay:"[ morgin kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[ gjr kl.] LT",lastWeek:"[sstu] dddd [kl] LT",sameElse:"L"},relativeTime:{future:"um %s",past:"%s sani",s:"f sekund",ss:"%d sekundir",m:"ein minuttur",mm:"%d minuttir",h:"ein tmi",hh:"%d tmar",d:"ein dagur",dd:"%d dagar",M:"ein mnaur",MM:"%d mnair",y:"eitt r",yy:"%d r"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsRegex=/(janv\.?|fvr\.?|mars|avr\.?|mai|juin|juil\.?|aot|sept\.?|oct\.?|nov\.?|dc\.?|janvier|fvrier|mars|avril|mai|juin|juillet|aot|septembre|octobre|novembre|dcembre)/i,monthsParse=[/^janv/i,/^fvr/i,/^mars/i,/^avr/i,/^mai/i,/^juin/i,/^juil/i,/^aot/i,/^sept/i,/^oct/i,/^nov/i,/^dc/i];moment.defineLocale("fr",{months:"janvier_fvrier_mars_avril_mai_juin_juillet_aot_septembre_octobre_novembre_dcembre".split("_"),monthsShort:"janv._fvr._mars_avr._mai_juin_juil._aot_sept._oct._nov._dc.".split("_"),monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(janvier|fvrier|mars|avril|mai|juin|juillet|aot|septembre|octobre|novembre|dcembre)/i,monthsShortStrictRegex:/(janv\.?|fvr\.?|mars|avr\.?|mai|juin|juil\.?|aot|sept\.?|oct\.?|nov\.?|dc\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"di_lu_ma_me_je_ve_sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourdhui ] LT",nextDay:"[Demain ] LT",nextWeek:"dddd [] LT",lastDay:"[Hier ] LT",lastWeek:"dddd [dernier ] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",ss:"%d secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",w:"une semaine",ww:"%d semaines",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},dayOfMonthOrdinalParse:/\d{1,2}(er|)/,ordinal:function(number,period){switch(period){case"D":return number+(1===number?"er":"");default:case"M":case"Q":case"DDD":case"d":return number+(1===number?"er":"e");case"w":case"W":return number+(1===number?"re":"e")}},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("fr-ca",{months:"janvier_fvrier_mars_avril_mai_juin_juillet_aot_septembre_octobre_novembre_dcembre".split("_"),monthsShort:"janv._fvr._mars_avr._mai_juin_juil._aot_sept._oct._nov._dc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"di_lu_ma_me_je_ve_sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourdhui ] LT",nextDay:"[Demain ] LT",nextWeek:"dddd [] LT",lastDay:"[Hier ] LT",lastWeek:"dddd [dernier ] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",ss:"%d secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},dayOfMonthOrdinalParse:/\d{1,2}(er|e)/,ordinal:function(number,period){switch(period){default:case"M":case"Q":case"D":case"DDD":case"d":return number+(1===number?"er":"e");case"w":case"W":return number+(1===number?"re":"e")}}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("fr-ch",{months:"janvier_fvrier_mars_avril_mai_juin_juillet_aot_septembre_octobre_novembre_dcembre".split("_"),monthsShort:"janv._fvr._mars_avr._mai_juin_juil._aot_sept._oct._nov._dc.".split("_"),monthsParseExact:!0,weekdays:"dimanche_lundi_mardi_mercredi_jeudi_vendredi_samedi".split("_"),weekdaysShort:"dim._lun._mar._mer._jeu._ven._sam.".split("_"),weekdaysMin:"di_lu_ma_me_je_ve_sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Aujourdhui ] LT",nextDay:"[Demain ] LT",nextWeek:"dddd [] LT",lastDay:"[Hier ] LT",lastWeek:"dddd [dernier ] LT",sameElse:"L"},relativeTime:{future:"dans %s",past:"il y a %s",s:"quelques secondes",ss:"%d secondes",m:"une minute",mm:"%d minutes",h:"une heure",hh:"%d heures",d:"un jour",dd:"%d jours",M:"un mois",MM:"%d mois",y:"un an",yy:"%d ans"},dayOfMonthOrdinalParse:/\d{1,2}(er|e)/,ordinal:function(number,period){switch(period){default:case"M":case"Q":case"D":case"DDD":case"d":return number+(1===number?"er":"e");case"w":case"W":return number+(1===number?"re":"e")}},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortWithDots="jan._feb._mrt._apr._mai_jun._jul._aug._sep._okt._nov._des.".split("_"),monthsShortWithoutDots="jan_feb_mrt_apr_mai_jun_jul_aug_sep_okt_nov_des".split("_");moment.defineLocale("fy",{months:"jannewaris_febrewaris_maart_april_maaie_juny_july_augustus_septimber_oktober_novimber_desimber".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShortWithoutDots[m.month()]:monthsShortWithDots[m.month()]:monthsShortWithDots},monthsParseExact:!0,weekdays:"snein_moandei_tiisdei_woansdei_tongersdei_freed_sneon".split("_"),weekdaysShort:"si._mo._ti._wo._to._fr._so.".split("_"),weekdaysMin:"Si_Mo_Ti_Wo_To_Fr_So".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[hjoed om] LT",nextDay:"[moarn om] LT",nextWeek:"dddd [om] LT",lastDay:"[juster om] LT",lastWeek:"[frne] dddd [om] LT",sameElse:"L"},relativeTime:{future:"oer %s",past:"%s lyn",s:"in pear sekonden",ss:"%d sekonden",m:"ien mint",mm:"%d minuten",h:"ien oere",hh:"%d oeren",d:"ien dei",dd:"%d dagen",M:"ien moanne",MM:"%d moannen",y:"ien jier",yy:"%d jierren"},dayOfMonthOrdinalParse:/\d{1,2}(ste|de)/,ordinal:function(number){return number+(1===number||8===number||number>=20?"ste":"de")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ga",{months:["Eanir","Feabhra","Mrta","Aibren","Bealtaine","Meitheamh","Iil","Lnasa","Men Fmhair","Deireadh Fmhair","Samhain","Nollaig"],monthsShort:["Ean","Feabh","Mrt","Aib","Beal","Meith","Iil","Ln","M.F.","D.F.","Samh","Noll"],monthsParseExact:!0,weekdays:["D Domhnaigh","D Luain","D Mirt","D Cadaoin","Dardaoin","D hAoine","D Sathairn"],weekdaysShort:["Domh","Luan","Mirt","Cad","Dar","Aoine","Sath"],weekdaysMin:["Do","Lu","M","C","D","A","Sa"],longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Inniu ag] LT",nextDay:"[Amrach ag] LT",nextWeek:"dddd [ag] LT",lastDay:"[Inn ag] LT",lastWeek:"dddd [seo caite] [ag] LT",sameElse:"L"},relativeTime:{future:"i %s",past:"%s  shin",s:"cpla soicind",ss:"%d soicind",m:"nimad",mm:"%d nimad",h:"uair an chloig",hh:"%d uair an chloig",d:"l",dd:"%d l",M:"m",MM:"%d monna",y:"bliain",yy:"%d bliain"},dayOfMonthOrdinalParse:/\d{1,2}(d|na|mh)/,ordinal:function(number){return number+(1===number?"d":number%10==2?"na":"mh")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("gd",{months:["Am Faoilleach","An Gearran","Am Mrt","An Giblean","An Citean","An t-gmhios","An t-Iuchar","An Lnastal","An t-Sultain","An Dmhair","An t-Samhain","An Dbhlachd"],monthsShort:["Faoi","Gear","Mrt","Gibl","Cit","gmh","Iuch","Ln","Sult","Dmh","Samh","Dbh"],monthsParseExact:!0,weekdays:["Didmhnaich","Diluain","Dimirt","Diciadain","Diardaoin","Dihaoine","Disathairne"],weekdaysShort:["Did","Dil","Dim","Dic","Dia","Dih","Dis"],weekdaysMin:["D","Lu","M","Ci","Ar","Ha","Sa"],longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[An-diugh aig] LT",nextDay:"[A-mireach aig] LT",nextWeek:"dddd [aig] LT",lastDay:"[An-d aig] LT",lastWeek:"dddd [seo chaidh] [aig] LT",sameElse:"L"},relativeTime:{future:"ann an %s",past:"bho chionn %s",s:"beagan diogan",ss:"%d diogan",m:"mionaid",mm:"%d mionaidean",h:"uair",hh:"%d uairean",d:"latha",dd:"%d latha",M:"mos",MM:"%d mosan",y:"bliadhna",yy:"%d bliadhna"},dayOfMonthOrdinalParse:/\d{1,2}(d|na|mh)/,ordinal:function(number){return number+(1===number?"d":number%10==2?"na":"mh")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("gl",{months:"xaneiro_febreiro_marzo_abril_maio_xuo_xullo_agosto_setembro_outubro_novembro_decembro".split("_"),monthsShort:"xan._feb._mar._abr._mai._xu._xul._ago._set._out._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"domingo_luns_martes_mrcores_xoves_venres_sbado".split("_"),weekdaysShort:"dom._lun._mar._mr._xov._ven._sb.".split("_"),weekdaysMin:"do_lu_ma_m_xo_ve_s".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY H:mm",LLLL:"dddd, D [de] MMMM [de] YYYY H:mm"},calendar:{sameDay:function(){return"[hoxe "+(1!==this.hours()?"s":"")+"] LT"},nextDay:function(){return"[ma "+(1!==this.hours()?"s":"")+"] LT"},nextWeek:function(){return"dddd ["+(1!==this.hours()?"s":"a")+"] LT"},lastDay:function(){return"[onte "+(1!==this.hours()?"":"a")+"] LT"},lastWeek:function(){return"[o] dddd [pasado "+(1!==this.hours()?"s":"a")+"] LT"},sameElse:"L"},relativeTime:{future:function(str){return 0===str.indexOf("un")?"n"+str:"en "+str},past:"hai %s",s:"uns segundos",ss:"%d segundos",m:"un minuto",mm:"%d minutos",h:"unha hora",hh:"%d horas",d:"un da",dd:"%d das",M:"un mes",MM:"%d meses",y:"un ano",yy:"%d anos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={s:[" "," "],ss:[number+" ",number+" "],m:[" "," "],mm:[number+" ",number+" "],h:[" "," "],hh:[number+" ",number+" "],d:[" "," "],dd:[number+" ",number+" "],M:[" "," "],MM:[number+" ",number+" "],y:[" "," "],yy:[number+" ",number+" "]};return isFuture?format[key][0]:format[key][1]}moment.defineLocale("gom-deva",{months:{standalone:"___________".split("_"),format:"___________".split("_"),isFormat:/MMMM(\s)+D[oD]?/},monthsShort:"._.__.___._._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"._._._._._._.".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"A h:mm []",LTS:"A h:mm:ss []",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY A h:mm []",LLLL:"dddd, MMMM Do, YYYY, A h:mm []",llll:"ddd, D MMM YYYY, A h:mm []"},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[] dddd[,] LT",lastDay:"[] LT",lastWeek:"[] dddd[,] LT",sameElse:"L"},relativeTime:{future:"%s",past:"%s ",s:processRelativeTime,ss:processRelativeTime,m:processRelativeTime,mm:processRelativeTime,h:processRelativeTime,hh:processRelativeTime,d:processRelativeTime,dd:processRelativeTime,M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}()/,ordinal:function(number,period){switch(period){case"D":return number+"";default:case"M":case"Q":case"DDD":case"d":case"w":case"W":return number}},week:{dow:0,doy:3},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>12?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<12?"":hour<16?"":hour<20?"":""}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={s:["thoddea sekondamni","thodde sekond"],ss:[number+" sekondamni",number+" sekond"],m:["eka mintan","ek minut"],mm:[number+" mintamni",number+" mintam"],h:["eka voran","ek vor"],hh:[number+" voramni",number+" voram"],d:["eka disan","ek dis"],dd:[number+" disamni",number+" dis"],M:["eka mhoinean","ek mhoino"],MM:[number+" mhoineamni",number+" mhoine"],y:["eka vorsan","ek voros"],yy:[number+" vorsamni",number+" vorsam"]};return isFuture?format[key][0]:format[key][1]}moment.defineLocale("gom-latn",{months:{standalone:"Janer_Febrer_Mars_Abril_Mai_Jun_Julai_Agost_Setembr_Otubr_Novembr_Dezembr".split("_"),format:"Janerachea_Febrerachea_Marsachea_Abrilachea_Maiachea_Junachea_Julaiachea_Agostachea_Setembrachea_Otubrachea_Novembrachea_Dezembrachea".split("_"),isFormat:/MMMM(\s)+D[oD]?/},monthsShort:"Jan._Feb._Mars_Abr._Mai_Jun_Jul._Ago._Set._Otu._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Aitar_Somar_Mongllar_Budhvar_Birestar_Sukrar_Son'var".split("_"),weekdaysShort:"Ait._Som._Mon._Bud._Bre._Suk._Son.".split("_"),weekdaysMin:"Ai_Sm_Mo_Bu_Br_Su_Sn".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"A h:mm [vazta]",LTS:"A h:mm:ss [vazta]",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY A h:mm [vazta]",LLLL:"dddd, MMMM Do, YYYY, A h:mm [vazta]",llll:"ddd, D MMM YYYY, A h:mm [vazta]"},calendar:{sameDay:"[Aiz] LT",nextDay:"[Faleam] LT",nextWeek:"[Fuddlo] dddd[,] LT",lastDay:"[Kal] LT",lastWeek:"[Fattlo] dddd[,] LT",sameElse:"L"},relativeTime:{future:"%s",past:"%s adim",s:processRelativeTime,ss:processRelativeTime,m:processRelativeTime,mm:processRelativeTime,h:processRelativeTime,hh:processRelativeTime,d:processRelativeTime,dd:processRelativeTime,M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}(er)/,ordinal:function(number,period){switch(period){case"D":return number+"er";default:case"M":case"Q":case"DDD":case"d":case"w":case"W":return number}},week:{dow:0,doy:3},meridiemParse:/rati|sokallim|donparam|sanje/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),"rati"===meridiem?hour<4?hour:hour+12:"sokallim"===meridiem?hour:"donparam"===meridiem?hour>12?hour:hour+12:"sanje"===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"rati":hour<12?"sokallim":hour<16?"donparam":hour<20?"sanje":"rati"}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("gu",{months:"___________".split("_"),monthsShort:"._.__.___._._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=10?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("he",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D []MMMM YYYY",LLL:"D []MMMM YYYY HH:mm",LLLL:"dddd, D []MMMM YYYY HH:mm",l:"D/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},calendar:{sameDay:"[ ]LT",nextDay:"[ ]LT",nextWeek:"dddd [] LT",lastDay:"[ ]LT",lastWeek:"[] dddd [ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:" ",ss:"%d ",m:"",mm:"%d ",h:"",hh:function(number){return 2===number?"":number+" "},d:"",dd:function(number){return 2===number?"":number+" "},M:"",MM:function(number){return 2===number?"":number+" "},y:"",yy:function(number){return 2===number?"":number%10==0&&10!==number?number+" ":number+" "}},meridiemParse:/"|"| | | ||/i,isPM:function(input){return/^("| |)$/.test(input)},meridiem:function(hour,minute,isLower){return hour<5?" ":hour<10?"":hour<12?isLower?'"':" ":hour<18?isLower?'"':" ":""}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"},monthsParse=[/^/i,/^|/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^|/i,/^/i,/^|/i,/^|/i];moment.defineLocale("hi",{months:{format:"___________".split("_"),standalone:"___________".split("_")},monthsShort:"._.__.___._._._._._.".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:[/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i],monthsRegex:/^(|\.?|||\.?|?||\.?|?|?||\.?||\.?|||\.?||\.?|||\.?|||\.?)/i,monthsShortRegex:/^(|\.?|||\.?|?||\.?|?|?||\.?||\.?|||\.?||\.?|||\.?|||\.?)/i,monthsStrictRegex:/^(?||?|?|?|?|?|?|?|||?\.?||\.?||?||?)/i,monthsShortStrictRegex:/^(\.?|\.?|?|\.?|?|?|\.?|\.?|\.?|\.?|\.?|\.?)/i,calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:"  ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=10?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"ss":return result+=1===number?"sekunda":2===number||3===number||4===number?"sekunde":"sekundi";case"m":return withoutSuffix?"jedna minuta":"jedne minute";case"mm":return result+=1===number?"minuta":2===number||3===number||4===number?"minute":"minuta";case"h":return withoutSuffix?"jedan sat":"jednog sata";case"hh":return result+=1===number?"sat":2===number||3===number||4===number?"sata":"sati";case"dd":return result+=1===number?"dan":"dana";case"MM":return result+=1===number?"mjesec":2===number||3===number||4===number?"mjeseca":"mjeseci";case"yy":return result+=1===number?"godina":2===number||3===number||4===number?"godine":"godina"}}moment.defineLocale("hr",{months:{format:"sijenja_veljae_oujka_travnja_svibnja_lipnja_srpnja_kolovoza_rujna_listopada_studenoga_prosinca".split("_"),standalone:"sijeanj_veljaa_oujak_travanj_svibanj_lipanj_srpanj_kolovoz_rujan_listopad_studeni_prosinac".split("_")},monthsShort:"sij._velj._ou._tra._svi._lip._srp._kol._ruj._lis._stu._pro.".split("_"),monthsParseExact:!0,weekdays:"nedjelja_ponedjeljak_utorak_srijeda_etvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._et._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_e_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"Do MMMM YYYY",LLL:"Do MMMM YYYY H:mm",LLLL:"dddd, Do MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[juer u] LT",lastWeek:function(){switch(this.day()){case 0:return"[prolu] [nedjelju] [u] LT";case 3:return"[prolu] [srijedu] [u] LT";case 6:return"[prole] [subote] [u] LT";case 1:case 2:case 4:case 5:return"[proli] dddd [u] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"par sekundi",ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:"dan",dd:translate,M:"mjesec",MM:translate,y:"godinu",yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var weekEndings="vasrnap htfn kedden szerdn cstrtkn pnteken szombaton".split(" ");function translate(number,withoutSuffix,key,isFuture){var num=number;switch(key){case"s":return isFuture||withoutSuffix?"nhny msodperc":"nhny msodperce";case"ss":return num+(isFuture||withoutSuffix)?" msodperc":" msodperce";case"m":return"egy"+(isFuture||withoutSuffix?" perc":" perce");case"mm":return num+(isFuture||withoutSuffix?" perc":" perce");case"h":return"egy"+(isFuture||withoutSuffix?" ra":" rja");case"hh":return num+(isFuture||withoutSuffix?" ra":" rja");case"d":return"egy"+(isFuture||withoutSuffix?" nap":" napja");case"dd":return num+(isFuture||withoutSuffix?" nap":" napja");case"M":return"egy"+(isFuture||withoutSuffix?" hnap":" hnapja");case"MM":return num+(isFuture||withoutSuffix?" hnap":" hnapja");case"y":return"egy"+(isFuture||withoutSuffix?" v":" ve");case"yy":return num+(isFuture||withoutSuffix?" v":" ve")}return""}function week(isFuture){return(isFuture?"":"[mlt] ")+"["+weekEndings[this.day()]+"] LT[-kor]"}moment.defineLocale("hu",{months:"janur_februr_mrcius_prilis_mjus_jnius_jlius_augusztus_szeptember_oktber_november_december".split("_"),monthsShort:"jan._feb._mrc._pr._mj._jn._jl._aug._szept._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"vasrnap_htf_kedd_szerda_cstrtk_pntek_szombat".split("_"),weekdaysShort:"vas_ht_kedd_sze_cst_pn_szo".split("_"),weekdaysMin:"v_h_k_sze_cs_p_szo".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY. MMMM D.",LLL:"YYYY. MMMM D. H:mm",LLLL:"YYYY. MMMM D., dddd H:mm"},meridiemParse:/de|du/i,isPM:function(input){return"u"===input.charAt(1).toLowerCase()},meridiem:function(hours,minutes,isLower){return hours<12?!0===isLower?"de":"DE":!0===isLower?"du":"DU"},calendar:{sameDay:"[ma] LT[-kor]",nextDay:"[holnap] LT[-kor]",nextWeek:function(){return week.call(this,!0)},lastDay:"[tegnap] LT[-kor]",lastWeek:function(){return week.call(this,!1)},sameElse:"L"},relativeTime:{future:"%s mlva",past:"%s",s:translate,ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("hy-am",{months:{format:"___________".split("_"),standalone:"___________".split("_")},monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY .",LLL:"D MMMM YYYY ., HH:mm",LLLL:"dddd, D MMMM YYYY ., HH:mm"},calendar:{sameDay:"[] LT",nextDay:"[] LT",lastDay:"[] LT",nextWeek:function(){return"dddd [ ] LT"},lastWeek:function(){return"[] dddd [ ] LT"},sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:"  ",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},meridiemParse:/|||/,isPM:function(input){return/^(|)$/.test(input)},meridiem:function(hour){return hour<4?"":hour<12?"":hour<17?"":""},dayOfMonthOrdinalParse:/\d{1,2}|\d{1,2}-(|)/,ordinal:function(number,period){switch(period){case"DDD":case"w":case"W":case"DDDo":return 1===number?number+"-":number+"-";default:return number}},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("id",{months:"Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_November_Desember".split("_"),monthsShort:"Jan_Feb_Mar_Apr_Mei_Jun_Jul_Agt_Sep_Okt_Nov_Des".split("_"),weekdays:"Minggu_Senin_Selasa_Rabu_Kamis_Jumat_Sabtu".split("_"),weekdaysShort:"Min_Sen_Sel_Rab_Kam_Jum_Sab".split("_"),weekdaysMin:"Mg_Sn_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/pagi|siang|sore|malam/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),"pagi"===meridiem?hour:"siang"===meridiem?hour>=11?hour:hour+12:"sore"===meridiem||"malam"===meridiem?hour+12:void 0},meridiem:function(hours,minutes,isLower){return hours<11?"pagi":hours<15?"siang":hours<19?"sore":"malam"},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Besok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kemarin pukul] LT",lastWeek:"dddd [lalu pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lalu",s:"beberapa detik",ss:"%d detik",m:"semenit",mm:"%d menit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function plural(n){return n%100==11||n%10!=1}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"nokkrar sekndur":"nokkrum sekndum";case"ss":return plural(number)?result+(withoutSuffix||isFuture?"sekndur":"sekndum"):result+"seknda";case"m":return withoutSuffix?"mnta":"mntu";case"mm":return plural(number)?result+(withoutSuffix||isFuture?"mntur":"mntum"):withoutSuffix?result+"mnta":result+"mntu";case"hh":return plural(number)?result+(withoutSuffix||isFuture?"klukkustundir":"klukkustundum"):result+"klukkustund";case"d":return withoutSuffix?"dagur":isFuture?"dag":"degi";case"dd":return plural(number)?withoutSuffix?result+"dagar":result+(isFuture?"daga":"dgum"):withoutSuffix?result+"dagur":result+(isFuture?"dag":"degi");case"M":return withoutSuffix?"mnuur":isFuture?"mnu":"mnui";case"MM":return plural(number)?withoutSuffix?result+"mnuir":result+(isFuture?"mnui":"mnuum"):withoutSuffix?result+"mnuur":result+(isFuture?"mnu":"mnui");case"y":return withoutSuffix||isFuture?"r":"ri";case"yy":return plural(number)?result+(withoutSuffix||isFuture?"r":"rum"):result+(withoutSuffix||isFuture?"r":"ri")}}moment.defineLocale("is",{months:"janar_febrar_mars_aprl_ma_jn_jl_gst_september_oktber_nvember_desember".split("_"),monthsShort:"jan_feb_mar_apr_ma_jn_jl_g_sep_okt_nv_des".split("_"),weekdays:"sunnudagur_mnudagur_rijudagur_mivikudagur_fimmtudagur_fstudagur_laugardagur".split("_"),weekdaysShort:"sun_mn_ri_mi_fim_fs_lau".split("_"),weekdaysMin:"Su_M_r_Mi_Fi_F_La".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] H:mm",LLLL:"dddd, D. MMMM YYYY [kl.] H:mm"},calendar:{sameDay:"[ dag kl.] LT",nextDay:"[ morgun kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[ gr kl.] LT",lastWeek:"[sasta] dddd [kl.] LT",sameElse:"L"},relativeTime:{future:"eftir %s",past:"fyrir %s san",s:translate,ss:translate,m:translate,mm:translate,h:"klukkustund",hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("it",{months:"gennaio_febbraio_marzo_aprile_maggio_giugno_luglio_agosto_settembre_ottobre_novembre_dicembre".split("_"),monthsShort:"gen_feb_mar_apr_mag_giu_lug_ago_set_ott_nov_dic".split("_"),weekdays:"domenica_luned_marted_mercoled_gioved_venerd_sabato".split("_"),weekdaysShort:"dom_lun_mar_mer_gio_ven_sab".split("_"),weekdaysMin:"do_lu_ma_me_gi_ve_sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:function(){return"[Oggi a"+(this.hours()>1?"lle ":0===this.hours()?" ":"ll'")+"]LT"},nextDay:function(){return"[Domani a"+(this.hours()>1?"lle ":0===this.hours()?" ":"ll'")+"]LT"},nextWeek:function(){return"dddd [a"+(this.hours()>1?"lle ":0===this.hours()?" ":"ll'")+"]LT"},lastDay:function(){return"[Ieri a"+(this.hours()>1?"lle ":0===this.hours()?" ":"ll'")+"]LT"},lastWeek:function(){switch(this.day()){case 0:return"[La scorsa] dddd [a"+(this.hours()>1?"lle ":0===this.hours()?" ":"ll'")+"]LT";default:return"[Lo scorso] dddd [a"+(this.hours()>1?"lle ":0===this.hours()?" ":"ll'")+"]LT"}},sameElse:"L"},relativeTime:{future:"tra %s",past:"%s fa",s:"alcuni secondi",ss:"%d secondi",m:"un minuto",mm:"%d minuti",h:"un'ora",hh:"%d ore",d:"un giorno",dd:"%d giorni",w:"una settimana",ww:"%d settimane",M:"un mese",MM:"%d mesi",y:"un anno",yy:"%d anni"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("it-ch",{months:"gennaio_febbraio_marzo_aprile_maggio_giugno_luglio_agosto_settembre_ottobre_novembre_dicembre".split("_"),monthsShort:"gen_feb_mar_apr_mag_giu_lug_ago_set_ott_nov_dic".split("_"),weekdays:"domenica_luned_marted_mercoled_gioved_venerd_sabato".split("_"),weekdaysShort:"dom_lun_mar_mer_gio_ven_sab".split("_"),weekdaysMin:"do_lu_ma_me_gi_ve_sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[Oggi alle] LT",nextDay:"[Domani alle] LT",nextWeek:"dddd [alle] LT",lastDay:"[Ieri alle] LT",lastWeek:function(){switch(this.day()){case 0:return"[la scorsa] dddd [alle] LT";default:return"[lo scorso] dddd [alle] LT"}},sameElse:"L"},relativeTime:{future:function(s){return(/^[0-9].+$/.test(s)?"tra":"in")+" "+s},past:"%s fa",s:"alcuni secondi",ss:"%d secondi",m:"un minuto",mm:"%d minuti",h:"un'ora",hh:"%d ore",d:"un giorno",dd:"%d giorni",M:"un mese",MM:"%d mesi",y:"un anno",yy:"%d anni"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ja",{eras:[{since:"2019-05-01",offset:1,name:"",narrow:"",abbr:"R"},{since:"1989-01-08",until:"2019-04-30",offset:1,name:"",narrow:"",abbr:"H"},{since:"1926-12-25",until:"1989-01-07",offset:1,name:"",narrow:"",abbr:"S"},{since:"1912-07-30",until:"1926-12-24",offset:1,name:"",narrow:"",abbr:"T"},{since:"1873-01-01",until:"1912-07-29",offset:6,name:"",narrow:"",abbr:"M"},{since:"0001-01-01",until:"1873-12-31",offset:1,name:"",narrow:"AD",abbr:"AD"},{since:"0000-12-31",until:-1/0,offset:1,name:"",narrow:"BC",abbr:"BC"}],eraYearOrdinalRegex:/(|\d+)/,eraYearOrdinalParse:function(input,match){return""===match[1]?1:parseInt(match[1]||input,10)},months:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYYMD",LLL:"YYYYMD HH:mm",LLLL:"YYYYMD dddd HH:mm",l:"YYYY/MM/DD",ll:"YYYYMD",lll:"YYYYMD HH:mm",llll:"YYYYMD(ddd) HH:mm"},meridiemParse:/|/i,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:function(now){return now.week()!==this.week()?"[]dddd LT":"dddd LT"},lastDay:"[] LT",lastWeek:function(now){return this.week()!==now.week()?"[]dddd LT":"dddd LT"},sameElse:"L"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:function(number,period){switch(period){case"y":return 1===number?"":number+"";case"d":case"D":case"DDD":return number+"";default:return number}},relativeTime:{future:"%s",past:"%s",s:"",ss:"%d",m:"1",mm:"%d",h:"1",hh:"%d",d:"1",dd:"%d",M:"1",MM:"%d",y:"1",yy:"%d"}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("jv",{months:"Januari_Februari_Maret_April_Mei_Juni_Juli_Agustus_September_Oktober_Nopember_Desember".split("_"),monthsShort:"Jan_Feb_Mar_Apr_Mei_Jun_Jul_Ags_Sep_Okt_Nop_Des".split("_"),weekdays:"Minggu_Senen_Seloso_Rebu_Kemis_Jemuwah_Septu".split("_"),weekdaysShort:"Min_Sen_Sel_Reb_Kem_Jem_Sep".split("_"),weekdaysMin:"Mg_Sn_Sl_Rb_Km_Jm_Sp".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/enjing|siyang|sonten|ndalu/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),"enjing"===meridiem?hour:"siyang"===meridiem?hour>=11?hour:hour+12:"sonten"===meridiem||"ndalu"===meridiem?hour+12:void 0},meridiem:function(hours,minutes,isLower){return hours<11?"enjing":hours<15?"siyang":hours<19?"sonten":"ndalu"},calendar:{sameDay:"[Dinten puniko pukul] LT",nextDay:"[Mbenjang pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kala wingi pukul] LT",lastWeek:"dddd [kepengker pukul] LT",sameElse:"L"},relativeTime:{future:"wonten ing %s",past:"%s ingkang kepengker",s:"sawetawis detik",ss:"%d detik",m:"setunggal menit",mm:"%d menit",h:"setunggal jam",hh:"%d jam",d:"sedinten",dd:"%d dinten",M:"sewulan",MM:"%d wulan",y:"setaun",yy:"%d taun"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ka",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:{standalone:"______".split("_"),format:"______".split("_"),isFormat:/(|)/},weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[] LT[-]",nextDay:"[] LT[-]",lastDay:"[] LT[-]",nextWeek:"[] dddd LT[-]",lastWeek:"[] dddd LT-",sameElse:"L"},relativeTime:{future:function(s){return s.replace(/(|||||)(|)/,(function($0,$1,$2){return""===$2?$1+"":$1+$2+""}))},past:function(s){return/(||||)/.test(s)?s.replace(/(|)$/," ")://.test(s)?s.replace(/$/," "):s},s:" ",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},dayOfMonthOrdinalParse:/0|1-|-\d{1,2}|\d{1,2}-/,ordinal:function(number){return 0===number?number:1===number?number+"-":number<20||number<=100&&number%20==0||number%100==0?"-"+number:number+"-"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var suffixes={0:"-",1:"-",2:"-",3:"-",4:"-",5:"-",6:"-",7:"-",8:"-",9:"-",10:"-",20:"-",30:"-",40:"-",50:"-",60:"-",70:"-",80:"-",90:"-",100:"-"};moment.defineLocale("kk",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:"[ ] dddd [] LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}-(|)/,ordinal:function(number){return number+(suffixes[number]||suffixes[number%10]||suffixes[number>=100?100:null])},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("km",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:"dddd [] [] LT",sameElse:"L"},relativeTime:{future:"%s",past:"%s",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("kn",{months:"___________".split("_"),monthsShort:"___________".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm",LTS:"A h:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm",LLLL:"dddd, D MMMM YYYY, A h:mm"},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=10?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},dayOfMonthOrdinalParse:/\d{1,2}()/,ordinal:function(number){return number+""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ko",{months:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm",LTS:"A h:mm:ss",L:"YYYY.MM.DD.",LL:"YYYY MMMM D",LLL:"YYYY MMMM D A h:mm",LLLL:"YYYY MMMM D dddd A h:mm",l:"YYYY.MM.DD.",ll:"YYYY MMMM D",lll:"YYYY MMMM D A h:mm",llll:"YYYY MMMM D dddd A h:mm"},calendar:{sameDay:" LT",nextDay:" LT",nextWeek:"dddd LT",lastDay:" LT",lastWeek:" dddd LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d",m:"1",mm:"%d",h:" ",hh:"%d",d:"",dd:"%d",M:" ",MM:"%d",y:" ",yy:"%d"},dayOfMonthOrdinalParse:/\d{1,2}(||)/,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"";case"M":return number+"";case"w":case"W":return number+"";default:return number}},meridiemParse:/|/,isPM:function(token){return""===token},meridiem:function(hour,minute,isUpper){return hour<12?"":""}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"},months=[" ","","","","","","","",""," "," "," "];moment.defineLocale("ku",{months:months,monthsShort:months,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return//.test(input)},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:"dddd [] LT",sameElse:"L"},relativeTime:{future:" %s",past:"%s",s:" ",ss:" %d",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]})).replace(//g,",")},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]})).replace(/,/g,"")},week:{dow:6,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var suffixes={0:"-",1:"-",2:"-",3:"-",4:"-",5:"-",6:"-",7:"-",8:"-",9:"-",10:"-",20:"-",30:"-",40:"-",50:"-",60:"-",70:"-",80:"-",90:"-",100:"-"};moment.defineLocale("ky",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:"[ ] dddd [] [] LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}-(|||)/,ordinal:function(number){return number+(suffixes[number]||suffixes[number%10]||suffixes[number>=100?100:null])},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={m:["eng Minutt","enger Minutt"],h:["eng Stonn","enger Stonn"],d:["een Dag","engem Dag"],M:["ee Mount","engem Mount"],y:["ee Joer","engem Joer"]};return withoutSuffix?format[key][0]:format[key][1]}function eifelerRegelAppliesToNumber(number){if(number=parseInt(number,10),isNaN(number))return!1;if(number<0)return!0;if(number<10)return 4<=number&&number<=7;if(number<100){var lastDigit=number%10;return eifelerRegelAppliesToNumber(0===lastDigit?number/10:lastDigit)}if(number<1e4){for(;number>=10;)number/=10;return eifelerRegelAppliesToNumber(number)}return eifelerRegelAppliesToNumber(number/=1e3)}moment.defineLocale("lb",{months:"Januar_Februar_Merz_Abrll_Mee_Juni_Juli_August_September_Oktober_November_Dezember".split("_"),monthsShort:"Jan._Febr._Mrz._Abr._Mee_Jun._Jul._Aug._Sept._Okt._Nov._Dez.".split("_"),monthsParseExact:!0,weekdays:"Sonndeg_Mindeg_Dnschdeg_Mttwoch_Donneschdeg_Freideg_Samschdeg".split("_"),weekdaysShort:"So._M._D._M._Do._Fr._Sa.".split("_"),weekdaysMin:"So_M_D_M_Do_Fr_Sa".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm [Auer]",LTS:"H:mm:ss [Auer]",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm [Auer]",LLLL:"dddd, D. MMMM YYYY H:mm [Auer]"},calendar:{sameDay:"[Haut um] LT",sameElse:"L",nextDay:"[Muer um] LT",nextWeek:"dddd [um] LT",lastDay:"[Gschter um] LT",lastWeek:function(){switch(this.day()){case 2:case 4:return"[Leschten] dddd [um] LT";default:return"[Leschte] dddd [um] LT"}}},relativeTime:{future:function(string){return eifelerRegelAppliesToNumber(string.substr(0,string.indexOf(" ")))?"a "+string:"an "+string},past:function(string){return eifelerRegelAppliesToNumber(string.substr(0,string.indexOf(" ")))?"viru "+string:"virun "+string},s:"e puer Sekonnen",ss:"%d Sekonnen",m:processRelativeTime,mm:"%d Minutten",h:processRelativeTime,hh:"%d Stonnen",d:processRelativeTime,dd:"%d Deeg",M:processRelativeTime,MM:"%d Mint",y:processRelativeTime,yy:"%d Joer"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("lo",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[]dddd[] LT",lastDay:"[] LT",lastWeek:"[]dddd[] LT",sameElse:"L"},relativeTime:{future:" %s",past:"%s",s:"",ss:"%d ",m:"1 ",mm:"%d ",h:"1 ",hh:"%d ",d:"1 ",dd:"%d ",M:"1 ",MM:"%d ",y:"1 ",yy:"%d "},dayOfMonthOrdinalParse:/()\d{1,2}/,ordinal:function(number){return""+number}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var units={ss:"sekund_sekundi_sekundes",m:"minut_minuts_minut",mm:"minuts_minui_minutes",h:"valanda_valandos_valand",hh:"valandos_valand_valandas",d:"diena_dienos_dien",dd:"dienos_dien_dienas",M:"mnuo_mnesio_mnes",MM:"mnesiai_mnesi_mnesius",y:"metai_met_metus",yy:"metai_met_metus"};function translateSingular(number,withoutSuffix,key,isFuture){return withoutSuffix?forms(key)[0]:isFuture?forms(key)[1]:forms(key)[2]}function special(number){return number%10==0||number>10&&number<20}function forms(key){return units[key].split("_")}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";return 1===number?result+translateSingular(0,withoutSuffix,key[0],isFuture):withoutSuffix?result+(special(number)?forms(key)[1]:forms(key)[0]):isFuture?result+forms(key)[1]:result+(special(number)?forms(key)[1]:forms(key)[2])}moment.defineLocale("lt",{months:{format:"sausio_vasario_kovo_balandio_gegus_birelio_liepos_rugpjio_rugsjo_spalio_lapkriio_gruodio".split("_"),standalone:"sausis_vasaris_kovas_balandis_gegu_birelis_liepa_rugpjtis_rugsjis_spalis_lapkritis_gruodis".split("_"),isFormat:/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?|MMMM?(\[[^\[\]]*\]|\s)+D[oD]?/},monthsShort:"sau_vas_kov_bal_geg_bir_lie_rgp_rgs_spa_lap_grd".split("_"),weekdays:{format:"sekmadien_pirmadien_antradien_treiadien_ketvirtadien_penktadien_etadien".split("_"),standalone:"sekmadienis_pirmadienis_antradienis_treiadienis_ketvirtadienis_penktadienis_etadienis".split("_"),isFormat:/dddd HH:mm/},weekdaysShort:"Sek_Pir_Ant_Tre_Ket_Pen_e".split("_"),weekdaysMin:"S_P_A_T_K_Pn_".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"YYYY [m.] MMMM D [d.]",LLL:"YYYY [m.] MMMM D [d.], HH:mm [val.]",LLLL:"YYYY [m.] MMMM D [d.], dddd, HH:mm [val.]",l:"YYYY-MM-DD",ll:"YYYY [m.] MMMM D [d.]",lll:"YYYY [m.] MMMM D [d.], HH:mm [val.]",llll:"YYYY [m.] MMMM D [d.], ddd, HH:mm [val.]"},calendar:{sameDay:"[iandien] LT",nextDay:"[Rytoj] LT",nextWeek:"dddd LT",lastDay:"[Vakar] LT",lastWeek:"[Prajus] dddd LT",sameElse:"L"},relativeTime:{future:"po %s",past:"prie %s",s:function(number,withoutSuffix,key,isFuture){return withoutSuffix?"kelios sekunds":isFuture?"keli sekundi":"kelias sekundes"},ss:translate,m:translateSingular,mm:translate,h:translateSingular,hh:translate,d:translateSingular,dd:translate,M:translateSingular,MM:translate,y:translateSingular,yy:translate},dayOfMonthOrdinalParse:/\d{1,2}-oji/,ordinal:function(number){return number+"-oji"},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var units={ss:"sekundes_sekundm_sekunde_sekundes".split("_"),m:"mintes_mintm_minte_mintes".split("_"),mm:"mintes_mintm_minte_mintes".split("_"),h:"stundas_stundm_stunda_stundas".split("_"),hh:"stundas_stundm_stunda_stundas".split("_"),d:"dienas_dienm_diena_dienas".split("_"),dd:"dienas_dienm_diena_dienas".split("_"),M:"mnea_mneiem_mnesis_mnei".split("_"),MM:"mnea_mneiem_mnesis_mnei".split("_"),y:"gada_gadiem_gads_gadi".split("_"),yy:"gada_gadiem_gads_gadi".split("_")};function format(forms,number,withoutSuffix){return withoutSuffix?number%10==1&&number%100!=11?forms[2]:forms[3]:number%10==1&&number%100!=11?forms[0]:forms[1]}function relativeTimeWithPlural(number,withoutSuffix,key){return number+" "+format(units[key],number,withoutSuffix)}function relativeTimeWithSingular(number,withoutSuffix,key){return format(units[key],number,withoutSuffix)}moment.defineLocale("lv",{months:"janvris_februris_marts_aprlis_maijs_jnijs_jlijs_augusts_septembris_oktobris_novembris_decembris".split("_"),monthsShort:"jan_feb_mar_apr_mai_jn_jl_aug_sep_okt_nov_dec".split("_"),weekdays:"svtdiena_pirmdiena_otrdiena_trediena_ceturtdiena_piektdiena_sestdiena".split("_"),weekdaysShort:"Sv_P_O_T_C_Pk_S".split("_"),weekdaysMin:"Sv_P_O_T_C_Pk_S".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY.",LL:"YYYY. [gada] D. MMMM",LLL:"YYYY. [gada] D. MMMM, HH:mm",LLLL:"YYYY. [gada] D. MMMM, dddd, HH:mm"},calendar:{sameDay:"[odien pulksten] LT",nextDay:"[Rt pulksten] LT",nextWeek:"dddd [pulksten] LT",lastDay:"[Vakar pulksten] LT",lastWeek:"[Pagju] dddd [pulksten] LT",sameElse:"L"},relativeTime:{future:"pc %s",past:"pirms %s",s:function(number,withoutSuffix){return withoutSuffix?"daas sekundes":"dam sekundm"},ss:relativeTimeWithPlural,m:relativeTimeWithSingular,mm:relativeTimeWithPlural,h:relativeTimeWithSingular,hh:relativeTimeWithPlural,d:relativeTimeWithSingular,dd:relativeTimeWithPlural,M:relativeTimeWithSingular,MM:relativeTimeWithPlural,y:relativeTimeWithSingular,yy:relativeTimeWithPlural},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var translator={words:{ss:["sekund","sekunda","sekundi"],m:["jedan minut","jednog minuta"],mm:["minut","minuta","minuta"],h:["jedan sat","jednog sata"],hh:["sat","sata","sati"],dd:["dan","dana","dana"],MM:["mjesec","mjeseca","mjeseci"],yy:["godina","godine","godina"]},correctGrammaticalCase:function(number,wordKey){return 1===number?wordKey[0]:number>=2&&number<=4?wordKey[1]:wordKey[2]},translate:function(number,withoutSuffix,key){var wordKey=translator.words[key];return 1===key.length?withoutSuffix?wordKey[0]:wordKey[1]:number+" "+translator.correctGrammaticalCase(number,wordKey)}};moment.defineLocale("me",{months:"januar_februar_mart_april_maj_jun_jul_avgust_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj_jun_jul_avg._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedjelja_ponedjeljak_utorak_srijeda_etvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sri._et._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_e_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sjutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedjelju] [u] LT";case 3:return"[u] [srijedu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[jue u] LT",lastWeek:function(){return["[prole] [nedjelje] [u] LT","[prolog] [ponedjeljka] [u] LT","[prolog] [utorka] [u] LT","[prole] [srijede] [u] LT","[prolog] [etvrtka] [u] LT","[prolog] [petka] [u] LT","[prole] [subote] [u] LT"][this.day()]},sameElse:"L"},relativeTime:{future:"za %s",past:"prije %s",s:"nekoliko sekundi",ss:translator.translate,m:translator.translate,mm:translator.translate,h:translator.translate,hh:translator.translate,d:"dan",dd:translator.translate,M:"mjesec",MM:translator.translate,y:"godinu",yy:translator.translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("mi",{months:"Kohi-tte_Hui-tanguru_Pout-te-rangi_Paenga-whwh_Haratua_Pipiri_Hngoingoi_Here-turi-kk_Mahuru_Whiringa--nuku_Whiringa--rangi_Hakihea".split("_"),monthsShort:"Kohi_Hui_Pou_Pae_Hara_Pipi_Hngoi_Here_Mahu_Whi-nu_Whi-ra_Haki".split("_"),monthsRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,3}/i,monthsStrictRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,3}/i,monthsShortRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,3}/i,monthsShortStrictRegex:/(?:['a-z\u0101\u014D\u016B]+\-?){1,2}/i,weekdays:"Rtapu_Mane_Trei_Wenerei_Tite_Paraire_Htarei".split("_"),weekdaysShort:"Ta_Ma_T_We_Ti_Pa_H".split("_"),weekdaysMin:"Ta_Ma_T_We_Ti_Pa_H".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [i] HH:mm",LLLL:"dddd, D MMMM YYYY [i] HH:mm"},calendar:{sameDay:"[i teie mahana, i] LT",nextDay:"[apopo i] LT",nextWeek:"dddd [i] LT",lastDay:"[inanahi i] LT",lastWeek:"dddd [whakamutunga i] LT",sameElse:"L"},relativeTime:{future:"i roto i %s",past:"%s i mua",s:"te hkona ruarua",ss:"%d hkona",m:"he meneti",mm:"%d meneti",h:"te haora",hh:"%d haora",d:"he ra",dd:"%d ra",M:"he marama",MM:"%d marama",y:"he tau",yy:"%d tau"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("mk",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"e_o_____a".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"D.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"[] dddd [] LT",lastDay:"[ ] LT",lastWeek:function(){switch(this.day()){case 0:case 3:case 6:return"[] dddd [] LT";case 1:case 2:case 4:case 5:return"[] dddd [] LT"}},sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}-(|||||)/,ordinal:function(number){var lastDigit=number%10,last2Digits=number%100;return 0===number?number+"-":0===last2Digits?number+"-":last2Digits>10&&last2Digits<20?number+"-":1===lastDigit?number+"-":2===lastDigit?number+"-":7===lastDigit||8===lastDigit?number+"-":number+"-"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ml",{months:"___________".split("_"),monthsShort:"._._._.___._._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm -",LTS:"A h:mm:ss -",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm -",LLLL:"dddd, D MMMM YYYY, A h:mm -"},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},meridiemParse:/|| ||/i,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem&&hour>=4||" "===meridiem||""===meridiem?hour+12:hour},meridiem:function(hour,minute,isLower){return hour<4?"":hour<12?"":hour<17?" ":hour<20?"":""}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function translate(number,withoutSuffix,key,isFuture){switch(key){case"s":return withoutSuffix?" ":" ";case"ss":return number+(withoutSuffix?" ":" ");case"m":case"mm":return number+(withoutSuffix?" ":" ");case"h":case"hh":return number+(withoutSuffix?" ":" ");case"d":case"dd":return number+(withoutSuffix?" ":" ");case"M":case"MM":return number+(withoutSuffix?" ":" ");case"y":case"yy":return number+(withoutSuffix?" ":" ");default:return number}}moment.defineLocale("mn",{months:" _ _ _ _ _ _ _ _ _ _  _  ".split("_"),monthsShort:"1 _2 _3 _4 _5 _6 _7 _8 _9 _10 _11 _12 ".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"YYYY  MMMM D",LLL:"YYYY  MMMM D HH:mm",LLLL:"dddd, YYYY  MMMM D HH:mm"},meridiemParse:/|/i,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[] dddd LT",lastDay:"[] LT",lastWeek:"[] dddd LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:translate,ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},dayOfMonthOrdinalParse:/\d{1,2} /,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+" ";default:return number}}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};function relativeTimeMr(number,withoutSuffix,string,isFuture){var output="";if(withoutSuffix)switch(string){case"s":output=" ";break;case"ss":output="%d ";break;case"m":output=" ";break;case"mm":output="%d ";break;case"h":output=" ";break;case"hh":output="%d ";break;case"d":output=" ";break;case"dd":output="%d ";break;case"M":output=" ";break;case"MM":output="%d ";break;case"y":output=" ";break;case"yy":output="%d "}else switch(string){case"s":output=" ";break;case"ss":output="%d ";break;case"m":output=" ";break;case"mm":output="%d ";break;case"h":output=" ";break;case"hh":output="%d ";break;case"d":output=" ";break;case"dd":output="%d ";break;case"M":output=" ";break;case"MM":output="%d ";break;case"y":output=" ";break;case"yy":output="%d "}return output.replace(/%d/i,number)}moment.defineLocale("mr",{months:"___________".split("_"),monthsShort:"._._._._._._._._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s",past:"%s",s:relativeTimeMr,ss:relativeTimeMr,m:relativeTimeMr,mm:relativeTimeMr,h:relativeTimeMr,hh:relativeTimeMr,d:relativeTimeMr,dd:relativeTimeMr,M:relativeTimeMr,MM:relativeTimeMr,y:relativeTimeMr,yy:relativeTimeMr},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem||""===meridiem?hour:""===meridiem||""===meridiem||""===meridiem?hour>=12?hour:hour+12:void 0},meridiem:function(hour,minute,isLower){return hour>=0&&hour<6?"":hour<12?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ms",{months:"Januari_Februari_Mac_April_Mei_Jun_Julai_Ogos_September_Oktober_November_Disember".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ogs_Sep_Okt_Nov_Dis".split("_"),weekdays:"Ahad_Isnin_Selasa_Rabu_Khamis_Jumaat_Sabtu".split("_"),weekdaysShort:"Ahd_Isn_Sel_Rab_Kha_Jum_Sab".split("_"),weekdaysMin:"Ah_Is_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/pagi|tengahari|petang|malam/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),"pagi"===meridiem?hour:"tengahari"===meridiem?hour>=11?hour:hour+12:"petang"===meridiem||"malam"===meridiem?hour+12:void 0},meridiem:function(hours,minutes,isLower){return hours<11?"pagi":hours<15?"tengahari":hours<19?"petang":"malam"},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Esok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kelmarin pukul] LT",lastWeek:"dddd [lepas pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lepas",s:"beberapa saat",ss:"%d saat",m:"seminit",mm:"%d minit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ms-my",{months:"Januari_Februari_Mac_April_Mei_Jun_Julai_Ogos_September_Oktober_November_Disember".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ogs_Sep_Okt_Nov_Dis".split("_"),weekdays:"Ahad_Isnin_Selasa_Rabu_Khamis_Jumaat_Sabtu".split("_"),weekdaysShort:"Ahd_Isn_Sel_Rab_Kha_Jum_Sab".split("_"),weekdaysMin:"Ah_Is_Sl_Rb_Km_Jm_Sb".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [pukul] HH.mm",LLLL:"dddd, D MMMM YYYY [pukul] HH.mm"},meridiemParse:/pagi|tengahari|petang|malam/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),"pagi"===meridiem?hour:"tengahari"===meridiem?hour>=11?hour:hour+12:"petang"===meridiem||"malam"===meridiem?hour+12:void 0},meridiem:function(hours,minutes,isLower){return hours<11?"pagi":hours<15?"tengahari":hours<19?"petang":"malam"},calendar:{sameDay:"[Hari ini pukul] LT",nextDay:"[Esok pukul] LT",nextWeek:"dddd [pukul] LT",lastDay:"[Kelmarin pukul] LT",lastWeek:"dddd [lepas pukul] LT",sameElse:"L"},relativeTime:{future:"dalam %s",past:"%s yang lepas",s:"beberapa saat",ss:"%d saat",m:"seminit",mm:"%d minit",h:"sejam",hh:"%d jam",d:"sehari",dd:"%d hari",M:"sebulan",MM:"%d bulan",y:"setahun",yy:"%d tahun"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("mt",{months:"Jannar_Frar_Marzu_April_Mejju_unju_Lulju_Awwissu_Settembru_Ottubru_Novembru_Diembru".split("_"),monthsShort:"Jan_Fra_Mar_Apr_Mej_un_Lul_Aww_Set_Ott_Nov_Di".split("_"),weekdays:"Il-add_It-Tnejn_It-Tlieta_L-Erbga_Il-amis_Il-imga_Is-Sibt".split("_"),weekdaysShort:"ad_Tne_Tli_Erb_am_im_Sib".split("_"),weekdaysMin:"a_Tn_Tl_Er_a_i_Si".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Illum fil-]LT",nextDay:"[Gada fil-]LT",nextWeek:"dddd [fil-]LT",lastDay:"[Il-biera fil-]LT",lastWeek:"dddd [li gadda] [fil-]LT",sameElse:"L"},relativeTime:{future:"f %s",past:"%s ilu",s:"ftit sekondi",ss:"%d sekondi",m:"minuta",mm:"%d minuti",h:"siega",hh:"%d siegat",d:"urnata",dd:"%d ranet",M:"xahar",MM:"%d xhur",y:"sena",yy:"%d sni"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("my",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[.] LT []",nextDay:"[] LT []",nextWeek:"dddd LT []",lastDay:"[.] LT []",lastWeek:"[] dddd LT []",sameElse:"L"},relativeTime:{future:" %s ",past:" %s ",s:".",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d ",M:"",MM:"%d ",y:"",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("nb",{months:"januar_februar_mars_april_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan._feb._mars_apr._mai_juni_juli_aug._sep._okt._nov._des.".split("_"),monthsParseExact:!0,weekdays:"sndag_mandag_tirsdag_onsdag_torsdag_fredag_lrdag".split("_"),weekdaysShort:"s._ma._ti._on._to._fr._l.".split("_"),weekdaysMin:"s_ma_ti_on_to_fr_l".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] HH:mm",LLLL:"dddd D. MMMM YYYY [kl.] HH:mm"},calendar:{sameDay:"[i dag kl.] LT",nextDay:"[i morgen kl.] LT",nextWeek:"dddd [kl.] LT",lastDay:"[i gr kl.] LT",lastWeek:"[forrige] dddd [kl.] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s siden",s:"noen sekunder",ss:"%d sekunder",m:"ett minutt",mm:"%d minutter",h:"en time",hh:"%d timer",d:"en dag",dd:"%d dager",w:"en uke",ww:"%d uker",M:"en mned",MM:"%d mneder",y:"ett r",yy:"%d r"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("ne",{months:"___________".split("_"),monthsShort:"._.__.___._._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"._._._._._._.".split("_"),weekdaysMin:"._._._._._._.".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=10?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<3?"":hour<12?"":hour<16?"":hour<20?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[] dddd[,] LT",lastDay:"[] LT",lastWeek:"[] dddd[,] LT",sameElse:"L"},relativeTime:{future:"%s",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortWithDots="jan._feb._mrt._apr._mei_jun._jul._aug._sep._okt._nov._dec.".split("_"),monthsShortWithoutDots="jan_feb_mrt_apr_mei_jun_jul_aug_sep_okt_nov_dec".split("_"),monthsParse=[/^jan/i,/^feb/i,/^maart|mrt.?$/i,/^apr/i,/^mei$/i,/^jun[i.]?$/i,/^jul[i.]?$/i,/^aug/i,/^sep/i,/^okt/i,/^nov/i,/^dec/i],monthsRegex=/^(januari|februari|maart|april|mei|ju[nl]i|augustus|september|oktober|november|december|jan\.?|feb\.?|mrt\.?|apr\.?|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i;moment.defineLocale("nl",{months:"januari_februari_maart_april_mei_juni_juli_augustus_september_oktober_november_december".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShortWithoutDots[m.month()]:monthsShortWithDots[m.month()]:monthsShortWithDots},monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(januari|februari|maart|april|mei|ju[nl]i|augustus|september|oktober|november|december)/i,monthsShortStrictRegex:/^(jan\.?|feb\.?|mrt\.?|apr\.?|mei|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"zondag_maandag_dinsdag_woensdag_donderdag_vrijdag_zaterdag".split("_"),weekdaysShort:"zo._ma._di._wo._do._vr._za.".split("_"),weekdaysMin:"zo_ma_di_wo_do_vr_za".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD-MM-YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[vandaag om] LT",nextDay:"[morgen om] LT",nextWeek:"dddd [om] LT",lastDay:"[gisteren om] LT",lastWeek:"[afgelopen] dddd [om] LT",sameElse:"L"},relativeTime:{future:"over %s",past:"%s geleden",s:"een paar seconden",ss:"%d seconden",m:"n minuut",mm:"%d minuten",h:"n uur",hh:"%d uur",d:"n dag",dd:"%d dagen",w:"n week",ww:"%d weken",M:"n maand",MM:"%d maanden",y:"n jaar",yy:"%d jaar"},dayOfMonthOrdinalParse:/\d{1,2}(ste|de)/,ordinal:function(number){return number+(1===number||8===number||number>=20?"ste":"de")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsShortWithDots="jan._feb._mrt._apr._mei_jun._jul._aug._sep._okt._nov._dec.".split("_"),monthsShortWithoutDots="jan_feb_mrt_apr_mei_jun_jul_aug_sep_okt_nov_dec".split("_"),monthsParse=[/^jan/i,/^feb/i,/^maart|mrt.?$/i,/^apr/i,/^mei$/i,/^jun[i.]?$/i,/^jul[i.]?$/i,/^aug/i,/^sep/i,/^okt/i,/^nov/i,/^dec/i],monthsRegex=/^(januari|februari|maart|april|mei|ju[nl]i|augustus|september|oktober|november|december|jan\.?|feb\.?|mrt\.?|apr\.?|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i;moment.defineLocale("nl-be",{months:"januari_februari_maart_april_mei_juni_juli_augustus_september_oktober_november_december".split("_"),monthsShort:function(m,format){return m?/-MMM-/.test(format)?monthsShortWithoutDots[m.month()]:monthsShortWithDots[m.month()]:monthsShortWithDots},monthsRegex:monthsRegex,monthsShortRegex:monthsRegex,monthsStrictRegex:/^(januari|februari|maart|april|mei|ju[nl]i|augustus|september|oktober|november|december)/i,monthsShortStrictRegex:/^(jan\.?|feb\.?|mrt\.?|apr\.?|mei|ju[nl]\.?|aug\.?|sep\.?|okt\.?|nov\.?|dec\.?)/i,monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"zondag_maandag_dinsdag_woensdag_donderdag_vrijdag_zaterdag".split("_"),weekdaysShort:"zo._ma._di._wo._do._vr._za.".split("_"),weekdaysMin:"zo_ma_di_wo_do_vr_za".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[vandaag om] LT",nextDay:"[morgen om] LT",nextWeek:"dddd [om] LT",lastDay:"[gisteren om] LT",lastWeek:"[afgelopen] dddd [om] LT",sameElse:"L"},relativeTime:{future:"over %s",past:"%s geleden",s:"een paar seconden",ss:"%d seconden",m:"n minuut",mm:"%d minuten",h:"n uur",hh:"%d uur",d:"n dag",dd:"%d dagen",M:"n maand",MM:"%d maanden",y:"n jaar",yy:"%d jaar"},dayOfMonthOrdinalParse:/\d{1,2}(ste|de)/,ordinal:function(number){return number+(1===number||8===number||number>=20?"ste":"de")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("nn",{months:"januar_februar_mars_april_mai_juni_juli_august_september_oktober_november_desember".split("_"),monthsShort:"jan._feb._mars_apr._mai_juni_juli_aug._sep._okt._nov._des.".split("_"),monthsParseExact:!0,weekdays:"sundag_mndag_tysdag_onsdag_torsdag_fredag_laurdag".split("_"),weekdaysShort:"su._m._ty._on._to._fr._lau.".split("_"),weekdaysMin:"su_m_ty_on_to_fr_la".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY [kl.] H:mm",LLLL:"dddd D. MMMM YYYY [kl.] HH:mm"},calendar:{sameDay:"[I dag klokka] LT",nextDay:"[I morgon klokka] LT",nextWeek:"dddd [klokka] LT",lastDay:"[I gr klokka] LT",lastWeek:"[Fregande] dddd [klokka] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"%s sidan",s:"nokre sekund",ss:"%d sekund",m:"eit minutt",mm:"%d minutt",h:"ein time",hh:"%d timar",d:"ein dag",dd:"%d dagar",w:"ei veke",ww:"%d veker",M:"ein mnad",MM:"%d mnader",y:"eit r",yy:"%d r"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("oc-lnc",{months:{standalone:"genir_febrir_mar_abril_mai_junh_julhet_agost_setembre_octbre_novembre_decembre".split("_"),format:"de genir_de febrir_de mar_d'abril_de mai_de junh_de julhet_d'agost_de setembre_d'octbre_de novembre_de decembre".split("_"),isFormat:/D[oD]?(\s)+MMMM/},monthsShort:"gen._febr._mar_abr._mai_junh_julh._ago._set._oct._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"dimenge_diluns_dimars_dimcres_dijus_divendres_dissabte".split("_"),weekdaysShort:"dg._dl._dm._dc._dj._dv._ds.".split("_"),weekdaysMin:"dg_dl_dm_dc_dj_dv_ds".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [de] YYYY",ll:"D MMM YYYY",LLL:"D MMMM [de] YYYY [a] H:mm",lll:"D MMM YYYY, H:mm",LLLL:"dddd D MMMM [de] YYYY [a] H:mm",llll:"ddd D MMM YYYY, H:mm"},calendar:{sameDay:"[ui a] LT",nextDay:"[deman a] LT",nextWeek:"dddd [a] LT",lastDay:"[ir a] LT",lastWeek:"dddd [passat a] LT",sameElse:"L"},relativeTime:{future:"d'aqu %s",past:"fa %s",s:"unas segondas",ss:"%d segondas",m:"una minuta",mm:"%d minutas",h:"una ora",hh:"%d oras",d:"un jorn",dd:"%d jorns",M:"un mes",MM:"%d meses",y:"un an",yy:"%d ans"},dayOfMonthOrdinalParse:/\d{1,2}(r|n|t||a)/,ordinal:function(number,period){var output=1===number?"r":2===number?"n":3===number?"r":4===number?"t":"";return"w"!==period&&"W"!==period||(output="a"),number+output},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("pa-in",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm ",LTS:"A h:mm:ss ",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm ",LLLL:"dddd, D MMMM YYYY, A h:mm "},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[] dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=10?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var monthsNominative="stycze_luty_marzec_kwiecie_maj_czerwiec_lipiec_sierpie_wrzesie_padziernik_listopad_grudzie".split("_"),monthsSubjective="stycznia_lutego_marca_kwietnia_maja_czerwca_lipca_sierpnia_wrzenia_padziernika_listopada_grudnia".split("_"),monthsParse=[/^sty/i,/^lut/i,/^mar/i,/^kwi/i,/^maj/i,/^cze/i,/^lip/i,/^sie/i,/^wrz/i,/^pa/i,/^lis/i,/^gru/i];function plural(n){return n%10<5&&n%10>1&&~~(n/10)%10!=1}function translate(number,withoutSuffix,key){var result=number+" ";switch(key){case"ss":return result+(plural(number)?"sekundy":"sekund");case"m":return withoutSuffix?"minuta":"minut";case"mm":return result+(plural(number)?"minuty":"minut");case"h":return withoutSuffix?"godzina":"godzin";case"hh":return result+(plural(number)?"godziny":"godzin");case"ww":return result+(plural(number)?"tygodnie":"tygodni");case"MM":return result+(plural(number)?"miesice":"miesicy");case"yy":return result+(plural(number)?"lata":"lat")}}moment.defineLocale("pl",{months:function(momentToFormat,format){return momentToFormat?/D MMMM/.test(format)?monthsSubjective[momentToFormat.month()]:monthsNominative[momentToFormat.month()]:monthsNominative},monthsShort:"sty_lut_mar_kwi_maj_cze_lip_sie_wrz_pa_lis_gru".split("_"),monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,weekdays:"niedziela_poniedziaek_wtorek_roda_czwartek_pitek_sobota".split("_"),weekdaysShort:"ndz_pon_wt_r_czw_pt_sob".split("_"),weekdaysMin:"Nd_Pn_Wt_r_Cz_Pt_So".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Dzi o] LT",nextDay:"[Jutro o] LT",nextWeek:function(){switch(this.day()){case 0:return"[W niedziel o] LT";case 2:return"[We wtorek o] LT";case 3:return"[W rod o] LT";case 6:return"[W sobot o] LT";default:return"[W] dddd [o] LT"}},lastDay:"[Wczoraj o] LT",lastWeek:function(){switch(this.day()){case 0:return"[W zesz niedziel o] LT";case 3:return"[W zesz rod o] LT";case 6:return"[W zesz sobot o] LT";default:return"[W zeszy] dddd [o] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"%s temu",s:"kilka sekund",ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:"1 dzie",dd:"%d dni",w:"tydzie",ww:translate,M:"miesic",MM:translate,y:"rok",yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("pt",{months:"janeiro_fevereiro_maro_abril_maio_junho_julho_agosto_setembro_outubro_novembro_dezembro".split("_"),monthsShort:"jan_fev_mar_abr_mai_jun_jul_ago_set_out_nov_dez".split("_"),weekdays:"Domingo_Segunda-feira_Tera-feira_Quarta-feira_Quinta-feira_Sexta-feira_Sbado".split("_"),weekdaysShort:"Dom_Seg_Ter_Qua_Qui_Sex_Sb".split("_"),weekdaysMin:"Do_2_3_4_5_6_S".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY HH:mm",LLLL:"dddd, D [de] MMMM [de] YYYY HH:mm"},calendar:{sameDay:"[Hoje s] LT",nextDay:"[Amanh s] LT",nextWeek:"dddd [s] LT",lastDay:"[Ontem s] LT",lastWeek:function(){return 0===this.day()||6===this.day()?"[ltimo] dddd [s] LT":"[ltima] dddd [s] LT"},sameElse:"L"},relativeTime:{future:"em %s",past:"h %s",s:"segundos",ss:"%d segundos",m:"um minuto",mm:"%d minutos",h:"uma hora",hh:"%d horas",d:"um dia",dd:"%d dias",w:"uma semana",ww:"%d semanas",M:"um ms",MM:"%d meses",y:"um ano",yy:"%d anos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("pt-br",{months:"janeiro_fevereiro_maro_abril_maio_junho_julho_agosto_setembro_outubro_novembro_dezembro".split("_"),monthsShort:"jan_fev_mar_abr_mai_jun_jul_ago_set_out_nov_dez".split("_"),weekdays:"domingo_segunda-feira_tera-feira_quarta-feira_quinta-feira_sexta-feira_sbado".split("_"),weekdaysShort:"dom_seg_ter_qua_qui_sex_sb".split("_"),weekdaysMin:"do_2_3_4_5_6_s".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D [de] MMMM [de] YYYY",LLL:"D [de] MMMM [de] YYYY [s] HH:mm",LLLL:"dddd, D [de] MMMM [de] YYYY [s] HH:mm"},calendar:{sameDay:"[Hoje s] LT",nextDay:"[Amanh s] LT",nextWeek:"dddd [s] LT",lastDay:"[Ontem s] LT",lastWeek:function(){return 0===this.day()||6===this.day()?"[ltimo] dddd [s] LT":"[ltima] dddd [s] LT"},sameElse:"L"},relativeTime:{future:"em %s",past:"h %s",s:"poucos segundos",ss:"%d segundos",m:"um minuto",mm:"%d minutos",h:"uma hora",hh:"%d horas",d:"um dia",dd:"%d dias",M:"um ms",MM:"%d meses",y:"um ano",yy:"%d anos"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",invalidDate:"Data invlida"})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function relativeTimeWithPlural(number,withoutSuffix,key){var separator=" ";return(number%100>=20||number>=100&&number%100==0)&&(separator=" de "),number+separator+{ss:"secunde",mm:"minute",hh:"ore",dd:"zile",ww:"sptmni",MM:"luni",yy:"ani"}[key]}moment.defineLocale("ro",{months:"ianuarie_februarie_martie_aprilie_mai_iunie_iulie_august_septembrie_octombrie_noiembrie_decembrie".split("_"),monthsShort:"ian._feb._mart._apr._mai_iun._iul._aug._sept._oct._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"duminic_luni_mari_miercuri_joi_vineri_smbt".split("_"),weekdaysShort:"Dum_Lun_Mar_Mie_Joi_Vin_Sm".split("_"),weekdaysMin:"Du_Lu_Ma_Mi_Jo_Vi_S".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY H:mm",LLLL:"dddd, D MMMM YYYY H:mm"},calendar:{sameDay:"[azi la] LT",nextDay:"[mine la] LT",nextWeek:"dddd [la] LT",lastDay:"[ieri la] LT",lastWeek:"[fosta] dddd [la] LT",sameElse:"L"},relativeTime:{future:"peste %s",past:"%s n urm",s:"cteva secunde",ss:relativeTimeWithPlural,m:"un minut",mm:relativeTimeWithPlural,h:"o or",hh:relativeTimeWithPlural,d:"o zi",dd:relativeTimeWithPlural,w:"o sptmn",ww:relativeTimeWithPlural,M:"o lun",MM:relativeTimeWithPlural,y:"un an",yy:relativeTimeWithPlural},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function relativeTimeWithPlural(number,withoutSuffix,key){var num,forms;return"m"===key?withoutSuffix?"":"":number+" "+(num=+number,forms={ss:withoutSuffix?"__":"__",mm:withoutSuffix?"__":"__",hh:"__",dd:"__",ww:"__",MM:"__",yy:"__"}[key].split("_"),num%10==1&&num%100!=11?forms[0]:num%10>=2&&num%10<=4&&(num%100<10||num%100>=20)?forms[1]:forms[2])}var monthsParse=[/^/i,/^/i,/^/i,/^/i,/^[]/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i,/^/i];moment.defineLocale("ru",{months:{format:"___________".split("_"),standalone:"___________".split("_")},monthsShort:{format:"._._._.____._._._._.".split("_"),standalone:"._.__.____._._._._.".split("_")},weekdays:{standalone:"______".split("_"),format:"______".split("_"),isFormat:/\[ ?[] ?(?:||)? ?] ?dddd/},weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),monthsParse:monthsParse,longMonthsParse:monthsParse,shortMonthsParse:monthsParse,monthsRegex:/^([]|\.?|[]|?\.?|?|\.?|[]|\.?|[]|[]|\.?|[]|\.?|?|\.?|[]|?\.?|[]|\.?|[]|?\.?|[]|\.?)/i,monthsShortRegex:/^([]|\.?|[]|?\.?|?|\.?|[]|\.?|[]|[]|\.?|[]|\.?|?|\.?|[]|?\.?|[]|\.?|[]|?\.?|[]|\.?)/i,monthsStrictRegex:/^([]|[]|?|[]|[]|[]|[]|?|[]|[]|[]|[])/i,monthsShortStrictRegex:/^(\.|?\.|[.]|\.|[]|[.]|[.]|\.|?\.|\.|?\.|\.)/i,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY .",LLL:"D MMMM YYYY ., H:mm",LLLL:"dddd, D MMMM YYYY ., H:mm"},calendar:{sameDay:"[, ] LT",nextDay:"[, ] LT",lastDay:"[, ] LT",nextWeek:function(now){if(now.week()===this.week())return 2===this.day()?"[] dddd, [] LT":"[] dddd, [] LT";switch(this.day()){case 0:return"[ ] dddd, [] LT";case 1:case 2:case 4:return"[ ] dddd, [] LT";case 3:case 5:case 6:return"[ ] dddd, [] LT"}},lastWeek:function(now){if(now.week()===this.week())return 2===this.day()?"[] dddd, [] LT":"[] dddd, [] LT";switch(this.day()){case 0:return"[ ] dddd, [] LT";case 1:case 2:case 4:return"[ ] dddd, [] LT";case 3:case 5:case 6:return"[ ] dddd, [] LT"}},sameElse:"L"},relativeTime:{future:" %s",past:"%s ",s:" ",ss:relativeTimeWithPlural,m:relativeTimeWithPlural,mm:relativeTimeWithPlural,h:"",hh:relativeTimeWithPlural,d:"",dd:relativeTimeWithPlural,w:"",ww:relativeTimeWithPlural,M:"",MM:relativeTimeWithPlural,y:"",yy:relativeTimeWithPlural},meridiemParse:/|||/i,isPM:function(input){return/^(|)$/.test(input)},meridiem:function(hour,minute,isLower){return hour<4?"":hour<12?"":hour<17?"":""},dayOfMonthOrdinalParse:/\d{1,2}-(||)/,ordinal:function(number,period){switch(period){case"M":case"d":case"DDD":return number+"-";case"D":return number+"-";case"w":case"W":return number+"-";default:return number}},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var months=["","","","","","","","","","","",""],days=["","","","","","",""];moment.defineLocale("sd",{months:months,monthsShort:months,weekdays:days,weekdaysShort:days,weekdaysMin:days,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd [  ] LT",lastDay:"[] LT",lastWeek:"[ ] dddd [] LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(//g,",")},postformat:function(string){return string.replace(/,/g,"")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("se",{months:"oajagemnnu_guovvamnnu_njukamnnu_cuoomnnu_miessemnnu_geassemnnu_suoidnemnnu_borgemnnu_akamnnu_golggotmnnu_skbmamnnu_juovlamnnu".split("_"),monthsShort:"oj_guov_njuk_cuo_mies_geas_suoi_borg_ak_golg_skb_juov".split("_"),weekdays:"sotnabeaivi_vuossrga_maebrga_gaskavahkku_duorastat_bearjadat_lvvardat".split("_"),weekdaysShort:"sotn_vuos_ma_gask_duor_bear_lv".split("_"),weekdaysMin:"s_v_m_g_d_b_L".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"MMMM D. [b.] YYYY",LLL:"MMMM D. [b.] YYYY [ti.] HH:mm",LLLL:"dddd, MMMM D. [b.] YYYY [ti.] HH:mm"},calendar:{sameDay:"[otne ti] LT",nextDay:"[ihttin ti] LT",nextWeek:"dddd [ti] LT",lastDay:"[ikte ti] LT",lastWeek:"[ovddit] dddd [ti] LT",sameElse:"L"},relativeTime:{future:"%s geaes",past:"mait %s",s:"moadde sekunddat",ss:"%d sekunddat",m:"okta minuhta",mm:"%d minuhtat",h:"okta diimmu",hh:"%d diimmut",d:"okta beaivi",dd:"%d beaivvit",M:"okta mnnu",MM:"%d mnut",y:"okta jahki",yy:"%d jagit"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("si",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"a h:mm",LTS:"a h:mm:ss",L:"YYYY/MM/DD",LL:"YYYY MMMM D",LLL:"YYYY MMMM D, a h:mm",LLLL:"YYYY MMMM D [] dddd, a h:mm:ss"},calendar:{sameDay:"[] LT[]",nextDay:"[] LT[]",nextWeek:"dddd LT[]",lastDay:"[] LT[]",lastWeek:"[] dddd LT[]",sameElse:"L"},relativeTime:{future:"%s",past:"%s ",s:" ",ss:" %d",m:"",mm:" %d",h:"",hh:" %d",d:"",dd:" %d",M:"",MM:" %d",y:"",yy:" %d"},dayOfMonthOrdinalParse:/\d{1,2} /,ordinal:function(number){return number+" "},meridiemParse:/ | |.|../,isPM:function(input){return".."===input||" "===input},meridiem:function(hours,minutes,isLower){return hours>11?isLower?"..":" ":isLower?"..":" "}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var months="janur_februr_marec_aprl_mj_jn_jl_august_september_oktber_november_december".split("_"),monthsShort="jan_feb_mar_apr_mj_jn_jl_aug_sep_okt_nov_dec".split("_");function plural(n){return n>1&&n<5}function translate(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"pr seknd":"pr sekundami";case"ss":return withoutSuffix||isFuture?result+(plural(number)?"sekundy":"seknd"):result+"sekundami";case"m":return withoutSuffix?"minta":isFuture?"mintu":"mintou";case"mm":return withoutSuffix||isFuture?result+(plural(number)?"minty":"mint"):result+"mintami";case"h":return withoutSuffix?"hodina":isFuture?"hodinu":"hodinou";case"hh":return withoutSuffix||isFuture?result+(plural(number)?"hodiny":"hodn"):result+"hodinami";case"d":return withoutSuffix||isFuture?"de":"dom";case"dd":return withoutSuffix||isFuture?result+(plural(number)?"dni":"dn"):result+"dami";case"M":return withoutSuffix||isFuture?"mesiac":"mesiacom";case"MM":return withoutSuffix||isFuture?result+(plural(number)?"mesiace":"mesiacov"):result+"mesiacmi";case"y":return withoutSuffix||isFuture?"rok":"rokom";case"yy":return withoutSuffix||isFuture?result+(plural(number)?"roky":"rokov"):result+"rokmi"}}moment.defineLocale("sk",{months:months,monthsShort:monthsShort,weekdays:"nedea_pondelok_utorok_streda_tvrtok_piatok_sobota".split("_"),weekdaysShort:"ne_po_ut_st_t_pi_so".split("_"),weekdaysMin:"ne_po_ut_st_t_pi_so".split("_"),longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD.MM.YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd D. MMMM YYYY H:mm"},calendar:{sameDay:"[dnes o] LT",nextDay:"[zajtra o] LT",nextWeek:function(){switch(this.day()){case 0:return"[v nedeu o] LT";case 1:case 2:return"[v] dddd [o] LT";case 3:return"[v stredu o] LT";case 4:return"[vo tvrtok o] LT";case 5:return"[v piatok o] LT";case 6:return"[v sobotu o] LT"}},lastDay:"[vera o] LT",lastWeek:function(){switch(this.day()){case 0:return"[minul nedeu o] LT";case 1:case 2:return"[minul] dddd [o] LT";case 3:return"[minul stredu o] LT";case 4:case 5:return"[minul] dddd [o] LT";case 6:return"[minul sobotu o] LT"}},sameElse:"L"},relativeTime:{future:"za %s",past:"pred %s",s:translate,ss:translate,m:translate,mm:translate,h:translate,hh:translate,d:translate,dd:translate,M:translate,MM:translate,y:translate,yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var result=number+" ";switch(key){case"s":return withoutSuffix||isFuture?"nekaj sekund":"nekaj sekundami";case"ss":return result+=1===number?withoutSuffix?"sekundo":"sekundi":2===number?withoutSuffix||isFuture?"sekundi":"sekundah":number<5?withoutSuffix||isFuture?"sekunde":"sekundah":"sekund";case"m":return withoutSuffix?"ena minuta":"eno minuto";case"mm":return result+=1===number?withoutSuffix?"minuta":"minuto":2===number?withoutSuffix||isFuture?"minuti":"minutama":number<5?withoutSuffix||isFuture?"minute":"minutami":withoutSuffix||isFuture?"minut":"minutami";case"h":return withoutSuffix?"ena ura":"eno uro";case"hh":return result+=1===number?withoutSuffix?"ura":"uro":2===number?withoutSuffix||isFuture?"uri":"urama":number<5?withoutSuffix||isFuture?"ure":"urami":withoutSuffix||isFuture?"ur":"urami";case"d":return withoutSuffix||isFuture?"en dan":"enim dnem";case"dd":return result+=1===number?withoutSuffix||isFuture?"dan":"dnem":2===number?withoutSuffix||isFuture?"dni":"dnevoma":withoutSuffix||isFuture?"dni":"dnevi";case"M":return withoutSuffix||isFuture?"en mesec":"enim mesecem";case"MM":return result+=1===number?withoutSuffix||isFuture?"mesec":"mesecem":2===number?withoutSuffix||isFuture?"meseca":"mesecema":number<5?withoutSuffix||isFuture?"mesece":"meseci":withoutSuffix||isFuture?"mesecev":"meseci";case"y":return withoutSuffix||isFuture?"eno leto":"enim letom";case"yy":return result+=1===number?withoutSuffix||isFuture?"leto":"letom":2===number?withoutSuffix||isFuture?"leti":"letoma":number<5?withoutSuffix||isFuture?"leta":"leti":withoutSuffix||isFuture?"let":"leti"}}moment.defineLocale("sl",{months:"januar_februar_marec_april_maj_junij_julij_avgust_september_oktober_november_december".split("_"),monthsShort:"jan._feb._mar._apr._maj._jun._jul._avg._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedelja_ponedeljek_torek_sreda_etrtek_petek_sobota".split("_"),weekdaysShort:"ned._pon._tor._sre._et._pet._sob.".split("_"),weekdaysMin:"ne_po_to_sr_e_pe_so".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD. MM. YYYY",LL:"D. MMMM YYYY",LLL:"D. MMMM YYYY H:mm",LLLL:"dddd, D. MMMM YYYY H:mm"},calendar:{sameDay:"[danes ob] LT",nextDay:"[jutri ob] LT",nextWeek:function(){switch(this.day()){case 0:return"[v] [nedeljo] [ob] LT";case 3:return"[v] [sredo] [ob] LT";case 6:return"[v] [soboto] [ob] LT";case 1:case 2:case 4:case 5:return"[v] dddd [ob] LT"}},lastDay:"[veraj ob] LT",lastWeek:function(){switch(this.day()){case 0:return"[prejnjo] [nedeljo] [ob] LT";case 3:return"[prejnjo] [sredo] [ob] LT";case 6:return"[prejnjo] [soboto] [ob] LT";case 1:case 2:case 4:case 5:return"[prejnji] dddd [ob] LT"}},sameElse:"L"},relativeTime:{future:"ez %s",past:"pred %s",s:processRelativeTime,ss:processRelativeTime,m:processRelativeTime,mm:processRelativeTime,h:processRelativeTime,hh:processRelativeTime,d:processRelativeTime,dd:processRelativeTime,M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("sq",{months:"Janar_Shkurt_Mars_Prill_Maj_Qershor_Korrik_Gusht_Shtator_Tetor_Nntor_Dhjetor".split("_"),monthsShort:"Jan_Shk_Mar_Pri_Maj_Qer_Kor_Gus_Sht_Tet_Nn_Dhj".split("_"),weekdays:"E Diel_E Hn_E Mart_E Mrkur_E Enjte_E Premte_E Shtun".split("_"),weekdaysShort:"Die_Hn_Mar_Mr_Enj_Pre_Sht".split("_"),weekdaysMin:"D_H_Ma_M_E_P_Sh".split("_"),weekdaysParseExact:!0,meridiemParse:/PD|MD/,isPM:function(input){return"M"===input.charAt(0)},meridiem:function(hours,minutes,isLower){return hours<12?"PD":"MD"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Sot n] LT",nextDay:"[Nesr n] LT",nextWeek:"dddd [n] LT",lastDay:"[Dje n] LT",lastWeek:"dddd [e kaluar n] LT",sameElse:"L"},relativeTime:{future:"n %s",past:"%s m par",s:"disa sekonda",ss:"%d sekonda",m:"nj minut",mm:"%d minuta",h:"nj or",hh:"%d or",d:"nj dit",dd:"%d dit",M:"nj muaj",MM:"%d muaj",y:"nj vit",yy:"%d vite"},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var translator={words:{ss:["sekunda","sekunde","sekundi"],m:["jedan minut","jedne minute"],mm:["minut","minute","minuta"],h:["jedan sat","jednog sata"],hh:["sat","sata","sati"],dd:["dan","dana","dana"],MM:["mesec","meseca","meseci"],yy:["godina","godine","godina"]},correctGrammaticalCase:function(number,wordKey){return 1===number?wordKey[0]:number>=2&&number<=4?wordKey[1]:wordKey[2]},translate:function(number,withoutSuffix,key){var wordKey=translator.words[key];return 1===key.length?withoutSuffix?wordKey[0]:wordKey[1]:number+" "+translator.correctGrammaticalCase(number,wordKey)}};moment.defineLocale("sr",{months:"januar_februar_mart_april_maj_jun_jul_avgust_septembar_oktobar_novembar_decembar".split("_"),monthsShort:"jan._feb._mar._apr._maj_jun_jul_avg._sep._okt._nov._dec.".split("_"),monthsParseExact:!0,weekdays:"nedelja_ponedeljak_utorak_sreda_etvrtak_petak_subota".split("_"),weekdaysShort:"ned._pon._uto._sre._et._pet._sub.".split("_"),weekdaysMin:"ne_po_ut_sr_e_pe_su".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"D. M. YYYY.",LL:"D. MMMM YYYY.",LLL:"D. MMMM YYYY. H:mm",LLLL:"dddd, D. MMMM YYYY. H:mm"},calendar:{sameDay:"[danas u] LT",nextDay:"[sutra u] LT",nextWeek:function(){switch(this.day()){case 0:return"[u] [nedelju] [u] LT";case 3:return"[u] [sredu] [u] LT";case 6:return"[u] [subotu] [u] LT";case 1:case 2:case 4:case 5:return"[u] dddd [u] LT"}},lastDay:"[jue u] LT",lastWeek:function(){return["[prole] [nedelje] [u] LT","[prolog] [ponedeljka] [u] LT","[prolog] [utorka] [u] LT","[prole] [srede] [u] LT","[prolog] [etvrtka] [u] LT","[prolog] [petka] [u] LT","[prole] [subote] [u] LT"][this.day()]},sameElse:"L"},relativeTime:{future:"za %s",past:"pre %s",s:"nekoliko sekundi",ss:translator.translate,m:translator.translate,mm:translator.translate,h:translator.translate,hh:translator.translate,d:"dan",dd:translator.translate,M:"mesec",MM:translator.translate,y:"godinu",yy:translator.translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var translator={words:{ss:["","",""],m:[" "," "],mm:["","",""],h:[" "," "],hh:["","",""],dd:["","",""],MM:["","",""],yy:["","",""]},correctGrammaticalCase:function(number,wordKey){return 1===number?wordKey[0]:number>=2&&number<=4?wordKey[1]:wordKey[2]},translate:function(number,withoutSuffix,key){var wordKey=translator.words[key];return 1===key.length?withoutSuffix?wordKey[0]:wordKey[1]:number+" "+translator.correctGrammaticalCase(number,wordKey)}};moment.defineLocale("sr-cyrl",{months:"___________".split("_"),monthsShort:"._._._.____._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"._._._._._._.".split("_"),weekdaysMin:"______".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"D. M. YYYY.",LL:"D. MMMM YYYY.",LLL:"D. MMMM YYYY. H:mm",LLLL:"dddd, D. MMMM YYYY. H:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:function(){switch(this.day()){case 0:return"[] [] [] LT";case 3:return"[] [] [] LT";case 6:return"[] [] [] LT";case 1:case 2:case 4:case 5:return"[] dddd [] LT"}},lastDay:"[ ] LT",lastWeek:function(){return["[] [] [] LT","[] [] [] LT","[] [] [] LT","[] [] [] LT","[] [] [] LT","[] [] [] LT","[] [] [] LT"][this.day()]},sameElse:"L"},relativeTime:{future:" %s",past:" %s",s:" ",ss:translator.translate,m:translator.translate,mm:translator.translate,h:translator.translate,hh:translator.translate,d:"",dd:translator.translate,M:"",MM:translator.translate,y:"",yy:translator.translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ss",{months:"Bhimbidvwane_Indlovana_Indlov'lenkhulu_Mabasa_Inkhwekhweti_Inhlaba_Kholwane_Ingci_Inyoni_Imphala_Lweti_Ingongoni".split("_"),monthsShort:"Bhi_Ina_Inu_Mab_Ink_Inh_Kho_Igc_Iny_Imp_Lwe_Igo".split("_"),weekdays:"Lisontfo_Umsombuluko_Lesibili_Lesitsatfu_Lesine_Lesihlanu_Umgcibelo".split("_"),weekdaysShort:"Lis_Umb_Lsb_Les_Lsi_Lsh_Umg".split("_"),weekdaysMin:"Li_Us_Lb_Lt_Ls_Lh_Ug".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Namuhla nga] LT",nextDay:"[Kusasa nga] LT",nextWeek:"dddd [nga] LT",lastDay:"[Itolo nga] LT",lastWeek:"dddd [leliphelile] [nga] LT",sameElse:"L"},relativeTime:{future:"nga %s",past:"wenteka nga %s",s:"emizuzwana lomcane",ss:"%d mzuzwana",m:"umzuzu",mm:"%d emizuzu",h:"lihora",hh:"%d emahora",d:"lilanga",dd:"%d emalanga",M:"inyanga",MM:"%d tinyanga",y:"umnyaka",yy:"%d iminyaka"},meridiemParse:/ekuseni|emini|entsambama|ebusuku/,meridiem:function(hours,minutes,isLower){return hours<11?"ekuseni":hours<15?"emini":hours<19?"entsambama":"ebusuku"},meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),"ekuseni"===meridiem?hour:"emini"===meridiem?hour>=11?hour:hour+12:"entsambama"===meridiem||"ebusuku"===meridiem?0===hour?0:hour+12:void 0},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("sv",{months:"januari_februari_mars_april_maj_juni_juli_augusti_september_oktober_november_december".split("_"),monthsShort:"jan_feb_mar_apr_maj_jun_jul_aug_sep_okt_nov_dec".split("_"),weekdays:"sndag_mndag_tisdag_onsdag_torsdag_fredag_lrdag".split("_"),weekdaysShort:"sn_mn_tis_ons_tor_fre_lr".split("_"),weekdaysMin:"s_m_ti_on_to_fr_l".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"D MMMM YYYY",LLL:"D MMMM YYYY [kl.] HH:mm",LLLL:"dddd D MMMM YYYY [kl.] HH:mm",lll:"D MMM YYYY HH:mm",llll:"ddd D MMM YYYY HH:mm"},calendar:{sameDay:"[Idag] LT",nextDay:"[Imorgon] LT",lastDay:"[Igr] LT",nextWeek:"[P] dddd LT",lastWeek:"[I] dddd[s] LT",sameElse:"L"},relativeTime:{future:"om %s",past:"fr %s sedan",s:"ngra sekunder",ss:"%d sekunder",m:"en minut",mm:"%d minuter",h:"en timme",hh:"%d timmar",d:"en dag",dd:"%d dagar",M:"en mnad",MM:"%d mnader",y:"ett r",yy:"%d r"},dayOfMonthOrdinalParse:/\d{1,2}(\:e|\:a)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?":e":1===b||2===b?":a":":e")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("sw",{months:"Januari_Februari_Machi_Aprili_Mei_Juni_Julai_Agosti_Septemba_Oktoba_Novemba_Desemba".split("_"),monthsShort:"Jan_Feb_Mac_Apr_Mei_Jun_Jul_Ago_Sep_Okt_Nov_Des".split("_"),weekdays:"Jumapili_Jumatatu_Jumanne_Jumatano_Alhamisi_Ijumaa_Jumamosi".split("_"),weekdaysShort:"Jpl_Jtat_Jnne_Jtan_Alh_Ijm_Jmos".split("_"),weekdaysMin:"J2_J3_J4_J5_Al_Ij_J1".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"hh:mm A",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[leo saa] LT",nextDay:"[kesho saa] LT",nextWeek:"[wiki ijayo] dddd [saat] LT",lastDay:"[jana] LT",lastWeek:"[wiki iliyopita] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s baadaye",past:"tokea %s",s:"hivi punde",ss:"sekunde %d",m:"dakika moja",mm:"dakika %d",h:"saa limoja",hh:"masaa %d",d:"siku moja",dd:"siku %d",M:"mwezi mmoja",MM:"miezi %d",y:"mwaka mmoja",yy:"miaka %d"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var symbolMap={1:"",2:"",3:"",4:"",5:"",6:"",7:"",8:"",9:"",0:""},numberMap={"":"1","":"2","":"3","":"4","":"5","":"6","":"7","":"8","":"9","":"0"};moment.defineLocale("ta",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, HH:mm",LLLL:"dddd, D MMMM YYYY, HH:mm"},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[ ] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:"  ",ss:"%d ",m:" ",mm:"%d ",h:"  ",hh:"%d  ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:function(number){return number+""},preparse:function(string){return string.replace(/[]/g,(function(match){return numberMap[match]}))},postformat:function(string){return string.replace(/\d/g,(function(match){return symbolMap[match]}))},meridiemParse:/|||||/,meridiem:function(hour,minute,isLower){return hour<2?" ":hour<6?" ":hour<10?" ":hour<14?" ":hour<18?" ":hour<22?" ":" "},meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<2?hour:hour+12:""===meridiem||""===meridiem||""===meridiem&&hour>=10?hour:hour+12},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("te",{months:"___________".split("_"),monthsShort:"._.__.____._._._._.".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"A h:mm",LTS:"A h:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY, A h:mm",LLLL:"dddd, D MMMM YYYY, A h:mm"},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"dddd, LT",lastDay:"[] LT",lastWeek:"[] dddd, LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:"%d",meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=10?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<10?"":hour<17?"":hour<20?"":""},week:{dow:0,doy:6}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("tet",{months:"Janeiru_Fevereiru_Marsu_Abril_Maiu_Juu_Jullu_Agustu_Setembru_Outubru_Novembru_Dezembru".split("_"),monthsShort:"Jan_Fev_Mar_Abr_Mai_Jun_Jul_Ago_Set_Out_Nov_Dez".split("_"),weekdays:"Domingu_Segunda_Tersa_Kuarta_Kinta_Sesta_Sabadu".split("_"),weekdaysShort:"Dom_Seg_Ters_Kua_Kint_Sest_Sab".split("_"),weekdaysMin:"Do_Seg_Te_Ku_Ki_Ses_Sa".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[Ohin iha] LT",nextDay:"[Aban iha] LT",nextWeek:"dddd [iha] LT",lastDay:"[Horiseik iha] LT",lastWeek:"dddd [semana kotuk] [iha] LT",sameElse:"L"},relativeTime:{future:"iha %s",past:"%s liuba",s:"segundu balun",ss:"segundu %d",m:"minutu ida",mm:"minutu %d",h:"oras ida",hh:"oras %d",d:"loron ida",dd:"loron %d",M:"fulan ida",MM:"fulan %d",y:"tinan ida",yy:"tinan %d"},dayOfMonthOrdinalParse:/\d{1,2}(st|nd|rd|th)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var suffixes={0:"-",1:"-",2:"-",3:"-",4:"-",5:"-",6:"-",7:"-",8:"-",9:"-",10:"-",12:"-",13:"-",20:"-",30:"-",40:"-",50:"-",60:"-",70:"-",80:"-",90:"-",100:"-"};moment.defineLocale("tg",{months:{format:"___________".split("_"),standalone:"___________".split("_")},monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",lastDay:"[ ] LT",nextWeek:"dddd[] [  ] LT",lastWeek:"dddd[] [  ] LT",sameElse:"L"},relativeTime:{future:" %s",past:"%s ",s:" ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},meridiemParse:/|||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem?hour<4?hour:hour+12:""===meridiem?hour:""===meridiem?hour>=11?hour:hour+12:""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){return hour<4?"":hour<11?"":hour<16?"":hour<19?"":""},dayOfMonthOrdinalParse:/\d{1,2}-(|)/,ordinal:function(number){return number+(suffixes[number]||suffixes[number%10]||suffixes[number>=100?100:null])},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("th",{months:"___________".split("_"),monthsShort:".._.._.._.._.._.._.._.._.._.._.._..".split("_"),monthsParseExact:!0,weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"._._._._._._.".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"H:mm",LTS:"H:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY  H:mm",LLLL:"dddd D MMMM YYYY  H:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd[ ] LT",lastDay:"[ ] LT",lastWeek:"[]dddd[ ] LT",sameElse:"L"},relativeTime:{future:" %s",past:"%s",s:"",ss:"%d ",m:"1 ",mm:"%d ",h:"1 ",hh:"%d ",d:"1 ",dd:"%d ",w:"1 ",ww:"%d ",M:"1 ",MM:"%d ",y:"1 ",yy:"%d "}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var suffixes={1:"'inji",5:"'inji",8:"'inji",70:"'inji",80:"'inji",2:"'nji",7:"'nji",20:"'nji",50:"'nji",3:"'nji",4:"'nji",100:"'nji",6:"'njy",9:"'unjy",10:"'unjy",30:"'unjy",60:"'ynjy",90:"'ynjy"};moment.defineLocale("tk",{months:"anwar_Fewral_Mart_Aprel_Ma_Iun_Iul_Awgust_Sentabr_Oktabr_Noabr_Dekabr".split("_"),monthsShort:"an_Few_Mar_Apr_Ma_In_Il_Awg_Sen_Okt_No_Dek".split("_"),weekdays:"ekenbe_Duenbe_Sienbe_arenbe_Penenbe_Anna_enbe".split("_"),weekdaysShort:"ek_Du_Si_ar_Pen_Ann_en".split("_"),weekdaysMin:"k_D_S_r_Pn_An_n".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[bugn sagat] LT",nextDay:"[ertir sagat] LT",nextWeek:"[indiki] dddd [sagat] LT",lastDay:"[dn] LT",lastWeek:"[geen] dddd [sagat] LT",sameElse:"L"},relativeTime:{future:"%s so",past:"%s ",s:"birne sekunt",m:"bir minut",mm:"%d minut",h:"bir sagat",hh:"%d sagat",d:"bir gn",dd:"%d gn",M:"bir a",MM:"%d a",y:"bir yl",yy:"%d yl"},ordinal:function(number,period){switch(period){case"d":case"D":case"Do":case"DD":return number;default:if(0===number)return number+"'unjy";var a=number%10;return number+(suffixes[a]||suffixes[number%100-a]||suffixes[number>=100?100:null])}},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("tl-ph",{months:"Enero_Pebrero_Marso_Abril_Mayo_Hunyo_Hulyo_Agosto_Setyembre_Oktubre_Nobyembre_Disyembre".split("_"),monthsShort:"Ene_Peb_Mar_Abr_May_Hun_Hul_Ago_Set_Okt_Nob_Dis".split("_"),weekdays:"Linggo_Lunes_Martes_Miyerkules_Huwebes_Biyernes_Sabado".split("_"),weekdaysShort:"Lin_Lun_Mar_Miy_Huw_Biy_Sab".split("_"),weekdaysMin:"Li_Lu_Ma_Mi_Hu_Bi_Sab".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"MM/D/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY HH:mm",LLLL:"dddd, MMMM DD, YYYY HH:mm"},calendar:{sameDay:"LT [ngayong araw]",nextDay:"[Bukas ng] LT",nextWeek:"LT [sa susunod na] dddd",lastDay:"LT [kahapon]",lastWeek:"LT [noong nakaraang] dddd",sameElse:"L"},relativeTime:{future:"sa loob ng %s",past:"%s ang nakalipas",s:"ilang segundo",ss:"%d segundo",m:"isang minuto",mm:"%d minuto",h:"isang oras",hh:"%d oras",d:"isang araw",dd:"%d araw",M:"isang buwan",MM:"%d buwan",y:"isang taon",yy:"%d taon"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:function(number){return number},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var numbersNouns="pagh_wa_cha_wej_loS_vagh_jav_Soch_chorgh_Hut".split("_");function translate(number,withoutSuffix,string,isFuture){var numberNoun=function(number){var hundred=Math.floor(number%1e3/100),ten=Math.floor(number%100/10),one=number%10,word="";return hundred>0&&(word+=numbersNouns[hundred]+"vatlh"),ten>0&&(word+=(""!==word?" ":"")+numbersNouns[ten]+"maH"),one>0&&(word+=(""!==word?" ":"")+numbersNouns[one]),""===word?"pagh":word}(number);switch(string){case"ss":return numberNoun+" lup";case"mm":return numberNoun+" tup";case"hh":return numberNoun+" rep";case"dd":return numberNoun+" jaj";case"MM":return numberNoun+" jar";case"yy":return numberNoun+" DIS"}}moment.defineLocale("tlh",{months:"tera jar wa_tera jar cha_tera jar wej_tera jar loS_tera jar vagh_tera jar jav_tera jar Soch_tera jar chorgh_tera jar Hut_tera jar wamaH_tera jar wamaH wa_tera jar wamaH cha".split("_"),monthsShort:"jar wa_jar cha_jar wej_jar loS_jar vagh_jar jav_jar Soch_jar chorgh_jar Hut_jar wamaH_jar wamaH wa_jar wamaH cha".split("_"),monthsParseExact:!0,weekdays:"lojmItjaj_DaSjaj_povjaj_ghItlhjaj_loghjaj_buqjaj_ghInjaj".split("_"),weekdaysShort:"lojmItjaj_DaSjaj_povjaj_ghItlhjaj_loghjaj_buqjaj_ghInjaj".split("_"),weekdaysMin:"lojmItjaj_DaSjaj_povjaj_ghItlhjaj_loghjaj_buqjaj_ghInjaj".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[DaHjaj] LT",nextDay:"[waleS] LT",nextWeek:"LLL",lastDay:"[waHu] LT",lastWeek:"LLL",sameElse:"L"},relativeTime:{future:function(output){var time=output;return time=-1!==output.indexOf("jaj")?time.slice(0,-3)+"leS":-1!==output.indexOf("jar")?time.slice(0,-3)+"waQ":-1!==output.indexOf("DIS")?time.slice(0,-3)+"nem":time+" pIq"},past:function(output){var time=output;return time=-1!==output.indexOf("jaj")?time.slice(0,-3)+"Hu":-1!==output.indexOf("jar")?time.slice(0,-3)+"wen":-1!==output.indexOf("DIS")?time.slice(0,-3)+"ben":time+" ret"},s:"puS lup",ss:translate,m:"wa tup",mm:translate,h:"wa rep",hh:translate,d:"wa jaj",dd:translate,M:"wa jar",MM:translate,y:"wa DIS",yy:translate},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var suffixes={1:"'inci",5:"'inci",8:"'inci",70:"'inci",80:"'inci",2:"'nci",7:"'nci",20:"'nci",50:"'nci",3:"'nc",4:"'nc",100:"'nc",6:"'nc",9:"'uncu",10:"'uncu",30:"'uncu",60:"'nc",90:"'nc"};moment.defineLocale("tr",{months:"Ocak_ubat_Mart_Nisan_Mays_Haziran_Temmuz_Austos_Eyll_Ekim_Kasm_Aralk".split("_"),monthsShort:"Oca_ub_Mar_Nis_May_Haz_Tem_Au_Eyl_Eki_Kas_Ara".split("_"),weekdays:"Pazar_Pazartesi_Sal_aramba_Perembe_Cuma_Cumartesi".split("_"),weekdaysShort:"Paz_Pts_Sal_ar_Per_Cum_Cts".split("_"),weekdaysMin:"Pz_Pt_Sa_a_Pe_Cu_Ct".split("_"),meridiem:function(hours,minutes,isLower){return hours<12?isLower?"":"":isLower?"s":"S"},meridiemParse:/||s|S/,isPM:function(input){return"s"===input||"S"===input},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[bugn saat] LT",nextDay:"[yarn saat] LT",nextWeek:"[gelecek] dddd [saat] LT",lastDay:"[dn] LT",lastWeek:"[geen] dddd [saat] LT",sameElse:"L"},relativeTime:{future:"%s sonra",past:"%s nce",s:"birka saniye",ss:"%d saniye",m:"bir dakika",mm:"%d dakika",h:"bir saat",hh:"%d saat",d:"bir gn",dd:"%d gn",w:"bir hafta",ww:"%d hafta",M:"bir ay",MM:"%d ay",y:"bir yl",yy:"%d yl"},ordinal:function(number,period){switch(period){case"d":case"D":case"Do":case"DD":return number;default:if(0===number)return number+"'nc";var a=number%10;return number+(suffixes[a]||suffixes[number%100-a]||suffixes[number>=100?100:null])}},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function processRelativeTime(number,withoutSuffix,key,isFuture){var format={s:["viensas secunds","'iensas secunds"],ss:[number+" secunds",number+" secunds"],m:["'n mut","'iens mut"],mm:[number+" muts",number+" muts"],h:["'n ora","'iensa ora"],hh:[number+" oras",number+" oras"],d:["'n ziua","'iensa ziua"],dd:[number+" ziuas",number+" ziuas"],M:["'n mes","'iens mes"],MM:[number+" mesen",number+" mesen"],y:["'n ar","'iens ar"],yy:[number+" ars",number+" ars"]};return isFuture||withoutSuffix?format[key][0]:format[key][1]}moment.defineLocale("tzl",{months:"Januar_Fevraglh_Mar_Avru_Mai_Gn_Julia_Guscht_Setemvar_Listopts_Noemvar_Zecemvar".split("_"),monthsShort:"Jan_Fev_Mar_Avr_Mai_Gn_Jul_Gus_Set_Lis_Noe_Zec".split("_"),weekdays:"Sladi_Lnei_Maitzi_Mrcuri_Xhadi_Vineri_Sturi".split("_"),weekdaysShort:"Sl_Ln_Mai_Mr_Xh_Vi_St".split("_"),weekdaysMin:"S_L_Ma_M_Xh_Vi_S".split("_"),longDateFormat:{LT:"HH.mm",LTS:"HH.mm.ss",L:"DD.MM.YYYY",LL:"D. MMMM [dallas] YYYY",LLL:"D. MMMM [dallas] YYYY HH.mm",LLLL:"dddd, [li] D. MMMM [dallas] YYYY HH.mm"},meridiemParse:/d\'o|d\'a/i,isPM:function(input){return"d'o"===input.toLowerCase()},meridiem:function(hours,minutes,isLower){return hours>11?isLower?"d'o":"D'O":isLower?"d'a":"D'A"},calendar:{sameDay:"[oxhi ] LT",nextDay:"[dem ] LT",nextWeek:"dddd [] LT",lastDay:"[ieiri ] LT",lastWeek:"[sr el] dddd [lasteu ] LT",sameElse:"L"},relativeTime:{future:"osprei %s",past:"ja%s",s:processRelativeTime,ss:processRelativeTime,m:processRelativeTime,mm:processRelativeTime,h:processRelativeTime,hh:processRelativeTime,d:processRelativeTime,dd:processRelativeTime,M:processRelativeTime,MM:processRelativeTime,y:processRelativeTime,yy:processRelativeTime},dayOfMonthOrdinalParse:/\d{1,2}\./,ordinal:"%d.",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("tzm",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[ ] LT",lastWeek:"dddd [] LT",sameElse:"L"},relativeTime:{future:"   %s",past:" %s",s:"",ss:"%d ",m:"",mm:"%d ",h:"",hh:"%d ",d:"",dd:"%d o",M:"o",MM:"%d ",y:"",yy:"%d "},week:{dow:6,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("tzm-latn",{months:"innayr_brayr_mars_ibrir_mayyw_ywnyw_ywlywz_wt_wtanbir_ktwbr_nwwanbir_dwjnbir".split("_"),monthsShort:"innayr_brayr_mars_ibrir_mayyw_ywnyw_ywlywz_wt_wtanbir_ktwbr_nwwanbir_dwjnbir".split("_"),weekdays:"asamas_aynas_asinas_akras_akwas_asimwas_asiyas".split("_"),weekdaysShort:"asamas_aynas_asinas_akras_akwas_asimwas_asiyas".split("_"),weekdaysMin:"asamas_aynas_asinas_akras_akwas_asimwas_asiyas".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},calendar:{sameDay:"[asdkh g] LT",nextDay:"[aska g] LT",nextWeek:"dddd [g] LT",lastDay:"[assant g] LT",lastWeek:"dddd [g] LT",sameElse:"L"},relativeTime:{future:"dadkh s yan %s",past:"yan %s",s:"imik",ss:"%d imik",m:"minu",mm:"%d minu",h:"saa",hh:"%d tassain",d:"ass",dd:"%d ossan",M:"ayowr",MM:"%d iyyirn",y:"asgas",yy:"%d isgasn"},week:{dow:6,doy:12}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("ug-cn",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY-MM-DD",LL:"YYYY-M-D-",LLL:"YYYY-M-D- HH:mm",LLLL:"dddd YYYY-M-D- HH:mm"},meridiemParse:/ || || |/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0)," "===meridiem||""===meridiem||" "===meridiem?hour:" "===meridiem||""===meridiem?hour+12:hour>=11?hour:hour+12},meridiem:function(hour,minute,isLower){var hm=100*hour+minute;return hm<600?" ":hm<900?"":hm<1130?" ":hm<1230?"":hm<1800?" ":""},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"[] dddd [] LT",lastDay:"[] LT",lastWeek:"[] dddd [] LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},dayOfMonthOrdinalParse:/\d{1,2}(-|-|-)/,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"-";case"w":case"W":return number+"-";default:return number}},preparse:function(string){return string.replace(//g,",")},postformat:function(string){return string.replace(/,/g,"")},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
function relativeTimeWithPlural(number,withoutSuffix,key){var num,forms;return"m"===key?withoutSuffix?"":"":"h"===key?withoutSuffix?"":"":number+" "+(num=+number,forms={ss:withoutSuffix?"__":"__",mm:withoutSuffix?"__":"__",hh:withoutSuffix?"__":"__",dd:"__",MM:"__",yy:"__"}[key].split("_"),num%10==1&&num%100!=11?forms[0]:num%10>=2&&num%10<=4&&(num%100<10||num%100>=20)?forms[1]:forms[2])}function processHoursFunction(str){return function(){return str+""+(11===this.hours()?"":"")+"] LT"}}moment.defineLocale("uk",{months:{format:"___________".split("_"),standalone:"___________".split("_")},monthsShort:"___________".split("_"),weekdays:function(m,format){var weekdays={nominative:"______".split("_"),accusative:"______".split("_"),genitive:"______".split("_")};return!0===m?weekdays.nominative.slice(1,7).concat(weekdays.nominative.slice(0,1)):m?weekdays[/(\[[]\]) ?dddd/.test(format)?"accusative":/\[?(?:|)? ?\] ?dddd/.test(format)?"genitive":"nominative"][m.day()]:weekdays.nominative},weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD.MM.YYYY",LL:"D MMMM YYYY .",LLL:"D MMMM YYYY ., HH:mm",LLLL:"dddd, D MMMM YYYY ., HH:mm"},calendar:{sameDay:processHoursFunction("[ "),nextDay:processHoursFunction("[ "),lastDay:processHoursFunction("[ "),nextWeek:processHoursFunction("[] dddd ["),lastWeek:function(){switch(this.day()){case 0:case 3:case 5:case 6:return processHoursFunction("[] dddd [").call(this);case 1:case 2:case 4:return processHoursFunction("[] dddd [").call(this)}},sameElse:"L"},relativeTime:{future:" %s",past:"%s ",s:" ",ss:relativeTimeWithPlural,m:relativeTimeWithPlural,mm:relativeTimeWithPlural,h:"",hh:relativeTimeWithPlural,d:"",dd:relativeTimeWithPlural,M:"",MM:relativeTimeWithPlural,y:"",yy:relativeTimeWithPlural},meridiemParse:/|||/,isPM:function(input){return/^(|)$/.test(input)},meridiem:function(hour,minute,isLower){return hour<4?"":hour<12?"":hour<17?"":""},dayOfMonthOrdinalParse:/\d{1,2}-(|)/,ordinal:function(number,period){switch(period){case"M":case"d":case"DDD":case"w":case"W":return number+"-";case"D":return number+"-";default:return number}},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
var months=["","","","","","","","","","","",""],days=["","","","","","",""];moment.defineLocale("ur",{months:months,monthsShort:months,weekdays:days,weekdaysShort:days,weekdaysMin:days,longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd D MMMM YYYY HH:mm"},meridiemParse:/|/,isPM:function(input){return""===input},meridiem:function(hour,minute,isLower){return hour<12?"":""},calendar:{sameDay:"[ ] LT",nextDay:"[ ] LT",nextWeek:"dddd [] LT",lastDay:"[  ] LT",lastWeek:"[] dddd [] LT",sameElse:"L"},relativeTime:{future:"%s ",past:"%s ",s:" ",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},preparse:function(string){return string.replace(//g,",")},postformat:function(string){return string.replace(/,/g,"")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("uz",{months:"___________".split("_"),monthsShort:"___________".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"D MMMM YYYY, dddd HH:mm"},calendar:{sameDay:"[ ] LT []",nextDay:"[] LT []",nextWeek:"dddd [ ] LT []",lastDay:"[ ] LT []",lastWeek:"[] dddd [ ] LT []",sameElse:"L"},relativeTime:{future:" %s ",past:"  %s ",s:"",ss:"%d ",m:" ",mm:"%d ",h:" ",hh:"%d ",d:" ",dd:"%d ",M:" ",MM:"%d ",y:" ",yy:"%d "},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("uz-latn",{months:"Yanvar_Fevral_Mart_Aprel_May_Iyun_Iyul_Avgust_Sentabr_Oktabr_Noyabr_Dekabr".split("_"),monthsShort:"Yan_Fev_Mar_Apr_May_Iyun_Iyul_Avg_Sen_Okt_Noy_Dek".split("_"),weekdays:"Yakshanba_Dushanba_Seshanba_Chorshanba_Payshanba_Juma_Shanba".split("_"),weekdaysShort:"Yak_Dush_Sesh_Chor_Pay_Jum_Shan".split("_"),weekdaysMin:"Ya_Du_Se_Cho_Pa_Ju_Sha".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"D MMMM YYYY, dddd HH:mm"},calendar:{sameDay:"[Bugun soat] LT [da]",nextDay:"[Ertaga] LT [da]",nextWeek:"dddd [kuni soat] LT [da]",lastDay:"[Kecha soat] LT [da]",lastWeek:"[O'tgan] dddd [kuni soat] LT [da]",sameElse:"L"},relativeTime:{future:"Yaqin %s ichida",past:"Bir necha %s oldin",s:"soniya",ss:"%d soniya",m:"bir daqiqa",mm:"%d daqiqa",h:"bir soat",hh:"%d soat",d:"bir kun",dd:"%d kun",M:"bir oy",MM:"%d oy",y:"bir yil",yy:"%d yil"},week:{dow:1,doy:7}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("vi",{months:"thng 1_thng 2_thng 3_thng 4_thng 5_thng 6_thng 7_thng 8_thng 9_thng 10_thng 11_thng 12".split("_"),monthsShort:"Thg 01_Thg 02_Thg 03_Thg 04_Thg 05_Thg 06_Thg 07_Thg 08_Thg 09_Thg 10_Thg 11_Thg 12".split("_"),monthsParseExact:!0,weekdays:"ch nht_th hai_th ba_th t_th nm_th su_th by".split("_"),weekdaysShort:"CN_T2_T3_T4_T5_T6_T7".split("_"),weekdaysMin:"CN_T2_T3_T4_T5_T6_T7".split("_"),weekdaysParseExact:!0,meridiemParse:/sa|ch/i,isPM:function(input){return/^ch$/i.test(input)},meridiem:function(hours,minutes,isLower){return hours<12?isLower?"sa":"SA":isLower?"ch":"CH"},longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"D MMMM [nm] YYYY",LLL:"D MMMM [nm] YYYY HH:mm",LLLL:"dddd, D MMMM [nm] YYYY HH:mm",l:"DD/M/YYYY",ll:"D MMM YYYY",lll:"D MMM YYYY HH:mm",llll:"ddd, D MMM YYYY HH:mm"},calendar:{sameDay:"[Hm nay lc] LT",nextDay:"[Ngy mai lc] LT",nextWeek:"dddd [tun ti lc] LT",lastDay:"[Hm qua lc] LT",lastWeek:"dddd [tun trc lc] LT",sameElse:"L"},relativeTime:{future:"%s ti",past:"%s trc",s:"vi giy",ss:"%d giy",m:"mt pht",mm:"%d pht",h:"mt gi",hh:"%d gi",d:"mt ngy",dd:"%d ngy",w:"mt tun",ww:"%d tun",M:"mt thng",MM:"%d thng",y:"mt nm",yy:"%d nm"},dayOfMonthOrdinalParse:/\d{1,2}/,ordinal:function(number){return number},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("x-pseudo",{months:"J~~r_F~br~r_~Mrc~h_p~rl_~M_~J~_Jl~_~gst~_Sp~tmb~r_~ctb~r_~vm~br_~Dc~mbr".split("_"),monthsShort:"J~_~Fb_~Mr_~pr_~M_~J_~Jl_~g_~Sp_~ct_~v_~Dc".split("_"),monthsParseExact:!0,weekdays:"S~d~_M~d~_T~sd~_Wd~sd~_T~hrs~d_~Frd~_S~tr~d".split("_"),weekdaysShort:"S~_~M_~T_~Wd_~Th_~Fr_~St".split("_"),weekdaysMin:"S~_M~_T_~W_T~h_Fr~_S".split("_"),weekdaysParseExact:!0,longDateFormat:{LT:"HH:mm",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY HH:mm",LLLL:"dddd, D MMMM YYYY HH:mm"},calendar:{sameDay:"[T~d~ t] LT",nextDay:"[T~m~rr~w t] LT",nextWeek:"dddd [t] LT",lastDay:"[~st~rd~ t] LT",lastWeek:"[L~st] dddd [t] LT",sameElse:"L"},relativeTime:{future:"~ %s",past:"%s ~g",s:" ~fw ~sc~ds",ss:"%d s~c~ds",m:" ~m~t",mm:"%d m~~ts",h:"~ h~r",hh:"%d h~rs",d:" ~d",dd:"%d d~s",M:" ~m~th",MM:"%d m~t~hs",y:" ~r",yy:"%d ~rs"},dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(number){var b=number%10;return number+(1==~~(number%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("yo",{months:"Sr_Erele_rna_Igbe_Ebibi_Okudu_Agmo_Ogun_Owewe_wara_Belu_p".split("_"),monthsShort:"Sr_Erl_rn_Igb_Ebi_Oku_Ag_Ogu_Owe_wa_Bel_p".split("_"),weekdays:"Aiku_Aje_Isgun_jru_jb_ti_Abamta".split("_"),weekdaysShort:"Aik_Aje_Is_jr_jb_ti_Aba".split("_"),weekdaysMin:"Ai_Aj_Is_r_b_t_Ab".split("_"),longDateFormat:{LT:"h:mm A",LTS:"h:mm:ss A",L:"DD/MM/YYYY",LL:"D MMMM YYYY",LLL:"D MMMM YYYY h:mm A",LLLL:"dddd, D MMMM YYYY h:mm A"},calendar:{sameDay:"[Oni ni] LT",nextDay:"[la ni] LT",nextWeek:"dddd [s ton'b] [ni] LT",lastDay:"[Ana ni] LT",lastWeek:"dddd [s tol] [ni] LT",sameElse:"L"},relativeTime:{future:"ni %s",past:"%s kja",s:"isju aaya die",ss:"aaya %d",m:"isju kan",mm:"isju %d",h:"wakati kan",hh:"wakati %d",d:"j kan",dd:"j %d",M:"osu kan",MM:"osu %d",y:"dun kan",yy:"dun %d"},dayOfMonthOrdinalParse:/j\s\d{1,2}/,ordinal:"j %d",week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("zh-cn",{months:"___________".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYYMD",LLL:"YYYYMDAhmm",LLLL:"YYYYMDddddAhmm",l:"YYYY/M/D",ll:"YYYYMD",lll:"YYYYMD HH:mm",llll:"YYYYMDdddd HH:mm"},meridiemParse:/|||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem||""===meridiem||""===meridiem?hour:""===meridiem||""===meridiem?hour+12:hour>=11?hour:hour+12},meridiem:function(hour,minute,isLower){var hm=100*hour+minute;return hm<600?"":hm<900?"":hm<1130?"":hm<1230?"":hm<1800?"":""},calendar:{sameDay:"[]LT",nextDay:"[]LT",nextWeek:function(now){return now.week()!==this.week()?"[]dddLT":"[]dddLT"},lastDay:"[]LT",lastWeek:function(now){return this.week()!==now.week()?"[]dddLT":"[]dddLT"},sameElse:"L"},dayOfMonthOrdinalParse:/\d{1,2}(||)/,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"";case"M":return number+"";case"w":case"W":return number+"";default:return number}},relativeTime:{future:"%s",past:"%s",s:"",ss:"%d ",m:"1 ",mm:"%d ",h:"1 ",hh:"%d ",d:"1 ",dd:"%d ",w:"1 ",ww:"%d ",M:"1 ",MM:"%d ",y:"1 ",yy:"%d "},week:{dow:1,doy:4}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("zh-hk",{months:"___________".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYYMD",LLL:"YYYYMD HH:mm",LLLL:"YYYYMDdddd HH:mm",l:"YYYY/M/D",ll:"YYYYMD",lll:"YYYYMD HH:mm",llll:"YYYYMDdddd HH:mm"},meridiemParse:/|||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem||""===meridiem||""===meridiem?hour:""===meridiem?hour>=11?hour:hour+12:""===meridiem||""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){var hm=100*hour+minute;return hm<600?"":hm<900?"":hm<1200?"":1200===hm?"":hm<1800?"":""},calendar:{sameDay:"[]LT",nextDay:"[]LT",nextWeek:"[]ddddLT",lastDay:"[]LT",lastWeek:"[]ddddLT",sameElse:"L"},dayOfMonthOrdinalParse:/\d{1,2}(||)/,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"";case"M":return number+"";case"w":case"W":return number+"";default:return number}},relativeTime:{future:"%s",past:"%s",s:"",ss:"%d ",m:"1 ",mm:"%d ",h:"1 ",hh:"%d ",d:"1 ",dd:"%d ",M:"1 ",MM:"%d ",y:"1 ",yy:"%d "}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("zh-mo",{months:"___________".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"DD/MM/YYYY",LL:"YYYYMD",LLL:"YYYYMD HH:mm",LLLL:"YYYYMDdddd HH:mm",l:"D/M/YYYY",ll:"YYYYMD",lll:"YYYYMD HH:mm",llll:"YYYYMDdddd HH:mm"},meridiemParse:/|||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem||""===meridiem||""===meridiem?hour:""===meridiem?hour>=11?hour:hour+12:""===meridiem||""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){var hm=100*hour+minute;return hm<600?"":hm<900?"":hm<1130?"":hm<1230?"":hm<1800?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[]dddd LT",lastDay:"[] LT",lastWeek:"[]dddd LT",sameElse:"L"},dayOfMonthOrdinalParse:/\d{1,2}(||)/,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"";case"M":return number+"";case"w":case"W":return number+"";default:return number}},relativeTime:{future:"%s",past:"%s",s:"",ss:"%d ",m:"1 ",mm:"%d ",h:"1 ",hh:"%d ",d:"1 ",dd:"%d ",M:"1 ",MM:"%d ",y:"1 ",yy:"%d "}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){!function(moment){"use strict";
//! moment.js locale configuration
moment.defineLocale("zh-tw",{months:"___________".split("_"),monthsShort:"1_2_3_4_5_6_7_8_9_10_11_12".split("_"),weekdays:"______".split("_"),weekdaysShort:"______".split("_"),weekdaysMin:"______".split("_"),longDateFormat:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYYMD",LLL:"YYYYMD HH:mm",LLLL:"YYYYMDdddd HH:mm",l:"YYYY/M/D",ll:"YYYYMD",lll:"YYYYMD HH:mm",llll:"YYYYMDdddd HH:mm"},meridiemParse:/|||||/,meridiemHour:function(hour,meridiem){return 12===hour&&(hour=0),""===meridiem||""===meridiem||""===meridiem?hour:""===meridiem?hour>=11?hour:hour+12:""===meridiem||""===meridiem?hour+12:void 0},meridiem:function(hour,minute,isLower){var hm=100*hour+minute;return hm<600?"":hm<900?"":hm<1130?"":hm<1230?"":hm<1800?"":""},calendar:{sameDay:"[] LT",nextDay:"[] LT",nextWeek:"[]dddd LT",lastDay:"[] LT",lastWeek:"[]dddd LT",sameElse:"L"},dayOfMonthOrdinalParse:/\d{1,2}(||)/,ordinal:function(number,period){switch(period){case"d":case"D":case"DDD":return number+"";case"M":return number+"";case"w":case"W":return number+"";default:return number}},relativeTime:{future:"%s",past:"%s",s:"",ss:"%d ",m:"1 ",mm:"%d ",h:"1 ",hh:"%d ",d:"1 ",dd:"%d ",M:"1 ",MM:"%d ",y:"1 ",yy:"%d "}})}(__webpack_require__(3))},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,H=[],K=[];!function(){function isPrime(n){for(var sqrtN=Math.sqrt(n),factor=2;factor<=sqrtN;factor++)if(!(n%factor))return!1;return!0}function getFractionalBits(n){return 4294967296*(n-(0|n))|0}for(var n=2,nPrime=0;nPrime<64;)isPrime(n)&&(nPrime<8&&(H[nPrime]=getFractionalBits(Math.pow(n,.5))),K[nPrime]=getFractionalBits(Math.pow(n,1/3)),nPrime++),n++}();var W=[],SHA256=C_algo.SHA256=Hasher.extend({_doReset:function(){this._hash=new WordArray.init(H.slice(0))},_doProcessBlock:function(M,offset){for(var H=this._hash.words,a=H[0],b=H[1],c=H[2],d=H[3],e=H[4],f=H[5],g=H[6],h=H[7],i=0;i<64;i++){if(i<16)W[i]=0|M[offset+i];else{var gamma0x=W[i-15],gamma0=(gamma0x<<25|gamma0x>>>7)^(gamma0x<<14|gamma0x>>>18)^gamma0x>>>3,gamma1x=W[i-2],gamma1=(gamma1x<<15|gamma1x>>>17)^(gamma1x<<13|gamma1x>>>19)^gamma1x>>>10;W[i]=gamma0+W[i-7]+gamma1+W[i-16]}var maj=a&b^a&c^b&c,sigma0=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),t1=h+((e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25))+(e&f^~e&g)+K[i]+W[i];h=g,g=f,f=e,e=d+t1|0,d=c,c=b,b=a,a=t1+(sigma0+maj)|0}H[0]=H[0]+a|0,H[1]=H[1]+b|0,H[2]=H[2]+c|0,H[3]=H[3]+d|0,H[4]=H[4]+e|0,H[5]=H[5]+f|0,H[6]=H[6]+g|0,H[7]=H[7]+h|0},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=Math.floor(nBitsTotal/4294967296),dataWords[15+(nBitsLeft+64>>>9<<4)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});C.SHA256=Hasher._createHelper(SHA256),C.HmacSHA256=Hasher._createHmacHelper(SHA256)}(Math),CryptoJS.SHA256)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(60),function(){var C=CryptoJS,Hasher=C.lib.Hasher,C_x64=C.x64,X64Word=C_x64.Word,X64WordArray=C_x64.WordArray,C_algo=C.algo;function X64Word_create(){return X64Word.create.apply(X64Word,arguments)}var K=[X64Word_create(1116352408,3609767458),X64Word_create(1899447441,602891725),X64Word_create(3049323471,3964484399),X64Word_create(3921009573,2173295548),X64Word_create(961987163,4081628472),X64Word_create(1508970993,3053834265),X64Word_create(2453635748,2937671579),X64Word_create(2870763221,3664609560),X64Word_create(3624381080,2734883394),X64Word_create(310598401,1164996542),X64Word_create(607225278,1323610764),X64Word_create(1426881987,3590304994),X64Word_create(1925078388,4068182383),X64Word_create(2162078206,991336113),X64Word_create(2614888103,633803317),X64Word_create(3248222580,3479774868),X64Word_create(3835390401,2666613458),X64Word_create(4022224774,944711139),X64Word_create(264347078,2341262773),X64Word_create(604807628,2007800933),X64Word_create(770255983,1495990901),X64Word_create(1249150122,1856431235),X64Word_create(1555081692,3175218132),X64Word_create(1996064986,2198950837),X64Word_create(2554220882,3999719339),X64Word_create(2821834349,766784016),X64Word_create(2952996808,2566594879),X64Word_create(3210313671,3203337956),X64Word_create(3336571891,1034457026),X64Word_create(3584528711,2466948901),X64Word_create(113926993,3758326383),X64Word_create(338241895,168717936),X64Word_create(666307205,1188179964),X64Word_create(773529912,1546045734),X64Word_create(1294757372,1522805485),X64Word_create(1396182291,2643833823),X64Word_create(1695183700,2343527390),X64Word_create(1986661051,1014477480),X64Word_create(2177026350,1206759142),X64Word_create(2456956037,344077627),X64Word_create(2730485921,1290863460),X64Word_create(2820302411,3158454273),X64Word_create(3259730800,3505952657),X64Word_create(3345764771,106217008),X64Word_create(3516065817,3606008344),X64Word_create(3600352804,1432725776),X64Word_create(4094571909,1467031594),X64Word_create(275423344,851169720),X64Word_create(430227734,3100823752),X64Word_create(506948616,1363258195),X64Word_create(659060556,3750685593),X64Word_create(883997877,3785050280),X64Word_create(958139571,3318307427),X64Word_create(1322822218,3812723403),X64Word_create(1537002063,2003034995),X64Word_create(1747873779,3602036899),X64Word_create(1955562222,1575990012),X64Word_create(2024104815,1125592928),X64Word_create(2227730452,2716904306),X64Word_create(2361852424,442776044),X64Word_create(2428436474,593698344),X64Word_create(2756734187,3733110249),X64Word_create(3204031479,2999351573),X64Word_create(3329325298,3815920427),X64Word_create(3391569614,3928383900),X64Word_create(3515267271,566280711),X64Word_create(3940187606,3454069534),X64Word_create(4118630271,4000239992),X64Word_create(116418474,1914138554),X64Word_create(174292421,2731055270),X64Word_create(289380356,3203993006),X64Word_create(460393269,320620315),X64Word_create(685471733,587496836),X64Word_create(852142971,1086792851),X64Word_create(1017036298,365543100),X64Word_create(1126000580,2618297676),X64Word_create(1288033470,3409855158),X64Word_create(1501505948,4234509866),X64Word_create(1607167915,987167468),X64Word_create(1816402316,1246189591)],W=[];!function(){for(var i=0;i<80;i++)W[i]=X64Word_create()}();var SHA512=C_algo.SHA512=Hasher.extend({_doReset:function(){this._hash=new X64WordArray.init([new X64Word.init(1779033703,4089235720),new X64Word.init(3144134277,2227873595),new X64Word.init(1013904242,4271175723),new X64Word.init(2773480762,1595750129),new X64Word.init(1359893119,2917565137),new X64Word.init(2600822924,725511199),new X64Word.init(528734635,4215389547),new X64Word.init(1541459225,327033209)])},_doProcessBlock:function(M,offset){for(var H=this._hash.words,H0=H[0],H1=H[1],H2=H[2],H3=H[3],H4=H[4],H5=H[5],H6=H[6],H7=H[7],H0h=H0.high,H0l=H0.low,H1h=H1.high,H1l=H1.low,H2h=H2.high,H2l=H2.low,H3h=H3.high,H3l=H3.low,H4h=H4.high,H4l=H4.low,H5h=H5.high,H5l=H5.low,H6h=H6.high,H6l=H6.low,H7h=H7.high,H7l=H7.low,ah=H0h,al=H0l,bh=H1h,bl=H1l,ch=H2h,cl=H2l,dh=H3h,dl=H3l,eh=H4h,el=H4l,fh=H5h,fl=H5l,gh=H6h,gl=H6l,hh=H7h,hl=H7l,i=0;i<80;i++){var Wi=W[i];if(i<16)var Wih=Wi.high=0|M[offset+2*i],Wil=Wi.low=0|M[offset+2*i+1];else{var gamma0x=W[i-15],gamma0xh=gamma0x.high,gamma0xl=gamma0x.low,gamma0h=(gamma0xh>>>1|gamma0xl<<31)^(gamma0xh>>>8|gamma0xl<<24)^gamma0xh>>>7,gamma0l=(gamma0xl>>>1|gamma0xh<<31)^(gamma0xl>>>8|gamma0xh<<24)^(gamma0xl>>>7|gamma0xh<<25),gamma1x=W[i-2],gamma1xh=gamma1x.high,gamma1xl=gamma1x.low,gamma1h=(gamma1xh>>>19|gamma1xl<<13)^(gamma1xh<<3|gamma1xl>>>29)^gamma1xh>>>6,gamma1l=(gamma1xl>>>19|gamma1xh<<13)^(gamma1xl<<3|gamma1xh>>>29)^(gamma1xl>>>6|gamma1xh<<26),Wi7=W[i-7],Wi7h=Wi7.high,Wi7l=Wi7.low,Wi16=W[i-16],Wi16h=Wi16.high,Wi16l=Wi16.low;Wih=(Wih=(Wih=gamma0h+Wi7h+((Wil=gamma0l+Wi7l)>>>0<gamma0l>>>0?1:0))+gamma1h+((Wil+=gamma1l)>>>0<gamma1l>>>0?1:0))+Wi16h+((Wil+=Wi16l)>>>0<Wi16l>>>0?1:0),Wi.high=Wih,Wi.low=Wil}var t1l,chh=eh&fh^~eh&gh,chl=el&fl^~el&gl,majh=ah&bh^ah&ch^bh&ch,majl=al&bl^al&cl^bl&cl,sigma0h=(ah>>>28|al<<4)^(ah<<30|al>>>2)^(ah<<25|al>>>7),sigma0l=(al>>>28|ah<<4)^(al<<30|ah>>>2)^(al<<25|ah>>>7),sigma1h=(eh>>>14|el<<18)^(eh>>>18|el<<14)^(eh<<23|el>>>9),sigma1l=(el>>>14|eh<<18)^(el>>>18|eh<<14)^(el<<23|eh>>>9),Ki=K[i],Kih=Ki.high,Kil=Ki.low,t1h=hh+sigma1h+((t1l=hl+sigma1l)>>>0<hl>>>0?1:0),t2l=sigma0l+majl;hh=gh,hl=gl,gh=fh,gl=fl,fh=eh,fl=el,eh=dh+(t1h=(t1h=(t1h=t1h+chh+((t1l+=chl)>>>0<chl>>>0?1:0))+Kih+((t1l+=Kil)>>>0<Kil>>>0?1:0))+Wih+((t1l+=Wil)>>>0<Wil>>>0?1:0))+((el=dl+t1l|0)>>>0<dl>>>0?1:0)|0,dh=ch,dl=cl,ch=bh,cl=bl,bh=ah,bl=al,ah=t1h+(sigma0h+majh+(t2l>>>0<sigma0l>>>0?1:0))+((al=t1l+t2l|0)>>>0<t1l>>>0?1:0)|0}H0l=H0.low=H0l+al,H0.high=H0h+ah+(H0l>>>0<al>>>0?1:0),H1l=H1.low=H1l+bl,H1.high=H1h+bh+(H1l>>>0<bl>>>0?1:0),H2l=H2.low=H2l+cl,H2.high=H2h+ch+(H2l>>>0<cl>>>0?1:0),H3l=H3.low=H3l+dl,H3.high=H3h+dh+(H3l>>>0<dl>>>0?1:0),H4l=H4.low=H4l+el,H4.high=H4h+eh+(H4l>>>0<el>>>0?1:0),H5l=H5.low=H5l+fl,H5.high=H5h+fh+(H5l>>>0<fl>>>0?1:0),H6l=H6.low=H6l+gl,H6.high=H6h+gh+(H6l>>>0<gl>>>0?1:0),H7l=H7.low=H7l+hl,H7.high=H7h+hh+(H7l>>>0<hl>>>0?1:0)},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;return dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[30+(nBitsLeft+128>>>10<<5)]=Math.floor(nBitsTotal/4294967296),dataWords[31+(nBitsLeft+128>>>10<<5)]=nBitsTotal,data.sigBytes=4*dataWords.length,this._process(),this._hash.toX32()},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone},blockSize:32});C.SHA512=Hasher._createHelper(SHA512),C.HmacSHA512=Hasher._createHmacHelper(SHA512)}(),CryptoJS.SHA512)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=(length=10)=>{const characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",charactersLength=characters.length;let result="";for(let i=0;i<length;i++)result+=characters.charAt(Math.floor(Math.random()*charactersLength));return result}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Channel=void 0;const rxjs_1=__webpack_require__(10);class Channel{constructor(name,id,visibility,topic,creatorId,companyId,creationDate,users_count,lastAvatarUpdateDate,subscribed,type,invited,category,mode,subscribers_count,muted){this.userRole="none",this.messageRetrieved=!1,this.messages=[],this.subscribed=!1,this.deleted=!1,this.invited=!1,this.type="SIMPLE",this.pageIndex=0,this.isLoading=!1,this.complete=!1,this.users=[],this.publishersRetreived=!1,this.loaded=!1,this.muted=!1,this.name=name,this.id=id,this.visibility=visibility,this.topic=topic,this.creatorId=creatorId,this.companyId=companyId,this.creationDate=creationDate,this.type=type,this.users_count=users_count,this.subscribers_count=subscribers_count,this.category=category,this.mode=mode,this.lastAvatarUpdateDate=lastAvatarUpdateDate;const timestamp=this.lastAvatarUpdateDate?"&ts="+new Date(this.lastAvatarUpdateDate).getTime():"";if(this.avatar=config.restServerUrl+"/api/channel-avatar/"+id+"?size=256"+timestamp,void 0!==subscribed&&(this.subscribed=subscribed),void 0!==type&&(this.userRole=type,this.subscribed="none"!==type),void 0!==invited&&(this.invited=invited),!this.mode)switch(this.visibility){case"company":this.mode="company_public";break;case"public":this.mode="all_public";break;case"private":this.mode="company_private"}this.updateSubject=new rxjs_1.Subject,this.muted=muted}static create(data){let channel=new Channel(data.name,data.id,data.visibility,data.topic,data.creatorId,data.companyId,data.creationDate,data.users_count,data.lastAvatarUpdateDate,data.subscribed,data.type,data.invited,data.category,data.mode,data.subscribers_count,data.mute);return channel.category||(channel.category="globalnews"),channel}isNotMember(){return this.userRole="none"}isOwner(){return"owner"===this.userRole}isPublisher(){return this.subscribed&&("owner"===this.userRole||"publisher"===this.userRole)}isMember(){return"member"===this.userRole}getAvatarSrc(){return this.lastAvatarUpdateDate?this.avatar:"/resources/skins/rainbow/images/channels/default_channel_avatar.png"}}exports.Channel=Channel},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SearchTextConvResults=exports.SearchTextResult=exports.SearchTextMsgResult=void 0;class SearchTextMsgResult{constructor(){this.body=void 0,this.date=void 0,this.isRoom=!1,this.isSent=!1,this.messageId=void 0,this.otherJid=null,this.historyIndex=null}static SearchTextMsgResultFactory(){return()=>new SearchTextMsgResult}}exports.SearchTextMsgResult=SearchTextMsgResult;exports.SearchTextResult=class{constructor(convId){this.room=null,this.contact=null,this.totalCount=0,this.convRes=[],this.otherJid=convId}addMsgItem(msgItem){this.convRes.push(msgItem)}isRoom(){return this.conversation?null!=this.conversation.room:null!==this.room}};class SearchTextConvResults{constructor(){this._searchedText=null,this.normalizedSearchText=null,this.queryIds=[],this.results=[],this.totalCount=0,this.currentMessageId=null,this.isSearching=!1}get searchedText(){return this._searchedText}set searchedText(searchText){this._searchedText=searchText,this.normalizedSearchText=searchText?searchText.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,""):null}isEmpty(){return 0===this.queryIds.length||0===Object.keys(this.results).length}clearAll(){this.searchedText=null,this.queryIds=[],this.partResults=[],this.totalCount=0,this.currentMessageId=null,this.results.splice(0,this.results.length)}isCurrentQuery(queryId){return this.queryIds.indexOf(queryId)>-1}getResultByJid(convJid){return this.results.find(result=>result.otherJid===convJid)}}exports.SearchTextConvResults=SearchTextConvResults,angular.module("rainbow").factory("SearchTextConvResultsFactory",(function(){return()=>new SearchTextConvResults})),angular.module("rainbow").factory("SearchTextMsgResultFactory",SearchTextMsgResult.SearchTextMsgResultFactory)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ReplaceMsg=void 0;class ReplaceMsg{constructor(id,body){this.id=id,this.body=body}static create(id,body){const toShort=emojione?emojione.toShort:text=>text;return new ReplaceMsg(id,toShort(body))}}exports.ReplaceMsg=ReplaceMsg},function(module,exports){var getRandomValues="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(getRandomValues){var rnds8=new Uint8Array(16);module.exports=function(){return getRandomValues(rnds8),rnds8}}else{var rnds=new Array(16);module.exports=function(){for(var r,i=0;i<16;i++)0==(3&i)&&(r=4294967296*Math.random()),rnds[i]=r>>>((3&i)<<3)&255;return rnds}}},function(module,exports){for(var byteToHex=[],i=0;i<256;++i)byteToHex[i]=(i+256).toString(16).substr(1);module.exports=function(buf,offset){var i=offset||0,bth=byteToHex;return[bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],"-",bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]],bth[buf[i++]]].join("")}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConversationServiceEventHandler=void 0;const message_1=__webpack_require__(16),xmpp_service_1=__webpack_require__(4),fileStorage_service_1=__webpack_require__(25),contact_service_1=__webpack_require__(1),logger_service_1=__webpack_require__(15),room_service_1=__webpack_require__(33),moment=__webpack_require__(3);class ConversationServiceEventHandler{constructor($rootScope,Conversation,fileServerService,webrtcGatewayService,conversationService){this.$rootScope=$rootScope,this.Conversation=Conversation,this.fileServerService=fileServerService,this.webrtcGatewayService=webrtcGatewayService,this.conversationService=conversationService}static create($rootScope,Conversation,fileServerService,webrtcGatewayService,conversationService){return new ConversationServiceEventHandler($rootScope,Conversation,fileServerService,webrtcGatewayService,conversationService)}onChatMessageReceived(stanza){logger_service_1.default.info("[ConversationServiceEventHandler] >onChatMessageReceived");try{const stanzaElem=$(stanza);return stanzaElem.find("event").length>0||stanzaElem.find("propose").length>0||stanzaElem.find("received").length>0?(logger_service_1.default.info("[ConversationServiceEventHandler] onChatMessageReceived ignore the message"),!0):(stanzaElem.find("recording").length>0?(logger_service_1.default.info("[ConversationServiceEventHandler] onChatMessageReceived : recording msg case"),this.onRecordingMessageReceived(stanza)):(logger_service_1.default.info("[ConversationServiceEventHandler] onChatMessageReceived"),this.extractStanzaData(stanza).then(stanzaData=>{stanzaData&&(stanzaData.body||stanzaData.oob||stanzaData.conference||stanzaData.replace?this.handleChatMessage(stanzaData):stanzaData.outgoingMessage||contact_service_1.default.isUserContact(stanzaData.participant)||!stanzaData.status||this.handleStatusMessage(stanzaData.conversation,stanzaData.participant,stanza))})),!0)}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onChatMessageReceived ERROR "+error),!0}}onConferenceMessageReceived(stanza){logger_service_1.default.info("[ConversationServiceEventHandler] onConferenceMessageReceived");try{return 0===$(stanza).find("event").length?logger_service_1.default.info("[ConversationServiceEventHandler] onConferenceMessageReceived ignore the message"):this.extractStanzaData(stanza).then(stanzaData=>{stanzaData.conference&&this.handleChatMessage(stanzaData)}),!0}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onConferenceMessageReceived ERROR "+error),!0}}onRoomAdminMessageReceived(conversation,contact,type,msgId){logger_service_1.default.info("[ConversationServiceEventHandler] onRoomAdminMessageReceived");const message=conversation.addAdminBubbleMessage(contact,new Date,type,msgId);conversation.setStatusMessage(contact,this.Conversation.Status.ACTIVE),this.conversationService.sendAckReceivedMessage(conversation,message),conversation===this.conversationService.activeConversation&&this.$rootScope.appVisible||conversation.setMissedCounter(conversation.missedCounter+1),this.$rootScope.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",message,conversation,!1),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,this.Conversation.EventType.IM)}onFileMessageReceived(stanza){logger_service_1.default.info("[ConversationServiceEventHandler] onFileMessageReceived");try{return this.extractStanzaData(stanza).then(stanzaData=>{if(stanzaData.body){const conversation=stanzaData.conversation;conversation.addFileMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId,stanzaData.urgency),conversation.setStatusMessage(stanzaData.participant,this.Conversation.Status.ACTIVE),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,this.Conversation.EventType.FILE)}}),!0}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onFileMessageReceived ERROR "+error),!0}}onWebRTCMessageReceived(stanza){logger_service_1.default.info("[ConversationServiceEventHandler] onWebRTCMessageReceived");try{return $(stanza).find("call_log").length>0?this.extractWebrtcStanzaData(stanza).then(stanzaData=>{if(stanzaData&&stanzaData.body){const conversation=stanzaData.conversation,message=conversation.addWebRTCMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId);conversation.setStatusMessage(stanzaData.participant,this.Conversation.Status.ACTIVE),this.conversationService.sendAckReceivedMessage(conversation,message),"R"===message.side||stanzaData.state&&"answered"===stanzaData.state?this.conversationService.sendAckReadMessage(conversation,message):conversation===this.conversationService.activeConversation&&this.$rootScope.appVisible||conversation.setMissedCounter(conversation.missedCounter+1),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}}):this.extractStanzaData(stanza).then(stanzaData=>{if(stanzaData&&stanzaData.body){const conversation=stanzaData.conversation;conversation.addWebRTCMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId),conversation.setStatusMessage(stanzaData.participant,this.Conversation.Status.ACTIVE),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}}),!0}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onWebRTCMessageReceived error "+error),!0}}onManagementMessageReceived(stanza){try{const stanzaElem=$(stanza),conversationElem=stanzaElem.find("conversation");if(conversationElem){const action=conversationElem.attr("action");let conversationGetterPromise=null;if("create"===action){const jid=xmpp_service_1.default.getBareJidFromJid(conversationElem.find("peer").text()),convType=conversationElem.find("type").text(),dbId=conversationElem.attr("id");conversationGetterPromise=this.conversationService.getConversationAsyncById(jid,convType,dbId)}else conversationGetterPromise=Promise.resolve(this.conversationService.getConversationByDbId(conversationElem.attr("id")));conversationGetterPromise.then(conversation=>{if(logger_service_1.default.info("[ConversationServiceEventHandler] onManagementMessageReceived ("+action+" conversation)"),conversation)switch(action){case"create":{conversation.dbId=conversationElem.attr("id");const lastMessageDate=conversationElem.find("lastMessageDate").text();lastMessageDate&&lastMessageDate.length>0&&(conversation.lastModification=new Date(lastMessageDate)),conversation.missedCounter=parseInt(conversationElem.find("unreadMessageNumber").text(),10)||0,conversation.muted="true"===conversationElem.find("mute").text(),this.conversationService.favoriteService.updateFavoriteConversations(conversation),this.conversationService.orderConversations(),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")}break;case"delete":this.conversationService.removeConversation(conversation)}else if("create"===action){const convId=xmpp_service_1.default.getBareJidFromJid(conversationElem.find("peer").text()),convDbId=conversationElem.attr("id"),lastModification=new Date(conversationElem.find("lastMessageDate").text()),lastMessageText=conversationElem.find("lastMessageText").text(),lastMessageSender=conversationElem.find("lastMessageSender").text(),missedIMCounter=parseInt(conversationElem.find("unreadMessageNumber").text(),10)||0,muted="true"===conversationElem.find("mute").text(),type=conversationElem.find("type").text(),conversationGetter="room"===type?"getRoomConversation":"getOrCreateOneToOneConversation";this.conversationService[conversationGetter](convId).then(conv=>{logger_service_1.default.info("[ConversationServiceEventHandler] onManagementMessageReceived update conversation ("+conv.id+")"),conv.dbId=convDbId,conv.lastModification=lastModification?new Date(lastModification):void 0,conv.lastMessageText=lastMessageText,conv.lastMessageSender=lastMessageSender,conv.muted=muted,conv.preload=!0,conv.setMissedCounter(missedIMCounter),type===this.Conversation.Type.BOT&&(conv.type=this.Conversation.Type.ONE_TO_ONE),this.conversationService.favoriteService.updateFavoriteConversations(conv),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conv)})}})}if(stanzaElem.find("mute")||stanzaElem.find("unmute")){const muteElem=stanzaElem.find("mute");let mute=!1;muteElem.length&&(mute=!muteElem.text().length||"true"===muteElem.text());const conversationDbId=stanzaElem.find("mute").attr("conversation")||stanzaElem.find("unmute").attr("conversation"),conversation=this.conversationService.getConversationByDbId(conversationDbId);conversation&&(logger_service_1.default.info("[ConversationServiceEventHandler] onManagementMessageReceived : mute is changed to "+mute),conversation.muted=mute)}return!0}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onManagementMessageReceived error "+error),!0}}onReceiptMessageReceived(stanza){try{let stanzaElement=$(stanza);const messageSender=xmpp_service_1.default.getBareJidFromJid(stanzaElement.attr("from")),carbonStanza=stanzaElement.find("message");contact_service_1.default.isUserContactJid(messageSender)&&carbonStanza.length>0&&(stanzaElement=$(carbonStanza));const recvMessage=stanzaElement.find("received");if(recvMessage.length&&recvMessage.length>0){logger_service_1.default.info("[ConversationServiceEventHandler] onReceiptMessageReceived");const messageId=$(recvMessage).attr("id"),entity=$(recvMessage).attr("entity"),event=$(recvMessage).attr("event");if("server"===entity&&"received"===event){const messageInfo=this.conversationService.pendingMessages[messageId];if(messageInfo&&messageInfo.message){const message=messageInfo.message,conversation=messageInfo.conversation;logger_service_1.default.info("[conversationService] Receive server ack ("+conversation.id+", "+message.id+")"),message.setReceiptStatus(message_1.Message.ReceiptStatus.SENT),conversation.updateMessage(message),delete this.conversationService.pendingMessages[messageId],this.$rootScope.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",message,conversation,"server")}}else"client"===entity&&this.extractStanzaData(stanza).then(stanzaData=>{this.handleReceiptReceiveMessage(stanzaData.conversation,stanza)})}else if(stanzaElement.find("mark_as_read").length){logger_service_1.default.info("[ConversationServiceEventHandler] onReceiptMessageReceived -- mark_as_read");const conversationId=stanzaElement.find("mark_as_read").attr("with"),conversation=this.conversationService.getConversationById(conversationId);if(conversation)switch(stanzaElement.find("mark_as_read").attr("id")){case"all-received":conversation.setMissedCounter(0);break;case"all-sent":conversation.ackReadAllSentMessages();break;default:logger_service_1.default.error("[ConversationServiceEventHandler] onReceiptMessageReceived error - unknown read type")}}else stanzaElement.find("voicemessage").length&&logger_service_1.default.debug("[ConversationServiceEventHandler] onReceiptMessageReceived VoiceMessage detected");return!0}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onReceiptMessageReceived error "+error),!0}}extractStanzaData(stanza){return new Promise((resolve,reject)=>{let stanzaElem=$(stanza);const from=stanzaElem.attr("from"),messageSender=xmpp_service_1.default.getBareJidFromJid(from),stanzaData={};let results=null;const carbonStanza=stanzaElem.find("message");if(carbonStanza.length>0&&contact_service_1.default.isUserContactJid(messageSender)){const forwardedCarbonMsg=$(stanzaElem).find("sent forwarded message forwarded message");if(forwardedCarbonMsg&&forwardedCarbonMsg.length){const origMsgId=$(stanzaElem).find("sent forwarded message").attr("id");stanzaElem=$(forwardedCarbonMsg).find("forwarded message"),stanzaData.isForwarded=!0,results=this.handleCarbonMsg(carbonStanza,stanzaData,stanzaElem,origMsgId)}else results=this.handleCarbonMsg(carbonStanza,stanzaData,stanzaElem,null)}else{const forwardedMsg=$(stanzaElem).find("forwarded[xmlns='urn:xmpp:forward:0']");if(forwardedMsg&&forwardedMsg.length){const origMsgId=stanzaElem.attr("id");stanzaElem=$(forwardedMsg).find("forwarded message"),stanzaData.isForwarded=!0,results=this.handleStandardMsg(stanzaData,stanzaElem,from,origMsgId,resolve)}else results=this.handleStandardMsg(stanzaData,stanzaElem,from,null,resolve)}results&&this.handleCommonData(stanza,stanzaData,stanzaElem,results.conversationId,results.delay,results.resource,resolve,reject)})}handleCommonData(stanza,stanzaData,stanzaElem,conversationId,delay,resource,resolve,reject){const archived="push"===stanzaElem.find("retransmission").attr("source");if(stanzaData.date=new Date,stanzaData.offline=!1,"Offline Storage"===delay.text()&&(stanzaData.date=new Date(delay.attr("stamp")),stanzaData.offline=!0),archived){let conversation=this.conversationService.getConversationById(conversationId);if(conversation)reject();else{const cs=this.conversationService;(conversationId.startsWith("room_")?cs.getRoomConversation(conversationId):cs.getOrCreateOneToOneConversation(conversationId)).then((function(conv){conversation=conv,reject()}))}return}const existingConv=this.conversationService.getConversationById(conversationId);if(stanzaData.convReady=existingConv&&null!==existingConv.dbId,stanzaData.body||existingConv||stanzaData.oob||stanzaData.conference)if(0===conversationId.indexOf("room_")){const room=room_service_1.default.getRoomByJid(conversationId),subject=stanzaElem.find("subject"),emptySubject=subject.length&&""===subject.text();room&&"accepted"!==room.status||emptySubject?logger_service_1.default.info("[conversationServiceEvent] extractStanzaData -- ignore this stanza message"):this.conversationService.getRoomConversation(conversationId).then((function(roomConv){return stanzaData.conversation=roomConv,stanzaData.conference&&stanzaData.conference.ownerjid?contact_service_1.default.getOrCreateContact(stanzaData.conference.ownerjid):(resource&&-1!==resource.indexOf("/")&&(resource=resource.split("/")[0]),contact_service_1.default.getOrCreateContact(resource))})).then((function(contact){stanzaData.participant=contact,resolve(stanzaData)})).catch((function(error){logger_service_1.default.error("[conversationServiceEventHandler] impossible to fetch conversation "+error.message),reject()}))}else this.conversationService.getOrCreateOneToOneConversation(conversationId).then((function(conv){stanzaData.conversation=conv,stanzaData.participant||(stanzaData.participant=conv.contact),resolve(stanzaData)})).catch((function(error){logger_service_1.default.error("[conversationServiceEventHandler] impossible to fetch conversation "+error.message),reject()}));else if($(stanza).find("deleted")){const deleted=$(stanza).find("deleted")[0];if(deleted&&"all"===deleted.getAttribute("id")){const conv=this.conversationService.getConversationById(deleted.getAttribute("with"));conv&&(logger_service_1.default.info("[conversationServiceEventHandler] Remove all messages for conversation "+conv.id),conv.reset())}resolve()}else logger_service_1.default.debug("[conversationServiceEventHandler] ignored message stanza"),reject()}handleStandardMsg(stanzaData,stanzaElem,from,msgId,resolve){logger_service_1.default.debug("[conversationServiceEventHandler] > handleStandardMsg "+msgId),stanzaData.outgoingMessage=!1,stanzaData.body=stanzaElem.find("body").text(),stanzaData.messageId=msgId||stanzaElem.attr("id"),stanzaData.carbon=!1,stanzaData.answeredMsg=stanzaElem.find("answeredMsg"),stanzaData.alternativeContent=stanzaElem.find("content"),stanzaData.attention=stanzaElem.find("attention");let conversationId=xmpp_service_1.default.getBareJidFromJid(from);const resource=xmpp_service_1.default.getResourceFromJid(from),delay=stanzaElem.find("delay");stanzaData.urgency="std";const headersElem=stanzaElem.find("headers[xmlns='http://jabber.org/protocol/shim']");if(headersElem&&headersElem.length){const urgencyElem=$(headersElem).find("header[name='Urgency']");urgencyElem&&urgencyElem.length&&(stanzaData.urgency=urgencyElem.text()),"undefined"===stanzaData.urgency&&(stanzaData.urgency="std")}const oob=stanzaElem.find("x[xmlns='jabber:x:oob']");if(oob&&oob.length){const oobElem=$(oob),url=oobElem.find("url").text(),mime=oobElem.find("mime").text(),filename=oobElem.find("filename").text(),filesize=oobElem.find("size").text();stanzaData.oob={url:url,mime:mime,filename:filename,filesize:filesize}}const geoloc=stanzaElem.find("geoloc");if(geoloc&&geoloc.length){const geolocElem=$(geoloc),lon=geolocElem.find("lon").text(),lat=geolocElem.find("lat").text();stanzaData.geoloc={lon:lon,lat:lat}}const voiceMessage=stanzaElem.find("voicemessage");voiceMessage&&voiceMessage.length&&(stanzaData.voiceMessage=!0);const conference=stanzaElem.find("x[xmlns='jabber:x:audioconference']");if(conference&&conference.length){const conferenceElem=$(conference),message=conferenceElem.attr("message"),confendpointid=conferenceElem.attr("confendpointid"),jid=conference.attr("jid"),type=conference.attr("type");if(stanzaData.conference={type:type,message:message,confendpointid:confendpointid,roomjid:jid,ownerjid:conversationId},"reminder"!==type)return logger_service_1.default.debug("[conversationServiceEventHandler] ignored message stanza for conference"),resolve(stanzaData),null;conversationId=jid}const replace=stanzaElem.find("replace");replace&&replace.length&&(stanzaData.replace={id:replace.attr("id")}),stanzaData.additionalContent=null;const contents=stanzaElem.find("content[xmlns='urn:xmpp:content']");contents&&contents.each((function(){stanzaData.additionalContent||(stanzaData.additionalContent={});const contentType=$(this).attr("type"),content=$(this).text();"text/markdown"===contentType&&(stanzaData.markdown=!0,stanzaData.body=content),stanzaData.additionalContent[contentType]={type:contentType,message:content}}));const subject=stanzaElem.find("subject");subject&&""!==subject.text()&&(stanzaData.subject=subject.text()),stanzaData.status=null;const composing=stanzaElem.find("composing"),paused=stanzaElem.find("paused"),active=stanzaElem.find("active"),inactive=stanzaElem.find("inactive");return composing.length?stanzaData.status="composing":paused.length?stanzaData.status="paused":active.length?stanzaData.status="active":inactive.length&&(stanzaData.status="inactive"),{conversationId:conversationId,resource:resource,delay:delay}}handleCarbonMsg(carbonStanza,stanzaData,stanzaElem,origMsgId){const carbonStanzaElem=$(carbonStanza),from=xmpp_service_1.default.getBareJidFromJid(carbonStanzaElem.attr("from")),fromResource=xmpp_service_1.default.getResourceFromJid(carbonStanzaElem.attr("from")),to=xmpp_service_1.default.getBareJidFromJid(carbonStanzaElem.attr("to")),toResource=xmpp_service_1.default.getResourceFromJid(carbonStanzaElem.attr("to"));stanzaData.outgoingMessage=contact_service_1.default.isUserContactJid(from),stanzaData.body=carbonStanzaElem.find("body").text(),stanzaData.participant=stanzaData.outgoingMessage?contact_service_1.default.userContact:null,stanzaData.messageId=origMsgId||carbonStanzaElem.attr("id"),stanzaData.carbon=!0,stanzaData.answeredMsg=carbonStanzaElem.find("answeredMsg"),stanzaData.alternativeContent=carbonStanzaElem.find("content");const conversationId=stanzaData.outgoingMessage?to:from,resource=stanzaData.outgoingMessage?toResource:fromResource,delay=carbonStanzaElem.find("delay");stanzaData.urgency="std";const headersElem=carbonStanzaElem.find("headers[xmlns='http://jabber.org/protocol/shim']");if(headersElem&&headersElem.length){const urgencyElem=$(headersElem).find("header[name='Urgency']");urgencyElem&&urgencyElem.length&&(stanzaData.urgency=urgencyElem.text())}const oob=carbonStanzaElem.find("x[xmlns='jabber:x:oob']");if(oob&&oob.length){const oobElem=$(oob),url=oobElem.find("url").text(),mime=oobElem.find("mime").text(),filename=oobElem.find("filename").text(),filesize=oobElem.find("size").text();stanzaData.oob={url:url,mime:mime,filename:filename,filesize:filesize}}const conference=stanzaElem.find("x[xmlns='jabber:x:audioconference']");if(conference&&conference.length){const conferenceElem=$(conference),subject=conferenceElem.attr("subject"),confendpointid=conferenceElem.attr("confendpointid"),jid=conference.attr("jid"),type=conference.attr("type");stanzaData.conference={type:type,subject:subject,confendpointid:confendpointid,roomjid:jid,ownerjid:conversationId}}const replace=carbonStanza.find("replace");replace&&replace.length&&(stanzaData.replace={id:replace.attr("id")}),stanzaData.status=null;const composing=stanzaElem.find("composing"),paused=stanzaElem.find("paused"),active=stanzaElem.find("active"),inactive=stanzaElem.find("inactive");composing.length?stanzaData.status="composing":paused.length?stanzaData.status="paused":active.length?stanzaData.status="active":inactive.length&&(stanzaData.status="inactive");const geoloc=carbonStanzaElem.find("geoloc");if(geoloc&&geoloc.length){const geolocElem=$(geoloc),lon=geolocElem.find("lon").text(),lat=geolocElem.find("lat").text();stanzaData.geoloc={lon:lon,lat:lat}}const voiceMessage=carbonStanzaElem.find("voicemessage");return voiceMessage&&voiceMessage.length&&(stanzaData.voiceMessage=!0),{conversationId:conversationId,resource:resource,delay:delay}}extractWebrtcStanzaData(stanza){return new Promise((resolve,reject)=>{logger_service_1.default.debug("[conversationServiceEventHandler] extractWebrtcStanzaData");const stanzaData={};stanzaData.messageId=$(stanza).attr("id"),stanzaData.callerJid=$(stanza).find("caller").text(),stanzaData.calleeJid=$(stanza).find("callee").text(),stanzaData.state=$(stanza).find("state").text();let conversationId=null;if(contact_service_1.default.isUserContactJid(stanzaData.callerJid)?(conversationId=stanzaData.calleeJid,stanzaData.participant=contact_service_1.default.userContact):conversationId=stanzaData.callerJid,-1!==conversationId.indexOf("janusgateway"))return logger_service_1.default.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore Janus message"),void reject();if(this.webrtcGatewayService.isMediaPillarJid(stanzaData.callerJid))return logger_service_1.default.debug("[conversationServiceEventHandler] extractWebrtcStanzaData -- ignore MediaPillar message"),void resolve();let duration=0;$(stanza).find("duration")&&(duration=parseInt($(stanza).find("duration").text(),10)),stanzaData.duration=duration>0?"("+moment.duration(duration,"ms").format("h[H] mm[m] ss[s]")+")":0;const date=$(stanza).find("date").text();date&&(stanzaData.date=new Date(date)),stanzaData.body="","missed"===stanzaData.state?stanzaData.body="missedCall||"+stanzaData.date:"answered"===stanzaData.state&&(stanzaData.body="activeCallMsg||"+stanzaData.date+"||"+stanzaData.duration),this.conversationService.getOrCreateOneToOneConversation(conversationId).then(conversation=>{stanzaData.conversation=conversation,stanzaData.participant||(stanzaData.participant=conversation.contact),resolve(stanzaData)}).catch(error=>{logger_service_1.default.error("[conversationServiceEventHandler] impossible to fetch conversation "+error.message),reject()})})}handleChatMessage(stanzaData){logger_service_1.default.info("[ConversationServiceEventHandler] handleChatMessage");const body=stanzaData.body;let message=null,conversation=stanzaData.conversation;if(conversation&&conversation.room&&(conversation.room.lastActivityDate=new Date),stanzaData.oob){const url=stanzaData.oob.url,fileName=stanzaData.oob.filename,fileId=fileStorage_service_1.default.extractFileIdFromUrl(url),attention=stanzaData.attention&&stanzaData.attention.length;fileStorage_service_1.default.retrieveAndStoreOneFileDescriptor(fileId).then(fileDescriptor=>{message=conversation.addFileSharingMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId,fileId,fileName,stanzaData.geoloc,stanzaData.urgency,stanzaData.isForwarded,attention),this.acknowledgeHandledChatMessage(stanzaData,conversation,message),this.fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then(blob=>{const newFileDescriptor=fileStorage_service_1.default.getFileDescriptorById(fileDescriptor.id);newFileDescriptor.previewBlob=blob,newFileDescriptor.previewBlobSubject.next(newFileDescriptor.previewBlob),this.$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:newFileDescriptor.id})}),this.$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})}).catch((function(error){logger_service_1.default.info("[ConversationServiceEventHandler] handleChatMessage error "+error)}))}else if(stanzaData.conference){const conferenceDescriptor={type:stanzaData.conference.type,message:stanzaData.conference.subject,confendpointid:stanzaData.conference.confendpointid,roomjid:stanzaData.conference.roomjid};if(conversation=this.conversationService.getConversationById(conferenceDescriptor.roomjid),this.$rootScope.$broadcast("ROOM_UPDATE_CONFID"),!conversation)return;message=conversation.addConferenceMessage(stanzaData.participant,stanzaData.date,stanzaData.messageId,conferenceDescriptor)}else if(stanzaData.replace)message=conversation.getMessageById(stanzaData.replace.id),message&&stanzaData.participant.jid!==message.from.jid?(logger_service_1.default.warn("[ConversationServiceEventHandler] handleChatMessage : message Replaced by somebody else - Skip"),message=null):(message||(message=conversation.addChatMessage(stanzaData.participant,stanzaData.date,"",stanzaData.replace.id,null,stanzaData.markdown,stanzaData.subject,null,null,stanzaData.additionalContent)),message.addReplaceMsg(stanzaData.messageId,body),conversation.updateAfterReplaceEvent(message));else if(body.length>0){const answeredMsgId=stanzaData.answeredMsg?stanzaData.answeredMsg.text():null,answeredMsgDate=stanzaData.answeredMsg?stanzaData.answeredMsg.attr("stamp"):null,alternativeContent=stanzaData.alternativeContent.length>0?{type:stanzaData.alternativeContent.attr("type"),message:stanzaData.alternativeContent.text()}:null,attention=stanzaData.attention&&stanzaData.attention.length;if(message=conversation.addChatMessage(stanzaData.participant,stanzaData.date,stanzaData.body,stanzaData.messageId,null,stanzaData.markdown,stanzaData.subject,answeredMsgId,answeredMsgDate,stanzaData.additionalContent,alternativeContent,attention,stanzaData.urgency),answeredMsgId){const answeredMessage=conversation.getMessageById(answeredMsgId);answeredMessage?(answeredMessage.urgencyAck=!0,answeredMessage.urgencyHandler&&answeredMessage.urgencyHandler()):logger_service_1.default.error("[ConversationServiceEventHandler] Not possible to handle answeredMsg because replied msg not found")}}message&&(message.isForwarded=!!stanzaData.isForwarded&&stanzaData.isForwarded,this.acknowledgeHandledChatMessage(stanzaData,conversation,message))}acknowledgeHandledChatMessage(stanzaData,conversation,message){if(logger_service_1.default.info("[ConversationServiceEventHandler] acknowledgeHandledChatMessage"),!message)return message=conversation.getMessageById(stanzaData.messageId),void(conversation.room&&message&&message.side===message_1.Message.Side.RIGHT&&this.conversationService.sendAckReceivedMessage(conversation,message));message.side===message_1.Message.Side.LEFT?(conversation===this.conversationService.activeConversation&&"away"!==contact_service_1.default.userContact.status&&this.$rootScope.appVisible&&!conversation.isFullScreenNoChat?this.conversationService.sendAckReadMessage(conversation,message):(this.conversationService.sendAckReceivedMessage(conversation,message),!stanzaData.offline&&stanzaData.convReady&&conversation.setMissedCounter(conversation.missedCounter+1)),message.isTextModified()&&(message.receiptStatus===message_1.Message.ReceiptStatus.READ&&this.conversationService.sendAckReadOrReceivedMessage(conversation,stanzaData.messageId,"read"),conversation.updateMessage(message))):(stanzaData.carbon?message.setReceiptStatus(message_1.Message.ReceiptStatus.SENT):message.setReceiptStatus(message_1.Message.ReceiptStatus.IN_PROGRESS),conversation.updateMessage(message)),conversation.setStatusMessage(stanzaData.participant,this.Conversation.Status.ACTIVE),this.$rootScope.$broadcast("ON_CONVERSATION_MESSAGE_RECEIVED",message,conversation,stanzaData.carbon),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}handleReceiptReceiveMessage(conversation,stanza){logger_service_1.default.info("[ConversationServiceEventHandler] handleReceiptReceiveMessage");const recvMessage=$(stanza).find("received[xmlns='urn:xmpp:receipts']");if(recvMessage.length){const messageId=$(recvMessage).attr("id"),message=conversation.getMessageById(messageId);if(message){let contactJid=$(stanza).attr("from").split("/")[1];contactJid||(contactJid=$(stanza).attr("from"));const event=$(recvMessage).attr("event");(conversation.room&&contact_service_1.default.isUserContactJid(contactJid)||!conversation.room)&&("received"===event?message.setReceiptStatus(message_1.Message.ReceiptStatus.UNREAD):"read"===event&&(message.setReceiptStatus(message_1.Message.ReceiptStatus.READ),conversation.setMissedCounter(0))),contact_service_1.default.isUserContactJid(contactJid)&&"read"===event&&"L"===message.side&&conversation.setMissedCounter(0),conversation.updateMessage(message),this.$rootScope.$broadcast("ON_CONVERSATION_RECEIPT_RECEIVED",message,conversation,event),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation)}else{const temp=$(stanza).attr("from"),event=$(recvMessage).attr("event");let contactJid="";temp&&(contactJid=temp.split("/")[1]),contactJid||(contactJid=temp),contact_service_1.default.isUserContactJid(contactJid)&&"read"===event&&(conversation.setMissedCounter(0),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation))}}}handleStatusMessage(conversation,participant,stanza){logger_service_1.default.info("[conversationServiceEventHandler] handleStatusMessage ");let status="";status="thread"===$(stanza).children().prop("tagName")?this.Conversation.stringToStatus($($(stanza).children()[1]).prop("tagName")):this.Conversation.stringToStatus($(stanza).children().prop("tagName")),conversation.setStatusMessage(participant,status),this.$rootScope.$broadcast("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",conversation,participant,status)}onRecordingMessageReceived(stanza){logger_service_1.default.info("[ConversationServiceEventHandler] onRecordingMessageReceived");try{const msgContent=stanza.textContent;return this.extractStanzaData(stanza).then(stanzaData=>{if("start"===msgContent){const conversation=stanzaData.conversation;conversation.addRecordingMessage(stanzaData.participant,stanzaData.date,msgContent,stanzaData.messageId),conversation.setStatusMessage(stanzaData.participant,this.Conversation.Status.ACTIVE),conversation.videoCall&&(conversation.videoCall.isRecorded=!0),this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation),this.$rootScope.$broadcast("ON_RECORDING_START_MSG_RECEIVED")}else if("stop"===msgContent){const conversation=stanzaData.conversation;conversation&&(conversation.addRecordingMessage(stanzaData.participant,stanzaData.date,msgContent,stanzaData.messageId),conversation.videoCall&&(conversation.videoCall.isRecorded=!1)),this.$rootScope.$broadcast("ON_RECORDING_STOP_MSG_RECEIVED")}else"remoteStopVideo"===msgContent?this.$rootScope.$broadcast("ON_RECORDING_REMOTESTOPVIDEO_MSG_RECEIVED"):"remoteChangeMediaVideo"===msgContent?this.$rootScope.$broadcast("ON_RECORDING_REMOTECHANGEMEDIAVIDEO_MSG_RECEIVED"):"remoteStopSharing"===msgContent?this.$rootScope.$broadcast("ON_RECORDING_REMOTESTOPSHARING_MSG_RECEIVED"):"remoteChangeMediaSharing"===msgContent&&this.$rootScope.$broadcast("ON_RECORDING_REMOTECHANGEMEDIASHARING_MSG_RECEIVED")}),!0}catch(error){return logger_service_1.default.error("[ConversationServiceEventHandler] onRecordingMessageReceived error "+error),!0}}}exports.ConversationServiceEventHandler=ConversationServiceEventHandler},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Room=void 0;const rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24);class Room{constructor(dbId,jid,name,desc,creationDate,conferenceEndpoints=[],history=Room.History.NONE,customdata={},conference=null,avatar=null,isActive=!1,lastActivityDate=null,autoRegister="unlock",autoAcceptInvitation=!1,tags=[],containerId="",containerName=""){this.nameForLogs="",this.users=[],this.ownerContact=null,this.organizers=[],this.members=[],this.avatarContacts=[],this.owner=!1,this.isModerator=!1,this.status="none",this.rxSubject=new rxjs_1.Subject,this.initPresPromise=null,this.initPresPromiseResolve=null,this.initPresInterval=null,this.initPresenceAck=!1,this.autoAcceptInvitation=!1,this.tags=[],this.foundByTag=!1,this.filterName=null,this.containerId="",this.containerName="",this.dbId=dbId,this.jid=jid,this.name=name,this.desc=desc,this.creationDate=creationDate,this.type=Room.Type.PRIVATE,this.history=history,this.customData=customdata,this.confEndpoints=conferenceEndpoints,this.conference=conference,this.avatar=avatar,this.isActive=isActive,this.lastActivityDate=lastActivityDate,this.autoRegister=autoRegister,this.autoAcceptInvitation=autoAcceptInvitation,this.tags=tags,this.containerId=containerId||"",this.containerName=containerName||""}static create(dbId,jid,name,topic,date,conferenceEndpoints,history,customdata,conference,avatar,isActive,lastActivityDate=null,autoRegister="unlock",autoAcceptInvitation=!1,tags=[],containerId="",containerName=""){const room=new Room(dbId,jid,name,topic,date,conferenceEndpoints,history,customdata,conference,avatar,isActive,lastActivityDate,autoRegister,autoAcceptInvitation,tags,containerId,containerName);return room.lastActivityDate=lastActivityDate,room}toString(){return"Room "+this.dbId+" "+this.name+" "+this.jid}getCreationDate(){return this.creationDate?new Date(this.creationDate):new Date}getLastActivityDate(){return this.lastActivityDate?new Date(this.lastActivityDate):this.getCreationDate()}subscribe(handler){return this.rxSubject.subscribe(handler)}updateAvatarInfo(){if(this.avatar)return;const avatarContacts=[],orderedContacts=this.users.slice();orderedContacts.sort((aa,bb)=>new Date(aa.date)>new Date(bb.date)?1:new Date(aa.date)<new Date(bb.date)?-1:0);for(let index=0;index<orderedContacts.length;index++){const contact=orderedContacts[index].contact,status=orderedContacts[index].status;if(!(this.ownerContact&&contact.dbId===this.ownerContact.dbId||contact.isAnonymousGuest()||contact.isBadGuest()||contact.isTerminated)&&(!this.owner&&!this.isModerator||"accepted"!==status&&"invited"!==status?"accepted"===status&&avatarContacts.push(contact):avatarContacts.push(contact),5===avatarContacts.length))break}this.avatarContacts=avatarContacts,this.rxSubject&&this.rxSubject.next(event_model_1.RBEvent.create("updateAvatarInfo",this.avatarContacts))}isUserOwner(contact){return!!contact&&(this.ownerContact&&this.ownerContact.jid===contact.jid)}isUserModerator(contact){return void 0!==this.getOrganizerFromContactJid(contact.jid)}isUserStatusAccepted(contact){const user=this.getUserByJid(contact.jid);return void 0!==user&&"accepted"===user.status}isUserStatusAcceptedOrInvited(contact){const user=this.getUserByJid(contact.jid);return void 0!==user&&("accepted"===user.status||"invited"===user.status)}isUserStillBelongToRoom(userJid){const ownUser=this.getUserByJid(userJid);return!ownUser||"unsubscribed"!==ownUser.status&&"deleted"!==ownUser.status}getOrganizerFromContactJid(contactJid){let user;return this.organizers.forEach(organizer=>{organizer.contact.jid===contactJid&&(user=organizer)}),user}getUserByJid(userJid){for(let i=0;i<this.users.length;i++)if(userJid===this.users[i].contact.jid)return this.users[i];return null}getPstnConfEndpointId(){if(this.confEndpoints&&this.confEndpoints.length)for(let i=0;i<this.confEndpoints.length;i++)if("pstnAudio"===this.confEndpoints[i].mediaType)return this.confEndpoints[i].confEndpointId;return null}getSFUConfEndpointId(){if(this.confEndpoints&&this.confEndpoints.length)for(let i=0;i<this.confEndpoints.length;i++)if("webrtc"===this.confEndpoints[i].mediaType)return this.confEndpoints[i].confEndpointId;return null}getSFUSharingConfEndpointId(){if(this.confEndpoints&&this.confEndpoints.length)for(let i=0;i<this.confEndpoints.length;i++)if("webrtcSharingOnly"===this.confEndpoints[i].mediaType)return this.confEndpoints[i].confEndpointId;return null}isMyPersonalMeetingRoom(){return this.conference&&"pstnAudio"===this.conference.mediaType&&!this.conference.scheduled&&this.conference.personalMeeting&&this.owner}isMeetingRoom(){return this.conference&&"pstnAudio"===this.conference.mediaType}isWebConferenceRoom(){return this.conference&&"pstnAudio"!==this.conference.mediaType&&null!==this.getSFUConfEndpointId()}isMeetingOrWebConferenceRoom(){return this.isMeetingRoom()||null!==this.getSFUConfEndpointId()}getNameForLogs(){if(!this.nameForLogs&&this.name){const temp=this.name.replace(/[^\s](?=.{1,}$)/g,"*");this.nameForLogs=this.name.charAt(0)+temp.substr(1)}return this.nameForLogs}getAutoRegister(){return this.autoRegister?this.autoRegister:"unlock"}setAutoRegister(value){this.autoRegister=value}getAutoAcceptInvitation(){return this.autoAcceptInvitation}setAutoAcceptInvitation(value){this.autoAcceptInvitation=value}getMuteUponEntry(){return this.conference?this.conference.muteUponEntry:"false"}setMuteUponEntry(value){this.conference&&(this.conference.muteUponEntry=value)}getDisableTimeStats(){return this.conference?this.conference.disableTimeStats:"false"}setDisableTimeStats(value){this.conference&&(this.conference.disableTimeStats=value)}getAllAcceptedMembers(){return this.members.filter(user=>!user.contact.isBadGuest()&&!user.contact.isAnonymousGuest()&&!user.contact.isTerminated&&"accepted"===user.status)}getAllAcceptedUsers(){return this.users.filter(user=>!user.contact.isBadGuest()&&!user.contact.isAnonymousGuest()&&!user.contact.isTerminated&&"accepted"===user.status)}getTagColor(tagName){const tagIndex=this.tags.findIndex(tag=>tag.tag===tagName);return tagIndex>-1?this.tags[tagIndex].color:"#ff9900"}}exports.Room=Room,Room.Type={PRIVATE:0,PUBLIC:1},Room.Privilege={USER:"user",MODERATOR:"moderator",GUEST:"guest"},Room.History={ALL:"all",NONE:"none"}},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__,root,factory;
/*! Moment Duration Format v2.2.2
 *  https://github.com/jsmreese/moment-duration-format
 *  Date: 2018-02-16
 *
 *  Duration format plugin function for the Moment.js library
 *  http://momentjs.com/
 *
 *  Copyright 2018 John Madhavan-Reese
 *  Released under the MIT license
 */root=this,factory=function(moment){var toLocaleStringWorks=!1,toLocaleStringRoundingWorks=!1,intlNumberFormatWorks=!1,intlNumberFormatRoundingWorks=!1,types="escape years months weeks days hours minutes seconds milliseconds general".split(" "),bubbles=[{type:"seconds",targets:[{type:"minutes",value:60},{type:"hours",value:3600},{type:"days",value:86400},{type:"weeks",value:604800},{type:"months",value:2678400},{type:"years",value:31536e3}]},{type:"minutes",targets:[{type:"hours",value:60},{type:"days",value:1440},{type:"weeks",value:10080},{type:"months",value:44640},{type:"years",value:525600}]},{type:"hours",targets:[{type:"days",value:24},{type:"weeks",value:168},{type:"months",value:744},{type:"years",value:8760}]},{type:"days",targets:[{type:"weeks",value:7},{type:"months",value:31},{type:"years",value:365}]},{type:"months",targets:[{type:"years",value:12}]}];function stringIncludes(str,search){return!(search.length>str.length)&&-1!==str.indexOf(search)}function repeatZero(qty){for(var result="";qty;)result+="0",qty-=1;return result}function cachedNumberFormat(locale,options){var cacheKey=locale+"+"+map(keys(options).sort(),(function(key){return key+":"+options[key]})).join(",");return cachedNumberFormat.cache[cacheKey]||(cachedNumberFormat.cache[cacheKey]=Intl.NumberFormat(locale,options)),cachedNumberFormat.cache[cacheKey]}function formatNumber(number,options,userLocale){var integerString,fractionString,exponentString,useToLocaleString=options.useToLocaleString,useGrouping=options.useGrouping,grouping=useGrouping&&options.grouping.slice(),maximumSignificantDigits=options.maximumSignificantDigits,minimumIntegerDigits=options.minimumIntegerDigits||1,fractionDigits=options.fractionDigits||0,groupingSeparator=options.groupingSeparator,decimalSeparator=options.decimalSeparator;if(useToLocaleString&&userLocale){var roundingOptions,localeStringOptions={minimumIntegerDigits:minimumIntegerDigits,useGrouping:useGrouping};return fractionDigits&&(localeStringOptions.maximumFractionDigits=fractionDigits,localeStringOptions.minimumFractionDigits=fractionDigits),maximumSignificantDigits&&number>0&&(localeStringOptions.maximumSignificantDigits=maximumSignificantDigits),intlNumberFormatWorks?(intlNumberFormatRoundingWorks||((roundingOptions=extend({},options)).useGrouping=!1,roundingOptions.decimalSeparator=".",number=parseFloat(formatNumber(number,roundingOptions),10)),cachedNumberFormat(userLocale,localeStringOptions).format(number)):(toLocaleStringRoundingWorks||((roundingOptions=extend({},options)).useGrouping=!1,roundingOptions.decimalSeparator=".",number=parseFloat(formatNumber(number,roundingOptions),10)),number.toLocaleString(userLocale,localeStringOptions))}var temp=(maximumSignificantDigits?number.toPrecision(maximumSignificantDigits+1):number.toFixed(fractionDigits+1)).split("e");exponentString=temp[1]||"",fractionString=(temp=temp[0].split("."))[1]||"";var integerLength=(integerString=temp[0]||"").length,fractionLength=fractionString.length,digitCount=integerLength+fractionLength,digits=integerString+fractionString;(maximumSignificantDigits&&digitCount===maximumSignificantDigits+1||!maximumSignificantDigits&&fractionLength===fractionDigits+1)&&((digits=function(digits){for(var digitsArray=digits.split("").reverse(),i=0,carry=!0;carry&&i<digitsArray.length;)i?"9"===digitsArray[i]?digitsArray[i]="0":(digitsArray[i]=(parseInt(digitsArray[i],10)+1).toString(),carry=!1):(parseInt(digitsArray[i],10)<5&&(carry=!1),digitsArray[i]="0"),i+=1;return carry&&digitsArray.push("1"),digitsArray.reverse().join("")}(digits)).length===digitCount+1&&(integerLength+=1),fractionLength&&(digits=digits.slice(0,-1)),integerString=digits.slice(0,integerLength),fractionString=digits.slice(integerLength)),maximumSignificantDigits&&(fractionString=fractionString.replace(/0*$/,""));var exponent=parseInt(exponentString,10);exponent>0?fractionString.length<=exponent?(integerString+=fractionString+=repeatZero(exponent-fractionString.length),fractionString=""):(integerString+=fractionString.slice(0,exponent),fractionString=fractionString.slice(exponent)):exponent<0&&(fractionString=repeatZero(Math.abs(exponent)-integerString.length)+integerString+fractionString,integerString="0"),maximumSignificantDigits||((fractionString=fractionString.slice(0,fractionDigits)).length<fractionDigits&&(fractionString+=repeatZero(fractionDigits-fractionString.length)),integerString.length<minimumIntegerDigits&&(integerString=repeatZero(minimumIntegerDigits-integerString.length)+integerString));var group,formattedString="";if(useGrouping)for(temp=integerString;temp.length;)grouping.length&&(group=grouping.shift()),formattedString&&(formattedString=groupingSeparator+formattedString),formattedString=temp.slice(-group)+formattedString,temp=temp.slice(0,-group);else formattedString=integerString;return fractionString&&(formattedString=formattedString+decimalSeparator+fractionString),formattedString}function durationLabelCompare(a,b){return a.label.length>b.label.length?-1:a.label.length<b.label.length?1:0}function durationGetLabels(token,localeData){var labels=[];return each(keys(localeData),(function(localeDataKey){if("_durationLabels"===localeDataKey.slice(0,15)){var labelType=localeDataKey.slice(15).toLowerCase();each(keys(localeData[localeDataKey]),(function(labelKey){labelKey.slice(0,1)===token&&labels.push({type:labelType,key:labelKey,label:localeData[localeDataKey][labelKey]})}))}})),labels}cachedNumberFormat.cache={};var engLocale={durationLabelsStandard:{S:"millisecond",SS:"milliseconds",s:"second",ss:"seconds",m:"minute",mm:"minutes",h:"hour",hh:"hours",d:"day",dd:"days",w:"week",ww:"weeks",M:"month",MM:"months",y:"year",yy:"years"},durationLabelsShort:{S:"msec",SS:"msecs",s:"sec",ss:"secs",m:"min",mm:"mins",h:"hr",hh:"hrs",d:"dy",dd:"dys",w:"wk",ww:"wks",M:"mo",MM:"mos",y:"yr",yy:"yrs"},durationTimeTemplates:{HMS:"h:mm:ss",HM:"h:mm",MS:"m:ss"},durationLabelTypes:[{type:"standard",string:"__"},{type:"short",string:"_"}],durationPluralKey:function(token,integerValue,decimalValue){return 1===integerValue&&null===decimalValue?token:token+token}};function isArray(array){return"[object Array]"===Object.prototype.toString.call(array)}function isObject(obj){return"[object Object]"===Object.prototype.toString.call(obj)}function find(array,callback){var match,index=0,max=array&&array.length||0;for("function"!=typeof callback&&(match=callback,callback=function(item){return item===match});index<max;){if(callback(array[index]))return array[index];index+=1}}function each(array,callback){var index=0,max=array.length;if(array&&max)for(;index<max;){if(!1===callback(array[index],index))return;index+=1}}function map(array,callback){var index=0,max=array.length,ret=[];if(!array||!max)return ret;for(;index<max;)ret[index]=callback(array[index],index),index+=1;return ret}function pluck(array,prop){return map(array,(function(item){return item[prop]}))}function compact(array){var ret=[];return each(array,(function(item){item&&ret.push(item)})),ret}function unique(array){var ret=[];return each(array,(function(_a){find(ret,_a)||ret.push(_a)})),ret}function intersection(a,b){var ret=[];return each(a,(function(_a){each(b,(function(_b){_a===_b&&ret.push(_a)}))})),unique(ret)}function rest(array,callback){var ret=[];return each(array,(function(item,index){if(!callback(item))return ret=array.slice(index),!1})),ret}function initial(array,callback){return rest(array.slice().reverse(),callback).reverse()}function extend(a,b){for(var key in b)b.hasOwnProperty(key)&&(a[key]=b[key]);return a}function keys(a){var ret=[];for(var key in a)a.hasOwnProperty(key)&&ret.push(key);return ret}function any(array,callback){var index=0,max=array.length;if(!array||!max)return!1;for(;index<max;){if(!0===callback(array[index],index))return!0;index+=1}return!1}function flatten(array){var ret=[];return each(array,(function(child){ret=ret.concat(child)})),ret}function featureTestFormatterRounding(formatter){return"3.6"===formatter(3.55,"en",{useGrouping:!1,minimumIntegerDigits:1,minimumFractionDigits:1,maximumFractionDigits:1})}function featureTestFormatter(formatter){var passed=!0;return!!((passed=(passed=(passed=passed&&"1"===formatter(1,"en",{minimumIntegerDigits:1}))&&"01"===formatter(1,"en",{minimumIntegerDigits:2}))&&"001"===formatter(1,"en",{minimumIntegerDigits:3}))&&(passed=(passed=(passed=(passed=passed&&"100"===formatter(99.99,"en",{maximumFractionDigits:0,minimumFractionDigits:0}))&&"100.0"===formatter(99.99,"en",{maximumFractionDigits:1,minimumFractionDigits:1}))&&"99.99"===formatter(99.99,"en",{maximumFractionDigits:2,minimumFractionDigits:2}))&&"99.990"===formatter(99.99,"en",{maximumFractionDigits:3,minimumFractionDigits:3}))&&(passed=(passed=(passed=(passed=(passed=passed&&"100"===formatter(99.99,"en",{maximumSignificantDigits:1}))&&"100"===formatter(99.99,"en",{maximumSignificantDigits:2}))&&"100"===formatter(99.99,"en",{maximumSignificantDigits:3}))&&"99.99"===formatter(99.99,"en",{maximumSignificantDigits:4}))&&"99.99"===formatter(99.99,"en",{maximumSignificantDigits:5}))&&(passed=(passed=passed&&"1,000"===formatter(1e3,"en",{useGrouping:!0}))&&"1000"===formatter(1e3,"en",{useGrouping:!1})))}function durationsFormat(){var durations,args=[].slice.call(arguments),settings={};if(each(args,(function(arg,index){if(!index){if(!isArray(arg))throw"Expected array as the first argument to durationsFormat.";durations=arg}"string"!=typeof arg&&"function"!=typeof arg?"number"!=typeof arg?isObject(arg)&&extend(settings,arg):settings.precision=arg:settings.template=arg})),!durations||!durations.length)return[];settings.returnMomentTypes=!0;var formattedDurations=map(durations,(function(dur){return dur.format(settings)})),outputTypes=intersection(types,unique(pluck(flatten(formattedDurations),"type"))),largest=settings.largest;return largest&&(outputTypes=outputTypes.slice(0,largest)),settings.returnMomentTypes=!1,settings.outputTypes=outputTypes,map(durations,(function(dur){return dur.format(settings)}))}function durationFormat(){var args=[].slice.call(arguments),settings=extend({},this.format.defaults),asMilliseconds=this.asMilliseconds(),asMonths=this.asMonths();"function"==typeof this.isValid&&!1===this.isValid()&&(asMilliseconds=0,asMonths=0);var isNegative=asMilliseconds<0,remainder=moment.duration(Math.abs(asMilliseconds),"milliseconds"),remainderMonths=moment.duration(Math.abs(asMonths),"months");each(args,(function(arg){"string"!=typeof arg&&"function"!=typeof arg?"number"!=typeof arg?isObject(arg)&&extend(settings,arg):settings.precision=arg:settings.template=arg}));var momentTokens={years:"y",months:"M",weeks:"w",days:"d",hours:"h",minutes:"m",seconds:"s",milliseconds:"S"},tokenDefs={escape:/\[(.+?)\]/,years:/\*?[Yy]+/,months:/\*?M+/,weeks:/\*?[Ww]+/,days:/\*?[Dd]+/,hours:/\*?[Hh]+/,minutes:/\*?m+/,seconds:/\*?s+/,milliseconds:/\*?S+/,general:/.+?/};settings.types=types;var typeMap=function(token){return find(types,(function(type){return tokenDefs[type].test(token)}))},tokenizer=new RegExp(map(types,(function(type){return tokenDefs[type].source})).join("|"),"g");settings.duration=this;var template="function"==typeof settings.template?settings.template.apply(settings):settings.template,outputTypes=settings.outputTypes,returnMomentTypes=settings.returnMomentTypes,largest=settings.largest,stopTrim=[];outputTypes||(isArray(settings.stopTrim)&&(settings.stopTrim=settings.stopTrim.join("")),settings.stopTrim&&each(settings.stopTrim.match(tokenizer),(function(token){var type=typeMap(token);"escape"!==type&&"general"!==type&&stopTrim.push(type)})));var localeData=moment.localeData();localeData||(localeData={}),each(keys(engLocale),(function(key){"function"!=typeof engLocale[key]?localeData["_"+key]||(localeData["_"+key]=engLocale[key]):localeData[key]||(localeData[key]=engLocale[key])})),each(keys(localeData._durationTimeTemplates),(function(item){template=template.replace("_"+item+"_",localeData._durationTimeTemplates[item])}));var userLocale=settings.userLocale||moment.locale(),useLeftUnits=settings.useLeftUnits,usePlural=settings.usePlural,precision=settings.precision,forceLength=settings.forceLength,useGrouping=settings.useGrouping,trunc=settings.trunc,useSignificantDigits=settings.useSignificantDigits&&precision>0,significantDigits=useSignificantDigits?settings.precision:0,significantDigitsCache=significantDigits,minValue=settings.minValue,isMinValue=!1,maxValue=settings.maxValue,isMaxValue=!1,useToLocaleString=settings.useToLocaleString,groupingSeparator=settings.groupingSeparator,decimalSeparator=settings.decimalSeparator,grouping=settings.grouping;useToLocaleString=useToLocaleString&&(toLocaleStringWorks||intlNumberFormatWorks);var trim=settings.trim;isArray(trim)&&(trim=trim.join(" ")),null===trim&&(largest||maxValue||useSignificantDigits)&&(trim="all"),null!==trim&&!0!==trim&&"left"!==trim&&"right"!==trim||(trim="large"),!1===trim&&(trim="");var trimIncludes=function(item){return item.test(trim)},rLarge=/large/,rSmall=/small/,rBoth=/both/,rMid=/mid/,rAll=/^all|[^sm]all/,rFinal=/final/,trimLarge=largest>0||any([rLarge,rBoth,rAll],trimIncludes),trimSmall=any([rSmall,rBoth,rAll],trimIncludes),trimMid=any([rMid,rAll],trimIncludes),trimFinal=any([rFinal,rAll],trimIncludes),rawTokens=map(template.match(tokenizer),(function(token,index){var type=typeMap(token);return"*"===token.slice(0,1)&&(token=token.slice(1),"escape"!==type&&"general"!==type&&stopTrim.push(type)),{index:index,length:token.length,text:"",token:"escape"===type?token.replace(tokenDefs.escape,"$1"):token,type:"escape"===type||"general"===type?null:type}})),currentToken={index:0,length:0,token:"",text:"",type:null},tokens=[];useLeftUnits&&rawTokens.reverse(),each(rawTokens,(function(token){if(token.type)return(currentToken.type||currentToken.text)&&tokens.push(currentToken),void(currentToken=token);useLeftUnits?currentToken.text=token.token+currentToken.text:currentToken.text+=token.token})),(currentToken.type||currentToken.text)&&tokens.push(currentToken),useLeftUnits&&tokens.reverse();var momentTypes=intersection(types,unique(compact(pluck(tokens,"type"))));if(!momentTypes.length)return pluck(tokens,"text").join("");momentTypes=map(momentTypes,(function(momentType,index){var rawValue,isSmallest=index+1===momentTypes.length,isLargest=!index;rawValue="years"===momentType||"months"===momentType?remainderMonths.as(momentType):remainder.as(momentType);var wholeValue=Math.floor(rawValue),decimalValue=rawValue-wholeValue,token=find(tokens,(function(token){return momentType===token.type}));return isLargest&&maxValue&&rawValue>maxValue&&(isMaxValue=!0),isSmallest&&minValue&&Math.abs(settings.duration.as(momentType))<minValue&&(isMinValue=!0),isLargest&&null===forceLength&&token.length>1&&(forceLength=!0),remainder.subtract(wholeValue,momentType),remainderMonths.subtract(wholeValue,momentType),{rawValue:rawValue,wholeValue:wholeValue,decimalValue:isSmallest?decimalValue:0,isSmallest:isSmallest,isLargest:isLargest,type:momentType,tokenLength:token.length}}));var truncMethod=trunc?Math.floor:Math.round,truncate=function(value,places){var factor=Math.pow(10,places);return truncMethod(value*factor)/factor},foundFirst=!1,bubbled=!1,formatValue=function(momentType,index){var formatOptions={useGrouping:useGrouping,groupingSeparator:groupingSeparator,decimalSeparator:decimalSeparator,grouping:grouping,useToLocaleString:useToLocaleString};return useSignificantDigits&&(significantDigits<=0?(momentType.rawValue=0,momentType.wholeValue=0,momentType.decimalValue=0):(formatOptions.maximumSignificantDigits=significantDigits,momentType.significantDigits=significantDigits)),isMaxValue&&!bubbled&&(momentType.isLargest?(momentType.wholeValue=maxValue,momentType.decimalValue=0):(momentType.wholeValue=0,momentType.decimalValue=0)),isMinValue&&!bubbled&&(momentType.isSmallest?(momentType.wholeValue=minValue,momentType.decimalValue=0):(momentType.wholeValue=0,momentType.decimalValue=0)),momentType.isSmallest||momentType.significantDigits&&momentType.significantDigits-momentType.wholeValue.toString().length<=0?precision<0?momentType.value=truncate(momentType.wholeValue,precision):0===precision?momentType.value=truncMethod(momentType.wholeValue+momentType.decimalValue):useSignificantDigits?(momentType.value=trunc?truncate(momentType.rawValue,significantDigits-momentType.wholeValue.toString().length):momentType.rawValue,momentType.wholeValue&&(significantDigits-=momentType.wholeValue.toString().length)):(formatOptions.fractionDigits=precision,momentType.value=trunc?momentType.wholeValue+truncate(momentType.decimalValue,precision):momentType.wholeValue+momentType.decimalValue):useSignificantDigits&&momentType.wholeValue?(momentType.value=Math.round(truncate(momentType.wholeValue,momentType.significantDigits-momentType.wholeValue.toString().length)),significantDigits-=momentType.wholeValue.toString().length):momentType.value=momentType.wholeValue,momentType.tokenLength>1&&(forceLength||foundFirst)&&(formatOptions.minimumIntegerDigits=momentType.tokenLength,bubbled&&formatOptions.maximumSignificantDigits<momentType.tokenLength&&delete formatOptions.maximumSignificantDigits),!foundFirst&&(momentType.value>0||""===trim||find(stopTrim,momentType.type)||find(outputTypes,momentType.type))&&(foundFirst=!0),momentType.formattedValue=formatNumber(momentType.value,formatOptions,userLocale),formatOptions.useGrouping=!1,formatOptions.decimalSeparator=".",momentType.formattedValueEn=formatNumber(momentType.value,formatOptions,"en"),2===momentType.tokenLength&&"milliseconds"===momentType.type&&(momentType.formattedValueMS=formatNumber(momentType.value,{minimumIntegerDigits:3,useGrouping:!1},"en").slice(0,2)),momentType};if((momentTypes=compact(momentTypes=map(momentTypes,formatValue))).length>1){var findType=function(type){return find(momentTypes,(function(momentType){return momentType.type===type}))},bubbleTypes=function(bubble){var bubbleMomentType=findType(bubble.type);bubbleMomentType&&each(bubble.targets,(function(target){var targetMomentType=findType(target.type);targetMomentType&&parseInt(bubbleMomentType.formattedValueEn,10)===target.value&&(bubbleMomentType.rawValue=0,bubbleMomentType.wholeValue=0,bubbleMomentType.decimalValue=0,targetMomentType.rawValue+=1,targetMomentType.wholeValue+=1,targetMomentType.decimalValue=0,targetMomentType.formattedValueEn=targetMomentType.wholeValue.toString(),bubbled=!0)}))};each(bubbles,bubbleTypes)}return bubbled&&(foundFirst=!1,significantDigits=significantDigitsCache,momentTypes=compact(momentTypes=map(momentTypes,formatValue))),!outputTypes||isMaxValue&&!settings.trim?(trimLarge&&(momentTypes=rest(momentTypes,(function(momentType){return!momentType.isSmallest&&!momentType.wholeValue&&!find(stopTrim,momentType.type)}))),largest&&momentTypes.length&&(momentTypes=momentTypes.slice(0,largest)),trimSmall&&momentTypes.length>1&&(momentTypes=initial(momentTypes,(function(momentType){return!momentType.wholeValue&&!find(stopTrim,momentType.type)&&!momentType.isLargest}))),trimMid&&(momentTypes=compact(momentTypes=map(momentTypes,(function(momentType,index){return index>0&&index<momentTypes.length-1&&!momentType.wholeValue?null:momentType})))),!trimFinal||1!==momentTypes.length||momentTypes[0].wholeValue||!trunc&&momentTypes[0].isSmallest&&momentTypes[0].rawValue<minValue||(momentTypes=[])):momentTypes=compact(momentTypes=map(momentTypes,(function(momentType){return find(outputTypes,(function(outputType){return momentType.type===outputType}))?momentType:null}))),returnMomentTypes?momentTypes:(each(tokens,(function(token){var key=momentTokens[token.type],momentType=find(momentTypes,(function(momentType){return momentType.type===token.type}));if(key&&momentType){var values=momentType.formattedValueEn.split(".");values[0]=parseInt(values[0],10),values[1]?values[1]=parseFloat("0."+values[1],10):values[1]=null;var pluralKey=localeData.durationPluralKey(key,values[0],values[1]),labels=durationGetLabels(key,localeData),autoLocalized=!1,pluralizedLabels={};each(localeData._durationLabelTypes,(function(labelType){var label=find(labels,(function(label){return label.type===labelType.type&&label.key===pluralKey}));label&&(pluralizedLabels[label.type]=label.label,stringIncludes(token.text,labelType.string)&&(token.text=token.text.replace(labelType.string,label.label),autoLocalized=!0))})),usePlural&&!autoLocalized&&(labels.sort(durationLabelCompare),each(labels,(function(label){return pluralizedLabels[label.type]===label.label?!stringIncludes(token.text,label.label)&&void 0:stringIncludes(token.text,label.label)?(token.text=token.text.replace(label.label,pluralizedLabels[label.type]),!1):void 0})))}})),(tokens=map(tokens,(function(token){if(!token.type)return token.text;var momentType=find(momentTypes,(function(momentType){return momentType.type===token.type}));if(!momentType)return"";var out="";return useLeftUnits&&(out+=token.text),(isNegative&&isMaxValue||!isNegative&&isMinValue)&&(out+="< ",isMaxValue=!1,isMinValue=!1),(isNegative&&isMinValue||!isNegative&&isMaxValue)&&(out+="> ",isMaxValue=!1,isMinValue=!1),isNegative&&(momentType.value>0||""===trim||find(stopTrim,momentType.type)||find(outputTypes,momentType.type))&&(out+="-",isNegative=!1),"milliseconds"===token.type&&momentType.formattedValueMS?out+=momentType.formattedValueMS:out+=momentType.formattedValue,useLeftUnits||(out+=token.text),out}))).join("").replace(/(,| |:|\.)*$/,"").replace(/^(,| |:|\.)*/,""))}function defaultFormatTemplate(){var dur=this.duration,findType=function(type){return dur._data[type]},firstType=find(this.types,findType),lastType=function(array,callback){for(var index=array.length;index-=1;)if(callback(array[index]))return array[index]}(this.types,findType);switch(firstType){case"milliseconds":return"S __";case"seconds":case"minutes":return"*_MS_";case"hours":return"_HMS_";case"days":if(firstType===lastType)return"d __";case"weeks":return firstType===lastType?"w __":(null===this.trim&&(this.trim="both"),"w __, d __, h __");case"months":if(firstType===lastType)return"M __";case"years":return firstType===lastType?"y __":(null===this.trim&&(this.trim="both"),"y __, M __, d __");default:return null===this.trim&&(this.trim="both"),"y __, d __, h __, m __, s __"}}function init(context){if(!context)throw"Moment Duration Format init cannot find moment instance.";context.duration.format=durationsFormat,context.duration.fn.format=durationFormat,context.duration.fn.format.defaults={trim:null,stopTrim:null,largest:null,maxValue:null,minValue:null,precision:0,trunc:!1,forceLength:null,userLocale:null,usePlural:!0,useLeftUnits:!1,useGrouping:!0,useSignificantDigits:!1,template:defaultFormatTemplate,useToLocaleString:!0,groupingSeparator:",",decimalSeparator:".",grouping:[3]},context.updateLocale("en",engLocale)}var toLocaleStringFormatter=function(number,locale,options){return number.toLocaleString(locale,options)};toLocaleStringWorks=function(){try{(0).toLocaleString("i")}catch(e){return"RangeError"===e.name}return!1}()&&featureTestFormatter(toLocaleStringFormatter),toLocaleStringRoundingWorks=toLocaleStringWorks&&featureTestFormatterRounding(toLocaleStringFormatter);var intlNumberFormatFormatter=function(number,locale,options){if("undefined"!=typeof window&&window&&window.Intl&&window.Intl.NumberFormat)return window.Intl.NumberFormat(locale,options).format(number)};return intlNumberFormatWorks=featureTestFormatter(intlNumberFormatFormatter),intlNumberFormatRoundingWorks=intlNumberFormatWorks&&featureTestFormatterRounding(intlNumberFormatFormatter),init(moment),init},__WEBPACK_AMD_DEFINE_ARRAY__=[__webpack_require__(3)],void 0===(__WEBPACK_AMD_DEFINE_RESULT__="function"==typeof(__WEBPACK_AMD_DEFINE_FACTORY__=factory)?__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__):__WEBPACK_AMD_DEFINE_FACTORY__)||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__),root&&(root.momentDurationFormatSetup=root.moment?factory(root.moment):factory)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConferenceParticipant=void 0;class ConferenceParticipant{constructor(participantId,userId,jid_im,jid_tel,participantRole,mute,held,confStartDate,startDate,phoneNumber,participantState,delegateCapability){this.participantId=participantId,this.userId=userId,this.jid_im=jid_im,this.jid_tel=jid_tel,this.participantRole=participantRole,this.mute=mute,this.held=held,this.confStartDate=confStartDate,this.startDate=startDate,this.phoneNumber=phoneNumber,this.participantState=participantState,this.delegateCapability=delegateCapability}static createFromData(data){return new ConferenceParticipant(data.participantId,data.userId,data.jid_im,data.jid_tel,data.participantRole,data.mute,data.held,data.confStartDate,data.startDate,data.phoneNumber,data.participantState,data.delegateCapability)}updateFromData(data){data.participantId&&(this.participantId=data.participantId),data.userId&&(this.userId=data.userId),this.jid_im=data.jid_im,data.jid_tel&&(this.jid_tel=data.jid_tel),this.participantRole=data.participantRole,this.mute=data.mute,this.held=data.held,this.confStartDate=data.confStartDate,this.startDate=data.startDate,this.phoneNumber=data.phoneNumber,this.participantState=data.participantState,this.delegateCapability=data.delegateCapability}}exports.ConferenceParticipant=ConferenceParticipant},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=__webpack_require__(54),Subscription_1=__webpack_require__(45);exports.scheduleArray=function(input,scheduler){return new Observable_1.Observable((function(subscriber){var sub=new Subscription_1.Subscription,i=0;return sub.add(scheduler.schedule((function(){i!==input.length?(subscriber.next(input[i++]),subscriber.closed||sub.add(this.schedule())):subscriber.complete()}))),sub}))}},function(module,exports,__webpack_require__){(function(Buffer){!function(exports){var storage,BUFFER=void 0!==Buffer&&Buffer,UINT8ARRAY="undefined"!=typeof Uint8Array&&Uint8Array,ARRAYBUFFER="undefined"!=typeof ArrayBuffer&&ArrayBuffer,ZERO=[0,0,0,0,0,0,0,0],isArray=Array.isArray||function(val){return!!val&&"[object Array]"==Object.prototype.toString.call(val)},BIT32=4294967296;function factory(name,bigendian,unsigned){var posH=bigendian?0:4,posL=bigendian?4:0,pos0=bigendian?0:3,pos1=bigendian?1:2,pos2=bigendian?2:1,pos3=bigendian?3:0,fromPositive=bigendian?fromPositiveBE:fromPositiveLE,fromNegative=bigendian?fromNegativeBE:fromNegativeLE,proto=Int64.prototype,isName="is"+name,_isInt64="_"+isName;return proto.buffer=void 0,proto.offset=0,proto[_isInt64]=!0,proto.toNumber=toNumber,proto.toString=function(radix){var buffer=this.buffer,offset=this.offset,high=readInt32(buffer,offset+posH),low=readInt32(buffer,offset+posL),str="",sign=!unsigned&&2147483648&high;sign&&(high=~high,low=BIT32-low);radix=radix||10;for(;;){var mod=high%radix*BIT32+low;if(high=Math.floor(high/radix),low=Math.floor(mod/radix),str=(mod%radix).toString(radix)+str,!high&&!low)break}sign&&(str="-"+str);return str},proto.toJSON=toNumber,proto.toArray=toArray,BUFFER&&(proto.toBuffer=toBuffer),UINT8ARRAY&&(proto.toArrayBuffer=toArrayBuffer),Int64[isName]=function(b){return!(!b||!b[_isInt64])},exports[name]=Int64,Int64;function Int64(buffer,offset,value,raddix){return this instanceof Int64?function(that,buffer,offset,value,raddix){UINT8ARRAY&&ARRAYBUFFER&&(buffer instanceof ARRAYBUFFER&&(buffer=new UINT8ARRAY(buffer)),value instanceof ARRAYBUFFER&&(value=new UINT8ARRAY(value)));if(!(buffer||offset||value||storage))return void(that.buffer=newArray(ZERO,0));if(!isValidBuffer(buffer,offset)){raddix=offset,value=buffer,offset=0,buffer=new(storage||Array)(8)}if(that.buffer=buffer,that.offset=offset|=0,void 0===value)return;"string"==typeof value?function(buffer,offset,str,raddix){var pos=0,len=str.length,high=0,low=0;"-"===str[0]&&pos++;var sign=pos;for(;pos<len;){var chr=parseInt(str[pos++],raddix);if(!(chr>=0))break;low=low*raddix+chr,high=high*raddix+Math.floor(low/BIT32),low%=BIT32}sign&&(high=~high,low?low=BIT32-low:high++);writeInt32(buffer,offset+posH,high),writeInt32(buffer,offset+posL,low)}(buffer,offset,value,raddix||10):isValidBuffer(value,raddix)?fromArray(buffer,offset,value,raddix):"number"==typeof raddix?(writeInt32(buffer,offset+posH,value),writeInt32(buffer,offset+posL,raddix)):value>0?fromPositive(buffer,offset,value):value<0?fromNegative(buffer,offset,value):fromArray(buffer,offset,ZERO,0)}(this,buffer,offset,value,raddix):new Int64(buffer,offset,value,raddix)}function toNumber(){var buffer=this.buffer,offset=this.offset,high=readInt32(buffer,offset+posH),low=readInt32(buffer,offset+posL);return unsigned||(high|=0),high?high*BIT32+low:low}function writeInt32(buffer,offset,value){buffer[offset+pos3]=255&value,value>>=8,buffer[offset+pos2]=255&value,value>>=8,buffer[offset+pos1]=255&value,value>>=8,buffer[offset+pos0]=255&value}function readInt32(buffer,offset){return 16777216*buffer[offset+pos0]+(buffer[offset+pos1]<<16)+(buffer[offset+pos2]<<8)+buffer[offset+pos3]}}function toArray(raw){var buffer=this.buffer,offset=this.offset;return storage=null,!1!==raw&&0===offset&&8===buffer.length&&isArray(buffer)?buffer:newArray(buffer,offset)}function toBuffer(raw){var buffer=this.buffer,offset=this.offset;if(storage=BUFFER,!1!==raw&&0===offset&&8===buffer.length&&Buffer.isBuffer(buffer))return buffer;var dest=new BUFFER(8);return fromArray(dest,0,buffer,offset),dest}function toArrayBuffer(raw){var buffer=this.buffer,offset=this.offset,arrbuf=buffer.buffer;if(storage=UINT8ARRAY,!1!==raw&&0===offset&&arrbuf instanceof ARRAYBUFFER&&8===arrbuf.byteLength)return arrbuf;var dest=new UINT8ARRAY(8);return fromArray(dest,0,buffer,offset),dest.buffer}function isValidBuffer(buffer,offset){var len=buffer&&buffer.length;return offset|=0,len&&offset+8<=len&&"string"!=typeof buffer[offset]}function fromArray(destbuf,destoff,srcbuf,srcoff){destoff|=0,srcoff|=0;for(var i=0;i<8;i++)destbuf[destoff++]=255&srcbuf[srcoff++]}function newArray(buffer,offset){return Array.prototype.slice.call(buffer,offset,offset+8)}function fromPositiveBE(buffer,offset,value){for(var pos=offset+8;pos>offset;)buffer[--pos]=255&value,value/=256}function fromNegativeBE(buffer,offset,value){var pos=offset+8;for(value++;pos>offset;)buffer[--pos]=255&-value^255,value/=256}function fromPositiveLE(buffer,offset,value){for(var end=offset+8;offset<end;)buffer[offset++]=255&value,value/=256}function fromNegativeLE(buffer,offset,value){var end=offset+8;for(value++;offset<end;)buffer[offset++]=255&-value^255,value/=256}factory("Uint64BE",!0,!0),factory("Int64BE",!0,!1),factory("Uint64LE",!1,!0),factory("Int64LE",!1,!1)}("string"!=typeof exports.nodeName?exports:this||{})}).call(this,__webpack_require__(56).Buffer)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var tools=__webpack_require__(48),tools_1=__webpack_require__(48),byEbmlID=__webpack_require__(232).byEbmlID,EBMLEncoder=function(){function EBMLEncoder(){this._schema=byEbmlID,this._buffers=[],this._stack=[]}return EBMLEncoder.prototype.encode=function(elms){var _this=this;return tools.concat(elms.reduce((function(lst,elm){return lst.concat(_this.encodeChunk(elm))}),[])).buffer},EBMLEncoder.prototype.encodeChunk=function(elm){return"m"===elm.type?elm.isEnd?this.endTag(elm):this.startTag(elm):this.writeTag(elm),this.flush()},EBMLEncoder.prototype.flush=function(){var ret=this._buffers;return this._buffers=[],ret},EBMLEncoder.prototype.getSchemaInfo=function(tagName){for(var tagNums=Object.keys(this._schema).map(Number),i=0;i<tagNums.length;i++){var tagNum=tagNums[i];if(this._schema[tagNum].name===tagName)return new tools_1.Buffer(tagNum.toString(16),"hex")}return null},EBMLEncoder.prototype.writeTag=function(elm){var tagName=elm.name,tagId=this.getSchemaInfo(tagName),tagData=elm.data;if(null==tagId)throw new Error("No schema entry found for "+tagName);var data=tools.encodeTag(tagId,tagData);this._stack.length>0?this._stack[this._stack.length-1].children.push({tagId:tagId,elm:elm,children:[],data:data}):this._buffers=this._buffers.concat(data)},EBMLEncoder.prototype.startTag=function(elm){var tagName=elm.name,tagId=this.getSchemaInfo(tagName);if(null==tagId)throw new Error("No schema entry found for "+tagName);if(elm.unknownSize){var data=tools.encodeTag(tagId,new tools_1.Buffer(0),elm.unknownSize);this._buffers=this._buffers.concat(data)}else{var tag={tagId:tagId,elm:elm,children:[],data:null};this._stack.length>0&&this._stack[this._stack.length-1].children.push(tag),this._stack.push(tag)}},EBMLEncoder.prototype.endTag=function(elm){elm.name;var tag=this._stack.pop();if(null==tag)throw new Error("EBML structure is broken");if(tag.elm.name!==elm.name)throw new Error("EBML structure is broken");var childTagDataBuffers=tag.children.reduce((function(lst,child){if(null===child.data)throw new Error("EBML structure is broken");return lst.concat(child.data)}),[]),childTagDataBuffer=tools.concat(childTagDataBuffers);"m"===tag.elm.type?tag.data=tools.encodeTag(tag.tagId,childTagDataBuffer,tag.elm.unknownSize):tag.data=tools.encodeTag(tag.tagId,childTagDataBuffer),this._stack.length<1&&(this._buffers=this._buffers.concat(tag.data))},EBMLEncoder}();exports.default=EBMLEncoder},function(module,exports,__webpack_require__){"use strict";var byEbmlID={128:{name:"ChapterDisplay",level:4,type:"m",multiple:!0,minver:1,webm:!0,description:"Contains all possible strings to use for the chapter display."},131:{name:"TrackType",level:3,type:"u",mandatory:!0,minver:1,range:"1-254",description:"A set of track types coded on 8 bits (1: video, 2: audio, 3: complex, 0x10: logo, 0x11: subtitle, 0x12: buttons, 0x20: control)."},133:{name:"ChapString",cppname:"ChapterString",level:5,type:"8",mandatory:!0,minver:1,webm:!0,description:"Contains the string to use as the chapter atom."},134:{name:"CodecID",level:3,type:"s",mandatory:!0,minver:1,description:"An ID corresponding to the codec, see the codec page for more info."},136:{name:"FlagDefault",cppname:"TrackFlagDefault",level:3,type:"u",mandatory:!0,minver:1,default:1,range:"0-1",description:"Set if that track (audio, video or subs) SHOULD be active if no language found matches the user preference. (1 bit)"},137:{name:"ChapterTrackNumber",level:5,type:"u",mandatory:!0,multiple:!0,minver:1,webm:!1,range:"not 0",description:"UID of the Track to apply this chapter too. In the absense of a control track, choosing this chapter will select the listed Tracks and deselect unlisted tracks. Absense of this element indicates that the Chapter should be applied to any currently used Tracks."},145:{name:"ChapterTimeStart",level:4,type:"u",mandatory:!0,minver:1,webm:!0,description:"Timestamp of the start of Chapter (not scaled)."},146:{name:"ChapterTimeEnd",level:4,type:"u",minver:1,webm:!1,description:"Timestamp of the end of Chapter (timestamp excluded, not scaled)."},150:{name:"CueRefTime",level:5,type:"u",mandatory:!0,minver:2,webm:!1,description:"Timestamp of the referenced Block."},151:{name:"CueRefCluster",level:5,type:"u",mandatory:!0,webm:!1,description:"The Position of the Cluster containing the referenced Block."},152:{name:"ChapterFlagHidden",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If a chapter is hidden (1), it should not be available to the user interface (but still to Control Tracks; see flag notes). (1 bit)"},16980:{name:"ContentCompAlgo",level:6,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The compression algorithm used. Algorithms that have been specified so far are: 0 - zlib,   3 - Header Stripping"},16981:{name:"ContentCompSettings",level:6,type:"b",minver:1,webm:!1,description:"Settings that might be needed by the decompressor. For Header Stripping (ContentCompAlgo=3), the bytes that were removed from the beggining of each frames of the track."},17026:{name:"DocType",level:1,type:"s",mandatory:!0,default:"matroska",minver:1,description:"A string that describes the type of document that follows this EBML header. 'matroska' in our case or 'webm' for webm files."},17029:{name:"DocTypeReadVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The minimum DocType version an interpreter has to support to read this file."},17030:{name:"EBMLVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The version of EBML parser used to create the file."},17031:{name:"DocTypeVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The version of DocType interpreter used to create the file."},17476:{name:"SegmentFamily",level:2,type:"b",multiple:!0,minver:1,webm:!1,bytesize:16,description:"A randomly generated unique ID that all segments related to each other must use (128 bits)."},17505:{name:"DateUTC",level:2,type:"d",minver:1,description:"Date of the origin of timestamp (value 0), i.e. production date."},17540:{name:"TagDefault",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"0-1",description:"Indication to know if this is the default/original language to use for the given tag. (1 bit)"},17541:{name:"TagBinary",level:4,type:"b",minver:1,webm:!1,description:"The values of the Tag if it is binary. Note that this cannot be used in the same SimpleTag as TagString."},17543:{name:"TagString",level:4,type:"8",minver:1,webm:!1,description:"The value of the Element."},17545:{name:"Duration",level:2,type:"f",minver:1,range:"> 0",description:"Duration of the segment (based on TimecodeScale)."},17816:{name:"ChapterFlagEnabled",level:4,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"0-1",description:"Specify wether the chapter is enabled. It can be enabled/disabled by a Control Track. When disabled, the movie should skip all the content between the TimeStart and TimeEnd of this chapter (see flag notes). (1 bit)"},18016:{name:"FileMimeType",level:3,type:"s",mandatory:!0,minver:1,webm:!1,description:"MIME type of the file."},18017:{name:"FileUsedStartTime",level:3,type:"u",divx:!0,description:"DivX font extension"},18018:{name:"FileUsedEndTime",level:3,type:"u",divx:!0,description:"DivX font extension"},18037:{name:"FileReferral",level:3,type:"b",webm:!1,description:"A binary value that a track/codec can refer to when the attachment is needed."},20529:{name:"ContentEncodingOrder",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"Tells when this modification was used during encoding/muxing starting with 0 and counting upwards. The decoder/demuxer has to start with the highest order number it finds and work its way down. This value has to be unique over all ContentEncodingOrder elements in the segment."},20530:{name:"ContentEncodingScope",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"not 0",description:"A bit field that describes which elements have been modified in this way. Values (big endian) can be OR'ed. Possible values: 1 - all frame contents, 2 - the track's private data, 4 - the next ContentEncoding (next ContentEncodingOrder. Either the data inside ContentCompression and/or ContentEncryption)"},20531:{name:"ContentEncodingType",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"A value describing what kind of transformation has been done. Possible values: 0 - compression, 1 - encryption"},20532:{name:"ContentCompression",level:5,type:"m",minver:1,webm:!1,description:"Settings describing the compression used. Must be present if the value of ContentEncodingType is 0 and absent otherwise. Each block must be decompressable even if no previous block is available in order not to prevent seeking."},20533:{name:"ContentEncryption",level:5,type:"m",minver:1,webm:!1,description:"Settings describing the encryption used. Must be present if the value of ContentEncodingType is 1 and absent otherwise."},21368:{name:"CueBlockNumber",level:4,type:"u",minver:1,default:1,range:"not 0",description:"Number of the Block in the specified Cluster."},22100:{name:"ChapterStringUID",level:4,type:"8",mandatory:!1,minver:3,webm:!0,description:"A unique string ID to identify the Chapter. Use for WebVTT cue identifier storage."},22337:{name:"WritingApp",level:2,type:"8",mandatory:!0,minver:1,description:'Writing application ("mkvmerge-0.3.3").'},22612:{name:"SilentTracks",cppname:"ClusterSilentTracks",level:2,type:"m",minver:1,webm:!1,description:"The list of tracks that are not used in that part of the stream. It is useful when using overlay tracks on seeking. Then you should decide what track to use."},25152:{name:"ContentEncoding",level:4,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Settings for one content encoding like compression or encryption."},25188:{name:"BitDepth",cppname:"AudioBitDepth",level:4,type:"u",minver:1,range:"not 0",description:"Bits per sample, mostly used for PCM."},25906:{name:"SignedElement",level:3,type:"b",multiple:!0,webm:!1,description:"An element ID whose data will be used to compute the signature."},26148:{name:"TrackTranslate",level:3,type:"m",multiple:!0,minver:1,webm:!1,description:"The track identification for the given Chapter Codec."},26897:{name:"ChapProcessCommand",cppname:"ChapterProcessCommand",level:5,type:"m",multiple:!0,minver:1,webm:!1,description:"Contains all the commands associated to the Atom."},26914:{name:"ChapProcessTime",cppname:"ChapterProcessTime",level:6,type:"u",mandatory:!0,minver:1,webm:!1,description:"Defines when the process command should be handled (0: during the whole chapter, 1: before starting playback, 2: after playback of the chapter)."},26916:{name:"ChapterTranslate",level:2,type:"m",multiple:!0,minver:1,webm:!1,description:"A tuple of corresponding ID used by chapter codecs to represent this segment."},26931:{name:"ChapProcessData",cppname:"ChapterProcessData",level:6,type:"b",mandatory:!0,minver:1,webm:!1,description:"Contains the command information. The data should be interpreted depending on the ChapProcessCodecID value. For ChapProcessCodecID = 1, the data correspond to the binary DVD cell pre/post commands."},26948:{name:"ChapProcess",cppname:"ChapterProcess",level:4,type:"m",multiple:!0,minver:1,webm:!1,description:"Contains all the commands associated to the Atom."},26965:{name:"ChapProcessCodecID",cppname:"ChapterProcessCodecID",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"Contains the type of the codec used for the processing. A value of 0 means native Matroska processing (to be defined), a value of 1 means the DVD command set is used. More codec IDs can be added later."},29555:{name:"Tag",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Element containing elements specific to Tracks/Chapters."},29572:{name:"SegmentFilename",level:2,type:"8",minver:1,webm:!1,description:"A filename corresponding to this segment."},29766:{name:"AttachmentLink",cppname:"TrackAttachmentLink",level:3,type:"u",minver:1,webm:!1,range:"not 0",description:"The UID of an attachment that is used by this codec."},2459272:{name:"CodecName",level:3,type:"8",minver:1,description:"A human-readable string specifying the codec."},408125543:{name:"Segment",level:"0",type:"m",mandatory:!0,multiple:!0,minver:1,description:"This element contains all other top-level (level 1) elements. Typically a Matroska file is composed of 1 segment."},17530:{name:"TagLanguage",level:4,type:"s",mandatory:!0,minver:1,webm:!1,default:"und",description:"Specifies the language of the tag specified, in the Matroska languages form."},17827:{name:"TagName",level:4,type:"8",mandatory:!0,minver:1,webm:!1,description:"The name of the Tag that is going to be stored."},26568:{name:"SimpleTag",cppname:"TagSimple",level:3,recursive:"1",type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Contains general information about the target."},25542:{name:"TagAttachmentUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Attachment(s) the tags belong to. If the value is 0 at this level, the tags apply to all the attachments in the Segment."},25540:{name:"TagChapterUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Chapter(s) the tags belong to. If the value is 0 at this level, the tags apply to all chapters in the Segment."},25545:{name:"TagEditionUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the EditionEntry(s) the tags belong to. If the value is 0 at this level, the tags apply to all editions in the Segment."},25541:{name:"TagTrackUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,default:0,description:"A unique ID to identify the Track(s) the tags belong to. If the value is 0 at this level, the tags apply to all tracks in the Segment."},25546:{name:"TargetType",cppname:"TagTargetType",level:4,type:"s",minver:1,webm:!1,strong:"informational",description:'An  string that can be used to display the logical level of the target like "ALBUM", "TRACK", "MOVIE", "CHAPTER", etc (see TargetType).'},26826:{name:"TargetTypeValue",cppname:"TagTargetTypeValue",level:4,type:"u",minver:1,webm:!1,default:50,description:"A number to indicate the logical level of the target (see TargetType)."},25536:{name:"Targets",cppname:"TagTargets",level:3,type:"m",mandatory:!0,minver:1,webm:!1,description:"Contain all UIDs where the specified meta data apply. It is empty to describe everything in the segment."},307544935:{name:"Tags",level:1,type:"m",multiple:!0,minver:1,webm:!1,description:"Element containing elements specific to Tracks/Chapters. A list of valid tags can be found here."},17677:{name:"ChapProcessPrivate",cppname:"ChapterProcessPrivate",level:5,type:"b",minver:1,webm:!1,description:'Some optional data attached to the ChapProcessCodecID information. For ChapProcessCodecID = 1, it is the "DVD level" equivalent.'},17278:{name:"ChapCountry",cppname:"ChapterCountry",level:5,type:"s",multiple:!0,minver:1,webm:!1,description:"The countries corresponding to the string, same 2 octets as in Internet domains."},17276:{name:"ChapLanguage",cppname:"ChapterLanguage",level:5,type:"s",mandatory:!0,multiple:!0,minver:1,webm:!0,default:"eng",description:"The languages corresponding to the string, in the bibliographic ISO-639-2 form."},143:{name:"ChapterTrack",level:4,type:"m",minver:1,webm:!1,description:"List of tracks on which the chapter applies. If this element is not present, all tracks apply"},25539:{name:"ChapterPhysicalEquiv",level:4,type:"u",minver:1,webm:!1,description:'Specify the physical equivalent of this ChapterAtom like "DVD" (60) or "SIDE" (50), see complete list of values.'},28348:{name:"ChapterSegmentEditionUID",level:4,type:"u",minver:1,webm:!1,range:"not 0",description:"The EditionUID to play from the segment linked in ChapterSegmentUID."},28263:{name:"ChapterSegmentUID",level:4,type:"b",minver:1,webm:!1,range:">0",bytesize:16,description:"A segment to play in place of this chapter. Edition ChapterSegmentEditionUID should be used for this segment, otherwise no edition is used."},29636:{name:"ChapterUID",level:4,type:"u",mandatory:!0,minver:1,webm:!0,range:"not 0",description:"A unique ID to identify the Chapter."},182:{name:"ChapterAtom",level:3,recursive:"1",type:"m",mandatory:!0,multiple:!0,minver:1,webm:!0,description:"Contains the atom information to use as the chapter atom (apply to all tracks)."},17885:{name:"EditionFlagOrdered",level:3,type:"u",minver:1,webm:!1,default:0,range:"0-1",description:"Specify if the chapters can be defined multiple times and the order to play them is enforced. (1 bit)"},17883:{name:"EditionFlagDefault",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If a flag is set (1) the edition should be used as the default one. (1 bit)"},17853:{name:"EditionFlagHidden",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,range:"0-1",description:"If an edition is hidden (1), it should not be available to the user interface (but still to Control Tracks; see flag notes). (1 bit)"},17852:{name:"EditionUID",level:3,type:"u",minver:1,webm:!1,range:"not 0",description:"A unique ID to identify the edition. It's useful for tagging an edition."},17849:{name:"EditionEntry",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!0,description:"Contains all information about a segment edition."},272869232:{name:"Chapters",level:1,type:"m",minver:1,webm:!0,description:"A system to define basic menus and partition data. For more detailed information, look at the Chapters Explanation."},18094:{name:"FileUID",level:3,type:"u",mandatory:!0,minver:1,webm:!1,range:"not 0",description:"Unique ID representing the file, as random as possible."},18012:{name:"FileData",level:3,type:"b",mandatory:!0,minver:1,webm:!1,description:"The data of the file."},18030:{name:"FileName",level:3,type:"8",mandatory:!0,minver:1,webm:!1,description:"Filename of the attached file."},18046:{name:"FileDescription",level:3,type:"8",minver:1,webm:!1,description:"A human-friendly name for the attached file."},24999:{name:"AttachedFile",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"An attached file."},423732329:{name:"Attachments",level:1,type:"m",minver:1,webm:!1,description:"Contain attached files."},235:{name:"CueRefCodecState",level:5,type:"u",webm:!1,default:0,description:"The position of the Codec State corresponding to this referenced element. 0 means that the data is taken from the initial Track Entry."},21343:{name:"CueRefNumber",level:5,type:"u",webm:!1,default:1,range:"not 0",description:"Number of the referenced Block of Track X in the specified Cluster."},219:{name:"CueReference",level:4,type:"m",multiple:!0,minver:2,webm:!1,description:"The Clusters containing the required referenced Blocks."},234:{name:"CueCodecState",level:4,type:"u",minver:2,webm:!1,default:0,description:"The position of the Codec State corresponding to this Cue element. 0 means that the data is taken from the initial Track Entry."},178:{name:"CueDuration",level:4,type:"u",mandatory:!1,minver:4,webm:!1,description:"The duration of the block according to the segment time base. If missing the track's DefaultDuration does not apply and no duration information is available in terms of the cues."},240:{name:"CueRelativePosition",level:4,type:"u",mandatory:!1,minver:4,webm:!1,description:"The relative position of the referenced block inside the cluster with 0 being the first possible position for an element inside that cluster.",position:"clusterRelative"},241:{name:"CueClusterPosition",level:4,type:"u",mandatory:!0,minver:1,description:"The position of the Cluster containing the required Block.",position:"segment"},247:{name:"CueTrack",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"The track for which a position is given."},183:{name:"CueTrackPositions",level:3,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contain positions for different tracks corresponding to the timestamp."},179:{name:"CueTime",level:3,type:"u",mandatory:!0,minver:1,description:"Absolute timestamp according to the segment time base."},187:{name:"CuePoint",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains all information relative to a seek point in the segment."},475249515:{name:"Cues",level:1,type:"m",minver:1,description:'A top-level element to speed seeking access. All entries are local to the segment. Should be mandatory for non "live" streams.'},18406:{name:"ContentSigHashAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The hash algorithm used for the signature. A value of '0' means that the contents have not been signed but only encrypted. Predefined values: 1 - SHA1-160 2 - MD5"},18405:{name:"ContentSigAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The algorithm used for the signature. A value of '0' means that the contents have not been signed but only encrypted. Predefined values: 1 - RSA"},18404:{name:"ContentSigKeyID",level:6,type:"b",minver:1,webm:!1,description:"This is the ID of the private key the data was signed with."},18403:{name:"ContentSignature",level:6,type:"b",minver:1,webm:!1,description:"A cryptographic signature of the contents."},18402:{name:"ContentEncKeyID",level:6,type:"b",minver:1,webm:!1,description:"For public key algorithms this is the ID of the public key the the data was encrypted with."},18401:{name:"ContentEncAlgo",level:6,type:"u",minver:1,webm:!1,default:0,description:"The encryption algorithm used. The value '0' means that the contents have not been encrypted but only signed. Predefined values: 1 - DES, 2 - 3DES, 3 - Twofish, 4 - Blowfish, 5 - AES"},28032:{name:"ContentEncodings",level:3,type:"m",minver:1,webm:!1,description:"Settings for several content encoding mechanisms like compression or encryption."},196:{name:"TrickMasterTrackSegmentUID",level:3,type:"b",divx:!0,bytesize:16,description:"DivX trick track extenstions"},199:{name:"TrickMasterTrackUID",level:3,type:"u",divx:!0,description:"DivX trick track extenstions"},198:{name:"TrickTrackFlag",level:3,type:"u",divx:!0,default:0,description:"DivX trick track extenstions"},193:{name:"TrickTrackSegmentUID",level:3,type:"b",divx:!0,bytesize:16,description:"DivX trick track extenstions"},192:{name:"TrickTrackUID",level:3,type:"u",divx:!0,description:"DivX trick track extenstions"},237:{name:"TrackJoinUID",level:5,type:"u",mandatory:!0,multiple:!0,minver:3,webm:!1,range:"not 0",description:"The trackUID number of a track whose blocks are used to create this virtual track."},233:{name:"TrackJoinBlocks",level:4,type:"m",minver:3,webm:!1,description:"Contains the list of all tracks whose Blocks need to be combined to create this virtual track"},230:{name:"TrackPlaneType",level:6,type:"u",mandatory:!0,minver:3,webm:!1,description:"The kind of plane this track corresponds to (0: left eye, 1: right eye, 2: background)."},229:{name:"TrackPlaneUID",level:6,type:"u",mandatory:!0,minver:3,webm:!1,range:"not 0",description:"The trackUID number of the track representing the plane."},228:{name:"TrackPlane",level:5,type:"m",mandatory:!0,multiple:!0,minver:3,webm:!1,description:"Contains a video plane track that need to be combined to create this 3D track"},227:{name:"TrackCombinePlanes",level:4,type:"m",minver:3,webm:!1,description:"Contains the list of all video plane tracks that need to be combined to create this 3D track"},226:{name:"TrackOperation",level:3,type:"m",minver:3,webm:!1,description:"Operation that needs to be applied on tracks to create this virtual track. For more details look at the Specification Notes on the subject."},32123:{name:"ChannelPositions",cppname:"AudioPosition",level:4,type:"b",webm:!1,description:"Table of horizontal angles for each successive channel, see appendix."},159:{name:"Channels",cppname:"AudioChannels",level:4,type:"u",mandatory:!0,minver:1,default:1,range:"not 0",description:"Numbers of channels in the track."},30901:{name:"OutputSamplingFrequency",cppname:"AudioOutputSamplingFreq",level:4,type:"f",minver:1,default:"Sampling Frequency",range:"> 0",description:"Real output sampling frequency in Hz (used for SBR techniques)."},181:{name:"SamplingFrequency",cppname:"AudioSamplingFreq",level:4,type:"f",mandatory:!0,minver:1,default:8e3,range:"> 0",description:"Sampling frequency in Hz."},225:{name:"Audio",cppname:"TrackAudio",level:3,type:"m",minver:1,description:"Audio settings."},2327523:{name:"FrameRate",cppname:"VideoFrameRate",level:4,type:"f",range:"> 0",strong:"Informational",description:"Number of frames per second.  only."},3126563:{name:"GammaValue",cppname:"VideoGamma",level:4,type:"f",webm:!1,range:"> 0",description:"Gamma Value."},3061028:{name:"ColourSpace",cppname:"VideoColourSpace",level:4,type:"b",minver:1,webm:!1,bytesize:4,description:"Same value as in AVI (32 bits)."},21683:{name:"AspectRatioType",cppname:"VideoAspectRatio",level:4,type:"u",minver:1,default:0,description:"Specify the possible modifications to the aspect ratio (0: free resizing, 1: keep aspect ratio, 2: fixed)."},21682:{name:"DisplayUnit",cppname:"VideoDisplayUnit",level:4,type:"u",minver:1,default:0,description:"How DisplayWidth & DisplayHeight should be interpreted (0: pixels, 1: centimeters, 2: inches, 3: Display Aspect Ratio)."},21690:{name:"DisplayHeight",cppname:"VideoDisplayHeight",level:4,type:"u",minver:1,default:"PixelHeight",range:"not 0",description:"Height of the video frames to display. The default value is only valid when DisplayUnit is 0."},21680:{name:"DisplayWidth",cppname:"VideoDisplayWidth",level:4,type:"u",minver:1,default:"PixelWidth",range:"not 0",description:"Width of the video frames to display. The default value is only valid when DisplayUnit is 0."},21725:{name:"PixelCropRight",cppname:"VideoPixelCropRight",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove on the right of the image."},21708:{name:"PixelCropLeft",cppname:"VideoPixelCropLeft",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove on the left of the image."},21691:{name:"PixelCropTop",cppname:"VideoPixelCropTop",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove at the top of the image."},21674:{name:"PixelCropBottom",cppname:"VideoPixelCropBottom",level:4,type:"u",minver:1,default:0,description:"The number of video pixels to remove at the bottom of the image (for HDTV content)."},186:{name:"PixelHeight",cppname:"VideoPixelHeight",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"Height of the encoded video frames in pixels."},176:{name:"PixelWidth",cppname:"VideoPixelWidth",level:4,type:"u",mandatory:!0,minver:1,range:"not 0",description:"Width of the encoded video frames in pixels."},21433:{name:"OldStereoMode",level:4,type:"u",maxver:"0",webm:!1,divx:!1,description:"DEPRECATED, DO NOT USE. Bogus StereoMode value used in old versions of libmatroska. (0: mono, 1: right eye, 2: left eye, 3: both eyes)."},21440:{name:"AlphaMode",cppname:"VideoAlphaMode",level:4,type:"u",minver:3,webm:!0,default:0,description:"Alpha Video Mode. Presence of this element indicates that the BlockAdditional element could contain Alpha data."},21432:{name:"StereoMode",cppname:"VideoStereoMode",level:4,type:"u",minver:3,webm:!0,default:0,description:"Stereo-3D video mode (0: mono, 1: side by side (left eye is first), 2: top-bottom (right eye is first), 3: top-bottom (left eye is first), 4: checkboard (right is first), 5: checkboard (left is first), 6: row interleaved (right is first), 7: row interleaved (left is first), 8: column interleaved (right is first), 9: column interleaved (left is first), 10: anaglyph (cyan/red), 11: side by side (right eye is first), 12: anaglyph (green/magenta), 13 both eyes laced in one Block (left eye is first), 14 both eyes laced in one Block (right eye is first)) . There are some more details on 3D support in the Specification Notes."},154:{name:"FlagInterlaced",cppname:"VideoFlagInterlaced",level:4,type:"u",mandatory:!0,minver:2,webm:!0,default:0,range:"0-1",description:"Set if the video is interlaced. (1 bit)"},224:{name:"Video",cppname:"TrackVideo",level:3,type:"m",minver:1,description:"Video settings."},26277:{name:"TrackTranslateTrackID",level:4,type:"b",mandatory:!0,minver:1,webm:!1,description:"The binary value used to represent this track in the chapter codec data. The format depends on the ChapProcessCodecID used."},26303:{name:"TrackTranslateCodec",level:4,type:"u",mandatory:!0,minver:1,webm:!1,description:"The chapter codec using this ID (0: Matroska Script, 1: DVD-menu)."},26364:{name:"TrackTranslateEditionUID",level:4,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify an edition UID on which this translation applies. When not specified, it means for all editions found in the segment."},22203:{name:"SeekPreRoll",level:3,type:"u",mandatory:!0,multiple:!1,default:0,minver:4,webm:!0,description:"After a discontinuity, SeekPreRoll is the duration in nanoseconds of the data the decoder must decode before the decoded data is valid."},22186:{name:"CodecDelay",level:3,type:"u",multiple:!1,default:0,minver:4,webm:!0,description:"CodecDelay is The codec-built-in delay in nanoseconds. This value must be subtracted from each block timestamp in order to get the actual timestamp. The value should be small so the muxing of tracks with the same actual timestamp are in the same Cluster."},28587:{name:"TrackOverlay",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify that this track is an overlay track for the Track specified (in the u-integer). That means when this track has a gap (see SilentTracks) the overlay track should be used instead. The order of multiple TrackOverlay matters, the first one is the one that should be used. If not found it should be the second, etc."},170:{name:"CodecDecodeAll",level:3,type:"u",mandatory:!0,minver:2,webm:!1,default:1,range:"0-1",description:"The codec can decode potentially damaged data (1 bit)."},2536e3:{name:"CodecDownloadURL",level:3,type:"s",multiple:!0,webm:!1,description:"A URL to download about the codec used."},3883072:{name:"CodecInfoURL",level:3,type:"s",multiple:!0,webm:!1,description:"A URL to find information about the codec used."},3839639:{name:"CodecSettings",level:3,type:"8",webm:!1,description:"A string describing the encoding setting used."},25506:{name:"CodecPrivate",level:3,type:"b",minver:1,description:"Private data only known to the codec."},2274716:{name:"Language",cppname:"TrackLanguage",level:3,type:"s",minver:1,default:"eng",description:"Specifies the language of the track in the Matroska languages form."},21358:{name:"Name",cppname:"TrackName",level:3,type:"8",minver:1,description:"A human-readable track name."},21998:{name:"MaxBlockAdditionID",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The maximum value of BlockAdditions for this track."},21375:{name:"TrackOffset",level:3,type:"i",webm:!1,default:0,description:"A value to add to the Block's Timestamp. This can be used to adjust the playback offset of a track."},2306383:{name:"TrackTimecodeScale",level:3,type:"f",mandatory:!0,minver:1,maxver:"3",webm:!1,default:1,range:"> 0",description:"DEPRECATED, DO NOT USE. The scale to apply on this track to work at normal speed in relation with other tracks (mostly used to adjust video speed when the audio length differs)."},2313850:{name:"DefaultDecodedFieldDuration",cppname:"TrackDefaultDecodedFieldDuration",level:3,type:"u",minver:4,range:"not 0",description:"The period in nanoseconds (not scaled by TimcodeScale)\nbetween two successive fields at the output of the decoding process (see the notes)"},2352003:{name:"DefaultDuration",cppname:"TrackDefaultDuration",level:3,type:"u",minver:1,range:"not 0",description:"Number of nanoseconds (not scaled via TimecodeScale) per frame ('frame' in the Matroska sense -- one element put into a (Simple)Block)."},28152:{name:"MaxCache",cppname:"TrackMaxCache",level:3,type:"u",minver:1,webm:!1,description:"The maximum cache size required to store referenced frames in and the current frame. 0 means no cache is needed."},28135:{name:"MinCache",cppname:"TrackMinCache",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"The minimum number of frames a player should be able to cache during playback. If set to 0, the reference pseudo-cache system is not used."},156:{name:"FlagLacing",cppname:"TrackFlagLacing",level:3,type:"u",mandatory:!0,minver:1,default:1,range:"0-1",description:"Set if the track may contain blocks using lacing. (1 bit)"},21930:{name:"FlagForced",cppname:"TrackFlagForced",level:3,type:"u",mandatory:!0,minver:1,default:0,range:"0-1",description:"Set if that track MUST be active during playback. There can be many forced track for a kind (audio, video or subs), the player should select the one which language matches the user preference or the default + forced track. Overlay MAY happen between a forced and non-forced track of the same kind. (1 bit)"},185:{name:"FlagEnabled",cppname:"TrackFlagEnabled",level:3,type:"u",mandatory:!0,minver:2,webm:!0,default:1,range:"0-1",description:"Set if the track is usable. (1 bit)"},29637:{name:"TrackUID",level:3,type:"u",mandatory:!0,minver:1,range:"not 0",description:"A unique ID to identify the Track. This should be kept the same when making a direct stream copy of the Track to another file."},215:{name:"TrackNumber",level:3,type:"u",mandatory:!0,minver:1,range:"not 0",description:"The track number as used in the Block Header (using more than 127 tracks is not encouraged, though the design allows an unlimited number)."},174:{name:"TrackEntry",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Describes a track with all elements."},374648427:{name:"Tracks",level:1,type:"m",multiple:!0,minver:1,description:"A top-level block of information with many tracks described."},175:{name:"EncryptedBlock",level:2,type:"b",multiple:!0,webm:!1,description:"Similar to EncryptedBlock Structure)"},202:{name:"ReferenceTimeCode",level:4,type:"u",multiple:!1,mandatory:!0,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},201:{name:"ReferenceOffset",level:4,type:"u",multiple:!1,mandatory:!0,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},200:{name:"ReferenceFrame",level:3,type:"m",multiple:!1,minver:0,webm:!1,divx:!0,description:"DivX trick track extenstions"},207:{name:"SliceDuration",level:5,type:"u",default:0,description:"The (scaled) duration to apply to the element."},206:{name:"Delay",cppname:"SliceDelay",level:5,type:"u",default:0,description:"The (scaled) delay to apply to the element."},203:{name:"BlockAdditionID",cppname:"SliceBlockAddID",level:5,type:"u",default:0,description:"The ID of the BlockAdditional element (0 is the main Block)."},205:{name:"FrameNumber",cppname:"SliceFrameNumber",level:5,type:"u",default:0,description:"The number of the frame to generate from this lace with this delay (allow you to generate many frames from the same Block/Frame)."},204:{name:"LaceNumber",cppname:"SliceLaceNumber",level:5,type:"u",minver:1,default:0,divx:!1,description:"The reverse number of the frame in the lace (0 is the last frame, 1 is the next to last, etc). While there are a few files in the wild with this element, it is no longer in use and has been deprecated. Being able to interpret this element is not required for playback."},232:{name:"TimeSlice",level:4,type:"m",multiple:!0,minver:1,divx:!1,description:"Contains extra time information about the data contained in the Block. While there are a few files in the wild with this element, it is no longer in use and has been deprecated. Being able to interpret this element is not required for playback."},142:{name:"Slices",level:3,type:"m",minver:1,divx:!1,description:"Contains slices description."},30114:{name:"DiscardPadding",level:3,type:"i",minver:4,webm:!0,description:"Duration in nanoseconds of the silent data added to the Block (padding at the end of the Block for positive value, at the beginning of the Block for negative value). The duration of DiscardPadding is not calculated in the duration of the TrackEntry and should be discarded during playback."},164:{name:"CodecState",level:3,type:"b",minver:2,webm:!1,description:"The new codec state to use. Data interpretation is private to the codec. This information should always be referenced by a seek entry."},253:{name:"ReferenceVirtual",level:3,type:"i",webm:!1,description:"Relative position of the data that should be in position of the virtual block."},251:{name:"ReferenceBlock",level:3,type:"i",multiple:!0,minver:1,description:"Timestamp of another frame used as a reference (ie: B or P frame). The timestamp is relative to the block it's attached to."},250:{name:"ReferencePriority",cppname:"FlagReferenced",level:3,type:"u",mandatory:!0,minver:1,webm:!1,default:0,description:"This frame is referenced and has the specified cache priority. In cache only a frame of the same or higher priority can replace this frame. A value of 0 means the frame is not referenced."},155:{name:"BlockDuration",level:3,type:"u",minver:1,default:"TrackDuration",description:'The duration of the Block (based on TimecodeScale). This element is mandatory when DefaultDuration is set for the track (but can be omitted as other default values). When not written and with no DefaultDuration, the value is assumed to be the difference between the timestamp of this Block and the timestamp of the next Block in "display" order (not coding order). This element can be useful at the end of a Track (as there is not other Block available), or when there is a break in a track like for subtitle tracks. When set to 0 that means the frame is not a keyframe.'},165:{name:"BlockAdditional",level:5,type:"b",mandatory:!0,minver:1,webm:!1,description:"Interpreted by the codec as it wishes (using the BlockAddID)."},238:{name:"BlockAddID",level:5,type:"u",mandatory:!0,minver:1,webm:!1,default:1,range:"not 0",description:"An ID to identify the BlockAdditional level."},166:{name:"BlockMore",level:4,type:"m",mandatory:!0,multiple:!0,minver:1,webm:!1,description:"Contain the BlockAdditional and some parameters."},30113:{name:"BlockAdditions",level:3,type:"m",minver:1,webm:!1,description:"Contain additional blocks to complete the main one. An EBML parser that has no knowledge of the Block structure could still see and use/skip these data."},162:{name:"BlockVirtual",level:3,type:"b",webm:!1,description:"A Block with no data. It must be stored in the stream at the place the real Block should be in display order. (see Block Virtual)"},161:{name:"Block",level:3,type:"b",mandatory:!0,minver:1,description:"Block containing the actual data to be rendered and a timestamp relative to the Cluster Timecode. (see Block Structure)"},160:{name:"BlockGroup",level:2,type:"m",multiple:!0,minver:1,description:"Basic container of information containing a single Block or BlockVirtual, and information specific to that Block/VirtualBlock."},163:{name:"SimpleBlock",level:2,type:"b",multiple:!0,minver:2,webm:!0,divx:!0,description:"Similar to SimpleBlock Structure"},171:{name:"PrevSize",cppname:"ClusterPrevSize",level:2,type:"u",minver:1,description:"Size of the previous Cluster, in octets. Can be useful for backward playing.",position:"prevCluster"},167:{name:"Position",cppname:"ClusterPosition",level:2,type:"u",minver:1,webm:!1,description:"The Position of the Cluster in the segment (0 in live broadcast streams). It might help to resynchronise offset on damaged streams.",position:"segment"},22743:{name:"SilentTrackNumber",cppname:"ClusterSilentTrackNumber",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"One of the track number that are not used from now on in the stream. It could change later if not specified as silent in a further Cluster."},231:{name:"Timecode",cppname:"ClusterTimecode",level:2,type:"u",mandatory:!0,minver:1,description:"Absolute timestamp of the cluster (based on TimecodeScale)."},524531317:{name:"Cluster",level:1,type:"m",multiple:!0,minver:1,description:"The lower level element containing the (monolithic) Block structure."},19840:{name:"MuxingApp",level:2,type:"8",mandatory:!0,minver:1,description:'Muxing application or library ("libmatroska-0.4.3").'},31657:{name:"Title",level:2,type:"8",minver:1,webm:!1,description:"General name of the segment."},2807730:{name:"TimecodeScaleDenominator",level:2,type:"u",mandatory:!0,minver:4,default:"1000000000",description:"Timestamp scale numerator, see TimecodeScale."},2807729:{name:"TimecodeScale",level:2,type:"u",mandatory:!0,minver:1,default:"1000000",description:"Timestamp scale in nanoseconds (1.000.000 means all timestamps in the segment are expressed in milliseconds)."},27045:{name:"ChapterTranslateID",level:3,type:"b",mandatory:!0,minver:1,webm:!1,description:"The binary value used to represent this segment in the chapter codec data. The format depends on the ChapProcessCodecID used."},27071:{name:"ChapterTranslateCodec",level:3,type:"u",mandatory:!0,minver:1,webm:!1,description:"The chapter codec using this ID (0: Matroska Script, 1: DVD-menu)."},27132:{name:"ChapterTranslateEditionUID",level:3,type:"u",multiple:!0,minver:1,webm:!1,description:"Specify an edition UID on which this correspondance applies. When not specified, it means for all editions found in the segment."},4096955:{name:"NextFilename",level:2,type:"8",minver:1,webm:!1,description:"An escaped filename corresponding to the next segment."},4110627:{name:"NextUID",level:2,type:"b",minver:1,webm:!1,bytesize:16,description:"A unique ID to identify the next chained segment (128 bits)."},3965867:{name:"PrevFilename",level:2,type:"8",minver:1,webm:!1,description:"An escaped filename corresponding to the previous segment."},3979555:{name:"PrevUID",level:2,type:"b",minver:1,webm:!1,bytesize:16,description:"A unique ID to identify the previous chained segment (128 bits)."},29604:{name:"SegmentUID",level:2,type:"b",minver:1,webm:!1,range:"not 0",bytesize:16,description:"A randomly generated unique ID to identify the current segment between many others (128 bits)."},357149030:{name:"Info",level:1,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains miscellaneous general information and statistics on the file."},21420:{name:"SeekPosition",level:3,type:"u",mandatory:!0,minver:1,description:"The position of the element in the segment in octets (0 = first level 1 element).",position:"segment"},21419:{name:"SeekID",level:3,type:"b",mandatory:!0,minver:1,description:"The binary ID corresponding to the element name.",type2:"ebmlID"},19899:{name:"Seek",cppname:"SeekPoint",level:2,type:"m",mandatory:!0,multiple:!0,minver:1,description:"Contains a single seek entry to an EBML element."},290298740:{name:"SeekHead",cppname:"SeekHeader",level:1,type:"m",multiple:!0,minver:1,description:"Contains the position of other level 1 elements."},32379:{name:"SignatureElementList",level:2,type:"m",multiple:!0,webm:!1,i:"Cluster|Block|BlockAdditional",description:"A list consists of a number of consecutive elements that represent one case where data is used in signature. Ex:  means that the BlockAdditional of all Blocks in all Clusters is used for encryption."},32347:{name:"SignatureElements",level:1,type:"m",webm:!1,description:"Contains elements that will be used to compute the signature."},32437:{name:"Signature",level:1,type:"b",webm:!1,description:"The signature of the data (until a new."},32421:{name:"SignaturePublicKey",level:1,type:"b",webm:!1,description:"The public key to use with the algorithm (in the case of a PKI-based signature)."},32410:{name:"SignatureHash",level:1,type:"u",webm:!1,description:"Hash algorithm used (1=SHA1-160, 2=MD5)."},32394:{name:"SignatureAlgo",level:1,type:"u",webm:!1,description:"Signature algorithm used (1=RSA, 2=elliptic)."},458458727:{name:"SignatureSlot",level:-1,type:"m",multiple:!0,webm:!1,description:"Contain signature of some (coming) elements in the stream."},191:{name:"CRC-32",level:-1,type:"b",minver:1,webm:!1,description:"The CRC is computed on all the data of the Master element it's in. The CRC element should be the first in it's parent master for easier reading. All level 1 elements should include a CRC-32. The CRC in use is the IEEE CRC32 Little Endian",crc:!0},236:{name:"Void",level:-1,type:"b",minver:1,description:"Used to void damaged data, to avoid unexpected behaviors when using damaged data. The content is discarded. Also used to reserve space in a sub-element for later use."},17139:{name:"EBMLMaxSizeLength",level:1,type:"u",mandatory:!0,default:8,minver:1,description:"The maximum length of the sizes you'll find in this file (8 or less in Matroska). This does not override the element size indicated at the beginning of an element. Elements that have an indicated size which is larger than what is allowed by EBMLMaxSizeLength shall be considered invalid."},17138:{name:"EBMLMaxIDLength",level:1,type:"u",mandatory:!0,default:4,minver:1,description:"The maximum length of the IDs you'll find in this file (4 or less in Matroska)."},17143:{name:"EBMLReadVersion",level:1,type:"u",mandatory:!0,default:1,minver:1,description:"The minimum EBML version a parser has to support to read this file."},440786851:{name:"EBML",level:"0",type:"m",mandatory:!0,multiple:!0,minver:1,description:"Set the EBML characteristics of the data to follow. Each EBML document has to start with this."}},byName={},schema={byEbmlID:byEbmlID,byName:byName};for(var ebmlID in byEbmlID){byName[byEbmlID[ebmlID].name.replace("-","_")]=parseInt(ebmlID,10)}module.exports=schema},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.InvitationService=void 0;const settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),contact_service_1=__webpack_require__(1),logger_service_1=__webpack_require__(15),errorHelper_service_1=__webpack_require__(39),event_service_1=__webpack_require__(32),invitation_model_1=__webpack_require__(412),rxjs_1=__webpack_require__(10),moment=__webpack_require__(3);class InvitationService{constructor(){this.logger=logger_service_1.default,this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.contactService=contact_service_1.default,this.settingsService=settings_service_1.default,this.errorHelperService=errorHelper_service_1.default,this.eventService=event_service_1.default,this.subscription=null,this.xmppHandler=null,this.rxSubject=new rxjs_1.Subject,this.portalURL=null,this.receivedInvitations={},this.sentInvitations={},this.acceptedInvitationsArray=[],this.sentInvitationsArray=[],this.receivedInvitationsArray=[]}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.invitationService||(win.rainbow.invitationService=new InvitationService),win.rainbow.invitationService}start(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(""),this.logger.info("[invitationService] === STARTING ==="),this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/",this.attachHandlers(),this.getAllSentInvitations(),this.getAllReceivedInvitations(),this.logger.info("[invitationService] === STARTED ==="),this.subscription=this.xmppService.subscribeToContactEvents(event=>{"ON_ROSTER_CHANGED_EVENT"===event.name&&this.getAllSentInvitations()})}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(""),this.logger.info("[invitationService] === STOPPING ==="),this.subscription&&this.subscription.unsubscribe(),this.logger.info("[invitationService] === STOPPED ===")}))}subscribe(callback){return this.rxSubject.subscribe(callback)}sendEvent(type,value=null){this.rxSubject.next({type:type,value:value}),this.eventService.publish(type,value)}attachHandlers(){this.logger.info("[invitationService] attachHandlers"),this.xmppHandler&&(xmpp_service_1.default.connection.deleteHandler(this.xmppHandler),this.xmppHandler=null),this.xmppHandler=xmpp_service_1.default.connection.addHandler(stanza=>this.onInvitationsUpdate(stanza),null,"message","management")}onInvitationsUpdate(stanza){const userInviteElem=$(stanza).find("userinvite");if(userInviteElem.length){const id=userInviteElem.attr("id"),type=userInviteElem.attr("type"),action=userInviteElem.attr("action");switch(type){case"received":this.handleReceivedInvitation(id,action);break;case"sent":this.handleSentInvitation(id,action);break;default:this.logger.warn("[invitationService] onInvitationsUpdate - received unexpected type - "+type)}}return!0}handleReceivedInvitation(id,action){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info("[invitationService] handleReceivedInvitation"),"delete"===action)return delete this.receivedInvitations[id],void this.updateReceivedInvitationsArray();const invitation=yield this.getServerInvitation(id);let updateInvitation=null,status="none";switch(invitation.status){case"pending":if(this.receivedInvitations[invitation.id]=invitation,updateInvitation=invitation,status="ask",invitation.invitingUserId){const contact=yield this.contactService.getContactByDBId(invitation.invitingUserId,!0);this.sendEvent("ON_INVITATION_RECEIVED",contact)}break;case"accepted":case"auto-accepted":if(this.receivedInvitations[invitation.id]=invitation,this.sendEvent("ON_INVITATION_ACCEPTED",invitation.invitingUserId),invitation.invitingUserId){const contact=yield this.contactService.getContactByDBId(invitation.invitingUserId,!0);this.eventService.publish("ON_CONTACT_UPDATED_EVENT",contact)}break;default:delete this.receivedInvitations[invitation.id],status="unknown"}invitation.invitingUserId&&(yield this.updateContactInvitationStatus(invitation.invitingUserId,status,updateInvitation)),this.updateReceivedInvitationsArray(),this.sendEvent("ON_INVITATION_CHANGED",invitation)}))}handleSentInvitation(id,action){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info("[invitationService] handleSentInvitation"),"delete"===action)return delete this.sentInvitations[id],void this.updateReceivedInvitationsArray();const invitation=yield this.getServerInvitation(id);let contactStatus=null;switch(invitation.status){case"pending":this.sentInvitations[invitation.id]=invitation,contactStatus="wait";break;case"accepted":case"auto-accepted":if(this.sendEvent("ON_INVITATION_ACCEPTED",invitation.invitedUserId),invitation.invitedUserId){const contact=yield this.contactService.getContactByDBId(invitation.invitedUserId,!0);this.eventService.publish("ON_CONTACT_UPDATED_EVENT",contact)}break;default:delete this.sentInvitations[invitation.id],contactStatus="unknown"}invitation.invitedUserId&&(yield this.updateContactInvitationStatus(invitation.invitedUserId,contactStatus,invitation)),this.updateSentInvitationsArray(),"resend"===action&&this.sendEvent("ON_INVITATIONS_RE_SEND",id)}))}updateReceivedInvitationsArray(){this.receivedInvitationsArray=[],this.acceptedInvitationsArray=[];for(const key in this.receivedInvitations)if(this.receivedInvitations.hasOwnProperty(key)){const invitation=this.receivedInvitations[key];switch(invitation.status){case"pending":this.receivedInvitationsArray.push(invitation);break;case"accepted":case"auto-accepted":this.acceptedInvitationsArray.push(invitation)}}this.receivedInvitationsArray.sort(this.sortInvitationArray),this.acceptedInvitationsArray=this.acceptedInvitationsArray.filter((function(acceptedInvitation){const lastInvite=moment(acceptedInvitation.lastNotificationDate);return moment.duration(moment().diff(lastInvite)).asHours()<168})),this.acceptedInvitationsArray.sort(this.sortInvitationArray),this.sendEvent("ON_INVITATIONS_NUMBER_UPDATED")}updateSentInvitationsArray(){this.sentInvitationsArray=[];for(const key in this.sentInvitations)this.sentInvitations.hasOwnProperty(key)&&this.sentInvitationsArray.push(this.sentInvitations[key]);this.sentInvitationsArray.sort(this.sortInvitationArray),this.sendEvent("ON_INVITATIONS_NUMBER_UPDATED")}getServerInvitation(invitationId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}${this.contactService.userContact.dbId}/invitations/${invitationId}`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const invitationData=(yield response.json()).data;return this.logger.info("[invitationService] getServerInvitation success"),invitation_model_1.Invitation.createFromData(invitationData)}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getServerInvitation");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}getReceivedInvitations(){return this.receivedInvitationsArray}getAcceptedInvitations(){return this.acceptedInvitationsArray}getSentInvitations(){return this.sentInvitationsArray}getInvitationsNumberForCounter(){return this.receivedInvitationsArray.length}getAllInvitationsNumber(){return this.receivedInvitationsArray.length+this.sentInvitationsArray.length+this.acceptedInvitationsArray.length}getInvitation(invitationId){let invitationFound=this.receivedInvitations[invitationId];return invitationFound||(invitationFound=this.acceptedInvitationsArray[invitationId]),invitationFound||(invitationFound=this.sentInvitations[invitationId]),invitationFound}joinContactInvitation(contact,customMessage=""){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info(`[invitationService] joinContactInvitation contact (${contact.jid})`);const url=`${this.portalURL}${this.contactService.userContact.dbId}/invitations`,headers=this.authService.getPostHeader(),data={invitedUserId:contact.dbId,customMessage:customMessage},response=yield fetch(url,{method:"POST",headers:headers,body:JSON.stringify(data)});if(!response.ok)throw response;this.logger.info(`[invitationService] joinContactInvitation - success (${contact.jid})`),"unknown"===contact.status&&this.updateContactInvitationStatus(contact.dbId,"wait")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"joinContactInvitation");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}sendInvitationByEmail(email,customMessage=""){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[invitationService] sendInvitationByEmail");const lang=this.settingsService.getAppliLanguageCodeForServer(),url=`${this.portalURL}${this.contactService.userContact.dbId}/invitations`,headers=this.authService.getPostHeader(),data={email:email,lang:lang,customMessage:customMessage},response=yield fetch(url,{method:"POST",headers:headers,body:JSON.stringify(data)});if(!response.ok)throw response;this.logger.info("[invitationService] sendInvitationByEmail - success")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"sendInvitationByEmail");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}cancelOneSendInvitation(invitation){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}${invitation.invitingUserId}/invitations/${invitation.id}/cancel`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"POST",headers:headers});if(!response.ok)throw response;this.logger.info("[invitationService] cancelOneSendInvitation success")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"cancelOneSendInvitation");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}reSendInvitation(invitationId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/invitations/${invitationId}/re-send`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"POST",headers:headers});if(!response.ok)throw response;this.logger.info(`[invitationService] reSendInvitation ${invitationId} success`)}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"reSendInvitation");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}sendInvitationsParBulk(emails){return __awaiter(this,void 0,void 0,(function*(){if(!emails.length||emails.length>100)throw this.logger.error("[invitationService] sendInvitationsParBulk mail list length not correct"),new Error("sendInvitationsParBulk mail list length not correct");try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/invitations/bulk`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"POST",headers:headers,body:JSON.stringify({emails:emails})});if(!response.ok)throw response;this.logger.info("[invitationService] sendInvitationsParBulk - success")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"sendInvitationsParBulk");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}acceptInvitation(invitation){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}${invitation.invitedUserId}/invitations/${invitation.id}/accept`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"POST",headers:headers});if(!response.ok)throw response;this.logger.info("[invitationService] acceptInvitation success")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"acceptInvitation");if(!errorInfo.error.errorDetailsCode||409605!==errorInfo.error.errorDetailsCode)throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error;{const contact=yield this.contactService.getContactByDBId(invitation.invitingUserId,!0);this.eventService.publish("ON_CONTACT_UPDATED_EVENT",contact)}}}))}declineInvitation(invitation){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}${invitation.invitedUserId}/invitations/${invitation.id}/decline`,headers=this.authService.getPostHeader(),response=yield fetch(url,{method:"POST",headers:headers});if(!response.ok)throw response;this.logger.info("[invitationService] declineInvitation success")}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"declineInvitation");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}updateContactInvitationStatus(contactDBId,status,invitation=null){return __awaiter(this,void 0,void 0,(function*(){const contact=yield this.contactService.getContactByDBId(contactDBId);switch(status){case"ask":contact.status="unknown",contact.ask="ask",contact.invitation=invitation;break;case"wait":contact.status="wait",contact.ask="subscribe",contact.invitation=invitation;break;default:contact.ask="none",contact.invitation=null}this.contactService.updateContactRichStatus(contact),contact.rxSubject.next({name:"update",data:contact})}))}sortInvitationArray(invitA,invitB){return new Date(invitB.lastNotificationDate).getTime()-new Date(invitA.lastNotificationDate).getTime()}getAllReceivedInvitations(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}${this.contactService.userContact.dbId}/invitations/received?format=full&status=pending&limit=500`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const invitationsData=(yield response.json()).data;return this.logger.info(`[invitationService] getAllReceivedInvitations success (find ${invitationsData.length} invitations)`),this.receivedInvitations={},invitationsData.forEach(invitationData=>{if("pending"===invitationData.status&&"registration"!==invitationData.type){const invitation=invitation_model_1.Invitation.createFromData(invitationData);this.receivedInvitations[invitationData.id]=invitation,invitationData.invitingUserId&&this.updateContactInvitationStatus(invitationData.invitingUserId,"ask",invitation)}else"accepted"!==invitationData.status&&"auto-accepted"!==invitationData.status||(this.receivedInvitations[invitationData.id]=invitation_model_1.Invitation.createFromData(invitationData))}),this.updateReceivedInvitationsArray(),this.receivedInvitations}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getAllReceivedInvitations");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}getAllSentInvitations(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}${this.contactService.userContact.dbId}/invitations/sent?format=full&status=pending&limit=500`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const invitationsData=(yield response.json()).data;return this.logger.info("[invitationService] getAllSentInvitations success (find "+invitationsData.length+" invitations)"),this.sentInvitations={},invitationsData.forEach(invitationData=>{if("pending"===invitationData.status&&!invitationData.inviteToJoinMeeting){const sentInvitation=invitation_model_1.Invitation.createFromData(invitationData);this.sentInvitations[invitationData.id]=sentInvitation,void 0!==sentInvitation.invitedUserId&&this.updateContactInvitationStatus(sentInvitation.invitedUserId,"wait",sentInvitation)}}),this.updateSentInvitationsArray(),this.sentInvitations}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getAllSentInvitations");throw this.logger.error("[invitationService] "+errorInfo.message),errorInfo.error}}))}}exports.InvitationService=InvitationService,exports.default=InvitationService.getInstance()},function(module,exports,__webpack_require__){"use strict";var SDPUtils=__webpack_require__(52);function writeMediaSection(transceiver,caps,type,stream,dtlsRole){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);if(sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()),sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),"offer"===type?"actpass":dtlsRole||"active"),sdp+="a=mid:"+transceiver.mid+"\r\n",transceiver.rtpSender&&transceiver.rtpReceiver?sdp+="a=sendrecv\r\n":transceiver.rtpSender?sdp+="a=sendonly\r\n":transceiver.rtpReceiver?sdp+="a=recvonly\r\n":sdp+="a=inactive\r\n",transceiver.rtpSender){var trackId=transceiver.rtpSender._initialTrackId||transceiver.rtpSender.track.id;transceiver.rtpSender._initialTrackId=trackId;var msid="msid:"+(stream?stream.id:"-")+" "+trackId+"\r\n";sdp+="a="+msid,sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid,transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid,sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n",transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"),sdp}function getCommonCapabilities(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]},findCodecByPayloadType=function(pt,codecs){pt=parseInt(pt,10);for(var i=0;i<codecs.length;i++)if(codecs[i].payloadType===pt||codecs[i].preferredPayloadType===pt)return codecs[i]},rtxCapabilityMatches=function(lRtx,rRtx,lCodecs,rCodecs){var lCodec=findCodecByPayloadType(lRtx.parameters.apt,lCodecs),rCodec=findCodecByPayloadType(rRtx.parameters.apt,rCodecs);return lCodec&&rCodec&&lCodec.name.toLowerCase()===rCodec.name.toLowerCase()};return localCapabilities.codecs.forEach((function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate){if("rtx"===lCodec.name.toLowerCase()&&lCodec.parameters&&rCodec.parameters.apt&&!rtxCapabilityMatches(lCodec,rCodec,localCapabilities.codecs,remoteCapabilities.codecs))continue;(rCodec=JSON.parse(JSON.stringify(rCodec))).numChannels=Math.min(lCodec.numChannels,rCodec.numChannels),commonCapabilities.codecs.push(rCodec),rCodec.rtcpFeedback=rCodec.rtcpFeedback.filter((function(fb){for(var j=0;j<lCodec.rtcpFeedback.length;j++)if(lCodec.rtcpFeedback[j].type===fb.type&&lCodec.rtcpFeedback[j].parameter===fb.parameter)return!0;return!1}));break}}})),localCapabilities.headerExtensions.forEach((function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}})),commonCapabilities}function isActionAllowedInSignalingState(action,type,signalingState){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[type][action].indexOf(signalingState)}function maybeAddCandidate(iceTransport,candidate){var alreadyAdded=iceTransport.getRemoteCandidates().find((function(remoteCandidate){return candidate.foundation===remoteCandidate.foundation&&candidate.ip===remoteCandidate.ip&&candidate.port===remoteCandidate.port&&candidate.priority===remoteCandidate.priority&&candidate.protocol===remoteCandidate.protocol&&candidate.type===remoteCandidate.type}));return alreadyAdded||iceTransport.addRemoteCandidate(candidate),!alreadyAdded}function makeError(name,description){var e=new Error(description);return e.name=name,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[name],e}module.exports=function(window,edgeVersion){function addTrackToStreamAndFireEvent(track,stream){stream.addTrack(track),stream.dispatchEvent(new window.MediaStreamTrackEvent("addtrack",{track:track}))}function fireAddTrack(pc,track,receiver,streams){var trackEvent=new Event("track");trackEvent.track=track,trackEvent.receiver=receiver,trackEvent.transceiver={receiver:receiver},trackEvent.streams=streams,window.setTimeout((function(){pc._dispatchEvent("track",trackEvent)}))}var RTCPeerConnection=function(config){var pc=this,_eventTarget=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(method){pc[method]=_eventTarget[method].bind(_eventTarget)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",config=JSON.parse(JSON.stringify(config||{})),this.usingBundle="max-bundle"===config.bundlePolicy,"negotiate"===config.rtcpMuxPolicy)throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(config.rtcpMuxPolicy||(config.rtcpMuxPolicy="require"),config.iceTransportPolicy){case"all":case"relay":break;default:config.iceTransportPolicy="all"}switch(config.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:config.bundlePolicy="balanced"}if(config.iceServers=function(iceServers,edgeVersion){var hasTurn=!1;return(iceServers=JSON.parse(JSON.stringify(iceServers))).filter((function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;server.url&&!server.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var isString="string"==typeof urls;return isString&&(urls=[urls]),urls=urls.filter((function(url){return 0===url.indexOf("turn:")&&-1!==url.indexOf("transport=udp")&&-1===url.indexOf("turn:[")&&!hasTurn?(hasTurn=!0,!0):0===url.indexOf("stun:")&&edgeVersion>=14393&&-1===url.indexOf("?transport=udp")})),delete server.url,server.urls=isString?urls[0]:urls,!!urls.length}}))}(config.iceServers||[],edgeVersion),this._iceGatherers=[],config.iceCandidatePoolSize)for(var i=config.iceCandidatePoolSize;i>0;i--)this._iceGatherers.push(new window.RTCIceGatherer({iceServers:config.iceServers,gatherPolicy:config.iceTransportPolicy}));else config.iceCandidatePoolSize=0;this._config=config,this.transceivers=[],this._sdpSessionId=SDPUtils.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(RTCPeerConnection.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(RTCPeerConnection.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),RTCPeerConnection.prototype.onicecandidate=null,RTCPeerConnection.prototype.onaddstream=null,RTCPeerConnection.prototype.ontrack=null,RTCPeerConnection.prototype.onremovestream=null,RTCPeerConnection.prototype.onsignalingstatechange=null,RTCPeerConnection.prototype.oniceconnectionstatechange=null,RTCPeerConnection.prototype.onconnectionstatechange=null,RTCPeerConnection.prototype.onicegatheringstatechange=null,RTCPeerConnection.prototype.onnegotiationneeded=null,RTCPeerConnection.prototype.ondatachannel=null,RTCPeerConnection.prototype._dispatchEvent=function(name,event){this._isClosed||(this.dispatchEvent(event),"function"==typeof this["on"+name]&&this["on"+name](event))},RTCPeerConnection.prototype._emitGatheringStateChange=function(){var event=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",event)},RTCPeerConnection.prototype.getConfiguration=function(){return this._config},RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},RTCPeerConnection.prototype._createTransceiver=function(kind,doNotAdd){var hasBundleTransport=this.transceivers.length>0,transceiver={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:kind,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&hasBundleTransport)transceiver.iceTransport=this.transceivers[0].iceTransport,transceiver.dtlsTransport=this.transceivers[0].dtlsTransport;else{var transports=this._createIceAndDtlsTransports();transceiver.iceTransport=transports.iceTransport,transceiver.dtlsTransport=transports.dtlsTransport}return doNotAdd||this.transceivers.push(transceiver),transceiver},RTCPeerConnection.prototype.addTrack=function(track,stream){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var transceiver;if(this.transceivers.find((function(s){return s.track===track})))throw makeError("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==track.kind||(transceiver=this.transceivers[i]);return transceiver||(transceiver=this._createTransceiver(track.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(stream)&&this.localStreams.push(stream),transceiver.track=track,transceiver.stream=stream,transceiver.rtpSender=new window.RTCRtpSender(track,transceiver.dtlsTransport),transceiver.rtpSender},RTCPeerConnection.prototype.addStream=function(stream){var pc=this;if(edgeVersion>=15025)stream.getTracks().forEach((function(track){pc.addTrack(track,stream)}));else{var clonedStream=stream.clone();stream.getTracks().forEach((function(track,idx){var clonedTrack=clonedStream.getTracks()[idx];track.addEventListener("enabled",(function(event){clonedTrack.enabled=event.enabled}))})),clonedStream.getTracks().forEach((function(track){pc.addTrack(track,clonedStream)}))}},RTCPeerConnection.prototype.removeTrack=function(sender){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(sender instanceof window.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var transceiver=this.transceivers.find((function(t){return t.rtpSender===sender}));if(!transceiver)throw makeError("InvalidAccessError","Sender was not created by this connection.");var stream=transceiver.stream;transceiver.rtpSender.stop(),transceiver.rtpSender=null,transceiver.track=null,transceiver.stream=null,-1===this.transceivers.map((function(t){return t.stream})).indexOf(stream)&&this.localStreams.indexOf(stream)>-1&&this.localStreams.splice(this.localStreams.indexOf(stream),1),this._maybeFireNegotiationNeeded()},RTCPeerConnection.prototype.removeStream=function(stream){var pc=this;stream.getTracks().forEach((function(track){var sender=pc.getSenders().find((function(s){return s.track===track}));sender&&pc.removeTrack(sender)}))},RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter((function(transceiver){return!!transceiver.rtpSender})).map((function(transceiver){return transceiver.rtpSender}))},RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter((function(transceiver){return!!transceiver.rtpReceiver})).map((function(transceiver){return transceiver.rtpReceiver}))},RTCPeerConnection.prototype._createIceGatherer=function(sdpMLineIndex,usingBundle){var pc=this;if(usingBundle&&sdpMLineIndex>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var iceGatherer=new window.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(iceGatherer,"state",{value:"new",writable:!0}),this.transceivers[sdpMLineIndex].bufferedCandidateEvents=[],this.transceivers[sdpMLineIndex].bufferCandidates=function(event){var end=!event.candidate||0===Object.keys(event.candidate).length;iceGatherer.state=end?"completed":"gathering",null!==pc.transceivers[sdpMLineIndex].bufferedCandidateEvents&&pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event)},iceGatherer.addEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates),iceGatherer},RTCPeerConnection.prototype._gather=function(mid,sdpMLineIndex){var pc=this,iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(!iceGatherer.onlocalcandidate){var bufferedCandidateEvents=this.transceivers[sdpMLineIndex].bufferedCandidateEvents;this.transceivers[sdpMLineIndex].bufferedCandidateEvents=null,iceGatherer.removeEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates),iceGatherer.onlocalcandidate=function(evt){if(!(pc.usingBundle&&sdpMLineIndex>0)){var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate,end=!cand||0===Object.keys(cand).length;if(end)"new"!==iceGatherer.state&&"gathering"!==iceGatherer.state||(iceGatherer.state="completed");else{"new"===iceGatherer.state&&(iceGatherer.state="gathering"),cand.component=1,cand.ufrag=iceGatherer.getLocalParameters().usernameFragment;var serializedCandidate=SDPUtils.writeCandidate(cand);event.candidate=Object.assign(event.candidate,SDPUtils.parseCandidate(serializedCandidate)),event.candidate.candidate=serializedCandidate,event.candidate.toJSON=function(){return{candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex,usernameFragment:event.candidate.usernameFragment}}}var sections=SDPUtils.getMediaSections(pc._localDescription.sdp);sections[event.candidate.sdpMLineIndex]+=end?"a=end-of-candidates\r\n":"a="+event.candidate.candidate+"\r\n",pc._localDescription.sdp=SDPUtils.getDescription(pc._localDescription.sdp)+sections.join("");var complete=pc.transceivers.every((function(transceiver){return transceiver.iceGatherer&&"completed"===transceiver.iceGatherer.state}));"gathering"!==pc.iceGatheringState&&(pc.iceGatheringState="gathering",pc._emitGatheringStateChange()),end||pc._dispatchEvent("icecandidate",event),complete&&(pc._dispatchEvent("icecandidate",new Event("icecandidate")),pc.iceGatheringState="complete",pc._emitGatheringStateChange())}},window.setTimeout((function(){bufferedCandidateEvents.forEach((function(e){iceGatherer.onlocalcandidate(e)}))}),0)}},RTCPeerConnection.prototype._createIceAndDtlsTransports=function(){var pc=this,iceTransport=new window.RTCIceTransport(null);iceTransport.onicestatechange=function(){pc._updateIceConnectionState(),pc._updateConnectionState()};var dtlsTransport=new window.RTCDtlsTransport(iceTransport);return dtlsTransport.ondtlsstatechange=function(){pc._updateConnectionState()},dtlsTransport.onerror=function(){Object.defineProperty(dtlsTransport,"state",{value:"failed",writable:!0}),pc._updateConnectionState()},{iceTransport:iceTransport,dtlsTransport:dtlsTransport}},RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(sdpMLineIndex){var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;iceGatherer&&(delete iceGatherer.onlocalcandidate,delete this.transceivers[sdpMLineIndex].iceGatherer);var iceTransport=this.transceivers[sdpMLineIndex].iceTransport;iceTransport&&(delete iceTransport.onicestatechange,delete this.transceivers[sdpMLineIndex].iceTransport);var dtlsTransport=this.transceivers[sdpMLineIndex].dtlsTransport;dtlsTransport&&(delete dtlsTransport.ondtlsstatechange,delete dtlsTransport.onerror,delete this.transceivers[sdpMLineIndex].dtlsTransport)},RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);send&&transceiver.rtpSender&&(params.encodings=transceiver.sendEncodingParameters,params.rtcp={cname:SDPUtils.localCName,compound:transceiver.rtcpParameters.compound},transceiver.recvEncodingParameters.length&&(params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc),transceiver.rtpSender.send(params)),recv&&transceiver.rtpReceiver&&params.codecs.length>0&&("video"===transceiver.kind&&transceiver.recvEncodingParameters&&edgeVersion<15019&&transceiver.recvEncodingParameters.forEach((function(p){delete p.rtx})),transceiver.recvEncodingParameters.length?params.encodings=transceiver.recvEncodingParameters:params.encodings=[{}],params.rtcp={compound:transceiver.rtcpParameters.compound},transceiver.rtcpParameters.cname&&(params.rtcp.cname=transceiver.rtcpParameters.cname),transceiver.sendEncodingParameters.length&&(params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc),transceiver.rtpReceiver.receive(params))},RTCPeerConnection.prototype.setLocalDescription=function(description){var sections,sessionpart,pc=this;if(-1===["offer","answer"].indexOf(description.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'));if(!isActionAllowedInSignalingState("setLocalDescription",description.type,pc.signalingState)||pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set local "+description.type+" in state "+pc.signalingState));if("offer"===description.type)sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift(),sections.forEach((function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);pc.transceivers[sdpMLineIndex].localCapabilities=caps})),pc.transceivers.forEach((function(transceiver,sdpMLineIndex){pc._gather(transceiver.mid,sdpMLineIndex)}));else if("answer"===description.type){sections=SDPUtils.splitSections(pc._remoteDescription.sdp),sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach((function(mediaSection,sdpMLineIndex){var transceiver=pc.transceivers[sdpMLineIndex],iceGatherer=transceiver.iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,localCapabilities=transceiver.localCapabilities,remoteCapabilities=transceiver.remoteCapabilities;if(!(SDPUtils.isRejected(mediaSection)&&0===SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length)&&!transceiver.rejected){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart),remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);isIceLite&&(remoteDtlsParameters.role="server"),pc.usingBundle&&0!==sdpMLineIndex||(pc._gather(transceiver.mid,sdpMLineIndex),"new"===iceTransport.state&&iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled"),"new"===dtlsTransport.state&&dtlsTransport.start(remoteDtlsParameters));var params=getCommonCapabilities(localCapabilities,remoteCapabilities);pc._transceive(transceiver,params.codecs.length>0,!1)}}))}return pc._localDescription={type:description.type,sdp:description.sdp},"offer"===description.type?pc._updateSignalingState("have-local-offer"):pc._updateSignalingState("stable"),Promise.resolve()},RTCPeerConnection.prototype.setRemoteDescription=function(description){var pc=this;if(-1===["offer","answer"].indexOf(description.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'));if(!isActionAllowedInSignalingState("setRemoteDescription",description.type,pc.signalingState)||pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set remote "+description.type+" in state "+pc.signalingState));var streams={};pc.remoteStreams.forEach((function(stream){streams[stream.id]=stream}));var receiverList=[],sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift(),isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0,usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;pc.usingBundle=usingBundle;var iceOptions=SDPUtils.matchPrefix(sessionpart,"a=ice-options:")[0];return pc.canTrickleIceCandidates=!!iceOptions&&iceOptions.substr(14).split(" ").indexOf("trickle")>=0,sections.forEach((function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection),kind=SDPUtils.getKind(mediaSection),rejected=SDPUtils.isRejected(mediaSection)&&0===SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length,protocol=lines[0].substr(2).split(" ")[2],direction=SDPUtils.getDirection(mediaSection,sessionpart),remoteMsid=SDPUtils.parseMsid(mediaSection),mid=SDPUtils.getMid(mediaSection)||SDPUtils.generateIdentifier();if(rejected||"application"===kind&&("DTLS/SCTP"===protocol||"UDP/DTLS/SCTP"===protocol))pc.transceivers[sdpMLineIndex]={mid:mid,kind:kind,protocol:protocol,rejected:!0};else{var transceiver,iceGatherer,iceTransport,dtlsTransport,rtpReceiver,sendEncodingParameters,recvEncodingParameters,localCapabilities,track;!rejected&&pc.transceivers[sdpMLineIndex]&&pc.transceivers[sdpMLineIndex].rejected&&(pc.transceivers[sdpMLineIndex]=pc._createTransceiver(kind,!0));var remoteIceParameters,remoteDtlsParameters,remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);rejected||(remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart),(remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart)).role="client"),recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var rtcpParameters=SDPUtils.parseRtcpParameters(mediaSection),isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates",sessionpart).length>0,cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map((function(cand){return SDPUtils.parseCandidate(cand)})).filter((function(cand){return 1===cand.component}));if(("offer"===description.type||"answer"===description.type)&&!rejected&&usingBundle&&sdpMLineIndex>0&&pc.transceivers[sdpMLineIndex]&&(pc._disposeIceAndDtlsTransports(sdpMLineIndex),pc.transceivers[sdpMLineIndex].iceGatherer=pc.transceivers[0].iceGatherer,pc.transceivers[sdpMLineIndex].iceTransport=pc.transceivers[0].iceTransport,pc.transceivers[sdpMLineIndex].dtlsTransport=pc.transceivers[0].dtlsTransport,pc.transceivers[sdpMLineIndex].rtpSender&&pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport),pc.transceivers[sdpMLineIndex].rtpReceiver&&pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport)),"offer"!==description.type||rejected){if("answer"===description.type&&!rejected){iceGatherer=(transceiver=pc.transceivers[sdpMLineIndex]).iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,rtpReceiver=transceiver.rtpReceiver,sendEncodingParameters=transceiver.sendEncodingParameters,localCapabilities=transceiver.localCapabilities,pc.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters,pc.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities,pc.transceivers[sdpMLineIndex].rtcpParameters=rtcpParameters,cands.length&&"new"===iceTransport.state&&(!isIceLite&&!isComplete||usingBundle&&0!==sdpMLineIndex?cands.forEach((function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})):iceTransport.setRemoteCandidates(cands)),usingBundle&&0!==sdpMLineIndex||("new"===iceTransport.state&&iceTransport.start(iceGatherer,remoteIceParameters,"controlling"),"new"===dtlsTransport.state&&dtlsTransport.start(remoteDtlsParameters)),!getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities).codecs.filter((function(c){return"rtx"===c.name.toLowerCase()})).length&&transceiver.sendEncodingParameters[0].rtx&&delete transceiver.sendEncodingParameters[0].rtx,pc._transceive(transceiver,"sendrecv"===direction||"recvonly"===direction,"sendrecv"===direction||"sendonly"===direction),!rtpReceiver||"sendrecv"!==direction&&"sendonly"!==direction?delete transceiver.rtpReceiver:(track=rtpReceiver.track,remoteMsid?(streams[remoteMsid.stream]||(streams[remoteMsid.stream]=new window.MediaStream),addTrackToStreamAndFireEvent(track,streams[remoteMsid.stream]),receiverList.push([track,rtpReceiver,streams[remoteMsid.stream]])):(streams.default||(streams.default=new window.MediaStream),addTrackToStreamAndFireEvent(track,streams.default),receiverList.push([track,rtpReceiver,streams.default])))}}else{(transceiver=pc.transceivers[sdpMLineIndex]||pc._createTransceiver(kind)).mid=mid,transceiver.iceGatherer||(transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,usingBundle)),cands.length&&"new"===transceiver.iceTransport.state&&(!isComplete||usingBundle&&0!==sdpMLineIndex?cands.forEach((function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})):transceiver.iceTransport.setRemoteCandidates(cands)),localCapabilities=window.RTCRtpReceiver.getCapabilities(kind),edgeVersion<15019&&(localCapabilities.codecs=localCapabilities.codecs.filter((function(codec){return"rtx"!==codec.name}))),sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:1001*(2*sdpMLineIndex+2)}];var stream,isNewTrack=!1;if("sendrecv"===direction||"sendonly"===direction){if(isNewTrack=!transceiver.rtpReceiver,rtpReceiver=transceiver.rtpReceiver||new window.RTCRtpReceiver(transceiver.dtlsTransport,kind),isNewTrack)track=rtpReceiver.track,remoteMsid&&"-"===remoteMsid.stream||(remoteMsid?(streams[remoteMsid.stream]||(streams[remoteMsid.stream]=new window.MediaStream,Object.defineProperty(streams[remoteMsid.stream],"id",{get:function(){return remoteMsid.stream}})),Object.defineProperty(track,"id",{get:function(){return remoteMsid.track}}),stream=streams[remoteMsid.stream]):(streams.default||(streams.default=new window.MediaStream),stream=streams.default)),stream&&(addTrackToStreamAndFireEvent(track,stream),transceiver.associatedRemoteMediaStreams.push(stream)),receiverList.push([track,rtpReceiver,stream])}else transceiver.rtpReceiver&&transceiver.rtpReceiver.track&&(transceiver.associatedRemoteMediaStreams.forEach((function(s){var nativeTrack=s.getTracks().find((function(t){return t.id===transceiver.rtpReceiver.track.id}));nativeTrack&&function(track,stream){stream.removeTrack(track),stream.dispatchEvent(new window.MediaStreamTrackEvent("removetrack",{track:track}))}(nativeTrack,s)})),transceiver.associatedRemoteMediaStreams=[]);transceiver.localCapabilities=localCapabilities,transceiver.remoteCapabilities=remoteCapabilities,transceiver.rtpReceiver=rtpReceiver,transceiver.rtcpParameters=rtcpParameters,transceiver.sendEncodingParameters=sendEncodingParameters,transceiver.recvEncodingParameters=recvEncodingParameters,pc._transceive(pc.transceivers[sdpMLineIndex],!1,isNewTrack)}}})),void 0===pc._dtlsRole&&(pc._dtlsRole="offer"===description.type?"active":"passive"),pc._remoteDescription={type:description.type,sdp:description.sdp},"offer"===description.type?pc._updateSignalingState("have-remote-offer"):pc._updateSignalingState("stable"),Object.keys(streams).forEach((function(sid){var stream=streams[sid];if(stream.getTracks().length){if(-1===pc.remoteStreams.indexOf(stream)){pc.remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream,window.setTimeout((function(){pc._dispatchEvent("addstream",event)}))}receiverList.forEach((function(item){var track=item[0],receiver=item[1];stream.id===item[2].id&&fireAddTrack(pc,track,receiver,[stream])}))}})),receiverList.forEach((function(item){item[2]||fireAddTrack(pc,item[0],item[1],[])})),window.setTimeout((function(){pc&&pc.transceivers&&pc.transceivers.forEach((function(transceiver){transceiver.iceTransport&&"new"===transceiver.iceTransport.state&&transceiver.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),transceiver.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},RTCPeerConnection.prototype.close=function(){this.transceivers.forEach((function(transceiver){transceiver.iceTransport&&transceiver.iceTransport.stop(),transceiver.dtlsTransport&&transceiver.dtlsTransport.stop(),transceiver.rtpSender&&transceiver.rtpSender.stop(),transceiver.rtpReceiver&&transceiver.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",event)},RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var pc=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,window.setTimeout((function(){if(pc.needNegotiation){pc.needNegotiation=!1;var event=new Event("negotiationneeded");pc._dispatchEvent("negotiationneeded",event)}}),0))},RTCPeerConnection.prototype._updateIceConnectionState=function(){var newState,states={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(transceiver){transceiver.iceTransport&&!transceiver.rejected&&states[transceiver.iceTransport.state]++})),newState="new",states.failed>0?newState="failed":states.checking>0?newState="checking":states.disconnected>0?newState="disconnected":states.new>0?newState="new":states.connected>0?newState="connected":states.completed>0&&(newState="completed"),newState!==this.iceConnectionState){this.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",event)}},RTCPeerConnection.prototype._updateConnectionState=function(){var newState,states={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(transceiver){transceiver.iceTransport&&transceiver.dtlsTransport&&!transceiver.rejected&&(states[transceiver.iceTransport.state]++,states[transceiver.dtlsTransport.state]++)})),states.connected+=states.completed,newState="new",states.failed>0?newState="failed":states.connecting>0?newState="connecting":states.disconnected>0?newState="disconnected":states.new>0?newState="new":states.connected>0&&(newState="connected"),newState!==this.connectionState){this.connectionState=newState;var event=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",event)}},RTCPeerConnection.prototype.createOffer=function(){var pc=this;if(pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"));var numAudioTracks=pc.transceivers.filter((function(t){return"audio"===t.kind})).length,numVideoTracks=pc.transceivers.filter((function(t){return"video"===t.kind})).length,offerOptions=arguments[0];if(offerOptions){if(offerOptions.mandatory||offerOptions.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==offerOptions.offerToReceiveAudio&&(numAudioTracks=!0===offerOptions.offerToReceiveAudio?1:!1===offerOptions.offerToReceiveAudio?0:offerOptions.offerToReceiveAudio),void 0!==offerOptions.offerToReceiveVideo&&(numVideoTracks=!0===offerOptions.offerToReceiveVideo?1:!1===offerOptions.offerToReceiveVideo?0:offerOptions.offerToReceiveVideo)}for(pc.transceivers.forEach((function(transceiver){"audio"===transceiver.kind?--numAudioTracks<0&&(transceiver.wantReceive=!1):"video"===transceiver.kind&&--numVideoTracks<0&&(transceiver.wantReceive=!1)}));numAudioTracks>0||numVideoTracks>0;)numAudioTracks>0&&(pc._createTransceiver("audio"),numAudioTracks--),numVideoTracks>0&&(pc._createTransceiver("video"),numVideoTracks--);var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.transceivers.forEach((function(transceiver,sdpMLineIndex){var track=transceiver.track,kind=transceiver.kind,mid=transceiver.mid||SDPUtils.generateIdentifier();transceiver.mid=mid,transceiver.iceGatherer||(transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,pc.usingBundle));var localCapabilities=window.RTCRtpSender.getCapabilities(kind);edgeVersion<15019&&(localCapabilities.codecs=localCapabilities.codecs.filter((function(codec){return"rtx"!==codec.name}))),localCapabilities.codecs.forEach((function(codec){"H264"===codec.name&&void 0===codec.parameters["level-asymmetry-allowed"]&&(codec.parameters["level-asymmetry-allowed"]="1"),transceiver.remoteCapabilities&&transceiver.remoteCapabilities.codecs&&transceiver.remoteCapabilities.codecs.forEach((function(remoteCodec){codec.name.toLowerCase()===remoteCodec.name.toLowerCase()&&codec.clockRate===remoteCodec.clockRate&&(codec.preferredPayloadType=remoteCodec.payloadType)}))})),localCapabilities.headerExtensions.forEach((function(hdrExt){(transceiver.remoteCapabilities&&transceiver.remoteCapabilities.headerExtensions||[]).forEach((function(rHdrExt){hdrExt.uri===rHdrExt.uri&&(hdrExt.id=rHdrExt.id)}))}));var sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:1001*(2*sdpMLineIndex+1)}];track&&edgeVersion>=15019&&"video"===kind&&!sendEncodingParameters[0].rtx&&(sendEncodingParameters[0].rtx={ssrc:sendEncodingParameters[0].ssrc+1}),transceiver.wantReceive&&(transceiver.rtpReceiver=new window.RTCRtpReceiver(transceiver.dtlsTransport,kind)),transceiver.localCapabilities=localCapabilities,transceiver.sendEncodingParameters=sendEncodingParameters})),"max-compat"!==pc._config.bundlePolicy&&(sdp+="a=group:BUNDLE "+pc.transceivers.map((function(t){return t.mid})).join(" ")+"\r\n"),sdp+="a=ice-options:trickle\r\n",pc.transceivers.forEach((function(transceiver,sdpMLineIndex){sdp+=writeMediaSection(transceiver,transceiver.localCapabilities,"offer",transceiver.stream,pc._dtlsRole),sdp+="a=rtcp-rsize\r\n",!transceiver.iceGatherer||"new"===pc.iceGatheringState||0!==sdpMLineIndex&&pc.usingBundle||(transceiver.iceGatherer.getLocalCandidates().forEach((function(cand){cand.component=1,sdp+="a="+SDPUtils.writeCandidate(cand)+"\r\n"})),"completed"===transceiver.iceGatherer.state&&(sdp+="a=end-of-candidates\r\n"))}));var desc=new window.RTCSessionDescription({type:"offer",sdp:sdp});return Promise.resolve(desc)},RTCPeerConnection.prototype.createAnswer=function(){var pc=this;if(pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==pc.signalingState&&"have-local-pranswer"!==pc.signalingState)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer in signalingState "+pc.signalingState));var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.usingBundle&&(sdp+="a=group:BUNDLE "+pc.transceivers.map((function(t){return t.mid})).join(" ")+"\r\n"),sdp+="a=ice-options:trickle\r\n";var mediaSectionsInOffer=SDPUtils.getMediaSections(pc._remoteDescription.sdp).length;pc.transceivers.forEach((function(transceiver,sdpMLineIndex){if(!(sdpMLineIndex+1>mediaSectionsInOffer)){if(transceiver.rejected)return"application"===transceiver.kind?"DTLS/SCTP"===transceiver.protocol?sdp+="m=application 0 DTLS/SCTP 5000\r\n":sdp+="m=application 0 "+transceiver.protocol+" webrtc-datachannel\r\n":"audio"===transceiver.kind?sdp+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===transceiver.kind&&(sdp+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(sdp+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+transceiver.mid+"\r\n");var localTrack;if(transceiver.stream)"audio"===transceiver.kind?localTrack=transceiver.stream.getAudioTracks()[0]:"video"===transceiver.kind&&(localTrack=transceiver.stream.getVideoTracks()[0]),localTrack&&edgeVersion>=15019&&"video"===transceiver.kind&&!transceiver.sendEncodingParameters[0].rtx&&(transceiver.sendEncodingParameters[0].rtx={ssrc:transceiver.sendEncodingParameters[0].ssrc+1});var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);!commonCapabilities.codecs.filter((function(c){return"rtx"===c.name.toLowerCase()})).length&&transceiver.sendEncodingParameters[0].rtx&&delete transceiver.sendEncodingParameters[0].rtx,sdp+=writeMediaSection(transceiver,commonCapabilities,"answer",transceiver.stream,pc._dtlsRole),transceiver.rtcpParameters&&transceiver.rtcpParameters.reducedSize&&(sdp+="a=rtcp-rsize\r\n")}}));var desc=new window.RTCSessionDescription({type:"answer",sdp:sdp});return Promise.resolve(desc)},RTCPeerConnection.prototype.addIceCandidate=function(candidate){var sections,pc=this;return candidate&&void 0===candidate.sdpMLineIndex&&!candidate.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(resolve,reject){if(!pc._remoteDescription)return reject(makeError("InvalidStateError","Can not add ICE candidate without a remote description"));if(candidate&&""!==candidate.candidate){var sdpMLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid)for(var i=0;i<pc.transceivers.length;i++)if(pc.transceivers[i].mid===candidate.sdpMid){sdpMLineIndex=i;break}var transceiver=pc.transceivers[sdpMLineIndex];if(!transceiver)return reject(makeError("OperationError","Can not add ICE candidate"));if(transceiver.rejected)return resolve();var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if("tcp"===cand.protocol&&(0===cand.port||9===cand.port))return resolve();if(cand.component&&1!==cand.component)return resolve();if((0===sdpMLineIndex||sdpMLineIndex>0&&transceiver.iceTransport!==pc.transceivers[0].iceTransport)&&!maybeAddCandidate(transceiver.iceTransport,cand))return reject(makeError("OperationError","Can not add ICE candidate"));var candidateString=candidate.candidate.trim();0===candidateString.indexOf("a=")&&(candidateString=candidateString.substr(2)),(sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp))[sdpMLineIndex]+="a="+(cand.type?candidateString:"end-of-candidates")+"\r\n",pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join("")}else for(var j=0;j<pc.transceivers.length&&(pc.transceivers[j].rejected||(pc.transceivers[j].iceTransport.addRemoteCandidate({}),(sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp))[j]+="a=end-of-candidates\r\n",pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join(""),!pc.usingBundle));j++);resolve()}))},RTCPeerConnection.prototype.getStats=function(selector){if(selector&&selector instanceof window.MediaStreamTrack){var senderOrReceiver=null;if(this.transceivers.forEach((function(transceiver){transceiver.rtpSender&&transceiver.rtpSender.track===selector?senderOrReceiver=transceiver.rtpSender:transceiver.rtpReceiver&&transceiver.rtpReceiver.track===selector&&(senderOrReceiver=transceiver.rtpReceiver)})),!senderOrReceiver)throw makeError("InvalidAccessError","Invalid selector.");return senderOrReceiver.getStats()}var promises=[];return this.transceivers.forEach((function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(method){transceiver[method]&&promises.push(transceiver[method].getStats())}))})),Promise.all(promises).then((function(allStats){var results=new Map;return allStats.forEach((function(stats){stats.forEach((function(stat){results.set(stat.id,stat)}))})),results}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(ortcObjectName){var obj=window[ortcObjectName];if(obj&&obj.prototype&&obj.prototype.getStats){var nativeGetstats=obj.prototype.getStats;obj.prototype.getStats=function(){return nativeGetstats.apply(this).then((function(nativeStats){var mapStats=new Map;return Object.keys(nativeStats).forEach((function(id){var stat;nativeStats[id].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(stat=nativeStats[id]).type]||stat.type,mapStats.set(id,nativeStats[id])})),mapStats}))}}}));var methods=["createOffer","createAnswer"];return methods.forEach((function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;return"function"==typeof args[0]||"function"==typeof args[1]?nativeMethod.apply(this,[arguments[2]]).then((function(description){"function"==typeof args[0]&&args[0].apply(null,[description])}),(function(error){"function"==typeof args[1]&&args[1].apply(null,[error])})):nativeMethod.apply(this,arguments)}})),(methods=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;return"function"==typeof args[1]||"function"==typeof args[2]?nativeMethod.apply(this,arguments).then((function(){"function"==typeof args[1]&&args[1].apply(null)}),(function(error){"function"==typeof args[2]&&args[2].apply(null,[error])})):nativeMethod.apply(this,arguments)}})),["getStats"].forEach((function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;return"function"==typeof args[1]?nativeMethod.apply(this,arguments).then((function(){"function"==typeof args[1]&&args[1].apply(null)})):nativeMethod.apply(this,arguments)}})),RTCPeerConnection}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConnectionService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),main_service_1=__webpack_require__(26),settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),event_service_1=__webpack_require__(32),xmpp_service_1=__webpack_require__(4),contact_service_1=__webpack_require__(1),fileStorage_service_1=__webpack_require__(25),invitation_service_1=__webpack_require__(233),profile_service_1=__webpack_require__(8),room_service_1=__webpack_require__(33),sdkConfig_1=__webpack_require__(38),sdkConstant_1=__webpack_require__(28),_botService=new WeakMap,_fileServerService=new WeakMap,_groupService=new WeakMap,_videoService=new WeakMap,_favoriteService=new WeakMap,_webrtcServiceEventHandler=new WeakMap,_telephonyService=new WeakMap,_conferenceService=new WeakMap,_webConferenceService=new WeakMap,_conversationService=new WeakMap,_platformService=new WeakMap,_adminCompanyService=new WeakMap,_companyDirectoryService=new WeakMap,_adminUserService=new WeakMap,_channelService=new WeakMap,_webrtcGatewayService=new WeakMap,_recordsService=new WeakMap,_voiceMessageService=new WeakMap;exports.ConnectionService=class{constructor($rootScope,botService,fileServerService,groupService,videoService,favoriteService,webrtcServiceEventHandler,telephonyService,conferenceService,webConferenceService,conversationService,platformService,adminCompanyService,companyDirectoryService,adminUserService,channelService,webrtcGatewayService,recordsService,voiceMessageService){this.logService="ConnectionService | ",this.state="disconnected",this.hostUsed="",this.RAINBOW_ONCONNECTIONSTATECHANGED="rainbowconnectionstatechanged",this.RAINBOW_ONSTARTED="started",this.RAINBOW_ONSIGNED="signed",this.RAINBOW_ONSTOPPED="stopped",this.RAINBOW_CONNECTIONINPROGRESS="inProgress",this.RAINBOW_ONUSERTOKENRENEW="userTokenRenew",this.RAINBOW_ONUSERTOKENRENEWFAILED="userTokenRenewFailed",this.RAINBOW_ONUSERTOKENWILLEXPIRE="userTokenWillExpire",this.RAINBOW_ONAPPTOKENRENEW="applicationTokenRenew",this.RAINBOW_ONAPPTOKENRENEWFAILED="applicationTokenRenewFailed",this.RAINBOW_CONNECTIONCONNECTED="connected",this.RAINBOW_CONNECTIONDISCONNECTED="disconnected",this.RAINBOW_OFFICIAL_HOST="openrainbow.com",this.RAINBOW_BETA_HOST="openrainbow.net",this.RAINBOW_DEV_HOST="openrainbow.org",this.RAINBOW_SANDBOX_HOST="sandbox.openrainbow.com",this.RAINBOW_CPAASPREPROD_HOST="cpaaspreprod.openrainbow.net",this.RAINBOW_CHINA_HOST="myopenrainbow.com.cn",this.RAINBOW_CHINASANDBOX_HOST="sandbox.myopenrainbow.com.cn",event_service_1.default.configure($rootScope),main_service_1.default.configure(),settings_service_1.default.configure("en"),settings_service_1.default.setSetting("apiMode","sdk"),_botService.set(this,botService),_fileServerService.set(this,fileServerService),_groupService.set(this,groupService),_videoService.set(this,videoService),_favoriteService.set(this,favoriteService),_webrtcServiceEventHandler.set(this,webrtcServiceEventHandler),_telephonyService.set(this,telephonyService),_conferenceService.set(this,conferenceService),_webConferenceService.set(this,webConferenceService),_conversationService.set(this,conversationService),_platformService.set(this,platformService),_adminCompanyService.set(this,adminCompanyService),_companyDirectoryService.set(this,companyDirectoryService),_adminUserService.set(this,adminUserService),_channelService.set(this,channelService),_webrtcGatewayService.set(this,webrtcGatewayService),_recordsService.set(this,recordsService),_voiceMessageService.set(this,voiceMessageService),xmpp_service_1.default.subscribeToConnectionEvents(event=>{let status="connected";"ON_XMPP_CONNECTING"===event.name&&(status="inProgress"),"ON_XMPP_DISCONNECTED"===event.name&&(status="LOGOUT"===event.data.reason?"unlogged":"disconnected"),"ON_XMPP_CONNECTED"===event.name&&(status="connected","RECONNECTION"===event.data.reason&&(EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONNECTIONSTATECHANGED,"reconnecting"),this.reconnectServices())),this.state=status,RainbowLogger_1.rainbowLogger.sdk(this.logService+"[onChange] :: Connection state changed to "+status),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONNECTIONSTATECHANGED,status)}),auth_service_1.default.subscribe(event=>{try{switch(event.name){case"ON_AUTH_TOKEN_RENEW":EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONUSERTOKENRENEW);break;case"ON_AUTH_TOKEN_EXPIRE":this.signout().then(()=>{EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONUSERTOKENRENEWFAILED)});break;case"ON_AUTH_TOKEN_WILL_EXPIRE":EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONUSERTOKENWILLEXPIRE);break;case"ON_APP_TOKEN_RENEW":EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONAPPTOKENRENEW);break;case"ON_APP_TOKEN_EXPIRE":EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONAPPTOKENRENEWFAILED)}}catch(error){RainbowLogger_1.rainbowLogger.error(this.logService+" failure "+error.message)}}),window.addEventListener("beforeunload",(function(){videoService.stop(),contact_service_1.default.stop(),conversationService.stop(),groupService.stop(),telephonyService.stop(),fileServerService.stop(),fileStorage_service_1.default.stop(),xmpp_service_1.default.stop(),profile_service_1.default.stop(),recordsService.stop(),channelService.stop(),webrtcGatewayService.stop()}))}static get $inject(){return["$rootScope","botService","fileServerService","groupService","videoService","favoriteService","webrtcServiceEventHandler","telephonyService","conferenceService","webConferenceService","conversationService","platformService","adminCompanyService","companyDirectoryService","adminUserService","channelService","webrtcGatewayService","recordsService","voiceMessageService"]}signin(strLogin,strPassword){return this.hostUsed=this.RAINBOW_SANDBOX_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowOfficial(strLogin,strPassword){return this.hostUsed=this.RAINBOW_OFFICIAL_HOST,window.config.webservices.currentServer=this.RAINBOW_OFFICIAL_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowBeta(strLogin,strPassword){return this.hostUsed=this.RAINBOW_BETA_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowCPaasPreProd(strLogin,strPassword){return this.hostUsed=this.RAINBOW_CPAASPREPROD_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowDev(strLogin,strPassword){return this.hostUsed=this.RAINBOW_DEV_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowSandboxChina(strLogin,strPassword){return this.hostUsed=this.RAINBOW_CHINASANDBOX_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowChina(strLogin,strPassword){return this.hostUsed=this.RAINBOW_CHINA_HOST,this.signinToRainbow(strLogin,strPassword,null)}signinOnRainbowHosted(strLogin,strPassword,strHost){return this.hostUsed=strHost,this.signinToRainbow(strLogin,strPassword,null)}signinSandBoxWithToken(strToken){return this.hostUsed=this.RAINBOW_SANDBOX_HOST,this.signinToRainbow(null,null,strToken)}signinOnRainbowOfficialWithToken(strToken){return this.hostUsed=this.RAINBOW_OFFICIAL_HOST,window.config.webservices.currentServer=this.RAINBOW_OFFICIAL_HOST,this.signinToRainbow(null,null,strToken)}signinOnRainbowBetaWithToken(strToken){return this.hostUsed=this.RAINBOW_BETA_HOST,this.signinToRainbow(null,null,strToken)}signinOnRainbowDevWithToken(strToken){return this.hostUsed=this.RAINBOW_DEV_HOST,this.signinToRainbow(null,null,strToken)}signinOnRainbowHostedWithToken(strToken,strHost){return this.hostUsed=strHost,this.signinToRainbow(null,null,strToken)}setRenewedToken(strToken){strToken||RainbowLogger_1.rainbowLogger.error(this.logService+"[setRenewedToken] Argument 'strToken' is missing or empty"),auth_service_1.default.sdkSetRenewedToken(strToken)}signinOnRainbowWithOICD(strToken){let challenge="";const characters="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",charactersLength=characters.length;for(let i=0;i<30;i++)challenge+=characters.charAt(Math.floor(Math.random()*charactersLength));const url=`https://openrainbow.com/api/rainbow/authentication/v1.0/oidc-client/jwt?id_token=${strToken}&challenge=${challenge}`;return new Promise((resolve,reject)=>{if(!strToken)return RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signinOnRainbowWithOICD] :: Argument strToken is null or undefined"),reject("Argument strToken is null or undefined");let headersXrainbowAppAuth=window.btoa(unescape(encodeURIComponent(window.sdk.key.appID+":"+window.SHA256(window.sdk.key.appSecret+challenge))));headersXrainbowAppAuth="Basic "+headersXrainbowAppAuth;const sdkHeaders=new Headers({"Content-Type":"application/x-www-form-urlencoded","X-Rainbow-App-Auth":headersXrainbowAppAuth,Accept:"application/json"});fetch(url,{method:"get",mode:"cors",headers:sdkHeaders}).then(response=>{response.json().then(data=>{this.signinOnRainbowBetaWithToken(data.token).then(account=>resolve(account)).catch(err=>reject(err))})}).catch(err=>reject(err))})}styleSignInWithRainbowButton(color,size){const el=document.querySelector(".SignInWithRainbow");if(!el)return RainbowLogger_1.rainbowLogger.sdk(this.logService+"[styleSignInWithRainbowButton] :: Could not find a corresponding HTML element"),!1;let width,height,backgroundSize,fontSize,backgroundColor,textColor;return size||(size="medium"),color||(color="blue"),"blue"===color?(backgroundColor="#1b85e0",textColor="#FFFFFF"):"white"===color&&(backgroundColor="#FFFFFF",textColor="#1b85e0"),"small"===size?(width="200px",height="20px",backgroundSize="18px",fontSize="12px"):"medium"===size?(width="250px",height="30px",backgroundSize="26px",fontSize="16px"):"large"===size&&(width="350px",height="40px",backgroundSize="34px",fontSize="22px"),el.style.backgroundColor=backgroundColor,el.style.color=textColor,el.style.width=width,el.style.height=height,el.style.fontSize=fontSize,el.style.border="0px",el.style.borderRadius="5px",el.innerHTML="Sign in with Rainbow",el.style.backgroundImage="url('https://hub.openrainbow.com/android-chrome-48x48.png')",el.style.backgroundPosition="left",el.style.backgroundRepeat="no-repeat",el.style.verticalAlign="middle",el.style.backgroundSize=backgroundSize,el.style.backgroundOrigin="content-box",el.style.paddingLeft="13px",RainbowLogger_1.rainbowLogger.sdk(this.logService+"[styleSignInWithRainbowButton] :: Styled a corresponding HTML element"),!0}signout(){const videoService=_videoService.get(this),favoriteService=_favoriteService.get(this),webrtcServiceEventHandler=_webrtcServiceEventHandler.get(this),botService=_botService.get(this),conversationService=_conversationService.get(this),conferenceService=_conferenceService.get(this),webConferenceService=_webConferenceService.get(this),channelService=_channelService.get(this),telephonyService=_telephonyService.get(this),fileServerService=_fileServerService.get(this),groupService=_groupService.get(this),adminCompanyService=_adminCompanyService.get(this),companyDirectoryService=_companyDirectoryService.get(this),adminUserService=_adminUserService.get(this),webrtcGatewayService=_webrtcGatewayService.get(this),recordsService=_recordsService.get(this),voiceMessageService=_voiceMessageService.get(this),result={code:sdkConstant_1.SDK.OK,label:"OK"};return RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Trying to sign out"),new Promise((resolve,reject)=>{videoService.stop().then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Video service stopped"),favoriteService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Favorite service stopped"),voiceMessageService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: VoiceMessage service stopped"),webrtcServiceEventHandler.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: WebRTCEventHandler service stopped"),contact_service_1.default.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Contact service stopped"),botService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Bot service stopped"),profile_service_1.default.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Profile service stopped"),conversationService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Conversation service stopped"),conferenceService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Conference service stopped"),webConferenceService.stop())).then(()=>{RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: PTSN Conference service stopped")}).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: ChannelService service stopped"),channelService.stop())).then(()=>telephonyService.stop()).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Telephony service stopped"),fileServerService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: FileServer service stopped"),fileStorage_service_1.default.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: FileStorage service stopped"),invitation_service_1.default.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Invitation service stopped"),groupService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Group service stopped"),room_service_1.default.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Room service stopped"),adminCompanyService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Company Directory service stopped"),companyDirectoryService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Admin User service stopped"),adminUserService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Invitation service stopped"),webrtcGatewayService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: webrtcGateway service stopped"),xmpp_service_1.default.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Records service stopped"),recordsService.stop())).then(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: XMPP service stopped"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: Services Successfully unloaded!"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONSTOPPED,null),resolve(result))).catch(error=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signout] :: An error occured during signout"),reject(error)))})}updateUserPassword(oldPassword,newPassword){return contact_service_1.default.updateUserPassword(oldPassword,newPassword,!1)}getState(){return this.state}getToken(){return auth_service_1.default.token}refreshToken(){return __awaiter(this,void 0,void 0,(function*(){try{return void(yield auth_service_1.default.renewAuthToken(!1))}catch(err){throw err}}))}signinToRainbow(login,password,token){const videoService=_videoService.get(this),webrtcServiceEventHandler=_webrtcServiceEventHandler.get(this),botService=_botService.get(this),conversationService=_conversationService.get(this),conferenceService=_conferenceService.get(this),webConferenceService=_webConferenceService.get(this),channelService=_channelService.get(this),telephonyService=_telephonyService.get(this),fileServerService=_fileServerService.get(this),groupService=_groupService.get(this),adminCompanyService=_adminCompanyService.get(this),companyDirectoryService=_companyDirectoryService.get(this),adminUserService=_adminUserService.get(this),webrtcGatewayService=_webrtcGatewayService.get(this),recordsService=_recordsService.get(this),platformService=_platformService.get(this),favoriteService=_favoriteService.get(this),voiceMessageService=_voiceMessageService.get(this);RainbowLogger_1.rainbowLogger.time("Auth");let withToken=!1;return new Promise((resolve,reject)=>{if(token)withToken=!0,login=null,password=null;else{if(!login)return reject({code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'login' is missing or empty"});if(!password)return reject({code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'password' is missing or empty"})}RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Rainbow host used "+this.hostUsed),withToken?RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Trying to sign-in with given token"):RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Tryng to sign-in");const result={code:sdkConstant_1.SDK.OK,label:"",account:null},appToken={appID:window.sdk.key.appID,appSecret:window.sdk.key.appSecret};auth_service_1.default.removeCredentials(),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - sdkLogOn"),auth_service_1.default.sdkLogOn(login,password,this.hostUsed,appToken,token).then(()=>{RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - sdkLogOn"),result.account={},result.label="ok",result.account.userId=auth_service_1.default.userId,result.account.companyId=auth_service_1.default.companyId,result.account.loginEmail=auth_service_1.default.login,result.account.roles=auth_service_1.default.loggedInUser.roles,result.token=auth_service_1.default.token,result.userData=auth_service_1.default.loggedInUser;const stats=[];RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Successfully sign-in with  | "+auth_service_1.default.jidIm),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONSIGNED,result),auth_service_1.default.startTokenSurvey(),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Start services..."),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - XMPPService"),xmpp_service_1.default.start().then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - companyService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Company service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - adminCompanyService"),adminCompanyService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - adminCompanyService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Admin company service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - companyDirectoryService"),companyDirectoryService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - companyDirectoryService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Company Directory Service company service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - adminUserService"),adminUserService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - adminUserService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Admin user service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - contactService"),contact_service_1.default.start())).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - contactService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Contact service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - profileService"),sdkConfig_1.sdkConfig.features.profileService)return profile_service_1.default.start()}).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - profileService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Profile service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - invitationService"),invitation_service_1.default.start())).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - invitationService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Invitation service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - fileServerService"),fileServerService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - fileServerService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: FileServer service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - fileStorageService"),fileStorage_service_1.default.start())).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - fileStorageService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: FileStorage service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - roomService"),sdkConfig_1.sdkConfig.features.roomService)return room_service_1.default.start()}).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - roomService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Room service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - groupService"),groupService.start(stats))).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - groupService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Group service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - favoriteService"),sdkConfig_1.sdkConfig.features.favoriteService)return favoriteService.start(stats)}).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - favoriteService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Favorite service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - voiceMessageService"),voiceMessageService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - voiceMessageService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Voice Message Service service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - webrtcGatewayService"),webrtcGatewayService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - webrtcGatewayService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: WebrtcGateway service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - videoService"),!0===sdkConfig_1.sdkConfig.unifiedPlan&&(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[videoService] :: Unified plan activated"),videoService.config||(videoService.config={}),videoService.config.unifiedPlan=!0),videoService.start(stats))).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - videoService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Video service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - webrtcServiceEventHandler"),webrtcServiceEventHandler.start(stats))).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - webrtcServiceEventHandler"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: WebRTCEventHandler service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - telephonyService"),sdkConfig_1.sdkConfig.features.telephony)return telephonyService.start(stats)}).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - telephonyService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Telephony service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - webConferenceService"),webConferenceService.start(stats))).then(()=>{if(webConferenceService.setActiveSpeakerValue(!1),RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - webConferenceService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Web Conference service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - conversationService"),sdkConfig_1.sdkConfig.features.conversationService)return conversationService.start(stats)}).then(()=>{RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - conversationService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Conversation service ready!"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Send initial presence"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - sendPresenceFromConfiguration"),contact_service_1.default.sendPresenceFromConfiguration()}).then(()=>{RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - sendPresenceFromConfiguration"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Initial presence sent !")}).then(()=>(RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - platformService"),platformService.start(stats))).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - platformService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Platform service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - botService"),sdkConfig_1.sdkConfig.features.bots)return botService.start(stats)}).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - botService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Bot service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - conferenceService"),sdkConfig_1.sdkConfig.features.conference)return conferenceService.start(stats)}).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - conferenceService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Conference service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - recordsService"),recordsService.start(stats))).then(()=>{if(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - recordsService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Records service ready!"),RainbowLogger_1.rainbowLogger.time("RainbowSDK Performance - channelService"),sdkConfig_1.sdkConfig.features.channels)return channelService.start(stats)}).then(()=>(RainbowLogger_1.rainbowLogger.timeEnd("RainbowSDK Performance - channelService"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Channel service ready!"),RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Services Successfully loaded!"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONSTARTED,result),RainbowLogger_1.rainbowLogger.timeEnd("Auth"),resolve(result))).catch(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Error during signin"),result.code=sdkConstant_1.SDK.ERRORXMPP,result.label="errorXMPP",result.account=null,reject(result)))}).catch(()=>(RainbowLogger_1.rainbowLogger.sdk(this.logService+"[signin] :: Error during signin"),result.code=sdkConstant_1.SDK.ERRORUNAUTHORIZED,result.label="errorUnauthorized",reject(result)))})}reconnectServices(){return __awaiter(this,void 0,void 0,(function*(){const videoService=_videoService.get(this),webrtcServiceEventHandler=_webrtcServiceEventHandler.get(this),conversationService=_conversationService.get(this),conferenceService=_conferenceService.get(this),channelService=_channelService.get(this),telephonyService=_telephonyService.get(this),fileServerService=_fileServerService.get(this),groupService=_groupService.get(this),favoriteService=_favoriteService.get(this),voiceMessageService=_voiceMessageService.get(this);try{videoService.attachHandlers(),webrtcServiceEventHandler.attachHandlers(),conversationService.attachHandlers(),conferenceService.reconnectService(),channelService.reconnect(),telephonyService.reconnect(),fileServerService.attachHandlers(),groupService.attachHandlers(),room_service_1.default.reconnect(),favoriteService.connect(),voiceMessageService.attachHandlers(),contact_service_1.default.updateUserContactFullJid(),invitation_service_1.default.attachHandlers(),profile_service_1.default.restart(),yield fileStorage_service_1.default.reinit(!1),yield conversationService.reinit(),yield contact_service_1.default.sendPresenceFromConfiguration(!0)}catch(error){RainbowLogger_1.rainbowLogger.error("[serviceLauncher] reconnectServices failure "+error.message)}}))}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PresenceService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),contact_service_1=__webpack_require__(1),xmpp_service_1=__webpack_require__(4),sdkConstant_1=__webpack_require__(28),_$rootScope=new WeakMap;class PresenceService{constructor($rootScope){this.RAINBOW_PRESENCE_ONLINE="online",this.RAINBOW_PRESENCE_AWAY="away",this.RAINBOW_PRESENCE_DONOTDISTURB="dnd",this.RAINBOW_PRESENCE_OFFLINE="xa",this.RAINBOW_PRESENCE_BUSY="busy",this.RAINBOW_PRESENCE_UNKNOW="unknow",this.RAINBOW_ONCONTACTPRESENCECHANGED="rainbowcontactpresencechanged",this.RAINBOW_ONPRESENCECHANGED="rainbowpresencechanged",this.RAINBOW_ONCONTACTRICHPRESENCECHANGED="rainbowcontactrichpresencechanged",this.RAINBOW_ONRICHPRESENCECHANGED="rainbowrichpresencechanged",_$rootScope.set(this,$rootScope),xmpp_service_1.default.subscribeToContactEvents(event=>{"ON_CONTACT_PRESENCE_EVENT"===event.name&&this.onPresenceChangedEvent(event.name,event.data)}),$rootScope.$on("$destroy",$rootScope.$on("ON_UPDATE_CONTACT_RICH_STATUS_EVENT",(event,contact)=>this.onRichPresenceChangedEvent(event,contact)))}static get $inject(){return["$rootScope"]}setPresenceTo(strPresenceState){if(strPresenceState!==this.RAINBOW_PRESENCE_DONOTDISTURB&&strPresenceState!==this.RAINBOW_PRESENCE_AWAY&&strPresenceState!==this.RAINBOW_PRESENCE_OFFLINE&&strPresenceState!==this.RAINBOW_PRESENCE_ONLINE)throw new Error("Parameter 'strPresenceState' should be 'dnd', 'away', 'xa' (invisible) or 'online'");return RainbowLogger_1.rainbowLogger.sdk(PresenceService.logService+"[setPresenceTo] :: Set presence to "+strPresenceState),contact_service_1.default.changeMyPresence(strPresenceState),{code:sdkConstant_1.SDK.OK,label:"OK"}}onPresenceChangedEvent(__event,json){const message=json.message||"''";json.jid===xmpp_service_1.default.fullJid?(RainbowLogger_1.rainbowLogger.sdk(PresenceService.logService+"[onPresenceChangedEvent] :: Presence changed for me ("+json.jid+") to  "+json.status+" | "+message),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONPRESENCECHANGED,json)):(RainbowLogger_1.rainbowLogger.sdk(PresenceService.logService+"[onPresenceChangedEvent] :: Presence changed for contact ("+json.jid+") to  "+json.status+" | "+message),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONTACTPRESENCECHANGED,json))}onRichPresenceChangedEvent(__event,contact){const message=contact.message||"''",telStatus=contact.telStatus||"''";if(xmpp_service_1.default.fullJid.includes(contact.jid)){RainbowLogger_1.rainbowLogger.sdk(PresenceService.logService+"[onPresenceChangedEvent] :: Rich Presence changed for myself to status "+contact.status+", message "+message+" and telStatus "+telStatus);const sdkEvent=new CustomEvent(this.RAINBOW_ONRICHPRESENCECHANGED,{detail:contact});document.dispatchEvent(sdkEvent)}else{RainbowLogger_1.rainbowLogger.sdk(PresenceService.logService+"[onPresenceChangedEvent] :: Rich Presence changed for contact ("+contact.jid+") to status "+contact.status+", message "+message+" and telStatus "+telStatus);const sdkEvent=new CustomEvent(this.RAINBOW_ONCONTACTRICHPRESENCECHANGED,{detail:contact});document.dispatchEvent(sdkEvent)}}}exports.PresenceService=PresenceService,PresenceService.logService="PresenceService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.UserProfileService=void 0;const auth_service_1=__webpack_require__(2),RainbowLogger_1=__webpack_require__(9),contact_service_1=__webpack_require__(1),profile_service_1=__webpack_require__(8),_$rootScope=new WeakMap,_adminUserService=new WeakMap;class UserProfileService{constructor($rootScope,adminUserService){_$rootScope.set(this,$rootScope),_adminUserService.set(this,adminUserService)}static get $inject(){return["$rootScope","adminUserService"]}getProfile(){return auth_service_1.default.loggedInUser}updateFirstName(strFirstname){return __awaiter(this,void 0,void 0,(function*(){try{if(!strFirstname||"string"!=typeof strFirstname||strFirstname.length<1)throw new Error("Parameter 'strFirstname' is missing, empty or null");const param={firstName:strFirstname},userData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateFirstName] :: First name updated"),userData.data}catch(err){throw err}}))}updateLastName(strLastName){return __awaiter(this,void 0,void 0,(function*(){try{if(!strLastName||"string"!=typeof strLastName||strLastName.length<1)throw new Error("Parameter 'strFirstname' is missing, empty or null");const param={lastName:strLastName},userData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateFirstName] :: First name updated"),userData.data}catch(err){throw err}}))}updatePhoneNumber(type,deviceType,strPhoneNumber,country){return __awaiter(this,void 0,void 0,(function*(){try{if(!type||"string"!=typeof type||["home","work","other"].indexOf(type)<0)throw new Error("Parameter 'type' is missing or not matching one of the following types: 'home', 'work', 'other'");if(!deviceType||"string"!=typeof deviceType||["landline","mobile","fax","other"].indexOf(deviceType)<0)throw new Error("Parameter 'deviceType' is missing or not matching one of the following types 'landline', 'mobile', 'fax', 'other'");if("string"!=typeof strPhoneNumber)throw new Error("Parameter 'strPhoneNumber' must be of type 'string' ");const phoneNumber={type:type,deviceType:deviceType,number:strPhoneNumber};country&&"string"==typeof country&&(phoneNumber.country=country);const userData=auth_service_1.default.loggedInUser;if(userData.phoneNumbers.length){let existingNumbers=!1;if(existingNumbers=userData.phoneNumbers.some(number=>number.type===type&&number.deviceType===deviceType),existingNumbers)userData.phoneNumbers.push(phoneNumber);else{const newNumber={type:type,deviceType:deviceType,number:strPhoneNumber};userData.phoneNumbers.push(newNumber)}}else{const newNumber={type:type,deviceType:deviceType,number:strPhoneNumber};userData.phoneNumbers.push(newNumber)}const res=yield profile_service_1.default.setUserData(userData);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updatePhoneNumber] :: Phone number updated"),res.data}catch(err){throw err}}))}deletePhoneNumber(type,deviceType){return __awaiter(this,void 0,void 0,(function*(){try{if(!type||"string"!=typeof type||["home","work","other"].indexOf(type)<0)throw new Error("Parameter 'type' is missing or not matching one of the following types: 'home', 'work', 'other'");if(!deviceType||"string"!=typeof deviceType||["landline","mobile","fax","other"].indexOf(deviceType)<0)throw new Error("Parameter 'deviceType' is missing or not matching one of the following types 'landline', 'mobile', 'fax', 'other'");const userData=auth_service_1.default.loggedInUser;let res;if(!userData.phoneNumbers.length)throw new Error("No phone numbers associated with the user profile");{const retrievedPhoneNumbers=userData.phoneNumbers;for(let i=0;i<retrievedPhoneNumbers.length;i++)retrievedPhoneNumbers[i].type===type&&retrievedPhoneNumbers[i].deviceType===deviceType&&retrievedPhoneNumbers.splice(i,1);userData.phoneNumbers=retrievedPhoneNumbers,res=yield profile_service_1.default.setUserData(userData),RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[deletePhoneNumber] :: Phone number deleted")}return res.data}catch(err){throw err}}))}updatePhotoFromUrl(imgUrl){return __awaiter(this,void 0,void 0,(function*(){try{if(!imgUrl||"string"!=typeof imgUrl||imgUrl.length<1)throw new Error("Parameter 'imgUrl' is missing, empty or null");return yield contact_service_1.default.pushAvatarImage(imgUrl),void RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updatePhotoFromUrl] :: Photo updated")}catch(err){throw err}}))}updateWorkEmail(strEmail){return __awaiter(this,void 0,void 0,(function*(){try{if(!strEmail||"string"!=typeof strEmail||strEmail.length<1)throw new Error("Parameter 'strEmail' is missing, empty or null");const userData=auth_service_1.default.loggedInUser;let emailExists=!1;if(userData.emails.length){for(let i=0;i<userData.emails.length;i++)"work"===userData.emails[i].type&&(userData.emails[i].email=strEmail,emailExists=!0);emailExists||userData.emails.push({email:strEmail,type:"work"})}else userData.emails=[{email:strEmail,type:"work"}];const param={emails:userData.emails},res=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateWorkEmail] :: work email updated"),res.data}catch(err){throw err}}))}updatePersonalEmail(strEmail){return __awaiter(this,void 0,void 0,(function*(){try{if(!strEmail||"string"!=typeof strEmail||strEmail.length<1)throw new Error("Parameter 'strEmail' is missing, empty or null");const userData=auth_service_1.default.loggedInUser;let emailExists=!1;if(userData.emails.length){for(let i=0;i<userData.emails.length;i++)"home"===userData.emails[i].type&&(userData.emails[i].email=strEmail,emailExists=!0);emailExists||userData.emails.push({email:strEmail,type:"home"})}else userData.emails=[{email:strEmail,type:"home"}];const param={emails:userData.emails},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updatePersonalEmail] :: work email updated"),updatedUserData.data}catch(err){throw err}}))}deleteWorkEmail(){return __awaiter(this,void 0,void 0,(function*(){try{const userData=auth_service_1.default.loggedInUser,param={emails:userData.emails.filter(element=>"work"!==element.type)},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[deleteWorkEmails] :: work emails deleted"),updatedUserData.data}catch(err){throw err}}))}deletePersonalEmail(){return __awaiter(this,void 0,void 0,(function*(){try{const userData=auth_service_1.default.loggedInUser,param={emails:userData.emails.filter(element=>"home"!==element.type)},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[deletePersonalEmails] :: personal emails deleted"),updatedUserData.data}catch(err){throw err}}))}updateCountry(countryStr){return __awaiter(this,void 0,void 0,(function*(){try{const param={country:countryStr},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateCountry] :: Country updated"),updatedUserData.data}catch(err){throw err}}))}updateLanguage(languageStr){return __awaiter(this,void 0,void 0,(function*(){try{const param={language:languageStr},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateLanguage] :: Language updated"),updatedUserData.data}catch(err){throw err}}))}updateTitle(titleStr){return __awaiter(this,void 0,void 0,(function*(){try{const param={title:titleStr},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateTitle] :: title updated"),updatedUserData.data}catch(err){throw err}}))}updateNickName(nickNameStr){return __awaiter(this,void 0,void 0,(function*(){try{const param={nickName:nickNameStr},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateNickName] :: nickname updated"),updatedUserData.data}catch(err){throw err}}))}updateJobTitle(jobTitleStr){return __awaiter(this,void 0,void 0,(function*(){try{const param={jobTitle:jobTitleStr},updatedUserData=yield profile_service_1.default.setUserData(param);return RainbowLogger_1.rainbowLogger.sdk(UserProfileService.logService+"[updateJobTitle] :: job title updated"),updatedUserData.data}catch(err){throw err}}))}}exports.UserProfileService=UserProfileService,UserProfileService.logService="UserProfileService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ContactsService=void 0;const sdkConstant_1=__webpack_require__(28),contact_service_1=__webpack_require__(1),invitation_service_1=__webpack_require__(233),office365ad_service_1=__webpack_require__(413),profile_service_1=__webpack_require__(8),EventsService_1=__webpack_require__(22),_$rootScope=new WeakMap,_directoryService=new WeakMap,_companyDirectoryService=new WeakMap,_phonebookService=new WeakMap;class ContactsService{constructor($rootScope,directoryService,companyDirectoryService,phonebookService){this.RAINBOW_ONCONTACTINFORMATIONCHANGED="rainbowcontactinformationchanged",this.RAINBOW_ONINFORMATIONCHANGED="rainbowinformationchanged",this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED="rainbowsubscriptionnumberchanged",this.RAINBOW_ONCONTACTINVITATIONRECEIVED="rainbowinvitationreceived",_$rootScope.set(this,$rootScope),_directoryService.set(this,directoryService),_companyDirectoryService.set(this,companyDirectoryService),_phonebookService.set(this,phonebookService),$rootScope.$on("$destroy",$rootScope.$on("ON_CONTACT_UPDATED_EVENT",(event,contact)=>this.onContactInformationUpdated(event,contact))),$rootScope.$on("$destroy",$rootScope.$on("ON_USER_CONTACT_UPDATED_EVENT",(event,contact)=>this.onInformationUpdated(event,contact))),$rootScope.$on("$destroy",$rootScope.$on("ON_INVITATIONS_NUMBER_UPDATED",()=>this.onInvitationNumberChanged())),$rootScope.$on("$destroy",$rootScope.$on("ON_INVITATION_CHANGED",(event,contact)=>this.onInvitationReceived(event,contact)))}static get $inject(){return["$rootScope","directoryService","companyDirectoryService","phonebookService"]}onContactInformationUpdated(__event,contact){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONTACTINFORMATIONCHANGED,contact)}onInformationUpdated(__event,contact){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONINFORMATIONCHANGED,contact)}onInvitationNumberChanged(){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONTACTINVITATIONNUMBERCHANGED,null)}onInvitationReceived(__event,contact){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONTACTINVITATIONRECEIVED,contact)}getContactByJID(strJID){return strJID?contact_service_1.default.getContactByJid(strJID):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'strJID' is missing or empty"}}getContactById(strId){return strId?contact_service_1.default.getContactById(strId):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'strId' is missing or empty"}}getNetworkContacts(){return __awaiter(this,void 0,void 0,(function*(){try{return contact_service_1.default.getContacts().filter((function(contact){return contact.id!==contact_service_1.default.userContact.id&&!contact.isBot&&contact.roster}))}catch(err){throw err}}))}getAll(){return contact_service_1.default.getContacts().filter((function(contact){return contact.id!==contact_service_1.default.userContact.id&&!contact.isBot}))}getConnectedUser(){return contact_service_1.default.userContact||null}getConnectedUserPhone(){return contact_service_1.default.userContact?0===contact_service_1.default.userContact.pbxId.length?null:{phoneNumber:contact_service_1.default.userContact.phonePbx,pbxId:contact_service_1.default.userContact.pbxId}:null}searchByName(strName,limit){return __awaiter(this,void 0,void 0,(function*(){const directoryService=_directoryService.get(this);if(!strName)throw new Error("Parameter 'strName' is missing or empty");limit||(limit=20);try{return yield directoryService.search(strName,!1,Math.min(limit,1e3))}catch(err){throw err}}))}searchPhonebook(strPattern){return __awaiter(this,void 0,void 0,(function*(){const phonebookService=_phonebookService.get(this),featureEnabled=profile_service_1.default.isFeatureEnabled(profile_service_1.default.FeaturesEnum.TELEPHONY_PHONE_BOOK);if(!strPattern)throw new Error("Parameter 'strPattern' is missing or empty");if(!featureEnabled)throw new Error("The feature is not enabled for connected user");try{return phonebookService.search(strPattern)}catch(err){throw err}}))}searchOffice365(strPattern){return __awaiter(this,void 0,void 0,(function*(){if(!strPattern)throw new Error("Parameter 'strPattern' is missing or empty");try{return yield office365ad_service_1.default.search(strPattern)}catch(err){throw err}}))}searchCompanyDirectory(strPattern,companyId){return __awaiter(this,void 0,void 0,(function*(){const companyDirectoryService=_companyDirectoryService.get(this);if(!strPattern)throw new Error("Parameter 'strPattern' is missing or empty");try{return yield companyDirectoryService.search(strPattern,companyId)}catch(err){throw err}}))}searchByLogin(strLogin){return __awaiter(this,void 0,void 0,(function*(){const directoryService=_directoryService.get(this);if(!strLogin)throw new Error("Parameter 'strLogin' is missing or empty");try{return directoryService.searchUserByLogin(strLogin)}catch(err){throw err}}))}searchByJid(strJid){return __awaiter(this,void 0,void 0,(function*(){const directoryService=_directoryService.get(this);if(!strJid)throw new Error("Parameter 'strJid' is missing or empty");try{return yield directoryService.searchUserByJid(strJid)}catch(err){throw err}}))}searchById(strId){return __awaiter(this,void 0,void 0,(function*(){if(!strId)throw new Error("Parameter 'strId' is missing or empty");try{return yield contact_service_1.default.getContactByDBId(strId,!0)}catch(err){throw err}}))}acceptInvitation(invitation){return __awaiter(this,void 0,void 0,(function*(){if(!invitation)return new Error("Parameter 'invitation' is missing or null");try{return yield invitation_service_1.default.acceptInvitation(invitation),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}declineInvitation(invitation){return __awaiter(this,void 0,void 0,(function*(){if(!invitation)throw new Error("Parameter 'invitation' is missing or null");try{return yield invitation_service_1.default.declineInvitation(invitation),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}addToNetwork(contact){return __awaiter(this,void 0,void 0,(function*(){if(!contact)throw new Error("Parameter 'contact' is missing or null");try{return yield invitation_service_1.default.joinContactInvitation(contact)}catch(err){throw err}}))}sendInvitationByEmail(email,customMessage){return __awaiter(this,void 0,void 0,(function*(){if(!email)throw new Error("Parameter 'email' is missing or null");try{return yield invitation_service_1.default.sendInvitationByEmail(email,customMessage)}catch(err){throw err}}))}removeFromNetwork(contact){return __awaiter(this,void 0,void 0,(function*(){if(!contact)throw new Error("Parameter 'contact' is missing or null");try{return yield contact_service_1.default.removeContact(contact),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}getInvitationById(strInvitationId){if(!strInvitationId)throw new Error("Parameter 'strInvitationId' is missing or null");return invitation_service_1.default.getInvitation(strInvitationId)}getInvitationsReceived(){return invitation_service_1.default.getReceivedInvitations()}cancelInvitation(invitation){return __awaiter(this,void 0,void 0,(function*(){if(!invitation)throw new Error("Parameter 'invitation' is missing or null");try{return void(yield invitation_service_1.default.cancelOneSendInvitation(invitation))}catch(err){throw err}}))}getInvitationsSent(){return invitation_service_1.default.getSentInvitations()}updateUserCustomData(customData){return __awaiter(this,void 0,void 0,(function*(){if(!customData)throw new Error("Parameter 'customData' is missing or null");try{return void(yield contact_service_1.default.updateUserContact({customData:customData}))}catch(err){throw err}}))}}exports.ContactsService=ContactsService,ContactsService.logService="ContactService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PbxService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),contact_service_1=__webpack_require__(1),sdkConstant_1=__webpack_require__(28),_$rootScope=new WeakMap,_videoService=new WeakMap,_telephonyService=new WeakMap,_voiceMessageService=new WeakMap,_webrtcGatewayService=new WeakMap;class PbxService{constructor($rootScope,videoService,telephonyService,voiceMessageService,webrtcGatewayService){this.RAINBOW_ONTELEPHONYCALLSTATECHANGED="rainbowontelephonycallstatechanged",this.RAINBOW_ONVOIPCALLSTATECHANGED="rainbowonvoipcallstatechanged",this.RAINBOW_ONTELEPHONYSTARTED="rainbowontelephonystarted",this.RAINBOW_ONTELEPHONYSTOPPED="rainbowontelephonystopped",this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED="rainbowontelephonyforwardstatechanged",this.RAINBOW_ONCALLNOMADICEVENT="rainbowoncallnomadicevent",this.RAINBOW_ONVOIPSTARTED="rainbowonvoipstarted",this.RAINBOW_ONVOIPSTOPPED="rainbowonvoipstopped",this.RAINBOW_ONVOICEMESSAGEUPDATED="rainbowonvoicemessageupdated",this.RAINBOW_TELEPHONYDIALING="dialing",this.RAINBOW_TELEPHONYRINGINGOUTGOING="ringingOutgoing",this.RAINBOW_TELEPHONYINCOMING="incomingCall",this.RAINBOW_TELEPHONYACTIVE="active",this.RAINBOW_TELEPHONYRELEASING="releasing",this.RAINBOW_TELEPHONYUNKNOW="Unknown",_$rootScope.set(this,$rootScope),_videoService.set(this,videoService),_telephonyService.set(this,telephonyService),_voiceMessageService.set(this,voiceMessageService),_webrtcGatewayService.set(this,webrtcGatewayService),$rootScope.$on("$destroy",$rootScope.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",(event,state)=>this.onTelephonyStateChanged(event,state))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_NOMADIC_EVENT",(event,nomadicObject)=>this.onCallNomadicEvent(event,nomadicObject))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_UPDATED_EVENT",(event,call)=>this.onTelephonyCallChanged(event,call))),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_FORWARDED_EVENT",(event,forwardStatus)=>this.onCallForwardChanged(event,forwardStatus))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTCGATEWAY_STATE_CHG",(event,state)=>this.onVoIPStateChanged(event,state))),$rootScope.$on("$destroy",$rootScope.$on("ON_VOICE_MESSAGE_UPDATE_EVENT",(event,counters)=>this.onVoiceMessageUpdated(event,counters)))}static get $inject(){return["$rootScope","videoService","telephonyService","voiceMessageService","webrtcGatewayService"]}onTelephonyStateChanged(__event,state){RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onTelephonyStateChanged] :: PBX state changed to "+state),"started"===state?EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONTELEPHONYSTARTED,null):EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONTELEPHONYSTOPPED,null)}onCallNomadicEvent(__event,nomadicObject){RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onCallNomadicEvent] :: Nomadic event received"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCALLNOMADICEVENT,nomadicObject)}onTelephonyCallChanged(__event,call){const isMediaPillarCallSituation=_webrtcGatewayService.get(this).isMediaPillarCallSituation(call);"Phone"!==call.type.value||isMediaPillarCallSituation?isMediaPillarCallSituation&&(RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onTelephonyCallChanged] :: Telephony state changed to "+call),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONVOIPCALLSTATECHANGED,call)):(RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onTelephonyCallChanged] :: Telephony state changed to "+call),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONTELEPHONYCALLSTATECHANGED,call))}onCallForwardChanged(__event,forwardStatus){RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onCallForwardChanged] :: Forward state changed to "+forwardStatus),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONTELEPHONYFORWARDSTATECHANGED,forwardStatus)}onVoIPStateChanged(__event,state){RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onVoIPStateChanged] :: VoIP state changed to "+state?"true":"false"),state?EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONVOIPSTARTED,null):EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONVOIPSTOPPED,null)}onVoiceMessageUpdated(__event,counters){RainbowLogger_1.rainbowLogger.sdk(PbxService.logService+"[onVoiceMessageUpdated] :: New Voice Message event received"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONVOICEMESSAGEUPDATED,counters)}isTelephonyAvailable(){return _telephonyService.get(this).started}isVoiceMailConfigured(){const telephonyService=_telephonyService.get(this);return Boolean(telephonyService.voiceMailFeatureEnabled&&telephonyService.voicemailNumber)}getAgentVersion(){return _telephonyService.get(this).agentStatus.agentVersion||"unknown"}getXMPPAgentStatus(){return _telephonyService.get(this).agentStatus.xmppAgent||"unknown"}getPhoneAPIStatus(){return _telephonyService.get(this).agentStatus.phoneApi||"unknown"}makeCall1PCC(strPhoneNumber,contact){return __awaiter(this,void 0,void 0,(function*(){const webrtcGatewayService=_webrtcGatewayService.get(this);try{if(!strPhoneNumber)throw new Error("Parameter 'strPhoneNumber' is missing or empty");return webrtcGatewayService.mediaPillarMakeCall1PCC(strPhoneNumber,contact)}catch(err){throw err}}))}makeCall(contact,strPhoneNumber,callSubject,correlatorData){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!strPhoneNumber)throw new Error("Parameter 'strPhoneNumber' is missing or empty");return contact?yield telephonyService.makeCall(contact,strPhoneNumber,callSubject,correlatorData):yield telephonyService.makeCallByPhoneNumber(strPhoneNumber,callSubject,correlatorData),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}callByNumber(strPhoneNumber){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!strPhoneNumber)throw new Error("Parameter 'strPhoneNumber' is missing or empty");return yield telephonyService.makeCallByPhoneNumber(strPhoneNumber),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}callWithMessage(contact,phoneNumber,callSubject,correlatorData){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!contact)throw new Error("Parameter 'contact' is missing or empty");if(!phoneNumber)throw new Error("Parameter 'phoneNumber' is missing or empty");if(!callSubject)throw new Error("Parameter 'callSubject' is missing or empty");return yield telephonyService.makeCall(contact,phoneNumber,callSubject,correlatorData),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}callWithSubject(contact,phoneNumber,callSubject){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!contact)throw new Error("Parameter 'contact' is missing or empty");if(!phoneNumber)throw new Error("Parameter 'phoneNumber' is missing or empty");if(!callSubject)throw new Error("Parameter 'callSubject' is missing or empty");return yield telephonyService.makeCall(contact,phoneNumber,callSubject),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}calls(){return _telephonyService.get(this).calls}getActiveCall(){return _telephonyService.get(this).getActiveCall()}release(call){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!call)throw new Error("Parameter 'call' is missing or null");return yield telephonyService.releaseCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}deflectToVM(call){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!call)throw new Error("Parameter 'call' is missing or null");if(!call.connectionId)throw new Error("Property 'connectionId' of the object 'call' is missing or null");if("Phone"!==call.type.value)throw new Error("Call must be of type 'Phone' (see call.type.value)");return yield telephonyService.deflectCallToVM(call),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}forwardToDevice(strPhoneNumber){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!strPhoneNumber||"string"!=typeof strPhoneNumber||0===strPhoneNumber.length)throw new Error("Parameter 'strPhoneNumber' is missing or empty");return telephonyService.forwardToDevice(strPhoneNumber),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}forwardToVoicemail(){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return yield telephonyService.forwardToVoicemail(),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}cancelForward(){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return yield telephonyService.cancelForward(),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}getForwardStatusFromServer(){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{yield telephonyService.getForwardStatus().then(()=>({code:sdkConstant_1.SDK.OK,label:"OK"}))}catch(err){throw err}}))}getForwardStatus(){return _telephonyService.get(this).getForwardObject()}answer(call){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this),webrtcGatewayService=_webrtcGatewayService.get(this);try{if(!call)throw new Error("Parameter 'call' is missing or null");return call.mediaPillarCall?webrtcGatewayService.answerCall(call):yield telephonyService.answerCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}hold(call){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!call)throw new Error("Parameter 'call' is missing or null");return yield telephonyService.holdCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}retrieve(call){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!call)throw new Error("Parameter 'call' is missing or null");return yield telephonyService.retrieveCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}transferCall(activeCall,heldCall){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!activeCall)throw new Error("Parameter 'activeCall' is missing or null");if(!heldCall)throw new Error("Parameter 'heldCall' is missing or null");return yield telephonyService.transfertCall(activeCall,heldCall),resolve({code:sdkConstant_1.SDK.OK,label:"OK"})}catch(err){throw err}}))}conferenceCall(activeCall,heldCall){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!activeCall)throw new Error("Parameter 'activeCall' is missing or null");if(!heldCall)throw new Error("Parameter 'heldCall' is missing or null");return yield telephonyService.conferenceCall(activeCall,heldCall),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}fetchVoiceMailMessagesNumber(){return __awaiter(this,void 0,void 0,(function*(){const voiceMessageService=_voiceMessageService.get(this);try{return yield voiceMessageService.getVoiceMessagesCounters()}catch(err){throw err}}))}muteCall(call,conversation){const webrtcGatewayService=_webrtcGatewayService.get(this);if(!call)throw new Error("Parameter 'call' is missing or null");webrtcGatewayService.muteAudio(call,!0,conversation)}unmuteCall(call,conversation){const webrtcGatewayService=_webrtcGatewayService.get(this);if(!call)throw new Error("Parameter 'call' is missing or null");webrtcGatewayService.muteAudio(call,!1,conversation)}nomadicLogin(phoneNumber,isUnchangeableNumber,notTakeIntoAccount){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!phoneNumber)throw new Error("Parameter 'phoneNumber' is missing or null");return void(yield telephonyService.nomadicLogin(phoneNumber,isUnchangeableNumber,notTakeIntoAccount))}catch(err){throw err}}))}nomadicLogout(){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return void(yield telephonyService.nomadicLogout())}catch(err){throw err}}))}getNomadicState(){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return void(yield telephonyService.getNomadicStatus())}catch(err){throw err}}))}setExternalNomadicNumber(phoneNumber){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!phoneNumber)throw new Error("Parameter 'phoneNumber' is missing or null");if("string"!=typeof phoneNumber)throw new Error("Parameter 'phoneNumber' is not a string");return void(yield telephonyService.nomadicLogin(phoneNumber))}catch(err){throw err}}))}setNomadicOfficePhone(){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return void(yield telephonyService.nomadicLoginOnOfficePhone())}catch(err){throw err}}))}setNomadicVoIP(){return __awaiter(this,void 0,void 0,(function*(){const webrtcGatewayService=_webrtcGatewayService.get(this),telephonyService=_telephonyService.get(this);try{const mediapillar=webrtcGatewayService.getMyMediaPillarRemoteExtension();return void(yield telephonyService.nomadicLogin(mediapillar))}catch(err){throw err}}))}setNomadicWebRTC(){return __awaiter(this,void 0,void 0,(function*(){const webrtcGatewayService=_webrtcGatewayService.get(this),telephonyService=_telephonyService.get(this);try{const mediapillar=webrtcGatewayService.getMyMediaPillarRemoteExtension();return void(yield telephonyService.nomadicLogin(mediapillar))}catch(err){throw err}}))}isDeskPhoneAvailable(){return!contact_service_1.default.userContact.isVirtualTerm}isVoIPAvailable(){return _webrtcGatewayService.get(this).isMediaPillarAvailable()}logonCCD(endpointTel,agentId,password,groupId){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!endpointTel)throw new Error("Parameter 'endpointTel' is missing or empty");return yield telephonyService.logonCCD(endpointTel,agentId,password,groupId)}catch(err){throw err}}))}logoffCCD(endpointTel,agentId,password,groupId){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{if(!endpointTel)throw new Error("Parameter 'endpointTel' is missing or empty");return yield telephonyService.logoffCCD(endpointTel,agentId,password,groupId)}catch(err){throw err}}))}withdrawalCCD(agentId,groupId,status){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return yield telephonyService.withdrawalCCD(agentId,groupId,status)}catch(err){throw err}}))}wrapupCCD(agentId,groupId,password,status){return __awaiter(this,void 0,void 0,(function*(){const telephonyService=_telephonyService.get(this);try{return telephonyService.wrapupCCD(agentId,groupId,password,status)}catch(err){throw err}}))}sendDTMF(dialString,call){return __awaiter(this,void 0,void 0,(function*(){const videoService=_videoService.get(this),telephonyService=_telephonyService.get(this);try{if(!dialString)throw new Error("Parameter 'dialString' is missing or empty");if(!call)throw new Error("Parameter 'call' is missing or empty");if("Video"===call.type.value)return videoService.sendDTMF(dialString,call,!1);if("Phone"===call.type.value)return telephonyService.sendDtmf(call,dialString);if("Video"!==call.type.value||"Phone"!==call.type.value)throw new Error("Parameter 'call' must be of type 'Video' or 'Phone'");return!0}catch(err){throw err}}))}}exports.PbxService=PbxService,PbxService.logService="TelephonyService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConversationsService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),_$rootScope=new WeakMap,_Conversation=new WeakMap,_conversationService=new WeakMap;class ConversationsService{constructor($rootScope,Conversation,conversationService){this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED="rainbowconversationsmissedcounterchanged",this.RAINBOW_ONCONVERSATIONSCHANGED="rainbowconversationschanged",this.RAINBOW_ONCONVERSATIONREMOVED="rainbowconversationremoved",this.RAINBOW_ONCONVERSATIONCHANGED="rainbowconversationchanged",_$rootScope.set(this,$rootScope),_Conversation.set(this,Conversation),_conversationService.set(this,conversationService),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATIONS_UPDATED_EVENT",(event,conversation)=>this.onConversationsChanged(event,conversation))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_REMOVE_EVENT",(event,conversation)=>this.onConversationsRemoved(event,conversation))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_UPDATED_EVENT",(event,conversation)=>this.onConversationChanged(event,conversation))),$rootScope.$on("$destroy",$rootScope.$on("ON_MISSED_COUNTER_CHANGED_EVENT",(event,json)=>this.onConversationsCounterChanged(event,json)))}static get $inject(){return["$rootScope","Conversation","conversationService"]}onConversationsChanged(__event,conversation){conversation&&EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONVERSATIONSCHANGED,conversation)}onConversationsRemoved(__event,conversation){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONVERSATIONREMOVED,conversation)}onConversationChanged(__event,conversation){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONVERSATIONCHANGED,conversation)}onConversationsCounterChanged(__event,json){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCONVERSATIONSMISSEDCOUNTERCHANGED,json)}getAllConversations(){return _conversationService.get(this).getConversations()}getCallById(strCallId){const conversationService=_conversationService.get(this);if(!strCallId)throw new Error("Parameter 'strCallId' is missing or empty");const allConversations=conversationService.getConversations();let call=null;return allConversations.forEach((function(conversation){conversation.videoCall&&conversation.videoCall.id===strCallId?call=conversation.videoCall:conversation.audioCall&&conversation.audioCall.id===strCallId&&(call=conversation.audioCall)})),call}getConversationById(strId){const conversationService=_conversationService.get(this);if(!strId)throw new Error("Parameter 'callId' is missing or empty");return conversationService.getConversationById(strId)}getConversationByBubbleId(strBubbleId){const conversationService=_conversationService.get(this);if(!strBubbleId)throw new Error("Parameter 'strBubbleId' is missing or empty");return conversationService.getConversationByRoomDbId(strBubbleId)}openConversationForContact(contact){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!contact)throw new Error("Parameter 'contact' is missing or null");RainbowLogger_1.rainbowLogger.sdk(ConversationsService.logService+"[openConversationForContact] :: Trying to open a conversation for a contact");return yield conversationService.getOrCreateOneToOneConversation(contact.jid)}catch(err){throw err}}))}openConversationForBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!bubble)throw new Error("Prameter 'bubble' is missing or null");RainbowLogger_1.rainbowLogger.sdk(ConversationsService.logService+"[openConversationForBubble] :: Try to create or get a conversation for a bubble ");return yield conversationService.getRoomConversation(bubble.jid)}catch(err){throw err}}))}closeConversation(conversation){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!conversation)throw new Error("Parametr 'conversation' is missing or null");return void(yield conversationService.closeConversation(conversation))}catch(err){throw err}}))}}exports.ConversationsService=ConversationsService,ConversationsService.logService="ConversationsService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ImService=void 0;const EventsService_1=__webpack_require__(22),RainbowLogger_1=__webpack_require__(9),message_1=__webpack_require__(16),sdkConstant_1=__webpack_require__(28),fileStorage_service_1=__webpack_require__(25),room_service_1=__webpack_require__(33),_$rootScope=new WeakMap,_conversationService=new WeakMap,_Conversation=new WeakMap;class ImService{constructor($rootScope,conversationService,Conversation){this.RAINBOW_ONNEWIMMESSAGERECEIVED="rainbownewimmessagereceived",this.RAINBOW_ONNEWIMRECEIPTRECEIVED="rainbownewimreceiptreceived",this.RAINBOW_ONNEWPARTICIPANTSTATUS="rainbownewparticipantstatus",_$rootScope.set(this,$rootScope),_conversationService.set(this,conversationService),_Conversation.set(this,Conversation),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_MESSAGE_RECEIVED",(event,message,conversation,cc)=>this.onNewImMessageReceived(event,message,conversation,cc))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATION_RECEIPT_RECEIVED",(event,message,conversation,evt)=>this.onNewImReceiptReceived(event,message,conversation,evt))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONVERSATIONS_STATUS_MESSAGE_EVENT",(event,conversation,participant,status)=>this.onNewParticipantStatus(event,conversation,participant,status)))}static get $inject(){return["$rootScope","conversationService","Conversation"]}onNewImMessageReceived(__event,message,conversation,cc){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONNEWIMMESSAGERECEIVED,{message:message,conversation:conversation,cc:cc})}onNewImReceiptReceived(__event,message,conversation,evt){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONNEWIMRECEIPTRECEIVED,{message:message,conversation:conversation,evt:evt})}onNewParticipantStatus(__event,participant,conversation,status){status&&status.value&&EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONNEWPARTICIPANTSTATUS,{participant:participant,conversation:conversation,status:status.value})}getMessagesFromConversation(conversation,intNbMessage=30){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!conversation)throw new Error("Parameter 'conversation' is missing or null");intNbMessage=intNbMessage?Math.min(intNbMessage,100):30;return yield conversationService.conversationServiceBulkHistoryHandler.getHistoryPage(conversation,intNbMessage)}catch(err){throw err}}))}getMessageFromConversationById(conversation,strMessageId){if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(!strMessageId)throw new Error("Parameter 'strMessageId' is missing or empty");const message=conversation.getMessageById(strMessageId);return message&&message.fileId&&(message.shortFileDescriptor=fileStorage_service_1.default.getFileDescriptorById(message.fileId)),message}getMessageFromBubbleById(bubble,strMessageId){const conversationService=_conversationService.get(this),Conversation=_Conversation.get(this);if(!bubble)throw new Error("Parameter 'bubble' is missing or null");if(!strMessageId)throw new Error("Parameter 'strMessageId' is missing or empty");const conversation=conversationService.getConversationByRoomDbId(bubble.dbId);if(!conversation)throw new Error("Parameter 'bubble' don't have a conversation");if(conversation.type!==Conversation.Type.ROOM)throw new Error("Parameter 'conversation' is not a bubble conversation");const message=conversation.getMessageById(strMessageId);return message&&message.fileId&&(message.shortFileDescriptor=fileStorage_service_1.default.getFileDescriptorById(message.fileId)),message}sendMessageToConversation(conversation,strMessage,alternativeContentType,alternativeContentMessage){const conversationService=_conversationService.get(this);if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(!strMessage)throw new Error("Parameter 'strMessage' is missing or empty");if("string"!=typeof strMessage)throw new Error("Parameter 'strMessage' must be a string");if(strMessage.length>1024)throw new Error("Parameter 'strMessage' should be shorter than 1024 characters");let alternativeContent=null;if(alternativeContentMessage){if(alternativeContentMessage.length>1024)throw new Error("Parameter 'alternativeContent.message' should be shorter than 1024 characters");if(!alternativeContentType||"text"!==alternativeContentType&&"markdown"!==alternativeContentType&&"rainbow/json"!==alternativeContentType)throw new Error("Parameter 'alternativeContent.type' should be set to either 'text', 'markdown' or 'rainbow/json'");"rainbow/json"===alternativeContentType&&(alternativeContentMessage=JSON.stringify(alternativeContentMessage)),alternativeContent={type:alternativeContentType,message:alternativeContentMessage}}return conversationService.sendChatMessage(conversation,strMessage,alternativeContent)}sendCorrectedChatMessage(conversation,strMessage,messageId){const conversationService=_conversationService.get(this);if(RainbowLogger_1.rainbowLogger.sdk(ImService.logService+"[sendCorrectedChatMessage] :: Trying to send a corrected message"),!conversation)throw new Error("Parameter 'conversation' is missing or null");if(!strMessage)throw new Error("Parameter 'strMessage' is missing or empty");if(strMessage.length>1024)throw new Error("Parameter 'strMessage' should be shorter than 1024 characters");if(!messageId)throw new Error("Parameter 'messageId' is missing or empty");conversationService.sendCorrectedChatMessage(conversation,strMessage,messageId);return conversation.getMessageById(messageId)}replyToMessage(conversation,strMessage,answerMessage){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(conversation){if(strMessage){if(answerMessage)return conversationService.sendChatMessage(conversation,strMessage,null,answerMessage),answerMessage;throw new Error("Parameter 'answerMessage' is missing or null")}throw new Error("Parameter 'strMessage' is missing or null")}throw new Error("Parameter 'conversation' is missing or null")}catch(err){throw err}}))}deleteMessage(conversation,messageId){const conversationService=_conversationService.get(this);if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(!messageId)throw new Error("Parameter 'messageId' is missing or empty");conversationService.sendCorrectedChatMessage(conversation,"",messageId);return conversation.getMessageById(messageId)}sendIsTypingStateInConversation(conversation,status){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(conversation){if("boolean"!=typeof status)throw new Error("Parameter 'status' is missing or null");if(!(conversation=conversation.id?conversationService.getConversationById(conversation.id):null))throw new Error("Parameter 'conversation': this conversation doesn't exist");return void conversationService.sendIsTypingState(conversation,status)}throw new Error("Parameter 'conversation' is missing or null")}catch(err){throw err}}))}sendMessageToBubble(bubble,strMessage){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");if(!strMessage)throw new Error("Parameter 'strMessage' is missing or empty");if(strMessage.length>1024)throw new Error("Parameter 'strMessage' should be shorter than 1024 characters");const conversation=yield conversationService.getRoomConversation(bubble.jid);if(!conversation)throw new Error("No 'conversation' found");let message;return bubble.isActive||(yield room_service_1.default.sendInitialRoomPresenceSync(bubble)),message=conversationService.sendChatMessage(conversation,strMessage),message}catch(err){throw err}}))}sendIsTypingStateInBubble(bubble,status){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");if("boolean"!=typeof status)throw new Error("Parameter 'status' is missing or null");if(!bubble.jid)throw new Error("Parameter 'bubble': this bubble is not a valid one");const conversation=yield conversationService.getRoomConversation(bubble.jid);if(!conversation)throw new Error("No 'conversation' found for this bubble");return void conversationService.sendIsTypingState(conversation,status)}catch(err){throw err}}))}removeAllMessagesFromConversation(conversation){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this),Conversation=_Conversation.get(this);try{if(conversation){if(conversation.type!==Conversation.Type.ONE_TO_ONE&&conversation.type!==Conversation.Type.BOT)throw new Error("Parameter 'conversation' is not a one-to-one conversation");return yield conversationService.removeAllMessages(conversation),{code:sdkConstant_1.SDK.OK,label:"OK"}}throw new Error("Parameter 'conversation' is missing or null")}catch(err){throw err}}))}markMessageFromConversationAsRead(conversation,message){const conversationService=_conversationService.get(this);if(!message)throw new Error("Parameter 'message' is missing or empty");if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(message.receiptStatus===message_1.Message.ReceiptStatus.READ)throw new Error("Parameter 'message' is aldready marked as read");return conversationService.sendAckReadMessage(conversation,message),message.receiptStatus===message_1.Message.ReceiptStatus.READ&&conversationService.decreaseMissedIMCounterForConversation(conversation),{code:sdkConstant_1.SDK.OK,label:"OK"}}}exports.ImService=ImService,ImService.logService="IMService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebRTCService=void 0;const sdkConfig_1=__webpack_require__(38),settings_service_1=__webpack_require__(5),xmpp_service_1=__webpack_require__(4),call_model_1=__webpack_require__(0),RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),sdkConstant_1=__webpack_require__(28),_$rootScope=new WeakMap,_videoService=new WeakMap,_platformService=new WeakMap,_extensionSharingService=new WeakMap,_webrtcGatewayService=new WeakMap,_recordsService=new WeakMap,_conversationService=new WeakMap;class WebRTCService{constructor($rootScope,videoService,platformService,extensionSharingService,webrtcGatewayService,recordsService,conversationService){this.DetectRTC=window.DetectRTC,this.RAINBOW_ONWEBRTCCALLSTATECHANGED="rainbowonwebrtccallstatechanged",this.RAINBOW_ONVOIPCALLSTATECHANGED="rainbowonvoipcallstatechanged",this.RAINBOW_ONWEBRTCMEDIADEVICECHANGED="rainbowonwebrtcmediadevicechanged",this.RAINBOW_ONWEBRTCERRORHANDLED="rainbowonwebrtcerrorhandled",this.RAINBOW_ONWEBRTCSTREAMADDED="rainbowonwebrtcstreamadded",this.RAINBOW_ONWEBRTCTRACKCHANGED="rainbowonwebrtctrackchanged",this.RAINBOW_ONCHROMESTOPSCREENSHARINGTRIGGERED="rainbowonchromestopscreensharingtriggered",this.RAINBOW_ONWEBRTCTMEDIAERROROCCURED="rainbowonwebrtcmediaerroroccured",this.RAINBOW_ONWEBRTCTRECORDSTARTED="rainbowonwebrtcrecordstarted",this.RAINBOW_ONWEBRTCTRECORDSTOPPED="rainbowonwebrtcrecordstopped",this.RAINBOW_ONWEBRTCTRECORDPAUSED="rainbowonwebrtcrecordpaused",this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED="rainbowonwebrtcrecordremotestarted",this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED="rainbowonwebrtcrecordremotestopped",this.RAINBOW_ONWEBRTCTRECORDDONE="rainbowonwebrtcrecorddone",this.RAINBOW_ONWEBRTCTRECORDERROR="rainbowonwebrtcrecorderror",_$rootScope.set(this,$rootScope),_videoService.set(this,videoService),_platformService.set(this,platformService),_extensionSharingService.set(this,extensionSharingService),_webrtcGatewayService.set(this,webrtcGatewayService),_recordsService.set(this,recordsService),_conversationService.set(this,conversationService),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_UPDATED_EVENT",(event,call)=>this.onWebRTCCallChanged(event,call))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_CALL_ERROR_EVENT",(event,error)=>this.onWebRTCErrorHandled(event,error))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_REMOTE_STREAM_ADDED",(event,streams)=>this.onWebRTCRemoteStreamAdded(event,streams))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_CALL_ESCALATION_SUCCESS",(event,call)=>this.onWebRTCEscalation(event,call))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_CALL_ESCALATION",(event,call)=>this.onWebRTCEscalation(event,call))),$rootScope.$on("$destroy",$rootScope.$on("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED",()=>this.onChromeStopScreenSharingTrigerred())),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_RECORD_SAVED",(event,description,data,source)=>this.onWebRTCRecordingData(event,description,data,source))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_RECORD_ERROR",()=>this.onWebRTCRecordingError())),$rootScope.$on("$destroy",$rootScope.$on("ON_RECORDING_START_MSG_RECEIVED",()=>this.onWebRTCRecordingStartedByRemote())),$rootScope.$on("$destroy",$rootScope.$on("ON_RECORDING_STOP_MSG_RECEIVED",()=>this.onWebRTCRecordingStoppedByRemote()))}static get $inject(){return["$rootScope","videoService","platformService","extensionSharingService","webrtcGatewayService","recordsService","conversationService"]}onWebRTCCallChanged(__event,call){const webrtcGatewayService=_webrtcGatewayService.get(this),videoService=_videoService.get(this);call.type.value!==call_model_1.Call.Type.WEBRTC.value||webrtcGatewayService.isMediaPillarCallSituation(call)||(EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCCALLSTATECHANGED,call),"active"===call.status.value&&call.unifiedPlanActivated&&videoService.attachDistantMediaStreamsUnifiedPlan(call))}onWebRTCErrorHandled(__event,error){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCERRORHANDLED,error)}onWebRTCRemoteStreamAdded(__event,streams){setTimeout(()=>{EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCSTREAMADDED,streams)},100)}onWebRTCEscalation(__event,call){setTimeout(()=>{EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRACKCHANGED,call)},100)}onChromeStopScreenSharingTrigerred(){setTimeout(()=>{EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHROMESTOPSCREENSHARINGTRIGGERED,null)},100)}onWebRTCRecordingData(__event,description,data,source){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDDONE,[description,data,source])}onWebRTCRecordingError(){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDERROR,null)}onWebRTCRecordingStartedByRemote(){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDREMOTESTARTED,null)}onWebRTCRecordingStoppedByRemote(){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDREMOTESTOPPED,null)}setUnifiedPlan(){const videoService=_videoService.get(this);if(!0===sdkConfig_1.sdkConfig.unifiedPlan){if(!videoService.config)return RainbowLogger_1.rainbowLogger.sdk("WebRTC Service: Unified plan set to true"),videoService.config={},videoService.config.unifiedPlan=!0,!0;RainbowLogger_1.rainbowLogger.sdk("WebRTC Service: Unified plan set to true"),videoService.config.unifiedPlan=!0}return!1}canMakeAudioVideoCall(){return("https:"===location.protocol||"chrome-extension:"===location.protocol)&&this.DetectRTC.isWebRTCSupported&&this.DetectRTC.isGetUserMediaSupported}hasAMicrophone(){return this.DetectRTC.hasMicrophone}hasACamera(){return this.DetectRTC.hasWebcam}useMicrophone(strMicrophoneId){return strMicrophoneId?(settings_service_1.default.setSetting("microphone",strMicrophoneId),settings_service_1.default.setSetting("headsetMicrophone",strMicrophoneId),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'strMicrophoneId' is missing or empty"}}useSpeaker(strSpeakerId){const platformService=_platformService.get(this);return strSpeakerId?(settings_service_1.default.setSetting("speaker",strSpeakerId),settings_service_1.default.setSetting("headsetSpeaker",strSpeakerId),settings_service_1.default.setSetting("ringingSpeaker",strSpeakerId),platformService.setSpeakerForElement(document.getElementById("largevideo"),strSpeakerId),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'strSpeakerId' is missing or empty"}}useCamera(strCameraId){return strCameraId?(settings_service_1.default.setSetting("camera",strCameraId),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'strCameraId' is missing or empty"}}callInAudio(contact,subject){const videoService=_videoService.get(this);return contact?this.canMakeAudioVideoCall()?(this.setUnifiedPlan(),videoService.makeCall(contact,"audio",subject),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}}callInVideo(contact,subject){const videoService=_videoService.get(this);return contact?this.canMakeAudioVideoCall()?(this.setUnifiedPlan(),videoService.makeCall(contact,"video",subject),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"}}callInSharing(contact,subject){return __awaiter(this,void 0,void 0,(function*(){const videoService=_videoService.get(this);try{if(contact){if(navigator.userAgent.indexOf("Chrome")>-1){const raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return parseInt(raw[2],10)>72?(videoService.makeDesktopSharingCall(contact,"sharingOnly",subject),{code:sdkConstant_1.SDK.OK,label:"OK"}):(yield this.canMakeDesktopSharingCall(),this.setUnifiedPlan(),videoService.makeDesktopSharingCall(contact,"sharingOnly",subject),{code:sdkConstant_1.SDK.OK,label:"OK"})}return this.setUnifiedPlan(),videoService.makeDesktopSharingCall(contact,"sharingOnly",subject),{code:sdkConstant_1.SDK.OK,label:"OK"}}throw new Error("Parameter 'contact' is missing or null")}catch(err){throw err}}))}callinAudioWithSharing(contact,subject){return __awaiter(this,void 0,void 0,(function*(){const videoService=_videoService.get(this),userAgent=navigator.userAgent;try{if(!contact)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'contact' is missing or null"};if(userAgent.indexOf("Chrome")>-1){const raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(parseInt(raw[2],10)>72)return videoService.makeDesktopSharingCall(contact,subject),{code:sdkConstant_1.SDK.OK,label:"OK"};yield this.canMakeDesktopSharingCall(),this.setUnifiedPlan(),videoService.makeDesktopSharingCall(contact,subject)}else this.setUnifiedPlan(),videoService.makeDesktopSharingCall(contact,subject);return{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}answerInAudio(call){const videoService=_videoService.get(this);return call?this.canMakeAudioVideoCall()?(this.setUnifiedPlan(),videoService.answerCall(call,"audio"),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}answerInVideo(call){const videoService=_videoService.get(this);return call?this.canMakeAudioVideoCall()?(this.setUnifiedPlan(),videoService.answerCall(call,"video"),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}getPeerConnectionForCall(call){if(!call)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"};if(!call.id)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Can not get the call ID"};return xmpp_service_1.default.connection.jingle.sessions[call.id].peerconnection}showLocalVideo(){const videoService=_videoService.get(this);return this.canMakeAudioVideoCall()?(videoService.attachLocalMediaStreams(!0),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}hideLocalVideo(){const videoService=_videoService.get(this);return this.canMakeAudioVideoCall()?(videoService.attachLocalMediaStreams(!1),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}showRemoteVideo(call){const videoService=_videoService.get(this);return call?this.canMakeAudioVideoCall()?(videoService.attachDistantMediaStreams(!0,call),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}hideRemoteVideo(call){const videoService=_videoService.get(this);return call?this.canMakeAudioVideoCall()?(videoService.attachDistantMediaStreams(!1,call),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}addVideoToCall(call){const videoService=_videoService.get(this);return this.canMakeAudioVideoCall()?(this.setUnifiedPlan(),videoService.addVideoToCall(call,!1),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}addSharingToCall(call){return __awaiter(this,void 0,void 0,(function*(){const videoService=_videoService.get(this);try{const userAgent=navigator.userAgent;if(!call)throw new Error("Parameter 'call' is missing or null");if(!(userAgent.indexOf("Chrome")>-1))return this.setUnifiedPlan(),videoService.addSharingToCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"};{const raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);parseInt(raw[2],10)>72&&videoService.addSharingToCall(call),yield this.canMakeDesktopSharingCall(),this.setUnifiedPlan(),videoService.addSharingToCall(call)}return{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}removeVideoFromCall(call){const videoService=_videoService.get(this);return this.canMakeAudioVideoCall()?(this.setUnifiedPlan(),videoService.removeVideoFromCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}}removeSharingFromCall(call){const videoService=_videoService.get(this);return this.setUnifiedPlan(),videoService.removeSharingFromCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}}release(call){const videoService=_videoService.get(this);return call?(this.canMakeAudioVideoCall()||RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"release called but WebRTC is not supported by your browser"),videoService.rejectCall(call),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"}}muteAudioCall(conversation){const videoService=_videoService.get(this);return conversation?this.canMakeAudioVideoCall()?(videoService.muteAudio(conversation,!0),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}unmuteAudioCall(conversation){const videoService=_videoService.get(this);return conversation?this.canMakeAudioVideoCall()?(videoService.muteAudio(conversation,!1),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORUNSUPPORTED,label:"WebRTC is not supported by your browser"}:{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'conversation' is missing or null"}}getLocalStreamsFromCall(call){if(!call||!("id"in call))return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(call.type!==call_model_1.Call.Type.WEBRTC)return{code:sdkConstant_1.SDK.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};const session=xmpp_service_1.default.connection.jingle.sessions[call.id];return session?session.localStreams:[]}getRemoteStreamsFromCall(call){if(!call||!("id"in call))return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or empty"};if(call.type!==call_model_1.Call.Type.WEBRTC)return{code:sdkConstant_1.SDK.ERRORNOTFOUND,label:"This call is not an audio or audio/video call"};const session=xmpp_service_1.default.connection.jingle.sessions[call.id];return session?session.remoteStreamsObject:[]}setChromeExtensionIdForSharing(strExtensionId){const extensionSharingService=_extensionSharingService.get(this);return strExtensionId?(extensionSharingService.setExtensionId(strExtensionId),extensionSharingService.start(),{code:sdkConstant_1.SDK.OK,label:"OK"}):{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'strExtensionId' is missing or empty"}}canMakeDesktopSharingCall(){return __awaiter(this,void 0,void 0,(function*(){const extensionSharingService=_extensionSharingService.get(this);try{const userAgent=navigator.userAgent;if(userAgent.indexOf("Firefox")>-1)return{code:sdkConstant_1.SDK.OK,label:"OK"};if(!(userAgent.indexOf("Chrome")>-1)){if(yield extensionSharingService.isExtensionInstalled())return WebRTCService.isChromeExtensionInstalled=!0,{code:sdkConstant_1.SDK.OK,label:"OK"};throw WebRTCService.isChromeExtensionInstalled=!1,new Error("Not Chrome Extension installed for desktop sharing")}{const raw=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);if(parseInt(raw[2],10)>72)return{code:sdkConstant_1.SDK.OK,label:"OK"}}return}catch(err){throw err}}))}startRecording(call,fileName,recordRemote,toUpload,onlyAudio,mimeType){const recordsService=_recordsService.get(this),conversationService=_conversationService.get(this);if(RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: Enter"),!call)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'call' is missing or null"};if(!fileName)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Parameter 'fileName' is missing or null"};recordRemote=null==recordRemote||recordRemote,toUpload=null==toUpload||toUpload,onlyAudio=null!=onlyAudio&&onlyAudio,mimeType=null==mimeType?"video/webm;codecs=vp9":mimeType,RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: Prepare recording...");if(recordsService.createRecord(call.id,recordRemote?"REMOTE":"LOCAL",toUpload,fileName,onlyAudio,mimeType)){recordsService.setOnPauseCallback(()=>{RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[onRTCChange] :: WebRTC recording paused"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDPAUSED,null)}),RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: Start recording"),recordsService.startRecording();const conversation=conversationService.getConversationById(call.conversationId);return conversation?(RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: Notify remote peer"),conversationService.sendRecordingMessage(conversation,"start")):RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: No conversation found - can't notify remote peer"),RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: WebRTC recording started"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDSTARTED,null),{code:sdkConstant_1.SDK.OK,label:"OK"}}return RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[startRecording] :: can't start a webRTC recording"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDERROR,null),{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"Can't record the conversation"}}stopRecording(call){const recordsService=_recordsService.get(this),conversationService=_conversationService.get(this);RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[stopRecording] :: Stop current WebRTC recording"),recordsService.setOnPauseCallback(null),recordsService.stopRecording();const conversation=conversationService.getConversationById(call.conversationId);return conversation?(RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[stopRecording] :: Notify remote peer"),conversationService.sendRecordingMessage(conversation,"stop")):RainbowLogger_1.rainbowLogger.sdk(WebRTCService.logService+"[stopRecording] :: No conversation found - can't notify remote peer"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCTRECORDSTOPPED,null),{code:sdkConstant_1.SDK.OK,label:"OK"}}}exports.WebRTCService=WebRTCService,WebRTCService.logService="WebRTCService | ",WebRTCService.isChromeExtensionInstalled=!1},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BubblesService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),room_model_1=__webpack_require__(226),promiseQueue_1=__webpack_require__(49),contact_service_1=__webpack_require__(1),room_service_1=__webpack_require__(33),_videoService=new WeakMap,_conversationService=new WeakMap,_conferenceService=new WeakMap,_webConferenceService=new WeakMap,_$rootScope=new WeakMap;class BubblesService{constructor(videoService,conversationService,conferenceService,webConferenceService,$rootScope){this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED="rainbowbubblerequesttojoin",this.RAINBOW_ONBUBBLEUPDATED="rainbowbubbleupdated",this.RAINBOW_ONBUBBLEAVATARUPDATED="rainbowbubbleavatarupdated",this.RAINBOW_ONBUBBLEDEACTIVATED="rainbowonbubbledeactivated",_videoService.set(this,videoService),_conversationService.set(this,conversationService),_conferenceService.set(this,conferenceService),_webConferenceService.set(this,webConferenceService),_$rootScope.set(this,$rootScope),$rootScope.$on("$destroy",$rootScope.$on(room_service_1.default.ROOM_UPDATE_EVENT,(event,room)=>this.onBubbleUpdatedEvent(event,room))),$rootScope.$on("$destroy",$rootScope.$on(room_service_1.default.ROOM_AVATAR_UPDATE_EVENT,()=>this.onAvatarUpdatedEvent())),$rootScope.$on("$destroy",$rootScope.$on("ROOM_INVITATION",(event,room)=>this.onRoomInvitationEvent(event,room)))}static get $inject(){return["videoService","conversationService","conferenceService","webConferenceService","$rootScope"]}onBubbleUpdatedEvent(__event,room){room&&!1===room.isActive?EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLEDEACTIVATED,room):EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLEUPDATED,room)}onAvatarUpdatedEvent(){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLEAVATARUPDATED,null)}onRoomInvitationEvent(__event,room){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLEINVITATIONTOJOINRECEIVED,room)}createBubble(strName,strDescription,boolWithHistory=!1,disableNotifications=!1,urlAvatar=null,autoAcceptInvitation=!1){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);let bubble=null;const description=strDescription||"",history=Boolean(boolWithHistory),notifications=Boolean(disableNotifications),autoAccept=Boolean(autoAcceptInvitation);if(!strName)throw new Error("Parameter 'strName' is missing or empty");try{bubble=yield room_service_1.default.createRoom(strName,description,history,urlAvatar,notifications,!1,!1,autoAccept);const conversation=yield conversationService.getRoomConversation(bubble.jid);return RainbowLogger_1.rainbowLogger.sdk(BubblesService.logService+"[createBubble] :: New bubble "+strName+" created successfully"),room_service_1.default.sendInitialRoomPresence(conversation.room),bubble}catch(err){throw err}}))}deleteBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){if(!(bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null))throw new Error("Parameter 'bubble' is missing or null");try{const closedBubble=yield this.closeBubble(bubble);return room_service_1.default.ownerDeleteRoom(closedBubble)}catch(err){throw err}}))}deleteAllBubbles(){return __awaiter(this,void 0,void 0,(function*(){const deleteallBubblePromiseQueue=promiseQueue_1.PromiseQueue.create(),bubbles=room_service_1.default.getMyRooms();try{bubbles.forEach(bubble=>{deleteallBubblePromiseQueue.add(()=>this.deleteBubble(bubble))})}catch(err){throw err}}))}inviteContactToBubble(contact,bubble,boolAsModerator=!1,boolWithInvitation=!0){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!bubble)throw new Error("Parameter 'bubble' is missing or null");let privilege=room_model_1.Room.Privilege.USER;boolAsModerator&&(privilege=room_model_1.Room.Privilege.MODERATOR);let withoutInvitation=!1;"boolean"==typeof boolWithInvitation&&(withoutInvitation=!boolWithInvitation);let isActive=!1,isAway=!1,isInvited=!1,isRejected=!1,isDeleted=!1;if(bubble.users.forEach(user=>{if(user.contact.id===contact.id)switch(user.status){case"invited":isInvited=!0;break;case"accepted":isActive=!0;break;case"unsubscribed":isAway=!0;break;case"rejected":isRejected=!0;break;case"deleted":isDeleted=!0}}),isActive||isInvited)throw new Error("Contact has been already invited or is already a member of the room");if(isAway||isRejected){const updatedBubble=yield room_service_1.default.ownerReinviteRejectedUser(bubble,contact,null,privilege,withoutInvitation);return updatedBubble.updateAvatarInfo(),updatedBubble}if(isDeleted){const updatedBubble=yield room_service_1.default.ownerReinviteDeletedUser(bubble,contact,null,privilege);return updatedBubble.updateAvatarInfo(),updatedBubble}const updatedBubble=yield room_service_1.default.addRoomUser(bubble,contact,null,privilege,withoutInvitation);return updatedBubble.updateAvatarInfo(),updatedBubble}catch(err){throw err}}))}removeContactFromBubble(contact,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!bubble)throw new Error("Parameter 'bubble' is missing or is null");let contactStatus="";switch(bubble.users.forEach(user=>{user.contact.id===contact.id&&(contactStatus=user.status)}),contactStatus){case room_service_1.default.RoomUserStatus.INVITED:{const updatedBubble=yield room_service_1.default.ownerDeletesUserFromRoom(bubble,contact);return updatedBubble.updateAvatarInfo(),updatedBubble}case room_service_1.default.RoomUserStatus.ACCEPTED:{const updatedBubble=yield room_service_1.default.unsubscribeUserFromRoom(bubble,contact);return updatedBubble.updateAvatarInfo(),updatedBubble}default:return bubble}}catch(err){throw err}}))}promoteContactToModerator(contact,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!bubble)throw new Error("Parameter 'bubble' is missing or is null");const updatedBubble=yield room_service_1.default.updateRoomUser(bubble,contact,null,"moderator");return updatedBubble.updateAvatarInfo(),updatedBubble}catch(err){throw err}}))}demoteContactFromModerator(contact,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!bubble)throw new Error("Parameter 'bubble' is missing or is null");const updatedBubble=yield room_service_1.default.updateRoomUser(bubble,contact,null,"user");return updatedBubble.updateAvatarInfo(),updatedBubble}catch(err){throw err}}))}changeOwner(contact,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!bubble)throw new Error("Parameter 'bubble' is missing or is null");const updatedBubble=yield room_service_1.default.changeRoomOwner(bubble,contact);return updatedBubble.updateAvatarInfo(),updatedBubble}catch(err){throw err}}))}acceptInvitationToJoinBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");return yield room_service_1.default.acceptRoomInvitation(bubble),bubble}catch(err){throw err}}))}declineInvitationToJoinBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");return yield room_service_1.default.declineRoomInvitation(bubble)}catch(err){throw err}}))}leaveBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");let hasOtherModerator=!1;if(bubble.users.forEach(user=>{contact_service_1.default.isUserContact(user)||"moderator"===user.privilege&&"accepted"===user.status&&(hasOtherModerator=!0)}),!hasOtherModerator)throw new Error("Can't leave the bubble. No other moderator");switch(bubble.status){case room_service_1.default.RoomUserStatus.UNSUBSCRIBED:return yield room_service_1.default.participantCloseRoom(bubble);default:return yield room_service_1.default.unsubscribeMeFromRoom(bubble)}}catch(err){throw err}}))}closeBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");return this.isBubbleArchived(bubble)||(yield room_service_1.default.ownerArchiveRoom(bubble)),bubble}catch(err){throw err}}))}isBubbleArchived(bubble){let isArchived=!0;return(bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null)?bubble.status!==room_service_1.default.RoomUserStatus.UNSUBSCRIBED?isArchived=!1:bubble.users.forEach(user=>{user.status!==room_service_1.default.RoomUserStatus.UNSUBSCRIBED&&user.status!==room_service_1.default.RoomUserStatus.DELETED&&(isArchived=!1)}):isArchived=!1,isArchived}getAllBubbles(){return room_service_1.default.getRooms()}getAllOwnedBubbles(){return room_service_1.default.getMyRooms()}getAllPendingBubbles(){return room_service_1.default.getRooms().filter(bubble=>"invited"===bubble.status)}getAllInactiveBubbles(){return room_service_1.default.getRooms().filter(bubble=>!1===bubble.isActive)}getBubbleById(strBubbleId){if(!strBubbleId)throw new Error("Parameter 'strBubbleId' is missing or empty");return room_service_1.default.getRoomById(strBubbleId)}updateNameForBubble(strName,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!strName)throw new Error("Parameter 'strName' is missing or empty");if(!bubble)throw new Error("Parameter 'bubble' is missing or empty");return bubble.name=strName,yield room_service_1.default.ownerUpdateRoom(bubble)}catch(err){throw err}}))}updateDescriptionForBubble(strDescription,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!strDescription)throw new Error("Parameter 'strDescription' is missing or empty");if(!bubble)throw new Error("Parameter 'bubble' is missing or empty");return bubble.desc=strDescription,yield room_service_1.default.ownerUpdateRoom(bubble)}catch(err){throw err}}))}updateAvatarForBubble(urlAvatar,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!urlAvatar)throw new Error("Parameter 'urlAvatar' is missing or empty");if(!bubble)throw new Error("Parameter 'bubble' is missing or empty");return bubble.id=bubble.dbId,yield room_service_1.default.setAvatarRoom(bubble,urlAvatar)}catch(err){throw err}}))}deleteAvatarFromBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!bubble)throw new Error("Parameter 'bubble' is missing or empty");return void(yield room_service_1.default.deleteAvatarRoom(bubble.dbId))}catch(err){throw err}}))}updateCustomDataForBubble(customData,bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!customData)throw new Error("Parameter 'customData' is missing or empty");if(!bubble)throw new Error("Parameter 'bubble' is missing or empty");bubble.customData=customData;const updatedCustomData=room_service_1.default.ownerUpdateRoomCustomData(bubble);return bubble.customData=updatedCustomData,bubble}catch(err){throw err}}))}deleteCustomDataForBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null;try{if(!bubble)throw new Error("Parameter 'bubble' is missing or empty");bubble.customData={};const updatedCustomData=yield room_service_1.default.ownerUpdateRoomCustomData(bubble);return bubble.customData=updatedCustomData,bubble}catch(err){throw err}}))}}exports.BubblesService=BubblesService,BubblesService.logService="BubblesService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConferencesService=void 0;const sdkConstant_1=__webpack_require__(28),EventsService_1=__webpack_require__(22),contact_service_1=__webpack_require__(1),profile_service_1=__webpack_require__(8),room_service_1=__webpack_require__(33),_videoService=new WeakMap,_conversationService=new WeakMap,_conferenceService=new WeakMap,_webConferenceService=new WeakMap,_$rootScope=new WeakMap;exports.ConferencesService=class{constructor(videoService,conversationService,conferenceService,webConferenceService,$rootScope){this.confBubble=null,this.confBubbleType="",this.RAINBOW_ONWEBCONFERENCEUPDATED="rainbowwebconferenceupdated",this.RAINBOW_ONWEBRTCMEDIAERROROCCURED="rainbowwebrtcmediaerroroccured",this.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTED="rainbowbubblesharingconferencestarted",this.RAINBOW_ONBUBBLECONFERENCESTARTED="rainbowbubbleconferencestarted",this.RAINBOW_ONBUBBLECONFERENCETALKERACTIVE="rainbowonwebconferencetalkeractive",this.RAINBOW_ONWEBCONFERENCEDELEGATED="rainbowonwebconferencedelegated",_videoService.set(this,videoService),_conversationService.set(this,conversationService),_conferenceService.set(this,conferenceService),_webConferenceService.set(this,webConferenceService),_$rootScope.set(this,$rootScope),$rootScope.$on("$destroy",$rootScope.$on("ON_CONFERENCE_UPDATED_EVENT",(event,conferenceSession)=>this.onConferenceUpdated(event,conferenceSession))),$rootScope.$on("$destroy",$rootScope.$on("ON_WEBRTC_GETUSERMEDIA_ERROR",(event,conferenceSession)=>this.onWebRtcGetUserMediaError(event,conferenceSession))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONFERENCE_PARTICIPANT_EVENT",(event,conferenceSession)=>this.onConferenceParticipantEvent(event,conferenceSession))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONFERENCE_STARTED_INVITATION",(event,room)=>this.onConferenceStartedInvitation(event,room))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONFERENCE_TALKER_EVENT",(event,conferenceSession)=>this.onConferenceTalkerEvent(event,conferenceSession))),$rootScope.$on("$destroy",$rootScope.$on("ON_CONFERENCE_DELEGATED_EVENT",(event,oldConfId,newConfId)=>this.onWebConferenceDelegated(event,oldConfId,newConfId)))}static get $inject(){return["videoService","conversationService","conferenceService","webConferenceService","$rootScope"]}onConferenceUpdated(__event,conferenceSession){conferenceSession&&EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBCONFERENCEUPDATED,conferenceSession)}onWebRtcGetUserMediaError(__event,conferenceSession){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBRTCMEDIAERROROCCURED,conferenceSession)}onConferenceParticipantEvent(__event,conferenceSession){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBCONFERENCEUPDATED,conferenceSession)}onConferenceStartedInvitation(__event,room){const confEndpoints=room.confEndpoints;confEndpoints&&confEndpoints.forEach(confEndpoint=>{"webrtc"===confEndpoint.mediaType&&EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLECONFERENCESTARTED,room),"webrtcSharingOnly"===confEndpoint.mediaType&&EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLESHARINGCONFERENCESTARTED,room)})}onConferenceTalkerEvent(__event,conferenceSession){conferenceSession&&EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONBUBBLECONFERENCETALKERACTIVE,conferenceSession)}onWebConferenceDelegated(__event,oldConfId,newConfId){const detail={oldConferenceId:oldConfId,newConferenceId:newConfId};EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONWEBCONFERENCEDELEGATED,detail)}isWebConferenceAllowed(){return profile_service_1.default.isFeatureEnabled(profile_service_1.default.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)}hasActiveWebConferenceSession(){return _webConferenceService.get(this).hasActiveConferenceSession()}getWebConferenceBubble(){return _webConferenceService.get(this).getRelatedRoomToActiveConferenceSession()}setActiveSpeakerValue(value){return _webConferenceService.get(this).setActiveSpeakerValue(value),value}startOrJoinWebConference(bubble){return __awaiter(this,void 0,void 0,(function*(){const webConferenceService=_webConferenceService.get(this);if(!(bubble=bubble&&bubble.dbId?room_service_1.default.getRoomById(bubble.dbId):null))throw new Error("Parameter 'bubble' is missing or empty");if(this.hasActiveWebConferenceSession())throw new Error("Already in a conference");try{return bubble.confEndpoints.length&&(yield webConferenceService.makeSnapshotForConfId(bubble.confEndpoints[0].confEndpointId,"webrtc",!0)),yield webConferenceService.bubbleStartOrJoinWebConference(bubble),this.confBubble=bubble,this.confBubbleType="webrtc",room_service_1.default.getRoomById(bubble.dbId)}catch(err){throw err}}))}stopWebConference(){return __awaiter(this,void 0,void 0,(function*(){const webConferenceService=_webConferenceService.get(this),conferenceService=_conferenceService.get(this);if(this.confBubble=this.confBubble&&this.confBubble.dbId?room_service_1.default.getRoomById(this.confBubble.dbId):null,!this.hasActiveWebConferenceSession()||!this.confBubble)throw new Error("No known conference in a Bubble");let id="";id="webrtc"===this.confBubbleType?this.confBubble.getSFUConfEndpointId():this.confBubble.getSFUSharingConfEndpointId();const sharingConfSession=webConferenceService.getConferenceSessionById(id),participant=sharingConfSession?sharingConfSession.getParticipantByJid(contact_service_1.default.userContact.jid):null;try{return"moderator"!==participant.role?(yield conferenceService.disconnectsParticipant(id,participant.participantId,this.confBubbleType),this.confBubble=null,void(this.confBubbleType=null)):(yield conferenceService.stopConference(id,"webrtc",this.confBubble.dbId),this.confBubble=null,void(this.confBubbleType=null))}catch(err){throw err}}))}muteConferenceAudio(conferenceSession){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this),participantId=conferenceSession.getConnectedParticipantByJid(contact_service_1.default.userContact.jid).participantId;if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");if(!participantId)throw new Error("Couldn't retrieve participant ID - make sure the conference is active and you are connected");try{return void(yield conferenceService.updateParticipantState(conferenceSession.id,participantId,"mute","webrtc"))}catch(err){throw err}}))}unmuteConferenceAudio(conferenceSession){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this),participantId=conferenceSession.getConnectedParticipantByJid(contact_service_1.default.userContact.jid).participantId;if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");if(!participantId)throw new Error("Couldn't retrieve participant ID - make sure the conference is active and you are connected");try{return void(yield conferenceService.updateParticipantState(conferenceSession.id,participantId,"unmute","webrtc"))}catch(err){throw err}}))}muteConferenceParticipant(conferenceSession,participantId){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this);if("moderator"!==conferenceSession.getConnectedParticipantByJid(contact_service_1.default.userContact.jid).role)throw new Error("You need to be a moderator of the conference to mute the other participants");if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");if(!participantId)throw new Error("Parameter 'participantId' is missing or empty");try{yield conferenceService.updateParticipantState(conferenceSession.id,participantId,"mute","webrtc")}catch(err){throw err}}))}unmuteConferenceParticipant(conferenceSession,participantId){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this);if("moderator"!==conferenceSession.getConnectedParticipantByJid(contact_service_1.default.userContact.jid).role)throw new Error("You need to be a moderator of the conference to mute the other participants");if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");if(!participantId)throw new Error("Parameter 'participantId' is missing or empty");try{return void(yield conferenceService.updateParticipantState(conferenceSession.id,participantId,"unmute","webrtc"))}catch(err){throw err}}))}muteAllConferenceParticipants(conferenceSession){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this);if("moderator"!==conferenceSession.getConnectedParticipantByJid(contact_service_1.default.userContact.jid).role)throw new Error("You need to be a moderator of the conference to mute the other participants");if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");const participants=conferenceSession.participants;try{for(let i=0;i<participants.length;i++)"moderator"!==participants[i].role&&(yield conferenceService.updateParticipantState(conferenceSession.id,participants[i].participantId,"mute","webrtc"));return}catch(err){throw err}}))}unmuteAllConferenceParticipants(conferenceSession){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this);if("moderator"!==conferenceSession.getConnectedParticipantByJid(contact_service_1.default.userContact.jid).role)throw new Error("You need to be a moderator of the conference to mute the other participants");if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");const participants=conferenceSession.participants;try{for(let i=0;i<participants.length;i++)"moderator"!==participants[i].role&&(yield conferenceService.updateParticipantState(conferenceSession.id,participants[i].participantId,"unmute","webrtc"));return}catch(err){throw err}}))}addVideoToConference(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");return webConferenceService.addMediaToConferenceSession(conferenceSession,"video")}addSharingToConference(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");return webConferenceService.addMediaToConferenceSession(conferenceSession,"sharing")}removeVideoFromConference(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");return webConferenceService.removeMediaFromConferenceSession(conferenceSession,"video"),conferenceSession}removeSharingFromConference(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");return webConferenceService.removeMediaFromConferenceSession(conferenceSession,"sharing"),conferenceSession}showLocalVideo(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");return webConferenceService.attachLocalMediaStream(!0,conferenceSession),webConferenceService.isActiveSpeakerEnabled(),conferenceSession}showRemoteVideo(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");return webConferenceService.isActiveSpeakerEnabled()?webConferenceService.attachGalleryMediaStreams(conferenceSession):webConferenceService.attachDistantMediaStream(!0,conferenceSession),conferenceSession}getConferenceSessionById(conferenceId){const webConferenceService=_webConferenceService.get(this);if(!conferenceId)throw new Error("Parameter 'conferenceId' is missing or empty");return webConferenceService.getConferenceSessionById(conferenceId)}updateGalleryPublisher(conferenceSession,galleryElementId,newPublisher){return __awaiter(this,void 0,void 0,(function*(){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");if(!galleryElementId)throw new Error("Parameter 'galleryElementId' is missing or empty");if(!newPublisher)throw new Error("Parameter 'newPublisher' is missing or empty");const existingPublisher=webConferenceService.getRelatedPublisherToElement(conferenceSession.id,galleryElementId);try{if(existingPublisher)for(let i=0;i<conferenceSession.videoGallery.length;i++)conferenceSession.videoGallery[i].id===galleryElementId&&(conferenceSession.videoGallery[i].sessionId?webConferenceService.dropRemoteVideoSession(conferenceSession,conferenceSession.videoGallery[i].sessionId):webConferenceService.reInitialiseVideoGalleryElementById(conferenceSession,galleryElementId));return void(yield webConferenceService.subscribeToPublisher(conferenceSession.id,newPublisher,galleryElementId))}catch(err){throw err}}))}removeGalleryPublisher(conferenceSession,galleryElementId){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");if(!galleryElementId)throw new Error("Parameter 'galleryElementId' is missing or empty");return webConferenceService.dropRemoteVideoSession(conferenceSession,galleryElementId),{code:sdkConstant_1.SDK.OK,label:`Publisher from ${galleryElementId} successfuly removed`}}setVideoGalleryElementsNumber(elementsNumber){return _webConferenceService.get(this).setVideoGalleryElementsNumber(elementsNumber),elementsNumber}removePipVideo(){return _videoService.get(this).removeConferencePip()}updateMainVideoSession(conferenceId,sessionId){const webConferenceService=_webConferenceService.get(this);try{if(conferenceId){if(sessionId){webConferenceService.updateMainScreenSession(conferenceId,sessionId);const conferenceSession=webConferenceService.getConferenceSessionById(conferenceId);return webConferenceService.attachDistantMediaStream(!0,conferenceSession),webConferenceService.getConferenceSessionById(conferenceId)}throw new Error("Parameter 'sessionId' is missing or empty")}throw new Error("Parameter 'conferenceId' is missing or empty")}catch(err){throw err}}disconnectParticipant(conferenceId,participantId,mediaType="webrtc"){return __awaiter(this,void 0,void 0,(function*(){const conferenceService=_conferenceService.get(this);if(!conferenceId)throw new Error("Parameter 'conferenceId' is missing or empty");if(!participantId)throw new Error("Parameter 'participantId' is missing or empty");try{return void(yield conferenceService.disconnectsParticipant(conferenceId,participantId,mediaType))}catch(err){throw err}}))}getListOfAvailableRemoteVideoPublishers(conferenceSession){const webConferenceService=_webConferenceService.get(this);if(!conferenceSession)throw new Error("Parameter 'conferenceSession' is missing or empty");const publishers={all:[],notActive:[]};return publishers.all=conferenceSession.getListOfRemoteVideoPublishers(),publishers.notActive=webConferenceService.getListOfAvailableRemoteVideoPublishers(conferenceSession.id),publishers}delegateConferenceToParticipant(conferenceId,participantId){return __awaiter(this,void 0,void 0,(function*(){const webConferenceService=_webConferenceService.get(this);try{if(!conferenceId)throw new Error("Parameter 'conferenceId' is missing or empty");if(!participantId)throw new Error("Parameter 'participantId' is missing or empty");return yield webConferenceService.delegateConferenceToParticipant(conferenceId,participantId)}catch(err){throw err}}))}}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GroupsService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),group_model_1=__webpack_require__(44),sdkConstant_1=__webpack_require__(28),_$rootScope=new WeakMap,_groupService=new WeakMap;class GroupsService{constructor(groupService,$rootScope){this.RAINBOW_ONGROUPCREATED="rainbowgroupcreated",this.RAINBOW_ONGROUPUPDATED="rainbowgroupupdated",this.RAINBOW_ONGROUPDELETED="rainbowgroupdeleted",this.RAINBOW_ONGROUPUSERADDED="rainbowgroupuseradded",this.RAINBOW_ONGROUPUSERREMOVED="rainbowgroupuserdeleted",_groupService.set(this,groupService),_$rootScope.set(this,$rootScope),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_UPDATE_GROUP_EVENT,(event,groupId)=>this.onGroupUpdated(event,groupId))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_CREATED_GROUP_EVENT,(event,groupId)=>this.onGroupCreated(event,groupId))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_REMOVED_GROUP_EVENT,(event,groupId)=>this.onGroupDeleted(event,groupId))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_ADD_GROUP_USER_EVENT,(event,groupId,userId)=>this.onGroupUserAdded(event,groupId,userId))),$rootScope.$on("$destroy",$rootScope.$on(groupService.ON_REMOVE_GROUP_USER_EVENT,(event,groupId,userId)=>this.onGroupUserRemoved(event,groupId,userId)))}static get $inject(){return["groupService","$rootScope"]}onGroupUpdated(__event,groupId){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{const group=yield groupService.getGroup(groupId);EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONGROUPUPDATED,group)}catch(err){throw err}}))}onGroupCreated(__event,groupId){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{const group=yield groupService.getGroup(groupId);EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONGROUPCREATED,group)}catch(err){throw err}}))}onGroupDeleted(__event,groupId){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONGROUPDELETED,groupId)}onGroupUserAdded(__event,groupId,userId){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{const group=yield groupService.getGroup(groupId);EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONGROUPUSERADDED,{group:group,userId:userId})}catch(err){throw err}}))}onGroupUserRemoved(__event,groupId,userId){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{const group=yield groupService.getGroup(groupId);EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONGROUPUSERREMOVED,{group:group,userId:userId})}catch(err){throw err}}))}createGroup(strName,strDescription,isFavorite){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{let group=null;const comment=strDescription||"";let boolFavorite=!1;if("boolean"==typeof isFavorite&&(boolFavorite=isFavorite),!strName)throw new Error("Parameter 'strName' is missing or empty");group=new group_model_1.Group(null,strName,comment,boolFavorite);const newGroup=yield groupService.addGroup(group);return RainbowLogger_1.rainbowLogger.sdk(GroupsService.logService+"[createGroup] :: New group created successfully"),newGroup}catch(err){throw err}}))}deleteGroup(group){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{if(!group)throw new Error("Parameter 'group' is missing or empty");return yield groupService.removeGroup(group.id),RainbowLogger_1.rainbowLogger.sdk(GroupsService.logService+"[deleteGroup] :: Group deleted successfully"),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}deleteAllGroups(){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{const PromiseQueue=[],groups=groupService.getGroupsAsArray(),deleteGroupPromise=group=>groupService.removeGroup(group.id);return groups.forEach(group=>{PromiseQueue.push(deleteGroupPromise(group))}),yield Promise.all(PromiseQueue),RainbowLogger_1.rainbowLogger.sdk(GroupsService.logService+"[deleteAllGroups] :: All groups deleted successfully"),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}getAll(){return _groupService.get(this).getGroupsAsArray()}getFavoritesGroups(){return _groupService.get(this).getGroupsAsArray().filter(group=>group.isFavorite)}setGroupAsFavorite(group){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{return group.isFavorite=!0,yield groupService.updateGroup(group),group}catch(err){throw err}}))}unsetGroupAsFavorite(group){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{return group.isFavorite=!1,yield groupService.updateGroup(group),group}catch(err){throw err}}))}getGroupById(groupId){const groupService=_groupService.get(this);let theGroup=null;return groupService.getGroupsAsArray().some(group=>groupId===group.id&&(theGroup=group,!0)),theGroup}getDetailedGroupById(id){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{if(!id)throw new Error("Parameter 'id' is missing or empty");return yield groupService.getGroup(id)}catch(err){throw err}}))}addContactInGroup(contact,group){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!group)throw new Error("Parameter 'group' is missing or null");const updatedGroup=yield groupService.addGroupUser(group,contact);return RainbowLogger_1.rainbowLogger.sdk(GroupsService.logService+"[addContactInGroup] :: Contact added successfully"),updatedGroup}catch(err){throw err}}))}removeContactFromGroup(contact,group){return __awaiter(this,void 0,void 0,(function*(){const groupService=_groupService.get(this);try{if(!contact)throw new Error("Parameter 'contact' is missing or null");if(!group)throw new Error("Parameter 'group' is missing or null");return groupService.removeGroupUser(group.id,contact)}catch(err){throw err}}))}}exports.GroupsService=GroupsService,GroupsService.logService="GroupService  | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallsLogService=void 0;const EventsService_1=__webpack_require__(22),_$rootScope=new WeakMap,_callLogService=new WeakMap;exports.CallsLogService=class{constructor($rootScope,callLogService){this.RAINBOW_ONCALLLOGUPDATED="rainbowcalllogupdated",this.RAINBOW_ONCALLLOGACKUPDATED="rainbowcalllogackupdated",this.initialized=!1,_$rootScope.set(this,$rootScope),_callLogService.set(this,callLogService),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_LOG_UPDATED",()=>this.onCallLogUpdated())),$rootScope.$on("$destroy",$rootScope.$on("ON_CALL_LOG_ACK_UPDATED",(event,data)=>this.onCallLogAckUpdated(event,data)))}static get $inject(){return["$rootScope","callLogService"]}onCallLogUpdated(){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCALLLOGUPDATED,null)}onCallLogAckUpdated(__event,data){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCALLLOGACKUPDATED,data)}getAll(){return __awaiter(this,void 0,void 0,(function*(){const callLogService=_callLogService.get(this);try{const callLogs=yield callLogService.getSimplifiedCallLogs();for(let i=0;i<callLogs.length;i++){let durationMs=0,hmmss=callLogs[i].duration;if(hmmss&&"string"==typeof hmmss&&hmmss.match(/^(?:(?:([01]?\d|2[0-3])h )?([0-5]?\d)m )?([0-5]?\ds)$/)){hmmss=hmmss.replace(/[hms]/g,"");const parts=hmmss.split(" ").reverse();for(let j=0;j<parts.length;j++)durationMs+=parts[j]*Math.pow(60,j);callLogs[i].duration=1e3*durationMs}}return callLogs}catch(err){throw err}}))}getMissedCallLogCounter(){return _callLogService.get(this).getMissedCallLogCounter()}getMissedCallLogNumber(){return _callLogService.get(this).getNumberMissedCallLogs()}deleteOneCallLog(id){return _callLogService.get(this).deleteOneCallLog(id),!0}deleteCallLogsForContact(jid){return _callLogService.get(this).deleteCallLogsForContact(jid)}deleteAllCallLogs(){return _callLogService.get(this).deleteAllCallLogs()}markCallLogAsRead(id){return _callLogService.get(this).markCallLogAsRead(id)}markAllCallsLogsAsRead(){return _callLogService.get(this).markAllCallsLogsAsRead()}isInitialized(){return this.initialized}}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FavoritesService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),_favoriteService=new WeakMap;class FavoritesService{constructor(favoriteService){this.RAINBOW_ONFAVORITECREATED="rainbowonfavoritecreated",this.RAINBOW_ONFAVORITEDELETED="rainbowonfavoritedeleted",_favoriteService.set(this,favoriteService),window.addEventListener("ON_FAVORITE_CREATED",event=>this.onFavoriteCreated(event)),window.addEventListener("ON_FAVORITE_DELETED",event=>this.onFavoriteDeleted(event))}static get $inject(){return["favoriteService"]}onFavoriteCreated(event){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONFAVORITECREATED,event.detail)}onFavoriteDeleted(event){EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONFAVORITEDELETED,event.detail)}fetchAllFavorites(){return __awaiter(this,void 0,void 0,(function*(){const favoriteService=_favoriteService.get(this);try{const favorites=yield favoriteService.getServerFavorites();return RainbowLogger_1.rainbowLogger.sdk(FavoritesService.logService+"[fetchAllFavorites] :: Successfully fetched the Favorites"),favorites}catch(err){throw err}}))}createFavorite(id,favoriteType){return __awaiter(this,void 0,void 0,(function*(){const favoriteService=_favoriteService.get(this);try{if(!id)throw RainbowLogger_1.rainbowLogger.sdk(FavoritesService.logService+"[createFavorite] :: Error: parameter 'id' is missing or null"),new Error(FavoritesService.logService+"[createFavorite] :: Error: parameter 'id' is missing or null");if(!favoriteType)throw RainbowLogger_1.rainbowLogger.sdk(FavoritesService.logService+"[createFavorite] :: Error: parameter 'favoriteType' is missing or null"),new Error(FavoritesService.logService+"[createFavorite] :: Error: parameter 'favoriteType' is missing or null");if("bubble"!==favoriteType&&"user"!==favoriteType)throw RainbowLogger_1.rainbowLogger.sdk(FavoritesService.logService+'[createFavorite] :: Error: favoriteType should be set to "user" or "bubble"'),new Error(FavoritesService.logService+'[createFavorite] :: Error: favoriteType should be set to "user" or "bubble"');return"bubble"===favoriteType&&(favoriteType="room"),void(yield favoriteService.addServerFavorite(id,favoriteType))}catch(err){throw err}}))}deleteFavorite(id){return __awaiter(this,void 0,void 0,(function*(){const favoriteService=_favoriteService.get(this);try{if(!id)throw RainbowLogger_1.rainbowLogger.sdk(FavoritesService.logService+"[deleteFavorite] :: Error: parameter 'id' is missing or null"),new Error(FavoritesService.logService+"[deleteFavorite] :: Error: parameter 'id' is missing or null");return void(yield favoriteService.removeServerFavorite(id))}catch(err){throw err}}))}}exports.FavoritesService=FavoritesService,FavoritesService.logService="FavoritesService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FilesStorageService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),contact_service_1=__webpack_require__(1),fileStorage_service_1=__webpack_require__(25),_$rootScope=new WeakMap,_Conversation=new WeakMap,_fileServerService=new WeakMap,_conversationService=new WeakMap;class FilesStorageService{constructor(Conversation,fileServerService,conversationService,$rootScope){this.RAINBOW_ONFILEUPLOADED_ERROR="rainbowfileuploadederror",this.RAINBOW_ONFILEDOWNLOADED="rainbowonfiledownloaded",this.RAINBOW_ONFILEDOWNLOADED_ERROR="rainbowfiledownloadederror",this.RAINBOW_ONCHUNKLOADMESSAGE="rainbowonchunkloadmessage",this.RAINBOW_ONFILEUPLOADED="rainbowfileuploaded",this.eventsMap={success:{download:this.RAINBOW_ONFILEDOWNLOADED,upload:this.RAINBOW_ONFILEUPLOADED},error:{download:this.RAINBOW_ONFILEDOWNLOADED_ERROR,upload:this.RAINBOW_ONFILEUPLOADED_ERROR}},_Conversation.set(this,Conversation),_fileServerService.set(this,fileServerService),_conversationService.set(this,conversationService),_$rootScope.set(this,$rootScope),$rootScope.$on("$destroy",$rootScope.$on("ON_FILE_TRANSFER_EVENT",(event,data)=>this.onFileTransferChanged(event,data)))}static get inject(){return["Conversation","fileServerService","conversationService","$rootScope"]}onFileTransferChanged(__event,data){data.result&&data.type?(RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[onFileTransferChanged] ::  File transfered"),EventsService_1.eventsService.dispatchEvent(this.eventsMap[data.result][data.type],data)):"uploading"!==(data=data.fileDesc).state&&"downloading"!==data.state||EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHUNKLOADMESSAGE,data)}addFileToConversation(conversation,file,data){const conversationService=_conversationService.get(this);return new Promise((resolve,reject)=>{if("string"==typeof file){const xhr=new XMLHttpRequest;xhr.open("GET",file,!0),xhr.onreadystatechange=()=>{if(xhr.readyState===XMLHttpRequest.DONE){const blob=xhr.response,_file=new File([blob],file.replace(/^.*[\\/]/,""));if(_file.size>1e8)return reject("The file is too large (limited to 100MB)");conversationService.sendFSMessage(conversation,_file,data).then(message=>resolve(message))}},xhr.responseType="blob",xhr.send()}else{if(file.size>1e8)return reject("The file is too large (limited to 100MB)");conversationService.sendFSMessage(conversation,file,data).then(message=>resolve(message))}})}uploadFileToConversation(conversation,file,message){return __awaiter(this,void 0,void 0,(function*(){const Conversation=_Conversation.get(this);try{if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(!file)throw new Error("Parameter 'file' is missing or null");if(conversation.type!==Conversation.Type.ONE_TO_ONE)throw new Error("Parameter 'conversation' is not a one-to-one conversation");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[uploadFileToConversation] ::  Add file to the conversation "+conversation.id);return yield this.addFileToConversation(conversation,file,message)}catch(err){throw err}}))}uploadFile(file,message,progressCallback){return __awaiter(this,void 0,void 0,(function*(){const fileServerService=_fileServerService.get(this);try{if(!file)throw new Error("Parameter 'file' is missing or null");const fileDescriptor=yield fileStorage_service_1.default.createFileDescriptor(file.name,file.name.split(".").pop(),file.size,[],!1);return yield fileServerService.uploadAFileByChunk(fileDescriptor,file,message,progressCallback)}catch(err){throw err}}))}uploadExistingFileToConversation(conversation,fileDescriptor,message=""){return __awaiter(this,void 0,void 0,(function*(){const conversationService=_conversationService.get(this);try{if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(!fileDescriptor)throw new Error("Parameter 'fileDescriptor' is missing or null");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[uploadExistingFileToConversation] ::  Upload existing file to conversation "+conversation.id);return yield conversationService.sendEFSMessage(conversation,fileDescriptor,message)}catch(err){throw err}}))}uploadFileToBubble(bubble,file,message){return __awaiter(this,void 0,void 0,(function*(){const Conversation=_Conversation.get(this),conversationService=_conversationService.get(this);try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");if(!file)throw new Error("Parameter 'file' is missing or null");const conversation=conversationService.getConversationByRoomDbId(bubble.dbId);if(!conversation)throw new Error("Parameter 'bubble' don't have a conversation");if(conversation.type!==Conversation.Type.ROOM)throw new Error("Parameter 'conversation' is not a bubble conversation");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[uploadFileToBubble] ::  Trying to add a file to the bubble "+bubble.dbId);return yield this.addFileToConversation(conversation,file,message)}catch(err){throw err}}))}downloadFile(fileDescriptor){return __awaiter(this,void 0,void 0,(function*(){const fileServerService=_fileServerService.get(this);try{if(!fileDescriptor)throw new Error("Parameter 'fileDescriptor' is missing or null");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[downloadFile] ::  Trying to get a file");return yield fileServerService.getBlobFromFileDescriptor(fileDescriptor,!0)}catch(err){throw err}}))}removeFile(fileDescriptor){return __awaiter(this,void 0,void 0,(function*(){try{if(!fileDescriptor)throw new Error("Parameter 'fileDescriptor' is missing or null");if(fileDescriptor.id||fileDescriptor.url){RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[removeFile] ::  Trying to remove a file");let fileDescriptorId=fileDescriptor.id;if(!fileDescriptorId){const parts=fileDescriptor.url.split("/");fileDescriptorId=parts.pop()||parts.pop()}return yield fileStorage_service_1.default.deleteFileDescriptor(fileDescriptorId),void RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[removeFile] ::  File removed")}throw new Error("Parameter 'fileDescriptor' does not contain sufficient information to remove the file - no id or url property")}catch(err){throw err}}))}getFileDescriptorFromId(id){return RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[getFileDescriptorFromId] ::  Get file descriptor "+id),fileStorage_service_1.default.getFileDescriptorById(id)}getFileDescriptorUrl(fileDescriptor,thumbnail){return __awaiter(this,void 0,void 0,(function*(){const fileServerService=_fileServerService.get(this);try{return yield fileServerService.getFileDescriptorUrl(fileDescriptor,thumbnail)}catch(err){throw err}}))}getFilesReceivedInConversation(conversation){return __awaiter(this,void 0,void 0,(function*(){const Conversation=_Conversation.get(this);try{if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(conversation.type!==Conversation.Type.ONE_TO_ONE)throw new Error("Parameter 'conversation' is not a one-to-one conversation");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[getFilesReceivedInConversation] ::  Get files received in conversation "+conversation.id+"...");const files=yield fileStorage_service_1.default.retrieveFilesReceivedFromPeer(contact_service_1.default.userContact.dbId,conversation.contact.dbId);return RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[getFilesReceivedInConversation] ::  Shared "+files.length),files}catch(err){throw err}}))}getFilesReceivedInBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[getFilesReceivedInBubble] ::  Get files received in bubble "+bubble.dbId);return yield fileStorage_service_1.default.retrieveReceivedFilesForRoom(bubble.dbId)}catch(err){throw err}}))}getFilesSentInConversation(conversation){return __awaiter(this,void 0,void 0,(function*(){const Conversation=_Conversation.get(this);try{if(!conversation)throw new Error("Parameter 'conversation' is missing or null");if(conversation.type!==Conversation.Type.ONE_TO_ONE)throw new Error("Parameter 'conversation' is not a one-to-one conversation");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[getFilesSentInConversation] :: Get files sent in conversation "+conversation.id);return fileStorage_service_1.default.retrieveSentFiles(conversation.contact.dbId)}catch(err){throw err}}))}getFilesSentInBubble(bubble){return __awaiter(this,void 0,void 0,(function*(){try{if(!bubble)throw new Error("Parameter 'bubble' is missing or null");RainbowLogger_1.rainbowLogger.sdk(FilesStorageService.logService+"[getFilesSentInBubble] :: Get files sent in bubble "+bubble.dbId);return fileStorage_service_1.default.retrieveSentFiles(bubble.dbId)}catch(err){throw err}}))}getUserQuotaConsumption(){return __awaiter(this,void 0,void 0,(function*(){try{return fileStorage_service_1.default.retrieveUserConsumption()}catch(err){throw err}}))}getAllFilesSent(){return fileStorage_service_1.default.getDocuments("date",!1)}getAllFilesReceived(){return fileStorage_service_1.default.getDocuments("date",!0)}cancelCurrentFileTransfer(id){return __awaiter(this,void 0,void 0,(function*(){const fileServerService=_fileServerService.get(this);try{if(!id)throw new Error("Parameter 'id' is missing or null");const fileDescriptor=fileStorage_service_1.default.getFileDescriptorById(id);if(null===fileDescriptor)throw new Error("Could not find a file with the id "+id);if("downloading"!==fileDescriptor.state&&"uploading"!==fileDescriptor.state)throw new Error("File Status is not set to 'downloading' or 'uploading'");return fileServerService.cancelCurrentFiletransfer(id),"not_uploaded"!==fileDescriptor.state&&"uploading"!==fileDescriptor.state?(fileDescriptor.state="uploaded",fileDescriptor):"not_uploaded"!==fileDescriptor.state&&"uploading"===fileDescriptor.state?(fileDescriptor.state="not_uploaded",fileDescriptor):fileDescriptor}catch(err){throw err}}))}}exports.FilesStorageService=FilesStorageService,FilesStorageService.logService="FilesStorageService | "},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CapabilitiesService=void 0;const profile_service_1=__webpack_require__(8);exports.CapabilitiesService=class{constructor(){}getAll(){return profile_service_1.default.getMyProfileFeatures()}getUserSubscription(){return profile_service_1.default.getMyProfileName()}isFeatureEnabled(featureString){return profile_service_1.default.isFeatureEnabled(featureString)}hasS4BExtensionEnabled(){return profile_service_1.default.isFeatureEnabled("MS_SKYPE_PLUGIN")}hasOutlookExtensionEnabled(){return profile_service_1.default.isFeatureEnabled("MS_OUTLOOK_PLUGIN")}hasCalendarPresenceEnabled(){return profile_service_1.default.isFeatureEnabled("MSO365_CALENDAR_PRESENCE")}hasTelephonyBasicCallEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_BASIC_CALL")}hasTelephonySecondCallEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_SECOND_CALL")}hasTelephonyTransferCallEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_TRANSFER_CALL")}hasTelephonyConferenceCallEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_CONFERENCE_CALL")}hasTelephonyDeflectCallEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_DEFLECT_CALL")}hasTelephonyForwardCallEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_FORWARD_CALL")}hasTelephonyPhoneBookEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_PHONE_BOOK")}hasTelephonyVoiceMailEnabled(){return profile_service_1.default.isFeatureEnabled("TELEPHONY_VOICE_MAIL")}hasWebRTCAudioMobileEnabled(){return profile_service_1.default.isFeatureEnabled("WEBRTC_FOR_MOBILE")}hasWebRTCVideoMobileEnabled(){return profile_service_1.default.isFeatureEnabled("WEBRTC_FOR_MOBILE_VIDEO")}hasBridgeConferenceEnabled(){return profile_service_1.default.isFeatureEnabled("CONFERENCE_ALLOWED")}hasBridgeConferenceRecordEnabled(){return profile_service_1.default.isFeatureEnabled("CONFERENCE_RECORDING")}hasBridgeConferenceDialOutEnabled(){return profile_service_1.default.isFeatureEnabled("CONFERENCE_DIAL_OUT")}maxParticipantsPerBubbleAllowed(){return profile_service_1.default.getFeatureLimitMax("BUBBLE_PARTICIPANT_COUNT")}maxParticipantsPerBridgeConferenceAllowed(){return profile_service_1.default.getFeatureLimitMax("CONFERENCE_PARTICIPANT_COUNT")}maxFileStorageQuotaAllowed(){return profile_service_1.default.getFeatureLimitMax("FILE_SHARING_QUOTA_GB")}}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AdminService=void 0;const _User=new WeakMap,_adminCompanyService=new WeakMap,_adminUserService=new WeakMap,company_model_1=__webpack_require__(19);class AdminService{constructor(User,adminCompanyService,adminUserService){this.logService="AdminService | ",_User.set(this,User),_adminCompanyService.set(this,adminCompanyService),_adminUserService.set(this,adminUserService)}static get $inject(){return["User","adminCompanyService","adminUserService"]}static getInstance(){return this.instance||(this.instance=new AdminService("User","adminCompanyService","adminUserService")),this.instance}createEssentialCompany(strName,strCountry){return __awaiter(this,void 0,void 0,(function*(){const adminCompanyService=_adminCompanyService.get(this),company=company_model_1.Company.create(null,"");company.name=strName,company.country=strCountry;try{return yield adminCompanyService.createCompanyEndUser(company)}catch(err){throw err}}))}createCompany(strName,strCountry,strState){return __awaiter(this,void 0,void 0,(function*(){const adminCompanyService=_adminCompanyService.get(this),company=company_model_1.Company.create(null,"");company.name=strName,company.country=strCountry,strState&&(company.state=strState),company.economicActivityClassification="";try{return yield adminCompanyService.createCompany(company)}catch(err){throw err}}))}removeCompany(company){return __awaiter(this,void 0,void 0,(function*(){const adminCompanyService=_adminCompanyService.get(this);try{return yield adminCompanyService.deleteCompany(company.id)}catch(err){throw err}}))}createUserForCompany(strLogin,strFirstName,strLastName,strPassword,company,tags){return __awaiter(this,void 0,void 0,(function*(){const User=_User.get(this),adminUserService=_adminUserService.get(this),user=User.create();user.loginEmail=strLogin,user.firstName=strFirstName,user.lastName=strLastName,user.password=strPassword,user.language="en",user.companyId=company.id,user.adminType="undefined",user.isActive=!0,user.isInitialized=!0,tags&&(user.tags=tags&&Array.isArray(tags)?tags:[tags]);try{return yield adminUserService.createUser(user)}catch(err){throw err}}))}removeUserFromCompany(user){return __awaiter(this,void 0,void 0,(function*(){const adminUserService=_adminUserService.get(this);try{return yield adminUserService.deleteUser(user)}catch(err){throw err}}))}fetchUsersByTag(searchPattern,page=1,pageSize=10){return __awaiter(this,void 0,void 0,(function*(){const adminUserService=_adminUserService.get(this);try{return yield adminUserService.getUsers(null,page,pageSize,searchPattern,!1,null,!1,!0)}catch(err){throw err}}))}updateUserTags(user,tags){return __awaiter(this,void 0,void 0,(function*(){const adminUserService=_adminUserService.get(this);if(!user)throw new Error(this.logService+"[updateUserTags] :: Error: parameter 'user' is missing or null");if(!user.id)throw new Error(this.logService+"[updateUserTags] :: Error: parameter 'user.id' is missing or null");if(tags instanceof Array!=!0)throw new Error(this.logService+"[updateUserTags] :: Error: parameter 'tags' must be an array");if(tags instanceof Array&&(tags.length<1||tags.length>5))throw new Error(this.logService+"[updateUserTags] :: Error: parameter 'tags' must be an array with at least 1 and maximum 5 elements");try{return yield adminUserService.updateUser(user)}catch(err){throw err}}))}setVisibilityForCompany(company,visibleByCompany){return __awaiter(this,void 0,void 0,(function*(){const adminCompanyService=_adminCompanyService.get(this);try{return yield adminCompanyService.addVisibility(company.id,visibleByCompany.id)}catch(err){throw err}}))}}exports.AdminService=AdminService},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChannelsService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),sdkConstant_1=__webpack_require__(28),contact_service_1=__webpack_require__(1),_$rootScope=new WeakMap,_channelService=new WeakMap;class ChannelsService{constructor($rootScope,channelService){this.RAINBOW_ONCHANNELUPDATED="rainbowchannelupdate",this.RAINBOW_ONCHANNELMESSAGERECEIVED="rainbowchannelmessagereceived",this.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED="rainbowchannelretractmessage",this.RAINBOW_ONCHANNELDELETED="rainbowchanneldeleted",this.RAINBOW_ONCHANNELAVATARUPDATED="rainbowchannelavatarupdate",this.RAINBOW_ONCHANNELUSERSUBSCRIBED="rainbowchannelusersubscribed",this.RAINBOW_ONCHANNELUSERUNSUBSCRIBED="rainbowchanneluserunsubscribed",_$rootScope.set(this,$rootScope),_channelService.set(this,channelService),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_MESSAGE_RECEIVED",(event,messageType,message)=>this.onMessageReceived(event,messageType,message))),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_UPDATE_EVENT",(event,updateType,id)=>this.onChannelUpdated(event,updateType,id))),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_USERS_UPDATE_EVENT",(event,id,users)=>this.onChannelUsersUpdated(event,id,users))),$rootScope.$on("$destroy",$rootScope.$on("ON_UPDATE_CHANNEL_AVATAR",(event,id)=>this.onChannelAvatarUpdated(event,id))),$rootScope.$on("$destroy",$rootScope.$on("CHANNEL_USER_SUBSCRIPTION_EVENT",(event,userType,channelId,userId)=>this.onUserSubscriptionChange(event,userType,channelId,userId)))}static get $inject(){return["$rootScope","channelService"]}onMessageReceived(__event,messageType,message){const channelId=message.channelId?message.channelId:message;RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT onMessageReceived"),this.fetchChannel(channelId).then(channel=>{0===messageType?EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELMESSAGERECEIVED,message):(RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT onMessageReceived - retracted message"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELRETRACTMESSAGERECEIVED,{channel:channel,message:message}))})}onChannelUpdated(__event,updateType,id){RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT: onChannelUpdated("+updateType+") id:"+id),3!==updateType?this.fetchChannel(id).then(channel=>{EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELUPDATED,{channel:channel,updateType:updateType})}):EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELDELETED,id)}onChannelUsersUpdated(__event,id,users){RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT onChannelUsersUpdated:"+id),this.fetchChannel(id).then(channel=>{EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELUPDATED,{channel:channel,users:users})})}onChannelAvatarUpdated(__event,id){this.fetchChannel(id).then(channel=>{RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT onChannelAvatarUpdated"+channel.id),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELAVATARUPDATED,channel)})}onUserSubscriptionChange(__event,userType,channelId,userId){let channel=null;this.fetchChannel(channelId).then(channelFound=>(channel=channelFound,contact_service_1.default.getContactByDBId(userId,!0))).then(user=>{user=user||userId,4===userType?(RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT onUserSubscriptionChange: user subscribed to a channel: "+channelId),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELUSERSUBSCRIBED,{channel:channel,user:user})):(RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[ChannelsService] :: EVENT onUserSubscriptionChange: user unsubscribed from a channel: "+channelId),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONCHANNELUSERUNSUBSCRIBED,{channel:channel,user:user}))})}fetchMyChannels(){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);try{return yield channelService.getMyChannels()}catch(err){throw err}}))}createPublicChannel(channelName,channelTopic="",category=""){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[createPublicChannel] :: Trying to create a new public channel");try{if(!channelName)throw new Error("Parameter 'channelName' is missing or empty");const mode="company_public",channel=yield channelService.createChannel(channelName,mode,channelTopic,category,!1);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[createPublicChannel] :: Public Channel created: "+channel.id),channel}catch(err){throw err}}))}createClosedChannel(channelName,channelTopic="",category=""){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[createClosedChannel] :: Trying to create a new closed channel");try{if(!channelName)throw new Error("Parameter 'channelName' is missing or empty");const mode="company_closed",channel=channelService.createChannel(channelName,mode,channelTopic,category,!1);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[createClosedChannel] :: created: "+channel.id),channel}catch(err){throw err}}))}deleteChannel(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteChannel] :: Trying to delete a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");return yield channelService.deleteChannel(id),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteChannel] :: deleted: "+id),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}fetchChannelsByName(name){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannelsByName] :: Trying to fetch channels by name");try{if(!name)throw new Error("Parameter 'name' is missing or empty");const filter={};filter.name=name;const channels=yield channelService.findChannels(filter);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannelsByName] :: fetched: "+channels.length),channels}catch(err){throw err}}))}fetchChannelsByTopic(topic){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannelsByTopic] :: Trying to fetch channels by topic");try{if(!topic)throw new Error("Parameter 'topic' is missing or empty");const filter={};filter.topic=topic;const channels=yield channelService.findChannels(filter);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannelsByTopic] :: fetched: "+channels.length),channels}catch(err){throw err}}))}fetchChannelsByCategory(category){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannelsByCategory] :: Trying to fetch channels by category");try{if(!category)throw new Error("Parameter 'category' is missing or empty");const filter={};filter.category=category;const channels=channelService.findChannels(filter);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannelsByCategory] :: fetched: "+channels.length),channels}catch(err){throw err}}))}fetchChannel(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannel] :: Trying to fetch a channel...");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const channel=channelService.getChannel(id);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchChannel] :: fetched: "+channel.id),channel}catch(err){throw err}}))}createItem(channel,message,title,url,itemType){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[createItem] :: Trying to create item");try{if(!channel)throw new Error("Parmeter 'channel' is missing or empty");if(!message)throw new Error("Parmeter 'message' is missing or empty");if(itemType&&-1===["basic","markdown","html","data"].indexOf(itemType))throw new Error("Parameter 'itemType' could be 'asic', 'markdown', 'html' or 'data'");return title=title||"",url=url||"",itemType=itemType?"urn:xmpp:channels:"+itemType:"urn:xmpp:channels:basic",yield channelService.publishToChannel(channel.id,null,itemType,message,title,url),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[createItem] :: created: "+channel.id),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}subscribeToChannelById(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[subscribeToChannelById] :: Trying to subscribe to a channel...");try{if(!id)throw new Error("Parameter 'id' is missing or null");const channel=channelService.getChannelFromCache(id);if(channel)yield channelService.subscribeToChannel(channel),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[subscribeToChannelById] :: subscribed: "+id);else{const channelFound=yield channelService.getChannel(id);if(!channelFound)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"No channel found with id "+id};yield channelService.subscribeToChannel(channelFound),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[subscribeToChannelById] :: subscribed: "+id)}return{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}subscribeToChannel(channel){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[subscribeToChannel] :: Trying to subscribe to a channel...");try{if(!channel)throw new Error("Paameter 'channel' is missing or null");return void(yield channelService.subscribeToChannel(channel))}catch(err){throw err}}))}unsubscribeFromChannelById(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[unsubscribeFromChannelById] :: Trying to unsubscribe from a channel...");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const channel=channelService.getChannelFromCache(id);if(channel)yield channelService.unsubscribeToChannel(channel),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[unsubscribeFromChannelById] :: unsubscribed: "+id);else{const channelFound=channelService.getChannel(id);if(!channelFound)return{code:sdkConstant_1.SDK.ERRORBADREQUEST,label:"No channel found with id "+id};yield channelService.unsubscribeToChannel(channelFound),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[unsubscribeFromChannelById] :: unsubscribed: "+id)}return{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}unsubscribeFromChannel(channel){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[unsubscribeFromChannel] :: Trying to unsubscribe from a channel...");try{if(!channel)throw new Error("Parameter 'channel' is missing or null");return yield channelService.unsubscribeToChannel(channel),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[unsubscribeFromChannel] :: unsubscribed: "+channel.id),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}updateChannel(id,channelTopic="",visibility="public",maxItems=30,maxPayloadSize=6e4,channelName=null,category=""){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannel] :: Trying to update a channel...");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const options={};null!==channelTopic&&(options.topic=channelTopic),null!==visibility&&(options.mode="company"===visibility?"company_public":"company_closed"),null!==maxItems&&(options.maxItems=maxItems),null!==maxPayloadSize&&(options.maxPayloadSize=maxPayloadSize),null!==channelName&&(options.name=channelName),null!==category&&(options.cateogry=category);const updatedChannel=yield channelService.updateChannel(id,options);return updatedChannel.visibility=options.visibility,RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannel] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelVisibility(id,visibility){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelVisibility] :: Trying to update visibility of a channel...");try{if(!id)throw new Error("Parameter 'id' is missing or empty");if(!visibility)throw new Error("Parameter 'visibility' is missing or empty");const options={};null!==visibility&&(options.mode="company"===visibility?"company_public":"company_closed");const updatedChannel=yield channelService.updateChannel(id,options);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelVisibility] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelVisibilityToPublic(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelVisibilityToPublic] :: Trying to update visibility to visible for a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const options={mode:"company_public"},updatedChannel=yield channelService.updateChannel(id,options);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelVisibilityToPublic] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelVisibilityToClosed(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelVisibilityToPublic] :: Trying to update visibility to visible for a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const options={mode:"company_closed"},updatedChannel=yield channelService.updateChannel(id,options);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelVisibilityToPublic] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelName(id,channelName){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelName] :: Trying to update the name of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const options={};null!==channelName&&(options.name=channelName);const updatedChannel=channelService.updateChannel(id,options);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelName] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelTopic(id,channelTopic){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelTopic] :: Try to update the topic of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const options={};null!==channelTopic&&(options.topic=channelTopic);const updatedChannel=channelService.updateChannel(id,options);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelTopic] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelCategory(id,category){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelCategory] :: Try to update the category of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const options={};null!==category&&(options.category=category);const updatedChannel=channelService.updateChannel(id,options);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelCategory] :: updated: "+id),updatedChannel}catch(err){throw err}}))}updateChannelAvatar(channel,urlAvatar){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelAvatar] :: Try to update the avatar of a channel");try{if(!channel)throw new Error("Parameter 'id' is missing or empty");if(!urlAvatar)throw new Error("Parameter 'urlAvatar' is missing or empty");return channelService.uploadChannelAvatar(channel,urlAvatar,512),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelAvatar] :: updated: "+channel.id),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}deleteChannelAvatar(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteChannelAvatar] :: Try to delete the avatar of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");return channelService.deleteChannelAvatar(id),RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteChannelAvatar] :: updated: "+id),{code:sdkConstant_1.SDK.OK,label:"OK"}}catch(err){throw err}}))}fetchUsers(id,options){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchUsers] :: Trying to fetch users of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");return(yield channelService.getChannelUsers(id,options)).data}catch(err){throw err}}))}deleteAllUsersFromChannel(id){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteAllUsersFromChannel] :: Trying to get delete all users of a channel...");try{if(!id)throw new Error("Parameter 'id' is missing or empty");yield channelService.removeAllUsersFromChannel(id);const updatedChannel=yield channelService.getChannel(id);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteAllUsersFromChannel] :: deleted: "+id),updatedChannel}catch(err){throw err}}))}updateChannelUsers(id,users,userType="member"){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelUsers] :: Trying to update users of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const usersData=yield channelService.updateChannelUsers(id,users,userType);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[updateChannelUsers] :: updated: "+id),usersData}catch(err){throw err}}))}addMembersToChannel(id,users){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[addMembersToChannel] :: Trying to add members to a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const userType="member",usersData=yield channelService.updateChannelUsers(id,users,userType);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[addMembersToChannel] :: added: "+id),usersData}catch(err){throw err}}))}addPublishersToChannel(id,users){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[addPublishersToChannel] :: Trying to add publishers to a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const userType="publisher",usersData=yield channelService.updateChannelUsers(id,users,userType);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[addPublishersToChannel] :: added: "+id),usersData}catch(err){throw err}}))}addOwnersToChannel(id,users){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[addOwnersToChannel] :: Trying to add owners to a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const userType="owner",usersData=yield channelService.updateChannelUsers(id,users,userType);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[addOwnersToChannel] :: added: "+id),usersData}catch(err){throw err}}))}deleteUsersFromChannel(id,users){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteUsersFromChannel] :: Trying to delete users from a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const userType="none",usersData=yield channelService.updateChannelUsers(id,users,userType);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteUsersFromChannel] :: deleted: "+id),usersData}catch(err){throw err}}))}fetchItems(id,maxMessages=10,beforeDate,afterDate){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchItems] :: Try to fetch items of a channel");try{if(!id)throw new Error("Parameter 'id' is missing or empty");const messages=channelService.getChannelItems(id,maxMessages,beforeDate,afterDate);return RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[fetchItems] :: fetched: "+id),messages}catch(err){throw err}}))}deleteItem(channelId,itemId){return __awaiter(this,void 0,void 0,(function*(){const channelService=_channelService.get(this);RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteItem] :: Trying to delete an item.");try{if(!channelId)throw new Error("Parameter 'channelId' is missing or empty");if(!itemId)throw new Error("Parameter 'itemId' is missing or empty");return yield channelService.deleteChannelItem(channelId,itemId),void RainbowLogger_1.rainbowLogger.sdk(ChannelsService.logService+"[deleteItem] :: Item deleted: "+itemId)}catch(err){throw err}}))}}exports.ChannelsService=ChannelsService,ChannelsService.logService="ChannelsService | "},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.SdkService=void 0;const RainbowLogger_1=__webpack_require__(9),EventsService_1=__webpack_require__(22),settings_service_1=__webpack_require__(5),sdkConfig_1=__webpack_require__(38),_connectionService=new WeakMap,_presenceService=new WeakMap,_contactsService=new WeakMap,_conversationsService=new WeakMap,_imService=new WeakMap,_pbxService=new WeakMap,_webRTCService=new WeakMap,_bubblesService=new WeakMap,_conferencesService=new WeakMap,_groupsService=new WeakMap,_callsLogService=new WeakMap,_userProfileService=new WeakMap,_favoritesService=new WeakMap,_filesStorageService=new WeakMap,_capabilitiesService=new WeakMap,_channelsService=new WeakMap,_adminService=new WeakMap;exports.SdkService=class{constructor(connectionService,presenceService,contactsService,conversationsService,imService,pbxService,webRTCService,bubblesService,conferencesService,groupsService,callsLogService,userProfileService,favoritesService,filesStorageService,capabilitiesService,channelsService,adminService){this.eventHandler=null,this.isReady=!1,this.RAINBOW_ONREADY="ready",this.RAINBOW_ONLOADED="loaded",_connectionService.set(this,connectionService),_presenceService.set(this,presenceService),_contactsService.set(this,contactsService),_conversationsService.set(this,conversationsService),_imService.set(this,imService),_pbxService.set(this,pbxService),_webRTCService.set(this,webRTCService),_bubblesService.set(this,bubblesService),_conferencesService.set(this,conferencesService),_groupsService.set(this,groupsService),_callsLogService.set(this,callsLogService),_userProfileService.set(this,userProfileService),_favoritesService.set(this,favoritesService),_filesStorageService.set(this,filesStorageService),_capabilitiesService.set(this,capabilitiesService),_channelsService.set(this,channelsService),_adminService.set(this,adminService),this.connection=connectionService,this.presence=presenceService,this.contacts=contactsService,this.conversations=conversationsService,this.im=imService,this.telephony=pbxService,this.webRTC=webRTCService,this.bubbles=bubblesService,this.conferences=conferencesService,this.groups=groupsService,this.callsLog=callsLogService,this.userProfile=userProfileService,this.favorites=favoritesService,this.fileStorage=filesStorageService,this.caps=capabilitiesService,this.channels=channelsService,this.admin=adminService,this.detectRTC=this.detectRTC.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.initializeAuto=this.initializeAuto.bind(this),this.start=this.start.bind(this)}static get $inject(){return["connectionService","presenceService","contactsService","conversationsService","imService","pbxService","webRTCService","bubblesService","conferencesService","groupsService","callsLogService","userProfileService","favoritesService","filesStorageService","capabilitiesService","channelsService","adminService"]}version(){return window.sdkversion}mode(){return settings_service_1.default.getSetting("apiMode")}setVerboseLog(boolHasVerboseLog){return sdkConfig_1.sdkConfig.verboseLog=boolHasVerboseLog,sdkConfig_1.sdkConfig.verboseLog}setKeyFromConfig(strApplicationID,strApplicationSecret){return RainbowLogger_1.rainbowLogger.sdk("SDKService | [setKeyFromConfig] :: Linked to application ID "+strApplicationID+" from configuration file"),sdkConfig_1.sdkConfig.credentials.appID=strApplicationID,sdkConfig_1.sdkConfig.credentials.appSecret=strApplicationSecret,!0}hasBeenLaunchedFromConfig(boolFromConfig){const fromConfig=boolFromConfig?"YES":"NO";return RainbowLogger_1.rainbowLogger.sdk("SDKService | [hasBeenLaunchedFromConfig] :: SDK lauched from a configuration file "+fromConfig),sdk.hasBeenLaunchedFromConfig=boolFromConfig,sdk.hasBeenLaunchedFromConfig}initialize(strApplicationID,strApplicationSecret){return __awaiter(this,void 0,void 0,(function*(){try{return strApplicationID&&strApplicationID.length>0?(sdk.key.appID=strApplicationID,RainbowLogger_1.rainbowLogger.sdk("SDKService | [initialize] :: Initialize the SDK for the application "+sdk.key.appID)):RainbowLogger_1.rainbowLogger.sdk("SDKService | [initialize] :: Initialize the SDK without an application key"),strApplicationSecret&&strApplicationSecret.length>0&&(sdk.key.appSecret=strApplicationSecret),yield this.detectRTC(),void RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize] :: SDK Initialized successfully!")}catch(err){throw err}}))}detectRTC(){return __awaiter(this,void 0,void 0,(function*(){try{return yield DetectRTC.load(),void this.initializeAuto()}catch(err){throw err}}))}load(customConfig){customConfig&&(RainbowLogger_1.rainbowLogger.sdk("Loading Rainbow Web SDK with custom config"),Object.assign(sdkConfig_1.sdkConfig,customConfig)),this.start(),RainbowLogger_1.rainbowLogger.sdk("SDKService | [load] :: Rainbow SDK loaded!"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONLOADED,null)}ready(){RainbowLogger_1.rainbowLogger.sdk("SDKService | [ready] :: Rainbow SDK ready!"),EventsService_1.eventsService.dispatchEvent(this.RAINBOW_ONREADY,null)}initializeAuto(){RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Initializing the Rainbow SDK..."),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: -----------------------------"),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Platform    | "+DetectRTC.osName+" "+DetectRTC.osVersion),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Screen      | "+window.screen.width+"x"+window.screen.height),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Cookie      | "+navigator.cookieEnabled),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Java        | "+navigator.javaEnabled()),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Server      | "+config.webservices.server),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Version WEB | "+window.version),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Version SDK | "+window.sdkversion),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Browser     | "+DetectRTC.browser.name+" "+DetectRTC.browser.fullVersion),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Microphone  | "+DetectRTC.hasMicrophone),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Camera      | "+DetectRTC.hasWebcam),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Speakers    | "+DetectRTC.hasSpeakers),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: WebRTC      | "+DetectRTC.isWebRTCSupported),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Mode        | "+this.mode()),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: verboseLog  | "+sdkConfig_1.sdkConfig.verboseLog),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: appID       | "+sdk.key.appID),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: -----------------------------"),RainbowLogger_1.rainbowLogger.sdk("SDK Service | [initialize ] :: Initialized!"),this.ready()}start(){config.webservices.currentServer=config.webservices.server,this.isReady=!0}}},function(module,exports){window.version="2.81.5"},function(module,exports){window.sdkversion="1.81.1"},function(module,exports){window.config={xmpp:{protocol:"wss",server:"sandbox.openrainbow.com",port:"443",pingInterval:"60000"},webservices:{protocol:"https",server:"sandbox.openrainbow.com",port:"443"},cpaas:{protocol:"https",server:"",port:"8887"}}},function(module,exports){window.app=angular.module("rainbow",[]),window.rainbowAdmin=angular.module("rainbowAdmin",[]),window.rainbow=angular.module("rainbow",["rainbowAdmin"])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(352),__webpack_require__(355),__webpack_require__(358),__webpack_require__(361),__webpack_require__(363);var _RainbowLogger__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(9);angular.module("rainbow").moduleIds=[],__webpack_require__(258),__webpack_require__(260),__webpack_require__(261),__webpack_require__(65),__webpack_require__(71),__webpack_require__(270),__webpack_require__(271),__webpack_require__(272),__webpack_require__(273),__webpack_require__(274),__webpack_require__(306),__webpack_require__(220),__webpack_require__(307),__webpack_require__(221),__webpack_require__(308),__webpack_require__(43),__webpack_require__(309),__webpack_require__(16),__webpack_require__(0),__webpack_require__(312),__webpack_require__(313),__webpack_require__(314),__webpack_require__(222),__webpack_require__(316),__webpack_require__(317),__webpack_require__(318),__webpack_require__(319),__webpack_require__(320),__webpack_require__(321),__webpack_require__(322),__webpack_require__(323),__webpack_require__(324),__webpack_require__(325),__webpack_require__(326),__webpack_require__(327),__webpack_require__(328),__webpack_require__(329),__webpack_require__(225),__webpack_require__(351),__webpack_require__(366),__webpack_require__(367),__webpack_require__(368),__webpack_require__(369),__webpack_require__(370),__webpack_require__(371),__webpack_require__(372),__webpack_require__(373),__webpack_require__(374),__webpack_require__(375),__webpack_require__(376),__webpack_require__(377),__webpack_require__(378),__webpack_require__(379),__webpack_require__(380),__webpack_require__(381),__webpack_require__(382),__webpack_require__(383),__webpack_require__(384),angular.module("rainbow").factory("rainbowLogger",(function(){return _RainbowLogger__WEBPACK_IMPORTED_MODULE_5__.rainbowLogger})),__webpack_require__(388),__webpack_require__(389),__webpack_require__(390),__webpack_require__(391),__webpack_require__(394),__webpack_require__(395),__webpack_require__(405),__webpack_require__(406),__webpack_require__(407),__webpack_require__(408),__webpack_require__(409)},function(module,exports,__webpack_require__){"use strict";(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}!function(){function retry(isDone,next){var currentTrial=0,isTimeout=!1,id=window.setInterval((function(){isDone()&&(window.clearInterval(id),next(isTimeout)),currentTrial++>50&&(window.clearInterval(id),next(isTimeout=!0))}),10)}var that,browserFakeUserAgent="Fake/5.0 (FakeOS) AppleWebKit/123 (KHTML, like Gecko) Fake/12.3.4567.89 Fake/123.45";if(isNodejs="object"==(void 0===process?"undefined":_typeof(process))&&"object"==_typeof(process.versions)&&process.versions.node&&!process.browser){var version=process.versions.node.toString().replace("v","");browserFakeUserAgent="Nodejs/"+version+" (NodeOS) AppleWebKit/"+version+" (KHTML, like Gecko) Nodejs/"+version+" Nodejs/"+version}that=void 0!==global?global:window,"undefined"==typeof window&&("undefined"==typeof window&&void 0!==global&&(global.navigator={userAgent:browserFakeUserAgent,getUserMedia:function(){}},that.window=global),"undefined"==typeof location&&(that.location={protocol:"file:",href:"",hash:""}),"undefined"==typeof screen&&(that.screen={width:0,height:0}));var navigator=window.navigator;void 0!==navigator?(void 0!==navigator.webkitGetUserMedia&&(navigator.getUserMedia=navigator.webkitGetUserMedia),void 0!==navigator.mozGetUserMedia&&(navigator.getUserMedia=navigator.mozGetUserMedia)):navigator={getUserMedia:function(){},userAgent:browserFakeUserAgent};var ua,match,isMobileDevice=!!/Android|webOS|iPhone|iPad|iPod|BB10|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(navigator.userAgent||""),isEdge=!(-1===navigator.userAgent.indexOf("Edge")||!navigator.msSaveOrOpenBlob&&!navigator.msSaveBlob),isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&"netscape"in window&&/ rv:/.test(navigator.userAgent),isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),isChrome=!!window.chrome&&!isOpera,isIE="undefined"!=typeof document&&!!document.documentMode&&!isEdge,isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return isMobile.Android()||isMobile.BlackBerry()||isMobile.iOS()||isMobile.Opera()||isMobile.Windows()},getOsName:function(){var osName="Unknown OS";return isMobile.Android()&&(osName="Android"),isMobile.BlackBerry()&&(osName="BlackBerry"),isMobile.iOS()&&(osName="iOS"),isMobile.Opera()&&(osName="Opera Mini"),isMobile.Windows()&&(osName="Windows"),osName}},osName="Unknown OS",osVersion="Unknown OS Version",osInfo=function(){for(var cs,nVer=navigator.appVersion,nAgt=navigator.userAgent,os="-",clientStrings=[{s:"Chrome OS",r:/CrOS/},{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],i=0;cs=clientStrings[i];i++)if(cs.r.test(nAgt)){os=cs.s;break}var osVersion="-";switch(/Windows/.test(os)&&(/Windows (.*)/.test(os)&&(osVersion=/Windows (.*)/.exec(os)[1]),os="Windows"),os){case"Mac OS X":/Mac OS X (10[\.\_\d]+)/.test(nAgt)&&(osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1]);break;case"Android":/Android ([\.\_\d]+)/.test(nAgt)&&(osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1]);break;case"iOS":/OS (\d+)_(\d+)_?(\d+)?/.test(nAgt)&&(osVersion=(osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer))[1]+"."+osVersion[2]+"."+(0|osVersion[3]))}return{osName:os,osVersion:osVersion}}();osInfo&&osInfo.osName&&"-"!=osInfo.osName?(osName=osInfo.osName,osVersion=osInfo.osVersion):isMobile.any()&&("Android"==(osName=isMobile.getOsName())&&(osVersion=!!(match=(ua=(ua||navigator.userAgent).toLowerCase()).match(/android\s([0-9\.]*)/))&&match[1]));var isNodejs="object"==(void 0===process?"undefined":_typeof(process))&&"object"==_typeof(process.versions)&&process.versions.node;"Unknown OS"===osName&&isNodejs&&(osName="Nodejs",osVersion=process.versions.node.toString().replace("v",""));var isCanvasSupportsStreamCapturing=!1,isVideoSupportsStreamCapturing=!1;["captureStream","mozCaptureStream","webkitCaptureStream"].forEach((function(item){"undefined"!=typeof document&&"function"==typeof document.createElement&&(!isCanvasSupportsStreamCapturing&&item in document.createElement("canvas")&&(isCanvasSupportsStreamCapturing=!0),!isVideoSupportsStreamCapturing&&item in document.createElement("video")&&(isVideoSupportsStreamCapturing=!0))}));var regexIpv4Local=/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/,regexIpv4=/([0-9]{1,3}(\.[0-9]{1,3}){3})/,regexIpv6=/[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7}/,MediaDevices=[],audioInputDevices=[],audioOutputDevices=[],videoInputDevices=[];navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&(navigator.enumerateDevices=function(callback){var enumerateDevices=navigator.mediaDevices.enumerateDevices();enumerateDevices&&enumerateDevices.then?navigator.mediaDevices.enumerateDevices().then(callback).catch((function(){callback([])})):callback([])});var canEnumerate=!1;("undefined"!=typeof MediaStreamTrack&&"getSources"in MediaStreamTrack||navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)&&(canEnumerate=!0);var hasMicrophone=!1,hasSpeakers=!1,hasWebcam=!1,isWebsiteHasMicrophonePermissions=!1,isWebsiteHasWebcamPermissions=!1,DetectRTC=window.DetectRTC||{};DetectRTC.browser=function(){var nameOffset,verOffset,ix,nAgt=(navigator.appVersion,navigator.userAgent),browserName=navigator.appName,fullVersion=""+parseFloat(navigator.appVersion),majorVersion=parseInt(navigator.appVersion,10);if(isOpera){browserName="Opera";try{majorVersion=(fullVersion=navigator.userAgent.split("OPR/")[1].split(" ")[0]).split(".")[0]}catch(e){fullVersion="0.0.0.0",majorVersion=0}}else isIE?((verOffset=nAgt.indexOf("rv:"))>0?fullVersion=nAgt.substring(verOffset+3):(verOffset=nAgt.indexOf("MSIE"),fullVersion=nAgt.substring(verOffset+5)),browserName="IE"):isChrome?(verOffset=nAgt.indexOf("Chrome"),browserName="Chrome",fullVersion=nAgt.substring(verOffset+7)):isSafari?-1!==nAgt.indexOf("CriOS")?(verOffset=nAgt.indexOf("CriOS"),browserName="Chrome",fullVersion=nAgt.substring(verOffset+6)):-1!==nAgt.indexOf("FxiOS")?(verOffset=nAgt.indexOf("FxiOS"),browserName="Firefox",fullVersion=nAgt.substring(verOffset+6)):(verOffset=nAgt.indexOf("Safari"),browserName="Safari",fullVersion=nAgt.substring(verOffset+7),-1!==(verOffset=nAgt.indexOf("Version"))&&(fullVersion=nAgt.substring(verOffset+8)),-1!==navigator.userAgent.indexOf("Version/")&&(fullVersion=navigator.userAgent.split("Version/")[1].split(" ")[0])):isFirefox?(verOffset=nAgt.indexOf("Firefox"),browserName="Firefox",fullVersion=nAgt.substring(verOffset+8)):(nameOffset=nAgt.lastIndexOf(" ")+1)<(verOffset=nAgt.lastIndexOf("/"))&&(browserName=nAgt.substring(nameOffset,verOffset),fullVersion=nAgt.substring(verOffset+1),browserName.toLowerCase()===browserName.toUpperCase()&&(browserName=navigator.appName));return isEdge&&(browserName="Edge",fullVersion=navigator.userAgent.split("Edge/")[1]),-1!==(ix=fullVersion.search(/[; \)]/))&&(fullVersion=fullVersion.substring(0,ix)),majorVersion=parseInt(""+fullVersion,10),isNaN(majorVersion)&&(fullVersion=""+parseFloat(navigator.appVersion),majorVersion=parseInt(navigator.appVersion,10)),{fullVersion:fullVersion,version:majorVersion,name:browserName,isPrivateBrowsing:!1}}(),function(callback){var isPrivate;try{if(window.webkitRequestFileSystem)window.webkitRequestFileSystem(window.TEMPORARY,1,(function(){isPrivate=!1}),(function(e){isPrivate=!0}));else if(window.indexedDB&&/Firefox/.test(window.navigator.userAgent)){var db;try{(db=window.indexedDB.open("test")).onerror=function(){return!0}}catch(e){isPrivate=!0}void 0===isPrivate&&retry((function(){return"done"===db.readyState}),(function(isTimeout){isTimeout||(isPrivate=!db.result)}))}else if(function(userAgent){var ua=userAgent.toLowerCase();if(0===ua.indexOf("msie")&&0===ua.indexOf("trident"))return!1;var match=/(?:msie|rv:)\s?([\d\.]+)/.exec(ua);return!!(match&&parseInt(match[1],10)>=10)}(window.navigator.userAgent)){isPrivate=!1;try{window.indexedDB||(isPrivate=!0)}catch(e){isPrivate=!0}}else if(window.localStorage&&/Safari/.test(window.navigator.userAgent)){try{window.localStorage.setItem("test",1)}catch(e){isPrivate=!0}void 0===isPrivate&&(isPrivate=!1,window.localStorage.removeItem("test"))}}catch(e){isPrivate=!1}retry((function(){return void 0!==isPrivate}),(function(isTimeout){callback(isPrivate)}))}((function(isPrivateBrowsing){DetectRTC.browser.isPrivateBrowsing=!!isPrivateBrowsing})),DetectRTC.browser["is"+DetectRTC.browser.name]=!0,DetectRTC.osName=osName,DetectRTC.osVersion=osVersion;var isWebRTCSupported=("object"==(void 0===process?"undefined":_typeof(process))&&"object"==_typeof(process.versions)&&process.versions["node-webkit"],!1);["RTCPeerConnection","webkitRTCPeerConnection","mozRTCPeerConnection","RTCIceGatherer"].forEach((function(item){isWebRTCSupported||item in window&&(isWebRTCSupported=!0)})),DetectRTC.isWebRTCSupported=isWebRTCSupported,DetectRTC.isORTCSupported="undefined"!=typeof RTCIceGatherer;var isScreenCapturingSupported=!1;((DetectRTC.browser.isChrome&&DetectRTC.browser.version>=35||DetectRTC.browser.isFirefox&&DetectRTC.browser.version>=34||DetectRTC.browser.isEdge&&DetectRTC.browser.version>=17||"Android"===DetectRTC.osName&&DetectRTC.browser.isChrome)&&(isScreenCapturingSupported=!0),(navigator.getDisplayMedia||navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)&&(isScreenCapturingSupported=!0),/^(https:|chrome-extension:)$/g.test(location.protocol||""))||("undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(DetectRTC.browser.isChrome||DetectRTC.browser.isEdge||DetectRTC.browser.isOpera)||DetectRTC.browser.isFirefox)&&(isScreenCapturingSupported=!1);DetectRTC.isScreenCapturingSupported=isScreenCapturingSupported;var webAudio={isSupported:!1,isCreateMediaStreamSourceSupported:!1};["AudioContext","webkitAudioContext","mozAudioContext","msAudioContext"].forEach((function(item){webAudio.isSupported||item in window&&(webAudio.isSupported=!0,window[item]&&"createMediaStreamSource"in window[item].prototype&&(webAudio.isCreateMediaStreamSourceSupported=!0))})),DetectRTC.isAudioContextSupported=webAudio.isSupported,DetectRTC.isCreateMediaStreamSourceSupported=webAudio.isCreateMediaStreamSourceSupported;var isRtpDataChannelsSupported=!1;DetectRTC.browser.isChrome&&DetectRTC.browser.version>31&&(isRtpDataChannelsSupported=!0),DetectRTC.isRtpDataChannelsSupported=isRtpDataChannelsSupported;var isSCTPSupportd=!1;(DetectRTC.browser.isFirefox&&DetectRTC.browser.version>28||DetectRTC.browser.isChrome&&DetectRTC.browser.version>25||DetectRTC.browser.isOpera&&DetectRTC.browser.version>=11)&&(isSCTPSupportd=!0),DetectRTC.isSctpDataChannelsSupported=isSCTPSupportd,DetectRTC.isMobileDevice=isMobileDevice;var isGetUserMediaSupported=!1;(navigator.getUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)&&(isGetUserMediaSupported=!0),DetectRTC.browser.isChrome&&DetectRTC.browser.version>=46&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(isGetUserMediaSupported="Requires HTTPs"),"Nodejs"===DetectRTC.osName&&(isGetUserMediaSupported=!1),DetectRTC.isGetUserMediaSupported=isGetUserMediaSupported;var w,h,r,displayResolution="";screen.width&&(displayResolution+=(screen.width?screen.width:"")+" x "+(screen.height?screen.height:""));DetectRTC.displayResolution=displayResolution,DetectRTC.displayAspectRatio=(w=screen.width,h=screen.height,r=function gcd(a,b){return 0==b?a:gcd(b,a%b)}(w,h),w/r/(h/r)).toFixed(2),DetectRTC.isCanvasSupportsStreamCapturing=isCanvasSupportsStreamCapturing,DetectRTC.isVideoSupportsStreamCapturing=isVideoSupportsStreamCapturing,"Chrome"==DetectRTC.browser.name&&DetectRTC.browser.version>=53&&(DetectRTC.isCanvasSupportsStreamCapturing||(DetectRTC.isCanvasSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features"),DetectRTC.isVideoSupportsStreamCapturing||(DetectRTC.isVideoSupportsStreamCapturing="Requires chrome flag: enable-experimental-web-platform-features")),DetectRTC.DetectLocalIPAddress=function(callback,stream){if(DetectRTC.isWebRTCSupported){var isPublic=!0,isIpv4=!0;!function(callback,stream){function handleCandidate(candidate){if(candidate){var match=regexIpv4.exec(candidate);if(match){var ipAddress=match[1],isPublic=candidate.match(regexIpv4Local);void 0===ipDuplicates[ipAddress]&&callback(ipAddress,isPublic,!0),ipDuplicates[ipAddress]=!0}}else callback()}function afterCreateOffer(){pc.localDescription.sdp.split("\n").forEach((function(line){line&&0===line.indexOf("a=candidate:")&&handleCandidate(line)}))}if("undefined"!=typeof document&&"function"==typeof document.getElementById){var ipDuplicates={},RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;if(!RTCPeerConnection){var iframe=document.getElementById("iframe");if(!iframe)return;var win=iframe.contentWindow;RTCPeerConnection=win.RTCPeerConnection||win.mozRTCPeerConnection||win.webkitRTCPeerConnection}if(RTCPeerConnection){var peerConfig=null;"Chrome"===DetectRTC.browser&&DetectRTC.browser.version<58&&(peerConfig={optional:[{RtpDataChannels:!0}]});var pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]},peerConfig);if(stream&&(pc.addStream?pc.addStream(stream):pc.addTrack&&stream.getTracks()[0]&&pc.addTrack(stream.getTracks()[0],stream)),pc.onicecandidate=function(event){event.candidate&&event.candidate.candidate?handleCandidate(event.candidate.candidate):handleCandidate()},!stream)try{pc.createDataChannel("sctp",{})}catch(e){}DetectRTC.isPromisesSupported?pc.createOffer().then((function(result){pc.setLocalDescription(result).then(afterCreateOffer)})):pc.createOffer((function(result){pc.setLocalDescription(result,afterCreateOffer,(function(){}))}),(function(){}))}}}((function(ip){ip?ip.match(regexIpv4Local)?callback("Local: "+ip,isPublic=!1,isIpv4):ip.match(regexIpv6)?callback("Public: "+ip,isPublic,isIpv4=!1):callback("Public: "+ip,isPublic,isIpv4):callback()}),stream)}},DetectRTC.isWebSocketsSupported="WebSocket"in window&&2===window.WebSocket.CLOSING,DetectRTC.isWebSocketsBlocked=!DetectRTC.isWebSocketsSupported,"Nodejs"===DetectRTC.osName&&(DetectRTC.isWebSocketsSupported=!0,DetectRTC.isWebSocketsBlocked=!1),DetectRTC.checkWebSocketsSupport=function(callback){callback=callback||function(){};try{var starttime,websocket=new WebSocket("wss://echo.websocket.org:443/");websocket.onopen=function(){DetectRTC.isWebSocketsBlocked=!1,starttime=(new Date).getTime(),websocket.send("ping")},websocket.onmessage=function(){DetectRTC.WebsocketLatency=(new Date).getTime()-starttime+"ms",callback(),websocket.close(),websocket=null},websocket.onerror=function(){DetectRTC.isWebSocketsBlocked=!0,callback()}}catch(e){DetectRTC.isWebSocketsBlocked=!0,callback()}},DetectRTC.load=function(callback){(function(callback){if(canEnumerate)if(!navigator.enumerateDevices&&window.MediaStreamTrack&&window.MediaStreamTrack.getSources&&(navigator.enumerateDevices=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack)),!navigator.enumerateDevices&&navigator.enumerateDevices&&(navigator.enumerateDevices=navigator.enumerateDevices.bind(navigator)),navigator.enumerateDevices){MediaDevices=[],audioInputDevices=[],audioOutputDevices=[],videoInputDevices=[],hasMicrophone=!1,hasSpeakers=!1,hasWebcam=!1,isWebsiteHasMicrophonePermissions=!1,isWebsiteHasWebcamPermissions=!1;var alreadyUsedDevices={};navigator.enumerateDevices((function(devices){MediaDevices=[],audioInputDevices=[],audioOutputDevices=[],videoInputDevices=[],devices.forEach((function(_device){var device={};for(var d in _device)try{"function"!=typeof _device[d]&&(device[d]=_device[d])}catch(e){}alreadyUsedDevices[device.deviceId+device.label+device.kind]||("audio"===device.kind&&(device.kind="audioinput"),"video"===device.kind&&(device.kind="videoinput"),device.deviceId||(device.deviceId=device.id),device.id||(device.id=device.deviceId),device.label?("videoinput"!==device.kind||isWebsiteHasWebcamPermissions||(isWebsiteHasWebcamPermissions=!0),"audioinput"!==device.kind||isWebsiteHasMicrophonePermissions||(isWebsiteHasMicrophonePermissions=!0)):(device.isCustomLabel=!0,"videoinput"===device.kind?device.label="Camera "+(videoInputDevices.length+1):"audioinput"===device.kind?device.label="Microphone "+(audioInputDevices.length+1):"audiooutput"===device.kind?device.label="Speaker "+(audioOutputDevices.length+1):device.label="Please invoke getUserMedia once.",void 0!==DetectRTC&&DetectRTC.browser.isChrome&&DetectRTC.browser.version>=46&&!/^(https:|chrome-extension:)$/g.test(location.protocol||"")&&"undefined"!=typeof document&&"string"==typeof document.domain&&document.domain.search&&-1===document.domain.search(/localhost|127.0./g)&&(device.label="HTTPs is required to get label of this "+device.kind+" device.")),"audioinput"===device.kind&&(hasMicrophone=!0,-1===audioInputDevices.indexOf(device)&&audioInputDevices.push(device)),"audiooutput"===device.kind&&(hasSpeakers=!0,-1===audioOutputDevices.indexOf(device)&&audioOutputDevices.push(device)),"videoinput"===device.kind&&(hasWebcam=!0,-1===videoInputDevices.indexOf(device)&&videoInputDevices.push(device)),MediaDevices.push(device),alreadyUsedDevices[device.deviceId+device.label+device.kind]=device)})),void 0!==DetectRTC&&(DetectRTC.MediaDevices=MediaDevices,DetectRTC.hasMicrophone=hasMicrophone,DetectRTC.hasSpeakers=hasSpeakers,DetectRTC.hasWebcam=hasWebcam,DetectRTC.isWebsiteHasWebcamPermissions=isWebsiteHasWebcamPermissions,DetectRTC.isWebsiteHasMicrophonePermissions=isWebsiteHasMicrophonePermissions,DetectRTC.audioInputDevices=audioInputDevices,DetectRTC.audioOutputDevices=audioOutputDevices,DetectRTC.videoInputDevices=videoInputDevices),callback&&callback()}))}else callback&&callback();else callback&&callback()})(callback=callback||function(){})},DetectRTC.MediaDevices=void 0!==MediaDevices?MediaDevices:[],DetectRTC.hasMicrophone=hasMicrophone,DetectRTC.hasSpeakers=hasSpeakers,DetectRTC.hasWebcam=hasWebcam,DetectRTC.isWebsiteHasWebcamPermissions=isWebsiteHasWebcamPermissions,DetectRTC.isWebsiteHasMicrophonePermissions=isWebsiteHasMicrophonePermissions,DetectRTC.audioInputDevices=audioInputDevices,DetectRTC.audioOutputDevices=audioOutputDevices,DetectRTC.videoInputDevices=videoInputDevices;var isSetSinkIdSupported=!1;"undefined"!=typeof document&&"function"==typeof document.createElement&&"setSinkId"in document.createElement("video")&&(isSetSinkIdSupported=!0),DetectRTC.isSetSinkIdSupported=isSetSinkIdSupported;var isRTPSenderReplaceTracksSupported=!1;DetectRTC.browser.isFirefox&&"undefined"!=typeof mozRTCPeerConnection?"getSenders"in mozRTCPeerConnection.prototype&&(isRTPSenderReplaceTracksSupported=!0):DetectRTC.browser.isChrome&&"undefined"!=typeof webkitRTCPeerConnection&&"getSenders"in webkitRTCPeerConnection.prototype&&(isRTPSenderReplaceTracksSupported=!0),DetectRTC.isRTPSenderReplaceTracksSupported=isRTPSenderReplaceTracksSupported;var isRemoteStreamProcessingSupported=!1;DetectRTC.browser.isFirefox&&DetectRTC.browser.version>38&&(isRemoteStreamProcessingSupported=!0),DetectRTC.isRemoteStreamProcessingSupported=isRemoteStreamProcessingSupported;var isApplyConstraintsSupported=!1;"undefined"!=typeof MediaStreamTrack&&"applyConstraints"in MediaStreamTrack.prototype&&(isApplyConstraintsSupported=!0),DetectRTC.isApplyConstraintsSupported=isApplyConstraintsSupported;var isMultiMonitorScreenCapturingSupported=!1;DetectRTC.browser.isFirefox&&DetectRTC.browser.version>=43&&(isMultiMonitorScreenCapturingSupported=!0),DetectRTC.isMultiMonitorScreenCapturingSupported=isMultiMonitorScreenCapturingSupported,DetectRTC.isPromisesSupported=!!("Promise"in window),DetectRTC.version="1.4.0",void 0===DetectRTC&&(window.DetectRTC={});var MediaStream=window.MediaStream;void 0===MediaStream&&"undefined"!=typeof webkitMediaStream&&(MediaStream=webkitMediaStream),DetectRTC.MediaStream=void 0!==MediaStream&&"function"==typeof MediaStream&&Object.keys(MediaStream.prototype),"undefined"!=typeof MediaStreamTrack?DetectRTC.MediaStreamTrack=Object.keys(MediaStreamTrack.prototype):DetectRTC.MediaStreamTrack=!1;var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;DetectRTC.RTCPeerConnection=void 0!==RTCPeerConnection&&Object.keys(RTCPeerConnection.prototype),window.DetectRTC=DetectRTC,module.exports=DetectRTC,void 0===(__WEBPACK_AMD_DEFINE_RESULT__=function(){return DetectRTC}.apply(exports,[]))||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)}()}).call(this,__webpack_require__(259),__webpack_require__(64))},function(module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,function(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},function(module,exports){function RBError(message,details,detailsCode,detailsData){this.name="RainbowError",this.message=message,this.details=details,this.detailsCode=detailsCode,this.detailsData=detailsData,this.stack=(new Error).stack}RBError.prototype=Object.create(Error.prototype),RBError.prototype.constructor=RBError,window.RBError=RBError},function(module,exports){angular.module("rainbow").factory("CompanyInvitation",[function(){"use strict";function CompanyInvitation(id,companyId,companyName,invitedUserId,invitedUserEmail,invitingAdminId,invitingAdminLoginEmail,invitationDate,lastNotificationDate,requestedNotificationLanguage,status,acceptationDate,declinationDate,invitedToBeCompanyAdmin){this.id=id,this.companyId=companyId,this.companyName=companyName,this.invitedUserId=invitedUserId,this.invitedUserEmail=invitedUserEmail,this.invitingAdminId=invitingAdminId,this.invitingAdminLoginEmail=invitingAdminLoginEmail,this.invitationDate=invitationDate,this.lastNotificationDate=lastNotificationDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.status=status,this.acceptationDate=acceptationDate,this.declinationDate=declinationDate,this.invitedToBeCompanyAdmin=invitedToBeCompanyAdmin}return CompanyInvitation.createFromData=function(data){return new CompanyInvitation(data.id,data.companyId,data.companyName,data.invitedUserId,data.invitedUserEmail,data.invitingAdminId,data.invitingAdminLoginEmail,data.invitationDate,data.lastNotificationDate,data.requestedNotificationLanguage,data.status,data.acceptationDate,data.declinationDate,data.invitedToBeCompanyAdmin)},CompanyInvitation}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Subscriber_1=__webpack_require__(55);exports.canReportError=function(observer){for(;observer;){var _a=observer,closed_1=_a.closed,destination=_a.destination,isStopped=_a.isStopped;if(closed_1||isStopped)return!1;observer=destination&&destination instanceof Subscriber_1.Subscriber?destination:null}return!0}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isArray=Array.isArray||function(x){return x&&"number"==typeof x.length}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isObject=function(x){return null!==x&&"object"==typeof x}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var UnsubscriptionErrorImpl=function(){function UnsubscriptionErrorImpl(errors){return Error.call(this),this.message=errors?errors.length+" errors occurred during unsubscription:\n"+errors.map((function(err,i){return i+1+") "+err.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=errors,this}return UnsubscriptionErrorImpl.prototype=Object.create(Error.prototype),UnsubscriptionErrorImpl}();exports.UnsubscriptionError=UnsubscriptionErrorImpl},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Subscriber_1=__webpack_require__(55),rxSubscriber_1=__webpack_require__(69),Observer_1=__webpack_require__(79);exports.toSubscriber=function(nextOrObserver,error,complete){if(nextOrObserver){if(nextOrObserver instanceof Subscriber_1.Subscriber)return nextOrObserver;if(nextOrObserver[rxSubscriber_1.rxSubscriber])return nextOrObserver[rxSubscriber_1.rxSubscriber]()}return nextOrObserver||error||complete?new Subscriber_1.Subscriber(nextOrObserver,error,complete):new Subscriber_1.Subscriber(Observer_1.empty)}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.observable="function"==typeof Symbol&&Symbol.observable||"@@observable"},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var identity_1=__webpack_require__(269);function pipeFromArray(fns){return 0===fns.length?identity_1.identity:1===fns.length?fns[0]:function(input){return fns.reduce((function(prev,fn){return fn(prev)}),input)}}exports.pipe=function(){for(var fns=[],_i=0;_i<arguments.length;_i++)fns[_i]=arguments[_i];return pipeFromArray(fns)},exports.pipeFromArray=pipeFromArray},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.identity=function(x){return x}},function(module,exports){angular.module("rainbow").factory("CompanyRequest",[function(){"use strict";function CompanyRequest(id,requestingUserId,requestingUserLoginEmail,requestedCompanyId,requestedCompanyName,status,requestingDate,requestedNotificationLanguage,lastNotificationDate,requestedToCompanyAdmin,requestedCompanyInvitationId){this.id=id,this.requestingUserId=requestingUserId,this.requestingUserLoginEmail=requestingUserLoginEmail,this.requestedCompanyId=requestedCompanyId,this.requestedCompanyName=requestedCompanyName,this.status=status,this.requestingDate=requestingDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.lastNotificationDate=lastNotificationDate,this.requestedToCompanyAdmin=requestedToCompanyAdmin,this.requestedCompanyInvitationId=requestedCompanyInvitationId}return CompanyRequest.createFromData=function(data){return new CompanyRequest(data.id,data.requestingUserId,data.requestingUserLoginEmail,data.requestedCompanyId,data.requestedCompanyName,data.status,data.requestingDate,data.requestedNotificationLanguage,data.lastNotificationDate,data.requestedToCompanyAdmin,data.requestedCompanyInvitationId)},CompanyRequest}])},function(module,exports){angular.module("rainbow").factory("CompanyBpLinkInvitation",[function(){"use strict";function CompanyBpLinkInvitation(id,invitedCompanyId,invitedCompanyName,invitedToBeBpIr,invitingAdminId,invitingAdminLoginEmail,invitingCompanyId,invitingCompanyName,invitationDate,lastNotificationDate,requestedNotificationLanguage,status,acceptationDate,cancelationDate,declinationDate){this.id=id,this.invitedCompanyId=invitedCompanyId,this.invitedCompanyName=invitedCompanyName,this.invitedToBeBpIr=invitedToBeBpIr,this.invitingAdminId=invitingAdminId,this.invitingAdminLoginEmail=invitingAdminLoginEmail,this.invitingCompanyId=invitingCompanyId,this.invitingCompanyName=invitingCompanyName,this.invitationDate=invitationDate,this.lastNotificationDate=lastNotificationDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.status=status,this.acceptationDate=acceptationDate,this.cancelationDate=cancelationDate,this.declinationDate=declinationDate}return CompanyBpLinkInvitation.createFromData=function(data){return new CompanyBpLinkInvitation(data.id,data.invitedCompanyId,data.invitedCompanyName,data.invitedToBeBpIr,data.invitingAdminId,data.invitingAdminLoginEmail,data.invitingCompanyId,data.invitingCompanyName,data.invitationDate,data.lastNotificationDate,data.requestedNotificationLanguage,data.status,data.acceptationDate,data.cancelationDate,data.declinationDate)},CompanyBpLinkInvitation}])},function(module,exports){angular.module("rainbow").factory("CompanyBpLinkRequest",[function(){"use strict";function CompanyBpLinkRequest(id,requestingAdminId,requestingAdminLoginEmail,requestingCompanyId,requestingCompanyName,requestedCompanyId,requestedCompanyName,requestedToBeBpIr,requestDate,lastNotificationDate,requestedNotificationLanguage,status,acceptationDate,cancelationDate,declinationDate){this.id=id,this.requestingAdminId=requestingAdminId,this.requestingAdminLoginEmail=requestingAdminLoginEmail,this.requestingCompanyId=requestingCompanyId,this.requestingCompanyName=requestingCompanyName,this.requestedCompanyId=requestedCompanyId,this.requestedCompanyName=requestedCompanyName,this.requestedToBeBpIr=requestedToBeBpIr,this.requestDate=requestDate,this.lastNotificationDate=lastNotificationDate,this.requestedNotificationLanguage=requestedNotificationLanguage,this.status=status,this.acceptationDate=acceptationDate,this.cancelationDate=cancelationDate,this.declinationDate=declinationDate}return CompanyBpLinkRequest.createFromData=function(data){return new CompanyBpLinkRequest(data.id,data.requestingAdminId,data.requestingAdminLoginEmail,data.requestingCompanyId,data.requestingCompanyName,data.requestedCompanyId,data.requestedCompanyName,data.requestedToBeBpIr,data.requestDate,data.lastNotificationDate,data.requestedNotificationLanguage,data.status,data.acceptationDate,data.cancelationDate,data.declinationDate)},CompanyBpLinkRequest}])},function(module,exports){angular.module("rainbow").factory("Conference",[function(){"use strict";function Conference(companyId,id,mediaType,name,passCodes,scheduled,lastUpdateDate,userId,confDialOutDisabled,playEntryTone,muteUponEntry){this.companyId=companyId,this.id=id,this.mediaType=mediaType,this.name=name,this.passCodes=passCodes||[],this.scheduled=scheduled,this.lastUpdateDate=lastUpdateDate,this.userId=userId,this.confDialOutDisabled=confDialOutDisabled,this.playEntryTone=playEntryTone,this.muteUponEntry=muteUponEntry,this.updateFromData=function(data){this.companyId=data.companyId,this.id=data.id,this.mediaType=data.mediaType,this.name=data.name,this.passCodes=data.passCodes,this.scheduled=data.scheduled,this.lastUpdateDate=data.lastUpdateDate,this.userId=data.userId,this.confDialOutDisabled=data.confDialOutDisabled,this.playEntryTone=data.playEntryTone,this.muteUponEntry=data.muteUponEntry}}return Conference.createFromData=function(data){return new Conference(data.companyId,data.id,data.mediaType,data.name,data.passCodes,data.scheduled,data.lastUpdateDate,data.userId,data.confDialOutDisabled,data.playEntryTone,data.muteUponEntry)},Conference}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0__),rxjs__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(77);angular.module("rainbow").factory("ConferenceSession",["$log","ConferenceParticipant","$q","$interval",function($log,ConferenceParticipant,$q,$interval){function ConferenceSession(_id,_participants,_active,_type){var that=this;that.id=_id,that.participants=_participants,that.active=_active,that.talkerActive=void 0,that.recordingStarted=void 0,that.talkers=void 0,that.talkerSubject=new rxjs__WEBPACK_IMPORTED_MODULE_1__.a(this.talkers),that.isLeaderAlreadyConnected=!1,that.status=null,that.localStreams=[],that.sessions={},that.publishers=[],that.type=_type,that.callId=null,that.hasLocalVideo=!1,that.jingleJid=null,that.localVideoSessionId=null,that.localSharingSessionId=null,that.haveJoined=!1,that.lock=!1,that.duration=0,that.durationTimer=null,that.conferenceStats=null,that.control={activeControl:!1,hasRemoteControlling:!1,controller:null,controlled:null},that.conferenceView=ConferenceSession.ConferenceView.GalleryView,that.networkQuality=0,that.isMyConference=!1,that.cleanupSessionData=function(){$log.debug("[ConferenceSession] Cleanup for conferenceSession "+that.id),that.participants=[],that.talkerActive=void 0,that.recordingStarted=void 0,that.talkers=void 0,that.isLeaderAlreadyConnected=!1,that.localStreams=[],that.sessions={},that.publishers=[],that.hasLocalVideo=!1,that.metricsState="",that.recordingStarted=!1,that.status="ended",that.hasLocalSharing=!1,that.reversedVideos=!1,that.jingleJid=null,that.localVideoSessionId=null,that.localSharingSessionId=null,that.haveJoined=!1,that.lock=!1,that.duration=0,that.conferenceStats=null,that.durationTimer&&($interval.cancel(that.durationTimer),that.durationTimer=null),that.conferenceView=ConferenceSession.ConferenceView.GalleryView,that.joinedFromOtherDevice=!1},that.updateFromData=function(id,participants,active){that.id=id,that.participants=participants,that.active=active},that.updateActiveState=function(active){that.active=active},that.updateStateFromData=function(active,talkerActive,recordingStarted,lock){that.active=active,that.talkerActive=talkerActive,that.recordingStarted=recordingStarted,that.lock=lock},that.updateParticipants=function(participantsData){return $q((function(resolve){var result=!1;participantsData||resolve(!1),that.participants||(that.participants=[]),0===participantsData.length&&(that.participants=[]),participantsData.forEach((function(participantData){if(participantData.participantId){$log.debug("[conferenceSession] updateParticipants participantId="+participantData.participantId);var existingParticipant=that.getParticipantById(participantData.participantId)?that.getParticipantById(participantData.participantId):participantData.jid_im?that.getParticipantByJid(participantData.jid_im):null;if(existingParticipant)$log.debug("[conferenceSession] updateParticipants update participantId="+participantData.participantId),existingParticipant.updateFromData(participantData);else{$log.debug("[conferenceSession] updateParticipants create participantId="+participantData.participantId);var newParticipant=ConferenceParticipant.createFromData(participantData);that.participants.push(newParticipant),result=newParticipant}}})),resolve(result)}))},that.removeParticipants=function(removedParticipants){removedParticipants&&removedParticipants.forEach((function(removedParticipantId){var removedParticipantIndex=that.getParticipantIndexById(removedParticipantId);-1!==removedParticipantIndex&&($log.debug("[conferenceSession] removeParticipants remove participantId="+removedParticipantId),that.participants.splice(removedParticipantIndex,1))}))},that.removePublisher=function(removedPublisherId){if(removedPublisherId){var removedPublisherIndex=that.getPublisherIndexById(removedPublisherId);-1!==removedPublisherIndex&&($log.debug("[conferenceSession] removePublisher remove participantId="+removedPublisherId),that.publishers.splice(removedPublisherIndex,1))}},that.updateTalkers=function(talkers){$log.debug("[conferenceSession] updateTalkers talkers="+talkers),that.talkers=talkers,that.talkerSubject.next(that.talkers)},that.isActive=function(){return void 0!==that.active&&that.active},that.isTalkerActive=function(){return void 0!==that.talkerActive&&that.talkerActive},that.isRecordingStarted=function(){return void 0!==that.recordingStarted&&that.recordingStarted},that.getParticipants=function(){return that.participants},that.getConnectedParticipants=function(){return that.participants?that.participants.filter((function(participant){return"disconnected"!==participant.state&&"watching"!==participant.state})):void 0},that.getWatchingParticipants=function(){return that.participants?that.participants.filter((function(participant){return"watching"===participant.state})):void 0},that.getConnectedParticipantsExceptLeader=function(){return that.participants?that.participants.filter((function(participant){return"disconnected"!==participant.state&&"watching"!==participant.state&&"moderator"!==participant.role})):void 0},that.getConnectedLeaderParticipantsExcept=function(jid){return that.participants?that.participants.filter((function(participant){return"disconnected"!==participant.state&&"moderator"===participant.role&&participant.jid_im!==jid})):void 0},that.getConnectedParticipantsExcept=function(jid){return that.participants?that.participants.filter((function(participant){return participant.jid_im!==jid&&"disconnected"!==participant.state&&"watching"!==participant.state})):void 0},that.getLeaderParticipant=function(){return that.participants?that.participants.find((function(participant){return"moderator"===participant.role&&"disconnected"!==participant.state&&"watching"!==participant.state})):void 0},that.getLeaderParticipantById=function(jid){return that.participants?that.participants.find((function(participant){return"moderator"===participant.role&&"disconnected"!==participant.state&&"watching"!==participant.state&&participant.jid_im===jid})):void 0},that.getParticipantById=function(participantId){return that.participants?that.participants.find((function(participant){return participant.participantId===participantId})):void 0},that.getParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid})):void 0},that.getNonDisconnectedParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid&&"disconnected"!==participant.state})):void 0},that.getConnectedParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid&&"connected"===participant.state})):void 0},that.getWatchingParticipantByJid=function(jid){return that.participants?that.participants.find((function(participant){return participant.jid_im===jid&&"watching"===participant.state})):void 0},that.getParticipantIndexById=function(participantId){return that.participants?that.participants.findIndex((function(participant){return participant.participantId===participantId})):-1},that.getPublisherIndexById=function(publisherId){return that.publishers?that.publishers.findIndex((function(publisher){return publisher.participantId===publisherId})):-1},that.isParticipantConnectedByJid=function(jid){return void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"connected"===participant.state}))},that.isParticipantWatchingByJid=function(jid){return void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"watching"===participant.state}))},that.isParticipantRingingByJid=function(jid){return void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"ringing"===participant.state}))},that.isParticipantConnectedWithThisUAByJid=function(jid){return that.haveJoined&&void 0!==that.participants&&that.participants.some((function(participant){return participant.jid_im===jid&&"connected"===participant.state}))},that.checkIfParticipantHasVideoByPublisherId=function(publisherId){var result=!1;if(that.publishers)for(var i=0;i<that.publishers.length;i++)if("video"===that.publishers[i].mediaType&&that.publishers[i].participantId===publisherId){result=!0;break}return result},that.getCurrentSharingParticipant=function(){var participantId=null;if(that.publishers)for(var i=0;i<that.publishers.length;i++)if("sharing"===that.publishers[i].mediaType){participantId=that.publishers[i].participantId;break}return participantId&&that.participants?that.participants.find((function(participant){return participant.participantId===participantId})):void 0},that.getDelegateParticipantsListExcept=function(jid){var result=[],participants=this.getConnectedParticipantsExcept(jid);if(participants)for(var i=0;i<participants.length;i++)participants[i].delegateCapability&&result.push(participants[i]);return result},that.getTalkers=function(){return that.talkers},that.setCallId=function(callId){that.callId=callId},that.getListOfRemoteVideoPublishers=function(){var result=[];if(that.publishers)for(var i=0;i<that.publishers.length;i++)"video"===that.publishers[i].mediaType&&that.publishers[i].jid_im!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default.a.userContact.jid&&result.push(that.publishers[i]);return result},that.startDuration=function(){that.durationTimer||(that.durationTimer=$interval((function(){that.duration++}),1e3))},that.stopDuration=function(){that.durationTimer&&($interval.cancel(that.durationTimer),that.durationTimer=null,that.duration=0)},that.isInConferenceWithDesktopApp=function(){var remoteSharing=that.getCurrentSharingParticipant();return!(!remoteSharing||!remoteSharing.contact)&&-1!==remoteSharing.contact.fullJid.indexOf("desk_")}}return ConferenceSession.createFromData=function(id,participants,active,type){return type||(type="pstnAudio"),new ConferenceSession(id,participants,active,type)},ConferenceSession.ConferenceView={GalleryView:"gallery_view",SpeakerView:"speaker_view",GridView:"grid_view"},ConferenceSession}])},function(module,exports){module.exports=function(module){return module.webpackPolyfill||(module.deprecate=function(){},module.paths=[],module.children||(module.children=[]),Object.defineProperty(module,"loaded",{enumerable:!0,get:function(){return module.l}}),Object.defineProperty(module,"id",{enumerable:!0,get:function(){return module.i}}),module.webpackPolyfill=1),module}},function(module,exports,__webpack_require__){var map={"./af":82,"./af.js":82,"./ar":83,"./ar-dz":84,"./ar-dz.js":84,"./ar-kw":85,"./ar-kw.js":85,"./ar-ly":86,"./ar-ly.js":86,"./ar-ma":87,"./ar-ma.js":87,"./ar-sa":88,"./ar-sa.js":88,"./ar-tn":89,"./ar-tn.js":89,"./ar.js":83,"./az":90,"./az.js":90,"./be":91,"./be.js":91,"./bg":92,"./bg.js":92,"./bm":93,"./bm.js":93,"./bn":94,"./bn-bd":95,"./bn-bd.js":95,"./bn.js":94,"./bo":96,"./bo.js":96,"./br":97,"./br.js":97,"./bs":98,"./bs.js":98,"./ca":99,"./ca.js":99,"./cs":100,"./cs.js":100,"./cv":101,"./cv.js":101,"./cy":102,"./cy.js":102,"./da":103,"./da.js":103,"./de":104,"./de-at":105,"./de-at.js":105,"./de-ch":106,"./de-ch.js":106,"./de.js":104,"./dv":107,"./dv.js":107,"./el":108,"./el.js":108,"./en-au":109,"./en-au.js":109,"./en-ca":110,"./en-ca.js":110,"./en-gb":111,"./en-gb.js":111,"./en-ie":112,"./en-ie.js":112,"./en-il":113,"./en-il.js":113,"./en-in":114,"./en-in.js":114,"./en-nz":115,"./en-nz.js":115,"./en-sg":116,"./en-sg.js":116,"./eo":117,"./eo.js":117,"./es":118,"./es-do":119,"./es-do.js":119,"./es-mx":120,"./es-mx.js":120,"./es-us":121,"./es-us.js":121,"./es.js":118,"./et":122,"./et.js":122,"./eu":123,"./eu.js":123,"./fa":124,"./fa.js":124,"./fi":125,"./fi.js":125,"./fil":126,"./fil.js":126,"./fo":127,"./fo.js":127,"./fr":128,"./fr-ca":129,"./fr-ca.js":129,"./fr-ch":130,"./fr-ch.js":130,"./fr.js":128,"./fy":131,"./fy.js":131,"./ga":132,"./ga.js":132,"./gd":133,"./gd.js":133,"./gl":134,"./gl.js":134,"./gom-deva":135,"./gom-deva.js":135,"./gom-latn":136,"./gom-latn.js":136,"./gu":137,"./gu.js":137,"./he":138,"./he.js":138,"./hi":139,"./hi.js":139,"./hr":140,"./hr.js":140,"./hu":141,"./hu.js":141,"./hy-am":142,"./hy-am.js":142,"./id":143,"./id.js":143,"./is":144,"./is.js":144,"./it":145,"./it-ch":146,"./it-ch.js":146,"./it.js":145,"./ja":147,"./ja.js":147,"./jv":148,"./jv.js":148,"./ka":149,"./ka.js":149,"./kk":150,"./kk.js":150,"./km":151,"./km.js":151,"./kn":152,"./kn.js":152,"./ko":153,"./ko.js":153,"./ku":154,"./ku.js":154,"./ky":155,"./ky.js":155,"./lb":156,"./lb.js":156,"./lo":157,"./lo.js":157,"./lt":158,"./lt.js":158,"./lv":159,"./lv.js":159,"./me":160,"./me.js":160,"./mi":161,"./mi.js":161,"./mk":162,"./mk.js":162,"./ml":163,"./ml.js":163,"./mn":164,"./mn.js":164,"./mr":165,"./mr.js":165,"./ms":166,"./ms-my":167,"./ms-my.js":167,"./ms.js":166,"./mt":168,"./mt.js":168,"./my":169,"./my.js":169,"./nb":170,"./nb.js":170,"./ne":171,"./ne.js":171,"./nl":172,"./nl-be":173,"./nl-be.js":173,"./nl.js":172,"./nn":174,"./nn.js":174,"./oc-lnc":175,"./oc-lnc.js":175,"./pa-in":176,"./pa-in.js":176,"./pl":177,"./pl.js":177,"./pt":178,"./pt-br":179,"./pt-br.js":179,"./pt.js":178,"./ro":180,"./ro.js":180,"./ru":181,"./ru.js":181,"./sd":182,"./sd.js":182,"./se":183,"./se.js":183,"./si":184,"./si.js":184,"./sk":185,"./sk.js":185,"./sl":186,"./sl.js":186,"./sq":187,"./sq.js":187,"./sr":188,"./sr-cyrl":189,"./sr-cyrl.js":189,"./sr.js":188,"./ss":190,"./ss.js":190,"./sv":191,"./sv.js":191,"./sw":192,"./sw.js":192,"./ta":193,"./ta.js":193,"./te":194,"./te.js":194,"./tet":195,"./tet.js":195,"./tg":196,"./tg.js":196,"./th":197,"./th.js":197,"./tk":198,"./tk.js":198,"./tl-ph":199,"./tl-ph.js":199,"./tlh":200,"./tlh.js":200,"./tr":201,"./tr.js":201,"./tzl":202,"./tzl.js":202,"./tzm":203,"./tzm-latn":204,"./tzm-latn.js":204,"./tzm.js":203,"./ug-cn":205,"./ug-cn.js":205,"./uk":206,"./uk.js":206,"./ur":207,"./ur.js":207,"./uz":208,"./uz-latn":209,"./uz-latn.js":209,"./uz.js":208,"./vi":210,"./vi.js":210,"./x-pseudo":211,"./x-pseudo.js":211,"./yo":212,"./yo.js":212,"./zh-cn":213,"./zh-cn.js":213,"./zh-hk":214,"./zh-hk.js":214,"./zh-mo":215,"./zh-mo.js":215,"./zh-tw":216,"./zh-tw.js":216};function webpackContext(req){var id=webpackContextResolve(req);return __webpack_require__(id)}function webpackContextResolve(req){if(!__webpack_require__.o(map,req)){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}return map[req]}webpackContext.keys=function(){return Object.keys(map)},webpackContext.resolve=webpackContextResolve,module.exports=webpackContext,webpackContext.id=276},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),function(){if("function"==typeof ArrayBuffer){var WordArray=CryptoJS.lib.WordArray,superInit=WordArray.init;(WordArray.init=function(typedArray){if(typedArray instanceof ArrayBuffer&&(typedArray=new Uint8Array(typedArray)),(typedArray instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&typedArray instanceof Uint8ClampedArray||typedArray instanceof Int16Array||typedArray instanceof Uint16Array||typedArray instanceof Int32Array||typedArray instanceof Uint32Array||typedArray instanceof Float32Array||typedArray instanceof Float64Array)&&(typedArray=new Uint8Array(typedArray.buffer,typedArray.byteOffset,typedArray.byteLength)),typedArray instanceof Uint8Array){for(var typedArrayByteLength=typedArray.byteLength,words=[],i=0;i<typedArrayByteLength;i++)words[i>>>2]|=typedArray[i]<<24-i%4*8;superInit.call(this,words,typedArrayByteLength)}else superInit.apply(this,arguments)}).prototype=WordArray}}(),CryptoJS.lib.WordArray)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),function(){var C=CryptoJS,WordArray=C.lib.WordArray,C_enc=C.enc;function swapEndian(word){return word<<8&4278255360|word>>>8&16711935}C_enc.Utf16=C_enc.Utf16BE={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,utf16Chars=[],i=0;i<sigBytes;i+=2){var codePoint=words[i>>>2]>>>16-i%4*8&65535;utf16Chars.push(String.fromCharCode(codePoint))}return utf16Chars.join("")},parse:function(utf16Str){for(var utf16StrLength=utf16Str.length,words=[],i=0;i<utf16StrLength;i++)words[i>>>1]|=utf16Str.charCodeAt(i)<<16-i%2*16;return WordArray.create(words,2*utf16StrLength)}},C_enc.Utf16LE={stringify:function(wordArray){for(var words=wordArray.words,sigBytes=wordArray.sigBytes,utf16Chars=[],i=0;i<sigBytes;i+=2){var codePoint=swapEndian(words[i>>>2]>>>16-i%4*8&65535);utf16Chars.push(String.fromCharCode(codePoint))}return utf16Chars.join("")},parse:function(utf16Str){for(var utf16StrLength=utf16Str.length,words=[],i=0;i<utf16StrLength;i++)words[i>>>1]|=swapEndian(utf16Str.charCodeAt(i)<<16-i%2*16);return WordArray.create(words,2*utf16StrLength)}}}(),CryptoJS.enc.Utf16)},function(module,exports,__webpack_require__){var C,WordArray,C_algo,SHA256,SHA224,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(217),WordArray=(C=CryptoJS).lib.WordArray,C_algo=C.algo,SHA256=C_algo.SHA256,SHA224=C_algo.SHA224=SHA256.extend({_doReset:function(){this._hash=new WordArray.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var hash=SHA256._doFinalize.call(this);return hash.sigBytes-=4,hash}}),C.SHA224=SHA256._createHelper(SHA224),C.HmacSHA224=SHA256._createHmacHelper(SHA224),CryptoJS.SHA224)},function(module,exports,__webpack_require__){var C,C_x64,X64Word,X64WordArray,C_algo,SHA512,SHA384,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(60),__webpack_require__(218),C_x64=(C=CryptoJS).x64,X64Word=C_x64.Word,X64WordArray=C_x64.WordArray,C_algo=C.algo,SHA512=C_algo.SHA512,SHA384=C_algo.SHA384=SHA512.extend({_doReset:function(){this._hash=new X64WordArray.init([new X64Word.init(3418070365,3238371032),new X64Word.init(1654270250,914150663),new X64Word.init(2438529370,812702999),new X64Word.init(355462360,4144912697),new X64Word.init(1731405415,4290775857),new X64Word.init(2394180231,1750603025),new X64Word.init(3675008525,1694076839),new X64Word.init(1203062813,3204075428)])},_doFinalize:function(){var hash=SHA512._doFinalize.call(this);return hash.sigBytes-=16,hash}}),C.SHA384=SHA512._createHelper(SHA384),C.HmacSHA384=SHA512._createHmacHelper(SHA384),CryptoJS.SHA384)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(60),function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,X64Word=C.x64.Word,C_algo=C.algo,RHO_OFFSETS=[],PI_INDEXES=[],ROUND_CONSTANTS=[];!function(){for(var x=1,y=0,t=0;t<24;t++){RHO_OFFSETS[x+5*y]=(t+1)*(t+2)/2%64;var newY=(2*x+3*y)%5;x=y%5,y=newY}for(x=0;x<5;x++)for(y=0;y<5;y++)PI_INDEXES[x+5*y]=y+(2*x+3*y)%5*5;for(var LFSR=1,i=0;i<24;i++){for(var roundConstantMsw=0,roundConstantLsw=0,j=0;j<7;j++){if(1&LFSR){var bitPosition=(1<<j)-1;bitPosition<32?roundConstantLsw^=1<<bitPosition:roundConstantMsw^=1<<bitPosition-32}128&LFSR?LFSR=LFSR<<1^113:LFSR<<=1}ROUND_CONSTANTS[i]=X64Word.create(roundConstantMsw,roundConstantLsw)}}();var T=[];!function(){for(var i=0;i<25;i++)T[i]=X64Word.create()}();var SHA3=C_algo.SHA3=Hasher.extend({cfg:Hasher.cfg.extend({outputLength:512}),_doReset:function(){for(var state=this._state=[],i=0;i<25;i++)state[i]=new X64Word.init;this.blockSize=(1600-2*this.cfg.outputLength)/32},_doProcessBlock:function(M,offset){for(var state=this._state,nBlockSizeLanes=this.blockSize/2,i=0;i<nBlockSizeLanes;i++){var M2i=M[offset+2*i],M2i1=M[offset+2*i+1];M2i=16711935&(M2i<<8|M2i>>>24)|4278255360&(M2i<<24|M2i>>>8),M2i1=16711935&(M2i1<<8|M2i1>>>24)|4278255360&(M2i1<<24|M2i1>>>8),(lane=state[i]).high^=M2i1,lane.low^=M2i}for(var round=0;round<24;round++){for(var x=0;x<5;x++){for(var tMsw=0,tLsw=0,y=0;y<5;y++)tMsw^=(lane=state[x+5*y]).high,tLsw^=lane.low;var Tx=T[x];Tx.high=tMsw,Tx.low=tLsw}for(x=0;x<5;x++){var Tx4=T[(x+4)%5],Tx1=T[(x+1)%5],Tx1Msw=Tx1.high,Tx1Lsw=Tx1.low;for(tMsw=Tx4.high^(Tx1Msw<<1|Tx1Lsw>>>31),tLsw=Tx4.low^(Tx1Lsw<<1|Tx1Msw>>>31),y=0;y<5;y++)(lane=state[x+5*y]).high^=tMsw,lane.low^=tLsw}for(var laneIndex=1;laneIndex<25;laneIndex++){var laneMsw=(lane=state[laneIndex]).high,laneLsw=lane.low,rhoOffset=RHO_OFFSETS[laneIndex];rhoOffset<32?(tMsw=laneMsw<<rhoOffset|laneLsw>>>32-rhoOffset,tLsw=laneLsw<<rhoOffset|laneMsw>>>32-rhoOffset):(tMsw=laneLsw<<rhoOffset-32|laneMsw>>>64-rhoOffset,tLsw=laneMsw<<rhoOffset-32|laneLsw>>>64-rhoOffset);var TPiLane=T[PI_INDEXES[laneIndex]];TPiLane.high=tMsw,TPiLane.low=tLsw}var T0=T[0],state0=state[0];for(T0.high=state0.high,T0.low=state0.low,x=0;x<5;x++)for(y=0;y<5;y++){var lane=state[laneIndex=x+5*y],TLane=T[laneIndex],Tx1Lane=T[(x+1)%5+5*y],Tx2Lane=T[(x+2)%5+5*y];lane.high=TLane.high^~Tx1Lane.high&Tx2Lane.high,lane.low=TLane.low^~Tx1Lane.low&Tx2Lane.low}lane=state[0];var roundConstant=ROUND_CONSTANTS[round];lane.high^=roundConstant.high,lane.low^=roundConstant.low}},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsLeft=(this._nDataBytes,8*data.sigBytes),blockSizeBits=32*this.blockSize;dataWords[nBitsLeft>>>5]|=1<<24-nBitsLeft%32,dataWords[(Math.ceil((nBitsLeft+1)/blockSizeBits)*blockSizeBits>>>5)-1]|=128,data.sigBytes=4*dataWords.length,this._process();for(var state=this._state,outputLengthBytes=this.cfg.outputLength/8,outputLengthLanes=outputLengthBytes/8,hashWords=[],i=0;i<outputLengthLanes;i++){var lane=state[i],laneMsw=lane.high,laneLsw=lane.low;laneMsw=16711935&(laneMsw<<8|laneMsw>>>24)|4278255360&(laneMsw<<24|laneMsw>>>8),laneLsw=16711935&(laneLsw<<8|laneLsw>>>24)|4278255360&(laneLsw<<24|laneLsw>>>8),hashWords.push(laneLsw),hashWords.push(laneMsw)}return new WordArray.init(hashWords,outputLengthBytes)},clone:function(){for(var clone=Hasher.clone.call(this),state=clone._state=this._state.slice(0),i=0;i<25;i++)state[i]=state[i].clone();return clone}});C.SHA3=Hasher._createHelper(SHA3),C.HmacSHA3=Hasher._createHmacHelper(SHA3)}(Math),CryptoJS.SHA3)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),
/** @preserve
	(c) 2012 by Cdric Mesnil. All rights reserved.

	Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

	    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
	    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	*/
function(Math){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,Hasher=C_lib.Hasher,C_algo=C.algo,_zl=WordArray.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),_zr=WordArray.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),_sl=WordArray.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),_sr=WordArray.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),_hl=WordArray.create([0,1518500249,1859775393,2400959708,2840853838]),_hr=WordArray.create([1352829926,1548603684,1836072691,2053994217,0]),RIPEMD160=C_algo.RIPEMD160=Hasher.extend({_doReset:function(){this._hash=WordArray.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(M,offset){for(var i=0;i<16;i++){var offset_i=offset+i,M_offset_i=M[offset_i];M[offset_i]=16711935&(M_offset_i<<8|M_offset_i>>>24)|4278255360&(M_offset_i<<24|M_offset_i>>>8)}var al,bl,cl,dl,el,ar,br,cr,dr,er,t,H=this._hash.words,hl=_hl.words,hr=_hr.words,zl=_zl.words,zr=_zr.words,sl=_sl.words,sr=_sr.words;for(ar=al=H[0],br=bl=H[1],cr=cl=H[2],dr=dl=H[3],er=el=H[4],i=0;i<80;i+=1)t=al+M[offset+zl[i]]|0,t+=i<16?f1(bl,cl,dl)+hl[0]:i<32?f2(bl,cl,dl)+hl[1]:i<48?f3(bl,cl,dl)+hl[2]:i<64?f4(bl,cl,dl)+hl[3]:f5(bl,cl,dl)+hl[4],t=(t=rotl(t|=0,sl[i]))+el|0,al=el,el=dl,dl=rotl(cl,10),cl=bl,bl=t,t=ar+M[offset+zr[i]]|0,t+=i<16?f5(br,cr,dr)+hr[0]:i<32?f4(br,cr,dr)+hr[1]:i<48?f3(br,cr,dr)+hr[2]:i<64?f2(br,cr,dr)+hr[3]:f1(br,cr,dr)+hr[4],t=(t=rotl(t|=0,sr[i]))+er|0,ar=er,er=dr,dr=rotl(cr,10),cr=br,br=t;t=H[1]+cl+dr|0,H[1]=H[2]+dl+er|0,H[2]=H[3]+el+ar|0,H[3]=H[4]+al+br|0,H[4]=H[0]+bl+cr|0,H[0]=t},_doFinalize:function(){var data=this._data,dataWords=data.words,nBitsTotal=8*this._nDataBytes,nBitsLeft=8*data.sigBytes;dataWords[nBitsLeft>>>5]|=128<<24-nBitsLeft%32,dataWords[14+(nBitsLeft+64>>>9<<4)]=16711935&(nBitsTotal<<8|nBitsTotal>>>24)|4278255360&(nBitsTotal<<24|nBitsTotal>>>8),data.sigBytes=4*(dataWords.length+1),this._process();for(var hash=this._hash,H=hash.words,i=0;i<5;i++){var H_i=H[i];H[i]=16711935&(H_i<<8|H_i>>>24)|4278255360&(H_i<<24|H_i>>>8)}return hash},clone:function(){var clone=Hasher.clone.call(this);return clone._hash=this._hash.clone(),clone}});function f1(x,y,z){return x^y^z}function f2(x,y,z){return x&y|~x&z}function f3(x,y,z){return(x|~y)^z}function f4(x,y,z){return x&z|y&~z}function f5(x,y,z){return x^(y|~z)}function rotl(x,n){return x<<n|x>>>32-n}C.RIPEMD160=Hasher._createHelper(RIPEMD160),C.HmacRIPEMD160=Hasher._createHmacHelper(RIPEMD160)}(Math),CryptoJS.RIPEMD160)},function(module,exports,__webpack_require__){var C,C_lib,Base,WordArray,C_algo,SHA1,HMAC,PBKDF2,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(72),__webpack_require__(73),C_lib=(C=CryptoJS).lib,Base=C_lib.Base,WordArray=C_lib.WordArray,C_algo=C.algo,SHA1=C_algo.SHA1,HMAC=C_algo.HMAC,PBKDF2=C_algo.PBKDF2=Base.extend({cfg:Base.extend({keySize:4,hasher:SHA1,iterations:1}),init:function(cfg){this.cfg=this.cfg.extend(cfg)},compute:function(password,salt){for(var cfg=this.cfg,hmac=HMAC.create(cfg.hasher,password),derivedKey=WordArray.create(),blockIndex=WordArray.create([1]),derivedKeyWords=derivedKey.words,blockIndexWords=blockIndex.words,keySize=cfg.keySize,iterations=cfg.iterations;derivedKeyWords.length<keySize;){var block=hmac.update(salt).finalize(blockIndex);hmac.reset();for(var blockWords=block.words,blockWordsLength=blockWords.length,intermediate=block,i=1;i<iterations;i++){intermediate=hmac.finalize(intermediate),hmac.reset();for(var intermediateWords=intermediate.words,j=0;j<blockWordsLength;j++)blockWords[j]^=intermediateWords[j]}derivedKey.concat(block),blockIndexWords[0]++}return derivedKey.sigBytes=4*keySize,derivedKey}}),C.PBKDF2=function(password,salt,cfg){return PBKDF2.create(cfg).compute(password,salt)},CryptoJS.PBKDF2)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.mode.CFB=function(){var CFB=CryptoJS.lib.BlockCipherMode.extend();function generateKeystreamAndEncrypt(words,offset,blockSize,cipher){var iv=this._iv;if(iv){var keystream=iv.slice(0);this._iv=void 0}else keystream=this._prevBlock;cipher.encryptBlock(keystream,0);for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}return CFB.Encryptor=CFB.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize;generateKeystreamAndEncrypt.call(this,words,offset,blockSize,cipher),this._prevBlock=words.slice(offset,offset+blockSize)}}),CFB.Decryptor=CFB.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,thisBlock=words.slice(offset,offset+blockSize);generateKeystreamAndEncrypt.call(this,words,offset,blockSize,cipher),this._prevBlock=thisBlock}}),CFB}(),CryptoJS.mode.CFB)},function(module,exports,__webpack_require__){var CTR,Encryptor,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.mode.CTR=(CTR=CryptoJS.lib.BlockCipherMode.extend(),Encryptor=CTR.Encryptor=CTR.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,iv=this._iv,counter=this._counter;iv&&(counter=this._counter=iv.slice(0),this._iv=void 0);var keystream=counter.slice(0);cipher.encryptBlock(keystream,0),counter[blockSize-1]=counter[blockSize-1]+1|0;for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}}),CTR.Decryptor=Encryptor,CTR),CryptoJS.mode.CTR)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),
/** @preserve
	 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
	 * derived from CryptoJS.mode.CTR
	 * Jan Hruby jhruby.web@gmail.com
	 */
CryptoJS.mode.CTRGladman=function(){var CTRGladman=CryptoJS.lib.BlockCipherMode.extend();function incWord(word){if(255==(word>>24&255)){var b1=word>>16&255,b2=word>>8&255,b3=255&word;255===b1?(b1=0,255===b2?(b2=0,255===b3?b3=0:++b3):++b2):++b1,word=0,word+=b1<<16,word+=b2<<8,word+=b3}else word+=1<<24;return word}var Encryptor=CTRGladman.Encryptor=CTRGladman.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,iv=this._iv,counter=this._counter;iv&&(counter=this._counter=iv.slice(0),this._iv=void 0),function(counter){0===(counter[0]=incWord(counter[0]))&&(counter[1]=incWord(counter[1]))}(counter);var keystream=counter.slice(0);cipher.encryptBlock(keystream,0);for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}});return CTRGladman.Decryptor=Encryptor,CTRGladman}(),CryptoJS.mode.CTRGladman)},function(module,exports,__webpack_require__){var OFB,Encryptor,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.mode.OFB=(OFB=CryptoJS.lib.BlockCipherMode.extend(),Encryptor=OFB.Encryptor=OFB.extend({processBlock:function(words,offset){var cipher=this._cipher,blockSize=cipher.blockSize,iv=this._iv,keystream=this._keystream;iv&&(keystream=this._keystream=iv.slice(0),this._iv=void 0),cipher.encryptBlock(keystream,0);for(var i=0;i<blockSize;i++)words[offset+i]^=keystream[i]}}),OFB.Decryptor=Encryptor,OFB),CryptoJS.mode.OFB)},function(module,exports,__webpack_require__){var ECB,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.mode.ECB=((ECB=CryptoJS.lib.BlockCipherMode.extend()).Encryptor=ECB.extend({processBlock:function(words,offset){this._cipher.encryptBlock(words,offset)}}),ECB.Decryptor=ECB.extend({processBlock:function(words,offset){this._cipher.decryptBlock(words,offset)}}),ECB),CryptoJS.mode.ECB)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.pad.AnsiX923={pad:function(data,blockSize){var dataSigBytes=data.sigBytes,blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-dataSigBytes%blockSizeBytes,lastBytePos=dataSigBytes+nPaddingBytes-1;data.clamp(),data.words[lastBytePos>>>2]|=nPaddingBytes<<24-lastBytePos%4*8,data.sigBytes+=nPaddingBytes},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},CryptoJS.pad.Ansix923)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.pad.Iso10126={pad:function(data,blockSize){var blockSizeBytes=4*blockSize,nPaddingBytes=blockSizeBytes-data.sigBytes%blockSizeBytes;data.concat(CryptoJS.lib.WordArray.random(nPaddingBytes-1)).concat(CryptoJS.lib.WordArray.create([nPaddingBytes<<24],1))},unpad:function(data){var nPaddingBytes=255&data.words[data.sigBytes-1>>>2];data.sigBytes-=nPaddingBytes}},CryptoJS.pad.Iso10126)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.pad.Iso97971={pad:function(data,blockSize){data.concat(CryptoJS.lib.WordArray.create([2147483648],1)),CryptoJS.pad.ZeroPadding.pad(data,blockSize)},unpad:function(data){CryptoJS.pad.ZeroPadding.unpad(data),data.sigBytes--}},CryptoJS.pad.Iso97971)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.pad.ZeroPadding={pad:function(data,blockSize){var blockSizeBytes=4*blockSize;data.clamp(),data.sigBytes+=blockSizeBytes-(data.sigBytes%blockSizeBytes||blockSizeBytes)},unpad:function(data){for(var dataWords=data.words,i=data.sigBytes-1;!(dataWords[i>>>2]>>>24-i%4*8&255);)i--;data.sigBytes=i+1}},CryptoJS.pad.ZeroPadding)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CryptoJS.pad.NoPadding={pad:function(){},unpad:function(){}},CryptoJS.pad.NoPadding)},function(module,exports,__webpack_require__){var C,CipherParams,Hex,CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(20),CipherParams=(C=CryptoJS).lib.CipherParams,Hex=C.enc.Hex,C.format.Hex={stringify:function(cipherParams){return cipherParams.ciphertext.toString(Hex)},parse:function(input){var ciphertext=Hex.parse(input);return CipherParams.create({ciphertext:ciphertext})}},CryptoJS.format.Hex)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(46),__webpack_require__(47),__webpack_require__(40),__webpack_require__(20),function(){var C=CryptoJS,BlockCipher=C.lib.BlockCipher,C_algo=C.algo,SBOX=[],INV_SBOX=[],SUB_MIX_0=[],SUB_MIX_1=[],SUB_MIX_2=[],SUB_MIX_3=[],INV_SUB_MIX_0=[],INV_SUB_MIX_1=[],INV_SUB_MIX_2=[],INV_SUB_MIX_3=[];!function(){for(var d=[],i=0;i<256;i++)d[i]=i<128?i<<1:i<<1^283;var x=0,xi=0;for(i=0;i<256;i++){var sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,SBOX[x]=sx,INV_SBOX[sx]=x;var x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;SUB_MIX_0[x]=t<<24|t>>>8,SUB_MIX_1[x]=t<<16|t>>>16,SUB_MIX_2[x]=t<<8|t>>>24,SUB_MIX_3[x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,INV_SUB_MIX_0[sx]=t<<24|t>>>8,INV_SUB_MIX_1[sx]=t<<16|t>>>16,INV_SUB_MIX_2[sx]=t<<8|t>>>24,INV_SUB_MIX_3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}}();var RCON=[0,1,2,4,8,16,32,64,128,27,54],AES=C_algo.AES=BlockCipher.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var key=this._keyPriorReset=this._key,keyWords=key.words,keySize=key.sigBytes/4,ksRows=4*((this._nRounds=keySize+6)+1),keySchedule=this._keySchedule=[],ksRow=0;ksRow<ksRows;ksRow++)if(ksRow<keySize)keySchedule[ksRow]=keyWords[ksRow];else{var t=keySchedule[ksRow-1];ksRow%keySize?keySize>6&&ksRow%keySize==4&&(t=SBOX[t>>>24]<<24|SBOX[t>>>16&255]<<16|SBOX[t>>>8&255]<<8|SBOX[255&t]):(t=SBOX[(t=t<<8|t>>>24)>>>24]<<24|SBOX[t>>>16&255]<<16|SBOX[t>>>8&255]<<8|SBOX[255&t],t^=RCON[ksRow/keySize|0]<<24),keySchedule[ksRow]=keySchedule[ksRow-keySize]^t}for(var invKeySchedule=this._invKeySchedule=[],invKsRow=0;invKsRow<ksRows;invKsRow++)ksRow=ksRows-invKsRow,t=invKsRow%4?keySchedule[ksRow]:keySchedule[ksRow-4],invKeySchedule[invKsRow]=invKsRow<4||ksRow<=4?t:INV_SUB_MIX_0[SBOX[t>>>24]]^INV_SUB_MIX_1[SBOX[t>>>16&255]]^INV_SUB_MIX_2[SBOX[t>>>8&255]]^INV_SUB_MIX_3[SBOX[255&t]]}},encryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._keySchedule,SUB_MIX_0,SUB_MIX_1,SUB_MIX_2,SUB_MIX_3,SBOX)},decryptBlock:function(M,offset){var t=M[offset+1];M[offset+1]=M[offset+3],M[offset+3]=t,this._doCryptBlock(M,offset,this._invKeySchedule,INV_SUB_MIX_0,INV_SUB_MIX_1,INV_SUB_MIX_2,INV_SUB_MIX_3,INV_SBOX),t=M[offset+1],M[offset+1]=M[offset+3],M[offset+3]=t},_doCryptBlock:function(M,offset,keySchedule,SUB_MIX_0,SUB_MIX_1,SUB_MIX_2,SUB_MIX_3,SBOX){for(var nRounds=this._nRounds,s0=M[offset]^keySchedule[0],s1=M[offset+1]^keySchedule[1],s2=M[offset+2]^keySchedule[2],s3=M[offset+3]^keySchedule[3],ksRow=4,round=1;round<nRounds;round++){var t0=SUB_MIX_0[s0>>>24]^SUB_MIX_1[s1>>>16&255]^SUB_MIX_2[s2>>>8&255]^SUB_MIX_3[255&s3]^keySchedule[ksRow++],t1=SUB_MIX_0[s1>>>24]^SUB_MIX_1[s2>>>16&255]^SUB_MIX_2[s3>>>8&255]^SUB_MIX_3[255&s0]^keySchedule[ksRow++],t2=SUB_MIX_0[s2>>>24]^SUB_MIX_1[s3>>>16&255]^SUB_MIX_2[s0>>>8&255]^SUB_MIX_3[255&s1]^keySchedule[ksRow++],t3=SUB_MIX_0[s3>>>24]^SUB_MIX_1[s0>>>16&255]^SUB_MIX_2[s1>>>8&255]^SUB_MIX_3[255&s2]^keySchedule[ksRow++];s0=t0,s1=t1,s2=t2,s3=t3}t0=(SBOX[s0>>>24]<<24|SBOX[s1>>>16&255]<<16|SBOX[s2>>>8&255]<<8|SBOX[255&s3])^keySchedule[ksRow++],t1=(SBOX[s1>>>24]<<24|SBOX[s2>>>16&255]<<16|SBOX[s3>>>8&255]<<8|SBOX[255&s0])^keySchedule[ksRow++],t2=(SBOX[s2>>>24]<<24|SBOX[s3>>>16&255]<<16|SBOX[s0>>>8&255]<<8|SBOX[255&s1])^keySchedule[ksRow++],t3=(SBOX[s3>>>24]<<24|SBOX[s0>>>16&255]<<16|SBOX[s1>>>8&255]<<8|SBOX[255&s2])^keySchedule[ksRow++],M[offset]=t0,M[offset+1]=t1,M[offset+2]=t2,M[offset+3]=t3},keySize:8});C.AES=BlockCipher._createHelper(AES)}(),CryptoJS.AES)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(46),__webpack_require__(47),__webpack_require__(40),__webpack_require__(20),function(){var C=CryptoJS,C_lib=C.lib,WordArray=C_lib.WordArray,BlockCipher=C_lib.BlockCipher,C_algo=C.algo,PC1=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],PC2=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],BIT_SHIFTS=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],SBOX_P=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],SBOX_MASK=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],DES=C_algo.DES=BlockCipher.extend({_doReset:function(){for(var keyWords=this._key.words,keyBits=[],i=0;i<56;i++){var keyBitPos=PC1[i]-1;keyBits[i]=keyWords[keyBitPos>>>5]>>>31-keyBitPos%32&1}for(var subKeys=this._subKeys=[],nSubKey=0;nSubKey<16;nSubKey++){var subKey=subKeys[nSubKey]=[],bitShift=BIT_SHIFTS[nSubKey];for(i=0;i<24;i++)subKey[i/6|0]|=keyBits[(PC2[i]-1+bitShift)%28]<<31-i%6,subKey[4+(i/6|0)]|=keyBits[28+(PC2[i+24]-1+bitShift)%28]<<31-i%6;for(subKey[0]=subKey[0]<<1|subKey[0]>>>31,i=1;i<7;i++)subKey[i]=subKey[i]>>>4*(i-1)+3;subKey[7]=subKey[7]<<5|subKey[7]>>>27}var invSubKeys=this._invSubKeys=[];for(i=0;i<16;i++)invSubKeys[i]=subKeys[15-i]},encryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._subKeys)},decryptBlock:function(M,offset){this._doCryptBlock(M,offset,this._invSubKeys)},_doCryptBlock:function(M,offset,subKeys){this._lBlock=M[offset],this._rBlock=M[offset+1],exchangeLR.call(this,4,252645135),exchangeLR.call(this,16,65535),exchangeRL.call(this,2,858993459),exchangeRL.call(this,8,16711935),exchangeLR.call(this,1,1431655765);for(var round=0;round<16;round++){for(var subKey=subKeys[round],lBlock=this._lBlock,rBlock=this._rBlock,f=0,i=0;i<8;i++)f|=SBOX_P[i][((rBlock^subKey[i])&SBOX_MASK[i])>>>0];this._lBlock=rBlock,this._rBlock=lBlock^f}var t=this._lBlock;this._lBlock=this._rBlock,this._rBlock=t,exchangeLR.call(this,1,1431655765),exchangeRL.call(this,8,16711935),exchangeRL.call(this,2,858993459),exchangeLR.call(this,16,65535),exchangeLR.call(this,4,252645135),M[offset]=this._lBlock,M[offset+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});function exchangeLR(offset,mask){var t=(this._lBlock>>>offset^this._rBlock)&mask;this._rBlock^=t,this._lBlock^=t<<offset}function exchangeRL(offset,mask){var t=(this._rBlock>>>offset^this._lBlock)&mask;this._lBlock^=t,this._rBlock^=t<<offset}C.DES=BlockCipher._createHelper(DES);var TripleDES=C_algo.TripleDES=BlockCipher.extend({_doReset:function(){var keyWords=this._key.words;this._des1=DES.createEncryptor(WordArray.create(keyWords.slice(0,2))),this._des2=DES.createEncryptor(WordArray.create(keyWords.slice(2,4))),this._des3=DES.createEncryptor(WordArray.create(keyWords.slice(4,6)))},encryptBlock:function(M,offset){this._des1.encryptBlock(M,offset),this._des2.decryptBlock(M,offset),this._des3.encryptBlock(M,offset)},decryptBlock:function(M,offset){this._des3.decryptBlock(M,offset),this._des2.encryptBlock(M,offset),this._des1.decryptBlock(M,offset)},keySize:6,ivSize:2,blockSize:2});C.TripleDES=BlockCipher._createHelper(TripleDES)}(),CryptoJS.TripleDES)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(46),__webpack_require__(47),__webpack_require__(40),__webpack_require__(20),function(){var C=CryptoJS,StreamCipher=C.lib.StreamCipher,C_algo=C.algo,RC4=C_algo.RC4=StreamCipher.extend({_doReset:function(){for(var key=this._key,keyWords=key.words,keySigBytes=key.sigBytes,S=this._S=[],i=0;i<256;i++)S[i]=i;i=0;for(var j=0;i<256;i++){var keyByteIndex=i%keySigBytes,keyByte=keyWords[keyByteIndex>>>2]>>>24-keyByteIndex%4*8&255;j=(j+S[i]+keyByte)%256;var t=S[i];S[i]=S[j],S[j]=t}this._i=this._j=0},_doProcessBlock:function(M,offset){M[offset]^=generateKeystreamWord.call(this)},keySize:8,ivSize:0});function generateKeystreamWord(){for(var S=this._S,i=this._i,j=this._j,keystreamWord=0,n=0;n<4;n++){j=(j+S[i=(i+1)%256])%256;var t=S[i];S[i]=S[j],S[j]=t,keystreamWord|=S[(S[i]+S[j])%256]<<24-8*n}return this._i=i,this._j=j,keystreamWord}C.RC4=StreamCipher._createHelper(RC4);var RC4Drop=C_algo.RC4Drop=RC4.extend({cfg:RC4.cfg.extend({drop:192}),_doReset:function(){RC4._doReset.call(this);for(var i=this.cfg.drop;i>0;i--)generateKeystreamWord.call(this)}});C.RC4Drop=StreamCipher._createHelper(RC4Drop)}(),CryptoJS.RC4)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(46),__webpack_require__(47),__webpack_require__(40),__webpack_require__(20),function(){var C=CryptoJS,StreamCipher=C.lib.StreamCipher,C_algo=C.algo,S=[],C_=[],G=[],Rabbit=C_algo.Rabbit=StreamCipher.extend({_doReset:function(){for(var K=this._key.words,iv=this.cfg.iv,i=0;i<4;i++)K[i]=16711935&(K[i]<<8|K[i]>>>24)|4278255360&(K[i]<<24|K[i]>>>8);var X=this._X=[K[0],K[3]<<16|K[2]>>>16,K[1],K[0]<<16|K[3]>>>16,K[2],K[1]<<16|K[0]>>>16,K[3],K[2]<<16|K[1]>>>16],C=this._C=[K[2]<<16|K[2]>>>16,4294901760&K[0]|65535&K[1],K[3]<<16|K[3]>>>16,4294901760&K[1]|65535&K[2],K[0]<<16|K[0]>>>16,4294901760&K[2]|65535&K[3],K[1]<<16|K[1]>>>16,4294901760&K[3]|65535&K[0]];for(this._b=0,i=0;i<4;i++)nextState.call(this);for(i=0;i<8;i++)C[i]^=X[i+4&7];if(iv){var IV=iv.words,IV_0=IV[0],IV_1=IV[1],i0=16711935&(IV_0<<8|IV_0>>>24)|4278255360&(IV_0<<24|IV_0>>>8),i2=16711935&(IV_1<<8|IV_1>>>24)|4278255360&(IV_1<<24|IV_1>>>8),i1=i0>>>16|4294901760&i2,i3=i2<<16|65535&i0;for(C[0]^=i0,C[1]^=i1,C[2]^=i2,C[3]^=i3,C[4]^=i0,C[5]^=i1,C[6]^=i2,C[7]^=i3,i=0;i<4;i++)nextState.call(this)}},_doProcessBlock:function(M,offset){var X=this._X;nextState.call(this),S[0]=X[0]^X[5]>>>16^X[3]<<16,S[1]=X[2]^X[7]>>>16^X[5]<<16,S[2]=X[4]^X[1]>>>16^X[7]<<16,S[3]=X[6]^X[3]>>>16^X[1]<<16;for(var i=0;i<4;i++)S[i]=16711935&(S[i]<<8|S[i]>>>24)|4278255360&(S[i]<<24|S[i]>>>8),M[offset+i]^=S[i]},blockSize:4,ivSize:2});function nextState(){for(var X=this._X,C=this._C,i=0;i<8;i++)C_[i]=C[i];for(C[0]=C[0]+1295307597+this._b|0,C[1]=C[1]+3545052371+(C[0]>>>0<C_[0]>>>0?1:0)|0,C[2]=C[2]+886263092+(C[1]>>>0<C_[1]>>>0?1:0)|0,C[3]=C[3]+1295307597+(C[2]>>>0<C_[2]>>>0?1:0)|0,C[4]=C[4]+3545052371+(C[3]>>>0<C_[3]>>>0?1:0)|0,C[5]=C[5]+886263092+(C[4]>>>0<C_[4]>>>0?1:0)|0,C[6]=C[6]+1295307597+(C[5]>>>0<C_[5]>>>0?1:0)|0,C[7]=C[7]+3545052371+(C[6]>>>0<C_[6]>>>0?1:0)|0,this._b=C[7]>>>0<C_[7]>>>0?1:0,i=0;i<8;i++){var gx=X[i]+C[i],ga=65535&gx,gb=gx>>>16,gh=((ga*ga>>>17)+ga*gb>>>15)+gb*gb,gl=((4294901760&gx)*gx|0)+((65535&gx)*gx|0);G[i]=gh^gl}X[0]=G[0]+(G[7]<<16|G[7]>>>16)+(G[6]<<16|G[6]>>>16)|0,X[1]=G[1]+(G[0]<<8|G[0]>>>24)+G[7]|0,X[2]=G[2]+(G[1]<<16|G[1]>>>16)+(G[0]<<16|G[0]>>>16)|0,X[3]=G[3]+(G[2]<<8|G[2]>>>24)+G[1]|0,X[4]=G[4]+(G[3]<<16|G[3]>>>16)+(G[2]<<16|G[2]>>>16)|0,X[5]=G[5]+(G[4]<<8|G[4]>>>24)+G[3]|0,X[6]=G[6]+(G[5]<<16|G[5]>>>16)+(G[4]<<16|G[4]>>>16)|0,X[7]=G[7]+(G[6]<<8|G[6]>>>24)+G[5]|0}C.Rabbit=StreamCipher._createHelper(Rabbit)}(),CryptoJS.Rabbit)},function(module,exports,__webpack_require__){var CryptoJS;module.exports=(CryptoJS=__webpack_require__(12),__webpack_require__(46),__webpack_require__(47),__webpack_require__(40),__webpack_require__(20),function(){var C=CryptoJS,StreamCipher=C.lib.StreamCipher,C_algo=C.algo,S=[],C_=[],G=[],RabbitLegacy=C_algo.RabbitLegacy=StreamCipher.extend({_doReset:function(){var K=this._key.words,iv=this.cfg.iv,X=this._X=[K[0],K[3]<<16|K[2]>>>16,K[1],K[0]<<16|K[3]>>>16,K[2],K[1]<<16|K[0]>>>16,K[3],K[2]<<16|K[1]>>>16],C=this._C=[K[2]<<16|K[2]>>>16,4294901760&K[0]|65535&K[1],K[3]<<16|K[3]>>>16,4294901760&K[1]|65535&K[2],K[0]<<16|K[0]>>>16,4294901760&K[2]|65535&K[3],K[1]<<16|K[1]>>>16,4294901760&K[3]|65535&K[0]];this._b=0;for(var i=0;i<4;i++)nextState.call(this);for(i=0;i<8;i++)C[i]^=X[i+4&7];if(iv){var IV=iv.words,IV_0=IV[0],IV_1=IV[1],i0=16711935&(IV_0<<8|IV_0>>>24)|4278255360&(IV_0<<24|IV_0>>>8),i2=16711935&(IV_1<<8|IV_1>>>24)|4278255360&(IV_1<<24|IV_1>>>8),i1=i0>>>16|4294901760&i2,i3=i2<<16|65535&i0;for(C[0]^=i0,C[1]^=i1,C[2]^=i2,C[3]^=i3,C[4]^=i0,C[5]^=i1,C[6]^=i2,C[7]^=i3,i=0;i<4;i++)nextState.call(this)}},_doProcessBlock:function(M,offset){var X=this._X;nextState.call(this),S[0]=X[0]^X[5]>>>16^X[3]<<16,S[1]=X[2]^X[7]>>>16^X[5]<<16,S[2]=X[4]^X[1]>>>16^X[7]<<16,S[3]=X[6]^X[3]>>>16^X[1]<<16;for(var i=0;i<4;i++)S[i]=16711935&(S[i]<<8|S[i]>>>24)|4278255360&(S[i]<<24|S[i]>>>8),M[offset+i]^=S[i]},blockSize:4,ivSize:2});function nextState(){for(var X=this._X,C=this._C,i=0;i<8;i++)C_[i]=C[i];for(C[0]=C[0]+1295307597+this._b|0,C[1]=C[1]+3545052371+(C[0]>>>0<C_[0]>>>0?1:0)|0,C[2]=C[2]+886263092+(C[1]>>>0<C_[1]>>>0?1:0)|0,C[3]=C[3]+1295307597+(C[2]>>>0<C_[2]>>>0?1:0)|0,C[4]=C[4]+3545052371+(C[3]>>>0<C_[3]>>>0?1:0)|0,C[5]=C[5]+886263092+(C[4]>>>0<C_[4]>>>0?1:0)|0,C[6]=C[6]+1295307597+(C[5]>>>0<C_[5]>>>0?1:0)|0,C[7]=C[7]+3545052371+(C[6]>>>0<C_[6]>>>0?1:0)|0,this._b=C[7]>>>0<C_[7]>>>0?1:0,i=0;i<8;i++){var gx=X[i]+C[i],ga=65535&gx,gb=gx>>>16,gh=((ga*ga>>>17)+ga*gb>>>15)+gb*gb,gl=((4294901760&gx)*gx|0)+((65535&gx)*gx|0);G[i]=gh^gl}X[0]=G[0]+(G[7]<<16|G[7]>>>16)+(G[6]<<16|G[6]>>>16)|0,X[1]=G[1]+(G[0]<<8|G[0]>>>24)+G[7]|0,X[2]=G[2]+(G[1]<<16|G[1]>>>16)+(G[0]<<16|G[0]>>>16)|0,X[3]=G[3]+(G[2]<<8|G[2]>>>24)+G[1]|0,X[4]=G[4]+(G[3]<<16|G[3]>>>16)+(G[2]<<16|G[2]>>>16)|0,X[5]=G[5]+(G[4]<<8|G[4]>>>24)+G[3]|0,X[6]=G[6]+(G[5]<<16|G[5]>>>16)+(G[4]<<16|G[4]>>>16)|0,X[7]=G[7]+(G[6]<<8|G[6]>>>24)+G[5]|0}C.RabbitLegacy=StreamCipher._createHelper(RabbitLegacy)}(),CryptoJS.RabbitLegacy)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AuthSettings=void 0;class AuthSettings{constructor(authURLs){if(this.type=null,this.loginUrl=null,this.logoutUrl=null,this.safetyUrl=null,this.userId=null,authURLs.length>0){let authSettings={};authSettings=1===authURLs.length?authURLs[0]:authURLs.reduce((settings,authUrl)=>"RAINBOW"===authUrl.type&&"RAINBOW"!==settings.type?(settings.safetyUrl=authUrl.url||authUrl.loginUrl,settings):(authUrl.safetyUrl=settings.url||settings.loginUrl,authUrl)),this.type=authSettings.type,this.loginUrl=authSettings.url||authSettings.loginUrl,this.logoutUrl=authSettings.logoutUrl,this.safetyUrl=authSettings.safetyUrl}}static createFromData(data){return new AuthSettings(data)}setParameter(name,fn){switch(name){case"uid":this.userId=fn();break;case"x-rainbow-app-auth":if("RAINBOW"!==this.type&&this.loginUrl){const url=new URL(this.loginUrl),appAuth=fn(url.searchParams.get("challenge"));url.searchParams.append(name,appAuth),this.loginUrl=url.href}break;case"token":if("RAINBOW"!==this.type&&this.logoutUrl){const url=new URL(this.logoutUrl),tkn=fn();url.searchParams.append(name,tkn),this.logoutUrl=url.href}break;case"safetyUrl":"RAINBOW"===this.type||this.safetyUrl||(this.safetyUrl=fn())}}}exports.AuthSettings=AuthSettings},function(module,exports,__webpack_require__){"use strict";var base64_url_decode=__webpack_require__(302);function InvalidTokenError(message){this.message=message}InvalidTokenError.prototype=new Error,InvalidTokenError.prototype.name="InvalidTokenError",module.exports=function(token,options){if("string"!=typeof token)throw new InvalidTokenError("Invalid token specified");var pos=!0===(options=options||{}).header?0:1;try{return JSON.parse(base64_url_decode(token.split(".")[pos]))}catch(e){throw new InvalidTokenError("Invalid token specified: "+e.message)}},module.exports.InvalidTokenError=InvalidTokenError},function(module,exports,__webpack_require__){var atob=__webpack_require__(303);module.exports=function(str){var output=str.replace(/-/g,"+").replace(/_/g,"/");switch(output.length%4){case 0:break;case 2:output+="==";break;case 3:output+="=";break;default:throw"Illegal base64url string!"}try{return function(str){return decodeURIComponent(atob(str).replace(/(.)/g,(function(m,p){var code=p.charCodeAt(0).toString(16).toUpperCase();return code.length<2&&(code="0"+code),"%"+code})))}(output)}catch(err){return atob(output)}}},function(module,exports){function InvalidCharacterError(message){this.message=message}InvalidCharacterError.prototype=new Error,InvalidCharacterError.prototype.name="InvalidCharacterError",module.exports="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(input){var str=String(input).replace(/=+$/,"");if(str.length%4==1)throw new InvalidCharacterError("'atob' failed: The string to be decoded is not correctly encoded.");for(var bs,buffer,bc=0,idx=0,output="";buffer=str.charAt(idx++);~buffer&&(bs=bc%4?64*bs+buffer:buffer,bc++%4)?output+=String.fromCharCode(255&bs>>(-2*bc&6)):0)buffer="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(buffer);return output}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=(url,options,timeout=1e4)=>Promise.race([fetch(url,options),new Promise((_,reject)=>setTimeout(()=>reject(new Error("timeout")),timeout))])},function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_RESULT__;
/*!
 * jQuery JavaScript Library v3.6.0
 * https://jquery.com/
 *
 * Includes Sizzle.js
 * https://sizzlejs.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2021-03-02T17:08Z
 */!function(global,factory){"use strict";"object"==typeof module.exports?module.exports=global.document?factory(global,!0):function(w){if(!w.document)throw new Error("jQuery requires a window with a document");return factory(w)}:factory(global)}("undefined"!=typeof window?window:this,(function(window,noGlobal){"use strict";var arr=[],getProto=Object.getPrototypeOf,slice=arr.slice,flat=arr.flat?function(array){return arr.flat.call(array)}:function(array){return arr.concat.apply([],array)},push=arr.push,indexOf=arr.indexOf,class2type={},toString=class2type.toString,hasOwn=class2type.hasOwnProperty,fnToString=hasOwn.toString,ObjectFunctionString=fnToString.call(Object),support={},isFunction=function(obj){return"function"==typeof obj&&"number"!=typeof obj.nodeType&&"function"!=typeof obj.item},isWindow=function(obj){return null!=obj&&obj===obj.window},document=window.document,preservedScriptAttributes={type:!0,src:!0,nonce:!0,noModule:!0};function DOMEval(code,node,doc){var i,val,script=(doc=doc||document).createElement("script");if(script.text=code,node)for(i in preservedScriptAttributes)(val=node[i]||node.getAttribute&&node.getAttribute(i))&&script.setAttribute(i,val);doc.head.appendChild(script).parentNode.removeChild(script)}function toType(obj){return null==obj?obj+"":"object"==typeof obj||"function"==typeof obj?class2type[toString.call(obj)]||"object":typeof obj}var jQuery=function(selector,context){return new jQuery.fn.init(selector,context)};function isArrayLike(obj){var length=!!obj&&"length"in obj&&obj.length,type=toType(obj);return!isFunction(obj)&&!isWindow(obj)&&("array"===type||0===length||"number"==typeof length&&length>0&&length-1 in obj)}jQuery.fn=jQuery.prototype={jquery:"3.6.0",constructor:jQuery,length:0,toArray:function(){return slice.call(this)},get:function(num){return null==num?slice.call(this):num<0?this[num+this.length]:this[num]},pushStack:function(elems){var ret=jQuery.merge(this.constructor(),elems);return ret.prevObject=this,ret},each:function(callback){return jQuery.each(this,callback)},map:function(callback){return this.pushStack(jQuery.map(this,(function(elem,i){return callback.call(elem,i,elem)})))},slice:function(){return this.pushStack(slice.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(jQuery.grep(this,(function(_elem,i){return(i+1)%2})))},odd:function(){return this.pushStack(jQuery.grep(this,(function(_elem,i){return i%2})))},eq:function(i){var len=this.length,j=+i+(i<0?len:0);return this.pushStack(j>=0&&j<len?[this[j]]:[])},end:function(){return this.prevObject||this.constructor()},push:push,sort:arr.sort,splice:arr.splice},jQuery.extend=jQuery.fn.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=!1;for("boolean"==typeof target&&(deep=target,target=arguments[i]||{},i++),"object"==typeof target||isFunction(target)||(target={}),i===length&&(target=this,i--);i<length;i++)if(null!=(options=arguments[i]))for(name in options)copy=options[name],"__proto__"!==name&&target!==copy&&(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=Array.isArray(copy)))?(src=target[name],clone=copyIsArray&&!Array.isArray(src)?[]:copyIsArray||jQuery.isPlainObject(src)?src:{},copyIsArray=!1,target[name]=jQuery.extend(deep,clone,copy)):void 0!==copy&&(target[name]=copy));return target},jQuery.extend({expando:"jQuery"+("3.6.0"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(msg){throw new Error(msg)},noop:function(){},isPlainObject:function(obj){var proto,Ctor;return!(!obj||"[object Object]"!==toString.call(obj))&&(!(proto=getProto(obj))||"function"==typeof(Ctor=hasOwn.call(proto,"constructor")&&proto.constructor)&&fnToString.call(Ctor)===ObjectFunctionString)},isEmptyObject:function(obj){var name;for(name in obj)return!1;return!0},globalEval:function(code,options,doc){DOMEval(code,{nonce:options&&options.nonce},doc)},each:function(obj,callback){var length,i=0;if(isArrayLike(obj))for(length=obj.length;i<length&&!1!==callback.call(obj[i],i,obj[i]);i++);else for(i in obj)if(!1===callback.call(obj[i],i,obj[i]))break;return obj},makeArray:function(arr,results){var ret=results||[];return null!=arr&&(isArrayLike(Object(arr))?jQuery.merge(ret,"string"==typeof arr?[arr]:arr):push.call(ret,arr)),ret},inArray:function(elem,arr,i){return null==arr?-1:indexOf.call(arr,elem,i)},merge:function(first,second){for(var len=+second.length,j=0,i=first.length;j<len;j++)first[i++]=second[j];return first.length=i,first},grep:function(elems,callback,invert){for(var matches=[],i=0,length=elems.length,callbackExpect=!invert;i<length;i++)!callback(elems[i],i)!==callbackExpect&&matches.push(elems[i]);return matches},map:function(elems,callback,arg){var length,value,i=0,ret=[];if(isArrayLike(elems))for(length=elems.length;i<length;i++)null!=(value=callback(elems[i],i,arg))&&ret.push(value);else for(i in elems)null!=(value=callback(elems[i],i,arg))&&ret.push(value);return flat(ret)},guid:1,support:support}),"function"==typeof Symbol&&(jQuery.fn[Symbol.iterator]=arr[Symbol.iterator]),jQuery.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),(function(_i,name){class2type["[object "+name+"]"]=name.toLowerCase()}));var Sizzle=
/*!
 * Sizzle CSS Selector Engine v2.3.6
 * https://sizzlejs.com/
 *
 * Copyright JS Foundation and other contributors
 * Released under the MIT license
 * https://js.foundation/
 *
 * Date: 2021-02-16
 */
function(window){var i,support,Expr,getText,isXML,tokenize,compile,select,outermostContext,sortInput,hasDuplicate,setDocument,document,docElem,documentIsHTML,rbuggyQSA,rbuggyMatches,matches,contains,expando="sizzle"+1*new Date,preferredDoc=window.document,dirruns=0,done=0,classCache=createCache(),tokenCache=createCache(),compilerCache=createCache(),nonnativeSelectorCache=createCache(),sortOrder=function(a,b){return a===b&&(hasDuplicate=!0),0},hasOwn={}.hasOwnProperty,arr=[],pop=arr.pop,pushNative=arr.push,push=arr.push,slice=arr.slice,indexOf=function(list,elem){for(var i=0,len=list.length;i<len;i++)if(list[i]===elem)return i;return-1},booleans="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",whitespace="[\\x20\\t\\r\\n\\f]",identifier="(?:\\\\[\\da-fA-F]{1,6}"+whitespace+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",attributes="\\["+whitespace+"*("+identifier+")(?:"+whitespace+"*([*^$|!~]?=)"+whitespace+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+identifier+"))|)"+whitespace+"*\\]",pseudos=":("+identifier+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+attributes+")*)|.*)\\)|)",rwhitespace=new RegExp(whitespace+"+","g"),rtrim=new RegExp("^"+whitespace+"+|((?:^|[^\\\\])(?:\\\\.)*)"+whitespace+"+$","g"),rcomma=new RegExp("^"+whitespace+"*,"+whitespace+"*"),rcombinators=new RegExp("^"+whitespace+"*([>+~]|"+whitespace+")"+whitespace+"*"),rdescend=new RegExp(whitespace+"|>"),rpseudo=new RegExp(pseudos),ridentifier=new RegExp("^"+identifier+"$"),matchExpr={ID:new RegExp("^#("+identifier+")"),CLASS:new RegExp("^\\.("+identifier+")"),TAG:new RegExp("^("+identifier+"|[*])"),ATTR:new RegExp("^"+attributes),PSEUDO:new RegExp("^"+pseudos),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+whitespace+"*(even|odd|(([+-]|)(\\d*)n|)"+whitespace+"*(?:([+-]|)"+whitespace+"*(\\d+)|))"+whitespace+"*\\)|)","i"),bool:new RegExp("^(?:"+booleans+")$","i"),needsContext:new RegExp("^"+whitespace+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+whitespace+"*((?:-\\d)?\\d*)"+whitespace+"*\\)|)(?=[^-]|$)","i")},rhtml=/HTML$/i,rinputs=/^(?:input|select|textarea|button)$/i,rheader=/^h\d$/i,rnative=/^[^{]+\{\s*\[native \w/,rquickExpr=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,rsibling=/[+~]/,runescape=new RegExp("\\\\[\\da-fA-F]{1,6}"+whitespace+"?|\\\\([^\\r\\n\\f])","g"),funescape=function(escape,nonHex){var high="0x"+escape.slice(1)-65536;return nonHex||(high<0?String.fromCharCode(high+65536):String.fromCharCode(high>>10|55296,1023&high|56320))},rcssescape=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,fcssescape=function(ch,asCodePoint){return asCodePoint?"\0"===ch?"":ch.slice(0,-1)+"\\"+ch.charCodeAt(ch.length-1).toString(16)+" ":"\\"+ch},unloadHandler=function(){setDocument()},inDisabledFieldset=addCombinator((function(elem){return!0===elem.disabled&&"fieldset"===elem.nodeName.toLowerCase()}),{dir:"parentNode",next:"legend"});try{push.apply(arr=slice.call(preferredDoc.childNodes),preferredDoc.childNodes),arr[preferredDoc.childNodes.length].nodeType}catch(e){push={apply:arr.length?function(target,els){pushNative.apply(target,slice.call(els))}:function(target,els){for(var j=target.length,i=0;target[j++]=els[i++];);target.length=j-1}}}function Sizzle(selector,context,results,seed){var m,i,elem,nid,match,groups,newSelector,newContext=context&&context.ownerDocument,nodeType=context?context.nodeType:9;if(results=results||[],"string"!=typeof selector||!selector||1!==nodeType&&9!==nodeType&&11!==nodeType)return results;if(!seed&&(setDocument(context),context=context||document,documentIsHTML)){if(11!==nodeType&&(match=rquickExpr.exec(selector)))if(m=match[1]){if(9===nodeType){if(!(elem=context.getElementById(m)))return results;if(elem.id===m)return results.push(elem),results}else if(newContext&&(elem=newContext.getElementById(m))&&contains(context,elem)&&elem.id===m)return results.push(elem),results}else{if(match[2])return push.apply(results,context.getElementsByTagName(selector)),results;if((m=match[3])&&support.getElementsByClassName&&context.getElementsByClassName)return push.apply(results,context.getElementsByClassName(m)),results}if(support.qsa&&!nonnativeSelectorCache[selector+" "]&&(!rbuggyQSA||!rbuggyQSA.test(selector))&&(1!==nodeType||"object"!==context.nodeName.toLowerCase())){if(newSelector=selector,newContext=context,1===nodeType&&(rdescend.test(selector)||rcombinators.test(selector))){for((newContext=rsibling.test(selector)&&testContext(context.parentNode)||context)===context&&support.scope||((nid=context.getAttribute("id"))?nid=nid.replace(rcssescape,fcssescape):context.setAttribute("id",nid=expando)),i=(groups=tokenize(selector)).length;i--;)groups[i]=(nid?"#"+nid:":scope")+" "+toSelector(groups[i]);newSelector=groups.join(",")}try{return push.apply(results,newContext.querySelectorAll(newSelector)),results}catch(qsaError){nonnativeSelectorCache(selector,!0)}finally{nid===expando&&context.removeAttribute("id")}}}return select(selector.replace(rtrim,"$1"),context,results,seed)}function createCache(){var keys=[];return function cache(key,value){return keys.push(key+" ")>Expr.cacheLength&&delete cache[keys.shift()],cache[key+" "]=value}}function markFunction(fn){return fn[expando]=!0,fn}function assert(fn){var el=document.createElement("fieldset");try{return!!fn(el)}catch(e){return!1}finally{el.parentNode&&el.parentNode.removeChild(el),el=null}}function addHandle(attrs,handler){for(var arr=attrs.split("|"),i=arr.length;i--;)Expr.attrHandle[arr[i]]=handler}function siblingCheck(a,b){var cur=b&&a,diff=cur&&1===a.nodeType&&1===b.nodeType&&a.sourceIndex-b.sourceIndex;if(diff)return diff;if(cur)for(;cur=cur.nextSibling;)if(cur===b)return-1;return a?1:-1}function createInputPseudo(type){return function(elem){return"input"===elem.nodeName.toLowerCase()&&elem.type===type}}function createButtonPseudo(type){return function(elem){var name=elem.nodeName.toLowerCase();return("input"===name||"button"===name)&&elem.type===type}}function createDisabledPseudo(disabled){return function(elem){return"form"in elem?elem.parentNode&&!1===elem.disabled?"label"in elem?"label"in elem.parentNode?elem.parentNode.disabled===disabled:elem.disabled===disabled:elem.isDisabled===disabled||elem.isDisabled!==!disabled&&inDisabledFieldset(elem)===disabled:elem.disabled===disabled:"label"in elem&&elem.disabled===disabled}}function createPositionalPseudo(fn){return markFunction((function(argument){return argument=+argument,markFunction((function(seed,matches){for(var j,matchIndexes=fn([],seed.length,argument),i=matchIndexes.length;i--;)seed[j=matchIndexes[i]]&&(seed[j]=!(matches[j]=seed[j]))}))}))}function testContext(context){return context&&void 0!==context.getElementsByTagName&&context}for(i in support=Sizzle.support={},isXML=Sizzle.isXML=function(elem){var namespace=elem&&elem.namespaceURI,docElem=elem&&(elem.ownerDocument||elem).documentElement;return!rhtml.test(namespace||docElem&&docElem.nodeName||"HTML")},setDocument=Sizzle.setDocument=function(node){var hasCompare,subWindow,doc=node?node.ownerDocument||node:preferredDoc;return doc!=document&&9===doc.nodeType&&doc.documentElement?(docElem=(document=doc).documentElement,documentIsHTML=!isXML(document),preferredDoc!=document&&(subWindow=document.defaultView)&&subWindow.top!==subWindow&&(subWindow.addEventListener?subWindow.addEventListener("unload",unloadHandler,!1):subWindow.attachEvent&&subWindow.attachEvent("onunload",unloadHandler)),support.scope=assert((function(el){return docElem.appendChild(el).appendChild(document.createElement("div")),void 0!==el.querySelectorAll&&!el.querySelectorAll(":scope fieldset div").length})),support.attributes=assert((function(el){return el.className="i",!el.getAttribute("className")})),support.getElementsByTagName=assert((function(el){return el.appendChild(document.createComment("")),!el.getElementsByTagName("*").length})),support.getElementsByClassName=rnative.test(document.getElementsByClassName),support.getById=assert((function(el){return docElem.appendChild(el).id=expando,!document.getElementsByName||!document.getElementsByName(expando).length})),support.getById?(Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){return elem.getAttribute("id")===attrId}},Expr.find.ID=function(id,context){if(void 0!==context.getElementById&&documentIsHTML){var elem=context.getElementById(id);return elem?[elem]:[]}}):(Expr.filter.ID=function(id){var attrId=id.replace(runescape,funescape);return function(elem){var node=void 0!==elem.getAttributeNode&&elem.getAttributeNode("id");return node&&node.value===attrId}},Expr.find.ID=function(id,context){if(void 0!==context.getElementById&&documentIsHTML){var node,i,elems,elem=context.getElementById(id);if(elem){if((node=elem.getAttributeNode("id"))&&node.value===id)return[elem];for(elems=context.getElementsByName(id),i=0;elem=elems[i++];)if((node=elem.getAttributeNode("id"))&&node.value===id)return[elem]}return[]}}),Expr.find.TAG=support.getElementsByTagName?function(tag,context){return void 0!==context.getElementsByTagName?context.getElementsByTagName(tag):support.qsa?context.querySelectorAll(tag):void 0}:function(tag,context){var elem,tmp=[],i=0,results=context.getElementsByTagName(tag);if("*"===tag){for(;elem=results[i++];)1===elem.nodeType&&tmp.push(elem);return tmp}return results},Expr.find.CLASS=support.getElementsByClassName&&function(className,context){if(void 0!==context.getElementsByClassName&&documentIsHTML)return context.getElementsByClassName(className)},rbuggyMatches=[],rbuggyQSA=[],(support.qsa=rnative.test(document.querySelectorAll))&&(assert((function(el){var input;docElem.appendChild(el).innerHTML="<a id='"+expando+"'></a><select id='"+expando+"-\r\\' msallowcapture=''><option selected=''></option></select>",el.querySelectorAll("[msallowcapture^='']").length&&rbuggyQSA.push("[*^$]="+whitespace+"*(?:''|\"\")"),el.querySelectorAll("[selected]").length||rbuggyQSA.push("\\["+whitespace+"*(?:value|"+booleans+")"),el.querySelectorAll("[id~="+expando+"-]").length||rbuggyQSA.push("~="),(input=document.createElement("input")).setAttribute("name",""),el.appendChild(input),el.querySelectorAll("[name='']").length||rbuggyQSA.push("\\["+whitespace+"*name"+whitespace+"*="+whitespace+"*(?:''|\"\")"),el.querySelectorAll(":checked").length||rbuggyQSA.push(":checked"),el.querySelectorAll("a#"+expando+"+*").length||rbuggyQSA.push(".#.+[+~]"),el.querySelectorAll("\\\f"),rbuggyQSA.push("[\\r\\n\\f]")})),assert((function(el){el.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var input=document.createElement("input");input.setAttribute("type","hidden"),el.appendChild(input).setAttribute("name","D"),el.querySelectorAll("[name=d]").length&&rbuggyQSA.push("name"+whitespace+"*[*^$|!~]?="),2!==el.querySelectorAll(":enabled").length&&rbuggyQSA.push(":enabled",":disabled"),docElem.appendChild(el).disabled=!0,2!==el.querySelectorAll(":disabled").length&&rbuggyQSA.push(":enabled",":disabled"),el.querySelectorAll("*,:x"),rbuggyQSA.push(",.*:")}))),(support.matchesSelector=rnative.test(matches=docElem.matches||docElem.webkitMatchesSelector||docElem.mozMatchesSelector||docElem.oMatchesSelector||docElem.msMatchesSelector))&&assert((function(el){support.disconnectedMatch=matches.call(el,"*"),matches.call(el,"[s!='']:x"),rbuggyMatches.push("!=",pseudos)})),rbuggyQSA=rbuggyQSA.length&&new RegExp(rbuggyQSA.join("|")),rbuggyMatches=rbuggyMatches.length&&new RegExp(rbuggyMatches.join("|")),hasCompare=rnative.test(docElem.compareDocumentPosition),contains=hasCompare||rnative.test(docElem.contains)?function(a,b){var adown=9===a.nodeType?a.documentElement:a,bup=b&&b.parentNode;return a===bup||!(!bup||1!==bup.nodeType||!(adown.contains?adown.contains(bup):a.compareDocumentPosition&&16&a.compareDocumentPosition(bup)))}:function(a,b){if(b)for(;b=b.parentNode;)if(b===a)return!0;return!1},sortOrder=hasCompare?function(a,b){if(a===b)return hasDuplicate=!0,0;var compare=!a.compareDocumentPosition-!b.compareDocumentPosition;return compare||(1&(compare=(a.ownerDocument||a)==(b.ownerDocument||b)?a.compareDocumentPosition(b):1)||!support.sortDetached&&b.compareDocumentPosition(a)===compare?a==document||a.ownerDocument==preferredDoc&&contains(preferredDoc,a)?-1:b==document||b.ownerDocument==preferredDoc&&contains(preferredDoc,b)?1:sortInput?indexOf(sortInput,a)-indexOf(sortInput,b):0:4&compare?-1:1)}:function(a,b){if(a===b)return hasDuplicate=!0,0;var cur,i=0,aup=a.parentNode,bup=b.parentNode,ap=[a],bp=[b];if(!aup||!bup)return a==document?-1:b==document?1:aup?-1:bup?1:sortInput?indexOf(sortInput,a)-indexOf(sortInput,b):0;if(aup===bup)return siblingCheck(a,b);for(cur=a;cur=cur.parentNode;)ap.unshift(cur);for(cur=b;cur=cur.parentNode;)bp.unshift(cur);for(;ap[i]===bp[i];)i++;return i?siblingCheck(ap[i],bp[i]):ap[i]==preferredDoc?-1:bp[i]==preferredDoc?1:0},document):document},Sizzle.matches=function(expr,elements){return Sizzle(expr,null,null,elements)},Sizzle.matchesSelector=function(elem,expr){if(setDocument(elem),support.matchesSelector&&documentIsHTML&&!nonnativeSelectorCache[expr+" "]&&(!rbuggyMatches||!rbuggyMatches.test(expr))&&(!rbuggyQSA||!rbuggyQSA.test(expr)))try{var ret=matches.call(elem,expr);if(ret||support.disconnectedMatch||elem.document&&11!==elem.document.nodeType)return ret}catch(e){nonnativeSelectorCache(expr,!0)}return Sizzle(expr,document,null,[elem]).length>0},Sizzle.contains=function(context,elem){return(context.ownerDocument||context)!=document&&setDocument(context),contains(context,elem)},Sizzle.attr=function(elem,name){(elem.ownerDocument||elem)!=document&&setDocument(elem);var fn=Expr.attrHandle[name.toLowerCase()],val=fn&&hasOwn.call(Expr.attrHandle,name.toLowerCase())?fn(elem,name,!documentIsHTML):void 0;return void 0!==val?val:support.attributes||!documentIsHTML?elem.getAttribute(name):(val=elem.getAttributeNode(name))&&val.specified?val.value:null},Sizzle.escape=function(sel){return(sel+"").replace(rcssescape,fcssescape)},Sizzle.error=function(msg){throw new Error("Syntax error, unrecognized expression: "+msg)},Sizzle.uniqueSort=function(results){var elem,duplicates=[],j=0,i=0;if(hasDuplicate=!support.detectDuplicates,sortInput=!support.sortStable&&results.slice(0),results.sort(sortOrder),hasDuplicate){for(;elem=results[i++];)elem===results[i]&&(j=duplicates.push(i));for(;j--;)results.splice(duplicates[j],1)}return sortInput=null,results},getText=Sizzle.getText=function(elem){var node,ret="",i=0,nodeType=elem.nodeType;if(nodeType){if(1===nodeType||9===nodeType||11===nodeType){if("string"==typeof elem.textContent)return elem.textContent;for(elem=elem.firstChild;elem;elem=elem.nextSibling)ret+=getText(elem)}else if(3===nodeType||4===nodeType)return elem.nodeValue}else for(;node=elem[i++];)ret+=getText(node);return ret},(Expr=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:matchExpr,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(match){return match[1]=match[1].replace(runescape,funescape),match[3]=(match[3]||match[4]||match[5]||"").replace(runescape,funescape),"~="===match[2]&&(match[3]=" "+match[3]+" "),match.slice(0,4)},CHILD:function(match){return match[1]=match[1].toLowerCase(),"nth"===match[1].slice(0,3)?(match[3]||Sizzle.error(match[0]),match[4]=+(match[4]?match[5]+(match[6]||1):2*("even"===match[3]||"odd"===match[3])),match[5]=+(match[7]+match[8]||"odd"===match[3])):match[3]&&Sizzle.error(match[0]),match},PSEUDO:function(match){var excess,unquoted=!match[6]&&match[2];return matchExpr.CHILD.test(match[0])?null:(match[3]?match[2]=match[4]||match[5]||"":unquoted&&rpseudo.test(unquoted)&&(excess=tokenize(unquoted,!0))&&(excess=unquoted.indexOf(")",unquoted.length-excess)-unquoted.length)&&(match[0]=match[0].slice(0,excess),match[2]=unquoted.slice(0,excess)),match.slice(0,3))}},filter:{TAG:function(nodeNameSelector){var nodeName=nodeNameSelector.replace(runescape,funescape).toLowerCase();return"*"===nodeNameSelector?function(){return!0}:function(elem){return elem.nodeName&&elem.nodeName.toLowerCase()===nodeName}},CLASS:function(className){var pattern=classCache[className+" "];return pattern||(pattern=new RegExp("(^|"+whitespace+")"+className+"("+whitespace+"|$)"))&&classCache(className,(function(elem){return pattern.test("string"==typeof elem.className&&elem.className||void 0!==elem.getAttribute&&elem.getAttribute("class")||"")}))},ATTR:function(name,operator,check){return function(elem){var result=Sizzle.attr(elem,name);return null==result?"!="===operator:!operator||(result+="","="===operator?result===check:"!="===operator?result!==check:"^="===operator?check&&0===result.indexOf(check):"*="===operator?check&&result.indexOf(check)>-1:"$="===operator?check&&result.slice(-check.length)===check:"~="===operator?(" "+result.replace(rwhitespace," ")+" ").indexOf(check)>-1:"|="===operator&&(result===check||result.slice(0,check.length+1)===check+"-"))}},CHILD:function(type,what,_argument,first,last){var simple="nth"!==type.slice(0,3),forward="last"!==type.slice(-4),ofType="of-type"===what;return 1===first&&0===last?function(elem){return!!elem.parentNode}:function(elem,_context,xml){var cache,uniqueCache,outerCache,node,nodeIndex,start,dir=simple!==forward?"nextSibling":"previousSibling",parent=elem.parentNode,name=ofType&&elem.nodeName.toLowerCase(),useCache=!xml&&!ofType,diff=!1;if(parent){if(simple){for(;dir;){for(node=elem;node=node[dir];)if(ofType?node.nodeName.toLowerCase()===name:1===node.nodeType)return!1;start=dir="only"===type&&!start&&"nextSibling"}return!0}if(start=[forward?parent.firstChild:parent.lastChild],forward&&useCache){for(diff=(nodeIndex=(cache=(uniqueCache=(outerCache=(node=parent)[expando]||(node[expando]={}))[node.uniqueID]||(outerCache[node.uniqueID]={}))[type]||[])[0]===dirruns&&cache[1])&&cache[2],node=nodeIndex&&parent.childNodes[nodeIndex];node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop();)if(1===node.nodeType&&++diff&&node===elem){uniqueCache[type]=[dirruns,nodeIndex,diff];break}}else if(useCache&&(diff=nodeIndex=(cache=(uniqueCache=(outerCache=(node=elem)[expando]||(node[expando]={}))[node.uniqueID]||(outerCache[node.uniqueID]={}))[type]||[])[0]===dirruns&&cache[1]),!1===diff)for(;(node=++nodeIndex&&node&&node[dir]||(diff=nodeIndex=0)||start.pop())&&((ofType?node.nodeName.toLowerCase()!==name:1!==node.nodeType)||!++diff||(useCache&&((uniqueCache=(outerCache=node[expando]||(node[expando]={}))[node.uniqueID]||(outerCache[node.uniqueID]={}))[type]=[dirruns,diff]),node!==elem)););return(diff-=last)===first||diff%first==0&&diff/first>=0}}},PSEUDO:function(pseudo,argument){var args,fn=Expr.pseudos[pseudo]||Expr.setFilters[pseudo.toLowerCase()]||Sizzle.error("unsupported pseudo: "+pseudo);return fn[expando]?fn(argument):fn.length>1?(args=[pseudo,pseudo,"",argument],Expr.setFilters.hasOwnProperty(pseudo.toLowerCase())?markFunction((function(seed,matches){for(var idx,matched=fn(seed,argument),i=matched.length;i--;)seed[idx=indexOf(seed,matched[i])]=!(matches[idx]=matched[i])})):function(elem){return fn(elem,0,args)}):fn}},pseudos:{not:markFunction((function(selector){var input=[],results=[],matcher=compile(selector.replace(rtrim,"$1"));return matcher[expando]?markFunction((function(seed,matches,_context,xml){for(var elem,unmatched=matcher(seed,null,xml,[]),i=seed.length;i--;)(elem=unmatched[i])&&(seed[i]=!(matches[i]=elem))})):function(elem,_context,xml){return input[0]=elem,matcher(input,null,xml,results),input[0]=null,!results.pop()}})),has:markFunction((function(selector){return function(elem){return Sizzle(selector,elem).length>0}})),contains:markFunction((function(text){return text=text.replace(runescape,funescape),function(elem){return(elem.textContent||getText(elem)).indexOf(text)>-1}})),lang:markFunction((function(lang){return ridentifier.test(lang||"")||Sizzle.error("unsupported lang: "+lang),lang=lang.replace(runescape,funescape).toLowerCase(),function(elem){var elemLang;do{if(elemLang=documentIsHTML?elem.lang:elem.getAttribute("xml:lang")||elem.getAttribute("lang"))return(elemLang=elemLang.toLowerCase())===lang||0===elemLang.indexOf(lang+"-")}while((elem=elem.parentNode)&&1===elem.nodeType);return!1}})),target:function(elem){var hash=window.location&&window.location.hash;return hash&&hash.slice(1)===elem.id},root:function(elem){return elem===docElem},focus:function(elem){return elem===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(elem.type||elem.href||~elem.tabIndex)},enabled:createDisabledPseudo(!1),disabled:createDisabledPseudo(!0),checked:function(elem){var nodeName=elem.nodeName.toLowerCase();return"input"===nodeName&&!!elem.checked||"option"===nodeName&&!!elem.selected},selected:function(elem){return elem.parentNode&&elem.parentNode.selectedIndex,!0===elem.selected},empty:function(elem){for(elem=elem.firstChild;elem;elem=elem.nextSibling)if(elem.nodeType<6)return!1;return!0},parent:function(elem){return!Expr.pseudos.empty(elem)},header:function(elem){return rheader.test(elem.nodeName)},input:function(elem){return rinputs.test(elem.nodeName)},button:function(elem){var name=elem.nodeName.toLowerCase();return"input"===name&&"button"===elem.type||"button"===name},text:function(elem){var attr;return"input"===elem.nodeName.toLowerCase()&&"text"===elem.type&&(null==(attr=elem.getAttribute("type"))||"text"===attr.toLowerCase())},first:createPositionalPseudo((function(){return[0]})),last:createPositionalPseudo((function(_matchIndexes,length){return[length-1]})),eq:createPositionalPseudo((function(_matchIndexes,length,argument){return[argument<0?argument+length:argument]})),even:createPositionalPseudo((function(matchIndexes,length){for(var i=0;i<length;i+=2)matchIndexes.push(i);return matchIndexes})),odd:createPositionalPseudo((function(matchIndexes,length){for(var i=1;i<length;i+=2)matchIndexes.push(i);return matchIndexes})),lt:createPositionalPseudo((function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument>length?length:argument;--i>=0;)matchIndexes.push(i);return matchIndexes})),gt:createPositionalPseudo((function(matchIndexes,length,argument){for(var i=argument<0?argument+length:argument;++i<length;)matchIndexes.push(i);return matchIndexes}))}}).pseudos.nth=Expr.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})Expr.pseudos[i]=createInputPseudo(i);for(i in{submit:!0,reset:!0})Expr.pseudos[i]=createButtonPseudo(i);function setFilters(){}function toSelector(tokens){for(var i=0,len=tokens.length,selector="";i<len;i++)selector+=tokens[i].value;return selector}function addCombinator(matcher,combinator,base){var dir=combinator.dir,skip=combinator.next,key=skip||dir,checkNonElements=base&&"parentNode"===key,doneName=done++;return combinator.first?function(elem,context,xml){for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)return matcher(elem,context,xml);return!1}:function(elem,context,xml){var oldCache,uniqueCache,outerCache,newCache=[dirruns,doneName];if(xml){for(;elem=elem[dir];)if((1===elem.nodeType||checkNonElements)&&matcher(elem,context,xml))return!0}else for(;elem=elem[dir];)if(1===elem.nodeType||checkNonElements)if(uniqueCache=(outerCache=elem[expando]||(elem[expando]={}))[elem.uniqueID]||(outerCache[elem.uniqueID]={}),skip&&skip===elem.nodeName.toLowerCase())elem=elem[dir]||elem;else{if((oldCache=uniqueCache[key])&&oldCache[0]===dirruns&&oldCache[1]===doneName)return newCache[2]=oldCache[2];if(uniqueCache[key]=newCache,newCache[2]=matcher(elem,context,xml))return!0}return!1}}function elementMatcher(matchers){return matchers.length>1?function(elem,context,xml){for(var i=matchers.length;i--;)if(!matchers[i](elem,context,xml))return!1;return!0}:matchers[0]}function condense(unmatched,map,filter,context,xml){for(var elem,newUnmatched=[],i=0,len=unmatched.length,mapped=null!=map;i<len;i++)(elem=unmatched[i])&&(filter&&!filter(elem,context,xml)||(newUnmatched.push(elem),mapped&&map.push(i)));return newUnmatched}function setMatcher(preFilter,selector,matcher,postFilter,postFinder,postSelector){return postFilter&&!postFilter[expando]&&(postFilter=setMatcher(postFilter)),postFinder&&!postFinder[expando]&&(postFinder=setMatcher(postFinder,postSelector)),markFunction((function(seed,results,context,xml){var temp,i,elem,preMap=[],postMap=[],preexisting=results.length,elems=seed||function(selector,contexts,results){for(var i=0,len=contexts.length;i<len;i++)Sizzle(selector,contexts[i],results);return results}(selector||"*",context.nodeType?[context]:context,[]),matcherIn=!preFilter||!seed&&selector?elems:condense(elems,preMap,preFilter,context,xml),matcherOut=matcher?postFinder||(seed?preFilter:preexisting||postFilter)?[]:results:matcherIn;if(matcher&&matcher(matcherIn,matcherOut,context,xml),postFilter)for(temp=condense(matcherOut,postMap),postFilter(temp,[],context,xml),i=temp.length;i--;)(elem=temp[i])&&(matcherOut[postMap[i]]=!(matcherIn[postMap[i]]=elem));if(seed){if(postFinder||preFilter){if(postFinder){for(temp=[],i=matcherOut.length;i--;)(elem=matcherOut[i])&&temp.push(matcherIn[i]=elem);postFinder(null,matcherOut=[],temp,xml)}for(i=matcherOut.length;i--;)(elem=matcherOut[i])&&(temp=postFinder?indexOf(seed,elem):preMap[i])>-1&&(seed[temp]=!(results[temp]=elem))}}else matcherOut=condense(matcherOut===results?matcherOut.splice(preexisting,matcherOut.length):matcherOut),postFinder?postFinder(null,results,matcherOut,xml):push.apply(results,matcherOut)}))}function matcherFromTokens(tokens){for(var checkContext,matcher,j,len=tokens.length,leadingRelative=Expr.relative[tokens[0].type],implicitRelative=leadingRelative||Expr.relative[" "],i=leadingRelative?1:0,matchContext=addCombinator((function(elem){return elem===checkContext}),implicitRelative,!0),matchAnyContext=addCombinator((function(elem){return indexOf(checkContext,elem)>-1}),implicitRelative,!0),matchers=[function(elem,context,xml){var ret=!leadingRelative&&(xml||context!==outermostContext)||((checkContext=context).nodeType?matchContext(elem,context,xml):matchAnyContext(elem,context,xml));return checkContext=null,ret}];i<len;i++)if(matcher=Expr.relative[tokens[i].type])matchers=[addCombinator(elementMatcher(matchers),matcher)];else{if((matcher=Expr.filter[tokens[i].type].apply(null,tokens[i].matches))[expando]){for(j=++i;j<len&&!Expr.relative[tokens[j].type];j++);return setMatcher(i>1&&elementMatcher(matchers),i>1&&toSelector(tokens.slice(0,i-1).concat({value:" "===tokens[i-2].type?"*":""})).replace(rtrim,"$1"),matcher,i<j&&matcherFromTokens(tokens.slice(i,j)),j<len&&matcherFromTokens(tokens=tokens.slice(j)),j<len&&toSelector(tokens))}matchers.push(matcher)}return elementMatcher(matchers)}return setFilters.prototype=Expr.filters=Expr.pseudos,Expr.setFilters=new setFilters,tokenize=Sizzle.tokenize=function(selector,parseOnly){var matched,match,tokens,type,soFar,groups,preFilters,cached=tokenCache[selector+" "];if(cached)return parseOnly?0:cached.slice(0);for(soFar=selector,groups=[],preFilters=Expr.preFilter;soFar;){for(type in matched&&!(match=rcomma.exec(soFar))||(match&&(soFar=soFar.slice(match[0].length)||soFar),groups.push(tokens=[])),matched=!1,(match=rcombinators.exec(soFar))&&(matched=match.shift(),tokens.push({value:matched,type:match[0].replace(rtrim," ")}),soFar=soFar.slice(matched.length)),Expr.filter)!(match=matchExpr[type].exec(soFar))||preFilters[type]&&!(match=preFilters[type](match))||(matched=match.shift(),tokens.push({value:matched,type:type,matches:match}),soFar=soFar.slice(matched.length));if(!matched)break}return parseOnly?soFar.length:soFar?Sizzle.error(selector):tokenCache(selector,groups).slice(0)},compile=Sizzle.compile=function(selector,match){var i,setMatchers=[],elementMatchers=[],cached=compilerCache[selector+" "];if(!cached){for(match||(match=tokenize(selector)),i=match.length;i--;)(cached=matcherFromTokens(match[i]))[expando]?setMatchers.push(cached):elementMatchers.push(cached);(cached=compilerCache(selector,function(elementMatchers,setMatchers){var bySet=setMatchers.length>0,byElement=elementMatchers.length>0,superMatcher=function(seed,context,xml,results,outermost){var elem,j,matcher,matchedCount=0,i="0",unmatched=seed&&[],setMatched=[],contextBackup=outermostContext,elems=seed||byElement&&Expr.find.TAG("*",outermost),dirrunsUnique=dirruns+=null==contextBackup?1:Math.random()||.1,len=elems.length;for(outermost&&(outermostContext=context==document||context||outermost);i!==len&&null!=(elem=elems[i]);i++){if(byElement&&elem){for(j=0,context||elem.ownerDocument==document||(setDocument(elem),xml=!documentIsHTML);matcher=elementMatchers[j++];)if(matcher(elem,context||document,xml)){results.push(elem);break}outermost&&(dirruns=dirrunsUnique)}bySet&&((elem=!matcher&&elem)&&matchedCount--,seed&&unmatched.push(elem))}if(matchedCount+=i,bySet&&i!==matchedCount){for(j=0;matcher=setMatchers[j++];)matcher(unmatched,setMatched,context,xml);if(seed){if(matchedCount>0)for(;i--;)unmatched[i]||setMatched[i]||(setMatched[i]=pop.call(results));setMatched=condense(setMatched)}push.apply(results,setMatched),outermost&&!seed&&setMatched.length>0&&matchedCount+setMatchers.length>1&&Sizzle.uniqueSort(results)}return outermost&&(dirruns=dirrunsUnique,outermostContext=contextBackup),unmatched};return bySet?markFunction(superMatcher):superMatcher}(elementMatchers,setMatchers))).selector=selector}return cached},select=Sizzle.select=function(selector,context,results,seed){var i,tokens,token,type,find,compiled="function"==typeof selector&&selector,match=!seed&&tokenize(selector=compiled.selector||selector);if(results=results||[],1===match.length){if((tokens=match[0]=match[0].slice(0)).length>2&&"ID"===(token=tokens[0]).type&&9===context.nodeType&&documentIsHTML&&Expr.relative[tokens[1].type]){if(!(context=(Expr.find.ID(token.matches[0].replace(runescape,funescape),context)||[])[0]))return results;compiled&&(context=context.parentNode),selector=selector.slice(tokens.shift().value.length)}for(i=matchExpr.needsContext.test(selector)?0:tokens.length;i--&&(token=tokens[i],!Expr.relative[type=token.type]);)if((find=Expr.find[type])&&(seed=find(token.matches[0].replace(runescape,funescape),rsibling.test(tokens[0].type)&&testContext(context.parentNode)||context))){if(tokens.splice(i,1),!(selector=seed.length&&toSelector(tokens)))return push.apply(results,seed),results;break}}return(compiled||compile(selector,match))(seed,context,!documentIsHTML,results,!context||rsibling.test(selector)&&testContext(context.parentNode)||context),results},support.sortStable=expando.split("").sort(sortOrder).join("")===expando,support.detectDuplicates=!!hasDuplicate,setDocument(),support.sortDetached=assert((function(el){return 1&el.compareDocumentPosition(document.createElement("fieldset"))})),assert((function(el){return el.innerHTML="<a href='#'></a>","#"===el.firstChild.getAttribute("href")}))||addHandle("type|href|height|width",(function(elem,name,isXML){if(!isXML)return elem.getAttribute(name,"type"===name.toLowerCase()?1:2)})),support.attributes&&assert((function(el){return el.innerHTML="<input/>",el.firstChild.setAttribute("value",""),""===el.firstChild.getAttribute("value")}))||addHandle("value",(function(elem,_name,isXML){if(!isXML&&"input"===elem.nodeName.toLowerCase())return elem.defaultValue})),assert((function(el){return null==el.getAttribute("disabled")}))||addHandle(booleans,(function(elem,name,isXML){var val;if(!isXML)return!0===elem[name]?name.toLowerCase():(val=elem.getAttributeNode(name))&&val.specified?val.value:null})),Sizzle}(window);jQuery.find=Sizzle,jQuery.expr=Sizzle.selectors,jQuery.expr[":"]=jQuery.expr.pseudos,jQuery.uniqueSort=jQuery.unique=Sizzle.uniqueSort,jQuery.text=Sizzle.getText,jQuery.isXMLDoc=Sizzle.isXML,jQuery.contains=Sizzle.contains,jQuery.escapeSelector=Sizzle.escape;var dir=function(elem,dir,until){for(var matched=[],truncate=void 0!==until;(elem=elem[dir])&&9!==elem.nodeType;)if(1===elem.nodeType){if(truncate&&jQuery(elem).is(until))break;matched.push(elem)}return matched},siblings=function(n,elem){for(var matched=[];n;n=n.nextSibling)1===n.nodeType&&n!==elem&&matched.push(n);return matched},rneedsContext=jQuery.expr.match.needsContext;function nodeName(elem,name){return elem.nodeName&&elem.nodeName.toLowerCase()===name.toLowerCase()}var rsingleTag=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function winnow(elements,qualifier,not){return isFunction(qualifier)?jQuery.grep(elements,(function(elem,i){return!!qualifier.call(elem,i,elem)!==not})):qualifier.nodeType?jQuery.grep(elements,(function(elem){return elem===qualifier!==not})):"string"!=typeof qualifier?jQuery.grep(elements,(function(elem){return indexOf.call(qualifier,elem)>-1!==not})):jQuery.filter(qualifier,elements,not)}jQuery.filter=function(expr,elems,not){var elem=elems[0];return not&&(expr=":not("+expr+")"),1===elems.length&&1===elem.nodeType?jQuery.find.matchesSelector(elem,expr)?[elem]:[]:jQuery.find.matches(expr,jQuery.grep(elems,(function(elem){return 1===elem.nodeType})))},jQuery.fn.extend({find:function(selector){var i,ret,len=this.length,self=this;if("string"!=typeof selector)return this.pushStack(jQuery(selector).filter((function(){for(i=0;i<len;i++)if(jQuery.contains(self[i],this))return!0})));for(ret=this.pushStack([]),i=0;i<len;i++)jQuery.find(selector,self[i],ret);return len>1?jQuery.uniqueSort(ret):ret},filter:function(selector){return this.pushStack(winnow(this,selector||[],!1))},not:function(selector){return this.pushStack(winnow(this,selector||[],!0))},is:function(selector){return!!winnow(this,"string"==typeof selector&&rneedsContext.test(selector)?jQuery(selector):selector||[],!1).length}});var rootjQuery,rquickExpr=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(jQuery.fn.init=function(selector,context,root){var match,elem;if(!selector)return this;if(root=root||rootjQuery,"string"==typeof selector){if(!(match="<"===selector[0]&&">"===selector[selector.length-1]&&selector.length>=3?[null,selector,null]:rquickExpr.exec(selector))||!match[1]&&context)return!context||context.jquery?(context||root).find(selector):this.constructor(context).find(selector);if(match[1]){if(context=context instanceof jQuery?context[0]:context,jQuery.merge(this,jQuery.parseHTML(match[1],context&&context.nodeType?context.ownerDocument||context:document,!0)),rsingleTag.test(match[1])&&jQuery.isPlainObject(context))for(match in context)isFunction(this[match])?this[match](context[match]):this.attr(match,context[match]);return this}return(elem=document.getElementById(match[2]))&&(this[0]=elem,this.length=1),this}return selector.nodeType?(this[0]=selector,this.length=1,this):isFunction(selector)?void 0!==root.ready?root.ready(selector):selector(jQuery):jQuery.makeArray(selector,this)}).prototype=jQuery.fn,rootjQuery=jQuery(document);var rparentsprev=/^(?:parents|prev(?:Until|All))/,guaranteedUnique={children:!0,contents:!0,next:!0,prev:!0};function sibling(cur,dir){for(;(cur=cur[dir])&&1!==cur.nodeType;);return cur}jQuery.fn.extend({has:function(target){var targets=jQuery(target,this),l=targets.length;return this.filter((function(){for(var i=0;i<l;i++)if(jQuery.contains(this,targets[i]))return!0}))},closest:function(selectors,context){var cur,i=0,l=this.length,matched=[],targets="string"!=typeof selectors&&jQuery(selectors);if(!rneedsContext.test(selectors))for(;i<l;i++)for(cur=this[i];cur&&cur!==context;cur=cur.parentNode)if(cur.nodeType<11&&(targets?targets.index(cur)>-1:1===cur.nodeType&&jQuery.find.matchesSelector(cur,selectors))){matched.push(cur);break}return this.pushStack(matched.length>1?jQuery.uniqueSort(matched):matched)},index:function(elem){return elem?"string"==typeof elem?indexOf.call(jQuery(elem),this[0]):indexOf.call(this,elem.jquery?elem[0]:elem):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(selector,context){return this.pushStack(jQuery.uniqueSort(jQuery.merge(this.get(),jQuery(selector,context))))},addBack:function(selector){return this.add(null==selector?this.prevObject:this.prevObject.filter(selector))}}),jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&11!==parent.nodeType?parent:null},parents:function(elem){return dir(elem,"parentNode")},parentsUntil:function(elem,_i,until){return dir(elem,"parentNode",until)},next:function(elem){return sibling(elem,"nextSibling")},prev:function(elem){return sibling(elem,"previousSibling")},nextAll:function(elem){return dir(elem,"nextSibling")},prevAll:function(elem){return dir(elem,"previousSibling")},nextUntil:function(elem,_i,until){return dir(elem,"nextSibling",until)},prevUntil:function(elem,_i,until){return dir(elem,"previousSibling",until)},siblings:function(elem){return siblings((elem.parentNode||{}).firstChild,elem)},children:function(elem){return siblings(elem.firstChild)},contents:function(elem){return null!=elem.contentDocument&&getProto(elem.contentDocument)?elem.contentDocument:(nodeName(elem,"template")&&(elem=elem.content||elem),jQuery.merge([],elem.childNodes))}},(function(name,fn){jQuery.fn[name]=function(until,selector){var matched=jQuery.map(this,fn,until);return"Until"!==name.slice(-5)&&(selector=until),selector&&"string"==typeof selector&&(matched=jQuery.filter(selector,matched)),this.length>1&&(guaranteedUnique[name]||jQuery.uniqueSort(matched),rparentsprev.test(name)&&matched.reverse()),this.pushStack(matched)}}));var rnothtmlwhite=/[^\x20\t\r\n\f]+/g;function Identity(v){return v}function Thrower(ex){throw ex}function adoptValue(value,resolve,reject,noValue){var method;try{value&&isFunction(method=value.promise)?method.call(value).done(resolve).fail(reject):value&&isFunction(method=value.then)?method.call(value,resolve,reject):resolve.apply(void 0,[value].slice(noValue))}catch(value){reject.apply(void 0,[value])}}jQuery.Callbacks=function(options){options="string"==typeof options?function(options){var object={};return jQuery.each(options.match(rnothtmlwhite)||[],(function(_,flag){object[flag]=!0})),object}(options):jQuery.extend({},options);var firing,memory,fired,locked,list=[],queue=[],firingIndex=-1,fire=function(){for(locked=locked||options.once,fired=firing=!0;queue.length;firingIndex=-1)for(memory=queue.shift();++firingIndex<list.length;)!1===list[firingIndex].apply(memory[0],memory[1])&&options.stopOnFalse&&(firingIndex=list.length,memory=!1);options.memory||(memory=!1),firing=!1,locked&&(list=memory?[]:"")},self={add:function(){return list&&(memory&&!firing&&(firingIndex=list.length-1,queue.push(memory)),function add(args){jQuery.each(args,(function(_,arg){isFunction(arg)?options.unique&&self.has(arg)||list.push(arg):arg&&arg.length&&"string"!==toType(arg)&&add(arg)}))}(arguments),memory&&!firing&&fire()),this},remove:function(){return jQuery.each(arguments,(function(_,arg){for(var index;(index=jQuery.inArray(arg,list,index))>-1;)list.splice(index,1),index<=firingIndex&&firingIndex--})),this},has:function(fn){return fn?jQuery.inArray(fn,list)>-1:list.length>0},empty:function(){return list&&(list=[]),this},disable:function(){return locked=queue=[],list=memory="",this},disabled:function(){return!list},lock:function(){return locked=queue=[],memory||firing||(list=memory=""),this},locked:function(){return!!locked},fireWith:function(context,args){return locked||(args=[context,(args=args||[]).slice?args.slice():args],queue.push(args),firing||fire()),this},fire:function(){return self.fireWith(this,arguments),this},fired:function(){return!!fired}};return self},jQuery.extend({Deferred:function(func){var tuples=[["notify","progress",jQuery.Callbacks("memory"),jQuery.Callbacks("memory"),2],["resolve","done",jQuery.Callbacks("once memory"),jQuery.Callbacks("once memory"),0,"resolved"],["reject","fail",jQuery.Callbacks("once memory"),jQuery.Callbacks("once memory"),1,"rejected"]],state="pending",promise={state:function(){return state},always:function(){return deferred.done(arguments).fail(arguments),this},catch:function(fn){return promise.then(null,fn)},pipe:function(){var fns=arguments;return jQuery.Deferred((function(newDefer){jQuery.each(tuples,(function(_i,tuple){var fn=isFunction(fns[tuple[4]])&&fns[tuple[4]];deferred[tuple[1]]((function(){var returned=fn&&fn.apply(this,arguments);returned&&isFunction(returned.promise)?returned.promise().progress(newDefer.notify).done(newDefer.resolve).fail(newDefer.reject):newDefer[tuple[0]+"With"](this,fn?[returned]:arguments)}))})),fns=null})).promise()},then:function(onFulfilled,onRejected,onProgress){var maxDepth=0;function resolve(depth,deferred,handler,special){return function(){var that=this,args=arguments,mightThrow=function(){var returned,then;if(!(depth<maxDepth)){if((returned=handler.apply(that,args))===deferred.promise())throw new TypeError("Thenable self-resolution");then=returned&&("object"==typeof returned||"function"==typeof returned)&&returned.then,isFunction(then)?special?then.call(returned,resolve(maxDepth,deferred,Identity,special),resolve(maxDepth,deferred,Thrower,special)):(maxDepth++,then.call(returned,resolve(maxDepth,deferred,Identity,special),resolve(maxDepth,deferred,Thrower,special),resolve(maxDepth,deferred,Identity,deferred.notifyWith))):(handler!==Identity&&(that=void 0,args=[returned]),(special||deferred.resolveWith)(that,args))}},process=special?mightThrow:function(){try{mightThrow()}catch(e){jQuery.Deferred.exceptionHook&&jQuery.Deferred.exceptionHook(e,process.stackTrace),depth+1>=maxDepth&&(handler!==Thrower&&(that=void 0,args=[e]),deferred.rejectWith(that,args))}};depth?process():(jQuery.Deferred.getStackHook&&(process.stackTrace=jQuery.Deferred.getStackHook()),window.setTimeout(process))}}return jQuery.Deferred((function(newDefer){tuples[0][3].add(resolve(0,newDefer,isFunction(onProgress)?onProgress:Identity,newDefer.notifyWith)),tuples[1][3].add(resolve(0,newDefer,isFunction(onFulfilled)?onFulfilled:Identity)),tuples[2][3].add(resolve(0,newDefer,isFunction(onRejected)?onRejected:Thrower))})).promise()},promise:function(obj){return null!=obj?jQuery.extend(obj,promise):promise}},deferred={};return jQuery.each(tuples,(function(i,tuple){var list=tuple[2],stateString=tuple[5];promise[tuple[1]]=list.add,stateString&&list.add((function(){state=stateString}),tuples[3-i][2].disable,tuples[3-i][3].disable,tuples[0][2].lock,tuples[0][3].lock),list.add(tuple[3].fire),deferred[tuple[0]]=function(){return deferred[tuple[0]+"With"](this===deferred?void 0:this,arguments),this},deferred[tuple[0]+"With"]=list.fireWith})),promise.promise(deferred),func&&func.call(deferred,deferred),deferred},when:function(singleValue){var remaining=arguments.length,i=remaining,resolveContexts=Array(i),resolveValues=slice.call(arguments),primary=jQuery.Deferred(),updateFunc=function(i){return function(value){resolveContexts[i]=this,resolveValues[i]=arguments.length>1?slice.call(arguments):value,--remaining||primary.resolveWith(resolveContexts,resolveValues)}};if(remaining<=1&&(adoptValue(singleValue,primary.done(updateFunc(i)).resolve,primary.reject,!remaining),"pending"===primary.state()||isFunction(resolveValues[i]&&resolveValues[i].then)))return primary.then();for(;i--;)adoptValue(resolveValues[i],updateFunc(i),primary.reject);return primary.promise()}});var rerrorNames=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;jQuery.Deferred.exceptionHook=function(error,stack){window.console&&window.console.warn&&error&&rerrorNames.test(error.name)&&window.console.warn("jQuery.Deferred exception: "+error.message,error.stack,stack)},jQuery.readyException=function(error){window.setTimeout((function(){throw error}))};var readyList=jQuery.Deferred();function completed(){document.removeEventListener("DOMContentLoaded",completed),window.removeEventListener("load",completed),jQuery.ready()}jQuery.fn.ready=function(fn){return readyList.then(fn).catch((function(error){jQuery.readyException(error)})),this},jQuery.extend({isReady:!1,readyWait:1,ready:function(wait){(!0===wait?--jQuery.readyWait:jQuery.isReady)||(jQuery.isReady=!0,!0!==wait&&--jQuery.readyWait>0||readyList.resolveWith(document,[jQuery]))}}),jQuery.ready.then=readyList.then,"complete"===document.readyState||"loading"!==document.readyState&&!document.documentElement.doScroll?window.setTimeout(jQuery.ready):(document.addEventListener("DOMContentLoaded",completed),window.addEventListener("load",completed));var access=function(elems,fn,key,value,chainable,emptyGet,raw){var i=0,len=elems.length,bulk=null==key;if("object"===toType(key))for(i in chainable=!0,key)access(elems,fn,i,key[i],!0,emptyGet,raw);else if(void 0!==value&&(chainable=!0,isFunction(value)||(raw=!0),bulk&&(raw?(fn.call(elems,value),fn=null):(bulk=fn,fn=function(elem,_key,value){return bulk.call(jQuery(elem),value)})),fn))for(;i<len;i++)fn(elems[i],key,raw?value:value.call(elems[i],i,fn(elems[i],key)));return chainable?elems:bulk?fn.call(elems):len?fn(elems[0],key):emptyGet},rmsPrefix=/^-ms-/,rdashAlpha=/-([a-z])/g;function fcamelCase(_all,letter){return letter.toUpperCase()}function camelCase(string){return string.replace(rmsPrefix,"ms-").replace(rdashAlpha,fcamelCase)}var acceptData=function(owner){return 1===owner.nodeType||9===owner.nodeType||!+owner.nodeType};function Data(){this.expando=jQuery.expando+Data.uid++}Data.uid=1,Data.prototype={cache:function(owner){var value=owner[this.expando];return value||(value={},acceptData(owner)&&(owner.nodeType?owner[this.expando]=value:Object.defineProperty(owner,this.expando,{value:value,configurable:!0}))),value},set:function(owner,data,value){var prop,cache=this.cache(owner);if("string"==typeof data)cache[camelCase(data)]=value;else for(prop in data)cache[camelCase(prop)]=data[prop];return cache},get:function(owner,key){return void 0===key?this.cache(owner):owner[this.expando]&&owner[this.expando][camelCase(key)]},access:function(owner,key,value){return void 0===key||key&&"string"==typeof key&&void 0===value?this.get(owner,key):(this.set(owner,key,value),void 0!==value?value:key)},remove:function(owner,key){var i,cache=owner[this.expando];if(void 0!==cache){if(void 0!==key){i=(key=Array.isArray(key)?key.map(camelCase):(key=camelCase(key))in cache?[key]:key.match(rnothtmlwhite)||[]).length;for(;i--;)delete cache[key[i]]}(void 0===key||jQuery.isEmptyObject(cache))&&(owner.nodeType?owner[this.expando]=void 0:delete owner[this.expando])}},hasData:function(owner){var cache=owner[this.expando];return void 0!==cache&&!jQuery.isEmptyObject(cache)}};var dataPriv=new Data,dataUser=new Data,rbrace=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,rmultiDash=/[A-Z]/g;function dataAttr(elem,key,data){var name;if(void 0===data&&1===elem.nodeType)if(name="data-"+key.replace(rmultiDash,"-$&").toLowerCase(),"string"==typeof(data=elem.getAttribute(name))){try{data=function(data){return"true"===data||"false"!==data&&("null"===data?null:data===+data+""?+data:rbrace.test(data)?JSON.parse(data):data)}(data)}catch(e){}dataUser.set(elem,key,data)}else data=void 0;return data}jQuery.extend({hasData:function(elem){return dataUser.hasData(elem)||dataPriv.hasData(elem)},data:function(elem,name,data){return dataUser.access(elem,name,data)},removeData:function(elem,name){dataUser.remove(elem,name)},_data:function(elem,name,data){return dataPriv.access(elem,name,data)},_removeData:function(elem,name){dataPriv.remove(elem,name)}}),jQuery.fn.extend({data:function(key,value){var i,name,data,elem=this[0],attrs=elem&&elem.attributes;if(void 0===key){if(this.length&&(data=dataUser.get(elem),1===elem.nodeType&&!dataPriv.get(elem,"hasDataAttrs"))){for(i=attrs.length;i--;)attrs[i]&&0===(name=attrs[i].name).indexOf("data-")&&(name=camelCase(name.slice(5)),dataAttr(elem,name,data[name]));dataPriv.set(elem,"hasDataAttrs",!0)}return data}return"object"==typeof key?this.each((function(){dataUser.set(this,key)})):access(this,(function(value){var data;if(elem&&void 0===value)return void 0!==(data=dataUser.get(elem,key))||void 0!==(data=dataAttr(elem,key))?data:void 0;this.each((function(){dataUser.set(this,key,value)}))}),null,value,arguments.length>1,null,!0)},removeData:function(key){return this.each((function(){dataUser.remove(this,key)}))}}),jQuery.extend({queue:function(elem,type,data){var queue;if(elem)return type=(type||"fx")+"queue",queue=dataPriv.get(elem,type),data&&(!queue||Array.isArray(data)?queue=dataPriv.access(elem,type,jQuery.makeArray(data)):queue.push(data)),queue||[]},dequeue:function(elem,type){type=type||"fx";var queue=jQuery.queue(elem,type),startLength=queue.length,fn=queue.shift(),hooks=jQuery._queueHooks(elem,type);"inprogress"===fn&&(fn=queue.shift(),startLength--),fn&&("fx"===type&&queue.unshift("inprogress"),delete hooks.stop,fn.call(elem,(function(){jQuery.dequeue(elem,type)}),hooks)),!startLength&&hooks&&hooks.empty.fire()},_queueHooks:function(elem,type){var key=type+"queueHooks";return dataPriv.get(elem,key)||dataPriv.access(elem,key,{empty:jQuery.Callbacks("once memory").add((function(){dataPriv.remove(elem,[type+"queue",key])}))})}}),jQuery.fn.extend({queue:function(type,data){var setter=2;return"string"!=typeof type&&(data=type,type="fx",setter--),arguments.length<setter?jQuery.queue(this[0],type):void 0===data?this:this.each((function(){var queue=jQuery.queue(this,type,data);jQuery._queueHooks(this,type),"fx"===type&&"inprogress"!==queue[0]&&jQuery.dequeue(this,type)}))},dequeue:function(type){return this.each((function(){jQuery.dequeue(this,type)}))},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,obj){var tmp,count=1,defer=jQuery.Deferred(),elements=this,i=this.length,resolve=function(){--count||defer.resolveWith(elements,[elements])};for("string"!=typeof type&&(obj=type,type=void 0),type=type||"fx";i--;)(tmp=dataPriv.get(elements[i],type+"queueHooks"))&&tmp.empty&&(count++,tmp.empty.add(resolve));return resolve(),defer.promise(obj)}});var pnum=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,rcssNum=new RegExp("^(?:([+-])=|)("+pnum+")([a-z%]*)$","i"),cssExpand=["Top","Right","Bottom","Left"],documentElement=document.documentElement,isAttached=function(elem){return jQuery.contains(elem.ownerDocument,elem)},composed={composed:!0};documentElement.getRootNode&&(isAttached=function(elem){return jQuery.contains(elem.ownerDocument,elem)||elem.getRootNode(composed)===elem.ownerDocument});var isHiddenWithinTree=function(elem,el){return"none"===(elem=el||elem).style.display||""===elem.style.display&&isAttached(elem)&&"none"===jQuery.css(elem,"display")};function adjustCSS(elem,prop,valueParts,tween){var adjusted,scale,maxIterations=20,currentValue=tween?function(){return tween.cur()}:function(){return jQuery.css(elem,prop,"")},initial=currentValue(),unit=valueParts&&valueParts[3]||(jQuery.cssNumber[prop]?"":"px"),initialInUnit=elem.nodeType&&(jQuery.cssNumber[prop]||"px"!==unit&&+initial)&&rcssNum.exec(jQuery.css(elem,prop));if(initialInUnit&&initialInUnit[3]!==unit){for(initial/=2,unit=unit||initialInUnit[3],initialInUnit=+initial||1;maxIterations--;)jQuery.style(elem,prop,initialInUnit+unit),(1-scale)*(1-(scale=currentValue()/initial||.5))<=0&&(maxIterations=0),initialInUnit/=scale;initialInUnit*=2,jQuery.style(elem,prop,initialInUnit+unit),valueParts=valueParts||[]}return valueParts&&(initialInUnit=+initialInUnit||+initial||0,adjusted=valueParts[1]?initialInUnit+(valueParts[1]+1)*valueParts[2]:+valueParts[2],tween&&(tween.unit=unit,tween.start=initialInUnit,tween.end=adjusted)),adjusted}var defaultDisplayMap={};function getDefaultDisplay(elem){var temp,doc=elem.ownerDocument,nodeName=elem.nodeName,display=defaultDisplayMap[nodeName];return display||(temp=doc.body.appendChild(doc.createElement(nodeName)),display=jQuery.css(temp,"display"),temp.parentNode.removeChild(temp),"none"===display&&(display="block"),defaultDisplayMap[nodeName]=display,display)}function showHide(elements,show){for(var display,elem,values=[],index=0,length=elements.length;index<length;index++)(elem=elements[index]).style&&(display=elem.style.display,show?("none"===display&&(values[index]=dataPriv.get(elem,"display")||null,values[index]||(elem.style.display="")),""===elem.style.display&&isHiddenWithinTree(elem)&&(values[index]=getDefaultDisplay(elem))):"none"!==display&&(values[index]="none",dataPriv.set(elem,"display",display)));for(index=0;index<length;index++)null!=values[index]&&(elements[index].style.display=values[index]);return elements}jQuery.fn.extend({show:function(){return showHide(this,!0)},hide:function(){return showHide(this)},toggle:function(state){return"boolean"==typeof state?state?this.show():this.hide():this.each((function(){isHiddenWithinTree(this)?jQuery(this).show():jQuery(this).hide()}))}});var div,input,rcheckableType=/^(?:checkbox|radio)$/i,rtagName=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,rscriptType=/^$|^module$|\/(?:java|ecma)script/i;div=document.createDocumentFragment().appendChild(document.createElement("div")),(input=document.createElement("input")).setAttribute("type","radio"),input.setAttribute("checked","checked"),input.setAttribute("name","t"),div.appendChild(input),support.checkClone=div.cloneNode(!0).cloneNode(!0).lastChild.checked,div.innerHTML="<textarea>x</textarea>",support.noCloneChecked=!!div.cloneNode(!0).lastChild.defaultValue,div.innerHTML="<option></option>",support.option=!!div.lastChild;var wrapMap={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function getAll(context,tag){var ret;return ret=void 0!==context.getElementsByTagName?context.getElementsByTagName(tag||"*"):void 0!==context.querySelectorAll?context.querySelectorAll(tag||"*"):[],void 0===tag||tag&&nodeName(context,tag)?jQuery.merge([context],ret):ret}function setGlobalEval(elems,refElements){for(var i=0,l=elems.length;i<l;i++)dataPriv.set(elems[i],"globalEval",!refElements||dataPriv.get(refElements[i],"globalEval"))}wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead,wrapMap.th=wrapMap.td,support.option||(wrapMap.optgroup=wrapMap.option=[1,"<select multiple='multiple'>","</select>"]);var rhtml=/<|&#?\w+;/;function buildFragment(elems,context,scripts,selection,ignored){for(var elem,tmp,tag,wrap,attached,j,fragment=context.createDocumentFragment(),nodes=[],i=0,l=elems.length;i<l;i++)if((elem=elems[i])||0===elem)if("object"===toType(elem))jQuery.merge(nodes,elem.nodeType?[elem]:elem);else if(rhtml.test(elem)){for(tmp=tmp||fragment.appendChild(context.createElement("div")),tag=(rtagName.exec(elem)||["",""])[1].toLowerCase(),wrap=wrapMap[tag]||wrapMap._default,tmp.innerHTML=wrap[1]+jQuery.htmlPrefilter(elem)+wrap[2],j=wrap[0];j--;)tmp=tmp.lastChild;jQuery.merge(nodes,tmp.childNodes),(tmp=fragment.firstChild).textContent=""}else nodes.push(context.createTextNode(elem));for(fragment.textContent="",i=0;elem=nodes[i++];)if(selection&&jQuery.inArray(elem,selection)>-1)ignored&&ignored.push(elem);else if(attached=isAttached(elem),tmp=getAll(fragment.appendChild(elem),"script"),attached&&setGlobalEval(tmp),scripts)for(j=0;elem=tmp[j++];)rscriptType.test(elem.type||"")&&scripts.push(elem);return fragment}var rtypenamespace=/^([^.]*)(?:\.(.+)|)/;function returnTrue(){return!0}function returnFalse(){return!1}function expectSync(elem,type){return elem===function(){try{return document.activeElement}catch(err){}}()==("focus"===type)}function on(elem,types,selector,data,fn,one){var origFn,type;if("object"==typeof types){for(type in"string"!=typeof selector&&(data=data||selector,selector=void 0),types)on(elem,type,selector,data,types[type],one);return elem}if(null==data&&null==fn?(fn=selector,data=selector=void 0):null==fn&&("string"==typeof selector?(fn=data,data=void 0):(fn=data,data=selector,selector=void 0)),!1===fn)fn=returnFalse;else if(!fn)return elem;return 1===one&&(origFn=fn,(fn=function(event){return jQuery().off(event),origFn.apply(this,arguments)}).guid=origFn.guid||(origFn.guid=jQuery.guid++)),elem.each((function(){jQuery.event.add(this,types,fn,data,selector)}))}function leverageNative(el,type,expectSync){expectSync?(dataPriv.set(el,type,!1),jQuery.event.add(el,type,{namespace:!1,handler:function(event){var notAsync,result,saved=dataPriv.get(this,type);if(1&event.isTrigger&&this[type]){if(saved.length)(jQuery.event.special[type]||{}).delegateType&&event.stopPropagation();else if(saved=slice.call(arguments),dataPriv.set(this,type,saved),notAsync=expectSync(this,type),this[type](),saved!==(result=dataPriv.get(this,type))||notAsync?dataPriv.set(this,type,!1):result={},saved!==result)return event.stopImmediatePropagation(),event.preventDefault(),result&&result.value}else saved.length&&(dataPriv.set(this,type,{value:jQuery.event.trigger(jQuery.extend(saved[0],jQuery.Event.prototype),saved.slice(1),this)}),event.stopImmediatePropagation())}})):void 0===dataPriv.get(el,type)&&jQuery.event.add(el,type,returnTrue)}jQuery.event={global:{},add:function(elem,types,handler,data,selector){var handleObjIn,eventHandle,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=dataPriv.get(elem);if(acceptData(elem))for(handler.handler&&(handler=(handleObjIn=handler).handler,selector=handleObjIn.selector),selector&&jQuery.find.matchesSelector(documentElement,selector),handler.guid||(handler.guid=jQuery.guid++),(events=elemData.events)||(events=elemData.events=Object.create(null)),(eventHandle=elemData.handle)||(eventHandle=elemData.handle=function(e){return void 0!==jQuery&&jQuery.event.triggered!==e.type?jQuery.event.dispatch.apply(elem,arguments):void 0}),t=(types=(types||"").match(rnothtmlwhite)||[""]).length;t--;)type=origType=(tmp=rtypenamespace.exec(types[t])||[])[1],namespaces=(tmp[2]||"").split(".").sort(),type&&(special=jQuery.event.special[type]||{},type=(selector?special.delegateType:special.bindType)||type,special=jQuery.event.special[type]||{},handleObj=jQuery.extend({type:type,origType:origType,data:data,handler:handler,guid:handler.guid,selector:selector,needsContext:selector&&jQuery.expr.match.needsContext.test(selector),namespace:namespaces.join(".")},handleObjIn),(handlers=events[type])||((handlers=events[type]=[]).delegateCount=0,special.setup&&!1!==special.setup.call(elem,data,namespaces,eventHandle)||elem.addEventListener&&elem.addEventListener(type,eventHandle)),special.add&&(special.add.call(elem,handleObj),handleObj.handler.guid||(handleObj.handler.guid=handler.guid)),selector?handlers.splice(handlers.delegateCount++,0,handleObj):handlers.push(handleObj),jQuery.event.global[type]=!0)},remove:function(elem,types,handler,selector,mappedTypes){var j,origCount,tmp,events,t,handleObj,special,handlers,type,namespaces,origType,elemData=dataPriv.hasData(elem)&&dataPriv.get(elem);if(elemData&&(events=elemData.events)){for(t=(types=(types||"").match(rnothtmlwhite)||[""]).length;t--;)if(type=origType=(tmp=rtypenamespace.exec(types[t])||[])[1],namespaces=(tmp[2]||"").split(".").sort(),type){for(special=jQuery.event.special[type]||{},handlers=events[type=(selector?special.delegateType:special.bindType)||type]||[],tmp=tmp[2]&&new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"),origCount=j=handlers.length;j--;)handleObj=handlers[j],!mappedTypes&&origType!==handleObj.origType||handler&&handler.guid!==handleObj.guid||tmp&&!tmp.test(handleObj.namespace)||selector&&selector!==handleObj.selector&&("**"!==selector||!handleObj.selector)||(handlers.splice(j,1),handleObj.selector&&handlers.delegateCount--,special.remove&&special.remove.call(elem,handleObj));origCount&&!handlers.length&&(special.teardown&&!1!==special.teardown.call(elem,namespaces,elemData.handle)||jQuery.removeEvent(elem,type,elemData.handle),delete events[type])}else for(type in events)jQuery.event.remove(elem,type+types[t],handler,selector,!0);jQuery.isEmptyObject(events)&&dataPriv.remove(elem,"handle events")}},dispatch:function(nativeEvent){var i,j,ret,matched,handleObj,handlerQueue,args=new Array(arguments.length),event=jQuery.event.fix(nativeEvent),handlers=(dataPriv.get(this,"events")||Object.create(null))[event.type]||[],special=jQuery.event.special[event.type]||{};for(args[0]=event,i=1;i<arguments.length;i++)args[i]=arguments[i];if(event.delegateTarget=this,!special.preDispatch||!1!==special.preDispatch.call(this,event)){for(handlerQueue=jQuery.event.handlers.call(this,event,handlers),i=0;(matched=handlerQueue[i++])&&!event.isPropagationStopped();)for(event.currentTarget=matched.elem,j=0;(handleObj=matched.handlers[j++])&&!event.isImmediatePropagationStopped();)event.rnamespace&&!1!==handleObj.namespace&&!event.rnamespace.test(handleObj.namespace)||(event.handleObj=handleObj,event.data=handleObj.data,void 0!==(ret=((jQuery.event.special[handleObj.origType]||{}).handle||handleObj.handler).apply(matched.elem,args))&&!1===(event.result=ret)&&(event.preventDefault(),event.stopPropagation()));return special.postDispatch&&special.postDispatch.call(this,event),event.result}},handlers:function(event,handlers){var i,handleObj,sel,matchedHandlers,matchedSelectors,handlerQueue=[],delegateCount=handlers.delegateCount,cur=event.target;if(delegateCount&&cur.nodeType&&!("click"===event.type&&event.button>=1))for(;cur!==this;cur=cur.parentNode||this)if(1===cur.nodeType&&("click"!==event.type||!0!==cur.disabled)){for(matchedHandlers=[],matchedSelectors={},i=0;i<delegateCount;i++)void 0===matchedSelectors[sel=(handleObj=handlers[i]).selector+" "]&&(matchedSelectors[sel]=handleObj.needsContext?jQuery(sel,this).index(cur)>-1:jQuery.find(sel,this,null,[cur]).length),matchedSelectors[sel]&&matchedHandlers.push(handleObj);matchedHandlers.length&&handlerQueue.push({elem:cur,handlers:matchedHandlers})}return cur=this,delegateCount<handlers.length&&handlerQueue.push({elem:cur,handlers:handlers.slice(delegateCount)}),handlerQueue},addProp:function(name,hook){Object.defineProperty(jQuery.Event.prototype,name,{enumerable:!0,configurable:!0,get:isFunction(hook)?function(){if(this.originalEvent)return hook(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[name]},set:function(value){Object.defineProperty(this,name,{enumerable:!0,configurable:!0,writable:!0,value:value})}})},fix:function(originalEvent){return originalEvent[jQuery.expando]?originalEvent:new jQuery.Event(originalEvent)},special:{load:{noBubble:!0},click:{setup:function(data){var el=this||data;return rcheckableType.test(el.type)&&el.click&&nodeName(el,"input")&&leverageNative(el,"click",returnTrue),!1},trigger:function(data){var el=this||data;return rcheckableType.test(el.type)&&el.click&&nodeName(el,"input")&&leverageNative(el,"click"),!0},_default:function(event){var target=event.target;return rcheckableType.test(target.type)&&target.click&&nodeName(target,"input")&&dataPriv.get(target,"click")||nodeName(target,"a")}},beforeunload:{postDispatch:function(event){void 0!==event.result&&event.originalEvent&&(event.originalEvent.returnValue=event.result)}}}},jQuery.removeEvent=function(elem,type,handle){elem.removeEventListener&&elem.removeEventListener(type,handle)},jQuery.Event=function(src,props){if(!(this instanceof jQuery.Event))return new jQuery.Event(src,props);src&&src.type?(this.originalEvent=src,this.type=src.type,this.isDefaultPrevented=src.defaultPrevented||void 0===src.defaultPrevented&&!1===src.returnValue?returnTrue:returnFalse,this.target=src.target&&3===src.target.nodeType?src.target.parentNode:src.target,this.currentTarget=src.currentTarget,this.relatedTarget=src.relatedTarget):this.type=src,props&&jQuery.extend(this,props),this.timeStamp=src&&src.timeStamp||Date.now(),this[jQuery.expando]=!0},jQuery.Event.prototype={constructor:jQuery.Event,isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=returnTrue,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},jQuery.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},jQuery.event.addProp),jQuery.each({focus:"focusin",blur:"focusout"},(function(type,delegateType){jQuery.event.special[type]={setup:function(){return leverageNative(this,type,expectSync),!1},trigger:function(){return leverageNative(this,type),!0},_default:function(){return!0},delegateType:delegateType}})),jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},(function(orig,fix){jQuery.event.special[orig]={delegateType:fix,bindType:fix,handle:function(event){var ret,target=this,related=event.relatedTarget,handleObj=event.handleObj;return related&&(related===target||jQuery.contains(target,related))||(event.type=handleObj.origType,ret=handleObj.handler.apply(this,arguments),event.type=fix),ret}}})),jQuery.fn.extend({on:function(types,selector,data,fn){return on(this,types,selector,data,fn)},one:function(types,selector,data,fn){return on(this,types,selector,data,fn,1)},off:function(types,selector,fn){var handleObj,type;if(types&&types.preventDefault&&types.handleObj)return handleObj=types.handleObj,jQuery(types.delegateTarget).off(handleObj.namespace?handleObj.origType+"."+handleObj.namespace:handleObj.origType,handleObj.selector,handleObj.handler),this;if("object"==typeof types){for(type in types)this.off(type,selector,types[type]);return this}return!1!==selector&&"function"!=typeof selector||(fn=selector,selector=void 0),!1===fn&&(fn=returnFalse),this.each((function(){jQuery.event.remove(this,types,fn,selector)}))}});var rnoInnerhtml=/<script|<style|<link/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rcleanScript=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function manipulationTarget(elem,content){return nodeName(elem,"table")&&nodeName(11!==content.nodeType?content:content.firstChild,"tr")&&jQuery(elem).children("tbody")[0]||elem}function disableScript(elem){return elem.type=(null!==elem.getAttribute("type"))+"/"+elem.type,elem}function restoreScript(elem){return"true/"===(elem.type||"").slice(0,5)?elem.type=elem.type.slice(5):elem.removeAttribute("type"),elem}function cloneCopyEvent(src,dest){var i,l,type,udataOld,udataCur,events;if(1===dest.nodeType){if(dataPriv.hasData(src)&&(events=dataPriv.get(src).events))for(type in dataPriv.remove(dest,"handle events"),events)for(i=0,l=events[type].length;i<l;i++)jQuery.event.add(dest,type,events[type][i]);dataUser.hasData(src)&&(udataOld=dataUser.access(src),udataCur=jQuery.extend({},udataOld),dataUser.set(dest,udataCur))}}function fixInput(src,dest){var nodeName=dest.nodeName.toLowerCase();"input"===nodeName&&rcheckableType.test(src.type)?dest.checked=src.checked:"input"!==nodeName&&"textarea"!==nodeName||(dest.defaultValue=src.defaultValue)}function domManip(collection,args,callback,ignored){args=flat(args);var fragment,first,scripts,hasScripts,node,doc,i=0,l=collection.length,iNoClone=l-1,value=args[0],valueIsFunction=isFunction(value);if(valueIsFunction||l>1&&"string"==typeof value&&!support.checkClone&&rchecked.test(value))return collection.each((function(index){var self=collection.eq(index);valueIsFunction&&(args[0]=value.call(this,index,self.html())),domManip(self,args,callback,ignored)}));if(l&&(first=(fragment=buildFragment(args,collection[0].ownerDocument,!1,collection,ignored)).firstChild,1===fragment.childNodes.length&&(fragment=first),first||ignored)){for(hasScripts=(scripts=jQuery.map(getAll(fragment,"script"),disableScript)).length;i<l;i++)node=fragment,i!==iNoClone&&(node=jQuery.clone(node,!0,!0),hasScripts&&jQuery.merge(scripts,getAll(node,"script"))),callback.call(collection[i],node,i);if(hasScripts)for(doc=scripts[scripts.length-1].ownerDocument,jQuery.map(scripts,restoreScript),i=0;i<hasScripts;i++)node=scripts[i],rscriptType.test(node.type||"")&&!dataPriv.access(node,"globalEval")&&jQuery.contains(doc,node)&&(node.src&&"module"!==(node.type||"").toLowerCase()?jQuery._evalUrl&&!node.noModule&&jQuery._evalUrl(node.src,{nonce:node.nonce||node.getAttribute("nonce")},doc):DOMEval(node.textContent.replace(rcleanScript,""),node,doc))}return collection}function remove(elem,selector,keepData){for(var node,nodes=selector?jQuery.filter(selector,elem):elem,i=0;null!=(node=nodes[i]);i++)keepData||1!==node.nodeType||jQuery.cleanData(getAll(node)),node.parentNode&&(keepData&&isAttached(node)&&setGlobalEval(getAll(node,"script")),node.parentNode.removeChild(node));return elem}jQuery.extend({htmlPrefilter:function(html){return html},clone:function(elem,dataAndEvents,deepDataAndEvents){var i,l,srcElements,destElements,clone=elem.cloneNode(!0),inPage=isAttached(elem);if(!(support.noCloneChecked||1!==elem.nodeType&&11!==elem.nodeType||jQuery.isXMLDoc(elem)))for(destElements=getAll(clone),i=0,l=(srcElements=getAll(elem)).length;i<l;i++)fixInput(srcElements[i],destElements[i]);if(dataAndEvents)if(deepDataAndEvents)for(srcElements=srcElements||getAll(elem),destElements=destElements||getAll(clone),i=0,l=srcElements.length;i<l;i++)cloneCopyEvent(srcElements[i],destElements[i]);else cloneCopyEvent(elem,clone);return(destElements=getAll(clone,"script")).length>0&&setGlobalEval(destElements,!inPage&&getAll(elem,"script")),clone},cleanData:function(elems){for(var data,elem,type,special=jQuery.event.special,i=0;void 0!==(elem=elems[i]);i++)if(acceptData(elem)){if(data=elem[dataPriv.expando]){if(data.events)for(type in data.events)special[type]?jQuery.event.remove(elem,type):jQuery.removeEvent(elem,type,data.handle);elem[dataPriv.expando]=void 0}elem[dataUser.expando]&&(elem[dataUser.expando]=void 0)}}}),jQuery.fn.extend({detach:function(selector){return remove(this,selector,!0)},remove:function(selector){return remove(this,selector)},text:function(value){return access(this,(function(value){return void 0===value?jQuery.text(this):this.empty().each((function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=value)}))}),null,value,arguments.length)},append:function(){return domManip(this,arguments,(function(elem){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||manipulationTarget(this,elem).appendChild(elem)}))},prepend:function(){return domManip(this,arguments,(function(elem){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var target=manipulationTarget(this,elem);target.insertBefore(elem,target.firstChild)}}))},before:function(){return domManip(this,arguments,(function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this)}))},after:function(){return domManip(this,arguments,(function(elem){this.parentNode&&this.parentNode.insertBefore(elem,this.nextSibling)}))},empty:function(){for(var elem,i=0;null!=(elem=this[i]);i++)1===elem.nodeType&&(jQuery.cleanData(getAll(elem,!1)),elem.textContent="");return this},clone:function(dataAndEvents,deepDataAndEvents){return dataAndEvents=null!=dataAndEvents&&dataAndEvents,deepDataAndEvents=null==deepDataAndEvents?dataAndEvents:deepDataAndEvents,this.map((function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)}))},html:function(value){return access(this,(function(value){var elem=this[0]||{},i=0,l=this.length;if(void 0===value&&1===elem.nodeType)return elem.innerHTML;if("string"==typeof value&&!rnoInnerhtml.test(value)&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=jQuery.htmlPrefilter(value);try{for(;i<l;i++)1===(elem=this[i]||{}).nodeType&&(jQuery.cleanData(getAll(elem,!1)),elem.innerHTML=value);elem=0}catch(e){}}elem&&this.empty().append(value)}),null,value,arguments.length)},replaceWith:function(){var ignored=[];return domManip(this,arguments,(function(elem){var parent=this.parentNode;jQuery.inArray(this,ignored)<0&&(jQuery.cleanData(getAll(this)),parent&&parent.replaceChild(elem,this))}),ignored)}}),jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},(function(name,original){jQuery.fn[name]=function(selector){for(var elems,ret=[],insert=jQuery(selector),last=insert.length-1,i=0;i<=last;i++)elems=i===last?this:this.clone(!0),jQuery(insert[i])[original](elems),push.apply(ret,elems.get());return this.pushStack(ret)}}));var rnumnonpx=new RegExp("^("+pnum+")(?!px)[a-z%]+$","i"),getStyles=function(elem){var view=elem.ownerDocument.defaultView;return view&&view.opener||(view=window),view.getComputedStyle(elem)},swap=function(elem,options,callback){var ret,name,old={};for(name in options)old[name]=elem.style[name],elem.style[name]=options[name];for(name in ret=callback.call(elem),options)elem.style[name]=old[name];return ret},rboxStyle=new RegExp(cssExpand.join("|"),"i");function curCSS(elem,name,computed){var width,minWidth,maxWidth,ret,style=elem.style;return(computed=computed||getStyles(elem))&&(""!==(ret=computed.getPropertyValue(name)||computed[name])||isAttached(elem)||(ret=jQuery.style(elem,name)),!support.pixelBoxStyles()&&rnumnonpx.test(ret)&&rboxStyle.test(name)&&(width=style.width,minWidth=style.minWidth,maxWidth=style.maxWidth,style.minWidth=style.maxWidth=style.width=ret,ret=computed.width,style.width=width,style.minWidth=minWidth,style.maxWidth=maxWidth)),void 0!==ret?ret+"":ret}function addGetHookIf(conditionFn,hookFn){return{get:function(){if(!conditionFn())return(this.get=hookFn).apply(this,arguments);delete this.get}}}!function(){function computeStyleTests(){if(div){container.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",div.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",documentElement.appendChild(container).appendChild(div);var divStyle=window.getComputedStyle(div);pixelPositionVal="1%"!==divStyle.top,reliableMarginLeftVal=12===roundPixelMeasures(divStyle.marginLeft),div.style.right="60%",pixelBoxStylesVal=36===roundPixelMeasures(divStyle.right),boxSizingReliableVal=36===roundPixelMeasures(divStyle.width),div.style.position="absolute",scrollboxSizeVal=12===roundPixelMeasures(div.offsetWidth/3),documentElement.removeChild(container),div=null}}function roundPixelMeasures(measure){return Math.round(parseFloat(measure))}var pixelPositionVal,boxSizingReliableVal,scrollboxSizeVal,pixelBoxStylesVal,reliableTrDimensionsVal,reliableMarginLeftVal,container=document.createElement("div"),div=document.createElement("div");div.style&&(div.style.backgroundClip="content-box",div.cloneNode(!0).style.backgroundClip="",support.clearCloneStyle="content-box"===div.style.backgroundClip,jQuery.extend(support,{boxSizingReliable:function(){return computeStyleTests(),boxSizingReliableVal},pixelBoxStyles:function(){return computeStyleTests(),pixelBoxStylesVal},pixelPosition:function(){return computeStyleTests(),pixelPositionVal},reliableMarginLeft:function(){return computeStyleTests(),reliableMarginLeftVal},scrollboxSize:function(){return computeStyleTests(),scrollboxSizeVal},reliableTrDimensions:function(){var table,tr,trChild,trStyle;return null==reliableTrDimensionsVal&&(table=document.createElement("table"),tr=document.createElement("tr"),trChild=document.createElement("div"),table.style.cssText="position:absolute;left:-11111px;border-collapse:separate",tr.style.cssText="border:1px solid",tr.style.height="1px",trChild.style.height="9px",trChild.style.display="block",documentElement.appendChild(table).appendChild(tr).appendChild(trChild),trStyle=window.getComputedStyle(tr),reliableTrDimensionsVal=parseInt(trStyle.height,10)+parseInt(trStyle.borderTopWidth,10)+parseInt(trStyle.borderBottomWidth,10)===tr.offsetHeight,documentElement.removeChild(table)),reliableTrDimensionsVal}}))}();var cssPrefixes=["Webkit","Moz","ms"],emptyStyle=document.createElement("div").style,vendorProps={};function finalPropName(name){var final=jQuery.cssProps[name]||vendorProps[name];return final||(name in emptyStyle?name:vendorProps[name]=function(name){for(var capName=name[0].toUpperCase()+name.slice(1),i=cssPrefixes.length;i--;)if((name=cssPrefixes[i]+capName)in emptyStyle)return name}(name)||name)}var rdisplayswap=/^(none|table(?!-c[ea]).+)/,rcustomProp=/^--/,cssShow={position:"absolute",visibility:"hidden",display:"block"},cssNormalTransform={letterSpacing:"0",fontWeight:"400"};function setPositiveNumber(_elem,value,subtract){var matches=rcssNum.exec(value);return matches?Math.max(0,matches[2]-(subtract||0))+(matches[3]||"px"):value}function boxModelAdjustment(elem,dimension,box,isBorderBox,styles,computedVal){var i="width"===dimension?1:0,extra=0,delta=0;if(box===(isBorderBox?"border":"content"))return 0;for(;i<4;i+=2)"margin"===box&&(delta+=jQuery.css(elem,box+cssExpand[i],!0,styles)),isBorderBox?("content"===box&&(delta-=jQuery.css(elem,"padding"+cssExpand[i],!0,styles)),"margin"!==box&&(delta-=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles))):(delta+=jQuery.css(elem,"padding"+cssExpand[i],!0,styles),"padding"!==box?delta+=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles):extra+=jQuery.css(elem,"border"+cssExpand[i]+"Width",!0,styles));return!isBorderBox&&computedVal>=0&&(delta+=Math.max(0,Math.ceil(elem["offset"+dimension[0].toUpperCase()+dimension.slice(1)]-computedVal-delta-extra-.5))||0),delta}function getWidthOrHeight(elem,dimension,extra){var styles=getStyles(elem),isBorderBox=(!support.boxSizingReliable()||extra)&&"border-box"===jQuery.css(elem,"boxSizing",!1,styles),valueIsBorderBox=isBorderBox,val=curCSS(elem,dimension,styles),offsetProp="offset"+dimension[0].toUpperCase()+dimension.slice(1);if(rnumnonpx.test(val)){if(!extra)return val;val="auto"}return(!support.boxSizingReliable()&&isBorderBox||!support.reliableTrDimensions()&&nodeName(elem,"tr")||"auto"===val||!parseFloat(val)&&"inline"===jQuery.css(elem,"display",!1,styles))&&elem.getClientRects().length&&(isBorderBox="border-box"===jQuery.css(elem,"boxSizing",!1,styles),(valueIsBorderBox=offsetProp in elem)&&(val=elem[offsetProp])),(val=parseFloat(val)||0)+boxModelAdjustment(elem,dimension,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles,val)+"px"}function Tween(elem,options,prop,end,easing){return new Tween.prototype.init(elem,options,prop,end,easing)}jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity");return""===ret?"1":ret}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(elem,name,value,extra){if(elem&&3!==elem.nodeType&&8!==elem.nodeType&&elem.style){var ret,type,hooks,origName=camelCase(name),isCustomProp=rcustomProp.test(name),style=elem.style;if(isCustomProp||(name=finalPropName(origName)),hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName],void 0===value)return hooks&&"get"in hooks&&void 0!==(ret=hooks.get(elem,!1,extra))?ret:style[name];"string"===(type=typeof value)&&(ret=rcssNum.exec(value))&&ret[1]&&(value=adjustCSS(elem,name,ret),type="number"),null!=value&&value==value&&("number"!==type||isCustomProp||(value+=ret&&ret[3]||(jQuery.cssNumber[origName]?"":"px")),support.clearCloneStyle||""!==value||0!==name.indexOf("background")||(style[name]="inherit"),hooks&&"set"in hooks&&void 0===(value=hooks.set(elem,value,extra))||(isCustomProp?style.setProperty(name,value):style[name]=value))}},css:function(elem,name,extra,styles){var val,num,hooks,origName=camelCase(name);return rcustomProp.test(name)||(name=finalPropName(origName)),(hooks=jQuery.cssHooks[name]||jQuery.cssHooks[origName])&&"get"in hooks&&(val=hooks.get(elem,!0,extra)),void 0===val&&(val=curCSS(elem,name,styles)),"normal"===val&&name in cssNormalTransform&&(val=cssNormalTransform[name]),""===extra||extra?(num=parseFloat(val),!0===extra||isFinite(num)?num||0:val):val}}),jQuery.each(["height","width"],(function(_i,dimension){jQuery.cssHooks[dimension]={get:function(elem,computed,extra){if(computed)return!rdisplayswap.test(jQuery.css(elem,"display"))||elem.getClientRects().length&&elem.getBoundingClientRect().width?getWidthOrHeight(elem,dimension,extra):swap(elem,cssShow,(function(){return getWidthOrHeight(elem,dimension,extra)}))},set:function(elem,value,extra){var matches,styles=getStyles(elem),scrollboxSizeBuggy=!support.scrollboxSize()&&"absolute"===styles.position,isBorderBox=(scrollboxSizeBuggy||extra)&&"border-box"===jQuery.css(elem,"boxSizing",!1,styles),subtract=extra?boxModelAdjustment(elem,dimension,extra,isBorderBox,styles):0;return isBorderBox&&scrollboxSizeBuggy&&(subtract-=Math.ceil(elem["offset"+dimension[0].toUpperCase()+dimension.slice(1)]-parseFloat(styles[dimension])-boxModelAdjustment(elem,dimension,"border",!1,styles)-.5)),subtract&&(matches=rcssNum.exec(value))&&"px"!==(matches[3]||"px")&&(elem.style[dimension]=value,value=jQuery.css(elem,dimension)),setPositiveNumber(0,value,subtract)}}})),jQuery.cssHooks.marginLeft=addGetHookIf(support.reliableMarginLeft,(function(elem,computed){if(computed)return(parseFloat(curCSS(elem,"marginLeft"))||elem.getBoundingClientRect().left-swap(elem,{marginLeft:0},(function(){return elem.getBoundingClientRect().left})))+"px"})),jQuery.each({margin:"",padding:"",border:"Width"},(function(prefix,suffix){jQuery.cssHooks[prefix+suffix]={expand:function(value){for(var i=0,expanded={},parts="string"==typeof value?value.split(" "):[value];i<4;i++)expanded[prefix+cssExpand[i]+suffix]=parts[i]||parts[i-2]||parts[0];return expanded}},"margin"!==prefix&&(jQuery.cssHooks[prefix+suffix].set=setPositiveNumber)})),jQuery.fn.extend({css:function(name,value){return access(this,(function(elem,name,value){var styles,len,map={},i=0;if(Array.isArray(name)){for(styles=getStyles(elem),len=name.length;i<len;i++)map[name[i]]=jQuery.css(elem,name[i],!1,styles);return map}return void 0!==value?jQuery.style(elem,name,value):jQuery.css(elem,name)}),name,value,arguments.length>1)}}),jQuery.Tween=Tween,Tween.prototype={constructor:Tween,init:function(elem,options,prop,end,easing,unit){this.elem=elem,this.prop=prop,this.easing=easing||jQuery.easing._default,this.options=options,this.start=this.now=this.cur(),this.end=end,this.unit=unit||(jQuery.cssNumber[prop]?"":"px")},cur:function(){var hooks=Tween.propHooks[this.prop];return hooks&&hooks.get?hooks.get(this):Tween.propHooks._default.get(this)},run:function(percent){var eased,hooks=Tween.propHooks[this.prop];return this.options.duration?this.pos=eased=jQuery.easing[this.easing](percent,this.options.duration*percent,0,1,this.options.duration):this.pos=eased=percent,this.now=(this.end-this.start)*eased+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),hooks&&hooks.set?hooks.set(this):Tween.propHooks._default.set(this),this}},Tween.prototype.init.prototype=Tween.prototype,Tween.propHooks={_default:{get:function(tween){var result;return 1!==tween.elem.nodeType||null!=tween.elem[tween.prop]&&null==tween.elem.style[tween.prop]?tween.elem[tween.prop]:(result=jQuery.css(tween.elem,tween.prop,""))&&"auto"!==result?result:0},set:function(tween){jQuery.fx.step[tween.prop]?jQuery.fx.step[tween.prop](tween):1!==tween.elem.nodeType||!jQuery.cssHooks[tween.prop]&&null==tween.elem.style[finalPropName(tween.prop)]?tween.elem[tween.prop]=tween.now:jQuery.style(tween.elem,tween.prop,tween.now+tween.unit)}}},Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(tween){tween.elem.nodeType&&tween.elem.parentNode&&(tween.elem[tween.prop]=tween.now)}},jQuery.easing={linear:function(p){return p},swing:function(p){return.5-Math.cos(p*Math.PI)/2},_default:"swing"},jQuery.fx=Tween.prototype.init,jQuery.fx.step={};var fxNow,inProgress,rfxtypes=/^(?:toggle|show|hide)$/,rrun=/queueHooks$/;function schedule(){inProgress&&(!1===document.hidden&&window.requestAnimationFrame?window.requestAnimationFrame(schedule):window.setTimeout(schedule,jQuery.fx.interval),jQuery.fx.tick())}function createFxNow(){return window.setTimeout((function(){fxNow=void 0})),fxNow=Date.now()}function genFx(type,includeWidth){var which,i=0,attrs={height:type};for(includeWidth=includeWidth?1:0;i<4;i+=2-includeWidth)attrs["margin"+(which=cssExpand[i])]=attrs["padding"+which]=type;return includeWidth&&(attrs.opacity=attrs.width=type),attrs}function createTween(value,prop,animation){for(var tween,collection=(Animation.tweeners[prop]||[]).concat(Animation.tweeners["*"]),index=0,length=collection.length;index<length;index++)if(tween=collection[index].call(animation,prop,value))return tween}function Animation(elem,properties,options){var result,stopped,index=0,length=Animation.prefilters.length,deferred=jQuery.Deferred().always((function(){delete tick.elem})),tick=function(){if(stopped)return!1;for(var currentTime=fxNow||createFxNow(),remaining=Math.max(0,animation.startTime+animation.duration-currentTime),percent=1-(remaining/animation.duration||0),index=0,length=animation.tweens.length;index<length;index++)animation.tweens[index].run(percent);return deferred.notifyWith(elem,[animation,percent,remaining]),percent<1&&length?remaining:(length||deferred.notifyWith(elem,[animation,1,0]),deferred.resolveWith(elem,[animation]),!1)},animation=deferred.promise({elem:elem,props:jQuery.extend({},properties),opts:jQuery.extend(!0,{specialEasing:{},easing:jQuery.easing._default},options),originalProperties:properties,originalOptions:options,startTime:fxNow||createFxNow(),duration:options.duration,tweens:[],createTween:function(prop,end){var tween=jQuery.Tween(elem,animation.opts,prop,end,animation.opts.specialEasing[prop]||animation.opts.easing);return animation.tweens.push(tween),tween},stop:function(gotoEnd){var index=0,length=gotoEnd?animation.tweens.length:0;if(stopped)return this;for(stopped=!0;index<length;index++)animation.tweens[index].run(1);return gotoEnd?(deferred.notifyWith(elem,[animation,1,0]),deferred.resolveWith(elem,[animation,gotoEnd])):deferred.rejectWith(elem,[animation,gotoEnd]),this}}),props=animation.props;for(!function(props,specialEasing){var index,name,easing,value,hooks;for(index in props)if(easing=specialEasing[name=camelCase(index)],value=props[index],Array.isArray(value)&&(easing=value[1],value=props[index]=value[0]),index!==name&&(props[name]=value,delete props[index]),(hooks=jQuery.cssHooks[name])&&"expand"in hooks)for(index in value=hooks.expand(value),delete props[name],value)index in props||(props[index]=value[index],specialEasing[index]=easing);else specialEasing[name]=easing}(props,animation.opts.specialEasing);index<length;index++)if(result=Animation.prefilters[index].call(animation,elem,props,animation.opts))return isFunction(result.stop)&&(jQuery._queueHooks(animation.elem,animation.opts.queue).stop=result.stop.bind(result)),result;return jQuery.map(props,createTween,animation),isFunction(animation.opts.start)&&animation.opts.start.call(elem,animation),animation.progress(animation.opts.progress).done(animation.opts.done,animation.opts.complete).fail(animation.opts.fail).always(animation.opts.always),jQuery.fx.timer(jQuery.extend(tick,{elem:elem,anim:animation,queue:animation.opts.queue})),animation}jQuery.Animation=jQuery.extend(Animation,{tweeners:{"*":[function(prop,value){var tween=this.createTween(prop,value);return adjustCSS(tween.elem,prop,rcssNum.exec(value),tween),tween}]},tweener:function(props,callback){isFunction(props)?(callback=props,props=["*"]):props=props.match(rnothtmlwhite);for(var prop,index=0,length=props.length;index<length;index++)prop=props[index],Animation.tweeners[prop]=Animation.tweeners[prop]||[],Animation.tweeners[prop].unshift(callback)},prefilters:[function(elem,props,opts){var prop,value,toggle,hooks,oldfire,propTween,restoreDisplay,display,isBox="width"in props||"height"in props,anim=this,orig={},style=elem.style,hidden=elem.nodeType&&isHiddenWithinTree(elem),dataShow=dataPriv.get(elem,"fxshow");for(prop in opts.queue||(null==(hooks=jQuery._queueHooks(elem,"fx")).unqueued&&(hooks.unqueued=0,oldfire=hooks.empty.fire,hooks.empty.fire=function(){hooks.unqueued||oldfire()}),hooks.unqueued++,anim.always((function(){anim.always((function(){hooks.unqueued--,jQuery.queue(elem,"fx").length||hooks.empty.fire()}))}))),props)if(value=props[prop],rfxtypes.test(value)){if(delete props[prop],toggle=toggle||"toggle"===value,value===(hidden?"hide":"show")){if("show"!==value||!dataShow||void 0===dataShow[prop])continue;hidden=!0}orig[prop]=dataShow&&dataShow[prop]||jQuery.style(elem,prop)}if((propTween=!jQuery.isEmptyObject(props))||!jQuery.isEmptyObject(orig))for(prop in isBox&&1===elem.nodeType&&(opts.overflow=[style.overflow,style.overflowX,style.overflowY],null==(restoreDisplay=dataShow&&dataShow.display)&&(restoreDisplay=dataPriv.get(elem,"display")),"none"===(display=jQuery.css(elem,"display"))&&(restoreDisplay?display=restoreDisplay:(showHide([elem],!0),restoreDisplay=elem.style.display||restoreDisplay,display=jQuery.css(elem,"display"),showHide([elem]))),("inline"===display||"inline-block"===display&&null!=restoreDisplay)&&"none"===jQuery.css(elem,"float")&&(propTween||(anim.done((function(){style.display=restoreDisplay})),null==restoreDisplay&&(display=style.display,restoreDisplay="none"===display?"":display)),style.display="inline-block")),opts.overflow&&(style.overflow="hidden",anim.always((function(){style.overflow=opts.overflow[0],style.overflowX=opts.overflow[1],style.overflowY=opts.overflow[2]}))),propTween=!1,orig)propTween||(dataShow?"hidden"in dataShow&&(hidden=dataShow.hidden):dataShow=dataPriv.access(elem,"fxshow",{display:restoreDisplay}),toggle&&(dataShow.hidden=!hidden),hidden&&showHide([elem],!0),anim.done((function(){for(prop in hidden||showHide([elem]),dataPriv.remove(elem,"fxshow"),orig)jQuery.style(elem,prop,orig[prop])}))),propTween=createTween(hidden?dataShow[prop]:0,prop,anim),prop in dataShow||(dataShow[prop]=propTween.start,hidden&&(propTween.end=propTween.start,propTween.start=0))}],prefilter:function(callback,prepend){prepend?Animation.prefilters.unshift(callback):Animation.prefilters.push(callback)}}),jQuery.speed=function(speed,easing,fn){var opt=speed&&"object"==typeof speed?jQuery.extend({},speed):{complete:fn||!fn&&easing||isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!isFunction(easing)&&easing};return jQuery.fx.off?opt.duration=0:"number"!=typeof opt.duration&&(opt.duration in jQuery.fx.speeds?opt.duration=jQuery.fx.speeds[opt.duration]:opt.duration=jQuery.fx.speeds._default),null!=opt.queue&&!0!==opt.queue||(opt.queue="fx"),opt.old=opt.complete,opt.complete=function(){isFunction(opt.old)&&opt.old.call(this),opt.queue&&jQuery.dequeue(this,opt.queue)},opt},jQuery.fn.extend({fadeTo:function(speed,to,easing,callback){return this.filter(isHiddenWithinTree).css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var empty=jQuery.isEmptyObject(prop),optall=jQuery.speed(speed,easing,callback),doAnimation=function(){var anim=Animation(this,jQuery.extend({},prop),optall);(empty||dataPriv.get(this,"finish"))&&anim.stop(!0)};return doAnimation.finish=doAnimation,empty||!1===optall.queue?this.each(doAnimation):this.queue(optall.queue,doAnimation)},stop:function(type,clearQueue,gotoEnd){var stopQueue=function(hooks){var stop=hooks.stop;delete hooks.stop,stop(gotoEnd)};return"string"!=typeof type&&(gotoEnd=clearQueue,clearQueue=type,type=void 0),clearQueue&&this.queue(type||"fx",[]),this.each((function(){var dequeue=!0,index=null!=type&&type+"queueHooks",timers=jQuery.timers,data=dataPriv.get(this);if(index)data[index]&&data[index].stop&&stopQueue(data[index]);else for(index in data)data[index]&&data[index].stop&&rrun.test(index)&&stopQueue(data[index]);for(index=timers.length;index--;)timers[index].elem!==this||null!=type&&timers[index].queue!==type||(timers[index].anim.stop(gotoEnd),dequeue=!1,timers.splice(index,1));!dequeue&&gotoEnd||jQuery.dequeue(this,type)}))},finish:function(type){return!1!==type&&(type=type||"fx"),this.each((function(){var index,data=dataPriv.get(this),queue=data[type+"queue"],hooks=data[type+"queueHooks"],timers=jQuery.timers,length=queue?queue.length:0;for(data.finish=!0,jQuery.queue(this,type,[]),hooks&&hooks.stop&&hooks.stop.call(this,!0),index=timers.length;index--;)timers[index].elem===this&&timers[index].queue===type&&(timers[index].anim.stop(!0),timers.splice(index,1));for(index=0;index<length;index++)queue[index]&&queue[index].finish&&queue[index].finish.call(this);delete data.finish}))}}),jQuery.each(["toggle","show","hide"],(function(_i,name){var cssFn=jQuery.fn[name];jQuery.fn[name]=function(speed,easing,callback){return null==speed||"boolean"==typeof speed?cssFn.apply(this,arguments):this.animate(genFx(name,!0),speed,easing,callback)}})),jQuery.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},(function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}})),jQuery.timers=[],jQuery.fx.tick=function(){var timer,i=0,timers=jQuery.timers;for(fxNow=Date.now();i<timers.length;i++)(timer=timers[i])()||timers[i]!==timer||timers.splice(i--,1);timers.length||jQuery.fx.stop(),fxNow=void 0},jQuery.fx.timer=function(timer){jQuery.timers.push(timer),jQuery.fx.start()},jQuery.fx.interval=13,jQuery.fx.start=function(){inProgress||(inProgress=!0,schedule())},jQuery.fx.stop=function(){inProgress=null},jQuery.fx.speeds={slow:600,fast:200,_default:400},jQuery.fn.delay=function(time,type){return time=jQuery.fx&&jQuery.fx.speeds[time]||time,type=type||"fx",this.queue(type,(function(next,hooks){var timeout=window.setTimeout(next,time);hooks.stop=function(){window.clearTimeout(timeout)}}))},function(){var input=document.createElement("input"),opt=document.createElement("select").appendChild(document.createElement("option"));input.type="checkbox",support.checkOn=""!==input.value,support.optSelected=opt.selected,(input=document.createElement("input")).value="t",input.type="radio",support.radioValue="t"===input.value}();var boolHook,attrHandle=jQuery.expr.attrHandle;jQuery.fn.extend({attr:function(name,value){return access(this,jQuery.attr,name,value,arguments.length>1)},removeAttr:function(name){return this.each((function(){jQuery.removeAttr(this,name)}))}}),jQuery.extend({attr:function(elem,name,value){var ret,hooks,nType=elem.nodeType;if(3!==nType&&8!==nType&&2!==nType)return void 0===elem.getAttribute?jQuery.prop(elem,name,value):(1===nType&&jQuery.isXMLDoc(elem)||(hooks=jQuery.attrHooks[name.toLowerCase()]||(jQuery.expr.match.bool.test(name)?boolHook:void 0)),void 0!==value?null===value?void jQuery.removeAttr(elem,name):hooks&&"set"in hooks&&void 0!==(ret=hooks.set(elem,value,name))?ret:(elem.setAttribute(name,value+""),value):hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:null==(ret=jQuery.find.attr(elem,name))?void 0:ret)},attrHooks:{type:{set:function(elem,value){if(!support.radioValue&&"radio"===value&&nodeName(elem,"input")){var val=elem.value;return elem.setAttribute("type",value),val&&(elem.value=val),value}}}},removeAttr:function(elem,value){var name,i=0,attrNames=value&&value.match(rnothtmlwhite);if(attrNames&&1===elem.nodeType)for(;name=attrNames[i++];)elem.removeAttribute(name)}}),boolHook={set:function(elem,value,name){return!1===value?jQuery.removeAttr(elem,name):elem.setAttribute(name,name),name}},jQuery.each(jQuery.expr.match.bool.source.match(/\w+/g),(function(_i,name){var getter=attrHandle[name]||jQuery.find.attr;attrHandle[name]=function(elem,name,isXML){var ret,handle,lowercaseName=name.toLowerCase();return isXML||(handle=attrHandle[lowercaseName],attrHandle[lowercaseName]=ret,ret=null!=getter(elem,name,isXML)?lowercaseName:null,attrHandle[lowercaseName]=handle),ret}}));var rfocusable=/^(?:input|select|textarea|button)$/i,rclickable=/^(?:a|area)$/i;function stripAndCollapse(value){return(value.match(rnothtmlwhite)||[]).join(" ")}function getClass(elem){return elem.getAttribute&&elem.getAttribute("class")||""}function classesToArray(value){return Array.isArray(value)?value:"string"==typeof value&&value.match(rnothtmlwhite)||[]}jQuery.fn.extend({prop:function(name,value){return access(this,jQuery.prop,name,value,arguments.length>1)},removeProp:function(name){return this.each((function(){delete this[jQuery.propFix[name]||name]}))}}),jQuery.extend({prop:function(elem,name,value){var ret,hooks,nType=elem.nodeType;if(3!==nType&&8!==nType&&2!==nType)return 1===nType&&jQuery.isXMLDoc(elem)||(name=jQuery.propFix[name]||name,hooks=jQuery.propHooks[name]),void 0!==value?hooks&&"set"in hooks&&void 0!==(ret=hooks.set(elem,value,name))?ret:elem[name]=value:hooks&&"get"in hooks&&null!==(ret=hooks.get(elem,name))?ret:elem[name]},propHooks:{tabIndex:{get:function(elem){var tabindex=jQuery.find.attr(elem,"tabindex");return tabindex?parseInt(tabindex,10):rfocusable.test(elem.nodeName)||rclickable.test(elem.nodeName)&&elem.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),support.optSelected||(jQuery.propHooks.selected={get:function(elem){var parent=elem.parentNode;return parent&&parent.parentNode&&parent.parentNode.selectedIndex,null},set:function(elem){var parent=elem.parentNode;parent&&(parent.selectedIndex,parent.parentNode&&parent.parentNode.selectedIndex)}}),jQuery.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],(function(){jQuery.propFix[this.toLowerCase()]=this})),jQuery.fn.extend({addClass:function(value){var classes,elem,cur,curValue,clazz,j,finalValue,i=0;if(isFunction(value))return this.each((function(j){jQuery(this).addClass(value.call(this,j,getClass(this)))}));if((classes=classesToArray(value)).length)for(;elem=this[i++];)if(curValue=getClass(elem),cur=1===elem.nodeType&&" "+stripAndCollapse(curValue)+" "){for(j=0;clazz=classes[j++];)cur.indexOf(" "+clazz+" ")<0&&(cur+=clazz+" ");curValue!==(finalValue=stripAndCollapse(cur))&&elem.setAttribute("class",finalValue)}return this},removeClass:function(value){var classes,elem,cur,curValue,clazz,j,finalValue,i=0;if(isFunction(value))return this.each((function(j){jQuery(this).removeClass(value.call(this,j,getClass(this)))}));if(!arguments.length)return this.attr("class","");if((classes=classesToArray(value)).length)for(;elem=this[i++];)if(curValue=getClass(elem),cur=1===elem.nodeType&&" "+stripAndCollapse(curValue)+" "){for(j=0;clazz=classes[j++];)for(;cur.indexOf(" "+clazz+" ")>-1;)cur=cur.replace(" "+clazz+" "," ");curValue!==(finalValue=stripAndCollapse(cur))&&elem.setAttribute("class",finalValue)}return this},toggleClass:function(value,stateVal){var type=typeof value,isValidValue="string"===type||Array.isArray(value);return"boolean"==typeof stateVal&&isValidValue?stateVal?this.addClass(value):this.removeClass(value):isFunction(value)?this.each((function(i){jQuery(this).toggleClass(value.call(this,i,getClass(this),stateVal),stateVal)})):this.each((function(){var className,i,self,classNames;if(isValidValue)for(i=0,self=jQuery(this),classNames=classesToArray(value);className=classNames[i++];)self.hasClass(className)?self.removeClass(className):self.addClass(className);else void 0!==value&&"boolean"!==type||((className=getClass(this))&&dataPriv.set(this,"__className__",className),this.setAttribute&&this.setAttribute("class",className||!1===value?"":dataPriv.get(this,"__className__")||""))}))},hasClass:function(selector){var className,elem,i=0;for(className=" "+selector+" ";elem=this[i++];)if(1===elem.nodeType&&(" "+stripAndCollapse(getClass(elem))+" ").indexOf(className)>-1)return!0;return!1}});var rreturn=/\r/g;jQuery.fn.extend({val:function(value){var hooks,ret,valueIsFunction,elem=this[0];return arguments.length?(valueIsFunction=isFunction(value),this.each((function(i){var val;1===this.nodeType&&(null==(val=valueIsFunction?value.call(this,i,jQuery(this).val()):value)?val="":"number"==typeof val?val+="":Array.isArray(val)&&(val=jQuery.map(val,(function(value){return null==value?"":value+""}))),(hooks=jQuery.valHooks[this.type]||jQuery.valHooks[this.nodeName.toLowerCase()])&&"set"in hooks&&void 0!==hooks.set(this,val,"value")||(this.value=val))}))):elem?(hooks=jQuery.valHooks[elem.type]||jQuery.valHooks[elem.nodeName.toLowerCase()])&&"get"in hooks&&void 0!==(ret=hooks.get(elem,"value"))?ret:"string"==typeof(ret=elem.value)?ret.replace(rreturn,""):null==ret?"":ret:void 0}}),jQuery.extend({valHooks:{option:{get:function(elem){var val=jQuery.find.attr(elem,"value");return null!=val?val:stripAndCollapse(jQuery.text(elem))}},select:{get:function(elem){var value,option,i,options=elem.options,index=elem.selectedIndex,one="select-one"===elem.type,values=one?null:[],max=one?index+1:options.length;for(i=index<0?max:one?index:0;i<max;i++)if(((option=options[i]).selected||i===index)&&!option.disabled&&(!option.parentNode.disabled||!nodeName(option.parentNode,"optgroup"))){if(value=jQuery(option).val(),one)return value;values.push(value)}return values},set:function(elem,value){for(var optionSet,option,options=elem.options,values=jQuery.makeArray(value),i=options.length;i--;)((option=options[i]).selected=jQuery.inArray(jQuery.valHooks.option.get(option),values)>-1)&&(optionSet=!0);return optionSet||(elem.selectedIndex=-1),values}}}}),jQuery.each(["radio","checkbox"],(function(){jQuery.valHooks[this]={set:function(elem,value){if(Array.isArray(value))return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>-1}},support.checkOn||(jQuery.valHooks[this].get=function(elem){return null===elem.getAttribute("value")?"on":elem.value})})),support.focusin="onfocusin"in window;var rfocusMorph=/^(?:focusinfocus|focusoutblur)$/,stopPropagationCallback=function(e){e.stopPropagation()};jQuery.extend(jQuery.event,{trigger:function(event,data,elem,onlyHandlers){var i,cur,tmp,bubbleType,ontype,handle,special,lastElement,eventPath=[elem||document],type=hasOwn.call(event,"type")?event.type:event,namespaces=hasOwn.call(event,"namespace")?event.namespace.split("."):[];if(cur=lastElement=tmp=elem=elem||document,3!==elem.nodeType&&8!==elem.nodeType&&!rfocusMorph.test(type+jQuery.event.triggered)&&(type.indexOf(".")>-1&&(namespaces=type.split("."),type=namespaces.shift(),namespaces.sort()),ontype=type.indexOf(":")<0&&"on"+type,(event=event[jQuery.expando]?event:new jQuery.Event(type,"object"==typeof event&&event)).isTrigger=onlyHandlers?2:3,event.namespace=namespaces.join("."),event.rnamespace=event.namespace?new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,event.result=void 0,event.target||(event.target=elem),data=null==data?[event]:jQuery.makeArray(data,[event]),special=jQuery.event.special[type]||{},onlyHandlers||!special.trigger||!1!==special.trigger.apply(elem,data))){if(!onlyHandlers&&!special.noBubble&&!isWindow(elem)){for(bubbleType=special.delegateType||type,rfocusMorph.test(bubbleType+type)||(cur=cur.parentNode);cur;cur=cur.parentNode)eventPath.push(cur),tmp=cur;tmp===(elem.ownerDocument||document)&&eventPath.push(tmp.defaultView||tmp.parentWindow||window)}for(i=0;(cur=eventPath[i++])&&!event.isPropagationStopped();)lastElement=cur,event.type=i>1?bubbleType:special.bindType||type,(handle=(dataPriv.get(cur,"events")||Object.create(null))[event.type]&&dataPriv.get(cur,"handle"))&&handle.apply(cur,data),(handle=ontype&&cur[ontype])&&handle.apply&&acceptData(cur)&&(event.result=handle.apply(cur,data),!1===event.result&&event.preventDefault());return event.type=type,onlyHandlers||event.isDefaultPrevented()||special._default&&!1!==special._default.apply(eventPath.pop(),data)||!acceptData(elem)||ontype&&isFunction(elem[type])&&!isWindow(elem)&&((tmp=elem[ontype])&&(elem[ontype]=null),jQuery.event.triggered=type,event.isPropagationStopped()&&lastElement.addEventListener(type,stopPropagationCallback),elem[type](),event.isPropagationStopped()&&lastElement.removeEventListener(type,stopPropagationCallback),jQuery.event.triggered=void 0,tmp&&(elem[ontype]=tmp)),event.result}},simulate:function(type,elem,event){var e=jQuery.extend(new jQuery.Event,event,{type:type,isSimulated:!0});jQuery.event.trigger(e,null,elem)}}),jQuery.fn.extend({trigger:function(type,data){return this.each((function(){jQuery.event.trigger(type,data,this)}))},triggerHandler:function(type,data){var elem=this[0];if(elem)return jQuery.event.trigger(type,data,elem,!0)}}),support.focusin||jQuery.each({focus:"focusin",blur:"focusout"},(function(orig,fix){var handler=function(event){jQuery.event.simulate(fix,event.target,jQuery.event.fix(event))};jQuery.event.special[fix]={setup:function(){var doc=this.ownerDocument||this.document||this,attaches=dataPriv.access(doc,fix);attaches||doc.addEventListener(orig,handler,!0),dataPriv.access(doc,fix,(attaches||0)+1)},teardown:function(){var doc=this.ownerDocument||this.document||this,attaches=dataPriv.access(doc,fix)-1;attaches?dataPriv.access(doc,fix,attaches):(doc.removeEventListener(orig,handler,!0),dataPriv.remove(doc,fix))}}}));var location=window.location,nonce={guid:Date.now()},rquery=/\?/;jQuery.parseXML=function(data){var xml,parserErrorElem;if(!data||"string"!=typeof data)return null;try{xml=(new window.DOMParser).parseFromString(data,"text/xml")}catch(e){}return parserErrorElem=xml&&xml.getElementsByTagName("parsererror")[0],xml&&!parserErrorElem||jQuery.error("Invalid XML: "+(parserErrorElem?jQuery.map(parserErrorElem.childNodes,(function(el){return el.textContent})).join("\n"):data)),xml};var rbracket=/\[\]$/,rCRLF=/\r?\n/g,rsubmitterTypes=/^(?:submit|button|image|reset|file)$/i,rsubmittable=/^(?:input|select|textarea|keygen)/i;function buildParams(prefix,obj,traditional,add){var name;if(Array.isArray(obj))jQuery.each(obj,(function(i,v){traditional||rbracket.test(prefix)?add(prefix,v):buildParams(prefix+"["+("object"==typeof v&&null!=v?i:"")+"]",v,traditional,add)}));else if(traditional||"object"!==toType(obj))add(prefix,obj);else for(name in obj)buildParams(prefix+"["+name+"]",obj[name],traditional,add)}jQuery.param=function(a,traditional){var prefix,s=[],add=function(key,valueOrFunction){var value=isFunction(valueOrFunction)?valueOrFunction():valueOrFunction;s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(null==value?"":value)};if(null==a)return"";if(Array.isArray(a)||a.jquery&&!jQuery.isPlainObject(a))jQuery.each(a,(function(){add(this.name,this.value)}));else for(prefix in a)buildParams(prefix,a[prefix],traditional,add);return s.join("&")},jQuery.fn.extend({serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map((function(){var elements=jQuery.prop(this,"elements");return elements?jQuery.makeArray(elements):this})).filter((function(){var type=this.type;return this.name&&!jQuery(this).is(":disabled")&&rsubmittable.test(this.nodeName)&&!rsubmitterTypes.test(type)&&(this.checked||!rcheckableType.test(type))})).map((function(_i,elem){var val=jQuery(this).val();return null==val?null:Array.isArray(val)?jQuery.map(val,(function(val){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}})):{name:elem.name,value:val.replace(rCRLF,"\r\n")}})).get()}});var r20=/%20/g,rhash=/#.*$/,rantiCache=/([?&])_=[^&]*/,rheaders=/^(.*?):[ \t]*([^\r\n]*)$/gm,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,prefilters={},transports={},allTypes="*/".concat("*"),originAnchor=document.createElement("a");function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){"string"!=typeof dataTypeExpression&&(func=dataTypeExpression,dataTypeExpression="*");var dataType,i=0,dataTypes=dataTypeExpression.toLowerCase().match(rnothtmlwhite)||[];if(isFunction(func))for(;dataType=dataTypes[i++];)"+"===dataType[0]?(dataType=dataType.slice(1)||"*",(structure[dataType]=structure[dataType]||[]).unshift(func)):(structure[dataType]=structure[dataType]||[]).push(func)}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR){var inspected={},seekingTransport=structure===transports;function inspect(dataType){var selected;return inspected[dataType]=!0,jQuery.each(structure[dataType]||[],(function(_,prefilterOrFactory){var dataTypeOrTransport=prefilterOrFactory(options,originalOptions,jqXHR);return"string"!=typeof dataTypeOrTransport||seekingTransport||inspected[dataTypeOrTransport]?seekingTransport?!(selected=dataTypeOrTransport):void 0:(options.dataTypes.unshift(dataTypeOrTransport),inspect(dataTypeOrTransport),!1)})),selected}return inspect(options.dataTypes[0])||!inspected["*"]&&inspect("*")}function ajaxExtend(target,src){var key,deep,flatOptions=jQuery.ajaxSettings.flatOptions||{};for(key in src)void 0!==src[key]&&((flatOptions[key]?target:deep||(deep={}))[key]=src[key]);return deep&&jQuery.extend(!0,target,deep),target}originAnchor.href=location.href,jQuery.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:location.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(location.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":allTypes,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":jQuery.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(target,settings){return settings?ajaxExtend(ajaxExtend(target,jQuery.ajaxSettings),settings):ajaxExtend(jQuery.ajaxSettings,target)},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){"object"==typeof url&&(options=url,url=void 0),options=options||{};var transport,cacheURL,responseHeadersString,responseHeaders,timeoutTimer,urlAnchor,completed,fireGlobals,i,uncached,s=jQuery.ajaxSetup({},options),callbackContext=s.context||s,globalEventContext=s.context&&(callbackContext.nodeType||callbackContext.jquery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery.Callbacks("once memory"),statusCode=s.statusCode||{},requestHeaders={},requestHeadersNames={},strAbort="canceled",jqXHR={readyState:0,getResponseHeader:function(key){var match;if(completed){if(!responseHeaders)for(responseHeaders={};match=rheaders.exec(responseHeadersString);)responseHeaders[match[1].toLowerCase()+" "]=(responseHeaders[match[1].toLowerCase()+" "]||[]).concat(match[2]);match=responseHeaders[key.toLowerCase()+" "]}return null==match?null:match.join(", ")},getAllResponseHeaders:function(){return completed?responseHeadersString:null},setRequestHeader:function(name,value){return null==completed&&(name=requestHeadersNames[name.toLowerCase()]=requestHeadersNames[name.toLowerCase()]||name,requestHeaders[name]=value),this},overrideMimeType:function(type){return null==completed&&(s.mimeType=type),this},statusCode:function(map){var code;if(map)if(completed)jqXHR.always(map[jqXHR.status]);else for(code in map)statusCode[code]=[statusCode[code],map[code]];return this},abort:function(statusText){var finalText=statusText||strAbort;return transport&&transport.abort(finalText),done(0,finalText),this}};if(deferred.promise(jqXHR),s.url=((url||s.url||location.href)+"").replace(rprotocol,location.protocol+"//"),s.type=options.method||options.type||s.method||s.type,s.dataTypes=(s.dataType||"*").toLowerCase().match(rnothtmlwhite)||[""],null==s.crossDomain){urlAnchor=document.createElement("a");try{urlAnchor.href=s.url,urlAnchor.href=urlAnchor.href,s.crossDomain=originAnchor.protocol+"//"+originAnchor.host!=urlAnchor.protocol+"//"+urlAnchor.host}catch(e){s.crossDomain=!0}}if(s.data&&s.processData&&"string"!=typeof s.data&&(s.data=jQuery.param(s.data,s.traditional)),inspectPrefiltersOrTransports(prefilters,s,options,jqXHR),completed)return jqXHR;for(i in(fireGlobals=jQuery.event&&s.global)&&0==jQuery.active++&&jQuery.event.trigger("ajaxStart"),s.type=s.type.toUpperCase(),s.hasContent=!rnoContent.test(s.type),cacheURL=s.url.replace(rhash,""),s.hasContent?s.data&&s.processData&&0===(s.contentType||"").indexOf("application/x-www-form-urlencoded")&&(s.data=s.data.replace(r20,"+")):(uncached=s.url.slice(cacheURL.length),s.data&&(s.processData||"string"==typeof s.data)&&(cacheURL+=(rquery.test(cacheURL)?"&":"?")+s.data,delete s.data),!1===s.cache&&(cacheURL=cacheURL.replace(rantiCache,"$1"),uncached=(rquery.test(cacheURL)?"&":"?")+"_="+nonce.guid+++uncached),s.url=cacheURL+uncached),s.ifModified&&(jQuery.lastModified[cacheURL]&&jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[cacheURL]),jQuery.etag[cacheURL]&&jqXHR.setRequestHeader("If-None-Match",jQuery.etag[cacheURL])),(s.data&&s.hasContent&&!1!==s.contentType||options.contentType)&&jqXHR.setRequestHeader("Content-Type",s.contentType),jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+("*"!==s.dataTypes[0]?", "+allTypes+"; q=0.01":""):s.accepts["*"]),s.headers)jqXHR.setRequestHeader(i,s.headers[i]);if(s.beforeSend&&(!1===s.beforeSend.call(callbackContext,jqXHR,s)||completed))return jqXHR.abort();if(strAbort="abort",completeDeferred.add(s.complete),jqXHR.done(s.success),jqXHR.fail(s.error),transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR)){if(jqXHR.readyState=1,fireGlobals&&globalEventContext.trigger("ajaxSend",[jqXHR,s]),completed)return jqXHR;s.async&&s.timeout>0&&(timeoutTimer=window.setTimeout((function(){jqXHR.abort("timeout")}),s.timeout));try{completed=!1,transport.send(requestHeaders,done)}catch(e){if(completed)throw e;done(-1,e)}}else done(-1,"No Transport");function done(status,nativeStatusText,responses,headers){var isSuccess,success,error,response,modified,statusText=nativeStatusText;completed||(completed=!0,timeoutTimer&&window.clearTimeout(timeoutTimer),transport=void 0,responseHeadersString=headers||"",jqXHR.readyState=status>0?4:0,isSuccess=status>=200&&status<300||304===status,responses&&(response=function(s,jqXHR,responses){for(var ct,type,finalDataType,firstDataType,contents=s.contents,dataTypes=s.dataTypes;"*"===dataTypes[0];)dataTypes.shift(),void 0===ct&&(ct=s.mimeType||jqXHR.getResponseHeader("Content-Type"));if(ct)for(type in contents)if(contents[type]&&contents[type].test(ct)){dataTypes.unshift(type);break}if(dataTypes[0]in responses)finalDataType=dataTypes[0];else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}firstDataType||(firstDataType=type)}finalDataType=finalDataType||firstDataType}if(finalDataType)return finalDataType!==dataTypes[0]&&dataTypes.unshift(finalDataType),responses[finalDataType]}(s,jqXHR,responses)),!isSuccess&&jQuery.inArray("script",s.dataTypes)>-1&&jQuery.inArray("json",s.dataTypes)<0&&(s.converters["text script"]=function(){}),response=function(s,response,jqXHR,isSuccess){var conv2,current,conv,tmp,prev,converters={},dataTypes=s.dataTypes.slice();if(dataTypes[1])for(conv in s.converters)converters[conv.toLowerCase()]=s.converters[conv];for(current=dataTypes.shift();current;)if(s.responseFields[current]&&(jqXHR[s.responseFields[current]]=response),!prev&&isSuccess&&s.dataFilter&&(response=s.dataFilter(response,s.dataType)),prev=current,current=dataTypes.shift())if("*"===current)current=prev;else if("*"!==prev&&prev!==current){if(!(conv=converters[prev+" "+current]||converters["* "+current]))for(conv2 in converters)if((tmp=conv2.split(" "))[1]===current&&(conv=converters[prev+" "+tmp[0]]||converters["* "+tmp[0]])){!0===conv?conv=converters[conv2]:!0!==converters[conv2]&&(current=tmp[0],dataTypes.unshift(tmp[1]));break}if(!0!==conv)if(conv&&s.throws)response=conv(response);else try{response=conv(response)}catch(e){return{state:"parsererror",error:conv?e:"No conversion from "+prev+" to "+current}}}return{state:"success",data:response}}(s,response,jqXHR,isSuccess),isSuccess?(s.ifModified&&((modified=jqXHR.getResponseHeader("Last-Modified"))&&(jQuery.lastModified[cacheURL]=modified),(modified=jqXHR.getResponseHeader("etag"))&&(jQuery.etag[cacheURL]=modified)),204===status||"HEAD"===s.type?statusText="nocontent":304===status?statusText="notmodified":(statusText=response.state,success=response.data,isSuccess=!(error=response.error))):(error=statusText,!status&&statusText||(statusText="error",status<0&&(status=0))),jqXHR.status=status,jqXHR.statusText=(nativeStatusText||statusText)+"",isSuccess?deferred.resolveWith(callbackContext,[success,statusText,jqXHR]):deferred.rejectWith(callbackContext,[jqXHR,statusText,error]),jqXHR.statusCode(statusCode),statusCode=void 0,fireGlobals&&globalEventContext.trigger(isSuccess?"ajaxSuccess":"ajaxError",[jqXHR,s,isSuccess?success:error]),completeDeferred.fireWith(callbackContext,[jqXHR,statusText]),fireGlobals&&(globalEventContext.trigger("ajaxComplete",[jqXHR,s]),--jQuery.active||jQuery.event.trigger("ajaxStop")))}return jqXHR},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},getScript:function(url,callback){return jQuery.get(url,void 0,callback,"script")}}),jQuery.each(["get","post"],(function(_i,method){jQuery[method]=function(url,data,callback,type){return isFunction(data)&&(type=type||callback,callback=data,data=void 0),jQuery.ajax(jQuery.extend({url:url,type:method,dataType:type,data:data,success:callback},jQuery.isPlainObject(url)&&url))}})),jQuery.ajaxPrefilter((function(s){var i;for(i in s.headers)"content-type"===i.toLowerCase()&&(s.contentType=s.headers[i]||"")})),jQuery._evalUrl=function(url,options,doc){return jQuery.ajax({url:url,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(response){jQuery.globalEval(response,options,doc)}})},jQuery.fn.extend({wrapAll:function(html){var wrap;return this[0]&&(isFunction(html)&&(html=html.call(this[0])),wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&wrap.insertBefore(this[0]),wrap.map((function(){for(var elem=this;elem.firstElementChild;)elem=elem.firstElementChild;return elem})).append(this)),this},wrapInner:function(html){return isFunction(html)?this.each((function(i){jQuery(this).wrapInner(html.call(this,i))})):this.each((function(){var self=jQuery(this),contents=self.contents();contents.length?contents.wrapAll(html):self.append(html)}))},wrap:function(html){var htmlIsFunction=isFunction(html);return this.each((function(i){jQuery(this).wrapAll(htmlIsFunction?html.call(this,i):html)}))},unwrap:function(selector){return this.parent(selector).not("body").each((function(){jQuery(this).replaceWith(this.childNodes)})),this}}),jQuery.expr.pseudos.hidden=function(elem){return!jQuery.expr.pseudos.visible(elem)},jQuery.expr.pseudos.visible=function(elem){return!!(elem.offsetWidth||elem.offsetHeight||elem.getClientRects().length)},jQuery.ajaxSettings.xhr=function(){try{return new window.XMLHttpRequest}catch(e){}};var xhrSuccessStatus={0:200,1223:204},xhrSupported=jQuery.ajaxSettings.xhr();support.cors=!!xhrSupported&&"withCredentials"in xhrSupported,support.ajax=xhrSupported=!!xhrSupported,jQuery.ajaxTransport((function(options){var callback,errorCallback;if(support.cors||xhrSupported&&!options.crossDomain)return{send:function(headers,complete){var i,xhr=options.xhr();if(xhr.open(options.type,options.url,options.async,options.username,options.password),options.xhrFields)for(i in options.xhrFields)xhr[i]=options.xhrFields[i];for(i in options.mimeType&&xhr.overrideMimeType&&xhr.overrideMimeType(options.mimeType),options.crossDomain||headers["X-Requested-With"]||(headers["X-Requested-With"]="XMLHttpRequest"),headers)xhr.setRequestHeader(i,headers[i]);callback=function(type){return function(){callback&&(callback=errorCallback=xhr.onload=xhr.onerror=xhr.onabort=xhr.ontimeout=xhr.onreadystatechange=null,"abort"===type?xhr.abort():"error"===type?"number"!=typeof xhr.status?complete(0,"error"):complete(xhr.status,xhr.statusText):complete(xhrSuccessStatus[xhr.status]||xhr.status,xhr.statusText,"text"!==(xhr.responseType||"text")||"string"!=typeof xhr.responseText?{binary:xhr.response}:{text:xhr.responseText},xhr.getAllResponseHeaders()))}},xhr.onload=callback(),errorCallback=xhr.onerror=xhr.ontimeout=callback("error"),void 0!==xhr.onabort?xhr.onabort=errorCallback:xhr.onreadystatechange=function(){4===xhr.readyState&&window.setTimeout((function(){callback&&errorCallback()}))},callback=callback("abort");try{xhr.send(options.hasContent&&options.data||null)}catch(e){if(callback)throw e}},abort:function(){callback&&callback()}}})),jQuery.ajaxPrefilter((function(s){s.crossDomain&&(s.contents.script=!1)})),jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(text){return jQuery.globalEval(text),text}}}),jQuery.ajaxPrefilter("script",(function(s){void 0===s.cache&&(s.cache=!1),s.crossDomain&&(s.type="GET")})),jQuery.ajaxTransport("script",(function(s){var script,callback;if(s.crossDomain||s.scriptAttrs)return{send:function(_,complete){script=jQuery("<script>").attr(s.scriptAttrs||{}).prop({charset:s.scriptCharset,src:s.url}).on("load error",callback=function(evt){script.remove(),callback=null,evt&&complete("error"===evt.type?404:200,evt.type)}),document.head.appendChild(script[0])},abort:function(){callback&&callback()}}}));var body,oldCallbacks=[],rjsonp=/(=)\?(?=&|$)|\?\?/;jQuery.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var callback=oldCallbacks.pop()||jQuery.expando+"_"+nonce.guid++;return this[callback]=!0,callback}}),jQuery.ajaxPrefilter("json jsonp",(function(s,originalSettings,jqXHR){var callbackName,overwritten,responseContainer,jsonProp=!1!==s.jsonp&&(rjsonp.test(s.url)?"url":"string"==typeof s.data&&0===(s.contentType||"").indexOf("application/x-www-form-urlencoded")&&rjsonp.test(s.data)&&"data");if(jsonProp||"jsonp"===s.dataTypes[0])return callbackName=s.jsonpCallback=isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback,jsonProp?s[jsonProp]=s[jsonProp].replace(rjsonp,"$1"+callbackName):!1!==s.jsonp&&(s.url+=(rquery.test(s.url)?"&":"?")+s.jsonp+"="+callbackName),s.converters["script json"]=function(){return responseContainer||jQuery.error(callbackName+" was not called"),responseContainer[0]},s.dataTypes[0]="json",overwritten=window[callbackName],window[callbackName]=function(){responseContainer=arguments},jqXHR.always((function(){void 0===overwritten?jQuery(window).removeProp(callbackName):window[callbackName]=overwritten,s[callbackName]&&(s.jsonpCallback=originalSettings.jsonpCallback,oldCallbacks.push(callbackName)),responseContainer&&isFunction(overwritten)&&overwritten(responseContainer[0]),responseContainer=overwritten=void 0})),"script"})),support.createHTMLDocument=((body=document.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===body.childNodes.length),jQuery.parseHTML=function(data,context,keepScripts){return"string"!=typeof data?[]:("boolean"==typeof context&&(keepScripts=context,context=!1),context||(support.createHTMLDocument?((base=(context=document.implementation.createHTMLDocument("")).createElement("base")).href=document.location.href,context.head.appendChild(base)):context=document),scripts=!keepScripts&&[],(parsed=rsingleTag.exec(data))?[context.createElement(parsed[1])]:(parsed=buildFragment([data],context,scripts),scripts&&scripts.length&&jQuery(scripts).remove(),jQuery.merge([],parsed.childNodes)));var base,parsed,scripts},jQuery.fn.load=function(url,params,callback){var selector,type,response,self=this,off=url.indexOf(" ");return off>-1&&(selector=stripAndCollapse(url.slice(off)),url=url.slice(0,off)),isFunction(params)?(callback=params,params=void 0):params&&"object"==typeof params&&(type="POST"),self.length>0&&jQuery.ajax({url:url,type:type||"GET",dataType:"html",data:params}).done((function(responseText){response=arguments,self.html(selector?jQuery("<div>").append(jQuery.parseHTML(responseText)).find(selector):responseText)})).always(callback&&function(jqXHR,status){self.each((function(){callback.apply(this,response||[jqXHR.responseText,status,jqXHR])}))}),this},jQuery.expr.pseudos.animated=function(elem){return jQuery.grep(jQuery.timers,(function(fn){return elem===fn.elem})).length},jQuery.offset={setOffset:function(elem,options,i){var curPosition,curLeft,curCSSTop,curTop,curOffset,curCSSLeft,position=jQuery.css(elem,"position"),curElem=jQuery(elem),props={};"static"===position&&(elem.style.position="relative"),curOffset=curElem.offset(),curCSSTop=jQuery.css(elem,"top"),curCSSLeft=jQuery.css(elem,"left"),("absolute"===position||"fixed"===position)&&(curCSSTop+curCSSLeft).indexOf("auto")>-1?(curTop=(curPosition=curElem.position()).top,curLeft=curPosition.left):(curTop=parseFloat(curCSSTop)||0,curLeft=parseFloat(curCSSLeft)||0),isFunction(options)&&(options=options.call(elem,i,jQuery.extend({},curOffset))),null!=options.top&&(props.top=options.top-curOffset.top+curTop),null!=options.left&&(props.left=options.left-curOffset.left+curLeft),"using"in options?options.using.call(elem,props):curElem.css(props)}},jQuery.fn.extend({offset:function(options){if(arguments.length)return void 0===options?this:this.each((function(i){jQuery.offset.setOffset(this,options,i)}));var rect,win,elem=this[0];return elem?elem.getClientRects().length?(rect=elem.getBoundingClientRect(),win=elem.ownerDocument.defaultView,{top:rect.top+win.pageYOffset,left:rect.left+win.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var offsetParent,offset,doc,elem=this[0],parentOffset={top:0,left:0};if("fixed"===jQuery.css(elem,"position"))offset=elem.getBoundingClientRect();else{for(offset=this.offset(),doc=elem.ownerDocument,offsetParent=elem.offsetParent||doc.documentElement;offsetParent&&(offsetParent===doc.body||offsetParent===doc.documentElement)&&"static"===jQuery.css(offsetParent,"position");)offsetParent=offsetParent.parentNode;offsetParent&&offsetParent!==elem&&1===offsetParent.nodeType&&((parentOffset=jQuery(offsetParent).offset()).top+=jQuery.css(offsetParent,"borderTopWidth",!0),parentOffset.left+=jQuery.css(offsetParent,"borderLeftWidth",!0))}return{top:offset.top-parentOffset.top-jQuery.css(elem,"marginTop",!0),left:offset.left-parentOffset.left-jQuery.css(elem,"marginLeft",!0)}}},offsetParent:function(){return this.map((function(){for(var offsetParent=this.offsetParent;offsetParent&&"static"===jQuery.css(offsetParent,"position");)offsetParent=offsetParent.offsetParent;return offsetParent||documentElement}))}}),jQuery.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},(function(method,prop){var top="pageYOffset"===prop;jQuery.fn[method]=function(val){return access(this,(function(elem,method,val){var win;if(isWindow(elem)?win=elem:9===elem.nodeType&&(win=elem.defaultView),void 0===val)return win?win[prop]:elem[method];win?win.scrollTo(top?win.pageXOffset:val,top?val:win.pageYOffset):elem[method]=val}),method,val,arguments.length)}})),jQuery.each(["top","left"],(function(_i,prop){jQuery.cssHooks[prop]=addGetHookIf(support.pixelPosition,(function(elem,computed){if(computed)return computed=curCSS(elem,prop),rnumnonpx.test(computed)?jQuery(elem).position()[prop]+"px":computed}))})),jQuery.each({Height:"height",Width:"width"},(function(name,type){jQuery.each({padding:"inner"+name,content:type,"":"outer"+name},(function(defaultExtra,funcName){jQuery.fn[funcName]=function(margin,value){var chainable=arguments.length&&(defaultExtra||"boolean"!=typeof margin),extra=defaultExtra||(!0===margin||!0===value?"margin":"border");return access(this,(function(elem,type,value){var doc;return isWindow(elem)?0===funcName.indexOf("outer")?elem["inner"+name]:elem.document.documentElement["client"+name]:9===elem.nodeType?(doc=elem.documentElement,Math.max(elem.body["scroll"+name],doc["scroll"+name],elem.body["offset"+name],doc["offset"+name],doc["client"+name])):void 0===value?jQuery.css(elem,type,extra):jQuery.style(elem,type,value,extra)}),type,chainable?margin:void 0,chainable)}}))})),jQuery.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],(function(_i,type){jQuery.fn[type]=function(fn){return this.on(type,fn)}})),jQuery.fn.extend({bind:function(types,data,fn){return this.on(types,null,data,fn)},unbind:function(types,fn){return this.off(types,null,fn)},delegate:function(selector,types,data,fn){return this.on(types,selector,data,fn)},undelegate:function(selector,types,fn){return 1===arguments.length?this.off(selector,"**"):this.off(types,selector||"**",fn)},hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)}}),jQuery.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),(function(_i,name){jQuery.fn[name]=function(data,fn){return arguments.length>0?this.on(name,null,data,fn):this.trigger(name)}}));var rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;jQuery.proxy=function(fn,context){var tmp,args,proxy;if("string"==typeof context&&(tmp=fn[context],context=fn,fn=tmp),isFunction(fn))return args=slice.call(arguments,2),(proxy=function(){return fn.apply(context||this,args.concat(slice.call(arguments)))}).guid=fn.guid=fn.guid||jQuery.guid++,proxy},jQuery.holdReady=function(hold){hold?jQuery.readyWait++:jQuery.ready(!0)},jQuery.isArray=Array.isArray,jQuery.parseJSON=JSON.parse,jQuery.nodeName=nodeName,jQuery.isFunction=isFunction,jQuery.isWindow=isWindow,jQuery.camelCase=camelCase,jQuery.type=toType,jQuery.now=Date.now,jQuery.isNumeric=function(obj){var type=jQuery.type(obj);return("number"===type||"string"===type)&&!isNaN(obj-parseFloat(obj))},jQuery.trim=function(text){return null==text?"":(text+"").replace(rtrim,"")},void 0===(__WEBPACK_AMD_DEFINE_RESULT__=function(){return jQuery}.apply(exports,[]))||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__);var _jQuery=window.jQuery,_$=window.$;return jQuery.noConflict=function(deep){return window.$===jQuery&&(window.$=_$),deep&&window.jQuery===jQuery&&(window.jQuery=_jQuery),jQuery},void 0===noGlobal&&(window.jQuery=window.$=jQuery),jQuery}))},function(module,exports){angular.module("rainbow").factory("ConferenceParticipant",[function(){"use strict";function ConferenceParticipant(participantId,userId,jid_im,jid_tel,role,mute,held,confStartDate,startDate,phoneNumber,state,delegateCapability){this.participantId=participantId,this.userId=userId,this.jid_im=jid_im,this.jid_tel=jid_tel,this.role=role,this.mute=mute,this.held=held,this.confStartDate=confStartDate,this.startDate=startDate,this.phoneNumber=phoneNumber,this.state=state,this.delegateCapability=delegateCapability,this.updateFromData=function(data){data.participantId&&(this.participantId=data.participantId),data.userId&&(this.userId=data.userId),this.jid_im=data.jid_im,data.jid_tel&&(this.jid_tel=data.jid_tel),this.role=data.participantRole?data.participantRole:this.role,this.confStartDate=data.confStartDate?data.confStartDate:this.confStartDate,this.startDate=data.startDate?data.startDate:this.startDate,this.phoneNumber=data.phoneNumber?data.phoneNumber:this.phoneNumber,this.state=data.participantState?data.participantState:this.state,this.mute=data.mute,this.held=data.held,this.delegateCapability=data.delegateCapability}}return ConferenceParticipant.createFromData=function(data){return new ConferenceParticipant(data.participantId,data.userId,data.jid_im,data.jid_tel,data.participantRole,data.mute,data.held,data.confStartDate,data.startDate,data.phoneNumber,data.participantState,data.delegateCapability)},ConferenceParticipant}])},function(module,exports){class DirectoryContact{constructor(companyId,id,firstName,lastName,eMail,jobTitle,department,companyName,street,city,state,postalCode,country,workPhoneNumbers,mobilePhoneNumbers,otherPhoneNumbers,custom1,custom2,tags){companyId&&(this.companyId=companyId),id&&(this.id=id),firstName&&(this.firstName=firstName),lastName&&(this.lastName=lastName),eMail&&(this.eMail=eMail),jobTitle&&(this.jobTitle=jobTitle),department&&(this.department=department),companyName&&(this.companyName=companyName),street&&(this.street=street),city&&(this.city=city),state&&(this.state=state),postalCode&&(this.postalCode=postalCode),country&&(this.country=country),workPhoneNumbers&&(this.workPhoneNumbers=workPhoneNumbers),mobilePhoneNumbers&&(this.mobilePhoneNumbers=mobilePhoneNumbers),otherPhoneNumbers&&(this.otherPhoneNumbers=otherPhoneNumbers),custom1&&(this.custom1=custom1),custom2&&(this.custom2=custom2),tags&&(this.tags=tags)}static directoryContactFactory(){return(data={})=>new DirectoryContact(data.companyId,data.id,data.firstName,data.lastName,data.eMail,data.jobTitle,data.department,data.companyName,data.street,data.city,data.state,data.postalCode,data.country,data.workPhoneNumbers,data.mobilePhoneNumbers,data.otherPhoneNumbers,data.custom1,data.custom2,data.tags)}}angular.module("rainbow").factory("directoryContact",DirectoryContact.directoryContactFactory)},function(module,exports){angular.module("rainbowAdmin").factory("Offer",[function(){"use strict";function Offer(id,name,description,groupName,offerReference,profileId,canBeSold,businessModel,isDefault,isExclusive,isPrepaid,prepaidDuration,autoSubscribe,hasConference,hasVoice,isDemo,isBundle,isChinaOffer){this.id=id,this.name=name||"",isDemo&&(this.name=this.name.replace(new RegExp("\\bDemo\\b")," Custom")),this.description=description||"Rainbow "+this.name,this.groupName=hasConference?"Conference":groupName||name,this.offerReference=offerReference,this.profileId=profileId,this.canBeSold=canBeSold||!1,this.businessModel=businessModel,this.isDefault=isDefault,this.isExclusive=isExclusive,this.isPrepaid=isPrepaid,this.prepaidDuration=prepaidDuration,this.autoSubscribe=autoSubscribe,this.hasConference=hasConference,this.hasVoice=hasVoice,this.isDemo=void 0===isDemo?!this.isDefault&&!this.canBeSold&&this.name.toLowerCase().includes("custom"):isDemo,this.isBundle=isBundle,this.isChinaOffer=isChinaOffer,this.disallowUnsubscribeWithAllocatedLicences=this.hasVoice||"Room"===this.groupName,this.disallowAllocationToUsers="Room"===this.groupName,this.hasVoice?this.logo="logo-offer-voice.svg":this.hasConference?this.logo="logo-offer-conference.svg":this.logo=Offer.getLogoByName(this.name),this.isEnterprise=function(){return this.groupName.toLowerCase().includes("enterprise")},this.isBusiness=function(){return this.groupName.toLowerCase().includes("business")},this.isEssential=function(){return this.isDefault},this.isTrial=function(){return this.isDemo},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel},this.isDeviceLicense=function(deviceType){return"TV"===deviceType&&"Room"===this.groupName},this.isFixedLicense=function(){return"flat_fee"===this.businessModel},this.isUserBasedLicense=function(){return"nb_users"===this.businessModel},this.isUsageBasedLicense=function(){return"usage"===this.businessModel}}return Offer.createFromData=function(data){return new Offer(data.id,data.name,data.description,data.groupName,data.offerReference,data.profileId,data.canBeSold,data.businessModel,data.isDefault,data.isExclusive,data.isPrepaid,data.prepaidDuration,data.autoSubscribe,data.hasConference,data.hasVoice,data.isDemo,data.isBundle,data.isChinaOffer)},Offer.createFromSubscriptionData=function(subscription){return new Offer(subscription.offerId,subscription.offerName,subscription.offerDescription,subscription.groupName,subscription.offerReference,subscription.profileId,subscription.canBeSold,subscription.businessModel,subscription.isDefault,subscription.isExclusive,subscription.isPrepaid,subscription.prepaidDuration,subscription.autoSubscribe,subscription.hasConference,subscription.hasVoice,subscription.isDemo,subscription.isBundle,subscription.isChinaOffer)},Offer.createFromSubscriptionCountersData=function(subscriptionCounters){return new Offer(subscriptionCounters.offerId,subscriptionCounters.offerName,void 0,subscriptionCounters.groupName,subscriptionCounters.offerReference,void 0,subscriptionCounters.canBeSold,subscriptionCounters.businessModel,subscriptionCounters.isDefault,subscriptionCounters.isExclusive,subscriptionCounters.isPrepaid,subscriptionCounters.prepaidDuration,void 0,subscriptionCounters.hasConference,subscriptionCounters.hasVoice,subscriptionCounters.isDemo,subscriptionCounters.isBundle)},Offer.createFromProfileData=function(profile){return new Offer(profile.offerId,profile.offerName,void 0,void 0,void 0,profile.profileId,!1,void 0,profile.isDefault,profile.isExclusive,profile.isPrepaid,profile.prepaidDuration,void 0,profile.hasConference,profile.hasVoice,profile.isDemo,profile.isBundle)},Offer.createFromOperationLog=function(operationLog){var data="delete"===operationLog.operationType?operationLog.previousData:operationLog.newData;return new Offer(data.offerId,data.offerName,data.offerDescription,void 0,data.offerReference,data.profileId,data.canBeSold,data.businessModel,data.isDefault,data.isExclusive,data.isPrepaid,data.prepaidDuration,void 0,data.hasConference,data.hasVoice,data.isDemo,data.isBundle)},Offer.getLogoByName=function(offerName){var logo="logo-offer-default.svg";if(offerName){var name=offerName.toLowerCase();-1!==name.indexOf("voice")?name="voice":-1!==name.indexOf("conference")?name="conference":-1!==name.indexOf("enterprise")?name="enterprise":-1!==name.indexOf("business")&&(name="business"),logo="logo-offer-"+name+".svg"}return logo},Offer.offerComparator=function(offer1,offer2){var offerOrder=["Essential","Business","Enterprise","Voice","Room","Conference"];if(offer1.isEssential())return-1;if(offer2.isEssential())return 1;if(offer1.isTrial()&&!offer2.isTrial())return-1;if(!offer1.isTrial()&&offer2.isTrial())return 1;if(offer1.canBeSold&&!offer2.canBeSold)return-1;if(!offer1.canBeSold&&offer2.canBeSold)return 1;if(offer1.hasConference&&!offer2.hasConference)return 1;if(!offer1.hasConference&&offer2.hasConference)return-1;var orderIndex1=offerOrder.findIndex((function(order){return offer1.name.startsWith(order)})),orderIndex2=offerOrder.findIndex((function(order){return offer2.name.startsWith(order)}));return(orderIndex1=-1===orderIndex1?offerOrder.length:orderIndex1)<(orderIndex2=-1===orderIndex2?offerOrder.length:orderIndex2)?-1:orderIndex1>orderIndex2?1:offer1.isTrial()?-1:offer2.isTrial()||offer1.isPrepaid&&!offer2.isPrepaid?1:!offer1.isPrepaid&&offer2.isPrepaid||offer1.name<offer2.name?-1:offer1.name>offer2.name?1:0},Offer.isExclusive=function(offer){return offer.isDefault||offer.isExclusive},Offer.isOptional=function(offer){return!Offer.isExclusive(offer)},Offer.isEssential=function(offer){return offer.isDefault},Offer.isNotEssential=function(offer){return!offer.isDefault},Offer.isModelByNbUsers=function(offer){return"nb_users"===offer.businessModel},Offer.isPrepaid=function(offer){return offer.isPrepaid},Offer.isNotPrepaid=function(offer){return!offer.isPrepaid},Offer.isUserLicense=function(offer){return offer.isUserLicense()},Offer.isUsageBasedLicense=function(offer){return offer.isUsageBasedLicense()},Offer}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const rxjs_1=__webpack_require__(10),message_1=__webpack_require__(16),call_model_1=__webpack_require__(0),uuid4=__webpack_require__(27),contact_service_1=__webpack_require__(1);angular.module("rainbow").factory("Conversation",["$log","$rootScope",function($log,$rootScope){function Conversation(conversationId){this.id=conversationId,this.dbId=null,this.type=null,this.owner=null,this.contact=null,this.room=null,this.capabilities=null,this.avatar=null,this.presenceStatus=null,this.name=function(){return{}},this.filterName="",this.missedCounter=0,this.missedCalls=0,this.messages=[],this.participantStatuses={},this.draft="",this.status=Conversation.Status.ACTIVE,this.historyIndex=-1,this.historyMessages=[],this.historyDefered=null,this.historyComplete=!1,this.lastModification=void 0,this.creationDate=new Date,this.lastMessageText="",this.lastMessageSender="",this.forwardFrom=null,this.forwardedMessage=null,this.replaceLastMsgId="",this.pip=!0,this.showVideoGallery=!0,this.conversationCallViewMode="unfold_more",this.videoCall={status:call_model_1.Call.Status.UNKNOWN},this.audioCall=null,this.pstnConferenceSession=null,this.webConferenceSession=null,this.isMutedAudio=!1,this.isMutedVideo=!1,this.infoVisible=!1,this.largeInfoVisible=!0,this.muted=!1,this.isFavorite=!1,this.lastEditableMsg=null,this.cacheMessages=[],this.rxSubject=new rxjs_1.Subject,this.innerHtml="",this.mentionedMembersArray=[],this.telephonyContacts=null,this.isFullScreenNoChat=!1,this.getMessageById=(messId,searchInCache=!1)=>{if(searchInCache){const foundMsg=this.cacheMessages.find(item=>item.id===messId);if(foundMsg)return foundMsg}return this.messages.find(item=>item.id===messId)},this.getMessageInCacheById=messId=>this.cacheMessages.find(item=>item.id===messId),this.getReplacedMessageById=msgId=>{let message=null;return this.messages.forEach(msg=>{message=msg.replaceMsgs.find(replaceMsg=>replaceMsg.id===msgId)}),message},this.reset=()=>{this.messages=[],this.historyIndex=-1,this.historyMessages=[],this.historyComplete=!1,this.currentHistoryId=null,this.lastMessageText=null,this.rxSubject.next({name:"appendMessage"})},this.subscribe=callback=>this.rxSubject.subscribe(callback)}Conversation.ChatstatesNS="http://jabber.org/protocol/chatstates",Conversation.ReceiptNS="urn:xmpp:receipts",Conversation.contentNS="urn:xmpp:content",Conversation.AttentionNS="urn:xmpp:attention:0",Conversation.FORWARDNS="urn:xmpp:forward:0",Conversation.Type={ONE_TO_ONE:0,ROOM:1,BOT:2},Conversation.EventType={NEW:0,IM:1,CAPABILITIES:2,FILE:3},Conversation.Status={ACTIVE:{key:0,value:"active"},INACTIVE:{key:1,value:"inactive"},COMPOSING:{key:2,value:"composing"},PAUSED:{key:3,value:"paused"}},Conversation.createOneToOneConversation=function(participant){$log.info("[Conversation] Create one to one conversation ("+participant.id+")");const conversation=new Conversation(participant.id);return conversation.contact=participant,participant.conversation=conversation,participant.isBot?(conversation.avatar="",conversation.type=Conversation.Type.BOT,conversation.infoVisible=!0):(conversation.avatar=participant.avatar?participant.avatar.src:null,conversation.type=Conversation.Type.ONE_TO_ONE),conversation.name=participant.name,participant.displayName&&(conversation.filterName=participant.displayName.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"")),conversation},Conversation.createRoomConversation=function(room){$log.info("[Conversation] Create room conversation ("+room.jid+")");const conversation=new Conversation(room.jid);return conversation.type=Conversation.Type.ROOM,conversation.room=room,conversation.filterName=room.name.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,""),conversation.infoVisible=!0,conversation};const randomBase=uuid4();let messageId=0;return Conversation.getUniqueMessageId=()=>{const messageToSendID="web_"+randomBase+messageId;return messageId++,messageToSendID},Conversation.stringToStatus=function(status){switch(status){case"composing":return Conversation.Status.COMPOSING;case"paused":return Conversation.Status.PAUSED;default:return Conversation.Status.ACTIVE}},Conversation.prototype.setMissedCounter=function(missedCounter){this.missedCounter=missedCounter,this.rxSubject.next({name:"missedCounter",value:missedCounter})},Conversation.prototype.shortnameToUnicode=data=>emojione?emojione.shortnameToUnicode(data):data,Conversation.prototype.isInCall=function(){return this.pstnConferenceSession?this.pstnConferenceSession.isParticipantConnectedByJid(contact_service_1.default.userContact.jid):this.webConferenceSession?this.webConferenceSession.isParticipantConnectedByJid(contact_service_1.default.userContact.jid):this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value&&"incommingCall"!==this.audioCall.status.value&&"queued"!==this.audioCall.status.value},Conversation.prototype.isNotInCall=function(){return!(this.videoCall&&this.videoCall.status&&"Unknown"!==this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"Unknown"!==this.audioCall.status.value||"busy"===contact_service_1.default.userContact.status&&""!==contact_service_1.default.userContact.message)},Conversation.prototype.isActive=function(){return this.videoCall&&this.videoCall.status&&"active"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"active"===this.audioCall.status.value},Conversation.prototype.isHeld=function(){return this.videoCall&&this.videoCall.status&&"held"===this.videoCall.status.value||this.audioCall&&this.audioCall.status&&"held"===this.audioCall.status.value},Conversation.prototype.getMessageByIdInHistory=function(messId){return this.historyMessages.find(item=>item.id===messId)},Conversation.prototype.addAdminBubbleMessage=function(from,date,type,messageID){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add addAdminBubbleMessage message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add addAdminBubbleMessage from "+from.jid+" : "+type);const data=type+"MsgRoom",side=message_1.Message.Side.ADMIN,message=message_1.Message.create(messageID,date,from,side,data,!1);return message.setReceiptStatus(message_1.Message.ReceiptStatus.SENT),this.addMessage(message)},Conversation.prototype.addFSMessage=function(fileId,data,status,attachedInfos,geoLoc=null,urgency=null,attention=null){const messageToSendID=Conversation.getUniqueMessageId(),unicodeData=this.shortnameToUnicode(data),date=new Date;$log.info("[Conversation] "+this.id+" add FILE SHARING message from me");const message=message_1.Message.createFileSharingMessage(messageToSendID,date,contact_service_1.default.userContact,"R",unicodeData,status,fileId,null,attachedInfos,geoLoc,attention);return message.urgency=urgency,message.setReceiptStatus(message_1.Message.ReceiptStatus.IN_PROGRESS),this.addMessage(message)},Conversation.prototype.addChatMessage=function(from,date,data,messageID,isSender,isMarkdown,subject,answeredMsgId,answeredMsgDate,additionalContent,alternativeContent,attention,urgency){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add CHAT message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add CHAT message ("+messageID+") from "+from.jid);const side=contact_service_1.default.isUserContact(from)?"R":"L",message=message_1.Message.create(messageID,date,from,side,data,!1,isMarkdown,additionalContent,subject,answeredMsgId,answeredMsgDate,alternativeContent,attention);return message.urgency=urgency,isSender?message.setReceiptStatus(message_1.Message.ReceiptStatus.IN_PROGRESS):message.setReceiptStatus(message_1.Message.ReceiptStatus.SENT),this.addMessage(message)},Conversation.prototype.addForwardChatMessage=function(from,date,messageID,forwardedMessage,origConv){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add CHAT message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add CHAT message ("+messageID+") from "+from.jid);const side=contact_service_1.default.isUserContact(from)?"R":"L",message=message_1.Message.create(messageID,date,from,side,"",!1,!1);message.setReceiptStatus(message_1.Message.ReceiptStatus.IN_PROGRESS),message.forwardedMsg=forwardedMessage,message.forwardConvType=origConv.type===Conversation.Type.ONE_TO_ONE?"chat":"groupchat",message.isForwarded=!0;const msgFwdOtherConv=message_1.Message.createFromMsg(message.forwardedMsg);return msgFwdOtherConv.id=messageID,msgFwdOtherConv.side=side,msgFwdOtherConv.date=date,msgFwdOtherConv.from=from,msgFwdOtherConv.isForwarded=!0,this.addMessage(msgFwdOtherConv),message},Conversation.prototype.addRecordingMessage=function(from,date,data,messageID){const message=message_1.Message.createRecordingAdminMessage(messageID,date,from,"ADMIN",data);return this.addMessage(message)},Conversation.prototype.addFileMessage=function(from,date,data,messageID,urgency=null){$log.info("[Conversation] "+this.id+" add FILE message from "+from.jid+" : "+data);const side=contact_service_1.default.isUserContact(from)?"R":"L",message=message_1.Message.createFileMessage(messageID,date,from,side,data,!1);return message.urgency=urgency,this.addMessage(message)},Conversation.prototype.addFileSharingMessage=function(from,date,data,messageID,fileId,fileName,geoloc,urgency,isForwarded,attention=null){$log.info("[Conversation] "+this.id+" add FILE SHARING message from "+from.jid+" : "+data);const side=contact_service_1.default.isUserContact(from)?"R":"L",message=message_1.Message.createFileSharingMessage(messageID,date,from,side,data,!1,fileId,fileName,null,geoloc,attention);return message.urgency=urgency,message.isForwarded=isForwarded,this.addMessage(message)},Conversation.prototype.addWebRTCMessage=function(from,date,data,messageID){if(this.getMessageById(messageID))return $log.info("[Conversation] "+this.id+" add addWebRTCMessage message ("+messageID+") already exists."),null;$log.info("[Conversation] "+this.id+" add WebRTC message from "+from.jid+" : "+data);const side=contact_service_1.default.isUserContact(from)?message_1.Message.Side.RIGHT:message_1.Message.Side.LEFT,message=message_1.Message.createWebRTCMessage(messageID,date,from,side,data,!1);return this.addMessage(message)},Conversation.prototype.updateMessage=message=>{message.sendUpdateEvent()},Conversation.prototype.addMessage=function(message){if(this.messages.find(item=>item.id===message.id))return $log.info("[Conversation] "+this.id+" try to add an already stored message with id "+message.id),message;if(message.side===message_1.Message.Side.LEFT)message.type===message_1.Message.Type.WEBRTC&&(this.missedCalls+=1),this.setStatusMessage(message.from,Conversation.Status.ACTIVE);else{const oldEditableMsg=this.lastEditableMsg;this.lastEditableMsg=message,oldEditableMsg&&this.updateMessage(oldEditableMsg)}return this.messages.push(message),this.lastModification=new Date,this.lastMessageText=message.data,this.lastMessageSender=message.from.id,this.replaceLastMsgId=null,message.isForwarded?(this.forwardFrom=message.from.jid,this.forwardedMessage=message.data):(this.forwardFrom=null,this.forwardedMessage=null),this.rxSubject.next({name:"appendMessage",message:message}),$rootScope.$broadcast("ON_CONVERSATION_UPDATED_EVENT",this.id),message},Conversation.prototype.addMessageInHistoryMessages=function(message){if(message&&(this.historyMessages.push(message),message.side===message_1.Message.Side.RIGHT&&(!this.lastEditableMsg||message.date.getTime()>this.lastEditableMsg.date.getTime()))){const oldEditableMsg=this.lastEditableMsg;this.lastEditableMsg=message,oldEditableMsg&&this.updateMessage(oldEditableMsg)}},Conversation.prototype.addMessageInCacheMessages=function(message){if(!message)return;this.getMessageInCacheById(message.id)||(this.cacheMessages.push(message),this.rxSubject.next({name:"cachedMessage",message:message}))},Conversation.prototype.removeMessage=function(message){const index=this.messages.lastIndexOf(message);-1!==index&&this.messages.splice(index,1)},Conversation.prototype.setStatusMessage=function(from,status){$log.info("[Conversation] "+this.id+" add status message from "+from.jid+" : "+status.value),this.participantStatuses[from.jid]=status,this.rxSubject.next({name:"status",value:status})},Conversation.prototype.ackReadAllSentMessages=function(){this.messages.forEach(message=>{"R"!==message.side||message.receiptStatus!==message_1.Message.ReceiptStatus.SENT&&message.receiptStatus!==message_1.Message.ReceiptStatus.UNREAD||(message.setReceiptStatus(message_1.Message.ReceiptStatus.READ),this.updateMessage(message))})},Conversation.prototype.ackReadAllReceivedMessages=function(){let result=!1;return this.messages.forEach(message=>{"R"===message.side||message.receiptStatus!==message_1.Message.ReceiptStatus.SENT&&message.receiptStatus!==message_1.Message.ReceiptStatus.UNREAD||(message.setReceiptStatus(message_1.Message.ReceiptStatus.READ),this.updateMessage(message),result=!0)}),result},Conversation.prototype.updateAfterReplaceEvent=function(message){const lastMsg=this.messages[this.messages.length-1];lastMsg&&lastMsg.id===message.id&&(this.lastModification=new Date,this.lastMessageText=message.getLastTextModified(),this.lastMessageSender=message.from.id,this.replaceLastMsgId=lastMsg.id,this.rxSubject.next({name:"replaceMessage",message:message}))},Conversation}])},function(module,exports,__webpack_require__){var _nodeId,_clockseq,rng=__webpack_require__(223),bytesToUuid=__webpack_require__(224),_lastMSecs=0,_lastNSecs=0;module.exports=function(options,buf,offset){var i=buf&&offset||0,b=buf||[],node=(options=options||{}).node||_nodeId,clockseq=void 0!==options.clockseq?options.clockseq:_clockseq;if(null==node||null==clockseq){var seedBytes=rng();null==node&&(node=_nodeId=[1|seedBytes[0],seedBytes[1],seedBytes[2],seedBytes[3],seedBytes[4],seedBytes[5]]),null==clockseq&&(clockseq=_clockseq=16383&(seedBytes[6]<<8|seedBytes[7]))}var msecs=void 0!==options.msecs?options.msecs:(new Date).getTime(),nsecs=void 0!==options.nsecs?options.nsecs:_lastNSecs+1,dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&void 0===options.clockseq&&(clockseq=clockseq+1&16383),(dt<0||msecs>_lastMSecs)&&void 0===options.nsecs&&(nsecs=0),nsecs>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=msecs,_lastNSecs=nsecs,_clockseq=clockseq;var tl=(1e4*(268435455&(msecs+=122192928e5))+nsecs)%4294967296;b[i++]=tl>>>24&255,b[i++]=tl>>>16&255,b[i++]=tl>>>8&255,b[i++]=255&tl;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255,b[i++]=255&tmh,b[i++]=tmh>>>24&15|16,b[i++]=tmh>>>16&255,b[i++]=clockseq>>>8|128,b[i++]=255&clockseq;for(var n=0;n<6;++n)b[i+n]=node[n];return buf||bytesToUuid(b)}},function(module,exports,__webpack_require__){var rng=__webpack_require__(223),bytesToUuid=__webpack_require__(224);module.exports=function(options,buf,offset){var i=buf&&offset||0;"string"==typeof options&&(buf="binary"===options?new Array(16):null,options=null);var rnds=(options=options||{}).random||(options.rng||rng)();if(rnds[6]=15&rnds[6]|64,rnds[8]=63&rnds[8]|128,buf)for(var ii=0;ii<16;++ii)buf[i+ii]=rnds[ii];return buf||bytesToUuid(rnds)}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RBNotification=void 0;exports.RBNotification=class{constructor(date){this.date=date}}},function(module,exports){angular.module("rainbow").factory("CallLog",[function(){"use strict";function CallLog(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall){this.id=id,this.contact=contact,this.state=state,this.duration=duration,this.direction=direction,this.callSubject=callSubject,this.isLatestCall=isLatestCall,type="unknown"===type||"audio"===type||"webrtc"===type?CallLog.Type.WEBRTC:"telephone"===type?CallLog.Type.TELEPHONE:CallLog.Type.CONFERENCE,this.type=type,this.read=read,this.date=date,this.updateCallLogDisplayInfo=function(){"missed"===this.state&&"incoming"===this.direction?(this.svgId="call_missed",this.svgClass="missed",this.title="missedCall"):"missed"===this.state&&"outgoing"===this.direction?(this.svgId="call_missed-outgoing",this.svgClass="missed",this.title="noAnswer"):"incoming"===this.direction?(this.svgId="call_received",this.svgClass="active",this.title="incommingCall"):"outgoing"===this.direction&&(this.svgId="call_made",this.svgClass="active",this.title="outgoingCall")}}return CallLog.create=function(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall){return new CallLog(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall)},CallLog.getNames=function(callLog){var result={firstname:"",lastname:""};return callLog&&callLog.contact&&(result.firstname=callLog.contact.firstname?callLog.contact.firstname.toUpperCase():"",result.lastname=callLog.contact.lastname?callLog.contact.lastname.toUpperCase():"",callLog&&callLog.date&&(result.date=callLog.date.getTime())),result},CallLog.getDate=function(callLog){return callLog&&callLog.date?callLog.date.getTime():0},CallLog.sortByContact=function(callLogA,callLogB){var res=-1;if(callLogA&&callLogA.value.lastname&&callLogB&&callLogB.value.lastname){var str1=callLogA.value.lastname,str2=callLogB.value.lastname;0===(res=str1.localeCompare(str2))&&(str1=callLogA.value.firstname,str2=callLogB.value.firstname,0===(res=str1.localeCompare(str2))&&callLogB.value.date&&callLogA.value.date&&(res=callLogB.value.date-callLogA.value.date))}return res},CallLog.sortByDate=function(callLogA,callLogB){var res=1;return callLogA&&callLogB&&(res=callLogB.value-callLogA.value),res},CallLog.Type={WEBRTC:"webrtc",TELEPHONE:"telephone",CONFERENCE:"conference"},CallLog}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_0__);angular.module("rainbow").factory("VoiceMail",[function(){function VoiceMail(){this.VMFlag=!1,this.VMCounter=0,this.infoMsg="",this.voiceMailFeatureEnabled=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_0___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_0___default.a.FeaturesEnum.TELEPHONY_VOICE_MAIL),this.setVMFlag=function(flag){this.VMFlag=flag},this.getVMFlag=function(){return this.VMFlag},this.setVMCounter=function(ct){ct>0?(this.VMFlag=!0,this.VMCounter=ct):this.VMCounter=0},this.getVMCounter=function(){return this.VMCounter},this.setInfoMsg=function(msg){this.infoMsg=msg},this.getInfoMsg=function(){return this.infoMsg},this.getDisplayState=function(){return this.voiceMailFeatureEnabled}}return VoiceMail.create=function(){return new VoiceMail},VoiceMail}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Offer=void 0;class Offer{constructor(id,name,isDefault,isExclusive,isPrepaid,hasConference,isDemo){this.id=null,this.name=null,this.isDefault=!1,this.isExclusive=!1,this.hasConference=!1,this.isPrepaid=!1,this.isDemo=!1,this.id=id,this.name=name||"",this.isDefault=isDefault,this.isExclusive=isExclusive,this.isPrepaid=isPrepaid,this.hasConference=hasConference,this.isDemo=isDemo}static createFromProfileData(profile){return new Offer(profile.offerId,profile.offerName,profile.isDefault,profile.isExclusive,profile.isPrepaid,profile.hasConference,profile.isDemo)}static offerComparator(offer1,offer2){const offerOrder=["Essential","Business","Enterprise","Voice","Room","Conference"];if(offer1.isEssential())return-1;if(offer2.isEssential())return 1;if(offer1.isDemo&&!offer2.isDemo)return-1;if(!offer1.isDemo&&offer2.isDemo)return 1;if(offer1.hasConference&&!offer2.hasConference)return 1;if(!offer1.hasConference&&offer2.hasConference)return-1;let orderIndex1=offerOrder.findIndex(order=>offer1.name.startsWith(order)),orderIndex2=offerOrder.findIndex(order=>offer2.name.startsWith(order));return orderIndex1=-1===orderIndex1?offerOrder.length:orderIndex1,orderIndex2=-1===orderIndex2?offerOrder.length:orderIndex2,orderIndex1<orderIndex2?-1:orderIndex1>orderIndex2?1:offer1.isDemo?-1:offer2.isDemo||offer1.isPrepaid&&!offer2.isPrepaid?1:!offer1.isPrepaid&&offer2.isPrepaid||offer1.name<offer2.name?-1:offer1.name>offer2.name?1:0}isEnterprise(){return this.name.toLowerCase().startsWith("enterprise")}isBusiness(){return this.name.toLowerCase().startsWith("business")}isEssential(){return this.isDefault}}exports.Offer=Offer},function(module,exports){angular.module("rainbow").factory("Organisation",[function(){"use strict";function Organisation(id,name,visibility){this.id=id,this.name=name,this.visibility=visibility,this.companies=[]}return Organisation.createFromData=function(data){return new Organisation(data.id,data.name,data.visibility)},Organisation}])},function(module,exports){angular.module("rainbowAdmin").factory("Bot",[function(){"use strict";function Bot(jid,name,id,avatarId,lastAvatarUpdateDate,isBotAvatarCustomized){this.jid=jid,this.name=name,this.id=id,this.avatarId=avatarId||id,this.lastAvatarUpdateDate=lastAvatarUpdateDate,this.isAvatarCustomized=isBotAvatarCustomized}return Bot.create=function(data){return new Bot(data.jid,data.name,data.id,data.avatarId,data.lastAvatarUpdateDate,data.isBotAvatarCustomized)},Bot}])},function(module,exports){angular.module("rainbow").factory("Site",[function(){"use strict";function Site(id,name,status,companyId,settings,isCentrex){this.id=id,this.name=name||"",this.status=status||"",this.companyId=companyId||"",this.settings=settings||"",angular.isDefined(isCentrex)&&(this.isCentrex=isCentrex)}return Site.createFromData=function(data){return new Site(data.id,data.name,data.status,data.companyId,data.settings,data.isCentrex)},Site.create=function(id,name,status,companyId){return new Site(id,name,status,companyId)},Site.StatusValues=["active","alerting","hold","terminated"],Site}])},function(module,exports){angular.module("rainbow").factory("System",[function(){"use strict";function System(id,pbxId,jid_pbxagent,jid_password,pbxMainBundlePrefix,serverPingTimeout,type,status,version,siteId,country,name,jid_pbxagent_password,jid_pbxagent_password_activating,usePbxMainBundlePrefix,pbxNumberingTranslator,isCentrex,isShared,bpId,cloudpbx,hasMediaPillar,isOxoManaged,oxopbx,pbxNationalPrefix,pbxInternationalPrefix){this.id=id||null,this.type=type||null,this.type!==System.TypeEnum.CLOUD_PBX&&(this.jid_pbxagent=jid_pbxagent||"",this.jid_password=jid_password||"",this.jid_pbxagent_password=jid_pbxagent_password||"",this.jid_pbxagent_password_activating=jid_pbxagent_password_activating||"",this.pbxMainBundlePrefix=pbxMainBundlePrefix||["0"],this.usePbxMainBundlePrefix=!angular.isDefined(usePbxMainBundlePrefix)||usePbxMainBundlePrefix,this.pbxNumberingTranslator=pbxNumberingTranslator||[],this.pbxNationalPrefix=pbxNationalPrefix,this.pbxInternationalPrefix=pbxInternationalPrefix),this.country=country||"FRA",this.name=name||"",siteId&&(this.siteId=siteId),pbxId&&(this.pbxId=pbxId),serverPingTimeout&&(this.serverPingTimeout=serverPingTimeout),status&&(this.status=status),version&&(this.version=version),angular.isDefined(isCentrex)&&(this.isCentrex=isCentrex),angular.isDefined(isShared)&&(this.isShared=isShared),bpId&&(this.bpId=bpId),angular.isDefined(hasMediaPillar)&&(this.hasMediaPillar=hasMediaPillar),angular.isDefined(isOxoManaged)&&(this.isOxoManaged=isOxoManaged),cloudpbx?(cloudpbx.domainName&&(this.domainName=cloudpbx.domainName),cloudpbx.numberingDigits&&(this.numberingDigits=cloudpbx.numberingDigits),cloudpbx.numberingPrefix&&(this.numberingPrefix=cloudpbx.numberingPrefix),cloudpbx.outgoingPrefix&&(this.outgoingPrefix=cloudpbx.outgoingPrefix),cloudpbx.externalTrunkId&&(this.externalTrunkId=cloudpbx.externalTrunkId),cloudpbx.installationNumber&&(this.installationNumber=cloudpbx.installationNumber),cloudpbx.installationNumberId&&(this.installationNumberId=cloudpbx.installationNumberId),cloudpbx.language&&(this.language=cloudpbx.language),cloudpbx.customSipHeader_1&&(this.customSipHeader_1=cloudpbx.customSipHeader_1),cloudpbx.customSipHeader_2&&(this.customSipHeader_2=cloudpbx.customSipHeader_2),cloudpbx.overflowSubscribersToVoicemail&&(angular.isDefined(cloudpbx.overflowSubscribersToVoicemail.activate)&&(this.callOverflowToVMActivate=cloudpbx.overflowSubscribersToVoicemail.activate),cloudpbx.overflowSubscribersToVoicemail.noReplyDelay&&(this.callOverflowToVMNoReplyDelay=cloudpbx.overflowSubscribersToVoicemail.noReplyDelay)),cloudpbx.barringOptions&&(cloudpbx.barringOptions.permissions&&(this.barringOptionsPermission=cloudpbx.barringOptions.permissions),cloudpbx.barringOptions.restrictions&&(this.barringOptionsRestriction=cloudpbx.barringOptions.restrictions)),cloudpbx.cliOptions&&(this.cliOptions=cloudpbx.cliOptions),cloudpbx.emergencyOptions&&(this.emergencyOptions=cloudpbx.emergencyOptions)):isOxoManaged&&oxopbx?(oxopbx.numberingDigits&&(this.numberingDigits=oxopbx.numberingDigits),oxopbx.numberingPrefix&&(this.numberingPrefix=oxopbx.numberingPrefix),oxopbx.outgoingPrefix&&(this.outgoingPrefix=oxopbx.outgoingPrefix),oxopbx.target&&(this.target=oxopbx.target),oxopbx.installationNumber&&(this.installationNumber=oxopbx.installationNumber),oxopbx.installationNumberId&&(this.installationNumberId=oxopbx.installationNumberId)):(this.numberingDigits=3,this.numberingPrefix="1")}return System.createFromData=function(data){return new System(data.id,data.pbxId,data.jid_pbxagent,data.jid_password,data.pbxMainBundlePrefix,data.serverPingTimeout,data.type,data.status,data.version,data.siteId,data.country,data.name,data.jid_pbxagent_password,data.jid_pbxagent_password_activating,data.usePbxMainBundlePrefix,data.pbxNumberingTranslator,data.isCentrex,data.isShared,data.bpId,data.cloudpbx,data.hasMediaPillar,data.isOxoManaged,data.oxopbx,data.pbxNationalPrefix,data.pbxInternationalPrefix)},System.create=function(){return new System},System.TypeValues=["oxe","oxo","third_party","cloud_pbx","oxo_managed"],System.TypeEnum={OXE:"oxe",OXO:"oxo",THIRD_PARTY:"third_party",CLOUD_PBX:"cloud_pbx",OXO_MANAGED:"oxo_managed"},System.StatusValues=["created","activating","activated"],System.CliPolicy={USER_DDI_NUMBER:"user_ddi_number",INSTALLATION_DDI_NUMBER:"installation_ddi_number"},System.CliPolicyValues=[System.CliPolicy.USER_DDI_NUMBER,System.CliPolicy.INSTALLATION_DDI_NUMBER],System}]),angular.module("rainbow").filter("serverTypeFilter",[function(){"use strict";return function(input){return"oxo"===input?"OXO Connect":"oxe"===input?"OmniPCX Enterprise":"third_party"===input?"Third party PBX":"cloud_pbx"===input?"Cloud PBX":"oxo_managed"===input?"Managed OXO Connect":input}}]),angular.module("rainbow").filter("systemStateFilter",[function(){"use strict";return function(input){return"created"===input||"activating"===input?"pending":"activated"===input?"systemStatusActivated":"connected"===input?"systemStatusConnected":"disconnected"===input?"systemStatusDisonnected":"degraded"===input?"systemStatusDegraded":input}}]),angular.module("rainbow").filter("systemStateColorFilter",[function(){"use strict";return function(input){return"created"===input||"activating"===input||"activated"===input?"color_blue":"connected"===input?"color_green":"disconnected"===input?"color_error":"degraded"===input?"color_warning":input}}]),angular.module("rainbow").filter("thirdPartySystemStateFilter",[function(){"use strict";return function(input){return"created"===input||"activating"===input?"pending":"activated"===input?"systemStatusConnected":input}}]),angular.module("rainbow").filter("thirdPartySystemStateColorFilter",[function(){"use strict";return function(input){return"created"===input||"activating"===input?"color_blue":"activated"===input?"color_green":input}}]),angular.module("rainbow").filter("cloudPbxStateFilter",[function(){"use strict";return function(input){return"created"===input?"systemStatusConnected":"disconnected"===input?"systemStatusDisonnected":input}}]),angular.module("rainbow").filter("cloudPbxStateColorFilter",[function(){"use strict";return function(input){return"created"===input?"color_green":"disconnected"===input?"color_error":input}}]),angular.module("rainbow").filter("gatewayStateFilter",[function(){"use strict";return function(input){return"true"===input?"systemStatusConnected":"false"===input?"systemStatusDisonnected":input}}]),angular.module("rainbow").filter("gatewayStateColorFilter",[function(){"use strict";return function(input){return"true"===input?"color_green":"false"===input?"color_error":"new_version"===input?"color_warning":input}}]),angular.module("rainbow").filter("cloudPbxBarringOptionPermissionFilter",[function(){"use strict";return function(input){return"default"===input?"same_than_company":"local"===input?"intraPBXCallsOnly":"nat_local"===input?"nationalAndIntraPBXCalls":"int_nat_local"===input?"internationalNationalAndIntraPBXCalls":input}}]),angular.module("rainbow").filter("cloudPbxBarringOptionRestrictionFilter",[function(){"use strict";return function(input){return"default"===input?"same_than_company":"no_restriction"===input?"none":"surcharged_numbers"===input?"surchargedNumbers":"custom_numbers"===input?"customizedProhibitedNumbers":input}}]),angular.module("rainbow").filter("cloudPbxCliPolicyFilter",[function(){"use strict";return function(input){return"user_ddi_number"===input?"userDDINumber":"installation_ddi_number"===input?"companyPhoneNumber":"other_ddi_number"===input?"otherDDINumber":input}}]),angular.module("rainbow").filter("ivrStateFilter",[function(){"use strict";return function(input){return"active"===input?"systemStatusActive":"unknown"}}]),angular.module("rainbow").filter("ivrStateClassFilter",[function(){"use strict";return function(input){return"active"===input?"color_green":"color_error"}}])},function(module,exports){angular.module("rainbow").factory("SystemsGroup",[function(){"use strict";function SystemsGroup(id,name,companies,systems){this.id=id||null,this.name=name,this.companies=companies||[],this.systems=systems,this.containsSystem=function(systemId){return!!this.systems&&this.systems.some((function(system){return system.systemId===systemId}))}}return SystemsGroup.createFromData=function(data){return new SystemsGroup(data.id,data.name,data.companies,data.systems)},SystemsGroup.create=function(id,name,companies,systems){return new SystemsGroup(id,name,companies,systems)},SystemsGroup}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(31),_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_0__);angular.module("rainbow").factory("User",["Subscription",function(Subscription){function User(data,noDefaultValues){var _this=this;User.attributes.forEach((function(attribute){data&&angular.isDefined(data[attribute.name])?_this[attribute.name]=data[attribute.name]:!noDefaultValues&&angular.isDefined(attribute.defaultValue)&&(_this[attribute.name]=attribute.defaultValue)})),this.subscriptions=[],this.updateFromData=function(newData){User.attributes.forEach((function(attribute){angular.isDefined(newData[attribute.name])&&(_this[attribute.name]=newData[attribute.name])}))},this.fillSubscriptionMap=function(){var subscriptionMap={};this.subscriptions.forEach((function(subscription){subscriptionMap[subscription.id]=subscription})),this.subscriptionMap=subscriptionMap},this.fillMainSubscriptionField=function(){var exclusiveSubscriptions=this.subscriptions.filter(Subscription.isExclusive).sort(Subscription.subscriptionComparator);exclusiveSubscriptions.length>0&&(this.mainSubscription=exclusiveSubscriptions[exclusiveSubscriptions.length-1],this.mainSubscriptionName=this.mainSubscription.offerName);var optionalSubscriptions=this.subscriptions.filter(Subscription.isOptional);optionalSubscriptions.length>0&&(this.optionalSubscriptionNames=optionalSubscriptions.map((function(optionalSubscription){return optionalSubscription.offerName})).join(", ")),this.subscriptionNames=this.mainSubscriptionName+(this.optionalSubscriptionNames?", "+this.optionalSubscriptionNames:"")},this.getMainSubscription=function(){return this.mainSubscription||this.fillMainSubscriptionField(),this.mainSubscription},this.getOptionalSubscriptions=function(){return this.subscriptions.filter(Subscription.isOptional)},this.getMainSubscriptionName=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.mainSubscriptionName},this.getOptionalSubscriptionNames=function(){return this.mainSubscriptionName||this.fillMainSubscriptionField(),this.optionalSubscriptionNames},this.hasUserRoleOnly=function(){return 1===this.roles.length&&-1!==this.roles.indexOf(User.RoleValues.USER)},this.isGuest=function(){return-1!==this.roles.indexOf(User.RoleValues.GUEST)||this.guestMode},this.isAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.ADMIN)},this.isOrganizationAdmin=function(){return!!this.isAdmin()&&"organization_admin"===this.adminType},this.isSiteAdmin=function(){return!!this.isAdmin()&&"site_admin"===this.adminType},this.isCompanyAdmin=function(){return!!this.isAdmin()&&"company_admin"===this.adminType},this.isBPAdmin=function(){return this.isBPAdminOperations()||this.isBPAdminFinance()},this.isBPAdminOperations=function(){return-1!==this.roles.indexOf(User.RoleValues.BP_ADMIN_OPERATIONS)},this.isBPAdminFinance=function(){return-1!==this.roles.indexOf(User.RoleValues.BP_ADMIN_FINANCE)},this.isSuperadmin=function(){return-1!==this.roles.indexOf(User.RoleValues.SUPERADMIN)},this.isBusinessAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.BUSINESS_ADMIN)},this.isPublicChannelsAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.PUBLIC_CHANNELS_ADMIN)},this.isAllCompanyChannelsAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.ALL_COMPANY_CHANNELS_ADMIN)},this.isClosedChannelsAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.CLOSED_CHANNELS_ADMIN)},this.isDirectoryAdmin=function(){return-1!==this.roles.indexOf(User.RoleValues.DIRECTORY_ADMIN)},this.isRainbowTv=function(){return this.isTv||-1!==this.roles.indexOf(User.RoleValues.TV)},this.computeDisplayName=function(){var nameInfo=_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_0___default.a.getNameInformation(this.firstName,this.lastName);this.displayName=nameInfo.displayName,this.initials=nameInfo.initials},this.getPhoneNumbers=function(type,deviceType){return this.phoneNumbers?this.phoneNumbers.filter((function(phoneNumber){return phoneNumber.type===type&&phoneNumber.deviceType===deviceType})):[]},this.getSystemPhoneNumber=function(){return this.phoneNumbers?this.phoneNumbers.find((function(phoneNumber){return angular.isDefined(phoneNumber.systemId)&&phoneNumber.isFromSystem})):void 0},this.isRvcpSubscriber=function(){var userSystemPhoneNumber=this.getSystemPhoneNumber();return userSystemPhoneNumber&&"RVCP Subscriber"===userSystemPhoneNumber.deviceName},this.isOxoSubscriber=function(){return this.getSystemPhoneNumber()},this.getActivePhoneNumber=function(type,deviceType){var filteredPhoneNumbers=this.getPhoneNumbers(type,deviceType);if(filteredPhoneNumbers.length>1){var systemPhoneNumber=filteredPhoneNumbers.find((function(phoneNumber){return angular.isDefined(phoneNumber.systemId)}));if(systemPhoneNumber)return systemPhoneNumber}return filteredPhoneNumbers[0]},this.getDdiPhoneNumber=function(type,deviceType){var filteredPhoneNumbers=this.getPhoneNumbers(type,deviceType);if(filteredPhoneNumbers.length>1){var ddiPhoneNumber=filteredPhoneNumbers.find((function(phoneNumber){return phoneNumber.isCloudPbxDDI||phoneNumber.isOxoPbxDDI}));if(ddiPhoneNumber||(ddiPhoneNumber=filteredPhoneNumbers.find((function(phoneNumber){return phoneNumber.isFromSystem}))),ddiPhoneNumber)return ddiPhoneNumber}return filteredPhoneNumbers[0]}}return User.createFromData=function(data,noDefaultValues){data&&data.roles&&data.roles.includes("private_channels_admin")&&data.roles.splice(data.roles.indexOf("private_channels_admin"),1,User.RoleValues.ALL_COMPANY_CHANNELS_ADMIN);var user=new User(data,noDefaultValues);return data.profiles&&(data.profiles.forEach((function(subscriptionData){var subscription=Subscription.createFromData(subscriptionData);subscription.isTerminated()||user.subscriptions.push(subscription)})),user.fillMainSubscriptionField()),user.computeDisplayName(),user},User.create=function(){return new User},User.prune=function(data,userContact){var dataCopy=Object.assign({},data);return"RAINBOW"===dataCopy.authenticationType&&delete dataCopy.authenticationExternalUid,dataCopy},User.VisibilityValues=["same_than_company","public","private"],User.PermissionValues=["same_than_company","enabled","disabled"],User.VmOverflowValues=["default","custom","disabled"],User.CliPolicy={COMPANY_POLICY:"company_policy",USER_DDI_NUMBER:"user_ddi_number",INSTALLATION_DDI_NUMBER:"installation_ddi_number",OTHER_DDI_NUMBER:"other_ddi_number"},User.CliPolicyValues=[User.CliPolicy.COMPANY_POLICY,User.CliPolicy.USER_DDI_NUMBER,User.CliPolicy.INSTALLATION_DDI_NUMBER,User.CliPolicy.OTHER_DDI_NUMBER],User.RoleValues={USER:"user",GUEST:"guest",SUPERADMIN:"superadmin",SUPPORT:"support",BUSINESS_ADMIN:"business_admin",ADMIN:"admin",BP_ADMIN_OPERATIONS:"bp_admin",BP_ADMIN_FINANCE:"bp_finance",DIRECTORY_ADMIN:"directory_admin",PUBLIC_CHANNELS_ADMIN:"public_channels_admin",ALL_COMPANY_CHANNELS_ADMIN:"all_company_channels_admin",CLOSED_CHANNELS_ADMIN:"closed_channels_admin",TV:"tv"},User.LoginPolicies=[{value:"RAINBOW",label:"rainbowLoginCredentials"},{value:"SAML",label:"ssoLoginCredentialsSAML",isSSO:!0},{value:"OIDC",label:"ssoLoginCredentialsOIDC",isSSO:!0},{value:"DEFAULT",label:"defaultLogin"}],User.attributes=[{name:"id",defaultValue:null},{name:"loginEmail",defaultValue:""},{name:"firstName",defaultValue:""},{name:"lastName",defaultValue:""},{name:"displayName",defaultValue:""},{name:"nickName",defaultValue:""},{name:"title",defaultValue:""},{name:"jobTitle",defaultValue:""},{name:"department",defaultValue:""},{name:"companyId",defaultValue:""},{name:"companyName",defaultValue:""},{name:"siteId",defaultValue:""},{name:"systemId",defaultValue:""},{name:"accountType",defaultValue:"free"},{name:"country",defaultValue:"FRA"},{name:"timezone",defaultValue:"Europe/Paris"},{name:"emails",defaultValue:[]},{name:"phoneNumbers",defaultValue:[]},{name:"roles",defaultValue:["user"]},{name:"adminType",defaultValue:"company_admin"},{name:"isActive",defaultValue:!1},{name:"isInitialized",defaultValue:!1},{name:"isTerminated",defaultValue:void 0},{name:"isTv",defaultValue:void 0},{name:"password",defaultValue:void 0},{name:"jid_im",defaultValue:""},{name:"jid_tel",defaultValue:""},{name:"language",defaultValue:"en"},{name:"lastAvatarUpdateDate",defaultValue:null},{name:"visibility",defaultValue:void 0},{name:"authenticationType",defaultValue:void 0},{name:"authenticationExternalUid",defaultValue:void 0},{name:"tags",defaultValue:void 0},{name:"userInfo1",defaultValue:void 0},{name:"userInfo2",defaultValue:void 0},{name:"tryNewUiCustomisation",defaultValue:void 0},{name:"softphoneOnlyCustomisation",defaultValue:void 0},{name:"fileSharingCustomisation",defaultValue:void 0},{name:"userTitleNameCustomisation",defaultValue:void 0},{name:"useRoomCustomisation",defaultValue:void 0},{name:"phoneMeetingCustomisation",defaultValue:void 0},{name:"useChannelCustomisation",defaultValue:void 0},{name:"useWebRTCVideoCustomisation",defaultValue:void 0},{name:"useWebRTCAudioCustomisation",defaultValue:void 0},{name:"instantMessagesCustomisation",defaultValue:void 0},{name:"userProfileCustomisation",defaultValue:void 0},{name:"fileStorageCustomisation",defaultValue:void 0},{name:"overridePresenceCustomisation",defaultValue:void 0},{name:"changeSettingsCustomisation",defaultValue:void 0},{name:"changeTelephonyCustomisation",defaultValue:void 0},{name:"recordingConversationCustomisation",defaultValue:void 0},{name:"useGifCustomisation",defaultValue:void 0},{name:"useDialOutCustomisation",defaultValue:void 0},{name:"selectedAppCustomisationTemplate",defaultValue:void 0},{name:"guestMode",defaultValue:void 0},{name:"lastLoginDate",defaultValue:void 0}],User}]),angular.module("rainbow").filter("genericPermissionLabelFilter",[function(){return function(input){return"same_than_company"===input?"same_than_company":"enabled"===input?"authorized":"disabled"===input?"notAuthorized":input}}]),angular.module("rainbow").filter("phoneVmOverflowLabelFilter",[function(){return function(input){return"default"===input?"same_than_company":"custom"===input?"yes":"disabled"===input?"no":input}}]),angular.module("rainbow").filter("cloudPbxSubscriberCliPolicyFilter",[function(){return function(input){return"company_policy"===input?"same_than_company":"user_ddi_number"===input?"userDDINumber":"installation_ddi_number"===input?"companyPhoneNumber":"other_ddi_number"===input?"otherDDINumber":input}}]),angular.module("rainbow").filter("softphoneOnlyPermissionLabelFilter",[function(){return function(input){return input&&"same_than_company"!==input?"enabled"===input?"softphoneOnly":"disabled"===input?"allServices":input:"same_than_company"}}])},function(module,exports){angular.module("rainbow").factory("Subscription",["Offer",function(Offer){"use strict";function Subscription(id,offerId,offerName,offerDescription,groupName,offerReference,profileId,profileName,maxNumberUsers,numberAssignedUsers,status,syncOngoing,updatingMaxNumberUsers,nbBPLicences,nbAssignedBPUsers,nbLicencesAssignedToECs,nbLicencesUsed,nbFreeLicences,businessModel,canBeSold,isDefault,isExclusive,isPrepaid,prepaidDuration,expirationDate,autoRenew,renewalTermOption,prepaidRenewalOption,hasConference,hasVoice,isDemo,isChinaOffer){this.id=id,this.offerId=offerId,this.offerName=offerName||"",isDemo&&(this.offerName=this.offerName.replace(new RegExp("\\bDemo\\b")," Custom")),this.offerDescription=offerDescription||"Rainbow "+this.offerName,this.groupName=groupName||offerName,this.offerReference=offerReference,this.profileId=profileId,this.profileName=profileName,this.maxNumberUsers=maxNumberUsers,this.numberAssignedUsers=numberAssignedUsers,this.status=status,this.syncOngoing=syncOngoing||!1,this.updatingMaxNumberUsers=updatingMaxNumberUsers,void 0!==nbBPLicences&&(this.nbBPLicences=nbBPLicences),void 0!==nbAssignedBPUsers&&(this.nbAssignedBPUsers=nbAssignedBPUsers),void 0!==nbLicencesAssignedToECs&&(this.nbLicencesAssignedToECs=nbLicencesAssignedToECs),void 0!==nbLicencesUsed&&(this.nbLicencesUsed=nbLicencesUsed),void 0!==nbFreeLicences&&(this.nbFreeLicences=nbFreeLicences),this.businessModel=businessModel,this.canBeSold=canBeSold,this.isDefault=isDefault,this.isExclusive=isExclusive,this.isPrepaid=isPrepaid,this.prepaidDuration=prepaidDuration,this.expirationDate=expirationDate,this.autoRenew=autoRenew,this.renewalTermOption=renewalTermOption,this.prepaidRenewalOption=prepaidRenewalOption,this.hasConference=hasConference,this.hasVoice=hasVoice,this.isDemo=void 0===isDemo?!this.isDefault&&!this.canBeSold&&this.offerName.toLowerCase().includes("custom"):isDemo,this.isChinaOffer=isChinaOffer,this.isEnterprise=function(){return this.groupName.toLowerCase().includes("enterprise")},this.isBusiness=function(){return this.groupName.toLowerCase().includes("business")},this.isEssential=function(){return this.isDefault},this.isTrial=function(){return this.isDemo},this.isTerminated=function(){return"terminated"===this.status},this.isTerminating=function(){return"terminating"===this.status},this.isUserLicense=function(){return this.isDefault||"nb_users"===this.businessModel||"usage"===this.businessModel}}return Subscription.createFromData=function(data){return new Subscription(data.id?data.id:data.subscriptionId,data.offerId,data.offerName,data.offerDescription,data.groupName,data.offerReference,data.profileId,data.profileName,data.maxNumberUsers,data.numberAssignedUsers,data.status,data.syncOngoing,data.updatingMaxNumberUsers,data.nbBPLicences,data.nbAssignedBPUsers,data.nbLicencesAssignedToECs,data.nbLicencesUsed,data.nbFreeLicences,data.businessModel,data.canBeSold,data.isDefault,data.isExclusive,data.isPrepaid,data.prepaidDuration,data.expirationDate,data.autoRenew,data.renewalTermOption,data.prepaidRenewalOption,data.hasConference,data.hasVoice,data.isDemo,data.isChinaOffer)},Subscription.PrepaidRenewalOptions={RENEW_BILLED:"billed",RENEW_ALLOCATED:"allocated"},Subscription.subscriptionComparator=function(subscription1,subscription2){var offer1=new Offer(subscription1.offerId,subscription1.offerName,subscription1.offerDescription,subscription1.groupName,subscription1.offerReference,subscription1.profileId,subscription1.canBeSold,subscription1.businessModel,subscription1.isDefault,subscription1.isExclusive,subscription1.isPrepaid,subscription1.prepaidDuration,subscription1.autoSubscribe,subscription1.hasConference,subscription1.hasVoice,subscription1.isDemo,subscription1.isBundle,subscription1.isChinaOffer),offer2=new Offer(subscription2.offerId,subscription2.offerName,subscription2.offerDescription,subscription2.groupName,subscription2.offerReference,subscription2.profileId,subscription2.canBeSold,subscription2.businessModel,subscription2.isDefault,subscription2.isExclusive,subscription2.isPrepaid,subscription2.prepaidDuration,subscription2.autoSubscribe,subscription2.hasConference,subscription2.hasVoice,subscription2.isDemo,subscription2.isBundle,subscription2.isChinaOffer);return Offer.offerComparator(offer1,offer2)},Subscription.isUserLicense=function(subscription){return subscription.isDefault||"nb_users"===subscription.businessModel||"usage"===subscription.businessModel},Subscription.isTvLicense=function(subscription){return"Room"===subscription.groupName},Subscription.excludeTvLicense=function(subscription){return!Subscription.isTvLicense(subscription)},Subscription.isExclusive=function(subscription){return subscription.isDefault||subscription.isExclusive},Subscription.isOptional=function(subscription){return!Subscription.isExclusive(subscription)},Subscription.isConference=function(subscription){return Subscription.isOptional(subscription)&&(subscription.hasConference||"usage"===subscription.businessModel)},Subscription.isNotConference=function(subscription){return Subscription.isOptional(subscription)&&!(subscription.hasConference||"usage"===subscription.businessModel)},Subscription.withLicenses=function(subscription){return subscription.isDefault||"usage"===subscription.businessModel||"nb_users"===subscription.businessModel&&subscription.maxNumberUsers>0},Subscription.isPrepaid=function(subscription){return subscription.isPrepaid},Subscription.isMonthly=function(subscription){return!subscription.isPrepaid},Subscription}])},function(module,exports){angular.module("rainbow").factory("IceServer",[function(){"use strict";function IceServer(id,urls,username,credential){this.id=id,this.urls=urls,this.username=username,this.credential=credential}return IceServer.createFromData=function(data){return new IceServer(data.id,data.urls,data.username,data.credential)},IceServer}])},function(module,exports){angular.module("rainbow").factory("PhoneNumber",[function(){"use strict";function PhoneNumber(id,shortNumber,number,numberE164,pbxUserId,userId,type,deviceType,pbxId,isFromSystem,isMonitored,systemId,country,voiceMailNumber,deviceName,firstName,lastName,internalNumber,isCloudPbxDDI,isCloudPbxDefault,password,isOxoPbxDDI,isOxoPbxDefault,userDisplayName,overflowToVoicemail,barringOptions){this.id=id,this.shortNumber=shortNumber,this.number=number,this.numberE164=numberE164,this.pbxUserId=pbxUserId,this.userId=userId,this.type=type,this.deviceType=deviceType,this.pbxId=pbxId,this.isFromSystem=isFromSystem,this.isMonitored=isMonitored,this.systemId=systemId,this.country=country,this.voiceMailNumber=voiceMailNumber,this.deviceName=deviceName,this.firstName=firstName,this.lastName=lastName,this.internalNumber=internalNumber,angular.isDefined(isCloudPbxDDI)&&(this.isCloudPbxDDI=isCloudPbxDDI),angular.isDefined(isCloudPbxDefault)&&(this.isCloudPbxDefault=isCloudPbxDefault),password&&(this.password=password),userDisplayName&&(this.userDisplayName=userDisplayName),angular.isDefined(isOxoPbxDDI)&&(this.isOxoPbxDDI=isOxoPbxDDI,this.isCloudPbxDDI=isOxoPbxDDI),angular.isDefined(isOxoPbxDefault)&&(this.isOxoPbxDefault=isOxoPbxDefault,this.isCloudPbxDefault=isOxoPbxDefault),overflowToVoicemail&&(this.overflowToVoicemail=overflowToVoicemail),barringOptions&&(this.barringOptions=barringOptions)}return PhoneNumber.SelectTypeEnum={EXTENSION:"extension",EXTENSION_CLOUD:"extension-cloud",GROUP_CLOUD:"group-cloud",DDI_CLOUD:"ddi-cloud",FREE_DDI_CLOUD:"free-ddi-cloud",FREE_DDI_GROUP_CLOUD:"free-ddi-group-cloud"},PhoneNumber.createFromData=function(data){return new PhoneNumber(data.id?data.id:data.phoneNumberId,data.shortNumber,data.number,data.numberE164,data.pbxUserId,data.userId,data.type,data.deviceType,data.pbxId,data.isFromSystem,data.isMonitored,data.systemId,data.country,data.voiceMailNumber,data.deviceName,data.firstName,data.lastName,data.internalNumber,data.isCloudPbxDDI,data.isCloudPbxDefault,data.password,data.isOxoPbxDDI,data.isOxoPbxDefault,data.userDisplayName,data.overflowToVoicemail,data.barringOptions)},PhoneNumber}])},function(module,exports){angular.module("rainbow").service("helpersService",[function(){"use strict";this.chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",this.findIndex=function(array,predicate){return array.findIndex(predicate)},this.checkBrowser=function(browser){return-1!==navigator.userAgent.indexOf(browser)},this.randomString=function(length){length=length||10;for(var rnd,string="";length>0;)rnd=Math.floor(Math.random()*this.chars.length),string+=this.chars.charAt(rnd),length--;return string}}])},function(module,exports){angular.module("rainbow").service("errorHelperService",["$filter",function($filter){"use strict";var service=this;service.ErrorCodeLabels={"-1":"unknownError",0:"errorNoServerResponse",400:"Bad request",4e5:"Bad request",400210:"invalidPhoneNumber",400400:"errorWrongPassword",400500:"invalidFile",400504:"companyNameAlreadyExist",400505:"BPCompanyWithoutPaymentConfigurationData",400506:"NoActiveSubscriptionToOffer",400509:"errorDecreaseSubscriptionForbidden",400511:"ActiveDirectoryDomainAlreadyUsed",400552:"BPCompanyAndECCompanyMustNotBeSame",400601:"outboundAndInternalPrefixesCantBeIdentical",400973:"noCreateUserPermission",400975:"userAlreadyExistsInOtherCompany",400983:"userAlreadyExistsInOtherCompany",400990:"noUserFound",400993:"noUserFound",401:"Authorization failure",401102:"Authorization failure",401202:"errorInvalidToken",401500:"errorUnauthorized",401501:"errorLoginForbidden",401510:"errorUnauthorized",401520:"errorUserNotActive",401521:"errorUserNotActive",403:"Forbidden",403e3:"accessDeniedNotRequiredRole",403001:"accessDeniedNotOwner",403034:"cantDeselectDefaultWebRTCGateway",403035:"cantDeleteDefaultWebRTCGateway",403060:"confLockMsg",403072:"errorIsoMd5Mismatch",403153:"notAllowedToAccessMeeting",403154:"notAllowedToAccessMeeting",403200:"notAllowedToChangeRole",403203:"notAllowedToChangeRole",403204:"notAllowedToMoveExistingUserToThisCompany",403205:"notAllowedToManageUser",403301:"notAllowedToManageCompany",403304:"notAllowedToAddAnotherAdmin",403311:"errorRemoveSyncOngoingSubscriptionForbidden",403315:"errorRemoveSubscriptionForbidden",403316:"errorRemoveAdminAllocatedSubscriptionForbidden",403317:"errorRemoveClientAllocatedSubscriptionForbidden",403400:"notAllowedDeleteAppOwner",403500:"notAllowedBlacklistedEmail",403501:"notAllowedBlacklistedEmail",403503:"NotAllowedSelfRegistrationEmail",403504:"notAllowedLoggedInUserEmail",403507:"notAllowedSupportEmail",403513:"companyNotABpCompany",403516:"companyNotABpCompany",403517:"companySeenAsTerminated",403518:"companyBpTypeIncompatible",403519:"companyAlreadyLinkedToBp",403520:"companyNotVadBp",403526:"isolatedUser",403531:"resetPasswordBlocked",403532:"resetPasswordForbidden",403608:"errorAssignSubscriptionSyncOngoing",403609:"errorAssignSubscriptionSyncOngoing",403610:"maxSubscriptionAllocationReached",403611:"notAllowedToCreateAnEquipment",403615:"maximumNumberConferenceParticipantsReach",403616:"subscriptionCompanyAdminEssentialAlreadyExists",403617:"roleCompanyAdminEssentialAlreadyExists",403620:"MaximumNumberRoomUsersReach",403621:"MaximumNumberConvUsersReach",403624:"notAllowedRemoveService",403625:"errorAllocatedSubscriptionRemoveForbidden",403626:"restrictedConvAccess",403630:"uploadErrorMaxQuotaReached",403655:"userAlreadyCompanyMember",403670:"errorOperationForbiddenOnGuest",403700:"errorDeleteSiteWithSystems",403701:"errorDeleteOrganisationLinkedCompany",403702:"errorDeleteCompanyWithSubscriptions",403703:"errorDeleteCompanyWithSites",403704:"errorDeleteCompanyWithUsers",403705:"errorDeleteCompanyStillTerminated",403706:"errorRemoveBusinessPartnerRole",403719:"externalTrunkChangeForbidden",403721:"numberingPlanCantBeUpdated",403722:"outgoingPrefixChangeForbidden",403723:"cannotRemoveCompanyPublicNumber",403724:"notAllowedDeleteCloudPbxWithPublicNumbers",403725:"notAllowedDeleteCloudPbxWithUsedExtensions",404:"resourceNotFound",404e3:"resourceNotFound",404001:"resourceNotFoundUpdateImpossible",404002:"resourceNotFoundDeleteImpossible",404116:"archivedOrDeletedConversation",404300:"noValidOfferReferenceInACTISFile",404301:"offerNotFound",409e3:"userAlreadyCreated",409005:"inviteUsersError",409008:"emptyVoiceMessage",409011:"noMessagesToExport",409251:"DDIAlreadyAssociatedToCompany",409552:"internalNumberAlreadyUsed",409555:"publicNumberAlreadyExists",409557:"notAllowedDeleteUserAssociatedToCloudPbx",409600:"userAlreadyExist",409601:"invitationReSentConflict",409602:"userAlreadyNetworkMember",409603:"invitationReSentConflict",409620:"offerAlreadySubscribed",409623:"conferenceOfferAlreadySubscribed",409625:"errorUpdateSyncOngoingSubscriptionForbidden",409800:"companyNotIrBp",409801:"companyNotLinkedToBp",409802:"actisCompanyAdminMismatch",409803:"actisCompanyNameMismatch",413e3:"uploadErrorTooLarge",500:"errorInternalServerError",1001:"extensionNotLinkedToEquipment",1002:"extensionHasNoIdentifier",1003:"extensionDoesNotExist",1004:"extensionLookupFailure",1005:"extensionConflict",1006:"nonUniqueEquipmentForExtension",1007:"userAlreadyAssociatedToExtension",1008:"extensionAssociatedToAnotherUser",1009:"failedToAttachExtension",1010:"userHasNoExtension",1011:"userHasTooManyExtensions",1012:"failedToDetachExtension"},service.portalErrorCodeLabels={massprovisioning:{4e5:"invalidValue",400501:"invalidFile",400502:"invalidColumnName",400504:"invalidFile",400506:"invalidValueInActionColumn",400600:"deviceTypeCannotBeUpdated",400601:"duplicateDeviceIds",400602:"duplicateMacAdresses",400603:"invalidDeviceTypes",400604:"missingDeviceTypeInLines",400605:"invalidEquipment",403610:"errorMaxSubscriptionReached",404600:"deviceDoesNotExist",404601:"noCloudPbxInCompany"},rvcpprovisioning:{403e3:"overflowConfigurationChangesStillInProgress",403622:"noVoiceLicenceAllocatedToUser",403728:"forbiddenOperationEquipmentHasDevices",409556:"companyHasAlreadyACloudPbx",403739:"forbiddenOperationWelcomeServiceUsed",413e3:"fileTooLarge",415e3:"audioFileTypeNotSupported"},authentication:{401102:"Authorization failure",401103:"Authorization failure",401500:"Authorization failure",401520:"Forbidden",401521:"Forbidden",401522:"Forbidden",401523:"Forbidden",401530:"Authorization failure",401600:"Authorization failure",401700:"Authorization failure",403e3:"Authorization failure",5e5:"errorInternalServerError",503e3:"resourceNotFound"}},service.handleErrorMessage=function(response,context){service.getErrorFullMessage(response,context)},service.handleError=function(response,params){var portal=service.getPortal(response),errorDetailsCode=response.status;response.data&&response.data.errorDetailsCode&&(errorDetailsCode=response.data.errorDetailsCode);var error=new Error(service.getDetailedErrorMessage(response));return error.status=response.status,error.fieldErrors=service.getBadRequestFieldErrors(response),error.errorDetailsCode=errorDetailsCode,error.errorDetailsLabel=service.getErrorCodeLabel(errorDetailsCode,portal),error.translatedMessage=service.getTranslatedErrorMessage(response,params,portal),error.portal=portal,error},service.getPortal=function(response){var url=response.config?response.config.url:void 0,res=url?url.match(/api\/rainbow\/(\w+)\//):void 0;return res?res[1]:void 0},service.getBadRequestFieldErrors=function(response){var fieldErrors={};if(400===response.status){if(response.data&&response.data.errorDetails instanceof Array)response.data.errorDetails.forEach((function(details){fieldErrors[details.param]||(fieldErrors[details.param]={ok:!1,message:details.msg,value:details.value})}));else if(response.data&&response.data.errorDetails&&response.data.errorDetails.param){var details=response.data.errorDetails;fieldErrors[details.param]={ok:!1,message:details.msg,value:details.value}}response.data&&400511===response.data.errorDetailsCode&&(fieldErrors.office365Tenant={ok:!1,message:service.ErrorCodeLabels[400511]}),response.data&&400601===response.data.errorDetailsCode&&(fieldErrors.outgoingPrefix={ok:!1,message:service.ErrorCodeLabels[400601]},fieldErrors.numberingPrefix={ok:!1,message:service.ErrorCodeLabels[400601]})}return fieldErrors},service.getErrorMessage=function(response){var errorMessage=service.getStatusErrorMessage(response);return response.data&&response.data.errorMsg&&(errorMessage="",response.data.errorDetails?response.data.errorDetails instanceof Array?errorMessage+="one or more fields are invalid":response.data.errorDetails.msg?errorMessage+=response.data.errorDetails.msg:errorMessage+=response.data.errorDetails:errorMessage+=response.data.errorMsg),errorMessage},service.getStatusErrorMessage=function(response){return 500===response.status?"Internal server error":-1===response.status?"Service unavailable":415===response.status?"Unsupported Media Type":413===response.status?"Request Entity Too Large":404===response.status?"Resource not found":403===response.status?"Access is forbidden":401===response.status?"Authorization failure":400===response.status?"Bad request":response.statusText?response.statusText:"Unknown error"},service.getDetailedErrorMessage=function(response){var errorMessage=service.getErrorMessage(response);return response.data&&response.data.errorDetailsData&&"string"==typeof response.data.errorDetailsData&&(errorMessage+=" "+response.data.errorDetailsData),response.data&&response.data.errorDetails&&response.data.errorDetails instanceof Array&&response.data.errorDetails.length>0&&(errorMessage+=" : "+response.data.errorDetails[0].msg),errorMessage},service.getTranslatedErrorMessage=function(response,params,portal){if(500===response.status)return service.getLocalizedError("500");var errorDetailsCode=null;response.data&&response.data.errorDetailsCode&&(errorDetailsCode=response.data.errorDetailsCode);var errorDetailsData=null;return errorDetailsData=response.data&&response.data.errorDetailsData?Object.assign(response.data.errorDetailsData,params):params,service.getTranslatedErrorMessageByDetailsCode(errorDetailsCode,errorDetailsData,service.getErrorMessage(response),portal)},service.getTranslatedErrorMessageByDetailsCode=function(errorDetailsCode,errorDetailsParams,errorInfoMessage,portal){var errorMessage;return errorDetailsCode&&(errorMessage=service.getLocalizedError(errorDetailsCode,errorDetailsParams,portal)),errorMessage||(errorMessage=errorDetailsCode?$filter("translate")("anErrorOccurred",{errorcode:errorDetailsCode}):$filter("translate")("anErrorOccurred"),errorInfoMessage&&(errorMessage+=" ("+$filter("translate")(errorInfoMessage)+")")),errorMessage},service.getLocalizedError=function(errorCode,params,portal){var errorMessage;if(errorCode){var errorLabel=service.getErrorCodeLabel(errorCode,portal);if(errorLabel){var translation=$filter("translate")(errorLabel,params);translation!==errorLabel&&(errorMessage=translation)}}return errorMessage},service.getErrorCodeLabel=function(errorCode,portal){return portal&&service.portalErrorCodeLabels[portal]&&service.portalErrorCodeLabels[portal][errorCode]?service.portalErrorCodeLabels[portal][errorCode]:service.ErrorCodeLabels[errorCode]},service.getErrorFullMessage=function(response,context){var errorMessage=context?context+" failure : ":"";response&&response.data?(errorMessage+=response.data.errorMsg,response.data.errorDetails&&(errorMessage+=" - ",response.data.errorDetails instanceof Array?response.data.errorDetails.forEach((function(details){errorMessage+=details.msg})):response.data.errorDetails.msg?errorMessage+=JSON.stringify(response.data.errorDetails.msg):errorMessage+=response.data.errorDetails)):errorMessage+="Unknow error - Something goes really wrong";var httpId="";return response&&response.headers&&(httpId=response.headers("x-rainbow-request-id"),errorMessage+=" x-rainbow-request-id = "+httpId),errorMessage}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0__);angular.module("rainbow").service("pushImageHelperService",["$log","$q","$http","errorHelperService",function($log,$q,$http,errorHelperService){var service=this;service.pushImage=function(pushServiceURL,avatarImg,params){return $q((function(resolve,reject){var resizePromise=null;if(params&&params.nosize)resizePromise=function(){var image=new Image;return image.src=avatarImg,$q.when(image)};else{var width=params&&params.width?params.width:512,height=params&&params.height?params.height:512;resizePromise=function(){return service.resizeImage(avatarImg,width,height)}}resizePromise().then((function(resizedImage){var binaryData=service.getBinaryData(resizedImage);$http({method:"POST",url:pushServiceURL,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getPostHeader("image/"+binaryData.type),data:binaryData.data,transformRequest:[]}).then((function(){$log.info("[pushImageHelperService] pushImage : success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[pushImageHelperService] "+errorHelperService.getErrorFullMessage(response,"pushImage"))}))}))}))},service.resizeImage=function(avatarImg,maxWidth,maxHeight){return $q((function(resolve){var image=new Image;image.src=avatarImg,image.onload=function(){var imageWidth=image.width,imageHeight=image.height;imageWidth>imageHeight?imageWidth>maxWidth&&(imageHeight*=maxWidth/imageWidth,imageWidth=maxWidth):imageHeight>maxHeight&&(imageWidth*=maxHeight/imageHeight,imageHeight=maxHeight);var canvas=document.createElement("canvas");canvas.width=imageWidth,canvas.height=imageHeight,image.width=imageWidth,image.height=imageHeight,canvas.getContext("2d").drawImage(this,0,0,imageWidth,imageHeight);var resizedImage=new Image;resizedImage.src=canvas.toDataURL("image/png"),resolve(resizedImage)}}))},service.getBinaryData=function(image){for(var typeIndex=image.src.indexOf("image/")+6,binaryIndex=image.src.indexOf(";base64,"),binaryData=image.src.slice(binaryIndex+8),imageType=image.src.slice(typeIndex,binaryIndex),binary_string=window.atob(binaryData),len=binary_string.length,bytes=new Uint8Array(len),i=0;i<len;i++)bytes[i]=binary_string.charCodeAt(i);return{type:imageType,data:bytes}}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(26),_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__);angular.module("rainbow").service("botService",["$http","$q","$log","$rootScope","$interval","conversationService",function($http,$q,$log,$rootScope,$interval,conversationService){var service=this;service.listeners=[],service.start=function(stats){$log.info("[botService] === STARTING ===");var startDate=performance.now();return $q((function(resolve,reject){service.init(),service.startListeners(),service.getBots().then((function(bots){$log.info(""),service.findEmily(bots),service.unlockWaitingConversations();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"botService",startDuration:startDuration}),$log.info("[botService] === STARTED ("+startDuration+" ms) ==="),$log.info(""),resolve()})).catch((function(error){$log.info("[botService] === STARTING FAILURE === "+error.message),reject()}))}))},service.stop=function(){$log.info("[botService] === STOPPED ===")},service.init=function(){service.emily=null,this.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/"},service.startListeners=function(){service.listeners.push($rootScope.$on("ON_COMPANY_SUPPORT_AVATAR_CHANGE_EVENT",service.onSupportAvatarChange))},service.stopListeners=function(){for(var listener;listener=listeners.pop();)listener()},service.onSupportAvatarChange=function(__event,supportAvatarInfo){$log.info("[botService] Emily avatar has been changed"),supportAvatarInfo.companyId===_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.userContact.company.id&&service.getEmilyBot().then((function(supportBot){service.updateEmily(supportBot)})).catch((function(error){$log.warn("[botService] Impossible to update Emily - "+error.stack||false)}))},service.getBots=function(format){return $q((function(resolve,reject){var url=service.portalURL+"bots?format="+(format||"full");$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[botService] getBots success"),resolve(response.data.data)})).catch((function(response){var errorMessage="getBots failure "+response.data.errorDetails+" with status "+response.status;$log.error("[botService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.getEmilyBot=function(){return $q((function(resolve,reject){var url=service.portalURL+"bots/rainbow-support";$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[botService] getEmilyBot success"),resolve(response.data.data)})).catch((function(response){var errorMessage="getEmilyBot failure "+response.data.errorDetails+" with status "+response.status;$log.error("[botService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.findEmily=function(bots){bots.forEach((function(bot){"Emily"===bot.name&&($log.info("[botService] Emily is found"),service.updateEmily(bot))}))},service.updateEmily=function(bot){service.emily=service.emily||bot,service.emily.name=bot.name,service.emily.id=bot.id,service.emily.avatarId=bot.avatarId||bot.id,service.emily.lastAvatarUpdateDate=bot.lastAvatarUpdateDate,service.emily.capabilities=bot.capabilities,service.emily.avatarUrl=service.getBotAvatarUrl(service.emily.avatarId,service.emily.lastAvatarUpdateDate),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.createBotContact(service.emily.jid,service.emily.name,service.emily.id,service.emily.avatarUrl,service.emily.capabilities),$log.info("[botService] Emily contact has been updated")},service.getEmily=function(){return service.emily},service.openConversationWithEmily=function(){return $q((function(resolve,reject){$log.info("[botService] openConversationWithEmily");var botContact=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.getContactByJid(service.emily.jid);conversationService.getOrCreateOneToOneConversation(botContact.jid).then((function(conversation){conversationService.setActiveConversation(conversation),resolve(conversation)})).catch((function(){$log.error("[botService] openConversationWithEmily failure"),reject()}))}))},service.unlockWaitingConversations=function(){conversationService.unlockWaitingBotConversations(!0)},service.getBotAvatarImage=function(avatarId,lastAvatarUpdateDate){return $q((function(resolve,reject){$log.info("[botService] getBotAvatarImage");var imgSrc=service.getBotAvatarUrl(avatarId,lastAvatarUpdateDate),image=new Image,nbErrors=0;image.onload=function(){var loadedImage=this;$interval((function(){$log.log("[botService] Load bot avatar "+avatarId+" lastAvatarUpdateDate "+lastAvatarUpdateDate+" success"),resolve(loadedImage)}),1,1)},image.onerror=function(){nbErrors++,$interval((function(){$log.warn("[botService] Load bor avatar "+avatarId+" lastAvatarUpdateDate "+lastAvatarUpdateDate+" failure"),1===nbErrors?($log.warn("[botService] Fallback to default emily avatar"),image.src="/resources/skins/rainbow/images/conversation/icon_headset.png"):reject(new Error("No image found"))}),1,1)},image.src=imgSrc}))},service.getBotAvatarUrl=function(botId,lastAvatarUpdateDate){var serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2___default.a.cdn&&(serverURL=_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2___default.a.cdnServer);var imgSrc=serverURL+"/api/avatar/"+botId+"?size=120";return imgSrc+=lastAvatarUpdateDate?"&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(lastAvatarUpdateDate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex):"&update="+Date.now()}}])},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0});const searchTextConvResults_1=__webpack_require__(221),conversationServiceEventHandler_1=__webpack_require__(225),conversationServiceBulkHistoryHandler_1=__webpack_require__(331),call_model_1=__webpack_require__(0),moment=__webpack_require__(3),rxjs_1=__webpack_require__(10),fileViewer_1=__webpack_require__(71),message_1=__webpack_require__(16),event_model_1=__webpack_require__(24),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),fileStorage_service_1=__webpack_require__(25),contact_service_1=__webpack_require__(1),logger_service_1=__webpack_require__(15),i18n_service_1=__webpack_require__(37),room_service_1=__webpack_require__(33),pgiConference_service_1=__webpack_require__(57),strophe_js_1=__webpack_require__(76);angular.module("rainbow").service("conversationService",["$q","$rootScope","$http","$interval","Conversation","videoService","telephonyService","ConversationServiceHistoryHandler","SearchTextConvResultsFactory","webConferenceService","webrtcGatewayService","fileServerService",function($q,$rootScope,$http,$interval,Conversation,videoService,telephonyService,ConversationServiceHistoryHandler,SearchTextConvResultsFactory,webConferenceService,webrtcGatewayService,fileServerService){var service=this;this.started=!1,service.start=stats=>{logger_service_1.default.info(""),logger_service_1.default.info("[conversationService] === STARTING ===");const defered=$q.defer(),startDate=performance.now();return this.pendingMessages={},this.activeConversation=null,this.conversations=[],this.conversationCreationPromise={},this.inCallConversations=[],this.idleConversations=[],this.involvedContactIds=[],this.rxSubject=new rxjs_1.Subject,this.pgiServiceSubscription=null,this.currentMissedIMCounter=0,this.currentMissedCallCounter=0,this.searchTextConvResults=SearchTextConvResultsFactory(),this.waitingBotConversations=[],this.botServiceReady=!1,this.isBasicCallAllowed=profile_service_1.default.isFeatureEnabled(profile_service_1.default.FeaturesEnum.TELEPHONY_BASIC_CALL),this.isSecondCallAllowed=profile_service_1.default.isFeatureEnabled(profile_service_1.default.FeaturesEnum.TELEPHONY_SECOND_CALL),this.attachHandlers(),logger_service_1.default.info("[conversationService] getServerConversations"),defered.resolve(),service.getServerConversations().then(()=>{service.started=!0,service.linkAllActiveCallsToConversations(),service.cleanUnwantedConversations(),service.pgiServiceSubscription=pgiConference_service_1.default.conferenceSessionsSubject.subscribe(updatedConfSessionEvent=>{updatedConfSessionEvent.id===pgiConference_service_1.default.getPstnInstantConferenceEndpointId()&&"created"===updatedConfSessionEvent.action&&pgiConference_service_1.default.subscribeToMyConferenceSessions(active=>{this.onPGiConferenceStateEvent(active)})});const startDuration=Math.round(performance.now()-startDate);stats.push({service:"conversationService",startDuration:startDuration}),logger_service_1.default.info("[conversationService] === STARTED ("+startDuration+" ms) ===")}).catch(error=>{logger_service_1.default.info("[conversationService] === STARTING FAILURE === "+error.message),defered.reject(error)}),this.contactUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_CONTACT_UPDATED_EVENT, rehandle it"),this.contactUpdateEventHandlerCleaner()),this.contactUpdateEventHandlerCleaner=$rootScope.$on("ON_CONTACT_UPDATED_EVENT",this.onContactChangedEvent),this.roomUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event "+room_service_1.default.ROOM_UPDATE_EVENT+", rehandle it"),this.roomUpdateEventHandlerCleaner()),this.roomUpdateEventHandlerCleaner=$rootScope.$on(room_service_1.default.ROOM_UPDATE_EVENT,this.onRoomChangedEvent),this.roomAddConferenceEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event "+room_service_1.default.ROOM_ADD_CONF_ENDPOINT_EVENT+", rehandle it"),this.roomAddConferenceEventHandlerCleaner()),this.roomAddConferenceEventHandlerCleaner=$rootScope.$on(room_service_1.default.ROOM_ADD_CONF_ENDPOINT_EVENT,this.onRoomAddConferenceEvent),this.roomHistoryUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event "+room_service_1.default.ROOM_HISTORY_UPDATE_EVENT+", rehandle it"),this.roomHistoryUpdateEventHandlerCleaner()),this.roomHistoryUpdateEventHandlerCleaner=$rootScope.$on(room_service_1.default.ROOM_HISTORY_UPDATE_EVENT,this.onRoomHistoryChangedEvent),this.roomAdminMessageEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event "+room_service_1.default.ROOM_ADMIN_MESSAGE_EVENT+", rehandle it"),this.roomAdminMessageEventHandlerCleaner()),this.roomAdminMessageEventHandlerCleaner=$rootScope.$on(room_service_1.default.ROOM_ADMIN_MESSAGE_EVENT,this.onRoomAdminMessageEvent),this.callUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_CALL_UPDATED_EVENT, rehandle it"),this.callUpdateEventHandlerCleaner()),this.callUpdateEventHandlerCleaner=$rootScope.$on("ON_CALL_UPDATED_EVENT",(_event,call)=>{this.onCallEvent(call)}),this.webRtcCallUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_WEBRTC_GW_CALL_UPDATED_EVENT, rehandle it"),this.webRtcCallUpdateEventHandlerCleaner()),this.webRtcCallUpdateEventHandlerCleaner=$rootScope.$on("ON_WEBRTC_GW_CALL_UPDATED_EVENT",(_event,call)=>{this.onCallEvent(call,!0)}),this.conversationUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_CONVERSATIONS_UPDATED_EVENT, rehandle it"),this.conversationUpdateEventHandlerCleaner()),this.conversationUpdateEventHandlerCleaner=$rootScope.$on("ON_CONVERSATIONS_UPDATED_EVENT",this.onConversationEvent),this.capacityUpdateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_UPDATE_MYCONTACT_EVENT, rehandle it"),this.capacityUpdateEventHandlerCleaner()),this.capacityUpdateEventHandlerCleaner=$rootScope.$on("ON_UPDATE_MYCONTACT_EVENT",this.onMyContactChangedEvent),this.telephonyStateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_TELEPHONY_STATUS_CHANGED_EVENT, rehandle it"),this.telephonyStateEventHandlerCleaner()),this.telephonyStateEventHandlerCleaner=$rootScope.$on("ON_TELEPHONY_STATUS_CHANGED_EVENT",this.onTelephonyStateChangeEvent),this.conferenceStateEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_CONFERENCE_STATE_EVENT, rehandle it"),this.conferenceStateEventHandlerCleaner()),this.conferenceStateEventHandlerCleaner=$rootScope.$on("ON_CONFERENCE_STATE_EVENT",this.onConferenceStateChangeEvent),this.conferenceParticipantsEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_CONFERENCE_PARTICIPANT_EVENT, rehandle it"),this.conferenceParticipantsEventHandlerCleaner()),this.conferenceParticipantsEventHandlerCleaner=$rootScope.$on("ON_CONFERENCE_PARTICIPANT_EVENT",this.onConferenceParticipantChangeEvent),this.reloadCapabilitiesForMyContactEventHandlerCleaner&&(logger_service_1.default.warn("[conversationService] already subscribed to event ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT, rehandle it"),this.reloadCapabilitiesForMyContactEventHandlerCleaner()),this.reloadCapabilitiesForMyContactEventHandlerCleaner=$rootScope.$on("ON_RELOAD_CAPABILITIES_FOR_MY_CONYTACT",this.onReloadCapabilitiesForMyContactEvent),defered.promise},this.attachHandlers=function(){if(this.removeHandlers(),contact_service_1.default.userContact&&!contact_service_1.default.userContact.instantMessagesEnabled)return logger_service_1.default.warn("[conversationService] attachHandlers skipped - instantMessagesEnabled : false"),this.conversationServiceEventHandler=conversationServiceEventHandler_1.ConversationServiceEventHandler.create($rootScope,Conversation,fileServerService,webrtcGatewayService,this),void(this.messageHandlerRef||(this.messageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onChatMessageReceived(stanza),!0}),"jabber:iq:recordingP2P","message","chat")));logger_service_1.default.info("[conversationService] attachHandlers"),this.conversationHistoryHandler=ConversationServiceHistoryHandler.create(this),this.conversationServiceEventHandler=conversationServiceEventHandler_1.ConversationServiceEventHandler.create($rootScope,Conversation,fileServerService,webrtcGatewayService,this),this.conversationServiceBulkHistoryHandler=new conversationServiceBulkHistoryHandler_1.ConversationServiceBulkHistoryHandler(this,fileServerService),xmpp_service_1.default.addHistoryHandler(stanza=>service.conversationHistoryHandler.onHistoryMessageReceived(stanza)),xmpp_service_1.default.addBulkHistoryHandler(stanza=>service.conversationServiceBulkHistoryHandler.onHistoryMessageReceived(stanza)),xmpp_service_1.default.addSearchTextHandler((queryId,stanza)=>{if(service.searchTextConvResults.isCurrentQuery(queryId)){const searchTextItem=service.conversationHistoryHandler.onSearchTextMessageReceived(stanza);searchTextItem&&this.storeSearchTextResult(searchTextItem)}}),this.messageHandlerRef||(this.messageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onChatMessageReceived(stanza),!0}),null,"message","chat")),this.messageMucHandlerRef||(this.messageMucHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onChatMessageReceived(stanza),!0}),null,"message","groupchat")),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onFileMessageReceived(stanza),!0}),null,"message","file")),this.webrtcMessageHandlerRef||(this.webrtcMessageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onWebRTCMessageReceived(stanza),!0}),null,"message","webrtc")),this.convMessageHandlerRef||(this.convMessageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onManagementMessageReceived(stanza),!0}),null,"message","management")),this.receiptMessageHandlerRef||(this.receiptMessageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onReceiptMessageReceived(stanza),!0}),null,"message")),this.audioConfMessageHandlerRef||(this.audioConfMessageHandlerRef=xmpp_service_1.default.addHandler((function(stanza){return service.conversationServiceEventHandler.onConferenceMessageReceived(stanza),!0}),"jabber:x:audioconference","message","chat")),this.aksSharingHandlerRef||(this.aksSharingHandlerRef=xmpp_service_1.default.addHandler(stanza=>(this.onAskSharingMessageReceived(stanza),!0),"http://jabber.org/protocol/commands","iq"))},this.removeHandlers=function(){logger_service_1.default.info("[conversationService] removeHandlers "),this.conversationHistoryHandler&&(this.conversationHistoryHandler=null),this.conversationServiceEventHandler&&(this.conversationServiceEventHandler=null),this.conversationServiceBulkHistoryHandler&&(this.conversationServiceBulkHistoryHandler=null),this.messageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.convMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.convMessageHandlerRef),this.convMessageHandlerRef=null),this.receiptMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.receiptMessageHandlerRef),this.receiptMessageHandlerRef=null),this.messageMucHandlerRef&&(xmpp_service_1.default.deleteHandler(this.messageMucHandlerRef),this.messageMucHandlerRef=null),this.recordingMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null),this.aksSharingHandlerRef&&(xmpp_service_1.default.deleteHandler(this.aksSharingHandlerRef),this.aksSharingHandlerRef=null)},service.stop=function(){return logger_service_1.default.info("[conversationService] === STOPPING ==="),this.conversations=null,this.messageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.fileMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.fileMessageHandlerRef),this.fileMessageHandlerRef=null),this.webrtcMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.webrtcMessageHandlerRef),this.webrtcMessageHandlerRef=null),this.recordingMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.recordingMessageHandlerRef),this.recordingMessageHandlerRef=null),this.audioConfMessageHandlerRef&&(xmpp_service_1.default.deleteHandler(this.audioConfMessageHandlerRef),this.audioConfMessageHandlerRef=null),this.aksSharingHandlerRef&&(xmpp_service_1.default.deleteHandler(this.aksSharingHandlerRef),this.aksSharingHandlerRef=null),this.contactUpdateEventHandlerCleaner&&(this.contactUpdateEventHandlerCleaner(),this.contactUpdateEventHandlerCleaner=null),this.roomUpdateEventHandlerCleaner&&(this.roomUpdateEventHandlerCleaner(),this.roomUpdateEventHandlerCleaner=null),this.roomAddConferenceEventHandlerCleaner&&(this.roomAddConferenceEventHandlerCleaner(),this.roomAddConferenceEventHandlerCleaner=null),this.roomAdminMessageEventHandlerCleaner&&(this.roomAdminMessageEventHandlerCleaner(),this.roomAdminMessageEventHandlerCleaner=null),this.callUpdateEventHandlerCleaner&&(this.callUpdateEventHandlerCleaner(),this.callUpdateEventHandlerCleaner=null),this.conversationUpdateEventHandlerCleaner&&(this.conversationUpdateEventHandlerCleaner(),this.conversationUpdateEventHandlerCleaner=null),this.capacityUpdateEventHandlerCleaner&&(this.capacityUpdateEventHandlerCleaner(),this.capacityUpdateEventHandlerCleaner=null),this.telephonyStateEventHandlerCleaner&&(this.telephonyStateEventHandlerCleaner(),this.telephonyStateEventHandlerCleaner=null),this.reloadCapabilitiesForMyContactEventHandlerCleaner&&(this.reloadCapabilitiesForMyContactEventHandlerCleaner(),this.reloadCapabilitiesForMyContactEventHandlerCleaner=null),this.conferenceParticipantsEventHandlerCleaner&&(this.conferenceParticipantsEventHandlerCleaner(),this.conferenceParticipantsEventHandlerCleaner=null),this.conferenceStateEventHandlerCleaner&&(this.conferenceStateEventHandlerCleaner(),this.conferenceStateEventHandlerCleaner=null),this.webRtcCallUpdateEventHandlerCleaner&&(this.webRtcCallUpdateEventHandlerCleaner(),this.webRtcCallUpdateEventHandlerCleaner=null),this.roomHistoryUpdateEventHandlerCleaner&&(this.roomHistoryUpdateEventHandlerCleaner(),this.roomHistoryUpdateEventHandlerCleaner=null),this.pgiServiceSubscription&&this.pgiServiceSubscription.unsubscribe(),this.started=!1,this.isReinit=!1,logger_service_1.default.info("[conversationService] === STOPPED ==="),$q.when()},service.subscribe=handler=>this.rxSubject.subscribe(handler),service.publish=rbEvent=>{this.rxSubject.next(rbEvent)},this.emojiOneToShort=text=>emojione?emojione.toShort(text):text,service.getServerConversations=()=>__awaiter(this,void 0,void 0,(function*(){if(!contact_service_1.default.userContact||contact_service_1.default.userContact.instantMessagesEnabled)try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${contact_service_1.default.userContact.dbId}/conversations`,response=yield fetch(url,{headers:auth_service_1.default.getRequestHeader()}),conversationsData=(yield response.json()).data;conversationsData.forEach(conversationData=>{conversationData.creationDateSort=conversationData.creationDate?new Date(conversationData.creationDate):void 0,conversationData.lastModificationSort=conversationData.lastMessageDate?new Date(conversationData.lastMessageDate):void 0}),conversationsData.sort(service.sortDataFunction);const maxConversations=auth_service_1.default.fromSDK?3e3:20,conversationPromises=[];conversationsData.forEach((conversationData,index)=>{const missedImCounter=parseInt(conversationData.unreadMessageNumber,10);index>=maxConversations&&0===missedImCounter?service.deleteServerConversation(conversationData.id):(logger_service_1.default.info("getServerConversations -- create conversation "+conversationData.jid_im+" "+conversationData.id),"user"===conversationData.type?conversationPromises.push(service.createOneToOneConversationFromData(conversationData)):conversationPromises.push(service.createRoomConversationFromData(conversationData)))}),yield Promise.all(conversationPromises),this.orderConversations()}catch(error){const errorMessage="getServerConversations -- failure:"+error.message;throw logger_service_1.default.error(errorMessage),new Error(errorMessage)}else logger_service_1.default.warn("[conversationService] getServerConversations skipped - instantMessagesEnabled : false")})),this.createServerConversation=conversation=>$q((resolve,reject)=>{if(conversation.dbId)return void resolve(conversation);const url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contact_service_1.default.userContact.dbId+"/conversations";let data=null;switch(conversation.type){case Conversation.Type.ONE_TO_ONE:data={peerId:conversation.contact.dbId,type:"user"};break;case Conversation.Type.ROOM:data={peerId:conversation.room.dbId,type:"room"};break;case Conversation.Type.BOT:conversation.type=Conversation.Type.ONE_TO_ONE,data={peerId:conversation.contact.dbId,type:"bot"}}$http({method:"POST",url:url,headers:auth_service_1.default.getRequestHeader(),data:data}).then(response=>{conversation.dbId=response.data.data.id,resolve(conversation)}).catch(response=>{let errorMessage="createServerConversation failure: unknown ... ";response.data&&response.data.errorDetails&&(errorMessage="createServerConversation failure: "+response.data.errorDetails),logger_service_1.default.warn("[conversationService] "+errorMessage),reject(new Error(errorMessage))})}),this.deleteServerConversation=function(conversationId){const defered=$q.defer();return conversationId?($http({method:"DELETE",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contact_service_1.default.userContact.dbId+"/conversations/"+conversationId,headers:auth_service_1.default.getRequestHeader()}).then((function(){logger_service_1.default.info("[conversationService] deleteServerConversation success: "+conversationId),service.orderConversations(),defered.resolve()}),(function(response){if(404002===response.data.errorDetailsCode)logger_service_1.default.info("[conversationService] deleteServerConversation success: "+conversationId),defered.resolve();else{const errorMessage="deleteServerConversation failure: "+response.data.errorDetails;logger_service_1.default.warn("[conversationService] "+errorMessage),defered.reject(new Error(errorMessage))}})),defered.promise):$q.when()},this.updateServerConversation=conversation=>{const defered=$q.defer();return conversation?($http({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contact_service_1.default.userContact.dbId+"/conversations/"+conversation.dbId,headers:auth_service_1.default.getPostHeader(),data:{mute:conversation.muted}}).then((function(){logger_service_1.default.info("[conversationService] updateServerConversation success: "+conversation.dbId),defered.resolve()}),(function(response){const errorMessage="updateServerConversation failure: "+response.data.errorDetails;logger_service_1.default.warn("[conversationService] "+errorMessage),defered.reject(new Error(errorMessage))})),defered.promise):$q.when()},this.ackAllMessages=function(conversationDbId,force){return $q((function(resolve,reject){if(!conversationDbId)return logger_service_1.default.error("[conversationService] ackAllMessages for conversation error -- missing conversation id"),void reject();const conversation=service.getConversationByDbId(conversationDbId);if(!conversation)return logger_service_1.default.error("[conversationService] ackAllMessages for conversation error -- can not find conversation"),void reject();if(!conversation.ackReadAllReceivedMessages()&&!force)return logger_service_1.default.info("[conversationService] ackAllMessages for conversation "+conversationDbId+" already updated"),void resolve();logger_service_1.default.info("[conversationService] ackAllMessages for conversation "+conversationDbId),$http({method:"PUT",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+contact_service_1.default.userContact.dbId+"/conversations/"+conversationDbId+"/markallread",headers:auth_service_1.default.getPostHeader()}).then((function(){logger_service_1.default.info("[conversationService] ackAllMessages success: "+conversationDbId),resolve()}),(function(response){const errorMessage="ackAllMessages failure: "+response.data.errorDetails;logger_service_1.default.warn("[conversationService] "+errorMessage),reject(new Error(errorMessage))}))}))},this.getConversationAsyncById=(conversationId,type,dbId="")=>this["room"===type?"getRoomConversation":"getOrCreateOneToOneConversation"](conversationId,dbId),this.createOneToOneConversationFromData=conversationData=>{const missedImCounter=parseInt(conversationData.unreadMessageNumber,10),muted=!0===conversationData.mute;this.getOrCreateOneToOneConversation(conversationData.jid_im,conversationData.id,conversationData.lastMessageDate,conversationData.lastMessageText,missedImCounter,muted,conversationData.creationDate,conversationData.lastMessageSender,conversationData.call,conversationData.replace,conversationData.forwardFrom,conversationData.forwardedMessage)},this.createRoomConversationFromData=conversationData=>{const missedImCounter=parseInt(conversationData.unreadMessageNumber,10),muted=!0===conversationData.mute;return this.getRoomConversation(conversationData.jid_im,conversationData.id,conversationData.lastMessageDate,conversationData.lastMessageText,missedImCounter,!0,muted,conversationData.creationDate,conversationData.lastMessageSender,conversationData.topic,conversationData.type,conversationData.forwardFrom,conversationData.forwardedMessage)},this.getOrCreateTelephonyConversation=call=>{logger_service_1.default.info("getOrCreateTelephonyConversation -- "+call.id);let conv=service.getConversationById(call.id);return call.id&&telephonyService.currentPgiObject&&telephonyService.currentPgiObject.callId&&call.id===telephonyService.currentPgiObject.callId&&(conv=service.getConversationById(telephonyService.currentPgiObject.roomJid)),conv||(conv=new Conversation(call.id),call.isConference?conv.telephonyContacts=call.participants:(conv.contact=call.contact,call.contact.conversation=conv),this.conversations[call.id]=conv),conv},this.getOrCreateOneToOneConversation=(conversationId,conversationDbId,lastModification,lastMessageText,missedIMCounter,muted,creationDate,lastMessageSender,lastCallInfo,replace,forwardFrom,forwardedMessage)=>{if(logger_service_1.default.info("[conversationService] getOrCreateOneToOneConversation "+conversationId+" "+conversationDbId+" "+missedIMCounter),!service.conversationCreationPromise[conversationId]){const conv=service.getConversationById(conversationId);if(conv)return conv.preload=!0,$q.resolve(conv);service.conversationCreationPromise[conversationId]=$q((resolve,reject)=>{contact_service_1.default.getOrCreateContact(conversationId).then(contact=>{const conversation=Conversation.createOneToOneConversation(contact);return conversation.lastModification=lastModification?new Date(lastModification):void 0,conversation.lastCallInfo=lastCallInfo,conversation.replaceLastMsgId=replace,lastMessageText&&(conversation.lastMessageText=service.emojiOneToShort(lastMessageText)),conversation.lastMessageSender=xmpp_service_1.default.getBareJidFromJid(lastMessageSender),conversation.muted=muted,conversation.creationDate=creationDate?new Date(creationDate):new Date,conversation.preload=!1,service.computeCapabilitiesForContact(contact),conversation.dbId=conversationDbId,conversation.missedCounter=missedIMCounter||0,conversation.forwardFrom=forwardFrom,conversation.forwardedMessage=forwardedMessage,service.createServerConversation(conversation)}).then(conversation=>{service.conversations[conversation.contact.id]=conversation,service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.NEW),resolve(conversation),delete service.conversationCreationPromise[conversationId]}).catch(error=>{const errorMessage="getOrCreateOneToOneConversation "+conversationId+" failure "+error.message;logger_service_1.default.error("[conversationService] "+errorMessage),reject(new Error(errorMessage)),delete service.conversationCreationPromise[conversationId]})})}return service.conversationCreationPromise[conversationId]},this.getRoomConversation=function(roomJid,conversationDbId,lastModification,lastMessageText,missedIMCounter,noError,muted,creationDate,lastMessageSender,topic,type,forwardFrom,forwardedMessage){if(contact_service_1.default.userContact&&!contact_service_1.default.userContact.roomsEnabled)return logger_service_1.default.info("[conversationService] === getRoomConversation skipped - roomsEnabled : "+contact_service_1.default.userContact.roomsEnabled),$q.when();if(logger_service_1.default.info("[conversationService] getRoomConversation "+roomJid),!service.conversationCreationPromise[roomJid]){const conv=service.getConversationById(roomJid);if(conv)return conv.preload=!0,$q.resolve(conv);service.conversationCreationPromise[roomJid]=$q((function(resolve,reject){$interval((function(){const room=room_service_1.default.getRoomByJid(roomJid);if(room||"bot"===type)if(room){const conversation=Conversation.createRoomConversation(room);conversation.dbId=conversationDbId,conversation.lastModification=lastModification?new Date(lastModification):void 0,lastMessageText&&(conversation.lastMessageText=service.emojiOneToShort(lastMessageText)),conversation.muted=muted,conversation.creationDate=creationDate?new Date(creationDate):new Date,conversation.preload=!1,conversation.lastMessageSender=xmpp_service_1.default.getBareJidFromJid(lastMessageSender),conversation.forwardFrom=forwardFrom,conversation.forwardedMessage=forwardedMessage,conversation.room&&topic&&(conversation.room.desc=topic),missedIMCounter&&(conversation.missedCounter=missedIMCounter),conversationDbId?(service.conversations[conversation.id]=conversation,service.getRoomConferences(conversation).then((function(){$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.NEW),resolve(conversation),delete service.conversationCreationPromise[roomJid]})).catch((function(error){const errorMessage="getRoomConversation "+roomJid+" failure "+error.message;logger_service_1.default.error("[conversationService] "+errorMessage),reject(new Error(errorMessage)),delete service.conversationCreationPromise[roomJid]}))):service.createServerConversation(conversation).then(createdConv=>{const createdRoom=room_service_1.default.getRoomByJid(roomJid);createdConv.room=createdRoom,service.conversations[createdConv.id]=createdConv,service.orderConversations(),createdRoom&&"unsubscribed"!==createdRoom.status&&createdRoom.isActive&&room_service_1.default.sendInitialRoomPresence(createdRoom),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",createdConv,Conversation.EventType.NEW),resolve(createdConv),delete service.conversationCreationPromise[roomJid]})}else{const obj={jid:roomJid,conversationDbId:conversationDbId,lastModification:lastModification,lastMessageText:lastMessageText?service.emojiOneToShort(lastMessageText):lastMessageText,lastMessageSender:xmpp_service_1.default.getBareJidFromJid(lastMessageSender),missedIMCounter:missedIMCounter,muted:muted,creationDate:creationDate};delete service.conversationCreationPromise[roomJid],service.waitingBotConversations.push(obj),service.unlockWaitingBotConversations(),resolve()}else logger_service_1.default.error("[conversationService] getRoomConversation ("+roomJid+") failure : no such room -- try to get from server and update"),setTimeout(()=>{room_service_1.default.getServerRoomByJid(roomJid).then(newRoom=>{const conversation=Conversation.createRoomConversation(newRoom);conversation.dbId=conversationDbId,conversation.lastModification=lastModification?new Date(lastModification):void 0,lastMessageText&&(conversation.lastMessageText=service.emojiOneToShort(lastMessageText)),conversation.muted=muted,conversation.creationDate=creationDate?new Date(creationDate):new Date,conversation.preload=!1,conversation.lastMessageSender=xmpp_service_1.default.getBareJidFromJid(lastMessageSender),conversation.forwardFrom=forwardFrom,conversation.forwardedMessage=forwardedMessage,conversation.room&&topic&&(conversation.room.desc=topic),missedIMCounter&&(conversation.missedCounter=missedIMCounter),conversationDbId&&(service.conversations[conversation.id]=conversation,$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.NEW),resolve(conversation),delete service.conversationCreationPromise[roomJid]),newRoom&&newRoom.confEndpoints&&newRoom.confEndpoints[0]&&$rootScope.$broadcast("ON_ADD_HOC_COMPLETED",newRoom)}).catch(()=>{logger_service_1.default.error("[conversationService] getRoomConversation ("+roomJid+") failure : no such room at all")})},500)}),1,1)}))}return service.conversationCreationPromise[roomJid]},service.getRoomConferences=function(conversation){return $q((function(resolve){const confEndpoints=conversation.room.confEndpoints;confEndpoints&&confEndpoints.forEach((function(confEndpoint){if("pstnAudio"===confEndpoint.mediaType){const conferenceSession=pgiConference_service_1.default.getConferenceSessionById(confEndpoint.confEndpointId);conferenceSession&&(conversation.pstnConferenceSession=conferenceSession)}})),resolve()}))},service.updateRoomConferences=function(){service.getConversations().forEach((function(conversation){if(conversation.room&&conversation.room.confEndpoints){const conferenceSession=pgiConference_service_1.default.getConferenceSessionById(conversation.room.getPstnConfEndpointId());conversation.pstnConferenceSession=conferenceSession||null;const webConfSession=webConferenceService.getConferenceSessionForRoom(conversation.room.confEndpoints);conversation.webConferenceSession=webConfSession||null}else conversation.pstnConferenceSession=null,conversation.webConferenceSession=null}))},this.closeConversation=conversation=>$q((function(resolve,reject){logger_service_1.default.info("[conversationService] closeConversation "+conversation.id),service.deleteServerConversation(conversation.dbId).then((function(){service.removeConversation(conversation),resolve()})).catch((function(error){reject(error)}))})),this.removeConversation=function(conversation){if(logger_service_1.default.info("[conversationService] remove conversation "+conversation.id),conversation.videoCall&&conversation.videoCall.status!==call_model_1.Call.Status.UNKNOWN)return void logger_service_1.default.info("[conversationService] Ignore conversation deletion message for conversation"+conversation.id);delete service.conversations[conversation.id],service.orderConversations();const conversations=service.getOrderedConversations();!service.activeConversation||conversations.idle.indexOf(service.activeConversation)>=0||(conversations.idle.length>0?service.setActiveConversation(conversations.idle.first()):conversations.inCall.length>0?service.setActiveConversation(conversations.inCall.first()):service.setActiveConversation(null)),conversation.contact&&(conversation.contact.conversation=null,conversation.contact=null),$rootScope.$broadcast("ON_CONVERSATION_REMOVE_EVENT",conversation)},this.getConversationByDbId=function(dbId){if(service.conversations)for(const key in service.conversations)if(service.conversations.hasOwnProperty(key)&&service.conversations[key].dbId===dbId)return service.conversations[key];return null},this.getConversationByRoomDbId=function(roomDbId){if(service.conversations)for(const key in service.conversations)if(service.conversations.hasOwnProperty(key)&&service.conversations[key].room&&service.conversations[key].room.dbId===roomDbId)return service.conversations[key];return null},this.searchConversations=criteria=>{const queries=criteria.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ -]+/);return service.getOrderedConversations().idle.filter(conversation=>{const names=conversation.filterName.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").split(/[ -]+/);return queries.every(query=>names.some((name,index)=>!(!name.length||-1===name.indexOf(query))&&(names[index]="",!0)))})},this.cleanFile=file=>{const stripScripts=s=>{const div=document.createElement("div");div.innerHTML=s;const scripts=div.getElementsByTagName("script");let i=scripts.length;for(;i--;)scripts[i].parentNode.removeChild(scripts[i]);return div.innerHTML};return new Promise(resolve=>{if("image/svg+xml"===file.type){const reader=new FileReader;reader.addEventListener("loadend",e=>{const elem=e.srcElement,cleanblob=new Blob([stripScripts(elem.result)],{type:"image/svg+xml"}),cleanFile=new File([cleanblob],file.name,{type:"image/svg+xml",lastModified:Date.now()});resolve(cleanFile)}),reader.readAsText(file)}else resolve(file)})},this.sendChatMessage=(conversation,textData,alternativeContent=null,answeredMsg=null,mentions=null,urgency=null)=>{const id=Conversation.getUniqueMessageId(),unicodeData=conversation.shortnameToUnicode(textData),isMarkdown=alternativeContent&&"text/markdown"===alternativeContent.type,answeredMsgId=answeredMsg?answeredMsg.id:null,answeredMsgDate=answeredMsg?answeredMsg.date:null,creationDate=new Date,from=contact_service_1.default.userContact,message=conversation.addChatMessage(from,creationDate,unicodeData,id,!0,isMarkdown,null,answeredMsgId,answeredMsgDate,null,alternativeContent,mentions);if(message)return message.urgency=urgency,this.pendingMessages[message.id]={conversation:conversation,message:message},this.sendXmppMessage(conversation,message),message},this.sendChatForwardMessage=(conversation,forwardText,forwardedMessage,origConv)=>__awaiter(this,void 0,void 0,(function*(){let fileDescriptorToSend=null,newForwardedMsg=null;forwardedMessage.fileId&&(fileDescriptorToSend=fileStorage_service_1.default.getFileDescriptorById(forwardedMessage.fileId)),fileDescriptorToSend?(fileDescriptorToSend.ownerId!==contact_service_1.default.userContact.dbId&&(fileDescriptorToSend=yield fileStorage_service_1.default.copyFileToUserCloudStorage(fileDescriptorToSend.id)),this.shareFileToViewer(conversation,fileDescriptorToSend),newForwardedMsg=message_1.Message.createFileSharingMessage(forwardedMessage.id,forwardedMessage.date,forwardedMessage.from,forwardedMessage.side,forwardedMessage.data,forwardedMessage.status,fileDescriptorToSend.id,forwardedMessage.fileName,null,forwardedMessage.geoloc)):newForwardedMsg=message_1.Message.create(forwardedMessage.id,forwardedMessage.date,forwardedMessage.from,forwardedMessage.side,forwardedMessage.data,forwardedMessage.status);const id=Conversation.getUniqueMessageId(),creationDate=new Date,from=contact_service_1.default.userContact,message=conversation.addForwardChatMessage(from,creationDate,id,newForwardedMsg,origConv);message&&(this.pendingMessages[newForwardedMsg.id]={conversation:conversation,newForwardedMsg:newForwardedMsg},this.sendXmppMessage(conversation,message),forwardText&&forwardText.length&&this.sendChatMessage(conversation,forwardText))})),this.shareFileToViewer=(conversation,fileDescriptor)=>__awaiter(this,void 0,void 0,(function*(){if(fileDescriptor)try{const viewerType=0===conversation.type?"user":"room",viewerOrRoomId=0===conversation.type?conversation.contact.dbId:conversation.room.dbId;yield fileStorage_service_1.default.addFileViewer(fileDescriptor.id,viewerOrRoomId,viewerType)}catch(error){throw new Error(error)}})),this.sendFSMessage=(conversation,file,data,voiceMessageData,attachedInfos,urgency=null)=>__awaiter(this,void 0,void 0,(function*(){try{const cleanFile=file;data&&0!==data.length||(data=cleanFile.name);const viewerData=conversation.type===Conversation.Type.ONE_TO_ONE?{viewerId:conversation.contact.dbId,type:"user"}:{viewerId:conversation.room.dbId,type:"room"},viewers=fileViewer_1.FileViewer.createFromData([viewerData]);let fileDescriptor=yield fileStorage_service_1.default.createFileDescriptor(file.name,file.name.split(".").pop(),file.size,viewers,voiceMessageData||!1);fileDescriptor.fileToSend=file,fileDescriptor.isImage()&&file.preview&&(fileDescriptor.previewBlob=file.preview);let message="object"==typeof data?data:void 0;message||(message=conversation.addFSMessage(fileDescriptor.id,data,"uploading",attachedInfos,null,urgency),attachedInfos&&!attachedInfos.attachedMsgId&&(message.attachedMsgId=message.id)),message.fileId=fileDescriptor.id,message.fileName=fileDescriptor.fileName,message.urgency=urgency;try{service.pendingMessages[message.id]={conversation:conversation,message:message},fileDescriptor.setState("uploading"),$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!0}),fileDescriptor=yield fileServerService.uploadAFileByChunk(fileDescriptor,file,message,null),fileDescriptor.setState("uploaded"),fileDescriptor.chunkPerformed=0,fileDescriptor.chunkTotalNumber=0,$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor}),this.sendXmppMessage(conversation,message,fileDescriptor)}catch(error){throw logger_service_1.default.error("[conversationService] sendFSMessage -- uploadAFile error"),attachedInfos||fileStorage_service_1.default.deleteFileDescriptor(fileDescriptor.id),fileDescriptor.setState("uploadError"),message.receiptStatus=message_1.Message.ReceiptStatus.ERROR,message.fileErrorMsg=error.translatedMessage?error.translatedMessage:"Unable to share file",message.sendUpdateEvent(),error}return message}catch(error){let msgKey=error.translatedMessage?error.translatedMessage:"Unable to share file";throw 403153===error.errorDetailsCode&&(msgKey=i18n_service_1.default.translate("fileSharingNoMoreAllowedMsg")),$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"fileTransfer",popupBodyTranslated:msgKey,okLabel:"ok"}),new Error(error)}})),this.sendEFSMessage=(conversation,fileDescriptor,data,attachedInfos,geoLoc=null,urgency=null)=>__awaiter(this,void 0,void 0,(function*(){let message=null;try{data&&0!==data.length||(data=fileDescriptor.fileName),message=conversation.addFSMessage(fileDescriptor.id,data,fileDescriptor.state,attachedInfos,geoLoc,urgency),message.fileName=fileDescriptor.fileName,attachedInfos&&!message.attachedMsgId&&(message.attachedMsgId=message.id);const viewerType=conversation.type===Conversation.Type.ONE_TO_ONE?"user":"room",viewerOrRoomId=conversation.type===Conversation.Type.ONE_TO_ONE?conversation.contact.dbId:conversation.room.dbId;return yield fileStorage_service_1.default.addFileViewer(fileDescriptor.id,viewerOrRoomId,viewerType),this.sendXmppMessage(conversation,message,fileDescriptor),this.pendingMessages[message.id]={conversation:conversation,message:message},$rootScope.$broadcast("ON_SEND_EFS_MESSAGE",fileDescriptor),message}catch(error){message.receiptStatus=message_1.Message.ReceiptStatus.ERROR,message.sendUpdateEvent()}})),this.sendXmppMessage=(conversation,message,fileDescriptor=null)=>{if(!message)return null;const id=message.id,unicodeData=conversation.shortnameToUnicode(message.data),to=conversation.type===Conversation.Type.ONE_TO_ONE?conversation.contact.jid:conversation.room.jid,type=conversation.type===Conversation.Type.ONE_TO_ONE?"chat":"groupchat",xmppMessage=strophe_js_1.$msg({to:to,type:type,id:id,"xml:lang":contact_service_1.default.currentLanguage});return xmppMessage.c("body",{"xml:lang":contact_service_1.default.currentLanguage}).t(unicodeData).up(),xmppMessage.c("store",{xmlns:"urn:xmpp:hints"}).up(),xmppMessage.c("request",{xmlns:Conversation.ReceiptNS}).up(),xmppMessage.c("active",{xmlns:Conversation.ChatstatesNS}).up(),fileDescriptor&&(xmppMessage.c("x",{xmlns:"jabber:x:oob",index:message.attachIndex,count:message.attachNumber}).c("url",{},config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+fileDescriptor.id).c("mime",{},fileDescriptor.typeMIME).c("filename",{},fileDescriptor.fileName).c("size",{},fileDescriptor.size).up(),message.fileId=fileDescriptor.id,fileDescriptor.tags&&"voicemail"===fileDescriptor.tags.purpose&&xmppMessage.c("voicemessage",{xmlns:"http://jabber.org/protocol/voicemessage"}).up()),message.attachedMsgId&&xmppMessage.c("attach-to",{xmlns:"urn:xmpp:message-attaching:1",id:message.attachedMsgId}).up(),message.geoloc&&xmppMessage.c("geoLoc",{xmlns:"http://jabber.org/protocol/geoloc"}).c("lat",message.geoloc.lat).c("lon",message.geoloc.lon),message.alternativeContent&&xmppMessage.c("content",{xmlns:Conversation.contentNS,type:message.alternativeContent.type}).t(message.alternativeContent.message).up(),message.answeredMsgId&&xmppMessage.c("answeredMsg",{stamp:message.answeredMsgDate.getTime()}).t(message.answeredMsgId).up(),message.attention&&message.attention.length&&(xmppMessage.c("mention",{xmlns:Conversation.AttentionNS}),message.attention.forEach(jidMentioned=>{xmppMessage.c("jid",null,jidMentioned)})),message.urgency&&"std"!==message.urgency&&xmppMessage.c("headers",{xmlns:"http://jabber.org/protocol/shim"}).c("header",{name:"Urgency"}).t(message.urgency).up().up(),message.forwardedMsg&&this.addXmppForwardMessage(conversation,xmppMessage,message),message.serverAckTimer=setTimeout(()=>{message.receiptStatus=message_1.Message.ReceiptStatus.ERROR,message.sendUpdateEvent()},1e4),message.setReceiptStatus(message_1.Message.ReceiptStatus.SENT),message.sendUpdateEvent(),xmpp_service_1.default.send(xmppMessage),conversation.room&&(conversation.room.lastActivityDate=new Date),message},this.addXmppForwardMessage=(conversation,xmppMessage,message)=>{xmppMessage.c("forwarded",{xmlns:Conversation.FORWARDNS});const unicodeData=conversation.shortnameToUnicode(message.forwardedMsg.data),from=message.forwardedMsg.from.fullJid?message.forwardedMsg.from.fullJid:message.forwardedMsg.from.jid;xmppMessage.c("message",{from:from,id:message.forwardedMsg.id,type:message.forwardConvType,xmlns:"jabber:client"}),xmppMessage.c("body",{"xml:lang":contact_service_1.default.currentLanguage}).t(unicodeData).up();const fileDescriptor=fileStorage_service_1.default.getFileDescriptorById(message.forwardedMsg.fileId);fileDescriptor&&(xmppMessage.c("x",{xmlns:"jabber:x:oob",index:message.attachIndex,count:message.attachNumber}).c("url",{},"uploaded"===fileDescriptor.state?config.restServerUrl+"/api/rainbow/fileserver/v1.0/files/"+fileDescriptor.id:"").c("mime",{},fileDescriptor.typeMIME).c("filename",{},fileDescriptor.fileName).c("size",{},fileDescriptor.size).up(),fileDescriptor.tags&&"voicemail"===fileDescriptor.tags.purpose&&xmppMessage.c("voicemessage",{xmlns:"http://jabber.org/protocol/voicemessage"}).up()),message.forwardedMsg.geoloc&&xmppMessage.c("geoLoc",{xmlns:"http://jabber.org/protocol/geoloc"}).c("lat",message.forwardedMsg.geoloc.lat).up().c("lon",message.forwardedMsg.geoloc.lon).up().up(),message.answeredMsgId&&xmppMessage.c("answeredMsg",{stamp:message.forwardedMsg.answeredMsgDate.getTime()}).t(message.forwardedMsg.answeredMsgId).up(),xmppMessage.up(),xmppMessage.up()},this.sendAckReadOrReceivedMessage=(conversation,id,event)=>{logger_service_1.default.info(`[ConversationService] ${conversation.id} send ${event} status for message ${id}`);const to=conversation.type===Conversation.Type.ONE_TO_ONE?conversation.contact.jid:conversation.room.jid,type=conversation.type===Conversation.Type.ONE_TO_ONE?"chat":"groupchat",from=contact_service_1.default.userContact.jid,receivedAttr={xmlns:Conversation.ReceiptNS,id:id,event:event,entity:"client"};conversation.type!==Conversation.Type.ONE_TO_ONE&&(receivedAttr.type="muc"),xmpp_service_1.default.send(strophe_js_1.$msg({to:to,from:from,type:type}).c("received",receivedAttr))},this.sendAckReceivedMessage=(conversation,message)=>{message.receiptStatus>=message_1.Message.ReceiptStatus.UNREAD||(this.sendAckReadOrReceivedMessage(conversation,message.id,"received"),message.setReceiptStatus(message_1.Message.ReceiptStatus.UNREAD))},this.sendAckReadMessage=(conversation,message)=>{message.receiptStatus!==message_1.Message.ReceiptStatus.READ&&(this.sendAckReadOrReceivedMessage(conversation,message.id,"read"),message.setReceiptStatus(message_1.Message.ReceiptStatus.READ),message.replaceMsgs&&message.replaceMsgs.length&&message.replaceMsgs.forEach(msg=>{this.sendAckReadOrReceivedMessage(conversation,msg.id,"read")}))},this.sendAckReadMessages=conversation=>{logger_service_1.default.info(`[ConversationService] ${conversation.id} sendAckReadMessages`);let result=!1;return conversation.messages.forEach(message=>{message.receiptStatus!==message_1.Message.ReceiptStatus.SENT&&message.receiptStatus!==message_1.Message.ReceiptStatus.UNREAD||message.side!==message_1.Message.Side.LEFT&&message.side!==message_1.Message.Side.ADMIN||(this.sendAckReadMessage(conversation,message),result=!0)}),result},this.sendChatStatus=(conversation,status)=>{if(logger_service_1.default.info(`[ConversationService] ${conversation.id} setStatus ${status.value}`),conversation.status===status)return;conversation.status=status;const to=conversation.type===Conversation.Type.ONE_TO_ONE?conversation.contact.jid:conversation.room.jid,type=conversation.type===Conversation.Type.ONE_TO_ONE?"chat":"groupchat";xmpp_service_1.default.send(strophe_js_1.$msg({to:to,type:type}).c(status.value,{xmlns:Conversation.ChatstatesNS}))},this.sendIsTypingState=function(conversation,isTypingState){const id=Conversation.getUniqueMessageId(),state=isTypingState?"composing":"active",to=conversation.type===Conversation.Type.ONE_TO_ONE?conversation.contact.jid:conversation.room.jid,type=conversation.type===Conversation.Type.ONE_TO_ONE?"chat":"groupchat",lang=contact_service_1.default.currentLanguage;xmpp_service_1.default.send(strophe_js_1.$msg({to:to,type:type,id:id,"xml:lang":lang}).c(state,{xmlns:Conversation.ChatstatesNS}).up())},this.sendRecordingMessage=(conversation,data)=>{const id=Conversation.getUniqueMessageId(),to=conversation.contact.jid,unicodeData=conversation.shortnameToUnicode(data),lang=contact_service_1.default.currentLanguage,message=conversation.addRecordingMessage(contact_service_1.default.userContact,new Date,unicodeData,id);if(!message)return null;const xmppMessage=strophe_js_1.$msg({to:to,type:"chat",id:id,"xml:lang":lang}).c("body",{"xml:lang":lang}).up().c("recording",{xmlns:"jabber:iq:recordingP2P"}).t(unicodeData).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up();return message.serverAckTimer=setTimeout(()=>{message.receiptStatus=message_1.Message.ReceiptStatus.ERROR,message.sendUpdateEvent()},1e4),xmpp_service_1.default.send(xmppMessage),this.pendingMessages[message.id]={conversation:conversation,message:message},message},this.sendCorrectedChatMessage=(conversation,data,origMsgId)=>{const originalMessage=conversation.getMessageById(origMsgId);if(!originalMessage)return logger_service_1.default.info("[conversationService] sendCorrectedChatMessage - originila message not found"),null;if(originalMessage.from.jid!==contact_service_1.default.userContact.jid)return logger_service_1.default.info("[conversationService] sendCorrectedChatMessage forbidden Action - only sent messages can be modified"),null;if(conversation.lastEditableMsg.id!==originalMessage.id)return logger_service_1.default.info("[conversationService] sendCorrectedChatMessage forbidden Action - only last sent message can be modified"),null;this.sendAckReadMessages(conversation);const id=Conversation.getUniqueMessageId(),to=conversation.type===Conversation.Type.ONE_TO_ONE?conversation.contact.jid:conversation.room.jid,type=conversation.type===Conversation.Type.ONE_TO_ONE?"chat":"groupchat",unicodeData=conversation.shortnameToUnicode(data),lang=contact_service_1.default.currentLanguage,xmppMessage=strophe_js_1.$msg({to:to,type:type,id:id,"xml:lang":lang}).c("body",{"xml:lang":contact_service_1.default.currentLanguage}).t(unicodeData).up().c("replace",{id:origMsgId,xmlns:"urn:xmpp:message-correct:0"}).up().c("store",{xmlns:"urn:xmpp:hints"}).up().c("request",{xmlns:Conversation.ReceiptNS}).up().c("active",{xmlns:Conversation.ChatstatesNS}).up();return originalMessage.serverAckTimer=setTimeout(()=>{originalMessage.receiptStatus=message_1.Message.ReceiptStatus.ERROR,originalMessage.sendUpdateEvent()},1e4),originalMessage.addReplaceMsg(id,data),xmpp_service_1.default.send(xmppMessage),conversation.room&&(conversation.room.lastActivityDate=new Date),conversation.updateAfterReplaceEvent(originalMessage),this.pendingMessages[id]={conversation:conversation,message:originalMessage},originalMessage},this.removeAllMessages=function(conversation){logger_service_1.default.info("[conversationService] removeAllMessage "+conversation.id);const defered=$q.defer(),mamRequest={queryid:xmpp_service_1.default.connection.getUniqueId(),with:conversation.id,onComplete:function(){defered.resolve()}},queryId=xmpp_service_1.default.connection.getUniqueId();return xmpp_service_1.default.connection.mam.delete(queryId,mamRequest),defered.promise},this.removeMessagesFromConversation=function(conversation,date,number){logger_service_1.default.info("[conversationService] removeMessagesFromConversation "+conversation.id),logger_service_1.default.info("[conversationService] removing "+number+" messages after "+date);const defered=$q.defer(),mamRequest={queryid:"remove_"+conversation.id,with:conversation.id,start:moment(date).format("YYYY-MM-DDTHH:mm:ss.SSSSSSZ"),max:number,onComplete:function(){logger_service_1.default.info("[conversationService] MAM Message deleted !!!"),defered.resolve()}};return xmpp_service_1.default.connection.mam.delete(conversation.id,mamRequest),defered.promise},this.sendConversationByEmail=function(conversation){const defered=$q.defer(),userContact=contact_service_1.default.userContact,url=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+userContact.dbId+"/conversations/"+conversation.dbId+"/downloads";return $http({method:"POST",url:url,headers:auth_service_1.default.getRequestHeader(),data:{}}).then(()=>{logger_service_1.default.error("[conversationService] sendConversationByEmail - success"),defered.resolve()},response=>{const error={message:"Impossible to download conversation",messageKey:null};response&&response.data&&409011===response.data.errorDetailsCode&&(error.message="No messages to export for the last 30 days.",error.messageKey="noMessagesToExport"),logger_service_1.default.error("[adminUserService] sendConversationByEmail - "+error.message),defered.reject(error)}),defered.promise},this.getHistoryPage=(conversation,size)=>service.isReinit?(logger_service_1.default.debug("[conversationService] getHistoryPage --- service is reinitialising !"),$q.reject(new Error("Service is reinitialising !"))):service.conversationServiceBulkHistoryHandler.getHistoryPage(conversation,size),this.retrieveMsgByDate=(conversation,msgDate)=>(logger_service_1.default.debug("[conversationService] >retrieveMsgByDate: "+msgDate),service.conversationHistoryHandler.retrieveMsgByDate(conversation,msgDate+"000")),this.searchTextInRoomsAndConversations=searchedText=>__awaiter(this,void 0,void 0,(function*(){try{this.searchTextConvResults.clearAll(),this.searchTextConvResults.isSearching=!0,yield Promise.all([this.searchTextInConversations(searchedText),this.searchTextInRooms(searchedText)]),this.searchTextConvResults.isSearching=!1}catch(error){this.searchTextConvResults.isSearching=!1}})),this.searchTextInConversations=searchedText=>__awaiter(this,void 0,void 0,(function*(){const queryId=xmpp_service_1.default.connection.getUniqueId();this.searchTextConvResults.queryIds.push(queryId),this.searchTextConvResults.searchedText=searchedText,yield service.conversationHistoryHandler.searchTextInConversations(queryId,searchedText),Object.keys(this.searchTextConvResults.partResults).forEach(jid=>{const result=this.searchTextConvResults.partResults[jid];result.room||contact_service_1.default.getOrCreateContact(jid).then(contact=>{result.contact=contact,this.sortResults(result),this.searchTextConvResults.totalCount+=result.convRes.length,this.searchTextConvResults.results.push(result),delete this.searchTextConvResults.partResults[jid]})})})),this.searchTextInRooms=searchedText=>__awaiter(this,void 0,void 0,(function*(){const promisesArray=room_service_1.default.getRooms().map(room=>room.desc&&room.desc.startsWith("Rainbow_OutlookCreation_InternalUseOnly")?Promise.resolve():this.searchTextInConversation(searchedText,!1,room.jid,"room"));yield Promise.all(promisesArray)})),this.searchTextInConversation=(searchedText,clear,conversationId,type=null)=>__awaiter(this,void 0,void 0,(function*(){clear&&this.searchTextConvResults.clearAll();const queryId=xmpp_service_1.default.connection.getUniqueId();this.searchTextConvResults.searchedText=searchedText,this.searchTextConvResults.queryIds.push(queryId);const searchMethodName="room"===type?"searchTextResultsInRoom":"searchTextResultsInConversation",count=yield service.conversationHistoryHandler[searchMethodName](queryId,searchedText,conversationId),result=this.searchTextConvResults.partResults[conversationId];result&&(result.totalCount=count,this.sortResults(result),this.searchTextConvResults.totalCount+=count,this.searchTextConvResults.results.push(result),delete this.searchTextConvResults.partResults[conversationId])})),this.storeSearchTextResult=searchTextMsgResult=>{const jid=searchTextMsgResult.otherJid;if(searchTextMsgResult.body.startsWith("/img"))return;let partialSearchTextResult=this.searchTextConvResults.partResults[jid];partialSearchTextResult||(partialSearchTextResult=new searchTextConvResults_1.SearchTextResult(jid),searchTextMsgResult.isRoom&&(partialSearchTextResult.room=room_service_1.default.getRoomByJid(jid)),this.searchTextConvResults.partResults[jid]=partialSearchTextResult),partialSearchTextResult.addMsgItem(searchTextMsgResult),partialSearchTextResult.totalCount++},this.sortResults=searchTextResult=>{searchTextResult.convRes.sort((res1,res2)=>res1.date?res2.date?res1.date-res2.date:1:-1)},this.setActiveConversation=function(conversation){return logger_service_1.default.debug("[conversationService] - setActiveConversation: "+(conversation?conversation.id:"null")),this.activeConversation=conversation,this.activeConversation},this.setMostRecentConversationActive=function(){const conversations=service.getConversations().sort(service.sortFunction);return conversations.length>0?this.setActiveConversation(conversations.first()):this.setActiveConversation(null)},this.getActiveConversation=function(){return this.activeConversation},this.getConversationById=function(conversationId){return service.conversations?service.conversations[conversationId]:null},this.getConversations=function(){const conversationArray=[];for(const key in service.conversations)service.conversations.hasOwnProperty(key)&&conversationArray.push(service.conversations[key]);return conversationArray},this.orderConversations=()=>{service.inCallConversations=[],service.idleConversations=[],service.involvedContactIds=[],Object.keys(service.conversations).forEach(key=>{const conversation=service.conversations[key];if(conversation.type===Conversation.Type.ROOM&&conversation.room.owner&&conversation.room.isMeetingRoom()){const confSession=pgiConference_service_1.default.getConferenceSessionById(conversation.room.getPstnConfEndpointId());if(confSession&&confSession.active)return void service.inCallConversations.push(conversation)}conversation.isInCall()?service.inCallConversations.push(conversation):service.idleConversations.push(conversation),conversation.type===Conversation.Type.ONE_TO_ONE&&service.involvedContactIds.push(conversation.contact.id)}),service.idleConversations.sort(service.sortFunction),service.publish(event_model_1.RBEvent.create("reorder"))},this.getOrderedConversations=function(){return{inCall:service.inCallConversations,idle:service.idleConversations,contactIds:service.involvedContactIds}},this.sortFunction=(aa,bb)=>{const aDate=!aa.lastModification&&aa.creationDate?aa.creationDate:aa.lastModification;return(!bb.lastModification&&bb.creationDate?bb.creationDate:bb.lastModification)-aDate},this.sortDataFunction=(aa,bb)=>{const aDate=!aa.lastModificationSort&&aa.creationDateSort?aa.creationDateSort:aa.lastModificationSort;return(!bb.lastModificationSort&&bb.creationDateSort?bb.creationDateSort:bb.lastModificationSort)-aDate},this.formatDate=date=>moment(date).utc().format("YYYY-MM-DDTHH:mm:ss")+"Z",this.resetConversationMissedCounters=function(conversation){$rootScope.appVisible&&(conversation.missedCounter=0,conversation.missedCalls=0,this.updateMissedCounters())},this.decreaseMissedIMCounterForConversation=function(conversation){conversation.missedCounter>0&&(conversation.missedCounter-=1),this.updateMissedCounters()},this.updateMissedCounters=function(){let missedIMCounter=0;const missedIMDetails=[];Object.keys(service.conversations).forEach((function(key){const conversation=service.conversations[key];0!==conversation.missedCounter&&(missedIMCounter+=conversation.missedCounter,missedIMDetails.push(conversation))})),missedIMCounter===this.currentMissedIMCounter&&0===this.currentMissedCallCounter||(this.currentMissedIMCounter=missedIMCounter,this.currentMissedCallCounter=0,$rootScope.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:missedIMCounter,missedCallCounter:0,missedIMDetails:missedIMDetails}))},this.dropConversationCall=function(conversation){conversation.audioCall&&telephonyService.releaseCall(conversation.audioCall),conversation.videoCall&&(videoService.attachLocalMediaStream(!1),videoService.attachDistantMediaStream(!1),videoService.releaseCall(conversation.videoCall))},this.holdConversationCall=function(conversation){conversation.audioCall&&(telephonyService.holdCall(conversation.audioCall),conversation.videoCall&&(videoService.attachLocalMediaStream(!1),videoService.attachDistantMediaStream(!1),videoService.releaseCall(conversation.videoCall)))},this.retrieveConversationCall=function(conversation){conversation.audioCall&&telephonyService.retrieveCall(conversation.audioCall),conversation.videoCall&&logger_service_1.default.error("Not implemented for the moment")},this.allowDesktopSharing=()=>!1,this.allowAdvancedDesktopSharing=()=>!1,this.updateConversationCall=(conversation,call)=>{call.type===call_model_1.Call.Type.WEBRTC?conversation.videoCall=call:call.type===call_model_1.Call.Type.PHONE&&(conversation.audioCall=call),call.setConversationId(conversation.id),!call.isConference&&conversation.contact&&this.computeCapabilitiesForContact(conversation.contact),this.computeCapabilitiesForMyContact()},this.computeCapabilitiesForContact=(contact,skipUpdateConversation)=>{let telephony=!1,webRTC=!1,sharedDesktop=!1,fileTransfert=!1,addMedia=!1;const contactStatus=contact.status,fullJid=contact.fullJid,myContact=contact_service_1.default.userContact;if(contact.jid===myContact.jid)return void this.computeCapabilitiesForMyContact();const isContactInMyCompany=contact.company&&contact_service_1.default.userContact.company&&"Rainbow"!==contact.company.name&&"Default"!==contact.company.name&&contact.company.name===contact_service_1.default.userContact.company.name,conversation=this.getConversationById(contact.id);if(videoService.started){const videoCall=conversation?conversation.videoCall:null;videoCall&&videoCall.status!==call_model_1.Call.Status.UNKNOWN||!(("unknown"===contactStatus||"wait"===contactStatus)&&isContactInMyCompany||"online"===contactStatus||"online-mobile"===contactStatus||"away"===contactStatus||"busy"===contactStatus&&"audioPhone"===contact.message)||(contact.webrtcAudioEnabled&&(webRTC=!0),sharedDesktop=!0)}if(telephonyService.started){const phoneNumberAvailable=contact.phonePro||contact.phonePbx&&contact.pbxId||contact.mobilePro||contact.phonePerso||contact.mobilePerso,audioCalls=telephonyService.getActiveCallsForContact(contact);0===audioCalls.length&&phoneNumberAvailable&&(telephony=!0),(0!==audioCalls.length||videoService.getMediaPillarAudioCall())&&fullJid&&(addMedia=!0)}"online"!==contactStatus&&"busy"!==contactStatus&&"away"!==contactStatus&&"dnd"!==contactStatus||(fileTransfert=!0);let capabilities={telephony:telephony,webRTC:webRTC,sharedDesktop:sharedDesktop,fileTransfert:fileTransfert,mediaAvailable:telephony||webRTC,addMedia:addMedia};(contact.isBot||contact.displayName&&-1!==contact.displayName.indexOf("E-HELPER"))&&(capabilities={telephony:!1,webRTC:!1,sharedDesktop:!1,fileTransfert:!1,mediaAvailable:!1,addMedia:!1}),contact.capabilities=capabilities,conversation&&(conversation.capabilities=capabilities,skipUpdateConversation||$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT",conversation,Conversation.EventType.CAPABILITIES))},this.computeCapabilitiesForMyContact=function(){let telephony=!1,webRTC=!1,sharedDesktop=!1;const myContact=contact_service_1.default.userContact;if(videoService.started){const isInCallWebRtc=videoService.isUserContactInCall();isInCallWebRtc||"busy"===myContact.status&&("busy"!==myContact.status||"audioPhone"!==myContact.message)||(myContact.webrtcAudioEnabled&&(webRTC=!0),service.allowDesktopSharing()&&(sharedDesktop=!0)),isInCallWebRtc&&videoService.getMediaPillarAudioCall()&&!videoService.getCurrentSharingCall()&&service.allowDesktopSharing()&&(sharedDesktop=!0)}if(telephonyService.started){const calls=telephonyService.getCalls();webrtcGatewayService.isMediaPillarCallSituation()&&Object.keys(videoService.calls).length>=1?telephony=!!(calls.length>=1&&service.isSecondCallAllowed):(0===calls.length&&service.isBasicCallAllowed||1===calls.length&&service.isSecondCallAllowed)&&(telephony=!0)}const capabilities={telephony:telephony,webRTC:webRTC,sharedDesktop:sharedDesktop,mediaAvailable:telephony||webRTC};logger_service_1.default.debug("[ConversationService] computeCapabilitiesForMyContact  capabilities "+JSON.stringify(capabilities)),myContact.capabilities=capabilities},this.onCallEvent=(call,fromWebRtcGW=!1)=>{switch(call.type){case call_model_1.Call.Type.WEBRTC:this.handleWebRtcCallEvent(call);break;case call_model_1.Call.Type.PHONE:this.handleTelephonyCallEvent(call,fromWebRtcGW)}},this.handleWebRtcCallEvent=call=>__awaiter(this,void 0,void 0,(function*(){if(webrtcGatewayService.isMediaPillarJid(call.fullJid)){if($rootScope.$broadcast("ON_MPMEDIA_CONVERSATION_CALL_UPDATED_EVENT",{call:call}),call.status===call_model_1.Call.Status.ACTIVE&&call.mediaPillarCall){(call.mediaPillarCall.telephonyCallRefs||[]).forEach(telCall=>{if(null!==telCall&&telCall.type.value===call_model_1.Call.Type.PHONE.value){const conversation=this.getConversationById(telCall.conversationId);conversation&&conversation.rxSubject.next({name:"callUpdate",value:call})}})}call.status!==call_model_1.Call.Status.RINGING_INCOMMING&&(this.computeCapabilitiesForMyContact(),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call}))}else service.getOrCreateOneToOneConversation(call.contact.id).then(conversation=>{service.updateConversationCall(conversation,call),service.orderConversations(),conversation.rxSubject.next({name:"callUpdate",value:call}),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:conversation,call:call})})})),this.isTempTelephonyConversation=call=>!call.contact||call.contact.temp||call.isConference||contact_service_1.default.isUserContact(call.contact),this.handleTelephonyCallEvent=(call,fromWebRtcGW=!1)=>__awaiter(this,void 0,void 0,(function*(){if(call.status===call_model_1.Call.Status.UNKNOWN){if(call.conversationId){if(call.conversationId===call.id){const conv=this.getConversationById(call.id);conv&&this.removeConversation(conv),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call})}else{const conv=this.getConversationById(call.conversationId);conv&&(logger_service_1.default.info("[ConversationService] onCallEvent call "+call.id+" conversation "+call.conversationId+" : set inactive"),conv.audioCall=null),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:conv,call:call})}this.orderConversations();const phoneCalls=telephonyService.getCalls();if(1===phoneCalls.length&&phoneCalls[0]&&(phoneCalls[0].status===call_model_1.Call.Status.HOLD||phoneCalls[0].status===call_model_1.Call.Status.PUT_ON_HOLD||phoneCalls[0].status===call_model_1.Call.Status.ACTIVE)){const remainingCall=phoneCalls[0],remainingConversation=!remainingCall.contact||remainingCall.contact.temp||remainingCall.contact.jid===contact_service_1.default.userContact.jid?this.getOrCreateTelephonyConversation(remainingCall):this.getConversationById(remainingCall.contact.id);remainingConversation&&setTimeout(()=>{this.publish(event_model_1.RBEvent.create("activeConversation",remainingConversation))},200)}}call.contact&&!telephonyService.getConferenceCallForContact(call.contact)&&videoService.endAllCallsForContact(call.contact),call.isConference&&setTimeout(()=>{(call.participants||[]).forEach(participantContact=>{participantContact&&0===telephonyService.getActiveCallsForContact(participantContact).length&&videoService.endAllCallsForContact(participantContact)})},1e3)}if(!fromWebRtcGW&&webrtcGatewayService.isMediaPillarCallSituation(call)){if(!call.isSecondary)return void $rootScope.$broadcast("ON_UPDATE_TELEPHONY_ICON_EVENT");if(call.status===call_model_1.Call.Status.RINGING_INCOMMING&&"MAKECALL"!==call.lastCause&&"CALLBACK"!==call.lastCause)return}if(call.status!==call_model_1.Call.Status.UNKNOWN&&null!==call.connectionId){if(!this.isSecondCallAllowed){const calls=telephonyService.getNotIdleCalls();if(calls.length>1&&calls.findIndex(calliter=>calliter.id===call.id)>0)return}const isTempConversation=this.isTempTelephonyConversation(call);logger_service_1.default.info("[ConversationService] onCallEvent -- "+call.connectionId+"  -- relevantEquipmentId : "+call.relevantEquipmentId+" "+(call.status?call.status.value:"null")+" isTempConversation: "+isTempConversation);let conversation=isTempConversation?this.getOrCreateTelephonyConversation(call):this.getConversationById(call.contact.id);if(conversation||(conversation=isTempConversation?this.getOrCreateTelephonyConversation(call):yield this.getOrCreateOneToOneConversation(call.contact.id)),isTempConversation&&conversation.contact&&call.contact&&(call.contact.firstname||call.contact.lastname)&&conversation.contact.updateName(call.contact.firstname,call.contact.lastname),isTempConversation&&!call.isConference&&call.conversationId===call.id&&!conversation.contact&&conversation.telephonyContacts&&(logger_service_1.default.info("[ConversationService] onCallEvent -- "+call.connectionId+" : remove prevous conference conversation "+call.id),this.removeConversation(conversation),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call}),conversation=this.getOrCreateTelephonyConversation(call)),call.conversationId&&call.conversationId!==conversation.id)if(call.conversationId===call.id)!isTempConversation&&this.conversations[call.id]&&(logger_service_1.default.info("[ConversationService] onCallEvent -- "+call.connectionId+" : remove prevous temp conversation "+call.id),delete this.conversations[call.id]);else{const previousConv=this.getConversationById(call.conversationId);previousConv&&(logger_service_1.default.info("[ConversationService] onCallEvent -- "+call.connectionId+" : set previous conversation to known rainbow contact inactive "+call.conversationId),previousConv.audioCall=null,$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:previousConv,call:call}))}this.updateConversationCall(conversation,call),call.status!==call_model_1.Call.Status.ACTIVE&&call.status!==call_model_1.Call.Status.DIALING&&call.status!==call_model_1.Call.Status.RINGING_OUTGOING||setTimeout(()=>{this.publish(event_model_1.RBEvent.create("activeConversation",conversation))},200),this.orderConversations(),$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:conversation,call:call}),conversation.rxSubject.next({name:"callUpdate",value:call});if(call.getDeviceIdFromConnectionIdFromCall()!==call.relevantEquipmentId&&call.status!==call_model_1.Call.Status.ACTIVE)return void $rootScope.$broadcast("ON_UPDATE_TELEPHONY_ICON_EVENT")}call.status!==call_model_1.Call.Status.ERROR||call.connectionId||this.publish(event_model_1.RBEvent.create("callError",call))})),this.onPGiConferenceStateEvent=active=>__awaiter(this,void 0,void 0,(function*(){if(active)try{const currentMeetingRoom=yield room_service_1.default.retrieveCurrentPersonalAudioRoom();yield this.getRoomConversation(currentMeetingRoom.jid)}catch(error){logger_service_1.default.debug("[conversationService] error handling pgi conference event")}service.orderConversations()})),this.onReloadCapabilitiesForMyContactEvent=function(__event){logger_service_1.default.info("[conversationService] onReloadCapabilitiesForMyContactEvent"),service.computeCapabilitiesForMyContact()},this.onConversationEvent=function(){service.updateMissedCounters()},this.onContactChangedEvent=function(__event,contact){service.computeCapabilitiesForContact(contact),service.computeCapabilitiesForMyContact()},this.onTelephonyStateChangeEvent=function(__event){const conversations=service.getConversations();conversations&&conversations.forEach((function(conversation){conversation.type===Conversation.Type.ONE_TO_ONE&&service.computeCapabilitiesForContact(conversation.contact)})),service.computeCapabilitiesForMyContact()},this.onConferenceStateChangeEvent=function(){service.updateRoomConferences(),service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onConferenceParticipantChangeEvent=function(){service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onRoomChangedEvent=function(__event,room,action){if(room){const conversation=service.getConversationById(room.jid);conversation&&("remove"===action?service.closeConversation(conversation):conversation.room=room)}},this.onRoomHistoryChangedEvent=function(__event,room){if(room){const conversation=service.getConversationById(room.jid);conversation&&conversation.chatRenderer&&(conversation.reset(),conversation.chatRenderer.loadMore())}},this.onRoomAdminMessageEvent=function(__event,roomJid,userJid,type,msgId){logger_service_1.default.info("[conversationService] onRoomAdminMessageEvent");const conversation=service.getConversationById(roomJid);conversation&&"welcome"===type&&conversation.room&&conversation.room.ownerContact&&(userJid=conversation.room.ownerContact.jid);const contact=contact_service_1.default.getContactByJid(userJid);if(conversation&&contact){if(!conversation.room.owner&&"invitation"===type)return;if(conversation.room&&conversation.room.isMeetingRoom())return;service.conversationServiceEventHandler.onRoomAdminMessageReceived(conversation,contact,type,msgId)}},this.onRoomAddConferenceEvent=function(__event){logger_service_1.default.info("[conversationService] onRoomAddConferenceEvent"),service.updateRoomConferences(),service.orderConversations(),$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")},this.onMyContactChangedEvent=function(){service.getOrderedConversations().idle.forEach((function(conversation){conversation.type===Conversation.Type.ONE_TO_ONE&&service.computeCapabilitiesForContact(conversation.contact)})),service.computeCapabilitiesForMyContact()},this.reinit=function(){const defered=$q.defer();return logger_service_1.default.info("[conversationService] Re-initialize conversation service"),service.activeConversation&&(service.activeConversation.reset(),service.activeConversation=null),delete service.conversations,service.conversations=[],service.conversationCreationPromise||(service.conversationCreationPromise={}),service.botServiceReady=!0,service.isReinit=!0,logger_service_1.default.info("[conversationService] getServerConversations"),service.getServerConversations().then((function(){service.isReinit=!1,service.linkAllActiveCallsToConversations(),$rootScope.$broadcast("ON_MISSED_COUNTER_CHANGED_EVENT",{missedIMCounter:this.currentMissedIMCounter,missedCallCounter:this.currentMissedCallCounter}),defered.resolve()})).catch((function(){service.isReinit=!1,$interval((function(){logger_service_1.default.info("[conversationService] getServerConversations failure, try again"),service.getServerConversations().then((function(){service.linkAllActiveCallsToConversations()}))}),1e4,1,!0),defered.resolve()})),defered.promise},this.linkAllActiveCallsToConversations=function(){for(const key in telephonyService.calls)if(telephonyService.calls.hasOwnProperty(key)){const call=telephonyService.calls[key];$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}for(const key in videoService.calls)if(videoService.calls.hasOwnProperty(key)){const call=videoService.calls[key];$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}},this.unlockWaitingBotConversations=function(isBotServiceReady){isBotServiceReady&&(service.botServiceReady=!0),service.botServiceReady&&(service.waitingBotConversations.forEach((function(obj,index){const contact=contact_service_1.default.getContactByJid(obj.jid);contact&&(service.getOrCreateOneToOneConversation(contact.jid,obj.conversationDbId,obj.lastModification,obj.lastMessageText,obj.missedIMCounter,obj.muted,obj.creationDate),service.waitingBotConversations.splice(index,1))})),service.waitingBotConversations=[])},this.askForSharing=(convId,contact)=>__awaiter(this,void 0,void 0,(function*(){const message=$iq({from:xmpp_service_1.default.jid,to:contact.fullJid,type:"set"});message.c("command",{xmlns:"http://jabber.org/protocol/commands",node:"request-transfert-sharing",convId:convId}),yield xmpp_service_1.default.sendIQ(message)})),this.acceptTransfertSharing=(convId,contact)=>__awaiter(this,void 0,void 0,(function*(){const message=$iq({from:xmpp_service_1.default.jid,to:contact.fullJid,type:"set"});message.c("command",{xmlns:"http://jabber.org/protocol/commands",node:"accept-transfert-sharing",convId:convId}),yield xmpp_service_1.default.sendIQ(message)})),this.refuseTransfertSharing=(convId,contact)=>__awaiter(this,void 0,void 0,(function*(){const message=$iq({from:xmpp_service_1.default.jid,to:contact.fullJid,type:"set"});message.c("command",{xmlns:"http://jabber.org/protocol/commands",node:"refuse-transfert-sharing",convId:convId}),yield xmpp_service_1.default.sendIQ(message)})),this.onAskSharingMessageReceived=stanza=>{try{const stanzaElem=$(stanza),from=stanzaElem.attr("from"),fromContact=contact_service_1.default.getContactByJid(xmpp_service_1.default.getBareJidFromJid(from)),commandElem=stanzaElem.find("command"),conversationId=commandElem.attr("convId"),conversation=this.getConversationById(conversationId);if(commandElem.length>0)switch(commandElem.attr("node")){case"request-transfert-sharing":conversation.rxSubject.next({name:"request-transfert-sharing",fromContact:fromContact});break;case"accept-transfert-sharing":conversation.rxSubject.next({name:"accept-transfert-sharing",fromContact:fromContact});break;case"refuse-transfert-sharing":conversation.rxSubject.next({name:"refuse-transfert-sharing",fromContact:fromContact})}}catch(error){return!0}return!0},this.cleanUnwantedConversations=()=>{Object.keys(service.conversations).forEach(key=>{const conversation=service.conversations[key];conversation.type===Conversation.Type.ROOM&&(!contact_service_1.default.userContact.roomsEnabled||conversation.room&&conversation.room.isMeetingRoom()&&!contact_service_1.default.userContact.phoneMeetingsEnabled)&&(logger_service_1.default.info("cleanUnwantedConversations -- close conversation "+conversation.id+" due to customisation limitation"),service.closeConversation(conversation))})}}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FilePublicDownload=void 0;const rxjs_1=__webpack_require__(10);class FilePublicDownload{constructor(url=null,fileName=null,totalBytes=null,receivedBytes=null,savePath=null){this.url=url,this.fileName=fileName,this.totalBytes=totalBytes,this.receivedBytes=receivedBytes,this.savePath=savePath,this.isCanceled=!1,this.openFolderOnceDownloadFinished=!1,this.progressSubject=new rxjs_1.Subject}static create(url,fileName,totalBytes,receivedBytes,savePath){return new FilePublicDownload(url,fileName,totalBytes,receivedBytes,savePath)}isDownloadFinished(){return this.receivedBytes===this.totalBytes}askCancel(){this.isCanceled=!0,this.progressSubject.next()}}exports.FilePublicDownload=FilePublicDownload},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConversationServiceBulkHistoryHandler=void 0;const message_1=__webpack_require__(16),strophe_js_1=__webpack_require__(76),moment=__webpack_require__(3);__webpack_require__(227);const contact_service_1=__webpack_require__(1),xmpp_service_1=__webpack_require__(4),i18n_service_1=__webpack_require__(37),logger_service_1=__webpack_require__(15),fileStorage_service_1=__webpack_require__(25);exports.ConversationServiceBulkHistoryHandler=class{constructor(conversationService,fileServerService){this.conversationService=conversationService,this.fileServerService=fileServerService,this.xmppService=xmpp_service_1.default,this.i18n=i18n_service_1.default,this.logger=logger_service_1.default,this.contactService=contact_service_1.default,this.fileStorageService=fileStorage_service_1.default}getHistoryPage(conversation,nbMessage){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(`[ConversationServiceBulkHistoryHandler] getHistoryPage(${conversation.id})`);try{return this.getHistoryPageInternal(conversation,nbMessage)}catch(error){return this.logger.info("[ConversationServiceBulkHistoryHandler] "+error.message),null}}))}getHistoryPageAroundMessage(conversation,messageHistoryIndex){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(`[ConversationServiceBulkHistoryHandler] getHistoryPageAroundDate(${conversation.id}, ${messageHistoryIndex})`),yield this.getHistoryPageInternal(conversation,15,"after",messageHistoryIndex),yield this.getHistoryPageInternal(conversation,15,"before",messageHistoryIndex)}))}getHistoryPageInternal(conversation,nbMessages,direction="before",messageHistoryIndex=null){return __awaiter(this,void 0,void 0,(function*(){this.logger.info(`[ConversationServiceBulkHistoryHandler] getHistoryPage(${conversation.id}, ${nbMessages})`);const resultPromise=new Promise((resolve,reject)=>{conversation.historyDefered={resolve:resolve}});if(conversation.room&&conversation.room.initPresPromise&&(yield conversation.room.initPresPromise.promise),conversation.currentHistoryId&&conversation.currentHistoryId===conversation.historyIndex){const errorMessage=`getHistoryPage(${conversation.id}, ${nbMessages}, ${conversation.historyIndex}) --- already asked`;throw this.logger.info("[ConversationServiceBulkHistoryHandler] "+errorMessage),new Error(errorMessage)}if(conversation.currentHistoryId=conversation.historyIndex,conversation.historyComplete){const errorMessage=`getHistoryPage(${conversation.id}) --- complete`;throw this.logger.info("[ConversationServiceBulkHistoryHandler] "+errorMessage),new Error(errorMessage)}const queryId=conversation.id,iqId=this.xmppService.connection.getUniqueId(),toAttr=conversation.room?conversation.room.jid:null,withField=conversation.room?this.contactService.userContact.jid:conversation.id,iq=strophe_js_1.$iq({id:iqId,to:toAttr,type:"set"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:1:bulk"}).c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"with"}).c("value").t(withField).up().up().up().c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(nbMessages).up();if(messageHistoryIndex){const historyRefDate="after"===direction?Number(messageHistoryIndex)-1:messageHistoryIndex;iq.c(direction).t(historyRefDate)}else-1===conversation.historyIndex?iq.c(direction).t(""):iq.c(direction).t(conversation.historyIndex);const startRequestDate=performance.now();yield this.xmppService.sendIQ(iq);const requestDuration=Math.round(performance.now()-startRequestDate);return yield resultPromise,this.logger.info(`[ConversationServiceBulkHistoryHandler] getHistoryPage(${conversation.id}) -- duration ${requestDuration}ms`),conversation}))}resetHistory(conversation){const nbMessages=conversation.messages.length;if(nbMessages>30){this.logger.info("[ConversationServiceBulkHistoryHandler] resetHistory for conversation "+conversation.id);const nbMessageToRemove=nbMessages-30;conversation.messages.splice(0,nbMessageToRemove),conversation.currentHistoryId=null,conversation.historyComplete=!1,conversation.historyIndex=conversation.messages[0].historyIndex}}onHistoryMessageReceived(stanza){try{this.logger.info("[conversationService] onHistoryMessageReceived");const resultsElem=$(stanza).find("results");if(1===resultsElem.length){const resultElems=resultsElem.find("result");if(resultElems.length>0){const queryId=$(resultElems[0]).attr("queryid");this.logger.info(`[ConversationServiceBulkHistoryHandler] onHistoryMessageReceived "results" (${queryId})`);const conversation=this.conversationService.getConversationById(queryId);conversation&&resultsElem.find("result").each((__index,resultElem)=>{let messageElem=$(resultElem).find("forwarded message");const from=messageElem.attr("from"),forwardedMsg=$(messageElem).find("forwarded[xmlns='urn:xmpp:forward:0']");if(forwardedMsg&&forwardedMsg.length){this.logger.info("[ConversationServiceHistoryHandler] ("+conversation.id+") Forwarded Message detected");const origMsgId=messageElem.attr("id");messageElem=$(forwardedMsg).find("forwarded message"),this.createMessage(conversation,resultElem,messageElem,from,origMsgId,!0)}else this.createMessage(conversation,resultElem,messageElem,from,null,!1)})}}else{const finElem=$(stanza).find("fin"),queryId=finElem.attr("queryid");this.logger.info(`[ConversationServiceBulkHistoryHandler] onHistoryMessageReceived "fin" (${queryId})`);const conversation=this.conversationService.getConversationById(queryId);if(conversation){if(conversation.historyComplete="true"===finElem.attr("complete"),conversation.historyIndex=$(finElem).find("set first").text(),conversation.messages.unshift.apply(conversation.messages,conversation.historyMessages),conversation.historyMessages=[],conversation.lastMessageText="",conversation.lastMessageSender=null,conversation.messages&&conversation.messages.length>0){const lastMessage=conversation.messages[conversation.messages.length-1];conversation.lastMessageText=lastMessage.data,conversation.lastMessageSender=lastMessage.from.id}conversation.historyDefered&&conversation.historyDefered.resolve()}}}catch(error){return this.logger.error("[ConversationServiceBulkHistoryHandler] onHistoryMessageReceived -- failure -- "+error),!0}return!0}createMessage(conversation,resultElem,messageElem,from,origMsgId,isForwardedMsg){const messageId=origMsgId||messageElem.attr("id");this.logger.info("[ConversationServiceHistoryHandler] : createMessage - searching for message "+messageId);let message=conversation.getMessageById(messageId);if(message||(message=conversation.historyMessages.find(item=>item.id===messageId)),message||(message=conversation.getReplacedMessageById(messageId)),message)return void this.logger.info("[ConversationServiceHistoryHandler] ("+conversation.id+") try to add an already stored message with id "+message.id);let fromContact=null,type=messageElem.attr("type"),fromJid=from&&0===from.indexOf("room_")?from.split("/")[1]:this.xmppService.getBareJidFromJid(from),roomEvent=null;if(!fromJid){const eventElem=$(resultElem).find("event");if(eventElem.length){if(fromJid=eventElem.attr("jid"),roomEvent=eventElem.attr("name"),conversation.room){if(conversation.room.isMeetingRoom()&&("welcome"===roomEvent||"conferenceAdd"===roomEvent||"conferenceRemove"===roomEvent||"invitation"===roomEvent))return;if("welcome"===roomEvent&&conversation.room.ownerContact&&(fromJid=conversation.room.ownerContact.jid),("conferenceAdd"===roomEvent||"conferenceRemove"===roomEvent)&&conversation.room.ownerContact){const user=conversation.room.getUserByJid(fromJid);fromContact=user&&user.contact?user.contact:conversation.room.ownerContact}}type="admin"}}if(!fromJid)return void this.logger.warn("[ConversationServiceBulkHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information");if("webrtc"===type){const callerJid=$(resultElem).find("caller").text();fromContact=this.contactService.getContact(callerJid)}fromContact||(fromContact=this.contactService.getContact(fromJid)),fromContact||(fromContact=this.contactService.createEmptyContact(fromJid));const date=new Date($(resultElem).find("forwarded delay").attr("stamp"));let body=$(messageElem).find("body").text();const side=this.contactService.isUserContact(fromContact)?message_1.Message.Side.RIGHT:message_1.Message.Side.LEFT,geoloc=$(resultElem).find("geoloc");let geolocData=null;if(geoloc&&geoloc.length){const geolocElem=$(geoloc);geolocData={lon:geolocElem.find("lon").text(),lat:geolocElem.find("lat").text()}}let urgency="std";const headersElem=$(messageElem).find("headers[xmlns='http://jabber.org/protocol/shim']");if(headersElem&&headersElem.length){const urgencyElem=$(headersElem).find("header[name='Urgency']");urgencyElem&&urgencyElem.length&&(urgency=urgencyElem.text())}const oob=$(messageElem).find("x[xmlns='jabber:x:oob']");if(oob&&oob.length&&(type="fileSharing"),$(resultElem).find("call_log").length){const state=$(resultElem).find("state").text();if("missed"===state)body="missedCall||"+date;else if("answered"===state){const duration=$(resultElem).find("duration")?parseInt($(resultElem).find("duration").text(),10):0,textDuration=duration>0?`(${moment.duration(duration,"ms").format("h[H] mm[m] ss[s]")})`:"";body=`activeCallMsg||${date}||${textDuration}`}}switch(type){case"webrtc":message=message_1.Message.createWebRTCMessage(messageId,date,fromContact,side,body,!1);break;case"admin":message=message_1.Message.createBubbleAdminMessage(messageId,date,fromContact,roomEvent);break;case"fileSharing":message=this.createFileSharingMessage(oob,messageId,date,fromContact,side,body,geolocData);break;case"recording":break;default:{const contents=$(resultElem).find("content[xmlns='urn:xmpp:content']");let isMarkdown=!1,additionalContent=null;contents&&contents.each((_ind,content)=>{additionalContent||(additionalContent={});const contentType=$(content).attr("type"),contentMessage=$(content).text();"text/markdown"===contentType&&(isMarkdown=!0,body=contentMessage),additionalContent[contentType]={type:contentType,message:contentMessage}});const replace=$(resultElem).find("replace");if(replace&&replace.length){const replacedMsgId=replace.attr("id");let replacedMessage=conversation.getMessageByIdInHistory(replacedMsgId);if(replacedMessage||(replacedMessage=conversation.getMessageById(replacedMsgId)),replacedMessage||(replacedMessage=message_1.Message.create(replacedMsgId,date,fromContact,side,body,!1,isMarkdown,additionalContent,null,null,null),message=replacedMessage),fromContact.jid!==replacedMessage.from.jid)this.logger.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived : message Replaced by somebody else - Skip"),message=null;else if(replacedMessage){replacedMessage.addReplaceMsg(messageId,body);const logBody=body.length?body.substr(0,1)+"***"+body.substr(body.length-1):"";this.logger.info("Add new history replace message for message "+messageId+" witn body "+logBody)}}else{const answeredMsg=$(resultElem).find("answeredMsg"),answeredMsgId=answeredMsg?answeredMsg.text():null,answeredMsgDate=answeredMsg?answeredMsg.attr("stamp"):null;if(message=message_1.Message.create(messageId,date,fromContact,side,body,!1,isMarkdown,additionalContent,null,answeredMsgId,answeredMsgDate),message.urgency=urgency,answeredMsgId){const answeredMessage=conversation.getMessageByIdInHistory(answeredMsgId);answeredMessage?(answeredMessage.urgencyAck=!0,answeredMessage.sendUpdateEvent()):this.logger.error("[ConversationServiceEventHandler] Not possible to handle answeredMsg because replied msg not found")}}}}if(message){message.isForwarded=isForwardedMsg,message.urgency=urgency,message.historyIndex=$(resultElem).attr("id");const ack=$(messageElem).find("ack");message.receiptStatus="true"===$(ack).attr("read")?5:"true"===$(ack).attr("recv")?4:3,conversation.addMessageInHistoryMessages(message),this.logger.info("Add new history message : "+message.getInfoForLogs())}}createFileSharingMessage(oob,messageId,date,from,side,body,geoloc,attention=null){const oobElem=$(oob),url=oobElem.find("url").text(),fileName=oobElem.find("filename").text(),fileId=this.fileStorageService.extractFileIdFromUrl(url),message=message_1.Message.createFileSharingMessage(messageId,date,from,side,body,!1,fileId,fileName,null,geoloc,attention);return this.fileStorageService.retrieveAndStoreOneFileDescriptor(fileId).then(fileDescriptor=>{fileDescriptor&&"not_uploaded"===fileDescriptor.state&&(message.receiptStatus=1,message.fileErrorMsg=this.i18n.translate("file_notuploaded")),this.fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then(blob=>{fileDescriptor.previewBlob=blob,fileDescriptor.previewBlobSubject.next(fileDescriptor.previewBlob)}).catch(()=>{this.logger.info("[ConversationServiceBulkHistoryHandler] getBlobThumbnailFromFileDescriptor error "),fileDescriptor.previewBlobSubject.next(fileDescriptor.previewBlob)})}).catch(error=>{this.logger.info("[ConversationServiceBulkHistoryHandler] createFileSharingMessage error "+error)}),message}}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.NgPgiConferenceService=exports.MEDIATYPE=void 0;const BehaviorSubject_1=__webpack_require__(66),distinctUntilChanged_1=__webpack_require__(75),conference_endpoint_model_1=__webpack_require__(333),conference_session_model_1=__webpack_require__(334),conference_participant_model_1=__webpack_require__(228),_escape=__webpack_require__(59),event_service_1=__webpack_require__(32),Subject_1=__webpack_require__(67),ReplaySubject_1=__webpack_require__(335),logger_service_1=__webpack_require__(15),contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),country_service_1=__webpack_require__(63),profile_service_1=__webpack_require__(8),room_service_1=__webpack_require__(33),i18n_service_1=__webpack_require__(37),errorHelper_service_1=__webpack_require__(39);var MEDIATYPE;!function(MEDIATYPE){MEDIATYPE.PSTNAUDIO="pstnAudio",MEDIATYPE.WEBRTC="webrtc",MEDIATYPE.WEBRTCSHARINGONLY="webrtcSharingOnly"}(MEDIATYPE=exports.MEDIATYPE||(exports.MEDIATYPE={}));exports.NgPgiConferenceService=class{constructor(){this.eventService=event_service_1.default,this.logger=logger_service_1.default,this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.countryService=country_service_1.default,this.profileService=profile_service_1.default,this.contactService=contact_service_1.default,this.roomService=room_service_1.default,this.i18n=i18n_service_1.default,this.conferenceEndpoints={},this.conferenceEnpointsSubject=new Subject_1.Subject,this.conferenceSessions={},this.conferenceSessionsSubject=new ReplaySubject_1.ReplaySubject,this.started=!1,this.isPstnConferenceAvailable=!1,this.isPstnConferenceAvailableSubject=new BehaviorSubject_1.BehaviorSubject(this.isPstnConferenceAvailable),this.pstnConferencePhoneNumbers=null,this.startedSubject=new BehaviorSubject_1.BehaviorSubject(!1)}start(stats){this.logger.info("=== STARTING ===");const startDate=performance.now();this.confProvPortalURL=new URL(config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/"),this.confPortalURL=new URL(config.restServerUrl+"/api/rainbow/conference/v1.0/"),this.attachHandlers(),this.computePstnConferencePremission(),this.isPstnConferenceAvailableSubject.pipe(distinctUntilChanged_1.distinctUntilChanged()).subscribe(isPstnConferenceAvailable=>{isPstnConferenceAvailable&&this.initializeServiceData()}),this.started=!0;const startDuration=Math.round(performance.now()-startDate);stats.push({service:"PgiConferenceService",startDuration:startDuration}),this.logger.info(`=== STARTED (${startDuration} ms) ===`),this.startedSubject.next(!0),this.contactService.userContact.phoneMeetingsEnabledSubject.pipe(distinctUntilChanged_1.distinctUntilChanged()).subscribe(phoneMeetingsEnabled=>{phoneMeetingsEnabled||this.stop()})}stop(){this.logger.info(""),this.logger.info("[PgiConferenceService] === STOPPING ==="),this.isPstnConferenceAvailable=!1,this.started=!1,this.logger.info("[PgiConferenceService] === STOPPED ==="),this.startedSubject.next(!1)}reconnectService(){this.logger.info("reconnectService"),this.attachHandlers(),this.refreshConferenceSessions()}attachHandlers(){this.xmppManagementHandler&&(this.xmppService.deleteHandler(this.xmppManagementHandler),this.xmppManagementHandler=null),this.xmppManagementHandler=this.xmppService.addHandler(stanza=>(this.onManagementMessage(stanza),!0),null,"message","management"),this.conferenceHandler&&(this.xmppService.connection.deleteHandler(this.conferenceHandler),this.conferenceHandler=null),this.conferenceHandler=this.xmppService.connection.addHandler(stanza=>(this.onConferenceMessage(stanza),!0),"jabber:iq:conference","message",null)}onManagementMessage(stanza){const stanzaElem=$(stanza);stanzaElem.find("confuseractivated ").length>0&&this.setPstnConferenceAvailability(this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED));const confendpointElem=stanzaElem.find("confendpoint");if(confendpointElem.length&&"update"===confendpointElem.attr("action")){this.logger.info("onManagementMessage - update of conference");const conferenceId=stanzaElem.find("confendpointid").text();this.retrieveConference(conferenceId,!0)}}onConferenceMessage(stanza){const stanzaElem=$(stanza),conferenceId=stanzaElem.find("conference-id").text(),conferenceSession=this.getConferenceSessionById(conferenceId);conferenceSession&&this.updateConferenceSession(stanzaElem,conferenceSession)}updateConferenceSession(stanzaElem,conferenceSession){this.logger.info("updateConferenceSession - "+conferenceSession.id);const conferenceStateElem=stanzaElem.find("conference-state");if(conferenceStateElem.length){const isConferenceActive="true"===conferenceStateElem.find("active").text();this.updateState(conferenceSession,isConferenceActive)}const talkersElem=stanzaElem.find("talkers");if(talkersElem.length){const talkers=[];talkersElem.find("participant-id").each((__index,talker)=>{const talkerParticipantId=$(talker).text();talkers.push(talkerParticipantId)}),this.logger.debug("update talkers with: "+talkers),conferenceSession.updateTalkers(talkers)}let participantsElem=stanzaElem.find("participants");if(0===participantsElem.length&&(participantsElem=stanzaElem.find("updated-participants")),participantsElem.length||(participantsElem=stanzaElem.find("added-participants")),participantsElem.length){const participants=[];participantsElem.find("participant").each((__index,participant)=>{const participantElem=$(participant),participantId=participantElem.find("participant-id").text(),jid_im=participantElem.find("jid-im").text(),phoneNumber=participantElem.find("phone-number").text(),role=participantElem.find("role").text(),mute=participantElem.find("mute").text(),hold=participantElem.find("hold").text(),cnxState=participantElem.find("cnx-state").text();participants.push({participantId:participantId,jid_im:jid_im,phoneNumber:phoneNumber,participantRole:role,mute:"on"===mute,held:"on"===hold,participantState:cnxState})}),participants.length&&(conferenceSession.participants=participants)}const removedParticipantsElem=stanzaElem.find("removed-participants");if(removedParticipantsElem.length){const removedParticipants=[];removedParticipantsElem.find("participant-id").each((__index,removedParticipant)=>{const removedParticipantId=$(removedParticipant).text();removedParticipants.push(removedParticipantId)}),this.logger.debug("remove participants: "+removedParticipants),conferenceSession.removeParticipants(removedParticipants)}this.conferenceSessionsSubject.next({id:conferenceSession.id,action:"updated"})}updateState(conferenceSession,isConferenceActive,lock=!1){return __awaiter(this,void 0,void 0,(function*(){if(conferenceSession.active&&!isConferenceActive){if(this.contactService.userContact.guestMode&&conferenceSession.type!==MEDIATYPE.WEBRTCSHARINGONLY)return this.eventService.publish("ON_OPEN_POPUP","concludeInvitation"),conferenceSession.cleanupSessionData(),void conferenceSession.updateStateFromData(isConferenceActive,lock);const room=this.roomService.findRoomsWithConfId(conferenceSession.id)[0];if(room)if(room.owner&&conferenceSession.id===this.getPstnInstantConferenceEndpointId())try{const currentRoomsCount=yield this.roomService.retrieveRoomConsumption();currentRoomsCount>this.profileService.getFeatureLimitMax(this.profileService.FeaturesEnum.BUBBLE_COUNT)?(this.eventService.publish("ON_OPEN_GLOBAL_POPUP",{popupTitle:"createBubble",popupBody:"maxCollabSpaceReached",okLabel:"ok"}),yield this.roomService.deletePersonalMeetingRoom()):room.isMyPersonalMeetingRoom()&&this.eventService.publish("ON_SHOW_POPUP",{component:"renameMeeting",data:room})}catch(error){}else if(!room.owner&&conferenceSession.isParticipantConnectedByJid(this.contactService.userContact.dbId)){const displayName=_escape(room.ownerContact.displayName),roomName=_escape(room.name),message=this.i18n.translate("meetingEndBy",{owner:displayName,meeting:roomName});this.eventService.publish("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}conferenceSession.cleanupSessionData()}conferenceSession.updateStateFromData(isConferenceActive,lock)}))}initializeServiceData(){return __awaiter(this,void 0,void 0,(function*(){try{yield this.retrievePstnConferences(),yield this.makeSnapshots(),this.logger.info("service data initialized")}catch(__e){this.logger.warn("service data init failed")}}))}setPstnConferenceAvailability(conferenceAvailable){this.isPstnConferenceAvailable&&!conferenceAvailable&&this.eventService.publish("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"pgiRightsRemovedWarning",okLabel:"ok"}),this.isPstnConferenceAvailable=conferenceAvailable,this.isPstnConferenceAvailableSubject.next(this.isPstnConferenceAvailable)}computePstnConferencePremission(){let isConferenceProvisioningOnGoing=!0;this.profileService.getProfilesByName("conference").filter(profile=>"active"===profile.status).forEach(profile=>{profile.provisioningNeeded&&profile.provisioningNeeded.length&&profile.provisioningNeeded.forEach(provisioning=>{-1!==provisioning.providerType.toLowerCase().indexOf("pgi")&&(isConferenceProvisioningOnGoing=provisioning.provisioningOngoing,isConferenceProvisioningOnGoing&&this.logger.info("computePstnConferencePremission - pgi provisioning on going"))})}),this.setPstnConferenceAvailability(this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CONFERENCE_ALLOWED)&&!isConferenceProvisioningOnGoing)}makeSnapshots(){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("makeSnapshots");const conferenceEndpointIds=[];for(const key in this.conferenceEndpoints)if(this.conferenceEndpoints[key]){const conferenceEndpoint=this.conferenceEndpoints[key];conferenceEndpoint&&(this.logger.info("makeSnapshots -- "+conferenceEndpoint.id),conferenceEndpointIds.push(conferenceEndpoint.id))}yield Promise.all(conferenceEndpointIds.map(conferenceEndpointId=>__awaiter(this,void 0,void 0,(function*(){try{yield this.makeSnapshotForConfId(conferenceEndpointId)}catch(__e){}})))),this.logger.info("makeSnapshots -- SUCCESS")}catch(__e){this.logger.info("makeSnapshots -- ERROR")}}))}makeSnapshotForConfId(confId){return __awaiter(this,void 0,void 0,(function*(){if(!confId){const error=new Error("makeSnapshotForConfId - No confId !!");throw this.logger.error(error.message),error}try{const confSession=this.conferenceSessions[confId];if(confSession&&confSession.active&&confSession.haveJoined)return this.logger.debug("makeSnapshotForConfId skipped, already joined"),confSession;const serverUrl=new URL(`conferences/${confId}/snapshot`,this.confPortalURL),headers=this.authService.getRequestHeader(),response=yield fetch(serverUrl.href,{method:"GET",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const snapshotData=(yield response.json()).data;return this.updateOrCreateConferenceSession(confId,snapshotData),snapshotData}catch(error){this.conferenceSessions[confId]&&(this.logger.debug("makeSnapshotForConfId failed - remove conferenceSession "+confId),this.removeConferenceSession(confId));const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"makeSnapshotForConfId");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}removeConferenceSession(confId){confId&&(this.logger.debug("removeConferenceSession "+confId),delete this.conferenceSessions[confId],this.conferenceSessionsSubject.next({id:confId,action:"deleted"}))}updateOrCreateConferenceSession(confId,snapshotData){if(this.logger.debug("updateOrCreateConferenceSession for "+confId),!confId||!snapshotData)return this.logger.warn("updateOrCreateConferenceSession - Not enough data"),null;let conferenceSession=this.conferenceSessions[confId];return conferenceSession?(snapshotData.active!==conferenceSession.active&&(this.logger.debug("updateOrCreateConferenceSession - state update to "+(snapshotData.active?"active":"inactive")),conferenceSession.active=snapshotData.active,this.conferenceSessionsSubject.next({id:confId,action:"updated"})),snapshotData.participants&&(this.logger.debug(`updateOrCreateConferenceSession - update participants for ${confId} with:\n${JSON.stringify(snapshotData.participants)}`),conferenceSession.participants=snapshotData.participants.map(participantData=>conference_participant_model_1.ConferenceParticipant.createFromData(participantData)),this.conferenceSessionsSubject.next({id:confId,action:"updated"}))):(this.logger.debug(`updateOrCreateConferenceSession - create new conferencesession with id ${confId} and data: \n${JSON.stringify(snapshotData)}`),conferenceSession=conference_session_model_1.ConferenceSession.createFromData(confId,snapshotData.participants,snapshotData.active,MEDIATYPE.PSTNAUDIO),this.conferenceSessions[confId]=conferenceSession,this.conferenceSessionsSubject.next({id:confId,action:"created"})),conferenceSession}updateConference(confEndpointId,confData){return __awaiter(this,void 0,void 0,(function*(){try{if(this.logger.info("updateConference"),!confEndpointId){const errorMessage="updateConference failure: No confEndpoint";throw this.logger.error("updateConference failure : No confEndpoint"),new Error(errorMessage)}const serverUrl=new URL("conferences/"+confEndpointId,this.confProvPortalURL),headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const response=yield fetch(serverUrl.href,{method:"PUT",headers:headers,body:JSON.stringify(confData)});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const conferenceData=(yield response.json()).data,conference=this.updateOrCreatePstnConferenceEndpoint(conferenceData);return this.logger.info("updateConference SUCCESS"),conference}catch(__e){throw this.logger.error("updateConference ERROR"),__e}}))}getPstnInstantConferenceEndpoint(){return this.conferenceEndpoints[Object.keys(this.conferenceEndpoints)[0]]}getPstnInstantConferenceEndpointId(){return this.conferenceEndpoints[Object.keys(this.conferenceEndpoints)[0]]?this.conferenceEndpoints[Object.keys(this.conferenceEndpoints)[0]].id:null}retrievePstnConferences(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.logger.info("retrievePstnConferences"),!this.isPstnConferenceAvailable)throw this.logger.warn("retrievePstnConferences - user is not allowed"),new Error("notAllowed");const serverUrl=new URL("conferences",this.confProvPortalURL);serverUrl.searchParams.set("format","full"),serverUrl.searchParams.set("userId",this.contactService.userContact.dbId),serverUrl.searchParams.set("scheduled","false"),serverUrl.searchParams.set("mediaType",MEDIATYPE.PSTNAUDIO);const headers=this.authService.getRequestHeader(),response=yield fetch(serverUrl.href,{method:"GET",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const conferencesProvisionData=(yield response.json()).data;for(const conferenceData of conferencesProvisionData)conferenceData&&conferenceData.mediaType===MEDIATYPE.PSTNAUDIO&&this.updateOrCreatePstnConferenceEndpoint(conferenceData);return this.logger.info("retrievePstnConferences successfully"),conferencesProvisionData}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrievePstnConferences");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}retrieveConference(confId,force=!1){return __awaiter(this,void 0,void 0,(function*(){if(!confId){const error=new Error("retrieveConference - missing parameter");throw this.logger.error(error.message),error}try{if(this.logger.info("retrieveConference - "+confId),this.conferenceEndpoints[confId]&&!force)return this.conferenceEndpoints[confId];const serverUrl=new URL("conferences/"+confId,this.confProvPortalURL),headers=this.authService.getRequestHeader(),response=yield fetch(serverUrl.href,{method:"GET",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const conferenceData=(yield response.json()).data;return conferenceData&&Object.prototype.hasOwnProperty.call(conferenceData,"id")?this.updateOrCreatePstnConferenceEndpoint(conferenceData):conferenceData}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrieveConference");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}updateOrCreatePstnConferenceEndpoint(conferenceData){if(this.logger.info("updateOrCreatePstnConferenceEndpoint for "+conferenceData.id),!conferenceData)return this.logger.error("updateOrCreatePstnConferenceEndpoint - no conference data !"),null;if(conferenceData.mediaType!==MEDIATYPE.PSTNAUDIO)return this.logger.warn("updateOrCreatePstnConferenceEndpoint - wrong mediaType: "+conferenceData.mediaType),null;if(this.conferenceEndpoints[conferenceData.id])this.conferenceEndpoints[conferenceData.id].updateFromData(conferenceData),this.conferenceEnpointsSubject.next({id:conferenceData.id,action:"updated"});else{const conference=conference_endpoint_model_1.ConferenceEndpoint.createFromData(conferenceData);this.conferenceEndpoints[conferenceData.id]=conference,this.conferenceEnpointsSubject.next({id:conferenceData.id,action:"created"})}return this.conferenceEndpoints[conferenceData.id]}getConferenceSessionWithConnId(connId){this.logger.debug("getConferenceSessionWithConnId with connId "+connId);for(const key in this.conferenceSessions)if(this.conferenceSessions[key]){const conferenceSession=this.conferenceSessions[key];if(conferenceSession&&conferenceSession.callId===connId)return this.logger.debug(`getConferenceSessionWithConnId with connId ${connId}: - conferenceSessionId: ${key}`),conferenceSession}return null}getConferenceSessionById(confId){return this.conferenceSessions[confId]}subscribeToPstnSession(confId){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info(`subscribeToPstnSession( confId=${confId})`),!confId){const error=new Error("subscribeToPstnSession - missing parameter");throw this.logger.error(error.message),error}try{const serverUrl=new URL(`conferences/${confId}/join`,this.confPortalURL),headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const data={participantPhoneNumber:"joinWithoutAudio",participant:{role:"member",type:"unmuted"},mediaType:MEDIATYPE.PSTNAUDIO},response=yield fetch(serverUrl.href,{method:"POST",headers:headers,body:JSON.stringify(data)});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const joinStatus=(yield response.json()).status;return this.logger.info(`subscribeToPstnSession( confId=${confId}) success : ${joinStatus}`),confId}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"subscribeToPstnSession");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}unSubscribeParticipantFromPstnSession(confId,participantId){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info(`unSubscribeParticipantFromPstnSession( confId=${confId} - participantId=${participantId})`),!confId||!participantId){const error=new Error("unSubscribeParticipantFromPstnSession - missing parameter");throw this.logger.error(error.message),error}try{const serverUrl=new URL(`conferences/${confId}/participants/${participantId}`,this.confPortalURL);serverUrl.searchParams.set("mediaType",MEDIATYPE.PSTNAUDIO);const headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const data={participantPhoneNumber:"joinWithoutAudio",participant:{role:"member",type:"unmuted"},mediaType:MEDIATYPE.PSTNAUDIO},response=yield fetch(serverUrl.href,{method:"DELETE",headers:headers,body:JSON.stringify(data)});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const dropStatus=(yield response.json()).status;this.logger.info(`unSubscribeParticipantFromPstnSession( confId=${confId} ) success : ${dropStatus}`)}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"unSubscribeParticipantFromPstnSession");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}startPstnConference(confId){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info(`startPstnConference( confId=${confId} )`),!confId){const error=new Error("startPstnConference - missing parameter");throw this.logger.error(error.message),error}if(this.conferenceSessions[confId]&&this.conferenceSessions[confId].active)this.logger.info("startPstnConference : conference already started");else try{const serverUrl=new URL(`conferences/${confId}/start`,this.confPortalURL),headers=this.authService.getRequestHeader(),response=yield fetch(serverUrl.href,{method:"PUT",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const startStatus=(yield response.json()).status;this.logger.info(`startPstnConference( confId=${confId} ) success : ${startStatus}`)}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"startPstnConference");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}stopPstnConference(confId){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info(`stopPstnConference( confId=${confId} )`),!confId){const error=new Error("stopPstnConference - missing parameter");throw this.logger.error(error.message),error}if(this.conferenceSessions[confId]&&this.conferenceSessions[confId].active)try{const serverUrl=new URL(`conferences/${confId}/stop`,this.confPortalURL),headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const data={mediaType:MEDIATYPE.PSTNAUDIO},response=yield fetch(serverUrl.href,{method:"PUT",headers:headers,body:JSON.stringify(data)}),responseData=yield response.json();if(!response.ok){if(this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),404===response.status&&404e3===responseData.errorDetailsCode){const session=this.getConferenceSessionById(confId);session&&(session.active=!1,session.participants=[],this.removeConferenceSession(confId))}throw response}const startStatus=responseData.status;this.logger.info(`stopPstnConference( confId=${confId} ) success : ${startStatus}`)}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"stopPstnConference");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}else this.logger.info("stopPstnConference : no conference to stop")}))}joinPstnConference(confId,participantPhoneNumber,participant,country){return __awaiter(this,void 0,void 0,(function*(){if(!confId||!participantPhoneNumber||!participant){const error=new Error("joinPstnConference - missing parameter");throw this.logger.error(error.message),error}this.logger.info(`joinPstnConference( confId=${confId}, PhoneNumber=${participantPhoneNumber}, role=${participant.role}, country=${country} )`);try{const serverUrl=new URL(`conferences/${confId}/join`,this.confPortalURL),headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const data={participantPhoneNumber:participantPhoneNumber,participant:participant,country:country,mediaType:MEDIATYPE.PSTNAUDIO},response=yield fetch(serverUrl.href,{method:"POST",headers:headers,body:JSON.stringify(data)});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;this.conferenceSessions[confId].joinInProgress=!0;const joinStatus=(yield response.json()).status;return this.logger.info(`joinPstnConference( confId=${confId} ) success - ${joinStatus}`),confId}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"joinPstnConference");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}disconnectParticipant(confId,participantId){return __awaiter(this,void 0,void 0,(function*(){if(!confId||!participantId){const error=new Error("disconnectParticipant - missing parameter");throw this.logger.error(error.message),error}this.logger.info(`disconnectParticipant( confId=${confId}, participantId=${participantId} )`);try{const serverUrl=new URL(`conferences/${confId}/participants/${participantId}`,this.confPortalURL);serverUrl.searchParams.set("mediaType",MEDIATYPE.PSTNAUDIO);const headers=this.authService.getRequestHeader(),response=yield fetch(serverUrl.href,{method:"DELETE",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;this.logger.info("disconnectParticipant success")}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"disconnectParticipant");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}retrievePstnPhoneNumbers(shouldFormatResults=!1){return __awaiter(this,void 0,void 0,(function*(){if(this.logger.info("retrievePstnPhoneNumbers : "+shouldFormatResults),this.pstnConferencePhoneNumbers)return shouldFormatResults?this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers):this.pstnConferencePhoneNumbers;try{const serverUrl=new URL("conferences/audio/phonenumbers",this.confProvPortalURL);serverUrl.searchParams.set("shortList","false");const headers=this.authService.getRequestHeader(),response=yield fetch(serverUrl.href,{method:"GET",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response;const responseData=yield response.json();return this.logger.info("retrievePstnPhoneNumbers success"),this.pstnConferencePhoneNumbers=responseData.data.phoneNumberList,shouldFormatResults?this.formatPstnPhoneNumbers(this.pstnConferencePhoneNumbers):this.pstnConferencePhoneNumbers}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"retrievePstnPhoneNumbers");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}resetPersonalMeetingRoom(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("resetPersonalMeetingRoom");try{const serverUrl=new URL("meetings/reset",this.confProvPortalURL),headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const response=yield fetch(serverUrl.href,{method:"PUT",headers:headers});if(!response.ok)throw this.logger.debug(`Request ${response.headers.get("x-rainbow-request-id")} failed with status ${response.status}`),response}catch(error){const errorInfo=yield errorHelper_service_1.default.getErrorInfo(error,"resetPersonalMeetingRoom");throw this.logger.error("[pgiConferenceService] "+errorInfo.message),errorInfo.error}}))}formatPstnPhoneNumbers(phoneNumbers){const pstnConferencePhoneNumbers={};return phoneNumbers.forEach(phoneNumber=>{if(phoneNumber.locationcode){const propertyName=this.countryService.getAlpha2Code(phoneNumber.locationcode.substr(0,3));propertyName&&(pstnConferencePhoneNumbers[propertyName]||(pstnConferencePhoneNumbers[propertyName]={numbersList:[]})),pstnConferencePhoneNumbers[propertyName].numbersList.push({number:phoneNumber.number,locationName:phoneNumber.location,city:phoneNumber.location.split(", ")[1],numberType:phoneNumber.numberType,needLanguageSelection:phoneNumber.needLanguageSelection})}}),pstnConferencePhoneNumbers}refreshConferenceSessions(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("refreshConferenceSessions");try{for(const confId in this.conferenceSessions)Object.prototype.hasOwnProperty.call(this.conferenceSessions,confId)&&(yield this.makeSnapshotForConfId(confId))}catch(error){this.logger.error("refreshConferenceSessions -- ERROR")}}))}subscribeToMyConferenceSessions(eventHandler){this.conferenceSessions[this.getPstnInstantConferenceEndpointId()]&&this.conferenceSessions[this.getPstnInstantConferenceEndpointId()].activeSubject.pipe(distinctUntilChanged_1.distinctUntilChanged()).subscribe(eventHandler)}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConferenceEndpoint=void 0;class ConferenceEndpoint{constructor(id,userId,mediaType,scheduled,confDialOutDisabled=!1,passCodes=[],playEntryTone=!1,muteUponEntry=!1){this.id=id,this.userId=userId,this.mediaType=mediaType,this.scheduled=scheduled,this.confDialOutDisabled=confDialOutDisabled,this.passCodes=passCodes,this.playEntryTone=playEntryTone,this.muteUponEntry=muteUponEntry}static createFromData(data){return new ConferenceEndpoint(data.id,data.userId,data.mediaType,data.scheduled,data.confDialOutDisabled,data.passCodes,data.playEntryTone,data.muteUponEntry)}updateFromData(data){this.id=data.id,this.userId=data.userId,this.mediaType=data.mediaType,this.scheduled=data.scheduled,this.confDialOutDisabled=data.confDialOutDisabled,this.passCodes=data.passCodes,this.playEntryTone=data.playEntryTone,this.muteUponEntry=data.muteUponEntry}}exports.ConferenceEndpoint=ConferenceEndpoint},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConferenceSession=void 0;const conference_participant_model_1=__webpack_require__(228),BehaviorSubject_1=__webpack_require__(66);class ConferenceSession{constructor(id,participants,active,type){this.conferenceStats=null,this.talkerSubject=new BehaviorSubject_1.BehaviorSubject(this.talkers),this._haveJoined=!1,this.haveJoinedSubject=new BehaviorSubject_1.BehaviorSubject(this._haveJoined),this._joinInProgress=!1,this.joinInProgressSubject=new BehaviorSubject_1.BehaviorSubject(this._haveJoined),this._active=!1,this.activeSubject=new BehaviorSubject_1.BehaviorSubject(this._active),this._callId="",this.callIdSubject=new BehaviorSubject_1.BehaviorSubject(this._callId),this._participants=[],this.participantsSubject=new BehaviorSubject_1.BehaviorSubject(this._participants),this._lock=!1,this.lockSubject=new BehaviorSubject_1.BehaviorSubject(this._lock),this.id=id,this.participants=participants,this.active=active,this.type=type}static createFromData(id,participants,active,type){return new ConferenceSession(id,participants.map(participantData=>conference_participant_model_1.ConferenceParticipant.createFromData(participantData)),active,type)}get haveJoined(){return this._haveJoined}set haveJoined(value){this._haveJoined=value,this.haveJoinedSubject.next(this._haveJoined)}get joinInProgress(){return this._joinInProgress}set joinInProgress(value){this._joinInProgress=value,this.joinInProgressSubject.next(this._joinInProgress)}get active(){return this._active}set active(value){this._active=value,this.activeSubject.next(this._active)}get callId(){return this._callId}set callId(value){this._callId=value,this.callIdSubject.next(this._callId)}get participants(){return this._participants}set participants(participantsData){if(participantsData.length)for(const participantData of participantsData){if(!participantData.participantId)return;const existingParticipant=this.getParticipantById(participantData.participantId)?this.getParticipantById(participantData.participantId):this.getParticipantByJid(participantData.jid_im);existingParticipant?existingParticipant.updateFromData(participantData):this._participants.push(conference_participant_model_1.ConferenceParticipant.createFromData(participantData))}else this._participants=[];this.participantsSubject.next(this._participants)}get lock(){return this._lock}set lock(value){this._lock=value,this.lockSubject.next(this._lock)}cleanupSessionData(){this.participants=[],this.talkers=[],this.haveJoined=!1}updateFromData(participants=[],active=!1){this.participants=participants,this.active=active}updateStateFromData(active,lock){this.active=active,this.lock=lock}removeParticipants(removedParticipantsIds=[]){for(const removedParticipantId of removedParticipantsIds){const removedParticipantIndex=this.getParticipantIndexById(removedParticipantId);-1!==removedParticipantIndex&&this._participants.splice(removedParticipantIndex,1)}this.participantsSubject.next(this._participants)}updateTalkers(talkers){this.talkers=talkers,this.talkerSubject.next(this.talkers)}getParticipants(){return this.participants}getConnectedParticipants(){return this.participants?this.participants.filter(participant=>"disconnected"!==participant.participantState&&"watching"!==participant.participantState):void 0}getWatchingParticipants(){return this.participants?this.participants.filter(participant=>"watching"===participant.participantState):void 0}getConnectedParticipantsExceptLeader(){return this.participants?this.participants.filter(participant=>"disconnected"!==participant.participantState&&"watching"!==participant.participantState&&"moderator"!==participant.participantRole):void 0}getConnectedLeaderParticipantsExcept(jid){return this.participants?this.participants.filter(participant=>"disconnected"!==participant.participantState&&"moderator"===participant.participantRole&&participant.jid_im!==jid):void 0}getConnectedParticipantsExcept(jid){return this.participants?this.participants.filter(participant=>participant.jid_im!==jid&&"disconnected"!==participant.participantState&&"watching"!==participant.participantState):void 0}getLeaderParticipant(){return this.participants?this.participants.find(participant=>"moderator"===participant.participantRole&&"disconnected"!==participant.participantState&&"watching"!==participant.participantState):void 0}getLeaderParticipantById(jid){return this.participants?this.participants.find(participant=>"moderator"===participant.participantRole&&"disconnected"!==participant.participantState&&"watching"!==participant.participantState&&participant.jid_im===jid):void 0}getParticipantById(participantId){return this.participants?this.participants.find(participant=>participant.participantId===participantId):void 0}getParticipantByJid(jid){return this.participants?this.participants.find(participant=>participant.jid_im===jid):void 0}getNonDisconnectedParticipantByJid(jid){return this.participants?this.participants.find(participant=>participant.jid_im===jid&&"disconnected"!==participant.participantState):void 0}getConnectedParticipantByJid(jid){return this.participants?this.participants.find(participant=>participant.jid_im===jid&&"connected"===participant.participantState):void 0}getWatchingParticipantByJid(jid){return this.participants?this.participants.find(participant=>participant.jid_im===jid&&"watching"===participant.participantState):void 0}getParticipantIndexById(participantId){return this.participants?this.participants.findIndex(participant=>participant.participantId===participantId):-1}isParticipantConnectedByJid(jid){return void 0!==this.participants&&this.participants.some(participant=>participant.jid_im===jid&&"connected"===participant.participantState)}isParticipantWatchingByJid(jid){return void 0!==this.participants&&this.participants.some(participant=>participant.jid_im===jid&&"watching"===participant.participantState)}isParticipantRingingByJid(jid){return void 0!==this.participants&&this.participants.some(participant=>participant.jid_im===jid&&"ringing"===participant.participantState)}isParticipantConnectedWithThisUAByJid(jid){return this.haveJoined&&void 0!==this.participants&&this.participants.some(participant=>participant.jid_im===jid&&"connected"===participant.participantState)}getTalkers(){return this.talkers}getParticipantStatus(jid){if(this.participants&&this.participants.length){const participant=this.participants.find(_participant=>_participant.jid_im===jid);if(participant)return participant.participantState}return"none"}}exports.ConferenceSession=ConferenceSession},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Subject_1=__webpack_require__(67),queue_1=__webpack_require__(336),Subscription_1=__webpack_require__(45),observeOn_1=__webpack_require__(343),ObjectUnsubscribedError_1=__webpack_require__(70),SubjectSubscription_1=__webpack_require__(81),ReplaySubject=function(_super){function ReplaySubject(bufferSize,windowTime,scheduler){void 0===bufferSize&&(bufferSize=Number.POSITIVE_INFINITY),void 0===windowTime&&(windowTime=Number.POSITIVE_INFINITY);var _this=_super.call(this)||this;return _this.scheduler=scheduler,_this._events=[],_this._infiniteTimeWindow=!1,_this._bufferSize=bufferSize<1?1:bufferSize,_this._windowTime=windowTime<1?1:windowTime,windowTime===Number.POSITIVE_INFINITY?(_this._infiniteTimeWindow=!0,_this.next=_this.nextInfiniteTimeWindow):_this.next=_this.nextTimeWindow,_this}return __extends(ReplaySubject,_super),ReplaySubject.prototype.nextInfiniteTimeWindow=function(value){if(!this.isStopped){var _events=this._events;_events.push(value),_events.length>this._bufferSize&&_events.shift()}_super.prototype.next.call(this,value)},ReplaySubject.prototype.nextTimeWindow=function(value){this.isStopped||(this._events.push(new ReplayEvent(this._getNow(),value)),this._trimBufferThenGetEvents()),_super.prototype.next.call(this,value)},ReplaySubject.prototype._subscribe=function(subscriber){var subscription,_infiniteTimeWindow=this._infiniteTimeWindow,_events=_infiniteTimeWindow?this._events:this._trimBufferThenGetEvents(),scheduler=this.scheduler,len=_events.length;if(this.closed)throw new ObjectUnsubscribedError_1.ObjectUnsubscribedError;if(this.isStopped||this.hasError?subscription=Subscription_1.Subscription.EMPTY:(this.observers.push(subscriber),subscription=new SubjectSubscription_1.SubjectSubscription(this,subscriber)),scheduler&&subscriber.add(subscriber=new observeOn_1.ObserveOnSubscriber(subscriber,scheduler)),_infiniteTimeWindow)for(var i=0;i<len&&!subscriber.closed;i++)subscriber.next(_events[i]);else for(i=0;i<len&&!subscriber.closed;i++)subscriber.next(_events[i].value);return this.hasError?subscriber.error(this.thrownError):this.isStopped&&subscriber.complete(),subscription},ReplaySubject.prototype._getNow=function(){return(this.scheduler||queue_1.queue).now()},ReplaySubject.prototype._trimBufferThenGetEvents=function(){for(var now=this._getNow(),_bufferSize=this._bufferSize,_windowTime=this._windowTime,_events=this._events,eventsCount=_events.length,spliceCount=0;spliceCount<eventsCount&&!(now-_events[spliceCount].time<_windowTime);)spliceCount++;return eventsCount>_bufferSize&&(spliceCount=Math.max(spliceCount,eventsCount-_bufferSize)),spliceCount>0&&_events.splice(0,spliceCount),_events},ReplaySubject}(Subject_1.Subject);exports.ReplaySubject=ReplaySubject;var ReplayEvent=function(time,value){this.time=time,this.value=value}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var QueueAction_1=__webpack_require__(337),QueueScheduler_1=__webpack_require__(340);exports.queueScheduler=new QueueScheduler_1.QueueScheduler(QueueAction_1.QueueAction),exports.queue=exports.queueScheduler},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var QueueAction=function(_super){function QueueAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this}return __extends(QueueAction,_super),QueueAction.prototype.schedule=function(state,delay){return void 0===delay&&(delay=0),delay>0?_super.prototype.schedule.call(this,state,delay):(this.delay=delay,this.state=state,this.scheduler.flush(this),this)},QueueAction.prototype.execute=function(state,delay){return delay>0||this.closed?_super.prototype.execute.call(this,state,delay):this._execute(state,delay)},QueueAction.prototype.requestAsyncId=function(scheduler,id,delay){return void 0===delay&&(delay=0),null!==delay&&delay>0||null===delay&&this.delay>0?_super.prototype.requestAsyncId.call(this,scheduler,id,delay):scheduler.flush(this)},QueueAction}(__webpack_require__(338).AsyncAction);exports.QueueAction=QueueAction},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var AsyncAction=function(_super){function AsyncAction(scheduler,work){var _this=_super.call(this,scheduler,work)||this;return _this.scheduler=scheduler,_this.work=work,_this.pending=!1,_this}return __extends(AsyncAction,_super),AsyncAction.prototype.schedule=function(state,delay){if(void 0===delay&&(delay=0),this.closed)return this;this.state=state;var id=this.id,scheduler=this.scheduler;return null!=id&&(this.id=this.recycleAsyncId(scheduler,id,delay)),this.pending=!0,this.delay=delay,this.id=this.id||this.requestAsyncId(scheduler,this.id,delay),this},AsyncAction.prototype.requestAsyncId=function(scheduler,id,delay){return void 0===delay&&(delay=0),setInterval(scheduler.flush.bind(scheduler,this),delay)},AsyncAction.prototype.recycleAsyncId=function(scheduler,id,delay){if(void 0===delay&&(delay=0),null!==delay&&this.delay===delay&&!1===this.pending)return id;clearInterval(id)},AsyncAction.prototype.execute=function(state,delay){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var error=this._execute(state,delay);if(error)return error;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},AsyncAction.prototype._execute=function(state,delay){var errored=!1,errorValue=void 0;try{this.work(state)}catch(e){errored=!0,errorValue=!!e&&e||new Error(e)}if(errored)return this.unsubscribe(),errorValue},AsyncAction.prototype._unsubscribe=function(){var id=this.id,scheduler=this.scheduler,actions=scheduler.actions,index=actions.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==index&&actions.splice(index,1),null!=id&&(this.id=this.recycleAsyncId(scheduler,id,null)),this.delay=null},AsyncAction}(__webpack_require__(339).Action);exports.AsyncAction=AsyncAction},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Action=function(_super){function Action(scheduler,work){return _super.call(this)||this}return __extends(Action,_super),Action.prototype.schedule=function(state,delay){return void 0===delay&&(delay=0),this},Action}(__webpack_require__(45).Subscription);exports.Action=Action},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var QueueScheduler=function(_super){function QueueScheduler(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(QueueScheduler,_super),QueueScheduler}(__webpack_require__(341).AsyncScheduler);exports.QueueScheduler=QueueScheduler},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Scheduler_1=__webpack_require__(342),AsyncScheduler=function(_super){function AsyncScheduler(SchedulerAction,now){void 0===now&&(now=Scheduler_1.Scheduler.now);var _this=_super.call(this,SchedulerAction,(function(){return AsyncScheduler.delegate&&AsyncScheduler.delegate!==_this?AsyncScheduler.delegate.now():now()}))||this;return _this.actions=[],_this.active=!1,_this.scheduled=void 0,_this}return __extends(AsyncScheduler,_super),AsyncScheduler.prototype.schedule=function(work,delay,state){return void 0===delay&&(delay=0),AsyncScheduler.delegate&&AsyncScheduler.delegate!==this?AsyncScheduler.delegate.schedule(work,delay,state):_super.prototype.schedule.call(this,work,delay,state)},AsyncScheduler.prototype.flush=function(action){var actions=this.actions;if(this.active)actions.push(action);else{var error;this.active=!0;do{if(error=action.execute(action.state,action.delay))break}while(action=actions.shift());if(this.active=!1,error){for(;action=actions.shift();)action.unsubscribe();throw error}}},AsyncScheduler}(Scheduler_1.Scheduler);exports.AsyncScheduler=AsyncScheduler},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Scheduler=function(){function Scheduler(SchedulerAction,now){void 0===now&&(now=Scheduler.now),this.SchedulerAction=SchedulerAction,this.now=now}return Scheduler.prototype.schedule=function(work,delay,state){return void 0===delay&&(delay=0),new this.SchedulerAction(this,work).schedule(state,delay)},Scheduler.now=function(){return Date.now()},Scheduler}();exports.Scheduler=Scheduler},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var Subscriber_1=__webpack_require__(55),Notification_1=__webpack_require__(344);exports.observeOn=function(scheduler,delay){return void 0===delay&&(delay=0),function(source){return source.lift(new ObserveOnOperator(scheduler,delay))}};var ObserveOnOperator=function(){function ObserveOnOperator(scheduler,delay){void 0===delay&&(delay=0),this.scheduler=scheduler,this.delay=delay}return ObserveOnOperator.prototype.call=function(subscriber,source){return source.subscribe(new ObserveOnSubscriber(subscriber,this.scheduler,this.delay))},ObserveOnOperator}();exports.ObserveOnOperator=ObserveOnOperator;var ObserveOnSubscriber=function(_super){function ObserveOnSubscriber(destination,scheduler,delay){void 0===delay&&(delay=0);var _this=_super.call(this,destination)||this;return _this.scheduler=scheduler,_this.delay=delay,_this}return __extends(ObserveOnSubscriber,_super),ObserveOnSubscriber.dispatch=function(arg){var notification=arg.notification,destination=arg.destination;notification.observe(destination),this.unsubscribe()},ObserveOnSubscriber.prototype.scheduleMessage=function(notification){this.destination.add(this.scheduler.schedule(ObserveOnSubscriber.dispatch,this.delay,new ObserveOnMessage(notification,this.destination)))},ObserveOnSubscriber.prototype._next=function(value){this.scheduleMessage(Notification_1.Notification.createNext(value))},ObserveOnSubscriber.prototype._error=function(err){this.scheduleMessage(Notification_1.Notification.createError(err)),this.unsubscribe()},ObserveOnSubscriber.prototype._complete=function(){this.scheduleMessage(Notification_1.Notification.createComplete()),this.unsubscribe()},ObserveOnSubscriber}(Subscriber_1.Subscriber);exports.ObserveOnSubscriber=ObserveOnSubscriber;var ObserveOnMessage=function(notification,destination){this.notification=notification,this.destination=destination};exports.ObserveOnMessage=ObserveOnMessage},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var empty_1=__webpack_require__(345),of_1=__webpack_require__(346),throwError_1=__webpack_require__(350);!function(NotificationKind){NotificationKind.NEXT="N",NotificationKind.ERROR="E",NotificationKind.COMPLETE="C"}(exports.NotificationKind||(exports.NotificationKind={}));var Notification=function(){function Notification(kind,value,error){this.kind=kind,this.value=value,this.error=error,this.hasValue="N"===kind}return Notification.prototype.observe=function(observer){switch(this.kind){case"N":return observer.next&&observer.next(this.value);case"E":return observer.error&&observer.error(this.error);case"C":return observer.complete&&observer.complete()}},Notification.prototype.do=function(next,error,complete){switch(this.kind){case"N":return next&&next(this.value);case"E":return error&&error(this.error);case"C":return complete&&complete()}},Notification.prototype.accept=function(nextOrObserver,error,complete){return nextOrObserver&&"function"==typeof nextOrObserver.next?this.observe(nextOrObserver):this.do(nextOrObserver,error,complete)},Notification.prototype.toObservable=function(){switch(this.kind){case"N":return of_1.of(this.value);case"E":return throwError_1.throwError(this.error);case"C":return empty_1.empty()}throw new Error("unexpected notification kind value")},Notification.createNext=function(value){return void 0!==value?new Notification("N",value):Notification.undefinedValueNotification},Notification.createError=function(err){return new Notification("E",void 0,err)},Notification.createComplete=function(){return Notification.completeNotification},Notification.completeNotification=new Notification("C"),Notification.undefinedValueNotification=new Notification("N",void 0),Notification}();exports.Notification=Notification},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=__webpack_require__(54);exports.EMPTY=new Observable_1.Observable((function(subscriber){return subscriber.complete()})),exports.empty=function(scheduler){return scheduler?function(scheduler){return new Observable_1.Observable((function(subscriber){return scheduler.schedule((function(){return subscriber.complete()}))}))}(scheduler):exports.EMPTY}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var isScheduler_1=__webpack_require__(347),fromArray_1=__webpack_require__(348),scheduleArray_1=__webpack_require__(229);exports.of=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var scheduler=args[args.length-1];return isScheduler_1.isScheduler(scheduler)?(args.pop(),scheduleArray_1.scheduleArray(args,scheduler)):fromArray_1.fromArray(args)}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isScheduler=function(value){return value&&"function"==typeof value.schedule}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=__webpack_require__(54),subscribeToArray_1=__webpack_require__(349),scheduleArray_1=__webpack_require__(229);exports.fromArray=function(input,scheduler){return scheduler?scheduleArray_1.scheduleArray(input,scheduler):new Observable_1.Observable(subscribeToArray_1.subscribeToArray(input))}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.subscribeToArray=function(array){return function(subscriber){for(var i=0,len=array.length;i<len&&!subscriber.closed;i++)subscriber.next(array[i]);subscriber.complete()}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Observable_1=__webpack_require__(54);function dispatch(_a){var error=_a.error;_a.subscriber.error(error)}exports.throwError=function(error,scheduler){return scheduler?new Observable_1.Observable((function(subscriber){return scheduler.schedule(dispatch,0,{error:error,subscriber:subscriber})})):new Observable_1.Observable((function(subscriber){return subscriber.error(error)}))}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _models_appli_message__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(16),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_files_fileStorage_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(25),_src_services_files_fileStorage_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_files_fileStorage_service__WEBPACK_IMPORTED_MODULE_3__);function _readOnlyError(name){throw new Error('"'+name+'" is read-only')}angular.module("rainbow").factory("ConversationServiceHistoryHandler",["$log","$q","$filter","$rootScope","fileServerService","SearchTextMsgResultFactory",function($log,$q,$filter,$rootScope,fileServerService,SearchTextMsgResultFactory){function ConversationServiceHistoryHandler(conversationService){this.conversationService=conversationService}return ConversationServiceHistoryHandler.create=function(conversationService){return new ConversationServiceHistoryHandler(conversationService)},ConversationServiceHistoryHandler.prototype.getHistoryPage=function(conversation,nbMessages){var that=this,room=conversation.room;return room&&room.initPresPromise?room.initPresPromise.promise.then((function(){return that.getHistoryPageInternal(conversation,nbMessages)})):this.getHistoryPageInternal(conversation,nbMessages)},ConversationServiceHistoryHandler.prototype.getHistoryPageInternal=function(conversation,size){if(conversation.currentHistoryId&&conversation.currentHistoryId===conversation.historyIndex)return $log.info("[ConversationServiceHistoryHandler] getHistoryPage("+conversation.id+", "+size+", "+conversation.historyIndex+") already asked"),$q.reject();conversation.currentHistoryId=conversation.historyIndex,$log.info("[ConversationServiceHistoryHandler] getHistoryPage("+conversation.id+", "+size+", "+conversation.historyIndex+")");var defered=conversation.historyDefered=$q.defer();if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.isUserContact(conversation.contact))return defered.reject(),defered.promise;if(conversation.historyComplete)return $log.info("[ConversationServiceHistoryHandler] getHistoryPage("+conversation.id+") : already complete"),defered.reject(),defered.promise;var mamRequest={queryid:conversation.id,with:conversation.id,max:size,before:""};return-1!==conversation.historyIndex&&(mamRequest.before=conversation.historyIndex),conversation.room?(mamRequest={queryid:conversation.id,with:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact.jid,max:size,before:""},-1!==conversation.historyIndex&&(mamRequest.before=conversation.historyIndex),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.mam.querymuc(conversation.id,conversation.room.jid,mamRequest)):_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.mam.query(conversation.id,mamRequest),defered.promise},ConversationServiceHistoryHandler.prototype.retrieveMsgByDate=function(conversation,msgDate){var defered=conversation.historyDefered=$q.defer();if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.isUserContact(conversation.contact))return defered.reject(),defered.promise;var queryId="cache_"+conversation.id;return ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg(queryId,conversation,1,msgDate,"after",(function(){$log.info("[ConversationServiceHistoryHandler] retrieveMsgByDate finished")})),ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg(queryId,conversation,1,msgDate,"before",(function(){$log.info("[ConversationServiceHistoryHandler] retrieveMsgByDate finished")})),defered.promise},ConversationServiceHistoryHandler.prototype.getCommonHistoryPageAroundMsg=function(queryId,conversation,size,centeredMsgDate,order,finishMethod){if($log.info("[ConversationServiceHistoryHandler] getCommonHistoryPageAroundMsg("+queryId+", "+size+", "+conversation.historyIndex+")"),conversation.room){var mamRequest={queryid:queryId,with:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact.jid,max:size,onComplete:finishMethod};mamRequest[order]=centeredMsgDate,_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.mam.querymuc(queryId,conversation.room.jid,mamRequest)}else{var _mamRequest={queryid:queryId,with:conversation.id,max:size,onComplete:finishMethod};_mamRequest[order]=centeredMsgDate,_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.mam.query(queryId,_mamRequest)}},ConversationServiceHistoryHandler.prototype.searchTextInConversations=function(queryId,text){$log.info("[ConversationServiceHistoryHandler] searchTextInConversations("+text+")");var defered=$q.defer(),iqId=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(100).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up();return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >searchTextInConversations: count= "+count),defered.resolve(parseInt(count,10))})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.getConversationTextCount=function(queryId,text,contactJid){$log.info("[ConversationServiceHistoryHandler] getConversationTextCount("+text+")");var defered=$q.defer(),iqId=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t("0").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(parseInt(count,10))})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextResultsInConversation=function(queryId,text,contactJid){$log.info("[ConversationServiceHistoryHandler] searchTextResultsInConversation("+text+")");var defered=$q.defer(),iqId=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(100).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(parseInt(count,10))})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextMoreResultsInConversation=function(queryId,text,contactJid,messageDate){$log.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+text+")");var defered=$q.defer(),iqId=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.getUniqueId(),iq=$iq({id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(100).up().c("before").t(messageDate).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(parseInt(count,10))})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextResultsInRoom=function(queryId,text,roomJid){$log.info("[ConversationServiceHistoryHandler] searchTextInRoom("+text+")");var defered=$q.defer(),userJid=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact.jid,iqId=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.getUniqueId(),iq=$iq({to:roomJid,id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(100).up().c("before").up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"with",type:"text-single"}).c("value").t(userJid).up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up();return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >searchTextInRoom: count= "+count),defered.resolve(parseInt(count,10))})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] >searchTextInRoom: Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.searchTextMoreResultsInRoom=function(queryId,text,contactJid,roomJid,messageDate,limitSize){$log.info("[ConversationServiceHistoryHandler] searchTextMoreResultsInConversation("+text+")");var defered=$q.defer(),iqId=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.getUniqueId(),iq=$iq({to:roomJid,id:iqId,type:"get"}).c("query",{queryid:queryId,xmlns:"urn:xmpp:mam:tmp"}).c("set",{xmlns:"http://jabber.org/protocol/rsm"}).c("max").t(limitSize).up().c("before").t(messageDate).up().up().c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up().c("field",{var:"withtext",type:"text-single"}).c("value").t(text).up().up().c("field",{var:"with",type:"text-single"}).c("value").t(contactJid).up().up();return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.sendIQ(iq).then((function(data){$log.info("[ConversationServiceHistoryHandler] sendIq Success: "+text);var count=$(data).find("query").find("set").find("count").text();$log.info("[ConversationServiceHistoryHandler] >getConversationTextCount: count= "+count),defered.resolve(count)})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] sendIq Failure: "+error.message),defered.reject(error)})),defered.promise},ConversationServiceHistoryHandler.prototype.onHistoryMessageReceived=function(stanza){$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived: "+stanza);try{var conversation=null,stanzaElem=$(stanza),queryId=stanzaElem.find("result").attr("queryid");if(queryId){if(conversation=this.conversationService.getConversationById(queryId)){if(stanzaElem.find("call_log").length)return this.onWebrtcHistoryMessageReceived(stanza,conversation);var fromJid,brutJid=stanzaElem.find("forwarded message").attr("from"),roomEvent=!1;if(!(fromJid=brutJid&&0===brutJid.indexOf("room_")?brutJid.split("/")[1]:_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.getBareJidFromJid(stanzaElem.find("forwarded message").attr("from")))&&stanzaElem.find("event").length&&(roomEvent=stanzaElem.find("event").attr("name"),fromJid=stanzaElem.find("event").attr("jid"),"welcome"===roomEvent&&conversation.room&&conversation.room.ownerContact&&(fromJid=conversation.room.ownerContact.jid)),!fromJid)return $log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;var from=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.getContactByJid(fromJid),type=stanzaElem.find("forwarded message").attr("type"),messageId=stanzaElem.find("forwarded message").attr("id"),date=new Date(stanzaElem.find("forwarded delay").attr("stamp")),body=stanzaElem.find("forwarded message body").text(),ack=stanzaElem.find("forwarded message ack"),oob=stanzaElem.find("forwarded message x[xmlns='jabber:x:oob']"),conference=stanzaElem.find("forwarded message x[xmlns='jabber:x:bubble:conference:pstn']"),contents=stanzaElem.find("content[xmlns='urn:xmpp:content']"),replace=stanzaElem.find("replace"),answeredMsg=stanzaElem.find("answeredMsg"),alternativeContentStanza=stanzaElem.find("content"),side=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.isUserContact(from)?_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.Side.RIGHT:_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.Side.LEFT,voiceMessage=stanzaElem.find("voicemessage"),voiceMessageData=!1;if(voiceMessage&&voiceMessage.length&&(voiceMessageData=!0),from||($log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+fromJid+", ignore message"),from=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.createEmptyContact(fromJid)),roomEvent){if($log.info("[ConversationServiceHistoryHandler] ("+conversation.id+") add Room admin event message "+roomEvent),type="admin",conversation.room&&conversation.room.isMeetingRoom()&&("welcome"===roomEvent||"conferenceAdd"===roomEvent||"conferenceRemove"===roomEvent||"invitation"===roomEvent))return!0;if(("conferenceAdd"===roomEvent||"conferenceRemove"===roomEvent)&&conversation.room&&conversation.room.ownerContact){var userJid=stanzaElem.find("event").attr("jid"),user=conversation.room.getUserByJid(userJid);from=user&&user.contact?user.contact:conversation.room.ownerContact}}var message=conversation.getMessageById(messageId);if(message||(message=conversation.historyMessages.find((function(item){return item.id===messageId}))),message)$log.info("[ConversationServiceHistoryHandler] ("+conversation.id+") try to add an already stored message with id "+message.id);else{switch(type){case"file":message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createFileMessage(messageId,date,from,side,body,!1);break;case"webrtc":message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createWebRTCMessage(messageId,date,from,side,body,!1);break;case"admin":message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createBubbleAdminMessage(messageId,date,from,roomEvent);break;case"recording":message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createRecordingAdminMessage(messageId,date,from,"Admin");break;default:if(oob&&oob.length){var oobElem=$(oob),url=oobElem.find("url").text(),fileName=oobElem.find("filename").text(),fileId=_src_services_files_fileStorage_service__WEBPACK_IMPORTED_MODULE_3___default.a.extractFileIdFromUrl(url);message=voiceMessageData?_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createVoiceMessage(messageId,date,from,side,body,!1,fileId,fileName,voiceMessageData):_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createFileSharingMessage(messageId,date,from,side,body,!1,fileId,fileName,null,geolocData),_src_services_files_fileStorage_service__WEBPACK_IMPORTED_MODULE_3___default.a.retrieveAndStoreOneFileDescriptor(fileId).then((function(fileDescriptor){fileDescriptor&&"not_uploaded"===fileDescriptor.state&&(message.receiptStatus=1,message.fileErrorMsg=$filter("translate")("file_notuploaded")),fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then((function(blob){fileDescriptor.previewBlob=blob,fileDescriptor.previewBlobSubject.next(fileDescriptor.previewBlob),$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})})),$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})})).catch((function(error){$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived error "+error)}))}else if(conference&&conference.length){var conferenceElem=$(conference),subject=conferenceElem.attr("subject"),confendpointid=conferenceElem.attr("confendpointid"),jid=conference.attr("jid");if("reminder"===conference.attr("type"))return!0;var conferenceDescriptor={subject:subject,confendpointid:confendpointid,roomjid:jid};message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createConferenceMessage(messageId,date,from,side,!1,conferenceDescriptor)}else{var isMarkdown=!1,additionalContent={};if(contents&&contents.each((function(){var contentType=$(this).attr("type"),content=$(this).text();"text/markdown"===contentType&&(_readOnlyError("isMarkdown"),isMarkdown=!0,_readOnlyError("body"),body=content),additionalContent[contentType]={type:contentType,message:content}})),replace&&replace.length){var replacedMsgId=replace.attr("id"),replacedMessage=conversation.getMessageByIdInHistory(replacedMsgId);replacedMessage||(replacedMessage=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.create(replacedMsgId,date,from,side,body,!1,isMarkdown,null,null,null,null),message=replacedMessage),from.jid!==replacedMessage.from.jid?($log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived : message Replaced by somebody else - Skip"),message=null):replacedMessage&&replacedMessage.addReplaceMsg(messageId,body)}else{var answeredMsgId=answeredMsg?answeredMsg.text():null,answeredMsgDate=answeredMsg?answeredMsg.attr("stamp"):null,alternativeContent=alternativeContentStanza?{type:alternativeContentStanza.attr("type"),message:alternativeContentStanza.text()}:null;message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.create(messageId,date,from,side,body,!1,isMarkdown,null,answeredMsgId,answeredMsgDate,additionalContent,alternativeContent)}}}message&&(message.receiptStatus="true"===angular.element(ack).attr("read")?5:"true"===angular.element(ack).attr("recv")?4:3,$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : pushing msg inside historyMessages"),conversation.addMessageInHistoryMessages(message))}}else if(queryId.startsWith("cache_")){$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : Query Id for Cached Message");var conversationId=queryId.substr(6);if(conversation=this.conversationService.getConversationById(conversationId)){var _fromJid;$log.info("[ConversationServiceHistoryHandler] onHistoryMessageReceived : Conversation Found");var _brutJid=stanzaElem.find("forwarded message").attr("from");if(!(_fromJid=_brutJid&&0===_brutJid.indexOf("room_")?_brutJid.split("/")[1]:_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.getBareJidFromJid(stanzaElem.find("forwarded message").attr("from")))&&stanzaElem.find("event").length){var _roomEvent=stanzaElem.find("event").attr("name");_fromJid=stanzaElem.find("event").attr("jid"),"welcome"===_roomEvent&&conversation.room&&conversation.room.ownerContact&&(_fromJid=conversation.room.ownerContact.jid)}if(!_fromJid)return $log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived - Receive message without valid fromJid information"),!0;var _from=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.getContactByJid(_fromJid),_messageId=stanzaElem.find("forwarded message").attr("id"),_date=new Date(stanzaElem.find("forwarded delay").attr("stamp")),_body=stanzaElem.find("forwarded message body").text(),_side=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.isUserContact(_from)?_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.Side.RIGHT:_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.Side.LEFT;_from||($log.warn("[ConversationServiceHistoryHandler] onHistoryMessageReceived missing contact for jid : "+_fromJid+", ignore message"),_from=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.createEmptyContact(_fromJid));var _message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.create(_messageId,_date,_from,_side,_body,!1,!1);_message&&conversation.addMessageInCacheMessages(_message),conversation.historyDefered&&conversation.historyDefered.resolve(_message)}}}else if(queryId=angular.element(stanza).find("fin").attr("queryid"),conversation=this.conversationService.getConversationById(queryId)){conversation.historyComplete="true"===angular.element(stanza).find("fin").attr("complete");var historyIndex=angular.element(stanza).find("fin set first").text();-1===conversation.historyIndex?(conversation.messages.unshift.apply(conversation.messages,conversation.historyMessages),conversation.chatRenderer&&conversation.chatRenderer.prependMessages(conversation.messages,conversation.room)):(conversation.messages.unshift.apply(conversation.messages,conversation.historyMessages),conversation.chatRenderer&&conversation.chatRenderer.prependMessages(conversation.historyMessages,conversation.room)),conversation.historyIndex=historyIndex,conversation.historyMessages=[],angular.isDefined(conversation.messages)&&conversation.messages.length>0?conversation.lastMessageText=conversation.messages[conversation.messages.length-1].data:conversation.lastMessageText="",conversation.historyDefered&&conversation.historyDefered.resolve(conversation)}return!0}catch(error){return $log.error("[ConversationServiceHistoryHandler] onHistoryMessageReceived error : "+error),!0}},ConversationServiceHistoryHandler.prototype.onSearchTextMessageReceived=function(stanza){$log.info("[ConversationServiceHistoryHandler] onSearchTextMessageReceived");try{var otherJid,stanzaElem=$(stanza),fromJid=stanzaElem.find("forwarded message").attr("from"),toJid=stanzaElem.find("forwarded message").attr("to"),isSent=!1,isRoom=!1;if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.isUserContactJid(fromJid)?($log.info("[ConversationServiceHistoryHandler] sent message"),isSent=!0,otherJid=toJid):($log.info("[ConversationServiceHistoryHandler] received message"),isSent=!1,otherJid=fromJid),otherJid&&0===otherJid.indexOf("room_")?(otherJid=otherJid.split("/")[0],isRoom=!0):otherJid=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.getBareJidFromJid(otherJid),!otherJid)return void $log.warn("[ConversationServiceHistoryHandler] onSearchTextMessageReceived - Receive message without valid otherJid information");var messageId=stanzaElem.find("forwarded message").attr("id"),date=new Date(stanzaElem.find("forwarded delay").attr("stamp")),body=stanzaElem.find("forwarded message body").text(),historyIndex=stanzaElem.find("result").attr("id"),searchMsgResult=SearchTextMsgResultFactory();return searchMsgResult.body=body,searchMsgResult.date=date,searchMsgResult.isRoom=isRoom,searchMsgResult.isSent=isSent,searchMsgResult.messageId=messageId,searchMsgResult.otherJid=otherJid,searchMsgResult.historyIndex=historyIndex,searchMsgResult}catch(error){return $log.error("[ConversationServiceHistoryHandler] onSearchTextMessageReceived error : "+error),!0}},ConversationServiceHistoryHandler.prototype.onWebrtcHistoryMessageReceived=function(stanza,conversation){try{var stanzaElem=$(stanza),messageId=stanzaElem.find("forwarded message").attr("id"),callerJid=stanzaElem.find("caller").text(),state=stanzaElem.find("state").text(),duration=0;stanzaElem.find("duration")&&(duration=stanzaElem.find("duration").text(),duration=parseInt(duration,10)),duration=duration>0?"("+moment.duration(duration,"ms").format("h[H] mm[m] ss[s]")+")":0;var date=stanzaElem.find("date").text();date=date?new Date(date):new Date(stanzaElem.find("forwarded delay").attr("stamp"));var body="";"missed"===state?body="missedCall||"+date:"answered"===state&&(body="activeCallMsg||"+date+"||"+duration);var message=conversation.getMessageById(messageId);if(message||(message=conversation.historyMessages.find((function(item){return item.id===messageId}))),message)$log.info("[ConversationServiceHistoryHandler] ("+conversation.id+") try to add an already stored message with id "+message.id);else{var from=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.getContactByJid(callerJid);from||($log.warn("[ConversationServiceHistoryHandler] onWebrtcHistoryMessageReceived missing contact for jid : "+callerJid+", ignore message"),from=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.createEmptyContact(callerJid));var side=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.isUserContact(from)?_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.Side.RIGHT:_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.Side.LEFT;message=_models_appli_message__WEBPACK_IMPORTED_MODULE_0__.Message.createWebRTCMessage(messageId,date,from,side,body,!1);var ack=stanzaElem.find("forwarded message ack");ack&&(message.receiptStatus="true"===angular.element(ack).attr("read")?5:"true"===angular.element(ack).attr("received")?4:3),conversation.historyMessages.push(message)}return!0}catch(error){return!0}},ConversationServiceHistoryHandler}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChannelService=void 0;const channel_service_1=__webpack_require__(353);class ChannelService extends channel_service_1.ChannelServiceAgnostic{constructor($rootScope,$http){super($rootScope,$http)}}exports.ChannelService=ChannelService,ChannelService.$inject=["$rootScope","$http"],angular.module("rainbow").service("channelService",ChannelService)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChannelServiceAgnostic=void 0;const rxjs_1=__webpack_require__(10),channel_1=__webpack_require__(220),channelMessage_model_1=__webpack_require__(354),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),event_service_1=__webpack_require__(32),logger_service_1=__webpack_require__(15),i18n_service_1=__webpack_require__(37),contact_service_1=__webpack_require__(1),event_model_1=__webpack_require__(24),_escape=__webpack_require__(59),imageUtils_service_1=__webpack_require__(74);class FeedChannel{constructor(){this.messages=[],this.complete=!1,this.pageIndex=0,this.isLoading=!1,this.type="AGGREGATE"}}class ChannelServiceAgnostic{constructor($rootScope,$http){this.$rootScope=$rootScope,this.$http=$http,this.eventService=event_service_1.default,this.logger=logger_service_1.default,this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.profileService=profile_service_1.default,this.i18n=i18n_service_1.default,this.contactService=contact_service_1.default,this.listeners=[],this.isStarted=!1,this.channels={},this.channelsList=[],this.serviceStatusSubject=new rxjs_1.Subject,this.rxSubject=new rxjs_1.Subject,this.LIST_EVENT_TYPE={ADD:0,UPDATE:1,REMOVE:2,DELETE:3,SUBSCRIBE:4,UNSUBSCRIBE:5,CREATE:6},this.USER_ROLE={NONE:"none",OWNER:"owner",PUBLISHER:"publisher",MEMBER:"member"},this.MESSAGE_ACTION={ADD:0,RETRACT:1},this.xmppMessageHandler=null,this.xmppManagementHandler=null,this.notificationCounter=0,this.messageCounter=0,this.invitationCounter=0,this.CHANNEL_UPDATE_EVENT="CHANNEL_UPDATE_EVENT",this.CHANNEL_MESSAGE_RECEIVED="CHANNEL_MESSAGE_RECEIVED",this.CHANNEL_USERS_UPDATE_EVENT="CHANNEL_USERS_UPDATE_EVENT",this.CHANNEL_NOTIFICATION_NUMBER_UPDATED="CHANNEL_NOTIFICATION_NUMBER_UPDATED",this.CHANNEL_USER_SUBSCRIPTION_EVENT="CHANNEL_USER_SUBSCRIPTION_EVENT"}start(){return __awaiter(this,void 0,void 0,(function*(){try{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.CHANNEL_ACTIVATED))return;if(this.contactService.userContact.isCPaaSGuest())return;if(!this.contactService.userContact.channelsEnabled)return;this.logger.info("=== STARTING ==="),this.feedChannel=new FeedChannel,this.portalURL=config.restServerUrl+"/api/rainbow/channels/v1.0/channels",this.getMyChannels()}catch(error){this.logger.info("=== STARTING FAILURE === "+error.message)}}))}getMyChannels(){return __awaiter(this,void 0,void 0,(function*(){try{const url=this.portalURL+"?format=full",headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw this.logger.debug(`Request ${responseData.headers.get("x-rainbow-request-id")} failed with status ${responseData.status}`),new Error(responseData.statusText);return(yield responseData.json()).data.forEach(channelData=>{const channel=channel_1.Channel.create(channelData);this.updateDisplayInfo(channel),channel.invited&&this.incrementInvitationCounter(),(channel.subscribed||channel.invited)&&(this.channels[channel.id]=channel)}),this.updateChannelsList(),this.attachHandlers(),this.attachListeners(),this.isStarted=!0,this.$rootScope.$broadcast("ON_CHANNEL_SERVICE_STARTED"),this.serviceStatusSubject.next("CHANNEL_SERVICE_STARTED"),this.channelsList}catch(error){throw this.channelErrorHandler("getMyChannels",error)}}))}attachHandlers(){this.xmppMessageHandler&&(this.xmppService.connection.deleteHandler(this.xmppMessageHandler),this.xmppMessageHandler=null),this.xmppManagementHandler&&(this.xmppService.connection.deleteHandler(this.xmppManagementHandler),this.xmppManagementHandler=null),this.xmppMessageHandler=this.xmppService.connection.addHandler(stanza=>this.onChannelMessageReceived(stanza),null,"message","headline"),this.xmppManagementHandler=this.xmppService.connection.addHandler(stanza=>this.onChannelManagementReceived(stanza),null,"message","management")}attachListeners(){this.listeners.push(this.eventService.subscribe(this.CHANNEL_USERS_UPDATE_EVENT,(_event,channelId,users)=>this.usersUpdateHandler(_event,channelId,users)))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("=== STOPPING ==="),this.listeners.forEach(destroyFunction=>{destroyFunction()}),this.channels={},this.channelsList=[],this.feedChannel=null,this.notificationCounter=0,this.logger.info("=== STOPPED ===")}))}subscribe(handler){return this.rxSubject.subscribe(handler)}reconnect(){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("reconnect"),yield this.stop(),yield this.start()}catch(error){this.logger.error("reconnect -- failure -- "+error.message)}}))}removeChannelFromCache(channelId){return new Promise((resolve,reject)=>{const channelToRemove=this.getChannelFromCache(channelId);if(channelToRemove){const channelName=channelToRemove.name;channelToRemove.invited&&this.decrementInvitationCounter(),delete this.channels[channelId],this.updateChannelsList(),this.feedChannel.messages=[],this.retrieveLatests().then(()=>{resolve(channelName)}).catch(err=>{reject(err)})}})}onChannelMessageReceived(stanza){try{const eventNode=$(stanza).find("event");if(eventNode&&"http://jabber.org/protocol/pubsub#event"===eventNode.attr("xmlns")){const items=eventNode.find("items"),item=items.find("item"),retract=items.find("retract"),update=eventNode.find("update");if(1===update.length)this.updateMessage(update);else if(1===item.length)this.onNewMessage(item);else if(1===retract.length){const messageId=retract.attr("id"),channelId=items.attr("node").split(":")[0];this.onRetractMessage(channelId,messageId)}}return!0}catch(err){return this.logger.error("onChannelMessageReceived -- failure -- "+err.message),!0}}onNewMessage(item){const entry=item.find("entry"),messageId=item.attr("id"),channelId=entry.attr("channelId"),channel=this.getChannelFromCache(channelId),channelMessageIndex=channel.messages.findIndex(mess=>mess.id===messageId),feedMessageIndex=this.feedChannel.messages.findIndex(mess=>mess.id===messageId);let action=entry.attr("creation")?"modify":"new";-1===channelMessageIndex&&-1===feedMessageIndex||(action="modify"),this.logger.info("[channelService] onChannelMessageReceived -- "+action+" message "+messageId+" on channel "+channelId);const message={id:messageId,channelId:channelId,from:entry.attr("from"),fromDetails:null,new:!1,entry:{type:entry.find("type").length?entry.find("type")[0].textContent:"",message:entry.find("message").length?entry.find("message")[0].textContent:"",title:entry.find("title").length?entry.find("title")[0].textContent:"",url:entry.find("url").length?entry.find("url")[0].textContent:"",images:[],attachments:[],video:null},modified:"modify"===action,timestamp:new Date(entry.attr("timestamp"))},imagesElem=item.find("images");0!==imagesElem.length&&imagesElem.find("id").each((__index,image)=>{message.entry.images.push({id:image.textContent})});const attachmentsElem=item.find("attachments");0!==attachmentsElem.length&&attachmentsElem.find("id").each((__index,attachment)=>{message.entry.attachments.push({id:attachment.textContent})});const videoElem=item.find("video");if(0!==videoElem.length&&(message.entry.video={provider:videoElem.find("provider")[0].textContent,id:videoElem.find("id")[0].textContent}),"new"===action){const channelMessage=channelMessage_model_1.ChannelMessage.createFromData(channel,message);channel.loaded&&channel.messages.unshift(channelMessage),this.feedChannel.messages.unshift(channelMessage),this.contactService.userContact.jid!==message.from&&(channelMessage.isNew=!0,this.incrementMessagesCounter()),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.ADD,message),this.rxSubject.next(event_model_1.RBEvent.create(this.CHANNEL_MESSAGE_RECEIVED,{action:this.MESSAGE_ACTION.ADD,message:message}))}else{const channelMessage=channelMessage_model_1.ChannelMessage.createFromData(channel,message);-1!==channelMessageIndex&&channel.messages.splice(channelMessageIndex,1,channelMessage),-1!==feedMessageIndex&&this.feedChannel.messages.splice(feedMessageIndex,1,channelMessage)}}updateMessage(update){const messageId=update.attr("id"),channelId=update.attr("channel_id"),channelMessage=this.getChannelMessage(channelId,messageId);if(channelMessage){const myLikeElem=update.find("my_appreciation");channelMessage.myLike=1===myLikeElem.length?myLikeElem.attr("appreciation"):"none";const likesElem=update.find("appreciations"),likeKeys=["like","happy","applause","fantastic","doubt"];1===likesElem.length&&(channelMessage.likeCounters=likeKeys.reduce((result,key)=>(result[key]=parseInt(likesElem.attr(key)||0,10),result),{})),channelMessage.publishUpdate()}}getChannelMessage(channelId,messageId){const channel=this.getChannelFromCache(channelId);if(channel){const channelMessageIndex=channel.messages.findIndex(mess=>mess.id===messageId),feedMessageIndex=this.feedChannel.messages.findIndex(mess=>mess.id===messageId);let channelMessage=-1!==channelMessageIndex?channel.messages.find(mess=>mess.id===messageId):null;return channelMessage||-1===feedMessageIndex||(channelMessage=this.feedChannel.messages.find(mess=>mess.id===messageId)),channelMessage}return null}onRetractMessage(channelId,messageId){this.logger.info("[channelService] onRetractMessage -- retract message "+messageId+" on channel "+channelId);const channel=this.getChannelFromCache(channelId),messageIndex=channel.messages.findIndex(message=>message.id===messageId);if(-1!==messageIndex){channel.messages[messageIndex].new&&this.decrementMessagesCounter(),channel.messages.splice(messageIndex,1)}const messageListIndex=this.feedChannel.messages.findIndex(message=>message.id===messageId);-1!==messageListIndex&&this.feedChannel.messages.splice(messageListIndex,1),this.$rootScope.$broadcast(this.CHANNEL_MESSAGE_RECEIVED,this.MESSAGE_ACTION.RETRACT)}onChannelManagementReceived(stanza){try{const channelMuteElem=angular.element(stanza).find("mute");if(channelMuteElem&&channelMuteElem.length>0&&"channel"===channelMuteElem.attr("type")){const channelId=channelMuteElem.attr("peer_id"),channel=this.getChannelFromCache(channelId);this.muteChannel(channel)}const channelUnmuteElem=angular.element(stanza).find("unmute");if(channelUnmuteElem&&channelUnmuteElem.length>0&&"channel"===channelUnmuteElem.attr("type")){const channelId=channelUnmuteElem.attr("peer_id"),channel=this.getChannelFromCache(channelId);this.unmuteChannel(channel)}const channelElem=angular.element(stanza).find("channel");if(channelElem&&channelElem.length>0){const channelId=channelElem.attr("channelid"),channel=this.getChannelFromCache(channelId);if(channel){const avatarElem=channelElem.find("avatar"),nameElem=channelElem.find("name"),topicElem=channelElem.find("topic"),categoryElem=channelElem.find("category");avatarElem&&avatarElem.length>0&&this.onAvatarChange(channelId,avatarElem),nameElem&&nameElem.length>0&&(channel.name=nameElem.text()),topicElem&&topicElem.length>0&&(channel.topic=topicElem.text()),categoryElem&&categoryElem.length>0&&(channel.category=categoryElem.text()),this.updateDisplayInfo(channel)}const action=channelElem.attr("action");switch(this.logger.info("[channelService] onChannelManagementReceived -- "+action+" event received on channel "+channelId),action){case"add":this.onAddToChannel(channelId);break;case"update":this.onUpdateToChannel(channelId);break;case"remove":this.onRemovedFromChannel(channelId);break;case"subscribe":this.onSubscribeToChannel(channelId,channelElem.attr("subscribers"));break;case"unsubscribe":this.onUnsubscribeToChannel(channelId,channelElem.attr("subscribers"));break;case"delete":this.onDeleteChannel(channelId)}}const channelSubscriptionElem=angular.element(stanza).find("channel-subscription");if(channelSubscriptionElem&&channelSubscriptionElem.length>0){const channelId=channelSubscriptionElem.attr("channelid"),action=channelSubscriptionElem.attr("action"),userId=channelSubscriptionElem.attr("id"),subscribers=channelSubscriptionElem.attr("subscribers");switch(this.getChannelFromCache(channelId).subscribers_count=Number.parseInt(subscribers,10),this.logger.info("[channelService] onChannelManagementReceived -- subscription-"+action+" event received on channel "+channelId),action){case"subscribe":this.onUserSubscribeEvent(channelId,userId);break;case"unsubscribe":this.onUserUnsubscribeEvent(channelId,userId)}}return!0}catch(err){return this.logger.error("[channels] onChannelManagementReceived -- failure -- "+err.message),!0}}onAvatarChange(channelId,avatar){const action=avatar.attr("action"),updateDate=avatar.attr("lastAvatarUpdateDate")?new Date(avatar.attr("lastAvatarUpdateDate")):null;if(this.logger.info("[channelService] onChannelManagementReceived -- "+action+" avatar for "+channelId),"delete"===action||"update"===action){const channel=this.getChannelFromCache(channelId);channel.lastAvatarUpdateDate=updateDate,null!==updateDate&&(channel.avatar=config.restServerUrl+"/api/channel-avatar/"+channelId+"?size=256&ts="+new Date(updateDate).getTime())}}onUpdateToChannel(channelId){this.getChannel(channelId).then(newChannel=>{newChannel.invited&&(this.addChannelToCache(newChannel),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,newChannel.id))})}onAddToChannel(channelId){const channel=this.getChannelFromCache(channelId);this.getChannel(channelId).then(newChannel=>{channel||newChannel.invited?!channel&&newChannel.invited?(this.addChannelToCache(newChannel),this.incrementInvitationCounter(),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,newChannel.id)):channel&&newChannel.userRole!==this.USER_ROLE.NONE&&(channel.userRole=newChannel.userRole,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId)})):(this.addChannelToCache(newChannel),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.ADD,newChannel.id))})}onRemovedFromChannel(channelId){this.removeChannelFromCache(channelId).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,channelId)})}onSubscribeToChannel(channelId,subscribersInfo){const channel=this.getChannelFromCache(channelId),subscribers=Number.parseInt(subscribersInfo,10);channel?(channel.invited=!1,channel.subscribed=!0,channel.subscribers_count=subscribers,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId)})):this.getChannel(channelId).then(newChannel=>(this.addChannelToCache(newChannel),this.feedChannel.messages=[],this.retrieveLatests())).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId)})}onUnsubscribeToChannel(channelId,subscribersInfo){const subscribers=Number.parseInt(subscribersInfo,10),channel=this.getChannelFromCache(channelId);channel.subscribers_count=subscribers,channel.subscribed=!1,this.feedChannel.messages=[],this.retrieveLatests().then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,channelId)})}onDeleteChannel(channelId){this.removeChannelFromCache(channelId).then(()=>{this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.DELETE,channelId)})}onUserSubscribeEvent(channelId,userId){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.SUBSCRIBE,channelId,userId)}onUserUnsubscribeEvent(channelId,userId){this.$rootScope.$broadcast(this.CHANNEL_USER_SUBSCRIPTION_EVENT,this.LIST_EVENT_TYPE.UNSUBSCRIBE,channelId,userId)}getChannelNextPage(channel,reset=!1){return __awaiter(this,void 0,void 0,(function*(){const logChannelName="AGGREGATE"===channel.type?"feedChannel":channel.id;try{if(channel.isLoading)return void this.logger.info("-- getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- ignored (isLoading)");channel.isLoading=!0,reset&&(channel.pageIndex=0);const askedMessagesNumber=(channel.pageIndex+1)*ChannelServiceAgnostic.PAGE_SIZE;if(askedMessagesNumber<=channel.messages.length)return this.logger.info("-- getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- success from cache"),channel.pageIndex+=1,channel.isLoading=!1,{messages:channel.messages,nbMessages:askedMessagesNumber};if(channel.complete)return this.logger.info("-- getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- success from cache (complete)"),channel.isLoading=!1,{messages:channel.messages,nbMessages:channel.messages.length};const messages=channel.messages,lastMessageDate=messages.length?messages[messages.length-1].timestamp:null,nbMessages=yield this.getChannelMessages(channel,lastMessageDate);return nbMessages<ChannelServiceAgnostic.PAGE_SIZE&&(channel.complete=!0),this.logger.info("-- getChannelNextPage("+logChannelName+", "+channel.pageIndex+") -- success from server "+(channel.complete?"(complete)":"")+" -- retreive "+nbMessages+" message(s)"),channel.pageIndex+=1,channel.loaded=!0,channel.isLoading=!1,{messages:channel.messages,nbMessages:channel.messages.length}}catch(error){throw channel.isLoading=!1,this.channelErrorHandler("getChannelNextPage("+logChannelName+", "+channel.pageIndex+")",error)}}))}getChannelPublishers(channel){return new Promise((resolve,reject)=>{if(channel.publishersRetreived)return resolve();this.getChannelUsers(channel.id,{format:"full",types:"owner publisher"}).then(usersData=>{usersData.data.forEach(userData=>{let contact=this.contactService.getContactByJid(userData.jid_im);contact||(contact=this.contactService.createContact(),contact.updateFromUserData(userData),this.contactService.updateContactRichStatus(contact),this.contactService.contacts[contact.id]=contact,this.contactService.dbContacts[contact.dbId]=contact,this.contactService.jtelContacts[contact.jidtel]=contact),channel.users.push(contact)}),channel.publishersRetreived=!0,this.logger.info("[channelService] getChannelPublishers ("+channel.id+") -- success -- find "+usersData.length+" publisher(s)"),resolve()}).catch(err=>{reject(this.channelErrorHandler("getChannelPublishers ("+channel.id+")",err))})})}getChannelMessages(channel,beforeDate){return __awaiter(this,void 0,void 0,(function*(){try{let provider=null;provider="AGGREGATE"===channel.type?this.getLatestMessages(10,beforeDate):this.getChannelItems(channel.id,ChannelServiceAgnostic.PAGE_SIZE,beforeDate);const messages=(yield provider).map(messageData=>channelMessage_model_1.ChannelMessage.createFromData(this.getChannelFromCache(messageData.channelId),messageData));return channel.messages.push.apply(channel.messages,messages),messages.length}catch(error){throw this.channelErrorHandler("getChannelMessages ("+channel.id+")",error)}}))}getChannelInvitations(){return this.channelsList.filter(channel=>!channel.deleted&&channel.invited)}muteChannel(channel){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/${channel.id}/mute`,responseData=yield fetch(url,{method:"POST",headers:this.authService.getPostHeader()});if(!responseData.ok)throw new Error(responseData.statusText);channel.muted=!0,channel.updateSubject.next()}catch(error){throw this.channelErrorHandler("muteChannel",error)}}))}unmuteChannel(channel){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/${channel.id}/mute`,responseData=yield fetch(url,{method:"DELETE",headers:this.authService.getPostHeader()});if(!responseData.ok)throw new Error(responseData.statusText);channel.muted=!1,channel.updateSubject.next()}catch(error){throw this.channelErrorHandler("unmuteChannel",error)}}))}createChannel(name,mode,topic="",category="globalnews",autoProvisionning=!1,max_items=100){return new Promise((resolve,reject)=>{const url=this.portalURL+(autoProvisionning?"?auto_provisioning=true":""),data={name:name,mode:mode,topic:topic,category:category,max_items:max_items};this.$http({method:"POST",url:url,headers:this.authService.getPostHeader(),data:data}).then(response=>{this.logger.info("[channelService] createChannel -- "+name+" -- "+mode+" -- success");const channel=channel_1.Channel.create(response.data.data);this.updateDisplayInfo(channel),resolve(channel)}).catch(err=>{reject(this.channelErrorHandler("createChannel -- "+name+" -- "+mode,err))})})}deleteChannel(channelId){return new Promise((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId,headers:this.authService.getPostHeader()}).then(response=>{this.logger.info("[channelService] deleteChannel -- "+channelId+" -- success"),resolve(response)}).catch(err=>{reject(this.channelErrorHandler("deleteChannel ("+channelId+")",err))})})}findChannels(filter){return new Promise((resolve,reject)=>{let query="?sortOrder="+(filter.sortOrder&&1===filter.sortOrder?"1":"-1");void 0!==filter.subscribed&&(query+="&subscribed="+filter.subscribed),filter.name&&(query+="&name="+filter.name),filter.topic&&(query+="&topic="+filter.topic),filter.limit&&(query+="&limit="+filter.limit),filter.offset&&(query+="&offset="+filter.offset),filter.sortField&&(query+="&sortField="+filter.sortField),filter.category&&(query+="&category="+filter.category),this.$http({method:"GET",url:this.portalURL+"/search"+query,headers:this.authService.getRequestHeader()}).then(response=>{const channels=[];response.data.data.forEach(channelData=>{const channel=channel_1.Channel.create(channelData);this.updateDisplayInfo(channel),channels.push(channel)}),resolve(channels)}).catch(err=>{reject(this.channelErrorHandler("findChannels ("+query+")",err))})})}browseChannels(filter){return new Promise((resolve,reject)=>{let query="?sortOrder="+(filter.sortOrder&&1===filter.sortOrder?"1":"-1");filter.category&&(query+="&category="+filter.category),filter.excluded_category&&(query+="&excluded_category="+filter.excluded_category),void 0!==filter.subscribed&&(query+="&subscribed="+filter.subscribed),filter.limit&&(query+="&limit="+filter.limit),filter.offset&&(query+="&offset="+filter.offset),filter.sortField&&(query+="&sortField="+filter.sortField),this.$http({method:"GET",url:this.portalURL+"/browse"+query,headers:this.authService.getRequestHeader()}).then(response=>{const channels=[];response.data.data.forEach(channelData=>{const channel=channel_1.Channel.create(channelData);this.updateDisplayInfo(channel),channels.push(channel)}),resolve(channels)}).catch(err=>{reject(this.channelErrorHandler("browseChannels ("+query+")",err))})})}getChannel(channelId){return new Promise((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+channelId,headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] getChannel -- "+channelId+" -- success");const channel=channel_1.Channel.create(response.data.data);this.updateDisplayInfo(channel),resolve(channel)}).catch(err=>{reject(this.channelErrorHandler("getChannel ("+channelId+")",err))})})}getChannelFromCache(channelId){const channel=this.channels[channelId];return void 0!==channel?channel:null}publishToChannel(channelId,itemId,type,message,title,url,images,video,attachments){return new Promise((resolve,reject)=>{const data={type:type,title:title||"",message:message||"",images:images||[],attachments:attachments||[]},queryParam=itemId?"?itemId="+itemId:"";video&&(data.video=video),this.$http({method:"POST",url:this.portalURL+"/"+channelId+"/publish"+queryParam,headers:this.authService.getRequestHeader(),data:data}).then(response=>{this.logger.info("[channelService] publishToChannel -- "+channelId+" -- "+type+" -- success"),resolve(response)}).catch(err=>{reject(this.channelErrorHandler("publishToChannel ("+channelId+")",err))})})}subscribeToChannel(channel){return new Promise((resolve,reject)=>{this.$http({method:"POST",url:this.portalURL+"/"+channel.id+"/subscribe",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] subscribeToChannel -- "+channel.id+" -- success"),channel.subscribed=!0,channel.users_count+=1,resolve(response)}).catch(err=>{reject(this.channelErrorHandler("subscribeToChannel ("+channel.id+")",err))})})}unsubscribeToChannel(channel){return new Promise((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channel.id+"/subscribe",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] unsubscribeToChannel -- success"),channel.subscribed=!1,channel.users_count-=1,channel.userRole=this.USER_ROLE.NONE,resolve(response)}).catch(err=>{reject(this.channelErrorHandler("unsubscribeToChannel",err))})})}updateChannel(channelId,options){return new Promise((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+channelId,headers:this.authService.getPostHeader(),data:options}).then(response=>{const channel=this.getChannelFromCache(channelId);channel.name=response.data.data.name,channel.topic=response.data.data.topic,channel.category=response.data.data.category,this.updateDisplayInfo(channel),this.logger.info("[channelService] updateChannel ( "+channelId+") -- success"),this.$rootScope.$broadcast(this.CHANNEL_UPDATE_EVENT,this.LIST_EVENT_TYPE.UPDATE,channel.id),channel.updateSubject.next(),resolve(channel)}).catch(err=>{reject(this.channelErrorHandler("updateChannel ("+channelId+")",err))})})}getChannelItems(channelId,maxMessages,beforeDate=null,afterDate=null){return new Promise((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+channelId+"/items",headers:this.authService.getRequestHeader(),params:{max:maxMessages,before:beforeDate,after:afterDate}}).then(response=>{this.logger.info("[channelService] getChannelItems -- success");this.getChannelFromCache(channelId).messagesCount=response.data.data.status.count,this.chewReceivedItems(response.data.data.items),resolve(response.data.data.items)}).catch(err=>{reject(this.channelErrorHandler("getChannelItems",err))})})}deleteChannelItem(channelId,itemId){return new Promise((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId+"/items/"+itemId,headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] deleteChannelItem ("+channelId+") -- success"),resolve()}).catch(err=>{reject(this.channelErrorHandler("deleteChannelItem ("+channelId+")",err))})})}getChannelUsers(channelId,options){return new Promise((resolve,reject)=>{const data={};options&&(options.format&&"string"==typeof options.format&&options.format.length&&(data.format=options.format),options.limit&&"number"==typeof options.limit&&options.limit>0&&(data.limit=options.limit),options.offset&&"number"==typeof options.offset&&options.offset>0&&(data.offset=options.offset),options.sortField&&"string"==typeof options.sortField&&options.sortField.length&&(data.sortField=options.sortField),!options.sortOrder||"-1"!==options.sortOrder&&"1"!==options.sortOrder||(data.sortOrder=options.sortOrder));let url=this.portalURL+"/"+channelId+"/users";options&&(options.types&&"string"==typeof options.types&&options.types.length?url+="?types="+options.types:options.invited&&"boolean"==typeof options.invited&&(url+="?invited="+options.invited)),this.$http({method:"GET",url:url,headers:this.authService.getRequestHeader(),params:data}).then(response=>{this.logger.info("[channelService] getChannelUsers ("+channelId+") -- success"),resolve(response.data)}).catch(err=>{reject(this.channelErrorHandler("getChannelUsers ("+channelId+")",err))})})}searchUsersByName(channelId,displayName,options){return options.displayName=displayName,new Promise((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/"+channelId+"/users/search",headers:this.authService.getRequestHeader(),params:options}).then(response=>{this.logger.info("[channelService] searchUsersByName ("+channelId+" -- success"),resolve(response.data.data)}).catch(err=>{reject(this.channelErrorHandler("searchUsersByName ("+channelId+")",err))})})}deleteChannelAvatar(channel){return new Promise((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channel.id+"/avatar",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] deleteChannelAvatar "+channel.id+" -- success"),resolve(response),channel.avatar=null,channel.lastAvatarUpdateDate=null,channel.updateSubject.next()}).catch(err=>{reject(this.channelErrorHandler("deleteChannelAvatar "+channel.id,err))})})}uploadChannelAvatar(channel,avatar,avatarSize){return new Promise((resolve,reject)=>{imageUtils_service_1.resizeImage(avatar,avatarSize,avatarSize).then(resizedImage=>{const binaryData=imageUtils_service_1.getBinaryData(resizedImage);this.$http({method:"POST",url:this.portalURL+"/"+channel.id+"/avatar",headers:this.authService.getPostHeader("image/"+binaryData.type),data:binaryData.data,transformRequest:[]}).then(response=>{this.logger.info("[channelService] uploadChannelAvatar "+channel.id+" -- success"),channel.avatar=resizedImage.src,channel.lastAvatarUpdateDate=new Date,channel.updateSubject.next(),resolve(response)}).catch(err=>{reject(this.channelErrorHandler("uploadChannelAvatar",err))})})})}updateChannelUsers(channelId,users,userType){return new Promise((resolve,reject)=>{const members=users.map(user=>({id:user.dbId,type:userType}));this.$http({method:"PUT",url:this.portalURL+"/"+channelId+"/users",headers:this.authService.getRequestHeader(),data:{data:members}}).then(response=>{this.logger.info("[channelService] updateChannelUsers -- success");const usersLists=response.data.data;this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,channelId,usersLists),resolve(usersLists)}).catch(err=>{reject(this.channelErrorHandler("updateChannelUsers",err))})})}usersUpdateHandler(_event,channelId,users){const channel=this.getChannelFromCache(channelId);if(null!==users){if(channel.users_count+=users.added.length-users.removed.length,channel.users.length){for(let i=0;i<users.added.length;i++)this.contactService.getContactByDBId(users.added[i]).then(contact=>{channel.users.push(contact)});for(let i=0;i<users.removed.length;i++)for(let j=channel.users.length-1;j>=0;j--)if(channel.users[j].dbId===users.removed[i]){channel.users.splice(j,1);break}}if(users.invalidUsers&&users.invalidUsers.length&&"409005"===users.invalidUsers[0].errorDetailsCode){const message=this.i18n.translate("inviteUsersError");this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}}}retrieveUsers(channel){if(this.logger.info("Retrieving users"),0===channel.users.length&&channel.userRole===this.USER_ROLE.OWNER){let publishers;const owner=this.contactService.userContact;return owner.type="owner",this.getChannelUsers(channel.id,{format:"full",types:"publisher",limit:19}).then(pubs=>(publishers=pubs.data.length?pubs.data:[],publishers.length<19?this.getChannelUsers(channel.id,{format:"full",types:"member",limit:19-publishers.length}):[])).then(members=>{publishers.push.apply(publishers,members.data);const users=publishers;return channel.users=this.usersToContacts(users),channel.users.unshift(owner),channel.users})}return Promise.resolve(null)}usersToContacts(users){if(null!==users)return users.map(user=>{const contact=this.contactService.createContact(user.jid_im,user.firstName,user.lastName,user.company,user.loginEmail);contact.dbId=user.id,contact.lastAvatarUpdateDate=user.lastAvatarUpdateDate,contact.type=user.type||user.affiliation,contact.getAvatar()})}retrieveLatests(beforeDate=null){return this.getLatestMessages(10,beforeDate,null).then(messagesData=>{const channelMessages=messagesData.map(messageData=>channelMessage_model_1.ChannelMessage.createFromData(this.getChannelFromCache(messageData.channelId),messageData));return this.feedChannel.messages.push.apply(this.feedChannel.messages,channelMessages),channelMessages.length})}incrementMessagesCounter(){this.messageCounter+=1,this.updateNotificationCounter()}decrementMessagesCounter(){this.messageCounter-=1,this.updateNotificationCounter()}incrementInvitationCounter(){this.invitationCounter+=1,this.updateNotificationCounter()}decrementInvitationCounter(){this.invitationCounter-=1,this.updateNotificationCounter()}ackMessages(){this.messageCounter=0,this.updateNotificationCounter(),this.feedChannel.messages.forEach(message=>{message.new=!1})}ackMessage(messageId){this.feedChannel.messages.forEach(message=>{message.id===messageId&&(message.new=!1)}),this.decrementMessagesCounter()}updateNotificationCounter(){this.notificationCounter=this.messageCounter+this.invitationCounter,this.notificationCounter<0&&(this.notificationCounter=0),this.$rootScope.$broadcast(this.CHANNEL_NOTIFICATION_NUMBER_UPDATED,this.notificationCounter)}removeAllUsersFromChannel(channelId){return new Promise((resolve,reject)=>{this.$http({method:"DELETE",url:this.portalURL+"/"+channelId+"/users",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] Removed all users from channel -- success"),this.$rootScope.$broadcast(this.CHANNEL_USERS_UPDATE_EVENT,channelId,null),resolve(response)}).catch(err=>{reject(this.channelErrorHandler("removeAllUsersFromChannel",err))})})}getPortalInfos(){return new Promise((resolve,reject)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/channels/v1.0/about",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] successfully retrieved portal infos -- success"),resolve(response.data)}).catch(err=>{reject(this.channelErrorHandler("getPortalInfos",err))})})}getLatestMessages(maxMessages,beforeDate=null,afterDate=null){return new Promise((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/latest-items",headers:this.authService.getRequestHeader(),params:{max:maxMessages,before:beforeDate,after:afterDate}}).then(response=>{this.chewReceivedItems(response.data.data.items),resolve(response.data.data.items)}).catch(err=>{reject(this.channelErrorHandler("getLatestMessages",err))})})}acceptInvitation(channelId){return new Promise((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+channelId+"/accept",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] acceptInvitation ("+channelId+") -- success"),this.decrementInvitationCounter(),resolve(response)}).catch(err=>{reject(this.channelErrorHandler("acceptInvitation",err))})})}declineInvitation(channelId){return new Promise((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+channelId+"/decline",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[channelService] declineInvitation ("+channelId+") -- success"),this.decrementInvitationCounter(),resolve(response)}).catch(err=>{reject(this.channelErrorHandler("declineInvitation",err))})})}chewReceivedItems(items){items.forEach(item=>{"urn:xmpp:channels:simple"===item.type&&(item.entry={message:item.message},delete item.message),item.modified=void 0!==item.creation})}updateChannelsList(){this.channelsList=Object.keys(this.channels).map(key=>this.channels[key])}addChannelToCache(channel){this.channels[channel.id]=channel,this.updateChannelsList()}channelErrorHandler(methodName,err){let error=null;return err.data?(this.logger.error("[channelService] "+methodName+" -- failure -- "+err.data.errorDetails),error=new RBError(err.data.errorMsg,err.data.errorDetails,err.data.errorDetailsCode)):(this.logger.error("[channelService] "+methodName+" -- failure -- Server failure"),error=new RBError("Server failure")),error}likeChannelItem(channel,message,appreciation){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${this.portalURL}/${channel.id}/items/${message.id}/like`,body=JSON.stringify({appreciation:appreciation}),responseData=yield fetch(url,{method:"POST",headers:this.authService.getPostHeader(),body:body});if(!responseData.ok)throw new Error(responseData.statusText);return(yield responseData.json()).data}catch(error){const errorMessage="getChannelItemReactions -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}getChannelMessageReactions(channelMessage,reaction){return __awaiter(this,void 0,void 0,(function*(){try{let url=`${this.portalURL}/${channelMessage.channel.id}/items/${channelMessage.id}/likes?limit=400`;reaction&&(url+="&appreciation="+reaction);const headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw new Error(responseData.statusText);return(yield responseData.json()).data.items.map(data=>{let contact=this.contactService.getContactById(data.id);contact||(contact=this.contactService.createContact(data.id,data.firstName,data.lastName),contact.createTextAvatarImage());let info=data.companyName;return contact.jobTitle&&(info=contact.jobTitle+" - "+info),{reaction:data.appreciation,contact:contact,info:info}})}catch(error){const errorMessage="getChannelItemReactions -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}updateDisplayInfo(channel){channel.displayName=_escape(channel.name),channel.displayTopic=_escape(channel.topic)}}exports.ChannelServiceAgnostic=ChannelServiceAgnostic,ChannelServiceAgnostic.PAGE_SIZE=10},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ChannelMessage=void 0;const rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24);class ChannelMessage{constructor(){this.id=null,this.type=null,this.message=null,this.from=null,this.images=null,this.attachments=null,this.contact=null,this.video=null,this.isNew=!0,this.isModified=!1,this.rxSubject=new rxjs_1.Subject}static createFromData(channel,data){const message=new ChannelMessage;return message.isNew=data.new,message.isModified=data.modified,message.id=data.id,message.type=data.type,message.from=data.from,message.timestamp=data.timestamp,message.channel=channel,message.video=data.video,data.entry.message&&(message.message=data.entry.message.replace(/<a/gi,"<a target='_blank' rel='noopener noreferrer' ")),data.entry.video&&(message.video=data.entry.video),data.entry.images&&"null"!==data.entry.images&&void 0!==data.entry.images&&(data.entry.images instanceof Array?data.entry.images.length>0&&(message.images=data.entry.images):message.images=[data.entry.images]),data.entry.attachments&&"null"!==data.entry.attachments&&void 0!==data.entry.attachments&&(data.entry.attachments instanceof Array?data.entry.attachments.length>0&&(message.attachments=data.entry.attachments):message.attachments=[data.entry.attachments]),message.myLike=data.my_appreciation?data.my_appreciation:"none",message.likeCounters=data.appreciations?data.appreciations:{like:0,fantastic:0,applause:0,doubt:0,happy:0},message}publishUpdate(){this.rxSubject.next(event_model_1.RBEvent.create("updateLikes"))}subscribe(handler){return this.rxSubject.subscribe(handler)}}exports.ChannelMessage=ChannelMessage},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FavoriteService=void 0;const favorite_service_1=__webpack_require__(356);class FavoriteService extends favorite_service_1.AgnosticFavoriteService{constructor(conversationService){super(conversationService)}}exports.FavoriteService=FavoriteService,FavoriteService.$inject=["conversationService"],angular.module("rainbow").service("favoriteService",FavoriteService)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AgnosticFavoriteService=void 0;const favorite_model_1=__webpack_require__(357),rxjs_1=__webpack_require__(10),contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),logger_service_1=__webpack_require__(15),room_service_1=__webpack_require__(33);exports.AgnosticFavoriteService=class{constructor(conversationService){this.conversationService=conversationService,this.favorites=[],this.eventNames=[],this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.contactService=contact_service_1.default,this.logger=logger_service_1.default,this.roomService=room_service_1.default}start(stats){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("=== STARTING ===");const startDate=performance.now();this.rxSubject=new rxjs_1.Subject,this.connect();const startDuration=Math.round(performance.now()-startDate);stats.push({service:"favoriteService",startDuration:startDuration}),this.eventNames=["ON_FAVORITE_CREATED","ON_FAVORITE_DELETED","ON_FAVORITE_UPDATED"],this.logger.info(`=== STARTED (${startDuration} ms) ===`)}))}connect(){return __awaiter(this,void 0,void 0,(function*(){try{yield this.getServerFavorites(),this.conversationService.favoriteService=this,this.attachHandlers(),this.rxSubject.next({name:"update"})}catch(error){this.logger.error("connect -- Failure -- "+error.message)}}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("=== STOPPING ==="),this.xmppManagementHandler&&(this.xmppService.deleteHandler(this.xmppManagementHandler),this.xmppManagementHandler=null),this.logger.info("=== STOPPED ===")}))}subscribe(observer){return this.rxSubject.subscribe(observer)}getServerFavorites(){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites`,headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",headers:headers});if(!responseData.ok)throw this.logger.debug(`Request ${responseData.headers.get("x-rainbow-request-id")} failed with status ${responseData.status}`),new Error(responseData.statusText);const promises=(yield responseData.json()).data.map(data=>__awaiter(this,void 0,void 0,(function*(){return this.createFavorite(data.id,data.peerId,data.type)}))),favorites=yield Promise.all(promises);return this.favorites=favorites.filter(favorite=>null!==favorite),this.logger.info(`getServerFavorites -- SUCCESS -- found ${this.favorites.length} favorites`),this.favorites}catch(error){const errorMessage="getServerFavorites -- FAILURE -- "+error.message;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}addServerFavorite(peerId,type){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites`,headers=this.authService.getPostHeader(),body={peerId:peerId,type:type},response=yield fetch(url,{method:"POST",headers:headers,body:JSON.stringify(body)}),responseData=yield response.json();if(responseData.errorDetails&&"FAVORITE_CONVERSATIONS_COUNT"===responseData.errorDetails.feature)throw new Error("Reach FAVORITE_CONVERSATIONS_COUNT");this.logger.info(`addServerFavorite(${peerId}, ${type}) -- SUCCESS`)}catch(error){const errorMessage=`addServerFavorite(${peerId}, ${type}) -- FAILURE -- ${error.message}`;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}removeServerFavorite(favoriteId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites/${favoriteId}`,headers=this.authService.getRequestHeader();yield fetch(url,{method:"DELETE",headers:headers}),this.logger.info(`removeServerFavorite(${favoriteId}) -- SUCCESS`)}catch(error){const errorMessage=`removeServerFavorite(${favoriteId}) -- FAILURE -- ${error.statusText}`;throw this.logger.error(errorMessage),new Error(errorMessage)}}))}toggleFavorite(conversation){return __awaiter(this,void 0,void 0,(function*(){try{const peerId=conversation.contact?conversation.contact.dbId:conversation.room.dbId,type=conversation.contact?conversation.contact.isBot?"bot":"user":"room",favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId);favorite?yield this.removeServerFavorite(favorite.id):yield this.addServerFavorite(peerId,type)}catch(error){throw new Error(error.message)}}))}getFavoriteConversation(peerId){return __awaiter(this,void 0,void 0,(function*(){const favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId),convGetter=favorite.contact?this.conversationService.getOrCreateOneToOneConversation(favorite.contact.jid):this.conversationService.getRoomConversation(favorite.room.jid);return yield convGetter}))}isFavoriteConversation(peerId){return this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId)}moveFavoritePosition(favoriteId,position){try{const url=`${config.restServerUrl}/api/rainbow/enduser/v1.0/users/${this.contactService.userContact.dbId}/favorites/${favoriteId}?position=${position}`,headers=this.authService.getRequestHeader();fetch(url,{method:"PUT",headers:headers}),this.logger.info(`moveFavoritePosition(${favoriteId}, ${position}) -- SUCCESS`)}catch(error){const errorMessage=`moveFavoritePosition(${favoriteId}, ${position}) -- FAILURE -- ${error.statusText}`;throw this.logger.error(errorMessage),new Error(errorMessage)}}createFavorite(id,peerId,type){return __awaiter(this,void 0,void 0,(function*(){try{const favorite=new favorite_model_1.Favorite(id,peerId,type);if("room"===type?favorite.room=this.roomService.getRoomById(peerId):favorite.contact=yield this.contactService.getContactByDBId(peerId),!favorite.room&&!favorite.contact)return this.removeServerFavorite(id),null;const convId=favorite.room?favorite.room.jid:favorite.contact.jid,conv=this.conversationService.getConversationById(convId);return conv&&(conv.isFavorite=!0,favorite.conv=conv),favorite}catch(error){return this.logger.warn(`createFavorite(${id}, ${peerId}, ${type}) -- FAILURE -- ${error.message}`),null}}))}updateFavoriteConversations(conversation){const peerId=conversation.contact?conversation.contact.dbId:conversation.room.dbId,favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId);favorite&&(conversation.isFavorite=!0,favorite.conv=conversation)}onXmppEvent(stanza){return __awaiter(this,void 0,void 0,(function*(){try{const favoriteElem=$(stanza).find("favorite");if(favoriteElem){const id=favoriteElem.attr("id"),type=favoriteElem.attr("type"),peerId=favoriteElem.attr("peer_id"),action=favoriteElem.attr("action");if("create"===action){let favorite=this.favorites.find(favoriteConv=>favoriteConv.peerId===peerId);favorite||(favorite=yield this.createFavorite(id,peerId,type),this.favorites.push(favorite),this.sendEvent("ON_FAVORITE_CREATED",{favorite:favorite}))}else if("delete"===action){const index=this.favorites.findIndex(fav=>fav.peerId===peerId);if(-1!==index){const favorite=this.favorites[index];favorite.conv&&(favorite.conv.isFavorite=!1),this.favorites.splice(index,1),this.sendEvent("ON_FAVORITE_DELETED",{favoriteId:favorite.id})}}else if("update"===action){const targetIndex=parseInt(favoriteElem.attr("position"),10),sourceIndex=this.favorites.findIndex(fav=>fav.id===id);-1!==sourceIndex&&(this.favorites.splice(targetIndex,0,this.favorites.splice(sourceIndex,1)[0]),this.sendEvent("ON_FAVORITE_UPDATED",{favoriteId:id,position:targetIndex}))}}return!0}catch(error){return!0}}))}sendEvent(eventName,detail){const event=new CustomEvent(eventName,{detail:detail});window.dispatchEvent(event)}attachHandlers(){this.xmppManagementHandler&&this.xmppService.deleteHandler(this.xmppManagementHandler),this.xmppManagementHandler=this.xmppService.addHandler(stanza=>(this.onXmppEvent(stanza),!0),null,"message","management")}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Favorite=void 0;exports.Favorite=class{constructor(id,peerId,type){this.id=id,this.peerId=peerId,this.type=type}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VoiceMessageService=void 0;const voiceMessage_service_1=__webpack_require__(359);class VoiceMessageService extends voiceMessage_service_1.AgnosticVoiceMessageService{constructor($rootScope,$http,$injector,telephonyService,fileServerService){super($rootScope,$http,$injector,telephonyService,fileServerService)}}exports.VoiceMessageService=VoiceMessageService,VoiceMessageService.$inject=["$rootScope","$http","$injector","telephonyService","fileServerService"],angular.module("rainbow").service("voiceMessageService",VoiceMessageService)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AgnosticVoiceMessageService=void 0;const rxjs_1=__webpack_require__(10),voiceMessage_model_1=__webpack_require__(360),logger_service_1=__webpack_require__(15),contact_service_1=__webpack_require__(1),settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),fileStorage_service_1=__webpack_require__(25);exports.AgnosticVoiceMessageService=class{constructor($rootScope,$http,$injector,telephonyService,fileServerService){this.$rootScope=$rootScope,this.$http=$http,this.$injector=$injector,this.telephonyService=telephonyService,this.fileServerService=fileServerService,this.portalURL="",this.sipWisePortalURL="",this.listeners=[],this.voiceMessageMngtRef=null,this.messageHandlerRef=null,this.voiceMessages=[],this.xmpp_message_handler=null,this.voiceMessagesCounters={total:0,unread:0},this.unreadVoiceMessageCounter=0,this.voiceMessagePromises={},this.rxSubject=new rxjs_1.Subject,this.CALLSERVICE_NS="urn:xmpp:pbxagent:callservice:1",this.CALLSERVICE_NS_SIPWISE="urn:xmpp:pbxagent:telephony:1",this.settingsService=settings_service_1.default,this.logger=logger_service_1.default,this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.profileService=profile_service_1.default,this.fileStorageService=fileStorage_service_1.default,this.contactService=contact_service_1.default}start(stats){return this.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",this.sipWisePortalURL=config.restServerUrl+"/api/rainbow/voice/v1.0/",this.telephonyService.isSipWiseRoot()&&(this.logger.info("[voiceMessageService] starting in sipWise mode "),this.CALLSERVICE_NS=this.CALLSERVICE_NS_SIPWISE),this.voiceMessagesCounters={total:0,unread:0},new Promise(resolve=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_VOICE_MAIL))return resolve();if(this.contactService.userContact.isCPaaSGuest())return resolve();this.logger.info("[voiceMessageService] === STARTING ===");let startDate=performance.now();this.attachHandlers(),this.telephonyService.isSipWiseRoot()&&this.getVoiceMessagesCounters().then(()=>{this.rxSubject.next({type:"VOICE_MESSAGE_UPDATE",data:this.voiceMessagesCounters}),this.$rootScope.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",this.voiceMessagesCounters)});const startDuration=Math.round(performance.now()-startDate);this.logger.info("[voiceMessageService] === STARTED ("+startDuration+" ms) ==="),stats.push({service:"voiceMessageService",startDuration:startDuration}),resolve()})}attachHandlers(){this.logger.info("[voiceMessageService] attachHandlers"),this.voiceMessageMngtRef&&(this.xmppService.connection.deleteHandler(this.voiceMessageMngtRef),this.voiceMessageMngtRef=null),this.voiceMessageMngtRef=this.xmppService.connection.addHandler(stanza=>this.onVoiceMessageManagement(stanza),null,"message","management"),this.messageHandlerRef&&(this.xmppService.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null),this.messageHandlerRef=this.xmppService.addHandler(stanza=>this.vmCounterHandler(stanza),this.CALLSERVICE_NS,"message",null)}stop(){return new Promise(resolve=>{this.logger.info("[voiceMessageService] === STOPPING ==="),this.listeners.forEach(destroyFunction=>{destroyFunction()}),this.voiceMessagesCounters={total:0,unread:0},this.logger.info("[voiceMessageService] === STOPPED ==="),resolve()})}subscribe(handler){return this.rxSubject.subscribe(handler)}vmCounterHandler(stanza){try{if(this.telephonyService.isSipWiseRoot()){const mwiElem=$(stanza).find("telephony").find("mwi");if(mwiElem&&0!==mwiElem.length){const mwiMessage=mwiElem.find("message"),mwiMsgType=mwiMessage.attr("type"),mwiMsgNew=mwiMessage.attr("new"),mwiMsgOld=mwiMessage.attr("old");mwiMsgType&&"voice"===mwiMsgType&&mwiMsgNew&&mwiMsgOld?(this.voiceMessagesCounters.unread=Number(mwiMsgNew),this.voiceMessagesCounters.total=Number(mwiMsgNew)+Number(mwiMsgOld),this.logger.info("[voiceMessageService] vmCounterHandler SipWise -- Messages total : "+this.voiceMessagesCounters.total+" - Messages Unread : "+this.voiceMessagesCounters.unread),this.rxSubject.next({type:"VOICE_MESSAGE_UPDATE",data:this.voiceMessagesCounters}),this.$rootScope.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",this.voiceMessagesCounters)):this.logger.info("[voiceMessageService] vmCounterHandler SipWise -- anomaly msg attr ")}}else{const vmCounters=$(stanza).find("voiceMessages").find("voiceMessagesCounters");if(vmCounters&&0!==vmCounters.length){const totalVoiceMessageAttr=vmCounters.attr("totalVoiceMessages"),unreadVoiceMessageAttr=vmCounters.attr("unreadVoiceMessages");this.voiceMessagesCounters={total:totalVoiceMessageAttr?parseInt(totalVoiceMessageAttr,10):0,unread:unreadVoiceMessageAttr?parseInt(unreadVoiceMessageAttr,10):0},this.rxSubject.next({type:"VOICE_MESSAGE_UPDATE",data:this.voiceMessagesCounters}),this.$rootScope.$broadcast("ON_VOICE_MESSAGE_UPDATE_EVENT",this.voiceMessagesCounters)}}return!0}catch(error){return!0}}onVoiceMessageManagement(stanza){return __awaiter(this,void 0,void 0,(function*(){try{const voiceMessageEndpointElem=$(stanza).find("visualvoicemail");if(voiceMessageEndpointElem.length&&"abort"===voiceMessageEndpointElem.attr("action")){const voiceMessageId=voiceMessageEndpointElem.attr("msgid"),errorEndPointElem=voiceMessageEndpointElem.find("error");this.voiceMessagePromises[voiceMessageId].reject(new Error(errorEndPointElem.attr("errordetailscode"))),delete this.voiceMessagePromises[voiceMessageId],this.logger.info("[voiceMessageService] onVoiceMessageManagement - "+voiceMessageId+" - abort - "+errorEndPointElem.attr("errormsg"))}else if(voiceMessageEndpointElem.length&&"create"===voiceMessageEndpointElem.attr("action")){const voiceMessageId=voiceMessageEndpointElem.attr("msgid");voiceMessageEndpointElem.find("url").text();let fileId=voiceMessageEndpointElem.find("fileid").text();this.logger.info("[voiceMessageService] onVoiceMessageManagement - "+voiceMessageId+" - create FileId - "+fileId),this.getVoiceMessageById(voiceMessageId)&&(yield this.fileStorageService.retrieveVoiceMessageFileDescriptorsListPerOwner(),this.voiceMessagePromises[voiceMessageId].resolve(voiceMessageId),delete this.voiceMessagePromises[voiceMessageId])}return!0}catch(error){return!0}}))}getVoiceMessageById(msgId){return this.voiceMessages.find(currentVoiceMsg=>msgId===currentVoiceMsg.id)}getVoiceMessagesList(){return __awaiter(this,void 0,void 0,(function*(){if("VVM"!==this.telephonyService.agentStatus.features)return[];try{const response=yield this.$http({method:"GET",url:this.portalURL+"voicemessages",headers:this.authService.getRequestHeader()});this.voiceMessages=[];const voiceMessagesData=response.data.data.voicemessages.voiceMessageList;return this.voiceMessages=yield Promise.all(voiceMessagesData.map(voiceMessageData=>__awaiter(this,void 0,void 0,(function*(){return yield this.createVoiceMessageFromData(voiceMessageData).catch(()=>{})})))),this.logger.info("[voiceMessageService] getVoiceMessagesList success - Messages number : "+this.voiceMessages.length),this.voiceMessages.sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()),this.voiceMessages}catch(error){let errorMessage="getVoiceMessagesList failure -- ";throw errorMessage+=error.status?error.status:error.message,this.logger.error("[voiceMessageService] "+errorMessage),new Error(errorMessage)}}))}getVoiceMessagesCounters(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.telephonyService.isSipWiseRoot()){const voiceMessageCountersData=(yield this.$http({method:"GET",url:this.sipWisePortalURL+"messages",headers:this.authService.getRequestHeader()})).data,counterInbox=Number(voiceMessageCountersData.inbox),counterOld=Number(voiceMessageCountersData.old);return this.voiceMessagesCounters.unread=counterInbox,this.voiceMessagesCounters.total=counterInbox+counterOld,this.logger.info("[voiceMessageService] getVoiceMessagesCounters success - total : "+this.voiceMessagesCounters.total+" - unread : "+this.voiceMessagesCounters.unread),this.voiceMessagesCounters}{const voiceMessageCountersData=(yield this.$http({method:"GET",url:this.portalURL+"voicemessages/counters",headers:this.authService.getRequestHeader()})).data.data.voicemessages.counters;return this.voiceMessagesCounters.total=parseInt(voiceMessageCountersData.total,10),this.voiceMessagesCounters.unread=parseInt(voiceMessageCountersData.unread,10),this.logger.info("[voiceMessageService] getVoiceMessagesCounters success - total : "+this.voiceMessagesCounters.total+" - unread : "+this.voiceMessagesCounters.unread),this.voiceMessagesCounters}}catch(error){throw this.voiceMessageHandleError("getVoiceMessagesCounters",error)}}))}getVoiceMessagesUnreadCounter(){return this.voiceMessagesCounters.unread}getVoiceMessagesTotalCounter(){return this.voiceMessagesCounters.total}getVoiceMessageAudioFileURL(voiceMessage){return __awaiter(this,void 0,void 0,(function*(){let vmFileDesc=this.fileStorageService.getVoiceMessageFileDescriptorByMsgId(voiceMessage.id);if(vmFileDesc&&"deleted"!==vmFileDesc.state){if("true"===this.settingsService.getSetting("enableUseFilePublicURL"))return yield this.fileServerService.getFileDescriptorPublicUrl(vmFileDesc);{const vmBlob=yield this.fileServerService.getBlobFromFileDescriptor(vmFileDesc);return URL.createObjectURL(vmBlob)}}let voiceMessageId=yield new Promise((resolve,reject)=>{this.voiceMessagePromises[voiceMessage.id]={resolve:resolve,reject:reject},this.getVoiceMessageFromPBX(voiceMessage)});if(vmFileDesc=this.fileStorageService.getVoiceMessageFileDescriptorByMsgId(voiceMessageId),vmFileDesc){const vmBlob=yield this.fileServerService.getBlobFromFileDescriptor(vmFileDesc);return URL.createObjectURL(vmBlob)}}))}getVoiceMessageFromPBX(voiceMessage){return __awaiter(this,void 0,void 0,(function*(){try{let url=this.portalURL+"voicemessages/"+encodeURIComponent(voiceMessage.id)+"?messageDate="+encodeURIComponent(voiceMessage.dateString)+"&messageFrom="+encodeURIComponent(voiceMessage.from);yield this.$http({method:"GET",url:url,headers:this.authService.getRequestHeader()});this.logger.info("[voiceMessageService] getVoiceMessageFromPBX success")}catch(error){throw this.voiceMessageHandleError("getVoiceMessageFromPBX",error)}}))}deleteVoiceMessage(voiceMessageId){return __awaiter(this,void 0,void 0,(function*(){try{yield this.$http({method:"DELETE",url:this.portalURL+"voicemessages/"+voiceMessageId,headers:this.authService.getRequestHeader()});this.logger.info("[voiceMessageService] deleteVoiceMessage success")}catch(error){throw this.voiceMessageHandleError("deleteVoiceMessage",error)}}))}deleteAllVoiceMessages(){return __awaiter(this,void 0,void 0,(function*(){try{yield this.$http({method:"DELETE",url:this.portalURL+"voicemessages/all",headers:this.authService.getRequestHeader()});this.logger.info("[voiceMessageService] deleteAllVoiceMessages success")}catch(error){throw this.voiceMessageHandleError("deleteAllVoiceMessages",error)}}))}createVoiceMessageFromData(data){return new Promise((resolve,reject)=>{if(data){const foundidentity=data.foundidentity;let identityFirstName="",identityLastName="";const otherParticipantJid=data.jid,otherParticipantNumber=data.from;otherParticipantJid||otherParticipantNumber?this.contactService.getOrCreateContact(otherParticipantJid,otherParticipantNumber).then(contact=>{if(this.logger.info("[voiceMessageService] createVoiceMessageFromData otherParticipant jid:"+otherParticipantJid+"  Number:"+otherParticipantNumber+" => contact retrieved (temp:"+contact.temp+")"),!otherParticipantJid&&contact.temp){if(foundidentity&&foundidentity.length){const foundFirstName=foundidentity.attr("firstName"),foundLastName=foundidentity.attr("lastName"),foundDisplayName=foundidentity.attr("displayName");identityFirstName=foundFirstName||"",identityLastName=foundLastName||"",""===identityLastName&&""===identityFirstName&&foundDisplayName&&0!==foundDisplayName.length&&foundDisplayName!==otherParticipantNumber&&(identityLastName=foundDisplayName),(identityFirstName.length||identityLastName.length)&&(this.logger.debug("[voiceMessageService] createVoiceMessageFromData  xNames updated from directories for contact "+contact.id),contact.updateName(identityFirstName,identityLastName))}else try{const centralizedService=this.$injector.get("centralizedService"),reload=!0;centralizedService.outlook.updateContactFromOutlookInfos(contact,otherParticipantNumber,reload).then(updateStatus=>{updateStatus?this.logger.debug("[telephonyService] createVoiceMessageFromData  xNames updated from outlook for contact "+contact.id):this.logger.debug("[telephonyService] createVoiceMessageFromData no update from outlook for contact :"+contact.id)}).catch(err=>{this.logger.debug("[voiceMessageService] createVoiceMessageFromData  no Outlook search available")})}catch(error){}var displayNameisAPhoneNumber=!1;if(this.telephonyService.started)displayNameisAPhoneNumber=contact.displayName.match(/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/)&&this.telephonyService.startAsPhoneNumber(contact.displayName);displayNameisAPhoneNumber&&contact.phoneProCan&&""!==contact.phoneProCan&&(contact.displayName=contact.phoneProCan)}let duration=Number.parseInt(data.length,10);resolve(new voiceMessage_model_1.VoiceMessage(data.id,contact,"true"===data.unread,duration,data.date,data.from,data.jid))}).catch(err=>{this.voiceMessageErrorHandler("getVoiceMessagesList",reject,err),reject("reject")}):reject("neither otherParticipantJid nor otherParticipantNumber")}else reject("no data")})}voiceMessageHandleError(methodName,err){let errorMessage=methodName+" -- failure -- ";return errorMessage+=err.data?err.data.errorDetails:"Server failure",this.logger.error("[voiceMessageService] "+errorMessage),new Error(errorMessage)}voiceMessageErrorHandler(methodName,reject,err){err.data?this.logger.error("[voiceMessageService] "+methodName+" -- failure -- "+err.data.errorDetails):this.logger.error("[voiceMessageService] "+methodName+" -- failure -- Server failure"),reject(err)}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.VoiceMessage=void 0;const rxjs_1=__webpack_require__(10);exports.VoiceMessage=class{constructor(id,contact,unread,duration,date,from,jid){this.id=id,this.contact=contact,this.unread=unread,this.duration=duration,this.date=new Date(date),this.dateString=date,this.from=from,this.jid=jid,this.rxSubject=new rxjs_1.Subject}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PhonebookService=void 0;const phonebook_service_1=__webpack_require__(362);class PhonebookService extends phonebook_service_1.AgnosticPhonebookService{constructor(logger){super(logger)}}exports.PhonebookService=PhonebookService,PhonebookService.$inject=["rainbowLogger"],angular.module("rainbow").service("phonebookService",PhonebookService)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AgnosticPhonebookService=void 0;const contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),profile_service_1=__webpack_require__(8);exports.AgnosticPhonebookService=class{constructor(logger){this.logger=logger,this.authService=auth_service_1.default,this.contactService=contact_service_1.default,this.profileService=profile_service_1.default,this.isPhonebookSearchAllowed=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK)}search(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK))return[];this.logger.info("search PBXContact from phonebook with pattern "+searchPattern);try{const url=`${config.restServerUrl}/api/rainbow/search/v1.0/phonebooks?limit=20&name=${encodeURIComponent(searchPattern)}`,headers=this.authService.getRequestHeader(),responseData=yield fetch(url,{method:"GET",mode:"cors",headers:headers}),phonebooksData=(yield responseData.json()).phoneBooks;return phonebooksData.map(phonebook=>{const contact=this.contactService.createBasicContact(null,phonebook.number);return contact.updateName(phonebook.firstName,phonebook.lastName),contact.getAvatar(),contact})}catch(error){return this.logger.info(`search PBXContact from phonebook with pattern ${searchPattern} --- FAILURE --- ${error.message}`),[]}}))}}},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallLogService=void 0;const callLog_service_1=__webpack_require__(364);class CallLogService extends callLog_service_1.AgnosticCallLogService{constructor(webrtcGatewayService,telephonyService,$injector,$rootScope){super(webrtcGatewayService,telephonyService,$injector,$rootScope)}}exports.CallLogService=CallLogService,CallLogService.$inject=["webrtcGatewayService","telephonyService","$injector","$rootScope"],angular.module("rainbow").service("callLogService",CallLogService)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AgnosticCallLogService=void 0;const callLog_model_1=__webpack_require__(365),rxjs_1=__webpack_require__(10),moment=__webpack_require__(3);__webpack_require__(227);const contact_service_1=__webpack_require__(1),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),logger_service_1=__webpack_require__(15);class AgnosticCallLogService{constructor(webrtcGatewayService,telephonyService,$injector,$rootScope){this.webrtcGatewayService=webrtcGatewayService,this.telephonyService=telephonyService,this.$injector=$injector,this.$rootScope=$rootScope,this.started=!1,this.rxSubject=new rxjs_1.Subject,this.callLogHandlerRef=null,this.callLogMessageAckRef=null,this.callLogNotificationRef=null,this.usePhonebookDirectory=!1,this.callLogPromises=[],this.numberMissedCallLogs=0,this.callLogs=[],this.aggregatedCallLogs=[],this.xmppService=xmpp_service_1.default,this.profileService=profile_service_1.default,this.logger=logger_service_1.default,this.contactService=contact_service_1.default,this.ackAllCallLogsInDBDone=!1,this.onHistoryCallLogMessageReceived=stanza=>__awaiter(this,void 0,void 0,(function*(){const stanzaElem=$(stanza);return stanzaElem.find("call_log").length>0?this.callLogPromises.push(this.createCallLogFromStanza(stanzaElem)):stanzaElem.find("count").length>0&&stanzaElem.find("query").length>0&&($(stanza).find("last").length>0||"0"===stanzaElem.find("count").text())&&($(stanza).find("last").length&&(this.lastTimestamp=$(stanza).find("last").text()),this.logger.info("createCallLogFromStanza --- all calllogs received"),yield Promise.all(this.callLogPromises).catch(()=>{}),this.callLogPromises=[],this.orderCallLogs(),this.startPromise&&(this.started=!0,this.startPromiseResolve(),this.startPromiseResolve=null,this.startPromise=null)),!0})),this.onCallLogAckReceived=stanza=>{try{if($(stanza).find("read").length>0){const msgId=$(stanza).find("read").attr("call_id");this.callLogs.forEach(callLog=>{callLog.id!==msgId||(callLog.read=!0)});const numberMissedCallLogs=this.getMissedCallLogCounter();numberMissedCallLogs!==this.numberMissedCallLogs&&(this.numberMissedCallLogs=numberMissedCallLogs,this.rxSubject.next({type:"ON_CALL_LOG_ACK_UPDATED",value:this.numberMissedCallLogs}))}}catch(error){return this.logger.error("onCallLogAckReceived -- failure --"+error),!0}return!0},this.onCallLogNotificationReceived=stanza=>__awaiter(this,void 0,void 0,(function*(){let stanzaElem=$(stanza);try{if(stanzaElem.find("deleted_call_log").length>0){let peer=stanzaElem.find("deleted_call_log").attr("peer");peer?this.removeCallLogsForUser(peer):(this.callLogs=[],yield this.getCallLogHistoryPage(),this.orderCallLogs())}else stanzaElem.find("updated_call_log").length>0&&(yield this.createCallLogFromStanza(stanzaElem).catch(()=>{}),this.orderCallLogs())}catch(error){return this.logger.error("callLogNotificationReceived -- failure --"+error),!0}return!0})),this.xmppService.connected&&this.attachXMPPListeners(),this.xmppService.subscribeToConnectionEvents(event=>{"ON_XMPP_CONNECTED"===event.name&&(this.attachXMPPListeners(),"RECONNECTION"===event.data.reason&&this.getCallLogHistoryPage()),"ON_XMPP_DISCONNECTED"===event.name&&"LOGOUT"===event.data.reason&&(this.numberMissedCallLogs=0,this.callLogs=[],this.aggregatedCallLogs=[],this.started=!1,this.ackAllCallLogsInDBDone=!1)})}subscribe(observer){return this.rxSubject.subscribe(observer)}start(){return __awaiter(this,void 0,void 0,(function*(){return this.started?Promise.resolve():(this.startPromise=new Promise(resolve=>{this.startPromiseResolve=resolve,this.usePhonebookDirectory=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_PHONE_BOOK)||config.permitSearchFromPhoneBook,this.getCallLogHistoryPage(),this.numberMissedCallLogs>30&&!this.ackAllCallLogsInDBDone&&(this.ackAllCallLogsInDBDone=!0,this.ackAllCallLogsInDB())}),this.startPromise)}))}attachXMPPListeners(){this.getMissedCallLogNumber(),this.callLogHandlerRef&&(this.xmppService.connection.deleteHandler(this.callLogHandlerRef),this.callLogHandlerRef=null),this.callLogHandlerRef=this.xmppService.connection.addHandler(stanza=>this.onHistoryCallLogMessageReceived(stanza),AgnosticCallLogService.CALL_LOG_NAMESPACE,null,null),this.callLogNotificationRef&&(this.xmppService.connection.deleteHandler(this.callLogNotificationRef),this.callLogNotificationRef=null),this.callLogNotificationRef=this.xmppService.connection.addHandler(stanza=>this.onCallLogNotificationReceived(stanza),AgnosticCallLogService.CALL_LOG_NOTIF_NAMESPACE,null,null),this.callLogMessageAckRef&&(this.xmppService.connection.deleteHandler(this.callLogMessageAckRef),this.callLogMessageAckRef=null),this.callLogMessageAckRef=this.xmppService.connection.addHandler(stanza=>this.onCallLogAckReceived(stanza),AgnosticCallLogService.CALL_LOG_ACK_NAMESPACE,null,null)}getCalllogs(){return __awaiter(this,void 0,void 0,(function*(){return yield this.start(),this.callLogs}))}getAggregatedCalllogs(){return __awaiter(this,void 0,void 0,(function*(){return yield this.start(),this.aggregatedCallLogs}))}getSimplifiedCallLogs(){return __awaiter(this,void 0,void 0,(function*(){return yield this.start(),this.callLogs.map(callLog=>({contact:callLog.contact.id,contactDisplayName:callLog.contact.displayName,read:callLog.read,contactInitials:callLog.contact.initials,id:callLog.id,state:callLog.state,date:callLog.date,duration:callLog.duration,direction:callLog.direction,type:callLog.type}))}))}getNumberMissedCallLogs(){return this.numberMissedCallLogs}markCallLogAsRead(id){return __awaiter(this,void 0,void 0,(function*(){const message=$msg({from:this.xmppService.jid,to:this.xmppService.jid});return message.c("read",{xmlns:AgnosticCallLogService.CALL_LOG_ACK_NAMESPACE,call_id:id}),this.xmppService.sendIQ(message)}))}markAllCallsLogsAsRead(){this.callLogs.forEach(callLog=>{if(!callLog.read){const message=$msg({from:this.xmppService.jid,to:this.xmppService.jid});message.c("read",{xmlns:AgnosticCallLogService.CALL_LOG_ACK_NAMESPACE,call_id:callLog.id}),this.xmppService.sendIQ(message)}})}deleteCallLogsForContact(jid){return __awaiter(this,void 0,void 0,(function*(){const message=$iq({from:this.xmppService.jid,to:this.xmppService.jid,type:"set"});return message.c("delete",{xmlns:AgnosticCallLogService.CALL_LOG_NAMESPACE,peer:jid}),this.xmppService.sendIQ(message)}))}deleteOneCallLog(id){return __awaiter(this,void 0,void 0,(function*(){const msg=$iq({from:this.xmppService.jid,to:this.xmppService.jid,type:"set"}).c("delete",{xmlns:AgnosticCallLogService.CALL_LOG_NAMESPACE,call_id:id});return this.xmppService.sendIQ(msg)}))}deleteAllCallLogs(){return __awaiter(this,void 0,void 0,(function*(){const message=$iq({from:this.xmppService.jid,to:this.xmppService.jid,type:"set"});return message.c("delete",{xmlns:AgnosticCallLogService.CALL_LOG_NAMESPACE}),this.xmppService.sendIQ(message)}))}getMissedCallLogNumber(){return __awaiter(this,void 0,void 0,(function*(){const message=$iq({from:this.xmppService.jid,type:"set"});message.c("query",{xmlns:AgnosticCallLogService.CALL_LOG_NAMESPACE}),message.c("set",{xmlns:"http://jabber.org/protocol/rsm"}),message.c("max").t(0).up().up(),message.c("x",{xmlns:"jabber:x:data",type:"submit"}),message.c("field",{var:"read"}).c("value").t("false").up().up();const stanza=yield this.xmppService.sendIQ(message);return this.numberMissedCallLogs=parseInt($(stanza).find("count").text(),10),this.rxSubject.next({type:"ON_CALL_LOG_NUMBER_UPDATED",value:this.numberMissedCallLogs}),this.numberMissedCallLogs}))}getCallLogHistoryPage(useAfter=null){return __awaiter(this,void 0,void 0,(function*(){const message=$iq({from:this.xmppService.jid,type:"set"});message.c("query",{xmlns:AgnosticCallLogService.CALL_LOG_NAMESPACE}),message.c("set",{xmlns:"http://jabber.org/protocol/rsm"}),message.c("max").t(AgnosticCallLogService.CALL_LOG_MAX).up(),useAfter?message.c("after").t(useAfter).up():message.c("before").t("").up(),yield this.xmppService.sendIQ(message)}))}ackAllCallLogsInDB(){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.warn("ackAllCallLogsInDB --- used for "+this.numberMissedCallLogs+" call-logs");const message=$iq({from:this.xmppService.jid,type:"set"});message.c("markallread",{xmlns:AgnosticCallLogService.CALL_LOG_NAMESPACE});const stanza=yield this.xmppService.sendIQ(message);if($(stanza).find("error").length)return void this.logger.warn("ackAllCallLogsInDB --- error ...");yield this.getMissedCallLogNumber()}catch(_a){return void this.logger.warn("ackAllCallLogsInDB --- error ...")}}))}orderCallLogs(){this.callLogs.sort((a,b)=>callLog_model_1.CallLog.getDate(b)-callLog_model_1.CallLog.getDate(a)),this.aggregateCalllogs(),this.$rootScope.$broadcast("ON_CALL_LOG_UPDATED"),this.rxSubject.next({type:"ON_CALL_LOG_UPDATED"});const missedCallLog=this.getMissedCallLogCounter();missedCallLog!==this.numberMissedCallLogs&&(this.numberMissedCallLogs=missedCallLog,this.$rootScope.$broadcast("ON_CALL_LOG_ACK_UPDATED",this.numberMissedCallLogs),this.rxSubject.next({type:"ON_CALL_LOG_ACK_UPDATED",value:this.numberMissedCallLogs}))}aggregateCalllogs(){let current=0;this.aggregatedCallLogs=[];let passed={};this.callLogs.forEach((callLog,ind)=>{const jid=callLog.contact.id;if("conference"===callLog.type)0!==ind&&current++,this.aggregatedCallLogs[current]=callLog,this.aggregatedCallLogs[current].count=1,this.aggregatedCallLogs[current].editable=!1;else if(0===ind)passed[jid]=1,this.aggregatedCallLogs[current]=callLog,this.aggregatedCallLogs[current].count=1,this.aggregatedCallLogs[current].editable=!0,"missed"===callLog.state&&"incoming"===callLog.direction?this.aggregatedCallLogs[current].isMissed=!0:"missed"===callLog.state&&"outgoing"===callLog.direction&&(this.aggregatedCallLogs[current].isNotAnswered=!0);else if(passed[jid]){var index=passed[jid],element=this.aggregatedCallLogs[index-1];element.editable&&(element.isMissed&&"missed"===callLog.state&&"incoming"===callLog.direction||element.isNotAnswered&&"missed"===callLog.state&&"outgoing"===callLog.direction?element.count++:element.editable=!1)}else current++,passed[jid]=current+1,this.aggregatedCallLogs[current]=callLog,this.aggregatedCallLogs[current].count=1,this.aggregatedCallLogs[current].editable=!0,"missed"===callLog.state&&"incoming"===callLog.direction?this.aggregatedCallLogs[current].isMissed=!0:"missed"===callLog.state&&"outgoing"===callLog.direction&&(this.aggregatedCallLogs[current].isNotAnswered=!0)})}createCallLogFromStanza(stanzaElem){return __awaiter(this,void 0,void 0,(function*(){let id=stanzaElem.find("call_id").text(),state=stanzaElem.find("state").text();if(this.callLogs.some(callLog=>callLog.id===id||"failed"===state||"ongoing"===state))return this.logger.debug("createCallLogFromStanza --- ignore existing of wrong call-log"),null;let callerJid=stanzaElem.find("caller").text(),calleeJid=stanzaElem.find("callee").text();if(callerJid&&-1!==callerJid.indexOf("janusgateway")||calleeJid&&-1!==calleeJid.indexOf("janusgateway"))return this.logger.debug("createCallLogFromStanza --- ignore janusgateway call-log"),null;if(callerJid&&this.webrtcGatewayService.isMediaPillarJid(callerJid)||calleeJid&&this.webrtcGatewayService.isMediaPillarJid(calleeJid))return this.logger.debug("createCallLogFromStanza --- ignore mediapillar call-log"),null;let type="webrtc",otherParticipantJid=null,otherParticipantNumber=null,isUserContact=this.xmppService.isConnectedJid(callerJid),direction=isUserContact?"outgoing":"incoming",conference="conference"===stanzaElem.find("call_log").attr("service");if(conference)type="conference",otherParticipantJid=callerJid,-1===otherParticipantJid.indexOf("@")&&(otherParticipantNumber=otherParticipantJid,otherParticipantJid=null);else{let typeCall=stanzaElem.find("call_log").attr("type");typeCall||(typeCall=stanzaElem.find("type").text()),"phone"===typeCall&&(type="telephone"),otherParticipantJid=isUserContact?calleeJid:callerJid,-1===otherParticipantJid.indexOf("@")&&(otherParticipantNumber=otherParticipantJid,otherParticipantJid=null,type="telephone")}if(otherParticipantJid||otherParticipantNumber)try{let contact=yield this.contactService.getOrCreateContact(otherParticipantJid,otherParticipantNumber);if(!conference&&!otherParticipantJid&&contact.temp){let foundIdentity=this.usePhonebookDirectory?stanzaElem.find("identity"):null;if(foundIdentity&&foundIdentity.length){let foundFirstName=foundIdentity.attr("firstName"),foundLastName=foundIdentity.attr("lastName"),foundDisplayName=foundIdentity.attr("displayName"),identityFirstName=foundFirstName||"",identityLastName=foundLastName||"";""===identityLastName&&""===identityFirstName&&foundDisplayName&&0!==foundDisplayName.length&&foundDisplayName!==otherParticipantNumber&&(identityLastName=foundDisplayName),(identityFirstName.length||identityLastName.length)&&(this.logger.debug("createCallLogFromStanza xNames updated from phonebook for contact "+contact.id),contact.updateName(identityFirstName,identityLastName))}else try{var centralizedService=this.$injector.get("centralizedService");(yield centralizedService.outlook.updateContactFromOutlookInfos(contact,otherParticipantNumber,!0))&&this.logger.debug("createCallLogFromStanza xNames updated from outlook for contact "+contact.id)}catch(error){this.logger.debug("createCallLogFromMessage no outlook service :"+contact.id)}let displayNameisAPhoneNumber=!1;if(this.telephonyService.started)displayNameisAPhoneNumber=contact.displayName.match(/^[0-9A-D #\-\+\*\(\)\./]{1,32}$/)&&this.telephonyService.startAsPhoneNumber(contact.displayName);displayNameisAPhoneNumber&&contact.phoneProCan&&""!==contact.phoneProCan&&(contact.displayName=contact.phoneProCan)}let read="true"===stanzaElem.find("ack").attr("read"),duration=parseInt(stanzaElem.find("duration").text(),10);duration=duration>0?moment.duration(duration,"ms").format("h[H] mm[m] ss[s]"):0;let date=stanzaElem.find("delay").attr("stamp");date&&(date=new Date(date));let callSubject=stanzaElem.find("subject").text(),callLog=callLog_model_1.CallLog.create(id,contact,state,duration,type,read,date,direction,callSubject,!1);this.callLogs.push(callLog)}catch(error){this.logger.error("createCallLogFromStanza -- failure --- "+error)}}))}getMissedCallLogCounter(){var num=0;return this.callLogs.forEach(callLog=>{callLog.read||"missed"!==callLog.state||"incoming"!==callLog.direction||num++}),num}removeCallLogsForUser(jid){jid.endsWith("@_")&&(jid=jid.substring(0,jid.length-2));for(var newLogs=[],i=0;i<this.callLogs.length;i++)(!this.callLogs[i].contact||this.callLogs[i].contact.jid!==jid&&this.callLogs[i].contact.id!==jid)&&newLogs.push(this.callLogs[i]);this.callLogs=newLogs,this.orderCallLogs()}}exports.AgnosticCallLogService=AgnosticCallLogService,AgnosticCallLogService.CALL_LOG_NAMESPACE="jabber:iq:telephony:call_log",AgnosticCallLogService.CALL_LOG_ACK_NAMESPACE="urn:xmpp:telephony:call_log:receipts",AgnosticCallLogService.CALL_LOG_NOTIF_NAMESPACE="jabber:iq:notification:telephony:call_log",AgnosticCallLogService.CALL_LOG_MAX=75},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallLog=void 0;class CallLog{constructor(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall){this.count=0,this.editable=!1,this.isMissed=!1,this.isNotAnswered=!1,this.id=id,this.contact=contact,this.state=state,this.duration=duration,this.type=type,this.read=read,this.date=date,this.direction=direction,this.callSubject=callSubject,this.isLatestCall=isLatestCall,this.type="unknown"===type||"audio"===type||"webrtc"===type?CallLog.Type.WEBRTC:"telephone"===type?CallLog.Type.TELEPHONE:CallLog.Type.CONFERENCE}static create(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall){return new CallLog(id,contact,state,duration,type,read,date,direction,callSubject,isLatestCall)}static getNames(callLog){let firstname="",lastname="",date=null;return callLog&&callLog.contact&&(firstname=callLog.contact.firstname.toUpperCase(),lastname=callLog.contact.lastname.toUpperCase(),date=callLog.date?callLog.date.getTime():null),{firstname:firstname,lastname:lastname,date:date}}static getDate(callLog){return callLog&&callLog.date?callLog.date.getTime():0}static sortByContact(callLogA,callLogB){var res=-1;if(callLogA&&callLogA.value.lastname&&callLogB&&callLogB.value.lastname){var str1=callLogA.value.lastname,str2=callLogB.value.lastname;0===(res=str1.localeCompare(str2))&&(str1=callLogA.value.firstname,str2=callLogB.value.firstname,0===(res=str1.localeCompare(str2))&&callLogB.value.date&&callLogA.value.date&&(res=callLogB.value.date-callLogA.value.date))}return res}static sortByDate(callLogA,callLogB){var res=1;return callLogA&&callLogB&&(res=callLogB.value-callLogA.value),res}updateCallLogDisplayInfo(grouped=!1){"incoming"===this.direction?(this.svgClass="missed"===this.state?"missed":"active",this.svgId="call_made","forwarded"===this.state?(this.svgId="call_missed",this.title="incomingCallForwarded"):this.title="incommingCall","missed"===this.state&&(this.title=grouped&&this.count>1?"missedCalls":"missedCall")):(this.svgId="call_received",this.title="outgoingCall",this.svgClass="active","missed"===this.state&&(this.svgClass="",this.title=grouped&&this.count>1?"noAnswers":"noAnswer"))}}exports.CallLog=CallLog,CallLog.Type={WEBRTC:"webrtc",TELEPHONE:"telephone",CONFERENCE:"conference"}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(5),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1__);angular.module("rainbow").service("ringingService",["$q","$log","$rootScope","$interval","platformService",function($q,$log,$rootScope,$interval,platformService){var service=this,listeners=[];service.start=function(stats){var startDate=performance.now();$log.info("[ringingService] STARTING"),service.notifs=["noSound","ding","harp","hello","complete","duck","appointed","chime","stairs","wet","wilhelm"],service.alarms=["noRingtone","lightBounce","discovery","lounge","uptown","morningLights","miami","farEast","highSpeed","rainDrops","deepSpace","steamTrain","happy","decrescendo","strident","peacefulness","classic1","classic2","classic3","cosy1","cosy2","cosy3","dynamic1","dynamic2","dynamic3","quiet1","quiet2","quiet3","relax1","relax2","relax3"];var audio=new Audio;$rootScope.canPlayOgg=Boolean(audio.canPlayType)&&Boolean(audio.canPlayType('audio/ogg; codecs="vorbis"')),service.audioFileType=$rootScope.canPlayOgg?".ogg":".mp3",audio=null,service.ringbackTone={audio:new Audio("/resources/sounds/outgoing-rings"+service.audioFileType),starting:!1},service.recordTone=new Audio("/resources/sounds/beep-01a"+service.audioFileType),service.SecondCallTone=new Audio("/resources/sounds/start"+service.audioFileType),service.joinWebConfTone=new Audio("/resources/sounds/join_meeting"+service.audioFileType),service.holdTone={audio:new Audio("/resources/sounds/hold-tone"+service.audioFileType),starting:!1},service.holdTone.audio.loop=!0,service.alarmNotifOnce=null,service.setActive(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.settings.activeNotif,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.settings.activeAlarm);var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"ringingService",startDuration:startDuration}),$log.info("[ringingService] === STARTED ("+startDuration+" ms) ==="),listeners.push($rootScope.$on("ON_WEB_CONFENRECE_PARTICIPANT_JOINED_EVENT",service.playWebConferenceJoinNotif)),$q.when()},service.setActive=function(notif,alarm){service.activeNotif=notif,service.activeAlarm=alarm,"noSound"!==notif?(service.pingAudio=new Audio("/resources/sounds/notifs/"+service.activeNotif+service.audioFileType),service.pingAudioSecondary=new Audio("/resources/sounds/notifs/"+service.activeNotif+service.audioFileType)):(service.pingAudio=null,service.pingAudioSecondary=null,$log.info("Notif sound set to null")),"noRingtone"!==alarm?(service.incomingRingingTone={audio:new Audio("/resources/sounds/alarms/"+service.activeAlarm+service.audioFileType),starting:!1},service.incomingRingingSecondaryTone={audio:new Audio("/resources/sounds/alarms/"+service.activeAlarm+service.audioFileType),starting:!1}):(service.incomingRingingTone=null,service.incomingRingingSecondaryTone=null,$log.info("Ringtone sound set to null"))},service.stop=function(){var listener;for($log.info("[ringingService] STOPPING"),$log.info("[ringingService] STOPPED");listener=listeners.pop();)listener();return service.ringbackTone&&(service.ringbackTone.starting=!1),service.incomingRingingTone&&(service.incomingRingingTone.starting=!1),service.incomingRingingSecondaryTone&&(service.incomingRingingSecondaryTone.starting=!1),$q.when()},service.setActiveAlarm=function(alarm){$log.info("[ringingService] setActiveAlarm to "+alarm),service.activeAlarm=alarm,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.setUserSettings({activeAlarm:service.activeAlarm}),"noRingtone"!==alarm?(service.incomingRingingTone={audio:new Audio("/resources/sounds/alarms/"+service.activeAlarm+service.audioFileType),starting:!1},service.incomingRingingSecondaryTone={audio:new Audio("/resources/sounds/alarms/"+service.activeAlarm+service.audioFileType),starting:!1}):(service.incomingRingingTone=null,service.incomingRingingSecondaryTone=null,$log.info("Ringtone sound set to null"))},service.playAlarmOnce=function(alarm){$log.info("[ringingService] playAlarmOnce "+alarm.name),null!==service.alarmNotifOnce&&service.alarmNotifOnce.pause(),service.alarmNotifOnce=new Audio("/resources/sounds/alarms/"+alarm.name+service.audioFileType),service.alarmNotifOnce.currentTime=0,service.alarmNotifOnce.play(),service.addEvents(service.alarmNotifOnce,alarm)},service.alarmCurPlay=function(){return service.alarmNotifOnce instanceof Audio},service.addEvents=function(audioObject,alarm){audioObject.onended=function(){service.alarmNotifOnce=null,alarm.iconPlayer="play"}},service.stopAlarmOnce=function(){$log.info("[ringingService] stopAlarmOnce"),service.alarmNotifOnce&&(service.alarmNotifOnce.pause(),service.alarmNotifOnce=null)},service.playNotifOnce=function(notif){$log.info("[ringingService] playNotifOnce "+notif.name),service.audioNotifOnce=new Audio("/resources/sounds/notifs/"+notif.name+service.audioFileType),service.audioNotifOnce.currentTime=0,service.audioNotifOnce.play(),service.addEvents(service.audioNotifOnce,notif)},service.notifCurPlay=function(){return service.audioNotifOnce instanceof Audio},service.stopNotifOnce=function(){$log.info("[ringingService] stopNotifOnce"),service.audioNotifOnce.pause(),service.audioNotifOnce=null},service.setActiveNotif=function(notif){$log.info("[ringingService] setActiveNotif to "+notif),service.activeNotif=notif,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.setUserSettings({activeNotif:service.activeNotif}),"noSound"!==notif?(service.pingAudio=new Audio("/resources/sounds/notifs/"+service.activeNotif+service.audioFileType),service.pingAudioSecondary=new Audio("/resources/sounds/notifs/"+service.activeNotif+service.audioFileType)):(service.pingAudio=null,service.pingAudioSecondary=null,$log.info("Notif sound set to null"))},service.playUrgencyNotif=function(){$log.info("[ringingService] playUrgencyNotif"),service.urgencyNotif&&service.urgencyNotif.pause(),service.urgencyNotif=new Audio("/resources/sounds/notifs/emergency.mp3"),service.urgencyNotif.currentTime=0,service.urgencyNotif.play()},service.stopUrgencyNotif=function(){$log.info("[ringingService] stopUrgencyNotif"),service.urgencyNotif&&(service.urgencyNotif.pause(),service.urgencyNotif=null)},service.play=function(tone){if(tone&&tone.audio){var result=tone.audio.play();result&&"function"==typeof result.finally?result.then((function(){$log.info("[ringingService] play ok")})).catch((function(error){$log.error("[ringingService] play error: "+error)})).finally((function(){tone.starting=!1})):($log.info("[ringingService] (no promise) play ok"),tone.starting=!1)}},service.startRingBackTone=function(){$log.info("[ringingService] startRingBackTone ..."),service.ringbackTone&&service.ringbackTone.stopDefered&&($log.info("[ringingService] startRingBackTone: cancel defered stop operation"),$interval.cancel(service.ringbackTone.stopDefered),service.ringbackTone.stopDefered=void 0),service.ringbackTone&&service.ringbackTone.audio&&service.ringbackTone.audio.paused&&!service.ringbackTone.starting?($log.info("[ringingService] startRingBackTone currently paused"),service.ringbackTone.starting=!0,service.ringbackTone.audio.currentTime=0,platformService.allowDevicesManagement()?platformService.getCurrentSpeaker().then((function(speaker){speaker?platformService.setSpeakerForElement(service.ringbackTone.audio,speaker.id).catch((function(){$log.error("[ringingService] startRingBackTone setSpeakerForElement -- error. Play on default device")})).finally((function(){$log.info("[ringingService] startRingBackTone play"),service.play(service.ringbackTone)})):($log.info("[ringingService] startRingBackTone play (no speaker)"),service.play(service.ringbackTone))})).catch((function(){$log.webrtc("[ringingService] startRingBackTone getCurrentSpeaker error"),service.ringbackTone.starting=!1})):($log.info("[ringingService] startRingBackTone play (no devices management)"),service.play(service.ringbackTone))):$log.info("[ringingService] startRingBackTone -- nothing to do (already starting or playing)")},service.stopRingBackTone=function(count){if($log.debug("[ringingService] stopRingBackTone ..."),service.ringbackTone){if(service.ringbackTone.starting)return void(service.ringbackTone.stopDefered?$log.debug("[ringingService] stopRingBackTone: nothing to do : stop already defered"):(count||(count=1),$log.debug("[ringingService] stopRingBackTone: tone still starting: defer stop 1s later"),service.ringbackTone.stopDefered=$interval(service.stopRingBackToneDefered,1e3,1,!0,count)));service.ringbackTone.stopDefered=void 0,service.ringbackTone.audio&&!service.ringbackTone.audio.paused?($log.info("[ringingService] stopRingBackTone: tone is playing: stop it"),service.ringbackTone.audio.pause(),service.ringbackTone.audio.currentTime=0):$log.debug("[ringingService] stopRingBackTone: nothing to do : tone is already stopped")}},service.stopRingBackToneDefered=function(count){service.ringbackTone.stopDefered=void 0,(count+=1)>=3?service.ringbackTone.audio&&($log.info("[ringingService] stopRingBackToneDefered: tone is blocked on starting, stop it"),service.ringbackTone.audio.pause(),service.ringbackTone.audio.currentTime=0,service.ringbackTone.audio.src="",service.ringbackTone.audio.src="/resources/sounds/outgoing-rings"+service.audioFileType):service.stopRingBackTone(count)},service.startIncomingRinging=function(){$log.info("[ringingService] startIncomingRinging ..."),service.incomingRingingTone&&service.incomingRingingTone.stopDefered&&($log.info("[ringingService] startIncomingRinging: cancel defered stop operation"),$interval.cancel(service.incomingRingingTone.stopDefered),service.incomingRingingTone.stopDefered=void 0),service.incomingRingingTone&&service.incomingRingingTone.audio&&service.incomingRingingTone.audio.paused&&!service.incomingRingingTone.starting?($log.info("[ringingService] startIncomingRinging currently paused"),service.incomingRingingTone.starting=!0,service.incomingRingingTone.audio.loop=!0,service.incomingRingingTone.audio.currentTime=0,platformService.allowDevicesManagement()?("true"===platformService.getSecondRingerStatusFromSettings()&&(service.incomingRingingSecondaryTone.starting=!0,service.incomingRingingSecondaryTone.audio.loop=!0,service.incomingRingingSecondaryTone.audio.currentTime=0,platformService.getRingingSpeaker().then((function(speaker){speaker&&platformService.setSpeakerForElement(service.incomingRingingSecondaryTone.audio,speaker.id).then((function(){$log.info("[ringingService] startIncomingRinging secondary device -- play"),service.play(service.incomingRingingSecondaryTone)}))})).catch((function(){$log.webrtc("[ringingService] startIncomingRinging secondary getRingingSpeaker error"),service.incomingRingingSecondaryTone.starting=!1}))),platformService.getCurrentSpeaker().then((function(speakerCurr){speakerCurr?platformService.setSpeakerForElement(service.incomingRingingTone.audio,speakerCurr.id).catch((function(){$log.error("[ringingService] startIncomingRinging setSpeakerForElement -- error. Play on default device")})).finally((function(){$log.info("[ringingService] startIncomingRinging -- play"),service.play(service.incomingRingingTone)})):($log.info("[ringingService] startIncomingRinging -- play (no speaker)"),service.play(service.incomingRingingTone))})).catch((function(){$log.webrtc("[ringingService] startIncomingRinging getCurrentSpeaker error"),service.incomingRingingTone.starting=!1}))):($log.info("[ringingService] startIncomingRinging -- play (no devices management)"),service.play(service.incomingRingingTone))):$log.info("[ringingService] startIncomingRinging -- nothing to do (already starting or playing)")},service.stopIncomingRinging=function(count){if($log.debug("[ringingService] stopIncomingRinging ..."),service.incomingRingingTone){if(service.incomingRingingTone.starting)return void(service.incomingRingingTone.stopDefered?$log.debug("[ringingService] stopIncomingRinging: nothing to do : stop already defered"):(count||(count=1),$log.debug("[ringingService] stopIncomingRinging: tone still starting: defer stop 1s later"),service.incomingRingingTone.stopDefered=$interval(service.stopIncomingRingingDefered,1e3,1,!0,count)));service.incomingRingingTone.stopDefered=void 0,service.incomingRingingTone.audio&&!service.incomingRingingTone.audio.paused?($log.info("[ringingService] stopIncomingRinging: tone is playing: stop it"),service.incomingRingingTone.audio.pause(),service.incomingRingingTone.audio.currentTime=0):$log.debug("[ringingService] stopIncomingRinging: nothing to do : tone is already stopped")}service.incomingRingingSecondaryTone&&service.incomingRingingSecondaryTone.audio&&!service.incomingRingingSecondaryTone.audio.paused&&($log.info("[ringingService] stopIncomingRinging: secondary tone is playing: stop it"),service.incomingRingingSecondaryTone.audio.pause(),service.incomingRingingSecondaryTone.audio.currentTime=0)},service.stopIncomingRingingDefered=function(count){service.incomingRingingTone.stopDefered=void 0,(count+=1)>=3?service.incomingRingingTone.audio&&($log.info("[ringingService] stopIncomingRingingDefered: tone is blocked on starting, stop it"),service.incomingRingingTone.audio.pause(),service.incomingRingingTone.audio.currentTime=0,service.incomingRingingTone.audio.src="",service.incomingRingingTone.audio.src="/resources/sounds/alarms/"+service.activeAlarm+service.audioFileType):service.stopIncomingRinging(count)},service.playImNotif=function(){"busy"!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.userContact.status||"audio"!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.userContact.message&&"video"!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.userContact.message&&"sharing"!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.userContact.message&&"presentation"!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_1___default.a.userContact.message?_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("imSound")&&service.pingAudio&&($log.info("[ringingService] playImNotif"),service.pingAudio.currentTime=0,service.pingAudioSecondary.currentTime=0,platformService.allowDevicesManagement()?("true"===platformService.getSecondRingerStatusFromSettings()&&platformService.getRingingSpeaker().then((function(speaker){speaker&&platformService.setSpeakerForElement(service.pingAudioSecondary,speaker.id).then((function(){service.pingAudioSecondary.play()}))})),platformService.getCurrentSpeaker().then((function(speakerCurr){speakerCurr?platformService.setSpeakerForElement(service.pingAudio,speakerCurr.id).then((function(){service.pingAudio.play()})):service.pingAudio.play()}))):service.pingAudio.play()):$log.info("[ringingService] playImNotif aborted due to communication Activity")},service.playRecordTone=function(){$log.info("[ringingService] playRecordTone"),service.recordTone.currentTime=0,platformService.allowDevicesManagement()?platformService.getCurrentSpeaker().then((function(speaker){speaker?platformService.setSpeakerForElement(service.recordTone,speaker.id).then((function(){service.recordTone.play()})):service.recordTone.play()})):service.recordTone.play()},service.playSecondCallTone=function(){$log.info("[ringingService] playSecondCallTone"),service.SecondCallTone.currentTime=0,platformService.allowDevicesManagement()?platformService.getCurrentSpeaker().then((function(speaker){speaker?platformService.setSpeakerForElement(service.SecondCallTone,speaker.id).then((function(){service.SecondCallTone.play()})):service.SecondCallTone.play()})):service.SecondCallTone.play()},service.playWebConferenceJoinNotif=function(){$log.info("[ringingService] playWebConferenceJoinNotif"),service.joinWebConfTone&&"true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("joinSfuSound")&&(service.joinWebConfTone.currentTime=0,platformService.allowDevicesManagement()?platformService.getCurrentSpeaker().then((function(speakerCurr){speakerCurr?platformService.setSpeakerForElement(service.joinWebConfTone,speakerCurr.id).then((function(){service.joinWebConfTone.play()})):service.joinWebConfTone.play()})):service.joinWebConfTone.play())},service.playHoldTone=function(){$log.info("[ringingService] playHoldTone..."),service.holdTone&&service.holdTone.stopDefered&&($log.info("[ringingService] playHoldTone: cancel defered stop operation"),$interval.cancel(service.holdTone.stopDefered),service.holdTone.stopDefered=void 0),service.holdTone&&service.holdTone.audio&&service.holdTone.audio.paused&&!service.holdTone.starting?(service.holdTone.starting=!0,service.holdTone.audio.currentTime=0,platformService.allowDevicesManagement()?platformService.getCurrentSpeaker().then((function(speakerCurr){speakerCurr?platformService.setSpeakerForElement(service.holdTone.audio,speakerCurr.id).catch((function(){$log.error("[ringingService] playHoldTone setSpeakerForElement -- error. Play on default device")})).finally((function(){$log.info("[ringingService] playHoldTone play"),service.play(service.holdTone)})):($log.info("[ringingService] playHoldTone play (no speaker)"),service.play(service.holdTone))})).catch((function(){$log.webrtc("[ringingService] playHoldTone getCurrentSpeaker error"),service.holdTone.starting=!1})):($log.info("[ringingService] playHoldTone play (no devices management)"),service.play(service.holdTone))):$log.info("[ringingService] playHoldTone -- nothing to do (already starting or playing)")},service.stopHoldTone=function(){if($log.debug("[ringingService] stopHoldTone ..."),service.holdTone){if(service.holdTone.starting)return void(service.holdTone.stopDefered?$log.debug("[ringingService] stopHoldTone: nothing to do : stop already defered"):($log.debug("[ringingService] stopHoldTone: tone still starting: defer stop 1s later"),service.holdTone.stopDefered=$interval(service.stopHoldToneDefered,1e3,1)));service.holdTone.stopDefered=void 0,service.holdTone.audio&&!service.holdTone.audio.paused?($log.info("[ringingService] stopHoldTone: tone is playing: stop it"),service.holdTone.audio.pause(),service.holdTone.audio.currentTime=0):$log.debug("[ringingService] stopHoldTone: nothing to do : tone is already stopped")}},service.stopHoldToneDefered=function(){service.holdTone.stopDefered=void 0,service.stopHoldTone()}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(14),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__);angular.module("rainbow").service("telephonyServiceSipWise",["$q","$interval","$http","$rootScope","$log","errorHelperService","$injector",function($q,$interval,$http,$rootScope,$log,errorHelperService,$injector){var service=this;service.portalURL=config.restServerUrl+"/api/rainbow/voice/v1.0/",service.portalAdminURL=config.restServerUrl+"/api/rainbow/rvcpprovisioning/v1.0/",service.sipWiseDevicesList=[],service.getPortalURLSipWise=function(){return service.portalURL},service.getDevicesListSipWise=function(){return service.sipWiseDevicesList.length<1&&$log.info("[telephonyServiceSipWise] getDevicesListSipWise : Anomaly API getUserDevices not yet performed"),service.sipWiseDevicesList},service.getDevicesIdFromListSipWiseWithType=function(devicetype){if(service.sipWiseDevicesList.length<1)return $log.info("[telephonyServiceSipWise] getDevicesIdFromListSipWiseWithType : Anomaly API getUserDevices not yet performed"),null;if("sip"!==devicetype&&"webrtc"!==devicetype)return $log.info("[telephonyServiceSipWise] getDevicesIdFromListSipWiseWithType : Anomaly wrong device type"),null;var foundIndex=service.sipWiseDevicesList.findIndex((function(elt){return elt.type===devicetype}));return-1!==foundIndex?service.sipWiseDevicesList[foundIndex].deviceId:($log.info("[telephonyServiceSipWise] getDevicesIdFromListSipWiseWithType : device type "+devicetype+" not found"),null)},service.getCurrentFromDevicesListSipWise=function(){if(service.sipWiseDevicesList.length<1)return $log.info("[telephonyServiceSipWise] getCurrentFromDevicesListSipWise : Anomaly API getUserDevices not yet performed"),null;var foundIndex=service.sipWiseDevicesList.findIndex((function(elt){return elt.main}));return-1!==foundIndex&&"inService"===service.sipWiseDevicesList[foundIndex].state?service.sipWiseDevicesList[foundIndex]:($log.info("[telephonyServiceSipWise] getCurrentFromDevicesListSipWise anomaly - no current/main device"),null)},service.setCurrentDevicesListSipWise=function(currentId){var deviceIndex=service.sipWiseDevicesList.findIndex((function(elt){return elt.deviceId===currentId}));if(-1!==deviceIndex&&deviceIndex<service.sipWiseDevicesList.length){if($log.info("[telephonyServiceSipWise] setCurrentDevicesListSipWise for device: "+service.sipWiseDevicesList[deviceIndex].deviceId+" / type : "+service.sipWiseDevicesList[deviceIndex].type),"inService"!==service.sipWiseDevicesList[deviceIndex].state){new Error("Anomaly setCurrentDevicesListSipWise - current device outOfService");$log.error("[telephonyServiceSipWise] setCurrentDevicesListSipWise anomaly - current device outOfService")}return service.sipWiseDevicesList.forEach((function(elt){return elt.main=!1})),service.sipWiseDevicesList[deviceIndex].main=!0,$rootScope.$broadcast("ON_CURRENT_DEVICE_SIPWISE_EVENT",service.sipWiseDevicesList[deviceIndex].type,service.getDevicesListSipWise()),!0}new Error("Anomaly setCurrentDevicesListSipWise - current device not found");return $log.error("[telephonyServiceSipWise] setCurrentDevicesListSipWise anomaly - current device not found / for device "+current),!1},service.putUserRoutingInfo=function(telService,currentId){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] putUserRoutingInfo : current = "+currentId),!currentId){var _error2=new Error("set routing failure - missing current device");return $log.error("[telephonyServiceSipWise] putUserRoutingInfo anomaly: missing current device"),void reject(_error2)}var foundIndex=service.sipWiseDevicesList.findIndex((function(elt){return elt.deviceId===currentId}));if(-1!==foundIndex){if($log.info("[telephonyServiceSipWise] putUserRoutingInfo found device with state : "+service.sipWiseDevicesList[foundIndex].state),"inService"!==service.sipWiseDevicesList[foundIndex].state){var error=new Error("Anomaly putUserRoutingInfo - current device outOfService");$log.error("[telephonyServiceSipWise] putUserRoutingInfo anomaly - current device outOfService")}}else{error=new Error("Anomaly putUserRoutingInfo - current device not found");$log.error("[telephonyServiceSipWise] putUserRoutingInfo anomaly - current device not found"),reject(error)}var reqUrl=service.portalURL+"routing",reqData={current:currentId};$log.info("[telephonyServiceSipWise] putUserRoutingInfo PUT "+reqUrl),$log.info("[telephonyServiceSipWise] putUserRoutingInfo data: "+JSON.stringify(reqData)),$http({method:"PUT",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] putUserRoutingInfo success : "),service.setCurrentDevicesListSipWise(currentId),service.patchNomadicData(telService),resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"putUserRoutingInfo")),reject(error)}))}))},service.getUserRoutingInfo=function(telService){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] getUserRoutingInfo"),service.sipWiseDevicesList.length<1)return $log.info("[telephonyServiceSipWise] getUserRoutingInfo : sipWise devices not yet avalaible"),reject();var reqUrl=service.portalURL+"routing";$log.info("[telephonyServiceSipWise] routing GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data.data;$log.info("[telephonyServiceSipWise] getUserRoutingInfo success / status : "+response.statusText);var current=respData.current;if(current){var foundIndex=service.sipWiseDevicesList.findIndex((function(elt){return elt.deviceId===current}));if(-1!==foundIndex)if("inService"!==service.sipWiseDevicesList[foundIndex].state){var error=new Error("Anomaly getUserRoutingInfo - current device outOfService");$log.error("[telephonyServiceSipWise] getUserRoutingInfo anomaly - current device outOfService"),reject(error)}else $log.info("[telephonyServiceSipWise] getUserRoutingInfo current : "+current+" type = "+service.sipWiseDevicesList[foundIndex].type),service.setCurrentDevicesListSipWise(current)?service.patchNomadicData(telService):reject(error);else{error=new Error("Anomaly getUserRoutingInfo - current device not found");$log.error("[telephonyServiceSipWise] getUserRoutingInfo anomaly - current not found"),reject(error)}}else{error=new Error("Anomaly getUserRoutingInfo - no current device");$log.error("[telephonyServiceSipWise] getUserRoutingInfo anomaly - no current device"),reject(error)}resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"routing")),reject(error)}))}))},service.patchNomadicData=function(telService){var current=service.getCurrentFromDevicesListSipWise();if($log.info("[telephonyServiceSipWise] patchNomadicData current type =  "+current.type),current&&"webrtc"===current.type){var webrtcGatewayService=$injector.get("webrtcGatewayService");telService.nomadicObject.destination=webrtcGatewayService.getMyMediaPillarRemoteExtension(),webrtcGatewayService.isMediaPillarAvailable()?(telService.nomadicObject.featureActivated=!0,telService.nomadicObject.modeActivated=!0,telService.nomadicObject.makeCallInitiatorIsMain=!1):(telService.nomadicObject.featureActivated=!0,telService.nomadicObject.modeActivated=!1,telService.nomadicObject.makeCallInitiatorIsMain=!1)}else telService.nomadicObject={},telService.nomadicObject.destination="",telService.nomadicObject.featureActivated=!0,telService.nomadicObject.modeActivated=!1,telService.nomadicObject.makeCallInitiatorIsMain=!0;$log.info("[telephonyServiceSipWise] patchNomadicData nomadicObject (desti/modeAct/CallIsMain) = "+telService.nomadicObject.destination+"/"+telService.nomadicObject.modeActivated+"/"+telService.nomadicObject.makeCallInitiatorIsMain),$rootScope.$broadcast("ON_CALL_NOMADIC_EVENT",telService.nomadicObject)},service.getUserDevices=function(telService){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getUserDevices");var reqUrl=service.portalURL+"devices";$log.info("[telephonyServiceSipWise] devices GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data;if($log.info("[telephonyServiceSipWise] getUserDevices success / status : "+response.statusText),respData.forEach((function(device){var sipDevice={type:device.type,id:device.id,deviceId:device.deviceId,jid_wrg:"",extension:"",state:"",main:!1};"webrtc"===device.type?(sipDevice.main=!0,sipDevice.jid_wrg=device.jid_wrg,service.sipWiseDevicesList.unshift(sipDevice)):service.sipWiseDevicesList.push(sipDevice)})),service.sipWiseDevicesList.length>=1)$log.info("[telephonyServiceSipWise] getUserDevices  : "+service.sipWiseDevicesList.length+" device(s)"),"webrtc"!==service.sipWiseDevicesList[0].type&&$log.error("[telephonyServiceSipWise] getUserDevices anomaly - no webrtc device"),resolve();else{var error=new Error("Anomaly getUserDevices - no device");$log.error("[telephonyServiceSipWise] getUserDevices anomaly - no device"),reject(error)}}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"devices")),reject(error)}))}))},service.getUserGroups=function(telService){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getUserGroups");var reqUrl=service.portalURL+"groups";$log.info("[telephonyServiceSipWise] groups GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data;$log.info("[telephonyServiceSipWise] getUserGroups success / status : "+response.statusText),telService.sipWiseUserGroupsDataClear(),respData.data.length>0&&respData.data.forEach((function(group){if(telService.sipWiseUserGroupsData.sipWiseUserGroupsList.push(group),"hunting_group"===group.type&&telService.sipWiseUserGroupsData.huntingGroupNb++,"manager_assistant"===group.type)if(telService.sipWiseUserGroupsData.managerAssistantNb++,1===telService.sipWiseUserGroupsData.managerAssistantNb){var onlyManager=group.members.find((function(elt){return"manager"===elt.roles[0]}));onlyManager?(telService.sipWiseUserGroupsData.managerAssistGrId=group.id,telService.sipWiseUserGroupsData.managerId=onlyManager.memberId,telService.sipWiseUserGroupsData.managerName=onlyManager.displayName,telService.sipWiseUserGroupsData.managerStatus=onlyManager.status):$log.info("[telephonyServiceSipWise] getUserGroups for groupId : "+group.id+" Anomaly not 1 only manager");var onlyAssistant=group.members.find((function(elt){return"assistant"===elt.roles[0]}));onlyAssistant?(telService.sipWiseUserGroupsData.assistantId=onlyAssistant.memberId,telService.sipWiseUserGroupsData.assistantName=onlyAssistant.displayName,telService.sipWiseUserGroupsData.assistantStatus=onlyAssistant.status):$log.info("[telephonyServiceSipWise] getUserGroups for groupId : "+group.id+" Anomaly not 1 only assistant")}else $log.info("[telephonyServiceSipWise] getUserGroups : Anomaly not a 1:1 mng/ass situation")})),telService.sipWiseUserGroupsData.sipWiseUserGroupsList.length>=1?$log.info("[telephonyServiceSipWise] getUserGroups  : "+telService.sipWiseUserGroupsData.sipWiseUserGroupsList.length+" user's group(s)"):$log.info("[telephonyServiceSipWise] getUserGroups  : no group"),resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"groups")),reject(error)}))}))},service.setUserGroupsForwards=function(telService,groupId,callForwardType,forwardData){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] setUserGroupsForwards for groupId : "+groupId);var wrongParaMsg="";if(groupId?0===telService.sipWiseUserGroupsData.sipWiseUserGroupsList.length&&(wrongParaMsg="invalid groupId"):wrongParaMsg="missing groupId",""!==wrongParaMsg){var error=new Error("set group forward failure - "+wrongParaMsg);return $log.error("[telephonyServiceSipWise] set group forward anomaly:"+wrongParaMsg),void reject(error)}var reqUrl=service.portalURL+"groups/"+encodeURIComponent(groupId)+"/forwards/"+encodeURIComponent(callForwardType),reqData=forwardData;$log.info("[telephonyServiceSipWise] setUserGroupsForwards PUT "+reqUrl),$log.info("[telephonyServiceSipWise] setUserGroupsForwards data: "+JSON.stringify(reqData)),$http({method:"PUT",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] setUserGroupsForwards success / status : "+response.statusText),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"setUserGroupsForwards"))}))}))},service.getUserGroupsForwards=function(telService,groupId){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getUserGroupsForwards for groupId : "+groupId);var wrongParaMsg="";if(groupId?0===telService.sipWiseUserGroupsData.sipWiseUserGroupsList.length&&(wrongParaMsg="invalid groupId"):wrongParaMsg="missing groupId",""!==wrongParaMsg){var error=new Error("get group forward failure - "+wrongParaMsg);return $log.error("[telephonyServiceSipWise] get group forward anomaly:"+wrongParaMsg),void reject(error)}var reqUrl=service.portalURL+"groups/"+encodeURIComponent(groupId)+"/forwards";$log.info("[telephonyServiceSipWise] getUserGroupsForwards GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data.data,group=telService.sipWiseUserGroupsData.sipWiseUserGroupsList.find((function(elt){return elt.id===groupId}));if(group.name!==respData.name){$log.info("[telephonyServiceSipWise] getUserGroupsForwards Anomaly group name : "+group.name+" VS "+respData.name);var error=errorHelperService.handleError(response);return reject(error),void $log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"getUserGroupsForwards"))}if(group.forwardData=respData,groupId===telService.sipWiseUserGroupsData.managerAssistGrId)if(telService.sipWiseUserGroupsData.managerAssistantNb>1)$log.info("[telephonyServiceSipWise] getUserGroupsForwards : Anomaly not a 1:1 mng/ass situation");else{var fwdActivate="unknow",mng=respData.members.find((function(elt){return elt.memberId===telService.sipWiseUserGroupsData.managerId}));if(mng&&mng.displayName===telService.sipWiseUserGroupsData.managerName){var fwd=mng.forwards.find((function(elt){return"immediate"===elt.type}));fwdActivate=fwd&&fwd.activate&&"managersecretary"===fwd.destinationType?"activated":"unactivated"}else $log.info("[telephonyServiceSipWise] getUserGroupsForwards : Anomaly manager forward status");telService.sipWiseUserGroupsData.managerForward=fwdActivate}$log.info("[telephonyServiceSipWise] getUserGroupsForwards success / status : "+response.statusText),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"getUserGroupsForwards"))}))}))},service.getAllUserGroupsForwards=function(telService){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getAllUserGroupsForwards");var getGroupPromises=[];return 0===telService.sipWiseUserGroupsData.sipWiseUserGroupsList.length?($log.info("[telephonyServiceSipWise] getAllUserGroupsForwards / no group"),resolve()):(telService.sipWiseUserGroupsData.sipWiseUserGroupsList.forEach((function(group){"manager_assistant"===group.type&&getGroupPromises.push(service.getUserGroupsForwards(telService,group.id))})),0===getGroupPromises.length?($log.info("[telephonyServiceSipWise] getAllUserGroupsForwards / no manager assistant group"),resolve()):$q.all(getGroupPromises).then((function(){$log.info("[telephonyServiceSipWise] getAllUserGroupsForwards -- group forward completed -- "+getGroupPromises.length+" group(s) forward updated"),resolve()})).catch((function(error){$log.error("[telephonyServiceSipWise] getAllUserGroupsForwards -- group forward failure -- "+error.message),reject(error)})))}))},service.getSnapshot=function(call,deviceId,seqNum){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getSnapshot");var tabQueryParam=[];call&&($log.info("[telephonyServiceSipWise] snapshot with callId "+call.id),tabQueryParam.push("callId="+call.id)),deviceId&&($log.info("[telephonyServiceSipWise] snapshot with deviceId "+deviceId),tabQueryParam.push("deviceId="+deviceId)),seqNum&&($log.info("[telephonyServiceSipWise] snapshot with seqNum "+seqNum),tabQueryParam.push("seqNum="+seqNum));var queryParam="";tabQueryParam.length>=1&&(queryParam="?"+tabQueryParam.join("&"));var reqUrl=service.portalURL+"snapshot"+queryParam;$log.info("[telephonyServiceSipWise] snapshot GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data.data;$log.info("[telephonyServiceSipWise] getSnapshot success / status : "+response.statusText),resolve(respData)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"snapshot")),reject(error)}))}))},service.processSnapshot=function(telService){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] processSnapshot");var nbRingingIn=0;service.getSnapshot().then((function(respData){try{respData&&respData.devices?respData.devices.forEach((function(snapDevice){service.sipWiseDevicesList.find((function(device){return device.deviceId===snapDevice.deviceId})).state=snapDevice.state,$log.info("[telephonyServiceSipWise] processSnapshot / devicesId="+snapDevice.deviceId+"; state="+snapDevice.state),service.sipWiseDevicesList.find((function(device){return device.deviceId===snapDevice.deviceId})).state="inService"})):$log.error("[telephonyServiceSipWise] processSnapshot / anomaly no device ");var getCallPromises=[];return respData&&respData.calls?respData.calls.length>5?($log.error("[telephonyServiceSipWise] processSnapshot / anomaly to much calls : "+respData.calls.length),resolve()):(respData.calls.forEach((function(snapCall){"ringingIn"===snapCall.legs[0].state&&++nbRingingIn>=4&&$log.info("[telephonyServiceSipWise] processSnapshot / anomaly to much ringingIn calls : "+nbRingingIn),nbRingingIn<4&&getCallPromises.push(service.createCallFromSnapShotCallsElt(telService,snapCall))})),0===getCallPromises.length?($log.info("[telephonyServiceSipWise] processSnapshot / anomaly no call created"),resolve()):$q.all(getCallPromises).then((function(){$log.info("[telephonyServiceSipWise] processSnapshot -- calls creation completed -- "+getCallPromises.length+" calls created"),resolve()})).catch((function(error){$log.error("[telephonyServiceSipWise] processSnapshot -- calls creation failure -- "+error.message),reject(error)}))):($log.info("[telephonyServiceSipWise] processSnapshot / no call elt"),resolve())}catch(error){var errorMessage=" processSnapshot -- "+error.message;reject(new Error(errorMessage))}}),(function(error){$log.info("[telephonyServiceSipWise] processSnapshot / getSnapshot error : "+error),reject(error)}))}))},service.createCallFromSnapShotCallsElt=function(telService,snapShotCallsElt){return $q((function(resolve,reject){var call=null;$log.info("[telephonyServiceSipWise] createCallFromSnapShotCallsElt - callId = "+snapShotCallsElt.callId);var leg=null,legId=null,deviceId=null,state=null,endPoint=null,phoneNumber=null,jid=null,displayName=null;if(!snapShotCallsElt.legs){var errorMessage="createCallFromSnapShotCallsElt -- Anomaly no leg";return $log.error("[telephonyServiceSipWise] "+errorMessage),$q.when()}if(leg=snapShotCallsElt.legs[0],legId=leg.legId?leg.legId:null,deviceId=leg.deviceId?leg.deviceId:null,state=telService.telephonyEventHandler.convLegStateToCallStatus(leg.state),$log.info("[telephonyServiceSipWise] createCallFromSnapShotCallsElt - legId = "+legId+" deviceId = "+deviceId+" leg_state = "+leg.state),!snapShotCallsElt.endpoints)return $log.info("[telephonyServiceSipWise] createCallFromSnapShotCallsElt -- No endPoint provided !"),$q.when();if((endPoint=snapShotCallsElt.endpoints[0]).endpointId,phoneNumber=endPoint.phoneNumber,jid=endPoint.jid,displayName=endPoint.displayName,!jid&&!phoneNumber){errorMessage="createCallFromSnapShotCallsElt -- Anomaly no jid no phoneNumber";return $log.error("[telephonyServiceSipWise] "+errorMessage),$q.when()}_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){jid||contact.displayName||(contact.displayName=displayName,contact.initials=displayName.charAt(0),contact.getAvatar()),(call=telService.getOrCreateCallSipWise(state,snapShotCallsElt.callId,legId,deviceId,contact)).relevantEquipmentId=deviceId,call.isSecondary=!1,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}))}))},service.makeSimpleCallSipWise=function(telService,contact,phoneNumber){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] makeSimpleCall to "+(contact?contact.nameForLogs:_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2___default()(phoneNumber))),!telService.isBasicCallAllowed){var profileError=new Error("makeSimpleCallSipWise failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyServiceSipWise] "+profileError.message),telService.makingCall=!1,void reject(profileError)}var phoneInfo=telService.getPhoneInfo(contact,phoneNumber),currentDeviceId=service.getCurrentFromDevicesListSipWise();if(currentDeviceId)var deviceId=currentDeviceId.deviceId;else deviceId="";if((telService.sipWiseEmergencyCallData.WGEmergencyCallForbidden&&currentDeviceId&&"webrtc"===currentDeviceId.type||"testemergency"===telService.sipWiseMode())&&service.checkEmergencyNumberSipWise(telService,phoneNumber)){$log.info("[telephonyServiceSipWise] makeVOIPSipemergencyCall - Not Allowed for num : "+phoneNumber);return telService.rxSubject.next({name:"ON_EMERGENCYCALL_VOIPSIP_NOTALLOWED_EVENT",data:phoneNumber}),telService.makingCall=!1,void reject()}if(telService.getActiveCall()&&currentDeviceId&&"webrtc"===currentDeviceId.type&&"demo"!==telService.sipWiseMode())return $log.info("[telephonyServiceSipWise] makeSecondVOIPSipCall - Not Allowed"),telService.makingCall=!1,$rootScope.$broadcast("ON_CALL_NOTALLOWED_EVENT","webCallAlreadyProgress"),void reject("webCallAlreadyProgress");var reqUrl=service.portalURL+"calls",reqData={deviceId:deviceId,calleeExtNumber:phoneInfo.longNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,callerAutoAnswer:!0};$log.info("[telephonyServiceSipWise] makeSimpleCall POST "+reqUrl),$log.info("[telephonyServiceSipWise] makeSimpleCall data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){var respCallId=response.data.data.callId;if($log.info("[telephonyServiceSipWise] makeSimpleCall success : callee "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2___default()(phoneNumber)+" / callId = "+respCallId),!respCallId||""===respCallId){var call;(call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact)).errorMessage="unexpectedError",telService.calls[call.contact.id]=call,call.autoClear=$interval((function(){telService.clearCall(call)}),5e3,1),telService.makingCall=!1,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call);var error=errorHelperService.handleError(response);return $log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"makeCall")),void reject(error)}(call=telService.getOrCreateCallSipWise(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING,respCallId,null,null,contact)).setRelevantEquipmentId(call.getDeviceIdSipWise()),call.isOwner=!0,$log.info("[telephonyServiceSipWise] makeSimpleCall Call created ("+call+")"),telService.makingCall=!1,call.setIsVm(phoneNumber===telService.voicemailNumber),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call.id)}),(function(response){var call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE,contact);call.errorMessage=response&&"403"===response.errorDetailsCode?"notAllowed":"invalidPhoneNumber",telService.calls[call.contact.id]=call,call.autoClear=$interval((function(){telService.clearCall(call)}),5e3,1),telService.makingCall=!1,call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call);var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"makeCall")),reject(error)}))}))},service.getPhoneInfoSipWise=function(contact,phoneNumber){var longNumber=phoneNumber,shortNumber="",internalNumber="";return contact&&(phoneNumber===contact.phonePro||phoneNumber===contact.phoneProCan?(longNumber=contact.phoneProCan?contact.phoneProCan:"",shortNumber=contact.phonePbx,internalNumber=contact.phoneInternalNumber):phoneNumber===contact.phonePbx&&(longNumber="",shortNumber=contact.phonePbx,internalNumber=contact.phoneInternalNumber)),{number:""!==longNumber?longNumber:shortNumber||internalNumber}},service.getErrorMessage=function(data,actionLabel){return null},service.releaseCallSipWise=function(telService,call){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] releaseCallSipWise "+call.id);var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.id),reqData={legId:call.connectionId?call.connectionId:""};$log.info("[telephonyServiceSipWise] releaseCall DELETE "+reqUrl),$log.info("[telephonyServiceSipWise] releaseCall data: "+JSON.stringify(reqData)),$http({method:"DELETE",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),call.startDate=null,call.vm=!1,$log.info("[telephonyServiceSipWise] releaseCall "+call.id+" - success"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),delete telService.calls[call.id],resolve(call)}),(function(response){var error=errorHelperService.handleError(response);service.deleteCallIfInvalid(error,call,telService),reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"releaseCall"))}))}))},service.deleteCallIfInvalid=function(error,call,telService){error&&"voice"===error.portal&&404201===error.errorDetailsCode&&"Specified leg not found"===error.message&&call&&($log.warn("[telephonyServiceSipWise] deleteCallIfInvalid: delete client call non existing on server: "+call.id),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),telService.calls[call.id]&&delete telService.calls[call.id])},service.answerCallSipWise=function(telService,call){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] answerCall : "+call.id);var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.id)+"/answer",reqData={legId:call.connectionId};$log.info("[telephonyServiceSipWise] answerCallSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] answerCallSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),$log.info("[telephonyServiceSipWise] answerCall success : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2___default()(call.contact.phone)+" Call ("+call+")"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){$log.info("[telephonyServiceSipWise] answerCall fail : error = "+response.data.errorCode+" msg = "+response.data.errorMsg+" details = "+response.data.errorDetails),response.data&&"Device is not able to answer a call"===response.data.errorDetails&&$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{autoClose:!1,okLabel:"close",popupTitle:"warning",popupBody:"deviceDoesntAllowAnswer"}),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN);var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"answerCall")),reject(error)}))}))},service.holdCallSipWise=function(telService,call){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] holdCallSipWise : "+call.id);var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.id)+"/hold",reqData={legId:call.connectionId};$log.info("[telephonyServiceSipWise] holdCallSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] holdCallSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] holdCall success : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2___default()(call.contact.phone)+" Call ("+call+")"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"holdCall"))}))}))},service.retrieveCallSipWise=function(telService,call){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] retrieveCallSipWise : "+call.id);var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.id)+"/retrieve",reqData={legId:call.connectionId};$log.info("[telephonyServiceSipWise] retrieveCallSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] retrieveCallSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] retrieveCall success : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_2___default()(call.contact.phone)+" Call ("+call+")"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"retrieveCall"))}))}))},service.deflectCallSipWise=function(telService,call,destination){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] deflectCallSipWise : "+call.id+" to destination : "+destination),!destination){var error=new Error("deflect failure - no destination");return $log.error("[telephonyServiceSipWise] deflect anomaly: no destination"),void reject(error)}var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.id)+"/deflect",reqData={destination:destination};$log.info("[telephonyServiceSipWise] deflectCallSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] deflectCallSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] deflectCallSipWise success :  Call ("+call+")"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"deflectCall"))}))}))},service.transfertCallSipWise=function(telService,activeCall,heldCall){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] transfertCallSipWise : activeCall : "+activeCall.id+" heldCall : "+heldCall.id),!activeCall||!heldCall){var error=new Error("transfer failure - missing activeCall or heldCall");return $log.error("[telephonyServiceSipWise] transfer anomaly: missing calls ref"),void reject(error)}var reqUrl=service.portalURL+"calls/"+encodeURIComponent(activeCall.id)+"/transfer",reqData={heldCallId:heldCall.id};$log.info("[telephonyServiceSipWise] transfertCallSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] transfertCallSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] transfertCallSipWise success : "+activeCall.id+"->"+heldCall.id),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"transfer"))}))}))},service.blindTransfertCallSipWise=function(telService,activeCall,calleeNumber){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] blindTransfertCallSipWise : activeCall : "+activeCall.id),!activeCall||!calleeNumber){var error=new Error("blind transfer failure - missing activeCall or callee number");return $log.error("[telephonyServiceSipWise] blind transfer anomaly: missing calls ref or callee number"),void reject(error)}var reqUrl=service.portalURL+"calls/"+encodeURIComponent(activeCall.id)+"/blind-transfer",reqData={destination:calleeNumber};$log.info("[telephonyServiceSipWise] blindTransfertCallSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] blindTransfertCallSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] blind transfertCallSipWise success :  Call ("+call+")"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"blind-transfer"))}))}))},service.forwardToDeviceSipWise=function(telService,phoneNumber,destType,forwardType){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] forwardToDeviceSipWise : phoneNumber = "+phoneNumber+" / destType = "+destType+" / fwtype = "+forwardType),!phoneNumber){var error=new Error("forward failure - missing phoneNumber");return $log.error("[telephonyServiceSipWise] forward anomaly: missing phoneNumber"),void reject(error)}var reqUrl=service.portalURL+"forwards/"+encodeURIComponent(forwardType),reqData={number:phoneNumber,destinationType:destType,activate:!0};$log.info("[telephonyServiceSipWise] forwardToDeviceSipWise PUT "+reqUrl),$log.info("[telephonyServiceSipWise] forwardToDeviceSipWise data: "+JSON.stringify(reqData)),$http({method:"PUT",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] forwardToDeviceSipWise success : "),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"forwardToDeviceSipWise"))}))}))},service.cancelForwardSipWise=function(telService,forwardType){return $q((function(resolve,reject){if($log.info("[telephonyServiceSipWise] cancelForwardSipWise :  fwtype = "+forwardType),!forwardType||"immediate"!==forwardType&&"busy"!==forwardType&&"noreply"!==forwardType){var error=new Error("cancel forward failure - wrong forwardType");return $log.error("[telephonyServiceSipWise] cancel forward anomaly: wrong forwardType"),void reject(error)}var reqUrl=service.portalURL+"forwards/"+encodeURIComponent(forwardType),reqData={activate:!1};$log.info("[telephonyServiceSipWise] cancelForwardSipWise PUT "+reqUrl),$log.info("[telephonyServiceSipWise] cancelForwardSipWise data: "+JSON.stringify(reqData)),$http({method:"PUT",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] forwardToDeviceSipWise success : "),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"forwardToDeviceSipWise"))}))}))},service.getForwardStatusSipWise=function(telService){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getForwardStatusSipWise");var reqUrl=service.portalURL+"forwards";$log.info("[telephonyServiceSipWise] getForwardStatusSipWise GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){if(response.data&&"Call Forwards successfully found"===response.data.status&&response.data.data){$log.info("[telephonyServiceSipWise] getForwardStatusSipWise success");var dataResponse=response.data.data,forwardObjectAdapter=service.convForwardObject(dataResponse);return $log.info("[telephonyServiceSipWise] getForwardStatusSipWise immediat fwdtype = "+forwardObjectAdapter.immediate.forwardType+" immediat forwardTo = "+forwardObjectAdapter.immediate.forwardTo),forwardObjectAdapter.busy&&$log.info("[telephonyServiceSipWise] getForwardStatusSipWise busy activate = "+forwardObjectAdapter.busy.activate),forwardObjectAdapter.noreply&&$log.info("[telephonyServiceSipWise] getForwardStatusSipWise noreply activate = "+forwardObjectAdapter.noreply.activate),$rootScope.$broadcast("ON_CALL_FORWARDED_EVENT",{forwardType:forwardObjectAdapter.immediate.forwardType,forwardTo:forwardObjectAdapter.immediate.forwardTo}),telService.forwardObject.forwardType=forwardObjectAdapter.immediate.forwardType,telService.forwardObject.forwardTo=forwardObjectAdapter.immediate.forwardTo,(forwardObjectAdapter.busy||forwardObjectAdapter.noreply)&&($rootScope.$broadcast("ON_CALL_FORWARDED_CONDI_EVENT",{busy:forwardObjectAdapter.busy,noreply:forwardObjectAdapter.noreply}),telService.forwardObject.busy=forwardObjectAdapter.busy,telService.forwardObject.noreply=forwardObjectAdapter.noreply),void resolve()}var error=new Error("getForwardStatus failure - invalide response");return $log.error("[telephonyServiceSipWise] getForwardStatus anomaly: invalide response"),void reject(error)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"getForwardStatusSipWise"))}))}))},service.convForwardObject=function(sipWiseForwardData){var forwardAdapter={immediate:{forwardType:"Desactivation",forwardTo:""},busy:{},noreply:{},manAssist:{}};return sipWiseForwardData.forEach((function(forward){"immediate"===forward.type?(forward.activate&&("voicemail"===forward.destinationType?(forwardAdapter.immediate.forwardType="Activation",forwardAdapter.immediate.forwardTo="VOICEMAILBOX"):""!==forward.number&&(forwardAdapter.immediate.forwardType="Activation",forwardAdapter.immediate.forwardTo=forward.number)),"managersecretary"===forward.destinationType&&(forwardAdapter.immediate.forwardType=forward.activate,forwardAdapter.immediate.forwardTo="MANAGERASSISTANT",forwardAdapter.manAssist=forward)):"busy"===forward.type?forwardAdapter.busy=forward:"noreply"===forward.type&&(forwardAdapter.noreply=forward)})),forwardAdapter},service.getOverFlowStatusSipWise=function(systemId,phoneNumberId){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] getOverFlowStatusSipWise : systemId = "+systemId+" / phoneNumberId = "+phoneNumberId);var reqUrl=service.portalAdminURL+"cloudpbxs/"+encodeURIComponent(systemId)+"/subscribers/"+encodeURIComponent(phoneNumberId)+"/overflow/status";$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data.data;$log.info("[telephonyServiceSipWise] getOverFlowStatusSipWise activated: "+respData.activate),resolve(respData)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"getOverFlowStatus")),reject(error)}))}))},service.sendDtmfSipWise=function(telService,call,dtmf){return $q((function(resolve,reject){$log.info("[telephonyServiceSipWise] sendDtmfSipWise for callId : "+call.id+" dtmf : "+dtmf);var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.id)+"/sendDtmf",reqData={legId:call.connectionId,digits:dtmf};$log.info("[telephonyServiceSipWise] sendDtmfSipWise POST "+reqUrl),$log.info("[telephonyServiceSipWise] sendDtmfSipWise data: "+JSON.stringify(reqData)),$http({method:"POST",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyServiceSipWise] sendDtmfSipWise success :  Call ("+call+")"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"sendDtmf"))}))}))},service.checkEmergencyNumberSipWise=function(telService,phoneNumber){var result=!1,emergencyData=telService.sipWiseEmergencyCallData;emergencyData.emergencyNuList.length>0&&(emergencyData.emergencyNuList.find((function(elt){return elt===phoneNumber}))&&(result=!0));return result},service.getEmergencyCallDataSipWise=function(telService){return $q((function(resolve,reject){var reqUrl=service.portalURL+"emergency-numbers";$log.info("[telephonyServiceSipWise] getEmergencyCallDataSipWise GET "+reqUrl),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var respData=response.data.data;$log.info("[telephonyServiceSipWise] getEmergencyCallDataSipWise success / status : "+response.statusText),$log.info("[telephonyServiceSipWise] getEmergencyCallDataSipWise success / callAuthorizationWithSoftPhone  : "+respData.emergencyOptions.callAuthorizationWithSoftPhone),$log.info("[telephonyServiceSipWise] getEmergencyCallDataSipWise success / nb of emergency Nu : "+respData.emergencyNumbers.length),telService.sipWiseEmergencyCallDataClear(),telService.sipWiseEmergencyCallData.WGEmergencyCallForbidden=!respData.emergencyOptions.callAuthorizationWithSoftPhone,telService.sipWiseEmergencyCallData.serverData=respData.emergencyNumbers,respData.emergencyNumbers&&respData.emergencyNumbers.length>0&&respData.emergencyNumbers.forEach((function(emergNumbers){telService.sipWiseEmergencyCallData.emergencyNuList.push(emergNumbers.number)})),"testemergency"===telService.sipWiseMode()&&(telService.sipWiseEmergencyCallData.WGEmergencyCallForbidden=!0,telService.sipWiseEmergencyCallData.emergencyNuList.push("3669")),resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[telephonyServiceSipWise] "+errorHelperService.getErrorFullMessage(response,"getEmergencyCallDataSipWise")),reject(error)}))}))}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_src_utils_promiseQueue__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(49),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__);angular.module("rainbow").factory("TelephonyServiceEventHandlerSipWise",["$log","$q","$rootScope",function($log,$q,$rootScope){function TelephonyServiceEventHandlerSipWise(telephonyService){this.telephonyService=telephonyService,this.promiseQueue=_src_utils_promiseQueue__WEBPACK_IMPORTED_MODULE_1__.PromiseQueue.create()}return TelephonyServiceEventHandlerSipWise.create=function(telephonyService){return new TelephonyServiceEventHandlerSipWise(telephonyService)},TelephonyServiceEventHandlerSipWise.CallFailureLabels={invalidNumberFormat:"invalidPhoneNumber",destOutOfOrder:"outOfService",destNotObtainable:"outOfService",doNotDisturb:"dnd",busy:"busy",incompatibleDestination:"invalidPhoneNumber"},TelephonyServiceEventHandlerSipWise.prototype.onCallserviceMessageReceived=function(stanza){try{var that=this,actionElem=$(stanza).find("telephony"),forwardUpdatedElem=actionElem.find("forwardUpdated"),routingUpdatedElem=actionElem.find("routing");if(forwardUpdatedElem&&0!==forwardUpdatedElem.length)return that.onforwardUpdatedMsg(forwardUpdatedElem);if(routingUpdatedElem&&0!==routingUpdatedElem.length)return that.onRoutingUpdatedMsg(routingUpdatedElem);var eventElem=actionElem.find("event"),seqNum=eventElem.attr("seqNum");if(!seqNum)return $log.info("[TelephonyServiceEventHandlerSipWise] onCallserviceMessageReceived -- no telephony event received then msg ignored"),!0;var ts=eventElem.attr("ts"),cause=eventElem.attr("cause");return $log.info("[TelephonyServiceEventHandlerSipWise] onCallserviceMessageReceived -- telephony event received and queued: seqNum = "+seqNum+" cause = "+cause+" ts = "+ts),this.promiseQueue.add((function(){return that.onTelephonyEvent(eventElem,seqNum)})),!0}catch(error){return $log.error("[TelephonyServiceEventHandlerSipWise] onCallserviceMessageReceived -- failure -- "+error.message),!0}},TelephonyServiceEventHandlerSipWise.prototype.onforwardUpdatedMsg=function(forwardUpdatedElem){$log.info("[TelephonyServiceEventHandlerSipWise] onforwardUpdatedMsg : msg forwardUpdated received");var forwardItem=forwardUpdatedElem.attr("forwardItem");if("user"===forwardItem&&this.telephonyService.getForwardStatus(),"group"===forwardItem){var groupId=forwardUpdatedElem.attr("forwardItemId");groupId?(this.telephonyService.getSipWiseUserGroupsForwards(groupId),"manager"===this.telephonyService.sipWiseManAssistGetMyRole()&&this.telephonyService.getForwardStatus()):this.telephonyService.getSipWiseUserGroups()}return!0},TelephonyServiceEventHandlerSipWise.prototype.onRoutingUpdatedMsg=function(routingUpdatedElem){$log.info("[TelephonyServiceEventHandlerSipWise] onRoutingUpdatedMsg : msg routing update received");var action=routingUpdatedElem.attr("action"),currentElem=routingUpdatedElem.find("current");routingUpdatedElem.find("destination");return"update"!==action?$log.info("[TelephonyServiceEventHandlerSipWise] onRoutingUpdatedMsg Anomaly: not an action update"):currentElem||$log.info("[TelephonyServiceEventHandlerSipWise] onRoutingUpdatedMsg Anomaly: no current elt"),!0},TelephonyServiceEventHandlerSipWise.prototype.onTelephonyEvent=function(eventElem,seqNum){$log.info("[TelephonyServiceEventHandlerSipWise] onTelephonyEvent for seqNum = "+seqNum);var that=this,callsToUpdate=[];return $q((function(resolve,reject){that.manageAllCalls(eventElem,seqNum,callsToUpdate).then((function(){return that.manageAllLegs(eventElem,seqNum,callsToUpdate)})).then((function(){return that.manageAllEndPoints(eventElem,seqNum,callsToUpdate)})).catch((function(error){$log.info("[TelephonyServiceEventHandlerSipWise] onTelephonyEvent CATCH / seqNum = "+seqNum);var errorMessage="onTelephonyEvent -- "+error.message;$log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage)})).finally((function(){$log.info("[TelephonyServiceEventHandlerSipWise] onTelephonyEvent FINALLY / seqNum = "+seqNum),that.CallsUpdate(callsToUpdate),resolve()}))}))},TelephonyServiceEventHandlerSipWise.prototype.manageAllCalls=function(eventElem,seqNum,callsToUpdate){var that=this,callPromises=[],liveCalls=0;return eventElem.find("call").each((function(){var callElemIter=angular.element(this),callId=callElemIter.attr("callId"),op=callElemIter.attr("op");$log.info("[TelephonyServiceEventHandlerSipWise] manageAllCalls ITER callId = "+callId+" op = "+op+" / seqNum = "+seqNum),"ended"!==op&&liveCalls++,callPromises.push($q((function(resolve,reject){that.manageCallElem(callElemIter,eventElem,seqNum,callsToUpdate).then((function(){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllCalls done for callId = "+callId+" / seqNum = "+seqNum)})).catch((function(error){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllCalls CATCH / seqNum = "+seqNum);var errorMessage="manageAllCalls -- "+error.message;$log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage)})).finally((function(){resolve()}))})))})),$q.all(callPromises).finally((function(){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllCalls : nb living calls = "+liveCalls+" / seqNum = "+seqNum)}))},TelephonyServiceEventHandlerSipWise.prototype.manageCallElem=function(callElem,eventElem,seqNum,callsToUpdate){var that=this;return callElem.length?$q((function(resolve,reject){try{var callId=callElem.attr("callId"),oldCallId=callElem.attr("oldCallId"),op=(callElem.attr("newCallId"),callElem.attr("op"));if(!callId){var errorMessage="manageCallElem -- Anomaly callId missing / seqNum = "+seqNum;$log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage),reject(errorMessage)}if(!op){errorMessage="manageCallElem -- Anomaly op missing / seqNum = "+seqNum;$log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage),reject(errorMessage)}if($log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem callId = "+callId+" op = "+op+" / seqNum = "+seqNum),oldCallId)(call=that.telephonyService.calls[oldCallId])?($log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem : oldcallId = "+oldCallId+" ended  / seqNum = "+seqNum),that.telephonyService.clearCall(call,!0),callsToUpdate[callId]={trigger:!0,info:"callended"}):$log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem : oldCallId "+oldCallId+" ended, no call found");switch(op){case"created":if($log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem / call creation / seqNum = "+seqNum),call=that.telephonyService.createCallSipWise(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,callId)){var cause=eventElem.attr("cause");cause&&call.setInitCauseSipWiseData(cause);var direction=callElem.find("direction").text();direction&&call.setDirectionSipWiseData(direction);var calledElem=callElem.find("called");(called={}).phoneNumber=calledElem.find("phoneNumber").text(),called.displayName=calledElem.find("displayName").text(),call.setCalledSipWiseData(called)}callsToUpdate[callId]={trigger:!1,info:"call"+op},resolve();break;case"updated":$log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem / call update / seqNum = "+seqNum);var called;calledElem=callElem.find("called");(called={}).phoneNumber=calledElem.find("phoneNumber").text(),called.displayName=calledElem.find("displayName").text();var call=that.getCallFromCallId(callId);_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call&&call.setCalledSipWiseData(called),that.checkCallRelevancy(callId)?callsToUpdate[callId]={trigger:!0,info:"call"+op}:$log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem : on callId "+callId+" updated, not relevant"),resolve();break;case"ended":$log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem / call end / seqNum = "+seqNum);call=that.telephonyService.calls[callId];that.checkCallRelevancy(callId)?($log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem : callId = "+callId+" ended  / seqNum = "+seqNum),that.telephonyService.clearCall(that.getCallFromCallId(callId),!0),callsToUpdate[callId]={trigger:!0,info:"call"+op}):$log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem : on callId "+callId+" ended, not relevant"),resolve();break;default:$log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem / invalid op -> "+op+" / seqNum = "+seqNum),reject()}}catch(error){errorMessage="manageCallElem -- "+error.message;reject(new Error(errorMessage))}})):($log.info("[TelephonyServiceEventHandlerSipWise] manageCallElem / no CallElem"),$q.resolve())},TelephonyServiceEventHandlerSipWise.prototype.manageAllLegs=function(eventElem,seqNum,callsToUpdate){var that=this,legPromises=[],liveLegs=0;return eventElem.find("leg").each((function(){var legElemIter=angular.element(this),legId=legElemIter.attr("legId"),op=legElemIter.attr("op");$log.info("[TelephonyServiceEventHandlerSipWise] manageAllLegs ITER legId = "+legId+" op = "+op+" / seqNum = "+seqNum),legElemIter.length&&("ended"!==op&&liveLegs++,legPromises.push($q((function(resolve,reject){that.manageLegElem(legElemIter,eventElem,seqNum,callsToUpdate).then((function(){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllLegs done for legId = "+legId+" / seqNum = "+seqNum)})).catch((function(error){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllLegs CATCH / seqNum = "+seqNum);var errorMessage="manageAllLegs -- "+error.message;$log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage)})).finally((function(){resolve()}))}))))})),$q.all(legPromises).finally((function(){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllLegs : nb living legs = "+liveLegs+" / seqNum = "+seqNum)}))},TelephonyServiceEventHandlerSipWise.prototype.manageLegElem=function(legElem,eventElem,seqNum,callsToUpdate){var that=this;return $q((function(resolve,reject){var legId=legElem.attr("legId"),callId=legElem.attr("callId"),deviceId=legElem.attr("deviceId"),state=legElem.attr("state"),op=legElem.attr("op");legId||reject("manageLegElem -- Anomaly legId missing / seqNum = "+seqNum);callId||reject("manageLegElem -- Anomaly callId missing / seqNum = "+seqNum);op||reject("manageLegElem -- Anomaly op missing / seqNum = "+seqNum);switch($log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem legId = "+legId+" callId = "+callId+" deviceId = "+deviceId+" state = "+state+" op = "+op+" / seqNum = "+seqNum),op){case"created":$log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / leg creation / seqNum = "+seqNum),that.computeCallRelevancy(deviceId)?($log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / create legId/callId = "+legId+"/"+callId+" relevant"),that.legElemCreate(eventElem).then((function(){that.getCallFromCallId(callId).setConnectionIdSipWise(legId),callsToUpdate[callId]={trigger:!0,info:"leg"+op},resolve()})).catch((function(error){reject(error)}))):($log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / create legId/callId = "+legId+"/"+callId+" not relevant"),resolve());break;case"updated":$log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / leg update / seqNum = "+seqNum),that.computeCallRelevancy(deviceId)?($log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / update legId/callId = "+legId+"/"+callId+" relevant"),that.legElemUpdate(eventElem).then((function(){that.getCallFromCallId(callId).setConnectionIdSipWise(legId),callsToUpdate[callId]={trigger:!0,info:"leg"+op},resolve()})).catch((function(error){reject(error)}))):($log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / update legId/callId = "+legId+"/"+callId+" not relevant"),resolve());break;case"ended":if($log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / leg end / seqNum = "+seqNum),that.computeCallRelevancy(deviceId))that.getCallFromCallId(callId)?(that.telephonyService.clearCall(that.getCallFromCallId(callId),!0),callsToUpdate[callId]={trigger:!0,info:"leg"+op}):$log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem : leg ended / call already removed");else $log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem : leg ended but not relevant");resolve();break;default:$log.info("[TelephonyServiceEventHandlerSipWise] manageLegElem / invalid op -> "+op+" / seqNum = "+seqNum),reject()}}))},TelephonyServiceEventHandlerSipWise.prototype.manageAllEndPoints=function(eventElem,seqNum,callsToUpdate){var that=this,endPointPromises=[],liveEndPoints=0;return eventElem.find("endpoint").each((function(){var endPointElemIter=angular.element(this),endPointId=endPointElemIter.attr("endpointId"),op=endPointElemIter.attr("op");$log.info("[TelephonyServiceEventHandlerSipWise] manageAllEndPoints ITER endPointId = "+endPointId+" op = "+op+" / seqNum = "+seqNum),endPointElemIter.length&&("ended"!==op&&liveEndPoints++,endPointPromises.push($q((function(resolve,reject){that.manageEndPointElem(endPointElemIter,eventElem,seqNum,callsToUpdate).then((function(){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllEndPoints done for endPointId = "+endPointId+" / seqNum = "+seqNum)})).catch((function(error){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllEndPoints CATCH / seqNum = "+seqNum);var errorMessage="manageAllEndPoints -- "+error.message;$log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage)})).finally((function(){resolve()}))}))))})),$q.all(endPointPromises).finally((function(){$log.info("[TelephonyServiceEventHandlerSipWise] manageAllEndPoints : nb living endPoint = "+liveEndPoints+" / seqNum = "+seqNum)}))},TelephonyServiceEventHandlerSipWise.prototype.manageEndPointElem=function(endPointElem,eventElem,seqNum,callsToUpdate){var that=this;return $q((function(resolve,reject){var endPointId=endPointElem.attr("endpointId"),callId=endPointElem.attr("callId"),state=endPointElem.attr("state"),op=endPointElem.attr("op");endPointElem.attr("anonymous");endPointId||reject("manageEndPointElem -- Anomaly endPointId missing / seqNum = "+seqNum);callId||reject("manageEndPointElem -- Anomaly callId missing / seqNum = "+seqNum);op||reject("manageEndPointElem -- Anomaly op missing / seqNum = "+seqNum);switch($log.info("[TelephonyServiceEventHandlerSipWise] manageEndPointElem endPointId = "+endPointId+" callId = "+callId+" state = "+state+" op = "+op+" / seqNum = "+seqNum),op){case"created":$log.info("[TelephonyServiceEventHandlerSipWise] manageEndPointElem: create endPointId/callId = "+endPointId+"/"+callId),that.endPointElemCreate(eventElem).then((function(){that.checkCallRelevancy(callId)?callsToUpdate[callId]={trigger:!0,info:"endpoint"+op}:$log.info("[TelephonyServiceEventHandlerSipWise] manageEndPointElem: create endPointId/callId = "+endPointId+"/"+callId+" not yet relevant"),resolve()})).catch((function(error){reject(error)}));break;case"updated":$log.info("[TelephonyServiceEventHandlerSipWise] manageEndPointElem / updated"),that.endPointElemUpdate(eventElem).then((function(){that.checkCallRelevancy(callId)?callsToUpdate[callId]={trigger:!0,info:"endpoint"+op}:$log.info("[TelephonyServiceEventHandlerSipWise] manageEndPointElem: update endPointId/callId = "+endPointId+"/"+callId+" not relevant"),resolve()})).catch((function(error){reject(error)}));break;case"ended":$log.info("[TelephonyServiceEventHandlerSipWise] manageEndPointElem / ended"),resolve();break;default:reject("manageEndPointElem / Anomaly unmanaged op : "+op)}}))},TelephonyServiceEventHandlerSipWise.prototype.legElemCreate=function(eventElem){var that=this,legElem=eventElem.find("leg");return this.getCall(legElem).then((function(call){try{var legState=legElem.attr("state"),deviceId=legElem.attr("deviceId");if(!deviceId){var errorMessage="legElemCreate -- Anomaly deviceId missing";return $log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage),$q.reject(new Error(errorMessage))}return $log.info("[TelephonyServiceEventHandlerSipWise] legElemCreate / leg state : "+legState+" / deviceId : "+deviceId),call.setDeviceIdSipWise(deviceId),call.setRelevantEquipmentId(deviceId),that.callsetStatusFromLegState(call,legState,eventElem),call.startDate=null,call.vm=!1,$q.when()}catch(error){$log.info("[TelephonyServiceEventHandlerSipWise] legElemCreate catch");errorMessage="legElemCreate -- "+error.message;return $log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandlerSipWise.prototype.legElemUpdate=function(eventElem){$log.info("[TelephonyServiceEventHandlerSipWise] legElemUpdate");var that=this,legElem=eventElem.find("leg");return this.getCall(legElem).then((function(call){try{$log.info("[TelephonyServiceEventHandlerSipWise] legElemUpdate try");var legState=legElem.attr("state");return that.callsetStatusFromLegState(call,legState,eventElem),$q.when()}catch(error){$log.info("[TelephonyServiceEventHandlerSipWise] legElemUpdate catch");var errorMessage="legElemUpdate -- "+error.message;return $log.error("[TelephonyServiceEventHandlerSipWise] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandlerSipWise.prototype.endPointElemCreate=function(eventElem){$log.info("[TelephonyServiceEventHandlerSipWise] endPointElemCreate");var that=this,endPointElem=eventElem.find("endpoint"),callId=endPointElem.attr("callId"),phoneNumber=endPointElem.find("phoneNumber").text(),jid=endPointElem.find("jid").text(),firstName=endPointElem.find("firstName").text(),lastName=endPointElem.find("lastName").text();endPointElem.find("displayName").text();if(jid||phoneNumber)return $q((function(resolve){_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){jid||firstName&&lastName&&contact.updateName(firstName,lastName);var call=that.getCallFromCallId(callId);callId&&call?(call.setContact(contact),$log.info("[TelephonyServiceEventHandlerSipWise] endPointElemCreate setContact DONE : displayName = "+call.contact.nameForLog)):$log.info("[TelephonyServiceEventHandlerSipWise] endPointElemCreate NOT DONE / no associated call"),resolve()}))}));return $log.error("[TelephonyServiceEventHandlerSipWise] endPointElemCreate -- Anomaly no jid no phoneNumber"),$q.when()},TelephonyServiceEventHandlerSipWise.prototype.endPointElemUpdate=function(eventElem){$log.info("[TelephonyServiceEventHandlerSipWise] endPointElemUpdate");var that=this,endPointElem=eventElem.find("endpoint"),callId=endPointElem.attr("callId"),phoneNumber=endPointElem.find("phoneNumber").text(),jid=endPointElem.find("jid").text(),firstName=endPointElem.find("firstName").text(),lastName=endPointElem.find("lastName").text();endPointElem.find("displayName").text();if(jid||phoneNumber)return $q((function(resolve){_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){jid||firstName&&lastName&&contact.updateName(firstName,lastName);var call=that.getCallFromCallId(callId);callId&&call?(call.setContact(contact),$log.info("[TelephonyServiceEventHandlerSipWise] endPointElemUpdate setContact DONE : displayName = "+call.contact.nameForLog)):$log.info("[TelephonyServiceEventHandlerSipWise] endPointElemUpdate setContact NOT DONE / no associated call"),resolve()}))}));return $log.error("[TelephonyServiceEventHandlerSipWise] endPointElemUpdate -- Anomaly no jid no phoneNumber"),$q.when()},TelephonyServiceEventHandlerSipWise.prototype.onFailCallEvent=function(call,failedElem){var cause=failedElem.find("failedReason").text();$log.info("[TelephonyServiceEventHandlerSipWise] onFailCallEvent for callId : "+call.id+" / call status ERROR / cause : "+cause),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR),call.errorMessage=TelephonyServiceEventHandlerSipWise.CallFailureLabels[cause],call.errorMessage||(call.errorMessage=cause)},TelephonyServiceEventHandlerSipWise.prototype.convLegStateToCallStatus=function(legState){var status=null;if(!legState)return $log.info("[TelephonyServiceEventHandlerSipWise] convLegStateToCallStatus Anomaly no legState"),status;switch(legState){case"initiated":case"dialing":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING;break;case"ringingIn":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING;break;case"ringingOut":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_OUTGOING;break;case"queued":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING;break;case"active":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE;break;case"hold":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD;break;case"holdVictim":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD;break;case"failed":status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR;break;default:$log.info("[TelephonyServiceEventHandlerSipWise] convLegStateToCallStatus Anomaly legState = "+legState)}return status},TelephonyServiceEventHandlerSipWise.prototype.callsetStatusFromLegState=function(call,legState,eventElem){if(call&&legState){var status=this.convLegStateToCallStatus(legState);status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR?this.onFailCallEvent(call,eventElem):call.setStatus(status),$log.info("[TelephonyServiceEventHandlerSipWise] callsetStatusFromLegState legstate = "+legState+" Call.status = "+call.status.value)}else $log.info("[TelephonyServiceEventHandlerSipWise] callsetStatusFromLegState Anomaly Call = "+call+" legState"+legState)},TelephonyServiceEventHandlerSipWise.prototype.getCallFromCallId=function(callId){if(!callId)return $log.debug("[TelephonyServiceEventHandlerSipWise] getCallFromCallId - Anomaly no callId"),null;var call=this.telephonyService.calls[callId];return call?($log.debug("[TelephonyServiceEventHandlerSipWise] getCallFromCallId = "+callId+" -  call: "+call),call):null},TelephonyServiceEventHandlerSipWise.prototype.getCall=function(elem){var that=this;return $q((function(resolve){var callId=elem.attr("callId"),legId=elem.attr("legId");that.getOrCreateCall(callId,legId).then((function(call){resolve(call)}))}))},TelephonyServiceEventHandlerSipWise.prototype.getOrCreateCall=function(callId,legId){var that=this;if(!callId)return $q.reject("no callId");var call=this.telephonyService.calls[callId];return call&&call.getConnectionIdSipWise()?($log.debug("[TelephonyServiceEventHandlerSipWise] getOrCreateCall - "+callId+" -  => found completed call: "+call),$q.when(call)):($log.debug("[TelephonyServiceEventHandlerSipWise] getOrCreateCall - "+callId+" -  => not completed : manage it"),legId?$q((function(resolve){resolve(that.telephonyService.getOrCreateCallSipWise(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,callId,legId))})):$q.reject("no legId"))},TelephonyServiceEventHandlerSipWise.prototype.sendCallUpdateEvent=function(call,elem){if(call){$log.info("[TelephonyServiceEventHandlerSipWise] sendCallUpdateEvent for call "+call);var infoEvt=this.extractInfoEvent(elem);$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call,infoEvt)}},TelephonyServiceEventHandlerSipWise.prototype.extractInfoEvent=function(elem){return elem&&null!==elem?elem:null},TelephonyServiceEventHandlerSipWise.prototype.CallsUpdate=function(callsToUpdate){var that=this;$log.info("[TelephonyServiceEventHandlerSipWise] CallsUpdate"),Object.keys(callsToUpdate||[]).forEach((function(callId){callsToUpdate[callId]&&callsToUpdate[callId].trigger?($log.info("[TelephonyServiceEventHandlerSipWise] CallsUpdate for callId "+callId+" triggered"),that.sendCallUpdateEvent(that.getCallFromCallId(callId),callsToUpdate[callId].info)):$log.info("[TelephonyServiceEventHandlerSipWise] CallsUpdate for callId "+callId+" no triggered")}))},TelephonyServiceEventHandlerSipWise.prototype.computeCallRelevancy=function(deviceId){var result=!1,currentUsedDevice=this.telephonyService.telephonyServiceSipWise.getCurrentFromDevicesListSipWise();return deviceId&&(result=deviceId===currentUsedDevice.deviceId),$log.info("[TelephonyServiceEventHandlerSipWise] computeCallRelevancy for deviceId : "+deviceId+" / relevant = "+result),result},TelephonyServiceEventHandlerSipWise.prototype.checkCallRelevancy=function(callId){var result=!1,currentUsedDevice=this.telephonyService.telephonyServiceSipWise.getCurrentFromDevicesListSipWise(),call=this.getCallFromCallId(callId);return call&&($log.debug("[TelephonyServiceEventHandlerSipWise] checkCallRelevancy call.deviceID = "+call.getDeviceIdSipWise()),result=call.getDeviceIdSipWise()==currentUsedDevice.deviceId),$log.info("[TelephonyServiceEventHandlerSipWise] checkCallRelevancy for callId : "+callId+" / relevant = "+result),result},TelephonyServiceEventHandlerSipWise}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var rxjs__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23),_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(0),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(5),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3__),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4__),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5__),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(14),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7__);angular.module("rainbow").service("telephonyService",["$q","$interval","$http","$rootScope","$log","TelephonyServiceEventHandler","errorHelperService","VoiceMail","videoService","$injector",function($q,$interval,$http,$rootScope,$log,TelephonyServiceEventHandler,errorHelperService,VoiceMail,videoService,$injector){var service=this,listeners=[],subscriptions=[],CALLSERVICE_NS="urn:xmpp:pbxagent:callservice:1",sipWise=!1;service.rxSubject=new rxjs__WEBPACK_IMPORTED_MODULE_0__.a,service.start=function(stats){if($log.info("[telephonyService] === STARTING ==="),service.setSipWise(service.isSipWiseRoot()),service.isSipWise()){$log.info("[telephonyService] starting in sipWise mode"),CALLSERVICE_NS="urn:xmpp:pbxagent:telephony:1";try{service.telephonyServiceEventHandlerSipWise=$injector.get("TelephonyServiceEventHandlerSipWise")}catch(error){var errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[telephonyService] injection TelephonyServiceEventHandlerSipWise  exception  -- "+errorMessage+" : "+errorStack)}try{service.telephonyServiceSipWise=$injector.get("telephonyServiceSipWise")}catch(error){errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[telephonyService] injection TelephonyServiceSipWise  exception  -- "+errorMessage+" : "+errorStack)}}service.startDate=performance.now(),service.stats=stats,service.calls=[],service.pendingMakeCalls=[],service.starting=service.started=!1,service.agentStatus={phoneApi:"disconnected",xmppAgent:"stopped",agentVersion:"unknown"},service.voicemailNumber=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.voicemailNumber,service.pbxId=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.pbxId,service.makingCall=!1,service.voiceMail=VoiceMail.create(),service.forwardObject={},service.nomadicObject={},service.nomadicAnswerNotTakedIntoAccount=!1,service.sipWiseUserGroupsData={huntingGroupNb:0,managerAssistantNb:0,managerAssistGrId:0,managerId:0,managerName:"",managerStatus:"",managerForward:"unknow",assistantId:0,assistantName:"",assistantStatus:"",sipWiseUserGroupsList:[]},service.sipWiseEmergencyCallData={WGEmergencyCallForbidden:!1,emergencyNuList:[],serverData:null},service.isBasicCallAllowed=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_BASIC_CALL),service.isSecondCallAllowed=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_SECOND_CALL),service.isTransferAllowed=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_TRANSFER_CALL),service.isConferenceAllowed=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_CONFERENCE_CALL),service.isVMDeflectCallAllowed=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_DEFLECT_CALL),service.voiceMailFeatureEnabled=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_VOICE_MAIL),service.isForwardEnabled=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_CALL_FORWARD),service.isNomadicEnabled=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_NOMADIC),service.userJidTel=_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.jidTel,service.portalURL=config.restServerUrl+"/api/rainbow/telephony/v1.0/",subscriptions.push(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.subscribeToContactEvents((function(event){"ON_CONTACT_PRESENCE_EVENT"===event.name&&service.onTelPresenceChange(event.data)}))),service.isSipWise()?service.telephonyEventHandler=service.telephonyServiceEventHandlerSipWise.create(service):service.telephonyEventHandler=TelephonyServiceEventHandler.create(service),$log.info("[telephonyService] starting on user jidTel: "+service.userJidTel),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact&&($log.info("[telephonyService] starting user name: "+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.nameForLogs+", full jid: "+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.fullJid),$log.info("[telephonyService] starting phonePbx: "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePbx)+", phonePro: "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePro)+", voicemailNumber: "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.voicemailNumber)+", pbxId: "+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.pbxId)),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact&&(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.telStatus?($log.info("[telephonyService] start with my existing telephony presence "+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.telStatus+" of user contact ("+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.jidtel+") "),service.onTelPresenceChange({jid:service.userJidTel+"/phone",status:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.telStatus})):($log.info("[telephonyService] Subscribe and wait for my telephony presence ("+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.jidtel+")"),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.sendSubscribeInvitation(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.jidtel)))},service.onTelPresenceChange=function(attr){if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.isTelJid(attr.jid)){var ressourceFromJid=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getResourceFromJid(attr.jid);if("phone"!==ressourceFromJid&&"pcg2"!==ressourceFromJid)return!0;var jid_im=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getImJid(attr.jid);if(!jid_im)return!0;var status=attr.status;_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.isUserContactJid(jid_im)&&("unavailable"===status||"offline"===status?($log.info("[telephonyService] received my telephony presence -- "+status),service.starting=service.started=!1,service.telephonyOfflineCallManagement(),$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),$log.info("[telephonyService] === STOPPED ===")):service.started||service.starting||($log.info("[telephonyService] received my telephony presence -- "+status),service.starting=!0,service.getAgentStatus().then((function(){return service.attachHandlers(),service.isSipWise()?(service.sipWiseUserGroupsDataClear(),service.sipWiseEmergencyCallDataClear(),service.getTelephonyState(!1)):service.isNomadicEnabled?service.getNomadicStatus().then((function(){var snapshotSecondary=service.nomadicObject.featureActivated&&service.nomadicObject.modeActivated&&!service.nomadicObject.makeCallInitiatorIsMain;return service.getTelephonyState(snapshotSecondary)})):service.getTelephonyState(!1)})).then((function(){service.isForwardEnabled&&service.getForwardStatus()})).then((function(){var startDuration=Math.round(performance.now()-service.startDate);service.stats.push({service:"telephonyService",startDuration:startDuration}),$log.info("[telephonyService] === STARTED ("+startDuration+" ms) ==="),service.started=!0,service.starting=!1,$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","started")})).catch((function(error){service.starting=!1,$log.error("[telephonyService] receive telephony presence but error in initialization - "+(error?error.message:"unknown error"))}))))}return!0},service.launchTelephonyInitilization=function(){_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact&&_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.telStatus?($log.info("[telephonyService] launchTelephonyInitilization telStatus: "+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.telStatus+" => start"),service.onTelPresenceChange({jid:service.userJidTel+"/phone",status:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.telStatus})):$log.info("[telephonyService] launchTelephonyInitilization no tel presence => do nothing")},service.reconnect=function(){$log.info("[telephonyService] reconnect (xmpp reconnection)"),service.starting=service.started=!1,service.telephonyOfflineCallManagement(),$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),service.attachHandlers()},service.telephonyOfflineCallManagement=function(){$log.info("[telephonyService] telephony Offline Call Management");try{var webrtcGatewayService=$injector.get("webrtcGatewayService");Object.keys(service.calls||[]).forEach((function(key){var call=service.calls[key];call&&(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.RINGING_INCOMMING&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_INCOMMING||(call.mediaPillarCall&&call.mediaPillarCall.webrtcCallRef&&($log.info("[telephonyService] Offline Call Management: release MP webrtc call for phone call "+call.id+" in state "+call.status.value),videoService.releaseCall(call.mediaPillarCall.webrtcCallRef)),$log.info("[telephonyService] Offline Call Management: stop popup and ringing tone for phone call "+call.id+" in state "+call.status.value),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),(call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.RINGING_OUTGOING||call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_OUTGOING)&&webrtcGatewayService.isMediaPillarCallSituation(call)&&call.mediaPillarCall&&call.mediaPillarCall.webrtcCallRef&&($log.info("[telephonyService] Offline Call Management: release MP webrtc call for phone call "+call.id+" in state "+call.status.value),videoService.releaseCall(call.mediaPillarCall.webrtcCallRef)),webrtcGatewayService.isMediaPillarCallSituation(call)&&call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE?($log.info("[telephonyService] Offline Call Management: keep MP call for phone call "+call.id+" in state "+call.status.value),call.pbxConnectionDown=!0):(delete service.calls[call.id],$log.info("[telephonyService] Offline Call Management: phone call deleted: "+call.id+" in state "+call.status.value)))})),$log.info("[telephonyService] Offline Call Management: clear "+service.pendingMakeCalls.length+" pending makecalls"),service.pendingMakeCalls=[]}catch(error){var errorMessage=error&&error.message?error.message:"Unknown error",errorStack=error&&error.stack?error.stack:"Unknown stack";$log.error("[telephonyService] telephonyOfflineCallManagement  exception  -- "+errorMessage+" : "+errorStack)}},service.getTelephonyState=function(secondary){if(service.isSipWise())return $q((function(resolve,reject){$log.info("[telephonyService] getTelephonyState -- sipWise get Devices then snapshot"),service.telephonyServiceSipWise.getUserDevices(service).then((function(){return service.telephonyServiceSipWise.processSnapshot(service)})).then((function(){return service.telephonyServiceSipWise.getUserRoutingInfo(service)})).then((function(){service.getSipWiseUserGroups()})).then((function(){service.fetchSipWiseEmergencyCallData()})).then((function(){resolve()})).catch((function(error){$log.info("[telephonyService] sipwise getTelephonyState CATCH");var errorMessage="sipwise getTelephonyState -- "+error.message;$log.error("[telephonyService] "+errorMessage),reject(error)}))}));var iq,defered=$q.defer();return iq=secondary?$iq({type:"get",to:service.userJidTel+"/phone"}).c("callservice",{xmlns:CALLSERVICE_NS}).c("connections",{deviceType:"SECONDARY"}):$iq({type:"get",to:service.userJidTel+"/phone"}).c("callservice",{xmlns:CALLSERVICE_NS}).c("connections"),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.sendIQ(iq,6e4).then((function(data){var errorMessage=service.getErrorMessage(data,"getTelephonyState");if(errorMessage)return $log.info("[telephonyService] getTelephonyState -- failure -- "+errorMessage),defered.reject(new Error(errorMessage)),defered.promise;var existingCalls=angular.element(data).find("connection");if($log.info("[telephonyService] getTelephonyState ("+(secondary?"SECONDARY":"MAIN")+") -- success -- "+existingCalls.length+" existing call(s)"),0===existingCalls.length)return defered.resolve(),defered.promise;var getCallPromises=[];return existingCalls.each((function(){getCallPromises.push(service.createCallFromConnectionElem(this,secondary))})),$q.all(getCallPromises).then((function(){$log.info("[telephonyService] getTelephonyState ("+(secondary?"SECONDARY":"MAIN")+") -- calls creation completed -- "+existingCalls.length+" calls created"),defered.resolve()})).catch((function(error){$log.error("[telephonyService] getTelephonyState -- calls creation failure -- "+error.message),defered.reject(error)})),defered.promise})).catch((function(error){$log.error("[telephonyService] getTelephonyState -- failure -- "+error.message),defered.reject(error)})),defered.promise},service.snapshotDevice=function(secondary){return $q((function(resolve,reject){if(service.isSipWise())resolve();else{var reqUrl=service.portalURL+"snapshotdevice";secondary&&(reqUrl+="?deviceType=SECONDARY"),$http({method:"GET",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(response){$log.info("[telephonyService] snapshotdevice success "),resolve(response.data.data)}),(function(response){$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"snapshotdevice"));var error=errorHelperService.handleError(response);reject(error)}))}}))},service.getAgentStatus=function(){var defered=$q.defer(),toPCG="/phone";service.isSipWise()&&($log.info("[telephonyService] getAgentStatus --- sipWise version"),toPCG="/pcg2");var getAgentIq=$iq({type:"get",to:service.userJidTel+toPCG}).c("pbxagentstatus",{xmlns:"urn:xmpp:pbxagent:monitoring:1"});return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.sendIQ(getAgentIq,6e4).then((function(data){var phoneApi=angular.element(data).find("phoneapi").text(),xmppAgent=angular.element(data).find("xmppagent").text(),agentVersion=angular.element(data).find("version").text(),features=angular.element(data).find("features").text(),type=angular.element(data).find("type").text();if(agentVersion&&(service.agentStatus={phoneApi:phoneApi,xmppAgent:xmppAgent,agentVersion:agentVersion,features:features},type?(service.isOxe=type.toLowerCase().includes("oxe"),service.isOxo=type.toLowerCase().includes("oxo")):(service.isOxe=agentVersion.toLowerCase().includes("oxe"),service.isOxo=agentVersion.toLowerCase().includes("oxo"))),service.isSipWise()&&"RVCP"!==type){service.setSipWise(!1);var errorMessage="getAgentStatus -- sipWise failure : wrong PCG type";$log.error("[telephonyService] "+errorMessage),defered.reject(new Error(errorMessage))}$log.info("[telephonyService] getAgentStatus -- success -- version "+agentVersion+" isOxe:"+service.isOxe+" isOxo:"+service.isOxo+" isSipWise:"+service.isSipWise()),$rootScope.$broadcast("ON_AGENT_STATUS_RECEIVED_EVENT"),defered.resolve()})).catch((function(error){var errorMessage="getAgentStatus -- failure : "+error.message;$log.error("[telephonyService] "+errorMessage),defered.reject(new Error(errorMessage))})),defered.promise},service.getSnapshotCall=function(callId){return $log.info("[telephonyService] getSnapshotCall"),$q((function(resolve,reject){var iq=$iq({type:"get",to:service.userJidTel+"/phone"}).c("callservice",{xmlns:CALLSERVICE_NS}).c("snapshotCall",{callId:callId});_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.sendIQ(iq).then((function(data){console.error(data),resolve()})).catch((function(error){var errorMessage="getSnapshotCall failure : "+error.message;$log.error("[telephonyService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.createCallFromConnectionElem=function(connectionElemObj,secondary){return $q((function(resolve,reject){var connectionElem=angular.element(connectionElemObj),jid=connectionElem.attr("endpointIm"),phoneNumber=connectionElem.attr("endpointTel"),connectionId=connectionElem.attr("callId"),endpointLci=connectionElem.attr("endpointLci"),lci=connectionElem.attr("lci"),participantsElem=connectionElem.find("participant"),identityFirstName=connectionElem.find("identity").attr("firstName"),identityLastName=connectionElem.find("identity").attr("lastName"),firstName="",lastName="";if(jid||phoneNumber||(phoneNumber="****"),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.TELEPHONY_PHONE_BOOK)&&0===participantsElem.length&&identityLastName&&identityLastName.length&&(lastName=identityLastName,identityFirstName&&identityFirstName.length&&(firstName=identityFirstName),$log.info("[telephonyService] createCallFromConnectionElem - name resolution for: "+connectionId+" for phoneNumber:"+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber)+" with firstname : "+firstName.slice(0,1)+"***")),"LCI_INITIATED"!==lci||secondary&&$injector.get("webrtcGatewayService").IsMediaPillarUserSelected()){(0===participantsElem.length?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getOrCreateContact(jid,phoneNumber):service.getParticipantsFromParticipantsElem(participantsElem)).then((function(response){var callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE;"LCI_INITIATED"===lci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.DIALING),"LCI_HELD"===lci&&"LCI_CONNECTED"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.HOLD),"LCI_CONNECTED"===lci&&"LCI_HELD"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.PUT_ON_HOLD),"LCI_CONNECTED"===lci&&"LCI_QUEUED"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_OUTGOING),"LCI_QUEUED"===lci&&"LCI_CONNECTED"===endpointLci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_INCOMMING),"LCI_ALERTING"===lci&&(callStatus=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.RINGING_INCOMMING);var call=null;0===participantsElem.length?(response&&response.temp&&""!==lastName&&response.updateName(firstName,lastName),call=service.getOrCreateCall(callStatus,connectionId,response),$log.info("[telephonyService] createCallFromConnectionElem - create call for user: "+response.id+" with callId: "+connectionId+" "+lci)):((call=service.getOrCreateCall(callStatus,connectionId)).setParticipants(response),call.isConference=!0,$log.info("[telephonyService] createCallFromConnectionElem - create conference call with callId: "+connectionId+" "+lci));call.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.getDeviceIdFromConnectionId(connectionId),call.isSecondary=secondary,call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)})).catch((function(error){$log.error("[TelephonyService] createCallFromConnectionElem - failure - "+error.message),reject(error)}))}else resolve()}))},service.getParticipantsFromParticipantsElem=function(participants){return $q((function(resolve,reject){var confParticipants=[],participantPromises=[];participants.each((function(){var participantElem=angular.element(this),endpointTel=participantElem.find("endpointTel").text(),endpointIm=participantElem.find("endpointIm").text();endpointIm&&_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.isUserContactJid(endpointIm)||participantPromises.push($q((function(resolvePromise,rejectPromise){endpointIm||endpointTel||(endpointTel="****"),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getOrCreateContact(endpointIm,endpointTel).then((function(contact){confParticipants.push(contact),resolvePromise()})).catch((function(error){rejectPromise(error)}))})))})),$q.all(participantPromises).then((function(){resolve(confParticipants)}),(function(error){reject(error)}))}))},service.getOrCreateCall=function(status,connectionId,contact){var call=service.calls[_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.getIdFromConnectionId(connectionId)];return call?(call.setConnectionId(connectionId),call.startDate=new Date):((call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.create(status,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Type.PHONE,contact)).setConnectionId(connectionId),service.calls[call.id]=call),call},service.createCallSipWise=function(status,callId){var call=null;return callId&&(call=service.calls[callId]),call?call.startDate=new Date:(call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.create(status,callId,_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Type.PHONE),service.calls[call.id]=call),call},service.getOrCreateCallSipWise=function(status,callId,legId,deviceId,contact){var call=null;return callId&&(call=service.calls[callId]),call?(call.setConnectionIdSipWise(legId),contact&&call.setContact(contact),deviceId&&call.setDeviceIdSipWise(deviceId),call.startDate=new Date):((call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.create(status,callId,_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Type.PHONE,contact)).setConnectionIdSipWise(legId),call.setDeviceIdSipWise(deviceId),service.calls[call.id]=call),call},service.attachHandlers=function(){$log.info("[telephonyService] attachHandlers"),0===Object.keys(service.calls||[]).length&&($rootScope.telephonyAreaClass=""),service.messageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.deleteHandler(service.messageHandlerRef),service.messageHandlerRef=null),service.messageHandlerRef=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.addHandler((function(stanza){return service.telephonyEventHandler.onCallserviceMessageReceived(stanza),!0}),CALLSERVICE_NS,"message",null)},service.stop=function(){var listener;for($log.info(""),$log.info("[telephonyService] === STOPPING ==="),service.starting=service.started=!1,service.userJidTel=null,service.calls=null,service.messageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.deleteHandler(service.messageHandlerRef),service.messageHandlerRef=null);listener=listeners.pop();)listener();return service.currentPgiObject={},subscriptions&&subscriptions.forEach((function(subscription){subscription.unsubscribe()})),$log.info("[telephonyService] === STOPPED ==="),$rootScope.$broadcast("ON_TELEPHONY_STATUS_CHANGED_EVENT","stopped"),$q.when()},service.getCallToHangOut=function(){var calls=service.getCalls();if(!calls||0===calls.length)return null;var callStatus=calls[0].status;return 1===calls.length||callStatus===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.DIALING||callStatus===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE||callStatus===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.PUT_ON_HOLD?calls[0]:calls[1]},service.getActiveCall=function(){var activeCall=null;return Object.keys(service.calls||[]).forEach((function(key){var call=service.calls[key];call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE&&(activeCall=call)})),activeCall},service.getCalls=function(){var calls=[];return Object.keys(service.calls||[]).forEach((function(key){var status=service.calls[key].status;status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.DIALING&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.RINGING_OUTGOING&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_OUTGOING&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.HOLD&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.PUT_ON_HOLD&&status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ERROR||calls.push(service.calls[key])})),calls},service.getNotIdleCalls=function(){var calls=[];return Object.keys(service.calls||[]).forEach((function(key){var call=service.calls[key];call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN&&calls.push(call)})),calls},service.getActiveCallsForContact=function(contact){var calls=[];return contact&&contact.jid&&Object.keys(service.calls||[]).forEach((function(key){!service.calls[key].contact||service.calls[key].contact.jid!==contact.jid||service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.DIALING&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.RINGING_OUTGOING&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_OUTGOING&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.HOLD&&service.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.PUT_ON_HOLD||calls.push(service.calls[key])})),calls},service.getConferenceCallForContact=function(contact){var conferenceCall=null;return contact&&contact.jid&&Object.keys(service.calls||[]).forEach((function(key){service.calls[key].status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE&&service.calls[key].isConference&&(service.calls[key].participants||[]).some((function(participantContact){return participantContact&&participantContact.jid===contact.jid}))&&(conferenceCall=service.calls[key])})),conferenceCall},service.logMakecallReqData=function(reqData,contact){var reqDataForLogs={};Object.keys(reqData).forEach((function(reqDataProperty){switch(reqDataProperty){case"calleeExtNumber":case"calleeIntNumber":case"calleeShortNumber":reqDataForLogs[reqDataProperty]=_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(reqData[reqDataProperty]);break;case"calleeDisplayName":contact&&(reqDataForLogs[reqDataProperty]=contact&&contact.nameForLogs?contact.nameForLogs:"");break;default:reqDataForLogs[reqDataProperty]=reqData[reqDataProperty]}})),$log.info("[telephonyService] makeCall data: "+JSON.stringify(reqDataForLogs))},service.makeCall=function(contact,phoneNumber,callSubject,correlatorData){$log.info("TELAPI [telephonyService] makeCall to "+(contact&&contact.nameForLogs?contact.nameForLogs:_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber)));var activeCall=service.getActiveCall();return service.makingCall?($log.warn("[telephonyService] makeCall failure - makeCall already making a call"),$q.reject()):(service.makingCall=!0,activeCall?service.isSipWise()?service.telephonyServiceSipWise.makeSimpleCallSipWise(service,contact,phoneNumber):service.makeConsultationCall(contact,phoneNumber,activeCall.connectionId,correlatorData):service.isSipWise()?service.telephonyServiceSipWise.makeSimpleCallSipWise(service,contact,phoneNumber):service.makeSimpleCall(contact,phoneNumber,callSubject,correlatorData))},service.makeSimpleCall=function(contact,phoneNumber,callSubject,correlatorData){if($log.info("[telephonyService] makeSimpleCall to "+(contact&&contact.nameForLogs?contact.nameForLogs:_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber))),!service.isBasicCallAllowed){var profileError=new Error("makeSimpleCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),service.makingCall=!1,$q.reject(profileError)}if($injector.get("webrtcGatewayService").isMediaPillarCallSituation()&&videoService.getWebrtcAudioCall())return $log.info("[telephonyService] makeCall failure - webrtcgateway call not possible when webrtc call already engaged"),service.makingCall=!1,$rootScope.$broadcast("ON_CALL_NOTALLOWED_EVENT","webCallAlreadyProgress"),$q.reject("webCallAlreadyProgress");var phoneInfo=service.getPhoneInfo(contact,phoneNumber),reqUrl=service.portalURL+"calls",reqData={calleeExtNumber:phoneInfo.longNumber,calleeIntNumber:phoneInfo.internalNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,calleeDisplayName:contact.displayName,callSubject:callSubject,correlatorData:correlatorData,secondaryDeviceMakeCall:angular.isDefined(service.nomadicObject.makeCallInitiatorIsMain)&&!0===service.nomadicObject.featureActivated&&service.isNomadicEnabled?service.nomadicObject.makeCallInitiatorIsMain?"false":"true":void 0};return $log.info("[telephonyService] makeSimpleCall POST "+reqUrl),service.logMakecallReqData(reqData,contact),service.doRequestMakecall(contact,phoneNumber,"POST",reqUrl,reqData)},service.makeConsultationCall=function(contact,phoneNumber,callId,correlatorData){if($log.info("[telephonyService] makeConsultationCall to "+(contact&&contact.nameForLogs?contact.nameForLogs:_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber))),!service.isSecondCallAllowed){var profileError=new Error("makeConsultationCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),service.makingCall=!1,$q.reject(profileError)}var phoneInfo=service.getPhoneInfo(contact,phoneNumber,correlatorData),reqUrl=service.portalURL+"calls/"+encodeURIComponent(callId)+"/consultation",reqData={calleeExtNumber:phoneInfo.longNumber,calleeIntNumber:phoneInfo.internalNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,calleeDisplayName:contact.displayName,correlatorData:phoneInfo.correlatorData};return $log.info("[telephonyService] makeConsultationCall POST "+reqUrl),service.logMakecallReqData(reqData,contact),service.doRequestMakecall(contact,phoneNumber,"POST",reqUrl,reqData).catch((function(error){throw service.deleteCallIfInvalid(error,service.calls[_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.getIdFromConnectionId(callId)]),error}))},service.doRequestMakecall=function(contact,phoneNumber,reqMethod,reqUrl,reqData){return $q((function(resolve,reject){$log.info("[telephonyService] doRequestMakecall to "+(contact&&contact.nameForLogs?contact.nameForLogs:_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber)));var call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Type.PHONE,contact);call.isSecondary=service.nomadicObject&&!service.nomadicObject.makeCallInitiatorIsMain,call.isOwner=!0,call.setIsVm(phoneNumber===service.voicemailNumber),service.pendingMakeCalls.push(call),$log.info("[telephonyService] doRequestMakecall Call created ("+call+")"),$http({method:reqMethod,url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] doRequestMakecall success : callee "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber)+" callId: "+response.data.data.callId),service.pendingMakeCalls.includes(call)?(call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.DIALING),call.setConnectionId(response.data.data.callId),call.setRelevantEquipmentId(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.getDeviceIdFromConnectionId(call.connectionId)),service.calls[call.id]=call,service.pendingMakeCalls.splice(service.pendingMakeCalls.indexOf(call),1),$log.info("[telephonyService] doRequestMakecall Call confirmed by makecall acknowlegement ("+call+")"),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call.id)):resolve(call.id?call.id:response.data.data.callId),service.makingCall=!1}),(function(response){$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"makeCall")),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ERROR),call.errorMessage=response&&"403"===response.errorDetailsCode?"notAllowed":"invalidPhoneNumber",service.calls[call.contact.id]=call,service.pendingMakeCalls.splice(service.pendingMakeCalls.indexOf(call),1),call.autoClear=$interval((function(){service.clearCall(call)}),5e3,1),service.makingCall=!1,call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call);var error=errorHelperService.handleError(response);reject(error)}))}))},service.makeCallByPhoneNumber=function(phoneNumber,callSubject,correlatorData){return $q((function(resolve,reject){if($log.info("[telephonyService] makeCallByPhoneNumber : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber)),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePro===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phoneProCan===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePbx===phoneNumber){var errorMessage="makeCallByPhoneNumber failure: impossible to call its own phone number";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getOrCreateContact(null,phoneNumber).then((function(contact){return contact,service.makeCall(contact,phoneNumber,callSubject,correlatorData)})).then((function(){resolve()})).catch((function(error){var _errorMessage="makeCallByPhoneNumber failure "+(error?error.message:"");$log.error("[telephonyService] - callService - "+_errorMessage),reject(new Error(_errorMessage))}))}))},service.getPhoneInfo=function(contact,phoneNumber,correlatorData){var longNumber=phoneNumber,shortNumber="",internalNumber="",pbxId="";return contact&&(phoneNumber===contact.phonePro||phoneNumber===contact.phoneProCan?(longNumber=contact.phoneProCan?contact.phoneProCan:"",shortNumber=contact.phonePbx,pbxId=contact.pbxId,internalNumber=contact.phoneInternalNumber):phoneNumber===contact.phonePbx&&(longNumber="",shortNumber=contact.phonePbx,pbxId=contact.pbxId,internalNumber=contact.phoneInternalNumber)),{longNumber:longNumber,shortNumber:shortNumber,pbxId:pbxId,internalNumber:internalNumber,correlatorData:correlatorData}},service.getErrorMessage=function(data,actionLabel){var errorMessage=actionLabel+" failure : ";if("error"===angular.element(data).attr("type")){var error=angular.element(data).find("error");if(error){var errorType=error.attr("type"),errorCode=error.attr("code");errorType&&(errorMessage+=errorType+" : ","modify"===errorType&&(errorMessage+=error.find("text").text())),errorCode&&"503"===errorCode&&(errorMessage+="Agent error : service unavailable"),$log.error("[telephonyService] "+errorMessage)}else errorMessage+="Unknown error";return errorMessage}return null},service.releaseCall=function(call){return $q((function(resolve,reject){if($log.info("TELAPI [telephonyService] releaseCall "+call.id),!service.isBasicCallAllowed){var profileError=new Error("releaseCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(call.pbxConnectionDown)return call.mediaPillarCall&&call.mediaPillarCall.webrtcCallRef&&call.mediaPillarCall.webrtcCallRef.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN?($log.info("[telephonyService] releaseCall "+call.id+" with pbx connection down : we release the mediapillar web call: "+call.mediaPillarCall.webrtcCallRef),videoService.releaseCall(call.mediaPillarCall.webrtcCallRef)):$log.info("[telephonyService] releaseCall "+call.id+" with pbx connection down : "+(call.mediaPillarCall?call.mediaPillarCall.webrtcCallRef?"no need to release webrtc call with status "+call.mediaPillarCall.webrtcCallRef:"no MP webrtc call to release":"no MP context!")),$log.info("[telephonyService] releaseCall "+call.id+" with pbx connection down : we remove the phone call"),service.clearCall(call),void resolve(call);if(service.isSipWise())service.telephonyServiceSipWise.releaseCallSipWise(service,call).then((function(theCall){resolve(theCall)}));else{var reqUrl=service.portalURL+"calls/"+encodeURIComponent(call.connectionId);$log.info("[telephonyService] releaseCall DELETE "+reqUrl),$http({method:"DELETE",url:reqUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN),call.startDate=null,call.vm=!1,$log.info("[telephonyService] releaseCall "+call.id+" - success"),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),delete service.calls[call.id],resolve(call)}),(function(response){var error=errorHelperService.handleError(response);service.deleteCallIfInvalid(error,call),reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"releaseCall"))}))}}))},service.releaseCallAndNotify=function(call){return $q((function(resolve,reject){service.releaseCall(call).then((function(){resolve()})).catch((function(){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),reject()}))}))},service.deleteCallIfInvalid=function(error,call){error&&"telephony"===error.portal&&404100===error.errorDetailsCode&&error.message&&(error.message.toLowerCase().includes("invalid connection identifier")||error.message.toLowerCase().includes("failed to send releasecall"))&&call&&($log.warn("[telephonyService] deleteCallIfInvalid: delete client call non existing on server: "+call.id),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),service.calls[call.id]&&delete service.calls[call.id])},service.answerCall=function(call){return $q((function(resolve,reject){$log.info("[telephonyService] answerCall : "+call.id);var activeCall=service.getActiveCall();if(!service.isBasicCallAllowed){var profileError=new Error("answerCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(call.isMediaPillarCall()&&($injector.get("webrtcGatewayService").isMediaPillarCallSituation(call)&&$rootScope.isDesktopApp)){var MP_context=call.getMediaPillarCall();if(MP_context&&MP_context.webrtcCallRef)return videoService.answerCall(MP_context.webrtcCallRef,"audio"),$log.info("[telephonyService] answer webrtcgateway sending webrtc proceed"),void resolve(call);$log.info("[telephonyService] answer webrtcgateway | Anomaly media Pillar : answer but no webrtcCallref")}service.isSipWise()?service.telephonyServiceSipWise.answerCallSipWise(service,call).then((function(theCall){resolve(theCall)}),(function(error){reject(error)})):call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.QUEUED_INCOMMING&&activeCall&&service.isOxe?service.holdCall(activeCall).catch((function(error){$log.warn("[telephonyService] holdCall (before answerCall) failed on callId:"+activeCall.connectionId+" "+error)})).then((function(){return service.answerCall(call)})).then((function(thecall){resolve(thecall)})).catch((function(error){var errorMessage="answerCall failure : "+error.message;$log.error("[telephonyService] - callService -  "+errorMessage),reject(new Error(errorMessage))})):$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/answer",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(response){call.setConnectionId(response.data.data.callId),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE),$log.info("[telephonyService] answerCall success : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(call.contact.phone)+" Call ("+call+")"),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){response.data&&"Device is not able to answer a call"===response.data.errorDetails&&$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{autoClose:!1,okLabel:"close",popupTitle:"warning",popupBody:"deviceDoesntAllowAnswer"}),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN);var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"answerCall"))}))}))},service.answerCallAndNotify=function(call){return $q((function(resolve,reject){service.answerCall(call).then((function(){resolve()})).catch((function(){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),reject()}))}))},service.holdCall=function(call){return $q((function(resolve,reject){if($log.info("[telephonyService] holdCall : callId: "+call.id+" "+call.contact.nameForLog),call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.HOLD){if(!service.isSecondCallAllowed){var profileError=new Error("holdCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}service.isSipWise()?service.telephonyServiceSipWise.holdCallSipWise(service,call).then((function(theCall){resolve(theCall)}),(function(error){reject(error)})):$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/hold",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(response){$log.info("[telephonyService] holdCall success : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(call.contact.phone)+" Call ("+call+")"),call.setConnectionId(response.data.data.callId),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.HOLD),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve(call)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"holdCall"))}))}else resolve(call)}))},service.retrieveCall=function(call){return $q((function(resolve,reject){if($log.info("[telephonyService] retrieveCall callId: "+call.id+" "+call.contact.nameForLog),!service.isSecondCallAllowed){var profileError=new Error("retrieveCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}var activeCall=service.getActiveCall();if(activeCall)service.holdCall(activeCall).then((function(){return service.retrieveCall(call)})).then((function(thecall){resolve(thecall)})).catch((function(error){var errorMessage="retrieveCall failure : "+error.message;$log.error("[telephonyService] - callService -  "+errorMessage),reject(new Error(errorMessage))}));else{if(service.isSipWise())return void service.telephonyServiceSipWise.retrieveCallSipWise(service,call).then((function(theCall){resolve(theCall)}),(function(error){reject(error)}));$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/retrieve",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(response){$log.info("[telephonyService] retrieveCall success : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(call.contact.phone)+" Call ("+call+")"),call.setConnectionId(response.data.data.callId),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.ACTIVE),call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve()}),(function(response){var error=errorHelperService.handleError(response);service.deleteCallIfInvalid(error,call),reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"retrieveCall"))}))}}))},service.deflectCallToVM=function(call){return $q((function(resolve,reject){if(call){if(!service.isVMDeflectCallAllowed){var profileError=new Error("deflectCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}$log.info("[telephonyService] deflectCallToVM "+call.contact.nameForLog),service.isSipWise()?service.telephonyServiceSipWise.deflectCallSipWise(service,call,service.voicemailNumber).then((function(){resolve()}),(function(error){reject(error)})):$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/deflect",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:service.voicemailNumber,calleeShortNumber:service.voicemailNumber,calleePbxId:service.pbxId}}).then((function(){$log.info("[telephonyService] deflectCall success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"deflectCallToVM"))}))}else resolve(call)}))},service.deflectCallToNumber=function(call,number){return $q((function(resolve,reject){if(call&&number){var profileError;if(!service.isVMDeflectCallAllowed)return(profileError=new Error("deflectCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError);if($log.info("[telephonyService] deflectCallToNumber "+call.contact.nameForLog),service.isSipWise())service.telephonyServiceSipWise.deflectCallSipWise(service,call,number).then((function(){resolve()}),(function(error){reject(error)}));else(profileError=new Error("deflectCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),reject(profileError)}else resolve(call)}))},service.transfertCall=function(activeCall,heldCall){return $q((function(resolve,reject){if(activeCall&&heldCall){if(!service.isTransferAllowed){var profileError=new Error("transferCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if($log.info("[telephonyService] transfertCall held("+heldCall.contact.displayName+") to active("+activeCall.contact.displayName+")"),service.isSipWise())return service.telephonyServiceSipWise.transfertCallSipWise(service,activeCall,heldCall);$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(activeCall.connectionId)+"/transfer/"+encodeURIComponent(heldCall.connectionId),headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(){$log.info("[telephonyService] transferCall success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"transfertCall"))}))}else resolve()}))},service.blindTransfertCall=function(activeCall,calleNumber){return $q((function(resolve,reject){if(activeCall&&calleNumber){var profileError;if(!service.isTransferAllowed||!service.isSipWise())return(profileError=new Error("blind transfertCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError);if("demo"===service.sipWiseMode())return service.telephonyServiceSipWise.blindTransfertCallSipWise(service,activeCall,calleNumber);$log.info("[telephonyService]  blind Transfert sipWise not implemented"),(profileError=new Error("blind transferCall failure - Not Allowed")).status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),reject(profileError)}else resolve()}))},service.conferenceCall=function(activeCall,heldCall){return $q((function(resolve,reject){if(activeCall&&heldCall){if(!service.isConferenceAllowed){var profileError=new Error("conferenceCall failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if($log.info("TELAPI [telephonyService] conferenceCall "+activeCall.connectionId+" ("+activeCall.contact.displayName+") and "+heldCall.connectionId+" ("+heldCall.contact.displayName+")"),service.isSipWise())return service.telephonyServiceSipWise.conferenceCallSipWise(service,activeCall,heldCall);$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(activeCall.connectionId)+"/conference/"+encodeURIComponent(heldCall.connectionId),headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(){$log.info("[telephonyService] conferenceCall success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"conferenceCall"))}))}else resolve()}))},service.sipWiseForwardToDevice=function(phoneNumber,destType,forwardType){return $q((function(resolve,reject){if($log.info("[telephonyService] sipWiseforwardToDevice : "+phoneNumber+" / destType = "+destType+" / fwType = "+forwardType),!service.isForwardEnabled){var profileError=new Error("sipWiseforwardToDevice failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePro===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phoneProCan===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePbx===phoneNumber){var errorMessage="sipWiseforwardToDevice failure: impossible to forward its own phone number";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}if(!phoneNumber||!forwardType||""===forwardType||!destType||""===destType){errorMessage="sipWiseforwardToDevice failure: bad parameters";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}if(!service.isSipWise()){errorMessage="sipWiseforwardToDevice not implemented if not sipWise case";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}service.telephonyServiceSipWise.forwardToDeviceSipWise(service,phoneNumber,destType,forwardType).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToDevice"))}))}))},service.sipWiseCancelForward=function(forwardType){return $q((function(resolve,reject){if($log.info("[telephonyService] sipWiseCancelForward :  fwType = "+forwardType),!service.isForwardEnabled){var profileError=new Error("cancelForward failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(!service.isSipWise()){var errorMessage="sipWiseCancelForward not implemented if not sipWise case";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}service.telephonyServiceSipWise.cancelForwardSipWise(service,forwardType).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"sipWiseCancelForward"))}))}))},service.forwardToDevice=function(phoneNumber){return $q((function(resolve,reject){if($log.info("[telephonyService] forwardToDevice : "+phoneNumber),!service.isForwardEnabled){var profileError=new Error("forwardToDevice failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePro===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phoneProCan===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePbx===phoneNumber){var errorMessage="forwardToDevice failure: impossible to forward its own phone number";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}service.isSipWise()?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getOrCreateContact(null,phoneNumber).then((function(contact){var phoneInfo=service.getPhoneInfo(contact,phoneNumber),destType="externalNumber";if(""!==phoneInfo.longNumber){destType="externalNumber";phoneNumber=phoneInfo.longNumber}else{destType="internalNumber";phoneNumber=phoneInfo.shortNumber}service.telephonyServiceSipWise.forwardToDeviceSipWise(service,phoneNumber,destType,"immediate").then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToDevice"))}))})):_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getOrCreateContact(null,phoneNumber).then((function(contact){var phoneInfo=service.getPhoneInfo(contact,phoneNumber);$http({method:"PUT",url:service.portalURL+"forward",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{calleeExtNumber:phoneInfo.longNumber,calleeIntNumber:phoneInfo.internalNumber,calleeShortNumber:phoneInfo.shortNumber,calleePbxId:phoneInfo.pbxId,calleeDisplayName:contact.displayName}}).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToDevice"))}))}))}))},service.forwardToVoicemail=function(callForwardType){return $q((function(resolve,reject){if($log.info("[telephonyService] forwardToVoicemail"),!service.voiceMailFeatureEnabled||!service.isForwardEnabled){var profileError=new Error("forwardToVoicemail failure - voicemail/forward feature not enabled");return profileError.status=profileError.errorDetailsCode="404",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(service.isSipWise()){var forwardType=callForwardType||"immediate";service.telephonyServiceSipWise.forwardToDeviceSipWise(service,service.voicemailNumber,"voicemail",forwardType).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToVoicemail"))}))}else $http({method:"PUT",url:service.portalURL+"forward",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:service.voicemailNumber,calleePbxId:service.pbxId}}).then((function(){$log.info("[telephonyService] forwardToVoicemail success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"forwardToVoicemail"))}))}))},service.cancelForward=function(){return $q((function(resolve,reject){if($log.info("[telephonyService] cancelForward"),!service.isForwardEnabled){var profileError=new Error("cancelForward failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(service.isSipWise()){service.telephonyServiceSipWise.cancelForwardSipWise(service,"immediate").then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"cancelForward"))}))}else _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePbx?$http({method:"PUT",url:service.portalURL+"forward",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{calleeExtNumber:"",calleeIntNumber:"CANCELFORWARD",calleePbxId:service.pbxId}}).then((function(){$log.info("[telephonyService] cancelForward success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"cancelForward"))})):reject()}))},service.getForwardStatus=function(){return $q((function(resolve,reject){if(!service.isForwardEnabled){var profileError=new Error("getForwardStatus failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(service.starting||service.started){if(service.isSipWise())return void service.telephonyServiceSipWise.getForwardStatusSipWise(service).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"getForwardStatus"))}));$http({method:"GET",url:service.portalURL+"forward",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(){$log.info("[telephonyService] getForwardStatus success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"getForwardStatus"))}))}else reject(new Error("getForwardStatus failure - Telephony not started"))}))},service.getForwardObject=function(){return service.forwardObject},service.isOverFlowStatusActivated=function(){return $q((function(resolve,reject){service.isSipWise()?service.telephonyServiceSipWise.getOverFlowStatusSipWise(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.systemId,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phoneNumberId).then((function(response){resolve(response.activate)}),(function(error){reject(error)})):resolve(!1)}))},service.nomadicLogin=function(phoneNumber,isUnchangeableNumber,NotTakeIntoAccount){return $q((function(resolve,reject){if(!service.isNomadicEnabled||!service.nomadicObject.featureActivated){var profileError=new Error("nomadicLogin failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePro===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phoneProCan===phoneNumber||_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.phonePbx===phoneNumber){var errorMessage="nomadicLogin failure: impossible to use its own phone number like nomadic phone";return $log.error("[telephonyService] "+errorMessage),void reject(new Error(errorMessage))}$log.info("[telephonyService] nomadicLogin : "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(phoneNumber)),NotTakeIntoAccount=NotTakeIntoAccount||!1,isUnchangeableNumber=isUnchangeableNumber||!1,service.nomadicAnswerNotTakedIntoAccount=NotTakeIntoAccount,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getOrCreateContact(null,phoneNumber).then((function(contact){var phoneInfo=service.getPhoneInfo(contact,phoneNumber);$http({method:"PUT",url:service.portalURL+"nomadic/login",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{destinationExtNumber:phoneInfo.longNumber,destinationIntNumber:phoneInfo.internalNumber,destinationShortNumber:phoneInfo.shortNumber,destinationRainbowNumber:isUnchangeableNumber?phoneNumber:"",destinationPbxId:phoneInfo.pbxId,destinationDisplayName:contact.displayName,destinationCountry:contact.country}}).then((function(){$log.info("[telephonyService] nomadicLogin success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"nomadicLogin"))}))}))}))},service.nomadicLoginOnOfficePhone=function(){return $q((function(resolve,reject){if(!service.isNomadicEnabled||!service.nomadicObject.featureActivated){var profileError=new Error("nomadicLoginOnOfficePhone failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}$log.info("[telephonyService] nomadicLoginOnOfficePhone"),$http({method:"PUT",url:service.portalURL+"nomadic/login",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(){$log.info("[telephonyService] nomadicLoginOnOfficePhone success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"nomadicLoginOnOfficePhone"))}))}))},service.nomadicLogout=function(){return $q((function(resolve,reject){if(!service.isNomadicEnabled||!service.nomadicObject.featureActivated){var profileError=new Error("nomadicLogout failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}$log.info("[telephonyService] nomadicLogout"),$http({method:"PUT",url:service.portalURL+"nomadic/logout",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(){$log.info("[telephonyService] nomadicLogout success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"nomadicLogout"))}))}))},service.getNomadicStatus=function(){return $q((function(resolve,reject){if(service.isSipWise()){$log.info("[telephonyService] getNomadicStatus -- SipWise bypass Nomadic");resolve()}else{if(!service.isNomadicEnabled){var profileError=new Error("getNomadicStatus failure - Not Allowed");return profileError.status=profileError.errorDetailsCode="403",$log.error("[telephonyService] "+profileError.message),void reject(profileError)}service.starting||service.started?$http({method:"GET",url:service.portalURL+"nomadic",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader()}).then((function(response){$log.info("[telephonyService] getNomadicStatus success"),service.updateNomadicData(response.data.data),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"getNomadicStatus"))})):reject(new Error("getNomadicStatus failure - Telephony not started"))}}))},service.setNomadicState=function(){return $q((function(resolve,reject){$log.info("[telephonyService] setNomadicState"),$http({method:"PUT",url:service.portalURL+"nomadic/state",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{makeCallInitiatorIsMain:"true"}}).then((function(){$log.info("[telephonyService] setNomadicState success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"setNomadicState"))}))}))},service.updateNomadicData=function(response){var destination=response.destination?_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_6___default()(response.destination):"";$log.info("[telephonyService] updateNomadicData destination: "+destination+" featureActivated: "+response.featureActivated+" makeCallInitiatorIsMain: "+response.makeCallInitiatorIsMain+" modeActivated: "+response.modeActivated+" monodevice: "+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.isVirtualTerm+" NomadicInitialized: "+response.nomadicModeInitialized);var nomadicObjectOrg=JSON.parse(JSON.stringify(service.nomadicObject));service.nomadicObject.featureActivated="true"===response.featureActivated,service.nomadicObject.modeActivated="true"===response.modeActivated,service.nomadicObject.destination=response.destination,service.nomadicObject.makeCallInitiatorIsMain="true"===response.makeCallInitiatorIsMain,void 0===response.nomadicModeInitialized?service.nomadicObject.nomadicModeInitialized=!0:service.nomadicObject.nomadicModeInitialized="true"===response.nomadicModeInitialized;var makeCallInitiatorIsMainChanged=nomadicObjectOrg.makeCallInitiatorIsMain!==service.nomadicObject.makeCallInitiatorIsMain;service.nomadicAnswerNotTakedIntoAccount||$rootScope.$broadcast("ON_CALL_NOMADIC_EVENT",service.nomadicObject),service.nomadicAnswerNotTakedIntoAccount=!1;var webrtcGatewayService=$injector.get("webrtcGatewayService");if(!service.nomadicObject.featureActivated||service.nomadicObject.nomadicModeInitialized||""!==service.nomadicObject.destination&&void 0!==service.nomadicObject.destination||!webrtcGatewayService.isMediaPillarConfigured())if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.isVirtualTerm||!service.nomadicObject.featureActivated||service.nomadicObject.nomadicModeInitialized||""!==service.nomadicObject.destination&&void 0!==service.nomadicObject.destination||!_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobileProCan&&!_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobilePerso)if(!_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.isVirtualTerm||!service.nomadicObject.featureActivated||service.nomadicObject.nomadicModeInitialized||""!==service.nomadicObject.destination&&void 0!==service.nomadicObject.destination||!_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobileProCan&&!_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobilePerso){if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.isVirtualTerm&&service.nomadicObject.featureActivated&&!service.nomadicObject.makeCallInitiatorIsMain&&!service.nomadicObject.modeActivated&&webrtcGatewayService.isMediaPillarConfigured()){defaultNumber=webrtcGatewayService.getMyMediaPillarRemoteExtension();service.nomadicLogin(defaultNumber)}}else{defaultNumber=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobileProCan?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobileProCan:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobilePerso;service.nomadicLogin(defaultNumber)}else{var defaultNumber=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobileProCan?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobileProCan:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.mobilePerso;service.nomadicLogin(defaultNumber,!1,!0).then((function(){service.nomadicLoginOnOfficePhone()}))}else{var defaultNumber=webrtcGatewayService.getMyMediaPillarRemoteExtension();service.nomadicLogin(defaultNumber)}return makeCallInitiatorIsMainChanged},service.getNomadicObject=function(){return service.nomadicObject},service.getNomadicDestination=function(){return service.nomadicObject.destination},service.sendDtmf=function(call,dtmf){return $q((function(resolve,reject){if(call&&dtmf){if($log.info("[telephonyService] sendDtmf for call "+call.id),service.isSipWise())return void service.telephonyServiceSipWise.sendDtmfSipWise(service,call,dtmf).then((function(){resolve()}),(function(error){reject(error)}));$http({method:"PUT",url:service.portalURL+"calls/"+encodeURIComponent(call.connectionId)+"/dtmf",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:{dtmf:dtmf}}).then((function(){$log.info("[telephonyService] sendDtmf success"),$rootScope.$broadcast("ON_DTMF_SENT",dtmf),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[telephonyService] "+errorHelperService.getErrorFullMessage(response,"sendDtmf"))}))}else reject()}))},service.clearCall=function(call,nobroadcast){if(call)$log.info("[telephonyService] clearCall for call id: "+call.id),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_1__.Call.Status.UNKNOWN),nobroadcast||(call.publish("ON_CALL_UPDATED_EVENT"),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),call.contact&&delete service.calls[call.contact.id],call.getCurrentCalled()&&call.setCurrentCalled(null);else{$log.error("[telephonyService]clearCall failure : call null")}},service.startAsPhoneNumber=function(phoneNumber){var cleanPhoneNumber=phoneNumber.trim().split(".").join("");if(cleanPhoneNumber.length<2)return!1;var match=cleanPhoneNumber.match(/^(\+|\d|#|\*|\(|\)|\.|-|||\s|\/)*$/);return!!match&&match[0]===cleanPhoneNumber},service.updateContactFromOutlookInfos=function(__contact,__phoneNumber,__reload,__mode){return $log.info("[telephonyService] default updateContactFromOutlookInfos"),$q.reject()},service.isSipWiseRoot=function(){return"RVCP Subscriber"===_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.systDeviceName},service.setSipWise=function(condition){sipWise=condition},service.isSipWise=function(){return sipWise},service.getSipWiseDevicesList=function(){return service.isSipWise()?service.telephonyServiceSipWise.getDevicesListSipWise():($log.info("[telephonyService] Anomaly not a sipWise situation"),NULL)},service.getSipWiseDevicesListCurrent=function(){$log.info("[telephonyService] getSipWiseDevicesListCurrent"),service.isSipWise()?service.telephonyServiceSipWise.getUserRoutingInfo(service):$log.info("[telephonyService] getSipWiseDevicesListCurrent Anomaly not a sipWise situation")},service.setSipWiseDevicesCurrent=function(currentDeviceId){service.isSipWise()?service.telephonyServiceSipWise.putUserRoutingInfo(service,currentDeviceId):$log.info("[telephonyService] setSipWiseDevicesMain Anomaly not a sipWise situation")},service.sipWiseUserGroupsDataClear=function(){service.sipWiseUserGroupsData.huntingGroupNb=0,service.sipWiseUserGroupsData.managerAssistantNb=0,service.sipWiseUserGroupsData.managerAssistGrId=0,service.sipWiseUserGroupsData.managerId=0,service.sipWiseUserGroupsData.managerName="",service.sipWiseUserGroupsData.managerStatus="",service.sipWiseUserGroupsData.managerForward="unknow",service.sipWiseUserGroupsData.assistantId=0,service.sipWiseUserGroupsData.assistantName="",service.sipWiseUserGroupsData.assistantStatus="",service.sipWiseUserGroupsData.sipWiseUserGroupsList=[]},service.sipWiseUserGroupsDataIsManagerAssistant=function(){return!!(service.isSipWise()&&service.sipWiseUserGroupsData.managerAssistantNb>0)&&(1===service.sipWiseUserGroupsData.managerAssistantNb||($log.info("[telephonyService] sipWiseUserGroupsDataIsManagerAssistant Anomaly not 1:1 Manager/Assistant"),!1))},service.sipWiseManAssistGetMyRole=function(){var myRole="";if(service.isSipWise()&&service.sipWiseUserGroupsData.managerAssistantNb>0){var foundGr=service.sipWiseUserGroupsData.sipWiseUserGroupsList.find((function(elt){return"manager_assistant"===elt.type}));if(foundGr){var me=foundGr.members.find((function(elt){return elt.displayName===_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.displayName}));me&&(myRole=me.roles[0])}}return myRole},service.sipWiseManAssistIamManagerForwarded=function(){var managerForward="unknown",result=!1;return service.isSipWise()&&1===service.sipWiseUserGroupsData.managerAssistantNb&&"manager"===service.sipWiseManAssistGetMyRole()&&(managerForward=service.sipWiseUserGroupsData.managerForward),"activated"===managerForward&&(result=!0),result},service.getSipWiseUserGroupsData=function(){return service.sipWiseUserGroupsData},service.getSipWiseUserGroups=function(){return $q((function(resolve,reject){if($log.info("[telephonyService] getSipWiseUserGroups"),!service.isSipWise()){return $log.error("[telephonyService] sipwise getUserGroups -- not a sipWise situation"),void reject()}service.telephonyServiceSipWise.getUserGroups(service).then((function(){return service.telephonyServiceSipWise.getAllUserGroupsForwards(service)})).then((function(){$rootScope.$broadcast("ON_TEL_USER_GROUPS_EVENT",service.sipWiseUserGroupsData),resolve()})).catch((function(error){$log.info("[telephonyService] sipwise getSipWiseUserGroups CATCH");var errorMessage="sipwise getUserGroups -- "+error.message;$log.error("[telephonyService] "+errorMessage),reject(error)}))}))},service.getSipWiseUserGroupsForwards=function(groupId){return $q((function(resolve,reject){if($log.info("[telephonyService] getSipWiseUserGroupsForwards"),!service.isSipWise()){return $log.error("[telephonyService] sipwise getUserGroupsForward -- not a sipWise situation"),void reject()}service.telephonyServiceSipWise.getUserGroupsForwards(service,groupId).then((function(){$rootScope.$broadcast("ON_TEL_USER_GROUPS_EVENT",service.sipWiseUserGroupsData),resolve()})).catch((function(error){$log.info("[telephonyService] sipwise getSipWiseUserGroupsForwards CATCH");var errorMessage="sipwise getUserGroupsForwards -- "+error.message;$log.error("[telephonyService] "+errorMessage),reject(error)}))}))},service.setSipWiseUserGroupsForwards=function(groupId,callForwardType,forwardData){return $q((function(resolve,reject){if($log.info("[telephonyService] setSipWiseUserGroupsForwards"),!service.isSipWise()){return $log.error("[telephonyService] sipwise setSipWiseUserGroupsForwards -- not a sipWise situation"),void reject()}service.telephonyServiceSipWise.setUserGroupsForwards(service,groupId,callForwardType,forwardData).then((function(){resolve()})).catch((function(error){$log.info("[telephonyService] setSipWiseUserGroupsForwards CATCH");var errorMessage="sipwise setSipWiseUserGroupsForwards -- "+error.message;$log.error("[telephonyService] "+errorMessage),reject(error)}))}))},service.sipWiseManAssistActivat=function(Activ,groupName){var groupNotFound=!0,groupId=0;if($log.info("[telephonyService] sipWiseManAssistActivat  Activ : "+Activ+" groupName : "+groupName),0!==service.sipWiseUserGroupsData.managerAssistantNb){if(groupName||(groupName=""),service.sipWiseUserGroupsData.sipWiseUserGroupsList.forEach((function(group){groupNotFound&&"manager_assistant"===group.type&&(groupName!==group.name&&""!==groupName||(groupId=group.id,groupNotFound=!1))})),!groupNotFound){var forwardData={destinationType:"managersecretary"};forwardData.activate=Activ,service.setSipWiseUserGroupsForwards(groupId,"immediate",forwardData)}}else{$log.error("[telephonyService] sipwise sipWiseManAssistActivat -- no Manager Assistant group available")}},service.sipWiseEmergencyCallDataClear=function(){if(!service.isSipWiseRoot()){return $log.error("[telephonyService] sipWiseEmergencyCallDataClear -- not a sipWise situation"),null}service.sipWiseEmergencyCallData.WGEmergencyCallForbidden=!1,service.sipWiseEmergencyCallData.emergencyNuList=[],service.sipWiseEmergencyCallData.serverData=null},service.getSipWiseEmergencyCallData=function(){if(!service.isSipWiseRoot()){return $log.error("[telephonyService] getSipWiseEmergencyCallData -- not a sipWise situation"),null}return service.sipWiseEmergencyCallData},service.fetchSipWiseEmergencyCallData=function(){return $q((function(resolve,reject){if($log.info("[telephonyService] fetchSipWiseEmergencyCallData"),!service.isSipWise()){return $log.error("[telephonyService] fetchSipWiseEmergencyCallData -- not a sipWise situation"),void reject()}service.telephonyServiceSipWise.getEmergencyCallDataSipWise(service).then((function(){resolve()})).catch((function(error){$log.info("[telephonyService] fetchSipWiseEmergencyCallData CATCH");var errorMessage="fetchSipWiseEmergencyCallData -- "+error.message;$log.error("[telephonyService] "+errorMessage),reject(error)}))}))},service.sipWiseMode=function(){var mode=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_2___default.a.getSetting("sipWiseMode");return sipWise||(mode=!1),mode},service.resetAllSipWiseCall=function(){if(service.isSipWise()){var iq=$iq({type:"set",to:service.userJidTel+"/pcg2"}).c("telephony",{xmlns:"urn:xmpp:pbxagent:telephony:1"}).c("service").c("deleteCalls",{forced:"true"});_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_4___default.a.sendIQ(iq,6e4).then((function(data){$log.info("[telephonyService] resetAllSipWiseCall : try to reset all ghost calls !"),console.error(data)})).catch((function(error){var errorMessage="resetAllSipWiseCall failure : "+error.message;$log.error("[telephonyService]"+errorMessage)}))}},service.logonCCD=function(endpointTel,agentId,password,groupId){return new Promise((function(resolve,reject){if(!endpointTel)return $log.error("[telephonyService] logonCCD : bad or empty 'endpointTel' parameter"),reject("[telephonyService] logonCCD : bad or empty 'endpointTel' parameter");var reqData={endpointTel:endpointTel,agentId:agentId,password:password,groupId:groupId};$http({method:"POST",url:service.portalURL+"/ccd/logon",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] logonCCD : success"),resolve(response)}),(function(response){var error=errorHelperService.handleError(response);return $log.error("[telephonyService] logonCCD : error"),reject(error)}))}))},service.logoffCCD=function(endpointTel,agentId,password,groupId){return new Promise((function(resolve,reject){if(!endpointTel)return $log.error("[telephonyService] logoffCCD : bad or empty 'endpointTel' parameter"),reject("[telephonyService] logoffCCD : bad or empty 'endpointTel' parameter");var reqData={endpointTel:endpointTel,agentId:agentId,password:password,groupId:groupId};$http({method:"POST",url:service.portalURL+"/ccd/logoff",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] logoffCCD : success"),resolve(response)}),(function(response){var error=errorHelperService.handleError(response);return $log.error("[telephonyService] logoffCCD : error"),reject(error)}))}))},service.withdrawalCCD=function(agentId,groupId,status){return new Promise((function(resolve,reject){var reqData={agentId:agentId,groupId:groupId,status:status};$http({method:"POST",url:service.portalURL+"/ccd/withdrawal",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] withdrawalCCD : success"),resolve(response)}),(function(response){var error=errorHelperService.handleError(response);return $log.error("[telephonyService] withdrawalCCD : error"),reject(error)}))}))},service.wrapupCCD=function(agentId,groupId,password,status){return new Promise((function(resolve,reject){var reqData={agentId:agentId,groupId:groupId,password:password,status:status};$http({method:"POST",url:service.portalURL+"/ccd/wrapup",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] wrapupCCD : success"),resolve(response)}),(function(response){var error=errorHelperService.handleError(response);return $log.error("[telephonyService] wrapupCCD : error"),reject(error)}))}))},service.oxopbxsUpdateIndividualPassword=function(newPassword){var url=config.restServerUrl+"/api/rainbow/oxopbxprovisioning/v1.0/oxopbxs/"+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.systemId+"/subscribers/"+_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.dbId+"/password";return new Promise((function(resolve,reject){var reqData={password:newPassword};$http({method:"PUT",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_3___default.a.getRequestHeader(),data:reqData}).then((function(response){$log.info("[telephonyService] oxopbxsUpdateIndividualPassword : success"),resolve(response)}),(function(response){var error=errorHelperService.handleError(response);return $log.error("[telephonyService] oxopbxsUpdateIndividualPassword : error : "+response.data.errorDetails),reject(error)}))}))},service.setPgiCallObject=function(numberCalled,dtmfToSend,roomJid,callId){service.currentPgiObject={numberCalled:numberCalled,dtmfToSend:dtmfToSend,roomJid:roomJid,callId:callId}}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_src_utils_promiseQueue__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(49),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2__),_src_models_contact_model__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(43),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(14),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5__),_src_services_pgiConference_pgiConference_service__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(57),_src_services_pgiConference_pgiConference_service__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(_src_services_pgiConference_pgiConference_service__WEBPACK_IMPORTED_MODULE_6__);angular.module("rainbow").factory("TelephonyServiceEventHandler",["$log","$q","$rootScope","$interval","$injector",function($log,$q,$rootScope,$interval,$injector){function TelephonyServiceEventHandler(telephonyService){this.telephonyService=telephonyService,this.promiseQueue=_src_utils_promiseQueue__WEBPACK_IMPORTED_MODULE_1__.PromiseQueue.create()}return TelephonyServiceEventHandler.create=function(telephonyService){return new TelephonyServiceEventHandler(telephonyService)},TelephonyServiceEventHandler.CallFailureLabels={DESTNOTOBTAINABLE:"outOfService",DONOTDISTURB:"dnd",TRUNKSBUSY:"trunksbusy",BUSY:"busy"},TelephonyServiceEventHandler.prototype.existingCall=function(callId){var exist=this.telephonyService.calls[callId];return $log.debug("[TelephonyServiceEventHandler] existingCall -- "+callId+" => "+exist),exist},TelephonyServiceEventHandler.prototype.onCallserviceMessageReceived=function(stanza){try{var stanzaElem=$(stanza),that=this;if("Offline Storage"===stanzaElem.find("delay").text())return!0;var actionElem=stanzaElem.find("callservice").children(),tagNames=actionElem.prop("tagName").split(":"),actionElemName=tagNames[tagNames.length-1].toLowerCase(),callId=actionElem.attr("callId"),callIdForLogs=callId?" -- "+callId:"",evtDeviceType=actionElem.attr("deviceType"),displayDeviceType=evtDeviceType?" -- "+evtDeviceType:"",oldCallId=actionElem.attr("oldCallId");oldCallId=oldCallId?" -- old "+oldCallId:"";actionElem.attr("correlatorData");var globalCallId=actionElem.attr("globalCallId");globalCallId&&(globalCallId=globalCallId),evtDeviceType||(evtDeviceType="MAIN");var cfgNomadic=this.telephonyService.getNomadicObject(),cfgOfficePhone=!cfgNomadic||(cfgNomadic.makeCallInitiatorIsMain||!cfgNomadic.modeActivated);if(!["messaging","voicemessages","forwarded","nomadicstatus","opendesktop"].includes(actionElemName)&&("MAIN"===evtDeviceType&&!cfgOfficePhone||"SECONDARY"===evtDeviceType&&cfgOfficePhone)&&!that.existingCall(callId))return $log.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+actionElemName.toUpperCase()+callIdForLogs+oldCallId+displayDeviceType+" => IGNORED"),!0;switch($log.info("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- "+actionElemName.toUpperCase()+callIdForLogs+oldCallId+displayDeviceType),actionElemName){case"initiated":this.promiseQueue.add((function(){return that.onInitiatedEvent(actionElem)}));break;case"originated":this.promiseQueue.add((function(){return that.onOriginatedEvent(actionElem)}));break;case"delivered":this.promiseQueue.add((function(){return that.onDeliveredEvent(actionElem)}));break;case"established":this.promiseQueue.add((function(){return that.onEstablishedEvent(actionElem)}));break;case"retrievecall":this.promiseQueue.add((function(){return that.onRetrieveCallEvent(actionElem)}));break;case"queued":this.promiseQueue.add((function(){return that.onQueuedEvent(actionElem)}));break;case"holdcall":case"held":this.promiseQueue.add((function(){return that.onHeldEvent(actionElem)}));break;case"diverted":this.promiseQueue.add((function(){return that.onDivertedEvent(actionElem)}));break;case"transfercall":case"transferred":this.promiseQueue.add((function(){return that.onTransferEvent(actionElem)}));break;case"conferenced":this.promiseQueue.add((function(){return that.onConferenceEvent(actionElem)}));break;case"connectioncleared":this.promiseQueue.add((function(){return that.onClearCallEvent(actionElem)}));break;case"failed":this.promiseQueue.add((function(){return that.onFailCallEvent(actionElem)}));break;case"updatecall":this.promiseQueue.add((function(){return that.onUpDateCallEvent(actionElem)}));break;case"forwarded":this.promiseQueue.add((function(){return that.onCallForwardedEvent(actionElem)}));break;case"callsubject":this.promiseQueue.add((function(){return that.onCallSubjectEvent(actionElem)}));break;case"nomadicstatus":this.promiseQueue.add((function(){return that.onCallNomadicEvent(actionElem)}));break;case"opendesktop":$log.info("[TelephonyServiceEventHandler] openDesktop detected ")}return!0}catch(error){return $log.error("[TelephonyServiceEventHandler] onCallserviceMessageReceived -- failure -- "+error.message),!0}},TelephonyServiceEventHandler.prototype.onInitiatedEvent=function(initiatedElem){$log.info("[TelephonyServiceEventHandler] onInitiatedEvent");var that=this;return this.getCall(initiatedElem,!1,!0).then((function(call){try{var deviceState=initiatedElem.attr("deviceState"),newConnectionId=initiatedElem.attr("newCallId"),cause=initiatedElem.attr("cause");return void 0!==newConnectionId?that.getOrCreateCall(newConnectionId).then((function(newCall){$log.info("[TelephonyServiceEventHandler] onInitiatedEvent : changed call id from "+call.id+" to "+newConnectionId),that.computeCallRelevancy(initiatedElem,newCall),"LCI_CONNECTED"===deviceState?newCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE):newCall.setStatus(call.status),newCall.setContact(call.contact),newCall.isOwner=call.isOwner;var confSession=_src_services_pgiConference_pgiConference_service__WEBPACK_IMPORTED_MODULE_6___default.a.getConferenceSessionWithConnId(call.connectionId);(confSession&&(confSession.callId=newConnectionId),call.isMediaPillarCall())&&$injector.get("webrtcGatewayService").replaceCallRefs(newCall,call);that.telephonyService.clearCall(call),that.sendCallUpdateEvent(call),that.sendCallUpdateEvent(newCall),delete that.telephonyService.calls[call.id]})):(that.computeCallRelevancy(initiatedElem,call),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2___default.a.FeaturesEnum.TELEPHONY_MAKE_CALL_CTI_APP)&&call.isSecondary&&!call.isOwner&&"MAKECALL"===cause||"CALLBACK"===cause?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact("","000").then((function(contact){call.setContact(contact),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),call.startDate=null,call.vm=!1,call.lastCause=cause||"",that.sendCallUpdateEvent(call,initiatedElem)})):that.sendCallUpdateEvent(call)),$q.when()}catch(error){var errorMessage="onInitiatedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onOriginatedEvent=function(originatedElem){$log.info("[TelephonyServiceEventHandler] onOriginatedEvent");var that=this;return this.getCall(originatedElem,!1,!0).then((function(call){try{var jid=originatedElem.attr("endpointIm"),phoneNumber=originatedElem.attr("endpointTel"),newConnectionId=originatedElem.attr("newCallId"),currentCalled={contactPhoneNumber:"",contact:call.contact,participantsPhoneNumbers:null,participants:null};return jid||phoneNumber?currentCalled.contactPhoneNumber=phoneNumber||"":call.contact&&call.contact.temp&&(currentCalled.contactPhoneNumber=call.contact.id),call.setCurrentCalled(currentCalled),void 0!==newConnectionId?that.getOrCreateCall(newConnectionId,jid,phoneNumber).then((function(newCall){$log.info("[TelephonyServiceEventHandler] onOriginatedEvent : changed call id from "+call.id+" to "+newConnectionId),that.computeCallRelevancy(originatedElem,newCall),newCall.setStatus(call.status),newCall.setContact(call.contact),newCall.setCurrentCalled(currentCalled),newCall.isOwner=call.isOwner;var confSession=_src_services_pgiConference_pgiConference_service__WEBPACK_IMPORTED_MODULE_6___default.a.getConferenceSessionWithConnId(call.connectionId);(confSession&&(confSession.callId=newConnectionId),call.isMediaPillarCall())&&$injector.get("webrtcGatewayService").replaceCallRefs(newCall,call);that.telephonyService.clearCall(call),that.sendCallUpdateEvent(call),that.sendCallUpdateEvent(newCall),delete that.telephonyService.calls[call.id]})):that.sendCallUpdateEvent(call),$q.when()}catch(error){var errorMessage="onOriginatedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onDeliveredEvent=function(deliveredElem){$log.info("[TelephonyServiceEventHandler] onDeliveredEvent");var that=this;return this.getCall(deliveredElem).then((function(call){try{if(that.computeCallRelevancy(deliveredElem,call),call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING)return $q.resolve();var type=deliveredElem.attr("type"),jid=deliveredElem.attr("endpointIm"),phoneNumber=deliveredElem.attr("endpointTel"),cause=deliveredElem.attr("cause"),correlatorData=deliveredElem.attr("correlatorData")?deliveredElem.attr("correlatorData"):"",globalCallId=deliveredElem.attr("globalCallId")?deliveredElem.attr("globalCallId"):"";return call.setStatus("outgoing"===type?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_OUTGOING:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),call.startDate=null,call.vm=!1,call.lastCause=cause||"",call.correlatorData=correlatorData,call.globalCallId=globalCallId,that.updateCallContact(jid,phoneNumber,deliveredElem,call)}catch(error){var errorMessage="onDeliveredEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onEstablishedEvent=function(establishedElem){$log.info("[TelephonyServiceEventHandler] onEstablishedEvent");var that=this;return this.getCall(establishedElem).then((function(call){try{that.computeCallRelevancy(establishedElem,call);var jid=establishedElem.attr("endpointIm"),phoneNumber=establishedElem.attr("endpointTel"),connectionId=establishedElem.attr("callId");if(call.contact&&call.contact.id)return call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),call.setConnectionId(connectionId),that.sendCallUpdateEvent(call,establishedElem),that.updateCallContact(jid,phoneNumber,establishedElem,call);if(!(call.participants&&call.participants.length>0))return $log.info("[TelephonyServiceEventHandler] onEstablishedEvent, no call contact / no participants"),jid||phoneNumber||(phoneNumber="****"),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){return call.setContact(contact),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),currentCalled={contactPhoneNumber:phoneNumber,contact:contact},call.setCurrentCalled(currentCalled),that.sendCallUpdateEvent(call,establishedElem),$q.when()}));for(var contactRecovered=null,i=0;i<call.participants.length&&!contactRecovered;i++)(call.participants[i].id===jid||call.currentCalled.participantsPhoneNumbers&&call.currentCalled.participantsPhoneNumbers.length>0&&call.currentCalled.participantsPhoneNumbers[i]===phoneNumber)&&(contactRecovered=call.participants[i]);call.participants=[],call.isConference=!1;var currentCalled=call.getCurrentCalled();return contactRecovered?(call.setContact(contactRecovered),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),currentCalled={contactPhoneNumber:phoneNumber,contact:contactRecovered},call.setCurrentCalled(currentCalled),that.sendCallUpdateEvent(call,establishedElem),$q.when()):(jid||phoneNumber||(phoneNumber="****"),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){return call.setContact(contact),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),currentCalled={contactPhoneNumber:phoneNumber,contact:contact},call.setCurrentCalled(currentCalled),that.sendCallUpdateEvent(call,establishedElem),$q.when()})))}catch(error){var errorMessage="onEstablishedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onRetrieveCallEvent=function(retrieveElem){$log.info("[TelephonyServiceEventHandler] onRetrieveCallEvent");var that=this;return this.getCall(retrieveElem,!0).then((function(call){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),that.sendCallUpdateEvent(call,retrieveElem)}))},TelephonyServiceEventHandler.prototype.onClearCallEvent=function(clearElem){var that=this,connectionId=clearElem.attr("callId"),callId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(connectionId);return $log.info("[TelephonyServiceEventHandler] onClearCallEvent, connectionId: "+connectionId),this.telephonyService.calls[callId]?this.getCall(clearElem).then((function(call){that.computeCallRelevancy(clearElem,call),that.telephonyService.clearCall(call,!0),that.sendCallUpdateEvent(call,clearElem)})):($log.info("[TelephonyServiceEventHandler] onClearCallEvent, no call for connectionId: "+connectionId),$q.resolve())},TelephonyServiceEventHandler.prototype.onHeldEvent=function(heldElem){$log.info("[TelephonyServiceEventHandler] onHeldEvent");var that=this;return this.getCall(heldElem,!0).then((function(call){try{var connectionId=heldElem.attr("callId");return _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(call.connectionId)===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(connectionId)?call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.HOLD):call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.PUT_ON_HOLD),that.sendCallUpdateEvent(call,heldElem),$q.when()}catch(error){var errorMessage="onHeldEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onQueuedEvent=function(queuedElem){$log.info("[TelephonyServiceEventHandler] onQueuedEvent");var that=this,cause=queuedElem.attr("cause");return"PARK"===cause?($log.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore PARK cause"),$q.when()):"NEWCALL"===cause?($log.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore NEWCALL cause"),$q.when()):"CAMPON"!==cause&&this.telephonyService.isOxe?($log.warn("[TelephonyServiceEventHandler] onQueuedEvent - ignore cause not CAMPON  (for oxe attendant res monoLine)"),$q.when()):this.getCall(queuedElem).then((function(call){try{that.computeCallRelevancy(queuedElem,call);var type=queuedElem.attr("type"),jid=queuedElem.attr("endpointIm"),phoneNumber=queuedElem.attr("endpointTel"),status="outgoing"===type?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_OUTGOING:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.QUEUED_INCOMMING;return call.setStatus(status),call.startDate=null,call.vm=!1,call.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(call.connectionId),that.updateCallContact(jid,phoneNumber,queuedElem,call)}catch(error){var errorMessage="onQueuedEvent -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.onDivertedEvent=function(divertedElem){$log.info("[TelephonyServiceEventHandler] onDivertedEvent");var oldConnectionId=divertedElem.attr("oldCallId"),oldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(oldConnectionId),call=this.telephonyService.calls[oldCallId];return call?(this.computeCallRelevancy(divertedElem,call),$injector.get("webrtcGatewayService").isMediaPillarCallCase()?call.isSecondary?this.telephonyService.clearCall(call):this.telephonyService.clearCall(call,!0):this.telephonyService.clearCall(call),this.sendCallUpdateEvent(call,divertedElem),$q.when()):($log.warn("[TelephonyServiceEventHandler] onDivertedEvent - receive divertedEvent on unknown call --- ignored"),$q.when())},TelephonyServiceEventHandler.prototype.onTransferEvent=function(transferElem){$log.info("[TelephonyServiceEventHandler] onTransferEvent");var that=this,activeConnectionId=transferElem.attr("activeCallId"),heldConnectionId=transferElem.attr("heldCallId"),newConnectionId=transferElem.attr("newCallId"),activeCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(activeConnectionId),activeCall=this.telephonyService.calls[activeCallId];if(heldConnectionId){var heldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(heldConnectionId),heldCall=this.telephonyService.calls[heldCallId];heldCall&&heldCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),activeCall&&activeCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),heldCall&&that.sendCallUpdateEvent(heldCall),activeCall&&that.sendCallUpdateEvent(activeCall)}if(newConnectionId){var jid=transferElem.attr("newEndpointIm"),phoneNumber=transferElem.attr("newEndpointTel"),deviceState=transferElem.attr("deviceState");deviceState||(deviceState=transferElem.attr("deviceStatus"));var deviceType=transferElem.attr("deviceType");return deviceType||(deviceType="MAIN"),activeCall&&(activeCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),that.sendCallUpdateEvent(activeCall)),jid||phoneNumber||(phoneNumber="****"),this.getOrCreateCall(newConnectionId,jid,phoneNumber).then((function(newCall){return deviceState&&"LCI_ALERTING"===deviceState?newCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING):newCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),newCall.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(newConnectionId),newCall.isSecondary=deviceType&&"SECONDARY"===deviceType,that.updateCallContact(jid,phoneNumber,transferElem,newCall)}))}return $q.resolve()},TelephonyServiceEventHandler.prototype.onConferenceEvent=function(conferencedElem){$log.info("[TelephonyServiceEventHandler] onConferenceEvent");var that=this,primaryOldConnectionId=conferencedElem.find("primaryOldCallId").text(),secondaryOldConnectionId=conferencedElem.find("secondaryOldCallId").text(),newConnectionId=conferencedElem.find("newCallId").text(),primaryOldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(primaryOldConnectionId),secondaryOldCallId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getIdFromConnectionId(secondaryOldConnectionId),primaryOldCall=this.telephonyService.calls[primaryOldCallId],secondaryOldCall=this.telephonyService.calls[secondaryOldCallId],confParticipants=[],participantPromises=[],confParticipantsPhoneNumbers=[];return conferencedElem.find("participant").each((function(){var participantElem=angular.element(this),endpointTel=participantElem.find("endpointTel").text(),endpointIm=participantElem.find("endpointIm").text();endpointIm&&_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.isUserContactJid(endpointIm)||participantPromises.push($q((function(resolve,reject){endpointIm||endpointTel||(endpointTel="****"),!endpointIm&&primaryOldCall&&primaryOldCall.contact&&primaryOldCall.currentCalled.contactPhoneNumber===endpointTel?(confParticipants.push(primaryOldCall.contact),confParticipantsPhoneNumbers.push(endpointTel),resolve()):!endpointIm&&secondaryOldCall&&secondaryOldCall.contact&&secondaryOldCall.currentCalled.contactPhoneNumber===endpointTel?(confParticipants.push(secondaryOldCall.contact),confParticipantsPhoneNumbers.push(endpointTel),resolve()):_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(endpointIm,endpointTel).then((function(contact){confParticipants.push(contact),confParticipantsPhoneNumbers.push(endpointTel),that.telephonyService.updateContactFromOutlookInfos(contact,endpointTel).then((function(updateStatus){updateStatus?$log.debug("[TelephonyServiceEventHandler] on conferenced, update from outlook for contact :"+contact.nameForLog):$log.debug("[TelephonyServiceEventHandler] on conferenced, no update from outlook for contact :"+contact.nameForLog)}),(function(){$log.debug("[TelephonyServiceEventHandler] on conferenced, no Outlook search available")})).finally((function(){resolve()}))})).catch((function(error){$log.error("[TelephonyServiceEventHandler] onConferenceEvent - Impossible to get contact - "+error.message),resolve()}))})))})),$q.all(participantPromises).finally((function(){var isSecondaryDevice=!1;primaryOldCall&&(isSecondaryDevice=isSecondaryDevice||primaryOldCall.isSecondary),secondaryOldCall&&(isSecondaryDevice=isSecondaryDevice||secondaryOldCall.isSecondary);var newConferenceCall=that.createConferenceCall(newConnectionId,confParticipants),currentCalled=newConferenceCall.getCurrentCalled();currentCalled.participants=confParticipants,currentCalled.participantsPhoneNumbers=confParticipantsPhoneNumbers,newConferenceCall.setCurrentCalled(currentCalled),newConferenceCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),newConferenceCall.relevantEquipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(newConnectionId),newConferenceCall.isSecondary=isSecondaryDevice,$log.debug("[TelephonyServiceEventHandler] on conferenced, create new call: "+newConferenceCall),that.sendCallUpdateEvent(newConferenceCall),primaryOldCall&&(primaryOldCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$log.debug("[TelephonyServiceEventHandler] on conferenced, updated primaryOldCall: "+primaryOldCall),that.sendCallUpdateEvent(primaryOldCall)),secondaryOldCall&&(secondaryOldCall.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN),$log.debug("[TelephonyServiceEventHandler] on conferenced, updated secondaryOldCall: "+secondaryOldCall),that.sendCallUpdateEvent(secondaryOldCall))}))},TelephonyServiceEventHandler.prototype.onUpDateCallEvent=function(updatecallElem){$log.info("[TelephonyServiceEventHandler] onUpDateCallEvent");var that=this;return this.getCall(updatecallElem).then((function(call){var jid=updatecallElem.attr("endpointIm"),phoneNumber=updatecallElem.attr("endpointTel"),firstName="",lastName="",identityFirstName=updatecallElem.find("identity").attr("firstName"),identityLastName=updatecallElem.find("identity").attr("lastName"),identityDisplayName=updatecallElem.find("identity").attr("displayName"),contactUpdateDone=!1;if(!config.permitSearchFromPhoneBook&&!_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_2___default.a.FeaturesEnum.TELEPHONY_PHONE_BOOK))return $log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not allowed for the user profile => IGNORED event"),$q.when();if(identityLastName&&identityLastName.length)lastName=identityLastName,identityFirstName&&identityFirstName.length&&(firstName=identityFirstName),$log.info("[TelephonyServiceEventHandler] onUpDateCallEvent received for call "+call.id+" for phoneNumber:"+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default()(phoneNumber)+" with name : "+firstName.slice(0,1)+"***");else{if(!identityDisplayName||!identityDisplayName.length||identityDisplayName===phoneNumber)return $log.info("[TelephonyServiceEventHandler] onUpDateCallEvent xnames not available => IGNORED event"),$q.when();lastName=identityDisplayName,$log.info("[TelephonyServiceEventHandler] onUpDateCallEvent only displayName available")}return _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){if(contact.temp){if(contact.updateName(firstName,lastName),call.contact&&call.contact.id){var currentCalled={contactPhoneNumber:phoneNumber,contact:contact};call.contact.id===contact.id&&call.contact.displayName!==phoneNumber&&call.contact.nameUpdatePrio!==_src_models_contact_model__WEBPACK_IMPORTED_MODULE_3__.Contact.NameUpdatePrio.OUTLOOK_UPDATE_PRIO||(contact.nameUpdatePrio=_src_models_contact_model__WEBPACK_IMPORTED_MODULE_3__.Contact.NameUpdatePrio.SERVER_UPDATE_PRIO,call.setContact(contact),call.setCurrentCalled(currentCalled),contactUpdateDone=!0,$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent xnames updated for "+phoneNumber+" with contact : "+contact.nameForLog))}else if(call.participants&&call.participants.length>0){currentCalled=call.getCurrentCalled();for(var i=0;i<call.participants.length;i++)call.participants[i].temp?call.participants[i].phoneProCan&&call.participants[i].phoneProCan===phoneNumber&&($log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+call.participants[i].nameForLog+" updated with : "+contact.nameForLog),call.participants[i]=contact,call.participants[i].nameUpdatePrio=_src_models_contact_model__WEBPACK_IMPORTED_MODULE_3__.Contact.NameUpdatePrio.SERVER_UPDATE_PRIO,currentCalled.participantsPhoneNumbers[i]=phoneNumber,currentCalled.participants[i]=contact,contactUpdateDone=!0):$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent STRANGE former participant was a rainbow: "+call.participants[i].nameForLog);call.setCurrentCalled(currentCalled)}}else if(call.contact&&call.contact.id){currentCalled={contactPhoneNumber:phoneNumber,contact:contact};call.contact.id!==contact.id&&(call.contact.temp&&(call.contact.updateName(firstName,lastName),call.contact.nameUpdatePrio=_src_models_contact_model__WEBPACK_IMPORTED_MODULE_3__.Contact.NameUpdatePrio.SERVER_UPDATE_PRIO),call.setContact(contact),call.setCurrentCalled(currentCalled),contactUpdateDone=!0,$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent call update with rainbow contact : "+contact.nameForLog))}else if(call.participants&&call.participants.length>0){for(currentCalled=call.getCurrentCalled(),i=0;i<call.participants.length;i++)call.participants[i].temp?call.participants[i].phoneProCan&&call.participants[i].phoneProCan===phoneNumber&&($log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent temp participant "+call.participants[i].nameForLog+" updated with : "+contact.nameForLog),call.participants[i]=contact,call.setParticipants(call.participants),currentCalled.participantsPhoneNumbers[i]=phoneNumber,currentCalled.participants[i]=contact,contactUpdateDone=!0):call.participants[i].jid===jid?(currentCalled.participantsPhoneNumbers[i]=phoneNumber,currentCalled.participants[i]=call.participants[i],contactUpdateDone=!0,$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent rainbow participant "+call.participants[i].nameForLog+" updated with the same : "+contact.nameForLog)):$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent other participant not updated : "+call.participants[i].nameForLog+" vs "+contact.nameForLog);call.setCurrentCalled(currentCalled)}contactUpdateDone?$interval((function(){that.sendCallUpdateEvent(call,updatecallElem)}),300,1):$log.debug("[TelephonyServiceEventHandler] onUpDateCallEvent, no update needed for call : "+call.id)}))}))},TelephonyServiceEventHandler.prototype.onFailCallEvent=function(failedElem){$log.info("[TelephonyServiceEventHandler] onFailCallEvent");var cause=failedElem.attr("cause"),that=this;return this.getCall(failedElem).then((function(call){call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ERROR),call.errorMessage=TelephonyServiceEventHandler.CallFailureLabels[cause],call.errorMessage||(call.errorMessage=cause),that.sendCallUpdateEvent(call,failedElem)}))},TelephonyServiceEventHandler.prototype.onCallNomadicEvent=function(nomadicElem){if($log.info("[TelephonyServiceEventHandler] onCallNomadicEvent"),!this.telephonyService.started&&!this.telephonyService.starting)return $log.info("[TelephonyServiceEventHandler] onCallNomadicEvent on uninitialized telephony => relaunch telephony initialization"),this.telephonyService.launchTelephonyInitilization(),$q.when();var response={destination:nomadicElem.attr("destination"),featureActivated:nomadicElem.attr("featureActivated"),makeCallInitiatorIsMain:nomadicElem.attr("makeCallInitiatorIsMain"),modeActivated:nomadicElem.attr("modeActivated"),nomadicModeInitialized:nomadicElem.attr("nomadicModeInitialized")};if(this.telephonyService.updateNomadicData(response)){var snapshotSecondary=this.telephonyService.nomadicObject.featureActivated&&this.telephonyService.nomadicObject.modeActivated&&!this.telephonyService.nomadicObject.makeCallInitiatorIsMain;this.telephonyService.getTelephonyState(snapshotSecondary)}return $q.when()},TelephonyServiceEventHandler.prototype.onCallForwardedEvent=function(forwardElem){var forwardType=forwardElem.attr("forwardType"),forwardTo=forwardElem.attr("forwardTo");return $log.info("[TelephonyServiceEventHandler] onCallForwardedEvent forwardType: "+forwardType+" forwardTo: "+forwardTo),$rootScope.$broadcast("ON_CALL_FORWARDED_EVENT",{forwardType:forwardType,forwardTo:forwardTo}),this.telephonyService.forwardObject.forwardType=forwardType,this.telephonyService.forwardObject.forwardTo=forwardTo,$q.when()},TelephonyServiceEventHandler.prototype.onCallSubjectEvent=function(callElem){$log.info("[TelephonyServiceEventHandler] onCallSubjectEvent");var that=this;return this.getCall(callElem).then((function(call){try{call.subject=callElem.find("subject").text(),call.subject&&($log.info("[TelephonyServiceEventHandler] subject display"+call.subject),that.sendCallUpdateEvent(call))}catch(error){var errorMessage="onCallSubjectEvent -- "+error.message;$log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}}))},TelephonyServiceEventHandler.prototype.computeCallRelevancy=function(elem,call){var newCallId=elem.attr("newCallId"),connectionId=newCallId||elem.attr("callId"),deviceType=elem.attr("deviceType"),equipmentId=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(connectionId),nomadicInfo=this.telephonyService.getNomadicObject(),makeCallInitiatorIsMain=nomadicInfo.makeCallInitiatorIsMain;deviceType||(deviceType="MAIN"),nomadicInfo.modeActivated||(makeCallInitiatorIsMain=!0),"MAIN"===deviceType&&makeCallInitiatorIsMain&&(call.relevantEquipmentId=equipmentId,call.connectionId=connectionId),"SECONDARY"!==deviceType||makeCallInitiatorIsMain||(call.relevantEquipmentId=equipmentId,call.connectionId=connectionId),call.isSecondary=deviceType&&"SECONDARY"===deviceType&&!makeCallInitiatorIsMain,$log.info("[TelephonyServiceEventHandler] computeCallRelevancy -- relevantEquipmentId: "+call.relevantEquipmentId+" connectionId: "+call.connectionId+" isSecondary: "+call.isSecondary)},TelephonyServiceEventHandler.prototype.getCall=function(elem,doNotUseEqtIdFromElem,searchPendingMakeCall){var that=this;return $q((function(resolve){var jid=elem.attr("endpointIm"),phoneNumber=elem.attr("endpointTel"),connectionId=elem.attr("callId");that.getOrCreateCall(connectionId,jid,phoneNumber,doNotUseEqtIdFromElem,searchPendingMakeCall).then((function(call){resolve(call)}))}))},TelephonyServiceEventHandler.prototype.getOrCreateCall=function(connectionId,jid,phoneNumber,doNotUseEqtIdFromElem,searchPendingMakeCall){var that=this;if(doNotUseEqtIdFromElem){var orgConnectionId=connectionId;connectionId=Object.keys(this.telephonyService.calls||[]).find((function(callConnectionId){return _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getCallIdFromConnectionId(callConnectionId)===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getCallIdFromConnectionId(connectionId)})),$log.debug("[TelephonyServiceEventHandler] getOrCreateCall - HOLD/RETRIEVE search call with callId: "+_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getCallIdFromConnectionId(orgConnectionId)+" from connection id: "+orgConnectionId+" => found connectionId: "+connectionId)}if(!connectionId)return $q.reject("no connection id");if(searchPendingMakeCall){var _call=this.telephonyService.pendingMakeCalls.pop();if(_call)return _call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING),_call.setConnectionId(connectionId),_call.setRelevantEquipmentId(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.getDeviceIdFromConnectionId(_call.connectionId)),$log.info("[TelephonyServiceEventHandler] getOrCreateCall - "+connectionId+" - "+jid+" => found pendingMakeCall: Call confirmed by csta event "+_call),this.telephonyService.calls[_call.id]=_call,$q.when(_call)}var call=this.telephonyService.calls[connectionId];return call?($log.info("[TelephonyServiceEventHandler] getOrCreateCall - "+connectionId+" - "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default()(phoneNumber)+" - "+jid+" => found call: "+call),$q.when(call)):($log.info("[TelephonyServiceEventHandler] getOrCreateCall - "+connectionId+" - "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default()(phoneNumber)+" - "+jid+" => not found : create call..."),$q((function(resolve){jid||phoneNumber?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){resolve(that.telephonyService.getOrCreateCall(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,connectionId,contact))})):resolve(that.telephonyService.getOrCreateCall(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,connectionId))})))},TelephonyServiceEventHandler.prototype.createConferenceCall=function(connectionId,participants){var conferenceCall=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,null,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.PHONE);return conferenceCall.setConnectionId(connectionId),conferenceCall.isConference=!0,conferenceCall.setParticipants(participants),this.telephonyService.calls[conferenceCall.id]=conferenceCall,conferenceCall},TelephonyServiceEventHandler.prototype.sendCallUpdateEvent=function(call,elem){var infoEvt=this.extractInfoEvent(elem);$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call,infoEvt)},TelephonyServiceEventHandler.prototype.extractInfoEvent=function(elem){var infoEvent={actionElemName:"",cause:""};if(elem&&null!==elem){var tagNames=elem.prop("tagName").split(":");infoEvent.actionElemName=tagNames[tagNames.length-1].toLowerCase(),infoEvent.cause=elem.attr("cause"),infoEvent.cause=infoEvent.cause?infoEvent.cause:""}else infoEvent=null;return infoEvent},TelephonyServiceEventHandler.prototype.analyzeContactChange=function(jid,phoneNumber,call){var updateContact=!1,searchOutlook=!1;return jid||phoneNumber?call.isConference?void 0:call.contact?(""!==jid?call.contact.id!==jid&&(updateContact=!0,searchOutlook=!1):call.contact.temp?call.contact.id!==phoneNumber?(updateContact=!0,searchOutlook=!0):call.contact.displayName===phoneNumber&&(updateContact=!1,searchOutlook=!0):""!==call.getCurrentCalled().contactPhoneNumber&&""!==phoneNumber&&call.getCurrentCalled().contactPhoneNumber!==phoneNumber&&(updateContact=!0,searchOutlook=!0),updateContact||searchOutlook?{updateContactToBeDone:updateContact,searchOutlookToBeDone:searchOutlook}:null):{updateContactToBeDone:!0,searchOutlookToBeDone:!0}:null},TelephonyServiceEventHandler.prototype.updateCallContact=function(jid,phoneNumber,actionElem,call){var that=this,tagNames=actionElem.prop("tagName").split(":"),actionElemName=tagNames[tagNames.length-1].toLowerCase();try{var updateAnalyse=that.analyzeContactChange(jid,phoneNumber,call);return call.isConference||""===phoneNumber||call.setCurrentCalledContactNumber(phoneNumber),updateAnalyse?_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid,phoneNumber).then((function(contact){return updateAnalyse.searchOutlookToBeDone?that.telephonyService.updateContactFromOutlookInfos(contact,phoneNumber).then((function(updateStatus){updateStatus?($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update from outlook for contact :"+contact.nameForLog),that.makeUpdateContact(call,contact,phoneNumber,actionElemName)):($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", no update from outlook for contact :"+contact.nameForLog),updateAnalyse.updateContactToBeDone?($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update contact :"+contact.nameForLog),that.makeUpdateContact(call,contact,phoneNumber,actionElemName)):that.sendCallUpdateEvent(call,actionElem))}),(function(){$log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", no Outlook search available"),updateAnalyse.updateContactToBeDone?($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update contact :"+contact.nameForLog),that.makeUpdateContact(call,contact,phoneNumber,actionElemName)):that.sendCallUpdateEvent(call,actionElem)})):($log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", update contact :"+contact.nameForLog),that.makeUpdateContact(call,contact,phoneNumber,actionElemName),$q.when())})).catch((function(error){if(error){var errorMessage="updateCallContact -- "+error.message;$log.error("[TelephonyServiceEventHandler] "+errorMessage)}return $log.debug("[TelephonyServiceEventHandler] on "+actionElemName+", no Outlook search available"),that.sendCallUpdateEvent(call,actionElem),$q.when()})):(that.sendCallUpdateEvent(call,actionElem),$q.when())}catch(error){var errorMessage="updateCallContact -- "+error.message;return $log.error("[TelephonyServiceEventHandler] "+errorMessage),$q.reject(new Error(errorMessage))}},TelephonyServiceEventHandler.prototype.makeUpdateContact=function(call,contact,phoneNumber,actionElemName){var that=this;call.setContact(contact);var currentCalled={contactPhoneNumber:phoneNumber,contact:contact};call.setCurrentCalled(currentCalled),"delivered"===actionElemName&&call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING?$interval((function(){that.sendCallUpdateEvent(call)}),300,1):that.sendCallUpdateEvent(call)},TelephonyServiceEventHandler}])},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DirectoryService=void 0;const contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),profile_service_1=__webpack_require__(8),anonymizer_1=__webpack_require__(14);class DirectoryService{constructor($rootScope,$log,$http,$injector,orderByFilter,conversationService,errorHelperService){this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.$injector=$injector,this.orderByFilter=orderByFilter,this.conversationService=conversationService,this.errorHelperService=errorHelperService,this.centralizedService=null,this.companyContactsNumber=0,this.otherCompanyContactsNumber=0,this.authService=auth_service_1.default,this.profileService=profile_service_1.default,this.contactService=contact_service_1.default}start(stats){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] === STARTING ===");let startDate=performance.now();try{this.centralizedService=this.$injector.get("centralizedService")}catch(error){}let startDuration=Math.round(performance.now()-startDate);stats.push({service:"directoryService",startDuration:startDuration}),this.$log.info("[DirectoryService] === STARTED ("+startDuration+" ms) ===")}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] Stopping"),this.$log.info("[DirectoryService] Stopped")}))}search(searchText,addRosters=!1,limit=20,companyId="",excludeCompanyId=null){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] searchContact with text "+anonymizer_1.default(searchText));let searchType=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.SEARCH_BY_TAGS)?"search=":"displayName=",serverUrl=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+limit+"&"+searchType+encodeURIComponent(searchText);companyId&&(serverUrl+="&companyId="+encodeURIComponent(companyId)),excludeCompanyId&&(serverUrl+="&excludeCompanyId="+encodeURIComponent(excludeCompanyId));try{const contactsData=(yield this.$http({method:"GET",url:serverUrl,headers:this.authService.getRequestHeader()})).data.data;this.$log.info("[DirectoryService] search find "+contactsData.length+" contact(s)"),excludeCompanyId?this.otherCompanyContactsNumber=contactsData.length:this.companyContactsNumber=contactsData.length;let contacts=[];if(contactsData.forEach(contactData=>{if(this.contactService.isUserContactJid(contactData.jid_im))return void this.$log.info("[DirectoryService] search contact "+contactData.jid_im+" ignored");let contact=this.contactService.getContact(contactData.jid_im);contact||(contact=this.contactService.createBasicContact(contactData.jid_im),contact.updateFromUserData(contactData),contact.getAvatar(),this.contactService.dbContacts[contactData.id]=contact,this.contactService.jtelContacts[contact.jidtel]=contact),contact.tags=contactData.tags,contact.dbId=contactData.id,this.contactService.updateContactRichStatus(contact),this.conversationService.computeCapabilitiesForContact(contact,!1),contacts.push(contact)}),addRosters){let rosterContacts=this.contactService.searchContacts(searchText);contacts=contacts.concat(rosterContacts.filter(item=>item.roster&&contacts.indexOf(item)<0))}return contacts=this.orderByFilter(contacts,"_displayName",!1),contacts}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] search - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),e}}))}getCompanyContactsNumber(){return this.companyContactsNumber}getOtherCompanyContactsNumber(){return this.otherCompanyContactsNumber}searchUserByLogin(loginEmail){return __awaiter(this,void 0,void 0,(function*(){this.$log.info('[DirectoryService] searchUserByLogin with "'+loginEmail+'"');const serverUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/";try{const userArray=(yield this.$http({method:"POST",url:serverUrl+"users/loginEmails",headers:this.authService.getPostHeader(),data:{loginEmail:[loginEmail]}})).data.data;if(1===userArray.length){let contact=yield this.contactService.getOrCreateContact(userArray[0].jid_im);return contact.loginEmail=loginEmail,contact}}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] searchUserByLogin - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),e}}))}searchUserByJid(jid){return __awaiter(this,void 0,void 0,(function*(){this.$log.info('[DirectoryService] searchUserByJid with "'+jid+'"');const serverUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/enduser/v1.0/users/jids/";try{const user=(yield this.$http({method:"GET",url:serverUrl+encodeURIComponent(jid),headers:this.authService.getRequestHeader()})).data;if(user){let contact=yield this.contactService.getOrCreateContact(jid);return contact.updateFromUserData(user.data),contact}}catch(error){let e=error;throw error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] searchUserByJid - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),e}}))}searchUserByPhoneNumber(phoneNumber){return __awaiter(this,void 0,void 0,(function*(){this.$log.info('[DirectoryService] searchUserByPhoneNumber with "'+phoneNumber+'"');const serverUrl=config.webservices.protocol+"://"+config.webservices.currentServer+":"+config.webservices.port+"/api/rainbow/search/v1.0/phone-numbers/"+phoneNumber+"/users";try{const user=(yield this.$http({method:"GET",url:serverUrl,headers:this.authService.getRequestHeader()})).data.data;if(user){return yield this.contactService.getOrCreateContact(user.jid_im)}}catch(error){let e=error;return error&&error.data&&(e=this.errorHelperService.handleError(error),this.$log.error("[DirectoryService] searchUserByPhoneNumber - "+e.message),401===error.data.errorCode&&this.$rootScope.$broadcast("ON_SESSION_EXPIRED_NOTIFICATION_EVENT")),null}}))}searchAllContacts(searchText,limit=20,companyId="",addRosters=!0,addOutlook=!0,excludeCompanyId=null){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[DirectoryService] searchAllContacts with text "+searchText);try{let contacts=[];addRosters&&(contacts=this.contactService.searchContacts(searchText));const rainbowContacts=yield this.search(searchText,!1,limit,companyId,excludeCompanyId);if(contacts=contacts.concat(rainbowContacts.filter(item=>!item.roster||contacts.indexOf(item)<0)),this.$log.info("[DirectoryService] searchAllContacts with text "+searchText+" found contacts "+contacts.length),addOutlook&&this.centralizedService){const[outlookContactsByEmail,outlookContactsByName]=yield Promise.all([this.searchOutlookUsersByEmail(searchText),this.searchOutlookUsersByName(searchText)]);let outlookResults=this.centralizedService.outlook.mergeOutlookContact(outlookContactsByEmail,outlookContactsByName);outlookResults=this.adaptOutlookContacts(outlookResults),contacts=contacts.concat(outlookResults),this.$log.info("[DirectoryService] searchAllContacts with text "+searchText+" with outlook contacts "+contacts.length)}return contacts}catch(error){throw this.$log.error("[DirectoryService] searchAllContacts - Unable to search all contacts"),error}}))}adaptOutlookContacts(outlookResults){return outlookResults&&outlookResults.length&&outlookResults.forEach(contact=>{contact.photo&&contact.photo.src?contact.avatar=contact.photo:contact.photo&&(contact.avatar=new Image,contact.avatar.src=contact.photo),contact.businessPhones=[],contact.businessPhone&&contact.businessPhones.push(contact.businessPhone),contact.mobilePhone&&(contact.mobilePhones=[],contact.mobilePhones.push(contact.mobilePhone)),contact.homePhone&&(contact.otherPhoneNumbers=contact.homePhone),contact.emailAddress&&(contact.email=contact.emailAddress),contact.outlookFlag=!0}),outlookResults}searchOutlookUsersByName(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(this.centralizedService)try{return yield this.centralizedService.outlook.searchByNameWithAvatar(searchPattern,2)}catch(_a){return this.$log.warn("[DirectoryService] searchOutlookUsersByName - Outlook service unavailable"),[]}}))}searchOutlookUsersByEmail(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(this.centralizedService&&this.centralizedService.outlook)try{return yield this.centralizedService.outlook.searchByEmailWithAvatar(searchPattern,2)}catch(_a){return this.$log.warn("[DirectoryService] searchOutlookUsersByEmail - Outlook service unavailable"),[]}}))}}exports.DirectoryService=DirectoryService,DirectoryService.$inject=["$rootScope","$log","$http","$injector","orderByFilter","conversationService","errorHelperService"],angular.module("rainbow").service("directoryService",DirectoryService)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_group_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(44),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__);angular.module("rainbow").service("groupService",["$q","$rootScope","$log","$http","usersService",function($q,$rootScope,$log,$http,usersService){var service=this;this.started=!1,service.ON_REMOVE_GROUP_USER_EVENT="ON_REMOVE_GROUP_USER_EVENT",service.ON_ADD_GROUP_USER_EVENT="ON_ADD_GROUP_USER_EVENT",service.ON_GROUP_USERS_UPDATE_EVENT="ON_GROUP_USERS_UPDATE_EVENT",service.ON_CREATED_GROUP_EVENT="ON_CREATED_GROUP_EVENT",service.ON_UPDATE_GROUP_EVENT="ON_UPDATE_GROUP_EVENT",service.ON_REMOVED_GROUP_EVENT="ON_REMOVED_GROUP_EVENT",this.start=function(){$log.info(""),$log.info("[groupService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/users/"+_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.userId+"/";var defered=$q.defer();return service.$q=$q,service.groups=null,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.userContact.isCPaaSGuest()?defered.resolve():(this.attachHandlers(),this.getGroups(),service.started=!0,$log.info("[groupService] === STARTED ==="),defered.resolve(),defered.promise)},this.stop=function(){return $log.info("[groupService] === STOPPING ==="),service.conversations=null,service.groups=null,this.groupMessageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.deleteHandler(this.groupMessageHandlerRef),this.groupMessageHandlerRef=null),this.started=!1,$log.info("[groupService] === STOPPED ==="),$q.when()},this.getGroups=function(){return service.groups?$q.when(service.groups):service.getRemoteGroups()},this.getGroupById=function(groupId){return service.group[groupId]},service.getGroupsAsArray=function(){var groupsArray=[];for(var key in service.groups)service.groups.hasOwnProperty(key)&&groupsArray.push(service.groups[key]);return groupsArray},this.getRemoteGroups=function(){$log.info("[groupService] getGroups");var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"groups?format=full",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[groupService] getGroups success (find "+response.data.total+" group(s))"),service.groups=[];var usersPromises=[];return data.forEach((function(groupData){var group=_src_models_group_model__WEBPACK_IMPORTED_MODULE_0__.Group.createFromData(groupData);service.groups.push(group),angular.forEach(groupData.users,(function(user_id){usersPromises=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.getContactByDBId(user_id).then((function(contact){contact&&group.users.push(contact)}))})),service.logGroupUsers(group),service.sortUsersInGroup(group)})),$q.all(usersPromises)}),(function(response){var errorMessage="getGroups"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})).then((function(){defered.resolve(service.groups)})),defered.promise};var addGroupUserAct=function(group_id,user_id){return $q((function(resolve){service.groups.some((function(group){return group.id===group_id&&(group.users.some((function(user){return user_id===user.dbId}))?(resolve(group),$rootScope.$broadcast(service.ON_ADD_GROUP_USER_EVENT,group_id,user_id),!0):(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.getContactByDBId(user_id).then((function(contact){group.users.push(contact),service.sortUsersInGroup(group);var Wgroups=[group];contact.getGroups()?contact.getGroups().push(group):contact.setGroups(Wgroups),$rootScope.$broadcast(service.ON_ADD_GROUP_USER_EVENT,group_id,user_id),resolve(group)})),!0))}))||($rootScope.$broadcast(service.ON_ADD_GROUP_USER_EVENT,group_id,user_id),resolve())}))};this.getGroup=function(group_id){$log.info("[groupService] getGroup  for "+group_id);var defered=$q.defer(),group=null;return $http({method:"GET",url:service.portalURL+"groups/"+group_id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var groupData=response.data.data,usersPromises=[];return group=_src_models_group_model__WEBPACK_IMPORTED_MODULE_0__.Group.createFromData(groupData),$log.info("[groupService] getGroup success for "+group.name+" : "+group.id),service.groups.some((function(item,index){return item.id===groupData.id&&(service.groups[index]=group,angular.forEach(groupData.users,(function(user){usersPromises=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.getContactByDBId(user.id).then((function(contact){contact&&(service.groups[index].users.push(contact),service.sortUsersInGroup(service.groups[index]))}))})),!0)}))||(service.groups.push(group),angular.forEach(groupData.users,(function(user){usersPromises=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.getContactByDBId(user.id).then((function(contact){if(contact){group.users.push(contact),service.sortUsersInGroup(group);var Wgroups=[group];contact.getGroups()?contact.getGroups().push(group):contact.setGroups(Wgroups)}}))}))),$q.all(usersPromises)}),(function(response){var errorMessage="getGroup"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})).then((function(){defered.resolve(group)})),defered.promise},this.addGroup=function(group){$log.info("[groupService] addGroup : "+group.name);var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"groups",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getPostHeader(),data:{name:group.name,comment:group.comment,isFavorite:group.isFavorite}}).then((function(response){$log.info("[groupService] addGroup success for : "+group.name);var groupData=response.data.data,new_group=_src_models_group_model__WEBPACK_IMPORTED_MODULE_0__.Group.createFromData(groupData);defered.resolve(new_group)}),(function(response){var errorMessage="addGroup"+service.handleErrorMessage(response),error=new Error(errorMessage);error.details=409===response.status?"conflict":"unknown",defered.reject(error),$log.error("[groupService] "+errorMessage)})),defered.promise};var removeGroupAct=function(group_id){angular.forEach(service.groups,(function(group,index){group.id===group_id&&service.groups.splice(index,1)}))};this.removeGroup=function(group_id){$log.info("[groupService] removeGroup : "+group_id);var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"groups/"+group_id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[groupService] removeGroup success for : "+group_id),removeGroupAct(group_id),defered.resolve()}),(function(response){var errorMessage="removeGroup"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise},this.updateGroup=function(group){$log.info("[groupService] updateGroup for : "+group.name);var defered=$q.defer();return $http({method:"PUT",url:service.portalURL+"groups/"+group.id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:{name:group.name,comment:group.comment,isFavorite:group.isFavorite}}).then((function(){$log.info("[groupService] updateGroup success for : "+group.name),defered.resolve()}),(function(response){var error=service.handleErrorMessage(response,"updateGroup");defered.reject(error),$log.error("[groupService] "+error.message)})),defered.promise},this.getGroupUsers=function(group_id){$log.info("[groupService] getGroupUsers : "+group_id);var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"groups/"+group_id+"/users",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[groupService] getGroupUsers success for "+group_id+" (find "+response.data.total+" users(s))"),defered.resolve(data.users)}),(function(response){var errorMessage="getGroupUsers"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise},this.addGroupUser=function(group,user){$log.info("[groupService] addGroupUser");var defered=service.$q.defer();return group.users.some((function(item){return user.dbId===item.dbId}))?($log.info("[groupService] addGroupUser - user: "+user.id+" already exist in group: "+group.name+" - no remote action"),void defered.resolve()):($http({method:"POST",url:service.portalURL+"groups/"+group.id+"/users/"+user.dbId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getPostHeader()}).then((function(response){$log.info("[groupService] addGroupUser success: "+user.id+"/"+group.name),addGroupUserAct(group.id,user.dbId).then((function(updatedGroup){if(updatedGroup)defered.resolve(updatedGroup);else{var groupData=response.data.data,newGroup=_src_models_group_model__WEBPACK_IMPORTED_MODULE_0__.Group.createFromData(groupData);defered.resolve(newGroup)}})),$rootScope.$broadcast(service.ON_GROUP_USERS_UPDATE_EVENT)}),(function(response){var errorMessage="addGroupUser"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise)};var removeGroupUserAct=function(group_id,user_id){angular.forEach(service.groups,(function(group){group.id===group_id&&(angular.forEach(group.users,(function(user_item,index){user_item.dbId===user_id&&(group.users.splice(index,1),user_item.getGroups()&&angular.forEach(user_item.getGroups(),(function(user_group_item,g_index){user_group_item.id===group_id&&user_item.getGroups().splice(g_index,1)})))})),service.sortUsersInGroup(group))}))};this.getGroupById=function(group_id){var result=null;return angular.forEach(service.groups,(function(group){group.id===group_id&&(result=group)})),result},this.removeGroupUser=function(group_id,user){$log.info("[groupService] removeGroupUser : "+group_id+"/"+user.id);var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"groups/"+group_id+"/users/"+user.dbId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[groupService] removeGroupUser success : "+group_id+"/"+user.id),removeGroupUserAct(group_id,user.dbId);var group=service.getGroupById(group_id);$rootScope.$broadcast(service.ON_GROUP_USERS_UPDATE_EVENT),defered.resolve(group)}),(function(response){var errorMessage="removeGroupUser"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise},this.getUserGroups=function(user){if(!user)return $log.info("[groupService] getUserGroups for unknown user !"),$q.when();$log.info("[groupService] getUserGroups for user : "+user.id);var defered=$q.defer(),userGroups=user.getGroups();return userGroups?$q.when(userGroups):($http({method:"GET",url:service.portalURL+"groups?userId="+user.dbId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[groupService] getUserGroups success (find "+response.data.total+" group(s))");var groups=[];data.forEach((function(groupData){var group=_src_models_group_model__WEBPACK_IMPORTED_MODULE_0__.Group.createFromData(groupData);groups.push(group)})),user.setGroups(groups),service.logUserGroups(user.nameForLog,groups),defered.resolve(groups)}),(function(response){var errorMessage="getUserGroups"+service.handleErrorMessage(response);defered.reject(new Error(errorMessage)),$log.error("[groupService] "+errorMessage)})),defered.promise)},this.getGroupFromName=function(group_name){$log.info("[groupService] getGroupFromName : "+group_name);var defered=$q.defer();return this.getGroups().then((function(groups){var group=null;groups.forEach((function(item){item.name===group_name&&(group=item)})),defered.resolve(group)})),defered.promise},this.sortUsersInGroup=function(group){group&&(group.sortedUserList=usersService.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity(group.users,$rootScope.orderType,$rootScope.filterType,!0))},this.searchLocalGroup=function(searchText){var groupNamesMatches=[];return $log.info("[groupService] searchLocalGroup with text "+searchText),searchText&&service.groups.forEach((function(gr){gr.name.toLowerCase().indexOf(searchText.toLowerCase().toString())>=0&&groupNamesMatches.push(gr)})),groupNamesMatches},this.extractStanzaData=function(stanza){var defered=$q.defer(),stanzaData={outgoingMessage:!1};return stanzaData.body=angular.element(stanza)[0].firstChild,stanzaData.messageId=angular.element(stanza).attr("id"),defered.resolve(stanzaData),defered.promise},this.onGroupMessageReceived=function(stanza){try{return this.extractStanzaData(stanza).then((function(stanzaData){if(stanzaData.body&&"group"===stanzaData.body.tagName){var action=stanzaData.body.getAttribute("action"),scope=stanzaData.body.getAttribute("scope"),group_id=stanzaData.body.getAttribute("id");switch(scope){case"group":switch(action){case"create":service.getGroup(group_id).then((function(){$rootScope.$broadcast(service.ON_CREATED_GROUP_EVENT,group_id)}));break;case"update":var name=stanzaData.body.getAttribute("name"),comment=stanzaData.body.getAttribute("comment"),isFavorite="true"===stanzaData.body.getAttribute("isFavorite");$rootScope.$broadcast(service.ON_UPDATE_GROUP_EVENT,group_id,name,comment,isFavorite);break;case"delete":removeGroupAct(group_id),$rootScope.$broadcast(service.ON_REMOVED_GROUP_EVENT,group_id)}break;case"user":var user_id=stanzaData.body.getAttribute("userId");switch(action){case"create":addGroupUserAct(group_id,user_id);break;case"delete":removeGroupUserAct(group_id,user_id),$rootScope.$broadcast(service.ON_REMOVE_GROUP_USER_EVENT,group_id,user_id)}}}})),!0}catch(error){return!0}},this.attachHandlers=function(){service.removeHandlers(),service.groupMessageHandlerRef||(service.groupMessageHandlerRef=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.addHandler((function(stanza){return service.onGroupMessageReceived(stanza)}),null,"message","management"))},this.removeHandlers=function(){service.groupMessageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.deleteHandler(service.groupMessageHandlerRef),service.groupMessageHandlerRef=null)},this.handleBadRequest=function(message,response){if(400===response.status&&response.data.errorDetails&&response.data.errorDetails.length>0){var fieldErrors={};response.data.errorDetails.forEach((function(details){fieldErrors[details.param]=details.msg}));var error=new Error(message+" failure: BadRequest");return error.fieldErrors=fieldErrors,error}return null},this.handleErrorMessage=function(response){var errorMessage=" failure: ";return 500===response.status&&(errorMessage+="Internal server error"),403===response.status?errorMessage+="Access is forbidden for the current user":404===response.status?errorMessage+=response.data.errorMsg:response.data&&response.data.errorDetails&&(errorMessage+=response.data.errorDetails),errorMessage},this.logUserGroups=function(ownername,groups){var groupsNameContent="";groups&&0!==groups.length&&(groups.forEach((function(gr){gr.name&&(groupsNameContent+=" "+gr.name)})),$log.info("[groupService] logUserGroups for "+ownername+":"+groupsNameContent))},this.logGroupUsers=function(group){var UserNameContent;group&&group.users&&0!==group.users.length&&(UserNameContent=group.users.map((function(user){return user.nameForLog})).join(" / "),$log.info("[groupService] logGroupUsers for "+group.name+": "+UserNameContent))}}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WebrtcGatewayService=exports.MPCallState=void 0;const call_model_1=__webpack_require__(0),uuid4=__webpack_require__(27),moment=__webpack_require__(3),contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8);var MPCallState;!function(MPCallState){MPCallState[MPCallState.Unknow=0]="Unknow",MPCallState[MPCallState.Free=1]="Free",MPCallState[MPCallState.WaitWebrtc=2]="WaitWebrtc",MPCallState[MPCallState.WaitTelephony=3]="WaitTelephony",MPCallState[MPCallState.CallOffer=4]="CallOffer",MPCallState[MPCallState.CallOnGoing=5]="CallOnGoing",MPCallState[MPCallState.CallActive=6]="CallActive",MPCallState[MPCallState.CallActiveNoWebMedia=7]="CallActiveNoWebMedia",MPCallState[MPCallState.TelCallReleasing=8]="TelCallReleasing",MPCallState[MPCallState.WebCallReleasing=9]="WebCallReleasing",MPCallState[MPCallState.RemoteControled=10]="RemoteControled",MPCallState[MPCallState.AnomalyCCS=11]="AnomalyCCS"}(MPCallState=exports.MPCallState||(exports.MPCallState={}));class WebrtcGatewayService{constructor($q,$rootScope,$log,$http,$interval,videoService,errorHelperService,telephonyService){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.$interval=$interval,this.videoService=videoService,this.errorHelperService=errorHelperService,this.telephonyService=telephonyService,this.started=!1,this.listeners=[],this.myContact=null,this.mediaPillarContact=null,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarJid="",this.authService=auth_service_1.default,this.evtQueue=[],this.SEM=0,this.fakeMediaPillarJid="00a241586a984a869c73719007b27921@demo-all-in-one-dev-1.opentouch.cloud",this.xmppService=xmpp_service_1.default,this.profileService=profile_service_1.default,this.contactService=contact_service_1.default,this.TO_transition=15e3,this.TO_transition_long=3e4,this.TO_NoWebMedia=6e4,this.TO_NoWebMediaNotel=5e3,this.TO_PILLAR_POLLING=3e5,this.TO_waitTelephony=600,this.mediaPillarKeepAliveSuspend=!1}start(stats){let startDate=performance.now();return this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.portalURL=config.restServerUrl+"/api/rainbow/mediapillar/v1.0/mediapillars",this.myContact=this.contactService.userContact,this.mediaPillarContact=null,this.mediaPillarCallContext={callState:MPCallState.Free,keepAlive_TO:null,callState_TO:null,waitTelephony_TO:null,isOutgoingCall3PCC:!1,telephonyCallRefs:[],webrtcCallRef:null,mediaPillarJid:"",rainbowPhoneNumber:"",remoteExtension:"",previousCallConnectionId:null,previousCallStatus:null,updateContactFlag:!1,isIncomingCallPopupWithWebRtcCall:!1},this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)?(this.$log.info("[WebrtcGatewayService] === STARTING ==="),this.started=!0,this.SEM=0,this.resetEvtAutomaton(),this.getMediaPillarData().then(mediaPillarJid=>{this.mediaPillarContact=this.createMediaPillarContact(mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid=mediaPillarJid,this.$log.info("[WebrtcGatewayService] Pillar remoteExtension used : "+this.mediaPillarCallContext.remoteExtension),""!==this.mediaPillarCallContext.remoteExtension?this.mediaPillarConfigured=!0:(this.$log.warn("[WebrtcGatewayService] no remoteExtention available "),this.mediaPillarConfigured=!1),this.mediaPillarConfigured&&this.dummyRegisterMediaPillarCall().then(()=>{this.mediaPillarAlive=!0,this.$log.info("[WebrtcGatewayService] Pseudo media pillar register OK with extension "+this.mediaPillarCallContext.remoteExtension),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive)}).catch(error=>{this.mediaPillarAlive=!1,this.$log.info("[WebrtcGatewayService] Pseudo media pillar register KO"),this.$log.info("[WebrtcGatewayService] Initial polling activated on starting issue"),this.mediaPillarKeepAlivePolling("START",3e5),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive)}),this.xmppConnectionSubscription=this.xmppService.subscribeToConnectionEvents(event=>{"ON_XMPP_DISCONNECTED"===event.name?(this.$log.info("[WebrtcGatewayService] onConnectionStateChangeEvent : disconnected then MP keepalive suspended"),this.mediaPillarKeepAliveSuspend=!0):"ON_XMPP_CONNECTED"===event.name&&(this.$log.info("[WebrtcGatewayService] onConnectionStateChangeEvent : connected then keepalive as necessary"),this.mediaPillarKeepAliveSuspend=!1,this.TO_PILLAR_POLLING=3e5)}),this.listeners.push(this.$rootScope.$on("ON_CALL_UPDATED_EVENT",(event,call,infoEvt)=>{this.onCallEvent(event,call,infoEvt)})),this.listeners.push(this.$rootScope.$on("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",(event,call)=>{this.onRemoteCtrlCall(event,call)}));var startDuration=Math.round(performance.now()-startDate);stats.push({service:"WebrtcGatewayService",startDuration:startDuration}),this.$log.info("[WebrtcGatewayService] === STARTED ("+startDuration+" ms) ===")}).catch(error=>{this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension="",this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.$log.info("[WebrtcGatewayService] === STARTING FAILURE === "+error.message)})):this.$log.info("[WebrtcGatewayService] === NO WEBRTCGATEWAY ENVOLVED === "),this.$q.when()}stop(){return this.$log.info("[WebrtcGatewayService] === STOPPING ==="),this.started=!1,this.mediaPillarConfigured=!1,this.mediaPillarAlive=!1,this.mediaPillarKeepAlivePolling("STOP",0),this.mediaPillarCallContext&&(this.releaseMediaPillarCallContext(),this.mediaPillarCallContext.callState=MPCallState.Unknow,this.mediaPillarCallContext.mediaPillarJid="",this.mediaPillarCallContext.rainbowPhoneNumber="",this.mediaPillarCallContext.remoteExtension=""),this.xmppConnectionSubscription&&this.xmppConnectionSubscription.unsubscribe(),this.listeners&&this.listeners.forEach(unregisterListener=>{unregisterListener()}),this.$log.info("[WebrtcGatewayService] === STOPPED ==="),this.$q.resolve()}onCallEvent(__event,call,infoEvt){if(this.isMediaPillarCallCase()){if(this.SEM++,this.$log.info("[WebrtcGatewayService] onCallEvent IN("+this.SEM+") state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onCallEvent "+this.mediaPillarCallContext.callState+" --- "+call.type.value+"("+call.id+","+call.status.value+")"),infoEvt&&null!==infoEvt&&(this.$log.info("[WebrtcGatewayService] onCallEvent tel infoEvt = "+infoEvt),this.$log.info("[WebrtcGatewayService] onCallEvent tel infoEvt : Evt = "+infoEvt.actionElemName+" / cause = "+infoEvt.cause),"updatecall"===infoEvt.actionElemName&&(this.mediaPillarCallContext.updateContactFlag=!0,this.$log.info("[WebrtcGatewayService] updateContactFlag = true"))),call.connectionId===this.mediaPillarCallContext.previousCallConnectionId&&call.status===this.mediaPillarCallContext.previousCallStatus&&!this.mediaPillarCallContext.updateContactFlag)return this.mediaPillarCallContext.previousCallConnectionId=call.connectionId,this.mediaPillarCallContext.previousCallStatus=call.status,this.$log.info("[WebrtcGatewayService] onCallEvent | DEBOUNCE EVT"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(call.type.value===call_model_1.Call.Type.PHONE.value&&null===call.id)return this.mediaPillarCallContext.previousCallConnectionId=call.connectionId,this.mediaPillarCallContext.previousCallStatus=call.status,this.$log.info("[WebrtcGatewayService] onCallEvent | FILTER EVT null/error"),this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+")");if(this.mediaPillarCallContext.previousCallConnectionId=call.connectionId,this.mediaPillarCallContext.previousCallStatus=call.status,this.evtQueue.push(call),this.evtQueue.length>1)return this.SEM--,void this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") evt pushed = "+call.status.value);for(;this.evtQueue.length;){try{this.processEvt(this.evtQueue[0])}catch(error){this.$log.error("[WebrtcGatewayService] onCallEvent queue processing | call : "+this.evtQueue[0].status.value+" Error : "+error)}this.evtQueue.splice(0,1)}this.SEM--,this.$log.info("[WebrtcGatewayService] onCallEvent OUT("+this.SEM+") state = "+this.mediaPillarCallContext.callState),0!==this.SEM&&(this.$log.error("[WebrtcGatewayService] onCallEvent OUT | Unmanaged Eventing Reentrancy Situation"),this.resetEvtAutomaton(),this.SEM=0)}}processEvt(call){if(this.$log.info("[WebrtcGatewayService] processEvt | process "+call.type.value+"("+call.id+","+call.status.value+") in MPcontextCallstate = "+this.mediaPillarCallContext.callState),call.type.value===call_model_1.Call.Type.PHONE.value){var telCallsNumber=this.telephonyService.getCalls().length;if((()=>{let ignoreEvt=!1;return(call.status===call_model_1.Call.Status.DIALING||this.telephonyService.isSipWise())&&(call.isSecondary=!0),call.isSecondary?call.status===call_model_1.Call.Status.UNKNOWN||call.status===call_model_1.Call.Status.RINGING_INCOMMING||call.status===call_model_1.Call.Status.QUEUED_INCOMMING||call.status===call_model_1.Call.Status.ACTIVE?(this.addTelCallRefs(call),ignoreEvt=!1,ignoreEvt):this.mediaPillarCallContext.callState===MPCallState.RemoteControled?(this.$log.info("[WebrtcGatewayService] processEvt |  RemoteControled state for call : "+call.id+" then ignore"),ignoreEvt=!0,ignoreEvt):(this.addTelCallRefs(call),this.mediaPillarCallContext.telephonyCallRefs.length>1?(this.$log.info("[WebrtcGatewayService] processEvt |  nthCall : "+this.mediaPillarCallContext.telephonyCallRefs.length+" then ignore"),ignoreEvt=!0,ignoreEvt):ignoreEvt):(this.$log.info("[WebrtcGatewayService] processEvt | NOT SECONDARY then ignore"),ignoreEvt=!0,ignoreEvt)})())this.$log.info("[WebrtcGatewayService] processEvt |  call("+call.id+" / SEC "+call.isSecondary+", "+call.status.value+") -> EVT IGNORED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+telCallsNumber);else switch(this.$log.info("[WebrtcGatewayService] processEvt |  call("+call.id+" / SEC "+call.isSecondary+", "+call.status.value+") -> EVT PROCESSED"),this.$log.info("[WebrtcGatewayService] processEvt |  telephonyCallRefs.length = "+this.mediaPillarCallContext.telephonyCallRefs.length),this.$log.info("[WebrtcGatewayService] processEvt |  calls.length = "+telCallsNumber),call.status){case call_model_1.Call.Status.RINGING_INCOMMING:this.onTelCallIncomming(call);break;case call_model_1.Call.Status.DIALING:this.onTelCallDialling(call);break;case call_model_1.Call.Status.RINGING_OUTGOING:this.onTelCallOutgoing(call);break;case call_model_1.Call.Status.ACTIVE:this.onTelCallActive(call);break;case call_model_1.Call.Status.UNKNOWN:this.onTelCallReleasing(call)}}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(call.fullJid)))switch(call.status){case call_model_1.Call.Status.RINGING_INCOMMING:this.onWebrtcCallIncomming(call);break;case call_model_1.Call.Status.CONNECTING:this.onWebrtcCallConnecting(call);break;case call_model_1.Call.Status.ACTIVE:this.onWebrtcCallActive(call);break;case call_model_1.Call.Status.ANSWERING:this.onWebrtcCallAnswering(call);break;case call_model_1.Call.Status.UNKNOWN:this.onWebrtcCallReleasing(call)}else this.$log.info("[WebrtcGatewayService] processEvt | process call("+call.id+","+call.status.value+") -> Not a webrtcgateway case")}releaseMediaPillarCallContext(){this.mediaPillarCallContext.callState=MPCallState.Free,this.stopCallStateTimeOut(),this.stopWaitTelephonyTimeOut(),this.mediaPillarCallContext.isOutgoingCall3PCC=!1,this.mediaPillarCallContext.updateContactFlag=!1,this.mediaPillarCallContext.telephonyCallRefs.length>0&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but telephonyCallRefs not empty !"),null!==this.mediaPillarCallContext.webrtcCallRef&&this.$log.warn("[WebrtcGatewayService] releaseMediaPillarCallContext | reset context but webrtcCallRef not null !"),this.mediaPillarCallContext.telephonyCallRefs=[],this.mediaPillarCallContext.webrtcCallRef=null,this.mediaPillarCallContext.previousCallConnectionId=null,this.mediaPillarCallContext.previousCallStatus="",this.mediaPillarCallContext.isIncomingCallPopupWithWebRtcCall=!1,this.$log.log("[WebrtcGatewayService] releaseMediaPillarCallContext | =====  mediaPillarCallContext RELEASED  ===== ")}resetEvtAutomaton(){this.evtQueue=[]}stopCallStateTimeOut(){this.mediaPillarCallContext.callState_TO&&this.$interval.cancel(this.mediaPillarCallContext.callState_TO),this.mediaPillarCallContext.callState_TO=null}stopWaitTelephonyTimeOut(){this.mediaPillarCallContext.waitTelephony_TO&&this.$interval.cancel(this.mediaPillarCallContext.waitTelephony_TO),this.mediaPillarCallContext.waitTelephony_TO=null}onRemoteCtrlCall(__event,call){this.$log.info("[WebrtcGatewayService] onRemoteCtrlCall for call "+call.id+" in previous state: "+this.mediaPillarCallContext.callState+": => Becomes REMOTECONTROLED"),this.mediaPillarCallContext.callState=MPCallState.RemoteControled,this.stopCallStateTimeOut()}addTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] addTelCallRefs | ANOMALY callRef not valid");let alreadyIn=!1;for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[i].id===callRef.id&&(alreadyIn=!0);alreadyIn||this.mediaPillarCallContext.telephonyCallRefs.push(callRef)}removeTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] removeTelCallRefs | ANOMALY callRef not valid");let i=0;for(;i<this.mediaPillarCallContext.telephonyCallRefs.length;)this.mediaPillarCallContext.telephonyCallRefs[i].id===callRef.id?(this.mediaPillarCallContext.telephonyCallRefs.splice(i,1),0===i&&this.mediaPillarCallContext.telephonyCallRefs.length&&(this.mediaPillarCallContext.telephonyCallRefs[0].setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.log("[WebrtcGatewayService] removeTelCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id))):i++}putAsMasterTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | ANOMALY callRef not valid");let i=-1;for(var j=0;j<this.mediaPillarCallContext.telephonyCallRefs.length;j++)this.mediaPillarCallContext.telephonyCallRefs[j].id===callRef.id&&(i=j);if(this.$log.log("[WebrtcGatewayService] putAsMasterTelCallRefs | master MP call is : "+callRef.id),0!==i)if(-1!==i){let replace=this.mediaPillarCallContext.telephonyCallRefs[0];this.mediaPillarCallContext.telephonyCallRefs[0]=callRef,this.mediaPillarCallContext.telephonyCallRefs[i]=replace,callRef.setMediaPillarCall(this.getMediaPillarCallContext())}else this.$log.warn("[WebrtcGatewayService] putAsMasterTelCallRefs | Anomaly call not in telephonyCallRefs")}isMasterTelCallRefs(callRef){return null==callRef?(this.$log.warn("[WebrtcGatewayService] isMasterTelCallRefs | ANOMALY callRef not valid"),!1):0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].id===callRef.id}isInTelCallRefs(callRef){if(null==callRef)return void this.$log.warn("[WebrtcGatewayService] isInTelCallRefs | ANOMALY callRef not valid");let i=-1;for(var j=0;j<this.mediaPillarCallContext.telephonyCallRefs.length;j++)this.mediaPillarCallContext.telephonyCallRefs[j].id===callRef.id&&(i=j);return-1!==i}replaceCallRefs(newCallRef,oldCallRef){if(null==newCallRef||null==oldCallRef)return void this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY callRef not valid");let flagNewAlreadyExist=!1,flagNewLinked=newCallRef.isMediaPillarCall(),flagOldLinked=oldCallRef.isMediaPillarCall();this.isInTelCallRefs(newCallRef)&&(flagNewAlreadyExist=!0,this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY newcallRef already existing"),this.removeTelCallRefs(newCallRef));let i=-1;for(var j=0;j<this.mediaPillarCallContext.telephonyCallRefs.length;j++)this.mediaPillarCallContext.telephonyCallRefs[j].id===oldCallRef.id&&(i=j);-1!==i?(this.mediaPillarCallContext.telephonyCallRefs[i]=newCallRef,flagOldLinked&&newCallRef.setMediaPillarCall(this.getMediaPillarCallContext()),oldCallRef.setMediaPillarCall(null),0===i&&this.$log.log("[WebrtcGatewayService] replaceCallRefs | master MP call becomes : "+this.mediaPillarCallContext.telephonyCallRefs[0].id)):(this.$log.warn("[WebrtcGatewayService] replaceCallRefs | ANOMALY oldCallRef not found"),flagNewAlreadyExist&&(this.addTelCallRefs(newCallRef),flagNewLinked&&newCallRef.setMediaPillarCall(this.getMediaPillarCallContext())))}automatonDefenseTimout(call){let actionLevel=0;if(null!=call)if(call.type.value===call_model_1.Call.Type.PHONE.value)switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition telcall call="+call.id+" evt="+call.status.value+" then timout"),call.status){case call_model_1.Call.Status.RINGING_OUTGOING:case call_model_1.Call.Status.RINGING_INCOMMING:break;default:this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(actionLevel=2)}else if(this.isMediaPillarJid(this.xmppService.getBareJidFromJid(call.fullJid)))switch(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | transition webrtc "+call.status.value+" then timout"),call.status){case call_model_1.Call.Status.ACTIVE:break;default:this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(actionLevel=3)}else this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | anomaly transition webrtc call but Not a webrtcgateway case"),actionLevel=2;else this.mediaPillarCallContext.callState!==MPCallState.CallActive&&this.mediaPillarCallContext.callState!==MPCallState.CallActiveNoWebMedia&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled&&this.mediaPillarCallContext.callState!==MPCallState.CallOffer&&this.mediaPillarCallContext.callState!==MPCallState.CallOnGoing&&(this.$log.log("[WebrtcGatewayService] automatonDefenseTimout | anomaly timout in unexpected state"),actionLevel=2);switch(0!==actionLevel&&this.$log.warn("[WebrtcGatewayService] automatonDefenseTimout | actionlevel "+actionLevel),actionLevel){case 0:break;case 1:this.TO_PILLAR_POLLING=3e5,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING);break;case 2:this.TO_PILLAR_POLLING=3e5,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.releaseMediaPillarCallContext();break;case 3:this.TO_PILLAR_POLLING=3e5,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext();break;default:this.TO_PILLAR_POLLING=3e5,this.mediaPillarAlive||this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.MediaPillarCallTerminator()}this.mediaPillarCallContext.callState!==MPCallState.Free&&(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(null)},this.TO_transition,1))}onTelCallIncomming(call){if(this.mediaPillarCallContext.telephonyCallRefs.length>1&&this.mediaPillarCallContext.callState!==MPCallState.Free&&this.mediaPillarCallContext.callState!==MPCallState.WaitTelephony&&this.mediaPillarCallContext.callState!==MPCallState.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] onTelCallIncomming | nth calls BUT trig the GUI & link the call"),call.setMediaPillarCall(this.getMediaPillarCallContext()),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_WEBRTC_GW_CALL_UPDATED_EVENT for call = "+call.id),this.mediaPillarCallContext.updateContactFlag=!0,void this.$rootScope.$broadcast("ON_WEBRTC_GW_CALL_UPDATED_EVENT",call);switch(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | mediapilaryse as necessary for call "+call.id+" date "+moment().format("HH:mm:ss:SSS")),this.mediaPillaryseTheCall(call,null)){case"Ok":if(this.stopWaitTelephonyTimeOut(),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),!this.isMediaPillarOutgoingCall()&&this.mediaPillarCallContext.callState===MPCallState.CallOffer&&this.mediaPillarCallContext.webrtcCallRef){const isPopupWithWebrtcCall=this.mediaPillarCallContext.isIncomingCallPopupWithWebRtcCall;isPopupWithWebrtcCall&&(this.$log.warn("[WebrtcGatewayService] onTelCallIncomming | Incoming tel phone while Popup displayed with Webrtc Call should happen in rare cases when csta event is very slow: use phone call info anyway for call "+call.id),this.mediaPillarCallContext.webrtcCallRef.contact=Object.assign(this.mediaPillarCallContext.webrtcCallRef.contact,call.contact),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.webrtcCallRef}));for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)(!isPopupWithWebrtcCall&&(this.mediaPillarCallContext.telephonyCallRefs[i].status===call_model_1.Call.Status.RINGING_INCOMMING||this.mediaPillarCallContext.telephonyCallRefs[i].status===call_model_1.Call.Status.QUEUED_INCOMMING)||isPopupWithWebrtcCall&&this.mediaPillarCallContext.telephonyCallRefs[i].status===call_model_1.Call.Status.QUEUED_INCOMMING)&&(this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ON_WEBRTC_GW_CALL_UPDATED_EVENT for call = "+call.id),this.mediaPillarCallContext.updateContactFlag=!0,this.$rootScope.$broadcast("ON_WEBRTC_GW_CALL_UPDATED_EVENT",this.mediaPillarCallContext.telephonyCallRefs[i]))}break;case"Update":this.stopCallStateTimeOut(),this.isMediaPillarOutgoingCall()||!this.mediaPillarCallContext.webrtcCallRef||call.status!==call_model_1.Call.Status.RINGING_INCOMMING&&call.status!==call_model_1.Call.Status.QUEUED_INCOMMING?this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore update call"):(this.$rootScope.$broadcast("ON_WEBRTC_GW_CALL_UPDATED_EVENT",call),this.$log.info("[WebrtcGatewayService] onTelCallIncomming | update call"));break;case"Ignore":this.$log.info("[WebrtcGatewayService] onTelCallIncomming | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallIncomming | media Pillar call anomaly "+status)}}onTelCallDialling(call){if(this.mediaPillarCallContext.isOutgoingCall3PCC=!0===call.isOwner,this.mediaPillarCallContext.isOutgoingCall3PCC)if(this.mediaPillarCallContext.callState===MPCallState.Free||this.mediaPillarCallContext.callState===MPCallState.WaitTelephony)switch(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.mediaPillaryseTheCall(call,null)){case"Ok":this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState===MPCallState.CallOffer&&(this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onTelCallDialling | outgoing3PCC then send webrtc proceed")),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1);break;case"Ignore":case"Update":this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignore evt");break;default:this.$log.error("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly "+status),this.MediaPillarCallTerminator()}else this.mediaPillarCallContext.callState===MPCallState.CallOffer||this.mediaPillarCallContext.callState===MPCallState.CallOnGoing?(this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, on state : "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallDialling | ignored , on state : "+this.mediaPillarCallContext.callState)):(this.$log.warn("[WebrtcGatewayService] onTelCallDialling | media Pillar call anomaly, MP context not compatible"),this.MediaPillarCallTerminator());else this.stopCallStateTimeOut(),this.$log.info("[WebrtcGatewayService] onTelCallDialling but not call owner (=>other client) | ignore evt on state : "+this.mediaPillarCallContext.callState)}onTelCallOutgoing(call){this.isMediaPillarOutgoingCall()?(this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition_long,1)):(this.$log.warn("[WebrtcGatewayService] onTelCallOutgoing | media Pillar, not a 1st 3PCC outgoing call then ignore & release MP CallContext"),this.releaseMediaPillarCallContext())}onTelCallActive(call){switch(this.mediaPillarCallContext.callState){case MPCallState.CallOnGoing:this.stopCallStateTimeOut(),call.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=MPCallState.CallActive;break;case MPCallState.TelCallReleasing:this.$log.warn("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState),this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , RE-ACTIVATION"),this.stopCallStateTimeOut(),call.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=MPCallState.CallActive;break;case MPCallState.CallActive:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar , ignore tel active on state CallActive ");break;case MPCallState.WebCallReleasing:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state WebCallReleasing then releaseMediaPillarCallContext"),this.releaseMediaPillarCallContext();break;case MPCallState.Free:this.$log.info("[WebrtcGatewayService] onTelCallActive | media Pillar recv tel active on state = 1 ; probably call taken on deskphone ; ignore active & release call context "),this.releaseMediaPillarCallContext();break;default:this.$log.info("[WebrtcGatewayService] onTelCallActive | Anomaly media Pillar recv tel active on state = "+this.mediaPillarCallContext.callState)}}onTelCallReleasing(call){this.telephonyService.getCalls().length;if(this.mediaPillarCallContext.telephonyCallRefs.length>1)return call.setMediaPillarCall(null),this.removeTelCallRefs(call),void this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- postpone mediaPillarCallContext release ;  remaining calls = "+this.mediaPillarCallContext.telephonyCallRefs.length);this.isMediaPillarReleasableCall()?(call.setMediaPillarCall(null),this.removeTelCallRefs(call),this.mediaPillarCallContext.webrtcCallRef&&this.mediaPillarCallContext.callState!==MPCallState.WebCallReleasing&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled?this.mediaPillarCallContext.callState!==MPCallState.TelCallReleasing?(this.mediaPillarCallContext.callState=MPCallState.TelCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- wait web release: state = "+this.mediaPillarCallContext.callState)):this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- ignore telrelease on state = "+this.mediaPillarCallContext.callState):this.mediaPillarCallContext.callState!==MPCallState.Free&&(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onTelCallReleasing -- "+call.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onTelCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())}onWebrtcCallIncomming(call){if(this.mediaPillarCallContext.webrtcCallRef)this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming -- "+call.id+" --- ignored other incomming");else{if(this.mediaPillarCallContext.callState===MPCallState.WebCallReleasing&&0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs[0].status!==call_model_1.Call.Status.UNKNOWN)return this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming -- "+call.id+" --- re propose during established tel call"),this.mediaPillarCallContext.webrtcCallRef=call,this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),void(this.mediaPillarCallContext.callState=MPCallState.CallOnGoing);switch(this.mediaPillaryseTheCall(null,call)){case"Ok":if(this.stopCallStateTimeOut(),(this.isMediaPillarOutgoingCall()||this.mediaPillarCallContext.callState!==MPCallState.WaitTelephony)&&(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1)),this.isMediaPillarOutgoingCall())this.videoService.answerCall(this.mediaPillarCallContext.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | outgoing3PCC then send webrtc proceed");else if(this.mediaPillarCallContext.callState===MPCallState.WaitTelephony)this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | incoming webrtc WaitTelephony : "+moment().format("HH:mm:ss:SSS")+" : arm waitTelephony_TO "),this.stopWaitTelephonyTimeOut(),this.mediaPillarCallContext.waitTelephony_TO=this.$interval(()=>{this.waitTelephonyTimeout(call)},this.TO_waitTelephony,1);else if(this.mediaPillarCallContext.callState===MPCallState.CallOffer){this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | incoming webrtc + telephony");for(var i=0;i<this.mediaPillarCallContext.telephonyCallRefs.length;i++)this.mediaPillarCallContext.telephonyCallRefs[i].status!==call_model_1.Call.Status.RINGING_INCOMMING&&this.mediaPillarCallContext.telephonyCallRefs[i].status!==call_model_1.Call.Status.QUEUED_INCOMMING||(this.$log.info("[WebrtcGatewayService] onWebrtcCallIncomming | ON_CONVERSATION_CALL_UPDATED_EVENT for call = "+this.mediaPillarCallContext.telephonyCallRefs[i].id),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:this.mediaPillarCallContext.telephonyCallRefs[i]}))}break;case"Ignore":break;default:this.$log.error("[WebrtcGatewayService] onWebrtcCallIncomming | media Pillar call anomaly "+status)}}}onWebrtcCallConnecting(call){return this.mediaPillarCallContext.callState===MPCallState.CallActive?(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnecting attempts"),this.mediaPillarCallContext.callState=MPCallState.CallActiveNoWebMedia,this.stopCallStateTimeOut(),void(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.timeOutCallActiveNoWebMedia()},this.TO_NoWebMedia,1))):this.mediaPillarCallContext.callState===MPCallState.TelCallReleasing?(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar webrtc call reconnecting while TelCallReleasing"),this.mediaPillarCallContext.callState=MPCallState.CallActiveNoWebMedia,this.stopCallStateTimeOut(),void(this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.timeOutCallActiveNoWebMedia()},this.TO_NoWebMediaNotel,1))):void 0}onWebrtcCallActive(call){this.mediaPillarCallContext.callState===MPCallState.CallActiveNoWebMedia&&(this.$log.info("[WebrtcGatewayService] onWebrtcCallConnecting -- media Pillar call reconnected"),this.mediaPillarCallContext.callState=MPCallState.CallActive,this.stopCallStateTimeOut())}onWebrtcCallAnswering(call){this.mediaPillarCallContext.callState=MPCallState.CallOnGoing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1)}onWebrtcCallReleasing(call){this.isMediaPillarReleasableCall()?(call.setMediaPillarCall(null),this.mediaPillarCallContext.webrtcCallRef=null,0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.callState!==MPCallState.TelCallReleasing&&this.mediaPillarCallContext.callState!==MPCallState.RemoteControled?this.mediaPillarCallContext.callState!==MPCallState.WebCallReleasing?(this.mediaPillarCallContext.callState=MPCallState.WebCallReleasing,this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1),this.releasePbxCallIfPbxConnectionDown(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+call.id+" -- wait tel release: state = "+this.mediaPillarCallContext.callState)):this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+call.id+" -- ignore webrelease on state = "+this.mediaPillarCallContext.callState):(this.releaseMediaPillarCallContext(),this.$log.info("[WebrtcGatewayService] onWebrtcCallReleasing -- "+call.id+" -- release MP context"))):(this.$log.warn("[WebrtcGatewayService] onWebrtcCallReleasing | media Pillar call release anomaly on state = "+this.mediaPillarCallContext.callState),this.MediaPillarCallTerminator())}waitTelephonyTimeout(call){this.mediaPillarCallContext.callState===MPCallState.WaitTelephony?(this.$log.info("[WebrtcGatewayService] waitTelephonyTimeout date "+moment().format("HH:mm:ss:SSS")+" -- "+call.id+" -- state = "+this.mediaPillarCallContext.callState+" : perform snpashot on secondary device to check remote extension's csta state"),this.telephonyService.snapshotDevice(!0).then(result=>{const connections=result.connections;this.mediaPillarCallContext.callState!==MPCallState.WaitTelephony||connections&&0!==connections.length?(this.$log.info("[WebrtcGatewayService] waitTelephonyTimeout date "+moment().format("HH:mm:ss:SSS")+" -- "+call.id+" -- state = "+this.mediaPillarCallContext.callState+" => no more waiting for phone call or existing csta call: don't display any incoming call popup"),this.stopCallStateTimeOut(),this.mediaPillarCallContext.callState_TO=this.$interval(()=>{this.automatonDefenseTimout(call)},this.TO_transition,1)):(this.$log.info("[WebrtcGatewayService] waitTelephonyTimeout date "+moment().format("HH:mm:ss:SSS")+" -- "+call.id+" -- state = "+this.mediaPillarCallContext.callState+" => still waiting for phone call and no csta call: send event to open incoming call popup with webrtc call"),this.mediaPillarCallContext.isIncomingCallPopupWithWebRtcCall=!0,this.$rootScope.$broadcast("ON_CONVERSATION_CALL_UPDATED_EVENT",{conversation:null,call:call}))}).catch(error=>{this.$log.error("[WebrtcGatewayService] waitTelephonyTimeout date "+moment().format("HH:mm:ss:SSS")+" -- "+call.id+" -- state = "+this.mediaPillarCallContext.callState+" => snpashotdevice error "+error)})):this.$log.info("[WebrtcGatewayService] waitTelephonyTimeout date "+moment().format("HH:mm:ss:SSS")+" -- "+call.id+" -- state = "+this.mediaPillarCallContext.callState+" => IGNORED"),this.mediaPillarCallContext.waitTelephony_TO=null}releasePbxCallIfPbxConnectionDown(){let activePbxCall=this.getActivePbxCall();activePbxCall&&activePbxCall.pbxConnectionDown&&(this.$log.info("[WebrtcGatewayService] releasePbxCallIfPbxConnectionDown | release call"+activePbxCall),this.telephonyService.releaseCall(activePbxCall),activePbxCall.mediaPillarCall=null)}mediaPillarMakeCall1PCC(phoneNumber,contact){this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall1PCC");const mediaPillarJid=this.getMyMediaPillarJid();if(!this.mediaPillarConfigured||!this.mediaPillarAlive)return this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall1PCC ANOMALY webrtcgateway not available"),null;if(this.videoService.makingCall=!0,""!==mediaPillarJid){const id="web_"+uuid4();if(!contact||null===contact){const call=call_model_1.Call.create(call_model_1.Call.Status.DIALING,id,call_model_1.Call.Type.WEBRTC,this.mediaPillarContact);return call.fullJid=mediaPillarJid,this.mediaPillarStartCall(call,phoneNumber,mediaPillarJid),call}const call=call_model_1.Call.create(call_model_1.Call.Status.DIALING,id,call_model_1.Call.Type.WEBRTC,contact);return call.fullJid=mediaPillarJid,this.mediaPillarStartCall(call,phoneNumber,mediaPillarJid),call}return this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY no mediaPillarJid"),null}mediaPillarReleaseCall1PCC(call){if(this.$log.info("[WebrtcGatewayService] mediaPillarReleaseCall1PCC"),this.mediaPillarConfigured){var foundCall=this.videoService.calls[call.id];foundCall&&foundCall.type===call_model_1.Call.Type.WEBRTC?this.videoService.rejectCall(foundCall):this.$log.info("[WebrtcGatewayService] mediaPillarReleaseCall1PCC ANOMALY invalid call")}else this.$log.info("[WebrtcGatewayService] mediaPillarReleaseCall1PCC ANOMALY webrtcgateway not available")}mediaPillarMakeCall(phoneNumber,contact){this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall");let mediaPillarJid=this.getMyMediaPillarJid();if(phoneNumber.length>6&&contact&&(phoneNumber=contact.phonePbx),this.videoService.makingCall=!0,""!==mediaPillarJid){var call,id="web_"+uuid4();if(contact&&null!==contact)(call=call_model_1.Call.create(call_model_1.Call.Status.DIALING,id,call_model_1.Call.Type.WEBRTC,contact)).fullJid=mediaPillarJid,this.mediaPillarStartCall(call,phoneNumber,mediaPillarJid);else(call=call_model_1.Call.create(call_model_1.Call.Status.DIALING,id,call_model_1.Call.Type.WEBRTC,this.mediaPillarContact)).fullJid=mediaPillarJid,this.mediaPillarStartCall(call,phoneNumber,mediaPillarJid)}else this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY no mediaPillarJid")}mediaPillarStartCall(call,phoneNumber,mediaPillarJid){this.$log.info("[WebrtcGatewayService] mediaPillarStartCall for phone number "+phoneNumber),this.initiateMediaPillarCall(call).then(()=>{this.dummyRegisterMediaPillarCall().then(()=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall for number "+phoneNumber),this.videoService.makeJingleCall(call,mediaPillarJid,phoneNumber)}).catch(error=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY dummyRegisterMediaPillarCall then abort call"),this.abortCall(call)})}).catch(error=>{this.$log.info("[WebrtcGatewayService] mediaPillarMakeCall ANOMALY initiateMediaPillarCall then abort call"),this.abortCall(call)})}abortCall(call){this.videoService.makingCall=!1,call&&this.videoService.removeCallObject(call),this.videoService.resetToSafeState()}initiateMediaPillarCall(call){return this.$q((resolve,reject)=>{this.$log.info("[WebrtcGatewayService] initiateMediaPillarCall");var mediaToGet=["audio"];this.videoService.getBrowserMedia(mediaToGet).then(stream=>{call.isInitiator=!0,this.videoService.localStreams.push(stream),this.videoService.calls[call.id]=call,call.localMedia=call.localMedia|call_model_1.Call.Media.AUDIO,this.contactService.setBusyState("dnd",this.videoService.calculatePresenceMessage(call)),this.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),resolve()}).catch(error=>{this.$log.info("[WebrtcGatewayService]   | initate call failure : "+JSON.stringify({error:error.message})),mediaToGet.indexOf("sharing")>=0||-1===error.toString().indexOf("getUserMedia")||this.videoService.openErrorPopup(),reject(error)})})}dummyRegisterMediaPillarCall(){return this.$q((resolve,reject)=>{var xmppIq=$iq({from:this.myContact.fullJid,to:this.mediaPillarCallContext.mediaPillarJid,type:"set"}).c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("register").c("jidIm").t(this.contactService.userContact.jid).up().c("jidTel").t(this.contactService.userContact.jidtel).up().c("number").t(this.mediaPillarCallContext.rainbowPhoneNumber).up().c("displayName").t(this.myContact.displayName).up().c("secret").t(this.mediaPillarCallContext.rainbowPhoneNumber).up();this.xmppService.sendIQ(xmppIq).then(data=>{resolve()}).catch(error=>{this.IsMediaPillarUserSelected()&&this.$log.warn("[WebrtcGatewayService] dummyRegisterMediaPillarCall -- register failure -- "+error.message),reject(error)})})}getMediaPillarData(){return this.telephonyService.isSipWise()?this.$q((resolve,reject)=>{var reqUrl=this.telephonyService.telephonyServiceSipWise.getPortalURLSipWise()+"devices";this.$log.info("[WebrtcGatewayService] getMediaPillarData sipwise device GET "+reqUrl),this.$http({method:"GET",url:reqUrl,headers:this.authService.getRequestHeader()}).then(response=>{let that=this;this.$log.log("[WebrtcGatewayService] getMediaPillarData sipwise success/ status : "+response.statusText);let respData=response.data,jid="";respData?(respData.forEach((function(device){"webrtc"===device.type&&(that.mediaPillarCallContext.rainbowPhoneNumber=device.deviceId,that.mediaPillarCallContext.remoteExtension=device.deviceId,jid=device.jid_wrg,jid&&-1===jid.indexOf("/")&&(jid+="/mediapillar"))})),""!==jid?resolve(jid):(that.$log.error("[WebrtcGatewayService] getMediaPillarData sipwise success -- missing jid_wrg"),reject(new Error("[WebrtcGatewayService] getMediaPillarData sipwise -- missing jid_wrg in response")))):(that.$log.error("[WebrtcGatewayService] getMediaPillarData sipwise success -- missing data"),reject(new Error("[WebrtcGatewayService] getMediaPillarData sipwise -- missing data in response")))}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$log.info("[WebrtcGatewayService] getMediaPillarData sipwise error -- "+error.message),reject(error)})}):this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.portalURL+"/data",headers:this.authService.getRequestHeader()}).then(response=>{if(this.$log.log("[WebrtcGatewayService] getMediaPillarData success"),response.data&&response.data.data){let prefix=response.data.data.prefix,rainbowPhoneNumber=response.data.data.rainbowPhoneNumber;prefix&&rainbowPhoneNumber&&(this.mediaPillarCallContext.rainbowPhoneNumber=rainbowPhoneNumber,this.mediaPillarCallContext.remoteExtension=prefix+rainbowPhoneNumber);let jid=response.data.data.jid_im;jid&&-1===jid.indexOf("/")&&(jid+="/mediapillar"),resolve(jid)}else this.$log.error("[WebrtcGatewayService] getMediaPillarData success -- missing data"),reject(new Error("[WebrtcGatewayService] getMediaPillarData -- missing data in response"))}).catch(errorResponse=>{let error=this.errorHelperService.handleError(errorResponse);this.$log.info("[WebrtcGatewayService] getMediaPillarData error -- "+error.message),reject(error)})})}mediaPillarKeepAlivePolling(cmd,timer){if(this.started)switch(cmd){case"START":this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&(this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null),this.mediaPillarCallContext.keepAlive_TO=this.$interval(()=>{this.mediaPillarKeepAlive()},timer,1);break;case"STOP":this.mediaPillarCallContext&&this.mediaPillarCallContext.keepAlive_TO&&this.$interval.cancel(this.mediaPillarCallContext.keepAlive_TO),this.mediaPillarCallContext.keepAlive_TO=null;break;default:this.$log.error("[WebrtcGatewayService] mediaPillarKeepAlivePolling cmd error : "+cmd)}}mediaPillarUserSelectAndPolling(selected){this.started&&(this.$log.log("[WebrtcGatewayService] mediaPillarUserSelectAndPolling : "+selected),selected?(this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.mediaPillarKeepAlive()):this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("STOP",0))}mediaPillarKeepAlive(){if(this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive"),this.mediaPillarKeepAliveSuspend)this.$log.info("[WebrtcGatewayService] KeepAlive suspended");else{let newSampleMediaPillarState=!1;this.dummyRegisterMediaPillarCall().then(()=>{newSampleMediaPillarState=!0,this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is UP")}).catch(error=>{newSampleMediaPillarState=!1,this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive webrtcgateway is DOWN")}).finally(()=>{this.mediaPillarAlive!==newSampleMediaPillarState&&(this.mediaPillarAlive=newSampleMediaPillarState,this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive),this.$log.info("[WebrtcGatewayService] mediaPillarKeepAlive ON_WEBRTCGATEWAY_STATE_CHG")),this.mediaPillarAlive?this.TO_PILLAR_POLLING<9e5?this.TO_PILLAR_POLLING+=1800:this.TO_PILLAR_POLLING=9e5:(this.TO_PILLAR_POLLING=3e5,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING)),this.IsMediaPillarUserSelected()&&this.mediaPillarAlive&&this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING)})}}forceMPpooling(){this.started&&(this.$log.log("[WebrtcGatewayService] forceMPpooling "),this.TO_PILLAR_POLLING=3e5,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$rootScope.$broadcast("ON_WEBRTCGATEWAY_STATE_CHG",this.mediaPillarAlive))}getMyMediaPillarJid(){return this.$log.info("[WebrtcGatewayService] getMyMediaPillarJid : "+this.mediaPillarCallContext.mediaPillarJid),this.mediaPillarCallContext.mediaPillarJid}getMyMediaPillarRemoteExtension(){if(this.telephonyService.isSipWise()){var webrtc=this.telephonyService.telephonyServiceSipWise.getDevicesIdFromListSipWiseWithType("webrtc");return webrtc||""}return this.mediaPillarCallContext.remoteExtension}shouldUseMediaPillar(){this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected();return void 0!==config.devMediaPillarEnabled&&config.devMediaPillarEnabled||!1,!1}isMediaPillarConfigured(){return this.mediaPillarConfigured&&this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.TELEPHONY_WEBRTC_PSTN_CALLING)}isMediaPillarAvailable(){var available=this.isMediaPillarConfigured();return available=available&&this.mediaPillarAlive}IsMediaPillarUserSelected(){var selected;if(this.telephonyService.isSipWise()){var current=this.telephonyService.telephonyServiceSipWise.getCurrentFromDevicesListSipWise();selected=current&&"webrtc"===current.type}else selected=!this.telephonyService.nomadicObject.makeCallInitiatorIsMain&&this.telephonyService.getNomadicDestination()===this.getMyMediaPillarRemoteExtension();return selected}isMediaPillarJid(fromJid){let indexMPinJid=-1;return!!fromJid&&(indexMPinJid=fromJid.search("mp_"),0===indexMPinJid)}isMediaPillarCallCase(){return this.isMediaPillarAvailable()&&this.IsMediaPillarUserSelected()}isMediaPillarCallSituation(call=null){var MP_situation=this.isMediaPillarCallCase();if(call)if(call.type===call_model_1.Call.Type.WEBRTC)MP_situation=MP_situation&&this.isMediaPillarJid(call.fullJid);else if(this.telephonyService.getCalls().length<=1&&this.mediaPillarCallContext.telephonyCallRefs.length<=1)switch(call.status){case call_model_1.Call.Status.RINGING_INCOMMING:case call_model_1.Call.Status.RINGING_OUTGOING:case call_model_1.Call.Status.QUEUED_INCOMMING:case call_model_1.Call.Status.DIALING:case call_model_1.Call.Status.RELEASING:break;default:MP_situation=!!call.mediaPillarCall&&(MP_situation&&this.isInTelCallRefs(call))}else switch(call.status){case call_model_1.Call.Status.RINGING_INCOMMING:case call_model_1.Call.Status.RINGING_OUTGOING:case call_model_1.Call.Status.QUEUED_INCOMMING:case call_model_1.Call.Status.DIALING:case call_model_1.Call.Status.RELEASING:break;default:MP_situation=!!call.mediaPillarCall&&((MP_situation=MP_situation&&call.mediaPillarCall.telephonyCallRefs.length>=1)&&this.isInTelCallRefs(call))}return MP_situation}mediaPillaryseTheCall(telephonyCall,webrtcCall){if(this.mediaPillarCallContext.callState!==MPCallState.Free){if(telephonyCall&&this.mediaPillarCallContext.updateContactFlag)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall | only Update"),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()),"Update";if(telephonyCall&&this.mediaPillarCallContext.callState===MPCallState.TelCallReleasing&&telephonyCall.status===call_model_1.Call.Status.RINGING_INCOMMING)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall |  transfer managed as Update"),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()),this.mediaPillarCallContext.callState=MPCallState.CallOffer,"Update";if(webrtcCall&&this.mediaPillarCallContext.callState!==MPCallState.WaitWebrtc)return this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall | only Ignore"),"Ignore"}var status="";if(!telephonyCall&&!webrtcCall)return"NoCallRef";if(telephonyCall&&webrtcCall)return"toManyCallRef";if(telephonyCall){switch(this.mediaPillarCallContext.callState){case MPCallState.Free:this.mediaPillarCallContext.callState=MPCallState.WaitWebrtc,status="Ok";break;case MPCallState.WaitTelephony:this.mediaPillarCallContext.callState=MPCallState.CallOffer,status="Ok";break;case MPCallState.WaitWebrtc:this.mediaPillarCallContext.telephonyCallRefs.length>1?(this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall but 2nd incomming in WaitWebrtc| only Ignore"),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()),status="Ignore"):this.telephonyService.isSipWise()?this.$log.info("[WebrtcGatewayService] multiple mediaPillaryseTheCall but sipwise case | only Ignore"):(this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,status="Ano_inTel_contextCallState_"+this.mediaPillarCallContext.callState,this.$log.info("[WebrtcGatewayService] mediaPillaryseTheCall again in WaitWebrtc"));break;default:this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,status="Ano_inTel_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"===status&&(this.putAsMasterTelCallRefs(telephonyCall),telephonyCall.setMediaPillarCall(this.getMediaPillarCallContext()))}else if(webrtcCall){switch(this.mediaPillarCallContext.webrtcCallRef=webrtcCall,this.mediaPillarCallContext.callState){case MPCallState.Free:this.mediaPillarCallContext.callState=MPCallState.WaitTelephony,status="Ok";break;case MPCallState.WaitWebrtc:this.mediaPillarCallContext.callState=MPCallState.CallOffer,status="Ok";break;default:this.mediaPillarCallContext.callState=MPCallState.AnomalyCCS,status="Ano_inWrtc_contextCallState_"+this.mediaPillarCallContext.callState}"Ok"===status&&webrtcCall.setMediaPillarCall(this.getMediaPillarCallContext())}return status}getMediaPillarCallContext(){return this.mediaPillarCallContext}isMediaPillarOutgoingCall(){var compatibleCallState;switch(this.mediaPillarCallContext.callState){case MPCallState.WaitWebrtc:case MPCallState.WaitTelephony:case MPCallState.CallOffer:case MPCallState.CallOnGoing:case MPCallState.CallActive:case MPCallState.CallActiveNoWebMedia:case MPCallState.TelCallReleasing:case MPCallState.WebCallReleasing:compatibleCallState=!0;break;default:compatibleCallState=!1}return compatibleCallState&&this.mediaPillarCallContext.isOutgoingCall3PCC}isMediaPillarReleasableCall(){var compatibleCallState;switch(this.mediaPillarCallContext.callState){case MPCallState.AnomalyCCS:case MPCallState.Unknow:compatibleCallState=!1;break;default:compatibleCallState=!0}return compatibleCallState}MediaPillarReleaseWebrtcCall(){this.mediaPillarCallContext.webrtcCallRef&&(this.mediaPillarCallContext.webrtcCallRef.mediaPillarCall=null,this.videoService.releaseCall(this.mediaPillarCallContext.webrtcCallRef))}timeOutCallActiveNoWebMedia(){this.$log.info("[WebrtcGatewayService] timeOutCallActiveNoWebMedia"),this.mediaPillarCallContext.callState===MPCallState.CallActiveNoWebMedia&&(this.MediaPillarCallTerminator(),this.mediaPillarKeepAlive(),this.$log.info("[WebrtcGatewayService] timeOutCallActiveNoWebMedia noWebMedia then release calls if existing & force keepalive"))}MediaPillarCallTerminator(){0!==this.mediaPillarCallContext.telephonyCallRefs.length&&this.mediaPillarCallContext.telephonyCallRefs.forEach(callRef=>{null!==callRef&&callRef.type.value===call_model_1.Call.Type.PHONE.value&&(callRef.mediaPillarCall=null,this.telephonyService.releaseCall(callRef),this.$log.info("[WebrtcGatewayService] MediaPillarCallTerminator | release call"+callRef))}),this.MediaPillarReleaseWebrtcCall(),this.releaseMediaPillarCallContext(),this.resetEvtAutomaton(),this.TO_PILLAR_POLLING+=3e5,this.mediaPillarKeepAlivePolling("START",this.TO_PILLAR_POLLING),this.$log.warn("[WebrtcGatewayService] MediaPillarCallTerminator | Full cleaning")}createMediaPillarContact(jid){this.$log.info("[webrtcGatewayService] createMediaPillarContact -- "+jid);const contact=this.contactService.createBasicContact(jid);return contact.displayName="mediaPillar",contact.avatar=new Image,contact.avatar.src="/resources/skins/rainbow/images/conversations/unknownUser.jpeg",this.xmppService.getResourceFromJid(jid)&&this.contactService.createBasicContact(this.xmppService.getBareJidFromJid(jid)),contact}muteAudio(pbxCall,muted,conversation){if(pbxCall){if(this.isMediaPillarCallCase()){let webrtcCall=this.mediaPillarCallContext.webrtcCallRef;if(webrtcCall){var session=this.xmppService.connection.jingle.sessions[webrtcCall.id];if(session){session.muteAudio(muted),webrtcCall.isMuted=muted,conversation&&(conversation.isMutedAudio=muted,conversation.rxSubject.next({name:"callUpdate",value:pbxCall})),pbxCall.isMuted=muted,this.$log.info("[webrtcGatewayService] muteAudio conversation: "+(conversation?conversation.id:"undefined")+" / pbxcall: "+pbxCall.id+"-- "+(muted?"mute":"unumute"));let eventData={call:pbxCall};conversation&&(eventData.conversation=conversation),this.$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",eventData),this.$rootScope.$broadcast("ON_MPMEDIA_CONVERSATION_CALL_UPDATED_EVENT",{call:webrtcCall})}else this.$log.error("[webrtcGatewayService] muteAudio "+pbxCall.id+" -- failure: no session")}}}else this.$log.error("[webrtcGatewayService] muteAudio - trying to mute a non existing call !")}getActivePbxCall(){return this.isMediaPillarCallCase()&&this.mediaPillarCallContext?this.mediaPillarCallContext.telephonyCallRefs.find(pxbCall=>pxbCall.status===call_model_1.Call.Status.ACTIVE):null}answerCall(call){const mediaPillarCall=call.getMediaPillarCall();if(mediaPillarCall&&mediaPillarCall.webrtcCallRef)this.videoService.answerCall(mediaPillarCall.webrtcCallRef,"audio"),this.$log.info("[WebrtcGatewayService] -- answerCall -- send webrtc proceed for call : "+call.id);else if(call.status===call_model_1.Call.Status.QUEUED_INCOMMING){let that=this;this.telephonyService.answerCall(call).catch((function(){that.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})),this.$log.info("[WebrtcGatewayService] -- answerCall -- "+call.id)}else this.$log.info("[WebrtcGatewayService] -- answerCall -- Anomaly media Pillar : answerAudioAction but no webrtcCallref & no 2nd call")}releaseCall(call){const mediaPillarCall=call.getMediaPillarCall();if(mediaPillarCall&&mediaPillarCall.webrtcCallRef)if(call.type===call_model_1.Call.Type.PHONE){this.$log.info("[WebrtcGatewayService] -- releaseCall MP PHONE -- "+call.id),this.isMasterTelCallRefs(call)&&(this.$log.info("[WebrtcGatewayService] -- rejectCall MP webrtc call -- "+mediaPillarCall.webrtcCallRef),this.videoService.rejectCall(mediaPillarCall.webrtcCallRef));let that=this;this.telephonyService.releaseCall(call).catch((function(){call.setStatus(call_model_1.Call.Status.UNKNOWN),that.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}))}else this.$log.info("[WebrtcGatewayService] -- releaseCall MP WEBRTC -- "+call.id),this.videoService.rejectCall(mediaPillarCall.webrtcCallRef);else{this.$log.info("[WebrtcGatewayService] releaseCall | Anomaly media Pillar : declineAction but no webrtcCallref for call = "+call.id);let that=this;this.telephonyService.releaseCall(call).catch((function(){call.setStatus(call_model_1.Call.Status.UNKNOWN),that.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}))}}deflectCallToVm(call){let that=this;this.telephonyService.deflectCallToVM(call).finally(()=>{if(call.type===call_model_1.Call.Type.PHONE){const mediaPillarCall=call.getMediaPillarCall();mediaPillarCall&&mediaPillarCall.webrtcCallRef&&that.videoService.rejectCall(mediaPillarCall.webrtcCallRef),call.setStatus(call_model_1.Call.Status.UNKNOWN),that.$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)}})}}exports.WebrtcGatewayService=WebrtcGatewayService,WebrtcGatewayService.$inject=["$q","$rootScope","$log","$http","$interval","videoService","errorHelperService","telephonyService"],angular.module("rainbow").service("webrtcGatewayService",WebrtcGatewayService)},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var rxjs__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23),_src_models_event_model__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(24),_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(0),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(5),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3__),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4__),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5__),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_6__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7__);angular.module("rainbow").service("videoService",["$q","$rootScope","$window","$log","$http","$interval","browserService","gRTCStatsService","fRTCStatsService","platformService","gaService","VideoServiceEventHandler","extensionSharingService",function($q,$rootScope,$window,$log,$http,$interval,browserService,gRTCStatsService,fRTCStatsService,platformService,gaService,VideoServiceEventHandler,extensionSharingService){var that=this;this.started=!1,this.connected=!1,this.RTC=null,this.videoEventHandler=null,this.config=null,this.companyConfig=null,this.calls={},this.localStream=null,this.autoreleaseTimeout=null,this.callsStats={},this.localStreams=[],this.makingCall=!1,this.reconnectCall=!1,this.statsInterval=null,this.audioProfileChanging=!1,this.reverseAudioCallInitiated=!1,this.alreadyAttaching=!1,this.ttl=0,this.ttlTimeout=null,this.xmppConnectionSubscription=null;var listeners=[];this.rxSubject=new rxjs__WEBPACK_IMPORTED_MODULE_0__.a,this.callsStatsSimplified={},this.allowDesktopSharing=function(){return!1},this.allowAdvancedDesktopSharing=function(){return!1},this.getDesktopSharingSource=function(){return null},this.askToAddSharing=function(__conversation_id){return!1},this.askToStartSharing=function(__contact_id,__media){return!1},this.isNativeApplication=function(){return!1},this.subscribe=function(handler){return this.rxSubject.subscribe(handler)},this.sendEvent=function(name){var data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.rxSubject.next(_src_models_event_model__WEBPACK_IMPORTED_MODULE_1__.RBEvent.create(name,data))},this.start=function(stats){$log.webrtc("[videoService] SERVICE | === STARTING ===");var startDate=performance.now();if(this.RTC=that.getBrowserMethodHandler(),this.RTC){that.started=!0,that.connected=!0,that.setWebrtcConfiguration();var startDuration=Math.round(performance.now()-startDate);stats.push({service:"videoService",startDuration:startDuration}),$log.info("[videoService] SERVICE | === STARTED ("+startDuration+" ms) ===")}else $log.error("[videoService] SERVICE | === STARTING FAILURE ===  webRTC capable browser is really required !");return this.xmppConnectionSubscription=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.subscribeToConnectionEvents((function(event){that.onConnectionStateChangeEvent(event)})),listeners.push($rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",that.onAudioProfileChangeEvent)),listeners.push($rootScope.$on("ON_VIDEO_INPUT_DEVICE_CHANGED_EVENT",that.onVideoInputChangeEvent)),this.attachHandlers(),$q.when()},this.stop=function(){try{if(this.started){var listener;for($log.webrtc("[videoService] SERVICE | === STOPPING ==="),this.started=!1,this.xmppConnectionSubscription&&this.xmppConnectionSubscription.unsubscribe();listener=listeners.pop();)listener();for(var key in that.removeHandlers(),that.config=null,that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];that.removeCallObject(call)}_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.terminate(),that.connected=!1,that.reconnectCall=!1,that.makingCall=!1,that.statsInterval&&window.clearInterval(that.statsInterval),that.ttlTimeout&&$interval.cancel(that.ttlTimeout),$log.webrtc("SERVICE | === STOPPED ===")}return $q.when()}catch(error){return $log.webrtc("[videoService] SERVICE | === STOPPING ERROR : "+error),$q.when()}},this.attachHandlers=function(){this.removeHandlers(),$log.info("[videoService] attachHandlers"),this.videoEventHandler=VideoServiceEventHandler.create(this)},this.removeHandlers=function(){$log.info("[videoService] removeHandlers"),this.videoEventHandler&&(this.videoEventHandler=null)},this.setIceConfig=function(){return $log.webrtc("[videoService] setIceConfig"),$q((function(resolve,reject){if(that.config&&0!==that.ttl)return $log.webrtc("[videoService] setIceConfig from stored variable"),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.ice_config=that.config,resolve();that.getIceConfig().then((function(config){that.config=config,"true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.getSetting("enableDSCP")&&($log.webrtc("[videoService] setWebrtcConfiguration - DSCP is enabled"),that.config.enableDSCP=!0),"true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.getSetting("dtx")&&($log.webrtc("[videoService] setWebrtcConfiguration - DTX is enabled"),that.config.dtx=!0);var simulcast="true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.getSetting("simulcast");(simulcast=simulcast||_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_6___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_6___default.a.FeaturesEnum.WEBRTC_CONFERENCE_SIMULCAST))&&($log.webrtc("[videoService] setWebrtcConfiguration - Simulcasting is enabled"),that.config.simulcast=!0),"true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.getSetting("unifiedPlan")&&($log.webrtc("[videoService] setWebrtcConfiguration - unifiedPlan is enabled"),that.config.unifiedPlan=!0),"true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.getSetting("debugWebRTC")&&($log.webrtc("[videoService] setWebrtcConfiguration - unifiedPlan is enabled"),that.config.debugWeRTC=!0),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.ice_config=that.config,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.setIceConfig(that.config),$log.webrtc("[videoService] setIceConfig from server success !"),resolve()})).catch((function(error){$log.error("[videoService] setIceConfig from server ERROR : "+error),-1!==error.status&&that.openErrorPopup("IceConfigurationFailed"),reject()}))}))},this.setCompanyWebrtcConfig=function(){return $log.webrtc("[videoService] setCompanyWebrtcConfig"),$q((function(resolve,reject){if(that.companyConfig)return $log.webrtc("[videoService] setCompanyWebrtcConfig from stored variable"),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.company_config=that.companyConfig,that.setVideoQualityConfigurationForCompany(),resolve();that.getCompanyWebrtcConfig().then((function(config){that.companyConfig=config,_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.company_config=that.companyConfig,that.setVideoQualityConfigurationForCompany(),$log.webrtc("[videoService] setCompanyWebrtcConfig from server success !"),resolve()})).catch((function(error){$log.error("[videoService] setCompanyWebrtcConfig from server ERROR : "+error),reject()}))}))},this.setWebrtcConfiguration=function(){return $q((function(resolve){var promises=[];promises.push(that.setIceConfig()),promises.push(that.setCompanyWebrtcConfig()),$q.all(promises).then((function(){$log.webrtc("[videoService] setWebrtcConfiguration -- done"),resolve()}))}))},this.onConnectionStateChangeEvent=function(event){try{if("ON_XMPP_DISCONNECTED"===event.name){for(var key in $log.info("MEDIA   | onConnectionStateChangeEvent : disconnected"),that.connected=!1,that.config=null,that.ttlTimeout&&$interval.cancel(that.ttlTimeout),that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];that.reconnectCall=!0,call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN&&($log.webrtc("INFO    | onConnectionStateChangeEvent : disconnected -> call goes to connecting state"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.CONNECTING),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),that.statsInterval&&window.clearInterval(that.statsInterval)}}else if("ON_XMPP_CONNECTED"===event.name){for(var key in $log.info("MEDIA   | onConnectionStateChangeEvent : connected"),that.attachHandlers(),that.setWebrtcConfiguration(),that.connected=!0,that.statsInterval&&(window.clearInterval(that.statsInterval),that.statsinterval=null),that.calls)if(that.calls.hasOwnProperty(key)){call=that.calls[key];var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];that.reconnectCall&&session&&session.peerconnection&&($log.info("MEDIA   | onConnectionStateChangeEvent : connected - start reconnection on session "+call.id),session.me=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.userContact.fullJid,session.isInitiator&&(session.initiator=session.me),session.connection=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.setBusyState("dnd",that.calculatePresenceMessage(call)),session.reconnectSession())}that.reconnectCall=!1}}catch(error){$log.info("MEDIA   | onConnectionStateChangeEvent : disconnected error : "+error)}},that.isUserContactInCall=function(){for(var key in that.calls){if(that.calls.hasOwnProperty(key))if(that.calls[key].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN)return!0}return!1},this.getCurrentActiveCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN)return call}return null},this.getCurrentActiveSession=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN)return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id]}return null},that.getMediaPillarAudioCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO&&call.isMediaPillarCall())return call}return null},that.getWebrtcAudioCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO&&!call.isMediaPillarCall())return call}return null},that.getMediaPillarSession=function(){var mediaPillarAudioCall=that.getMediaPillarAudioCall();return mediaPillarAudioCall?_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[mediaPillarAudioCall.id]:null},that.getCurrentSharingCall=function(){for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN&&(call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING||call.remoteMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING))return call}return null},that.endAllCallsForContact=function(contact){if(contact)for(var key in $log.webrtc("[videoService] endAllCallsForContact "+contact.jid),that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN&&call.contact&&call.contact.jid===contact.jid&&!call.isMediaPillarCall()&&that.releaseCall(call)}},that.onVideoInputChangeEvent=function(){for(var key in $log.webrtc("MEDIA   | onVideoInputChangeEvent"),that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id]&&call.localMedia&&call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&($log.webrtc("MEDIA   | audio + video call, renegotiate the profile"),that.escalateToVideoCall(call,!0))}},that.onAudioProfileChangeEvent=function(){if($log.webrtc("MEDIA   | onAudioProfileChangeEvent"),that.audioProfileChanging)$log.webrtc("MEDIA   | onAudioProfileChangeEvent -- already changing");else for(var key in that.calls)if(that.calls.hasOwnProperty(key)){var call=that.calls[key];_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id]&&call.localMedia&&(that.audioProfileChanging=!0,$interval((function(currentCall){that.audioProfileChanging=!1,that.renegotiateCurrentCall(currentCall)}),500,1,!0,call))}},this.renegotiateCurrentCall=function(call){call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO||call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING?($log.webrtc("MEDIA   | renegotiate the audio profile"),that.addAudioToCall(call,!0)):call.localMedia!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&call.localMedia!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO+_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING+_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO||($log.webrtc("MEDIA   | audio + video call, renegotiate the profile"),that.addVideoToCall(call,!0))},this.getCallByJid=function(contactJid,fullJid){var result=null;if(!contactJid&&!fullJid)return result;for(var key in $log.webrtc("[videoService] getCallByJid "+contactJid),that.calls){if(that.calls.hasOwnProperty(key))if((call=that.calls[key]).contact&&call.contact.jid===contactJid){result=call;break}}if(!result)for(var key in $log.webrtc("[videoService] getCallByJid fallback "+fullJid),that.calls){var call;if(that.calls.hasOwnProperty(key))if((call=that.calls[key])&&call.fullJid===fullJid){result=call;break}}return result},this.resetAudioOutputElement=function(){platformService.allowDevicesManagement()&&!this.audioProfileChanging&&($("#globalAudioTag").length?($log.webrtc("[videoService] resetAudioOutputElement"),this.audioProfileChanging=!0,platformService.getCurrentSpeaker().then((function(device){var sinkId="default";device&&device.id&&(sinkId=device.id);var anotherSink="default";"default"!==sinkId&&DetectRTC.audioOutputDevices.forEach((function(output){"default"!==output.deviceId&&"communications"!==output.deviceId&&output.deviceId!==sinkId&&(anotherSink=output.deviceId)})),$("#globalAudioTag")[0].setSinkId(anotherSink).then((function(){$log.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),"default"!==sinkId?$("#globalAudioTag")[0].setSinkId(sinkId).then((function(){$log.webrtc("[videoService] resetAudioOutputElement sinkId is "+$("#globalAudioTag")[0].sinkId),that.audioProfileChanging=!1,$("#globalAudioTag")[0].load&&$("#globalAudioTag")[0].load()})).catch((function(){that.audioProfileChanging=!1})):that.audioProfileChanging=!1})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement globalAudioTag error "+error),that.audioProfileChanging=!1})),$interval((function(){$("#largevideo")[0]&&$("#largevideo")[0].setSinkId(anotherSink).then((function(){$log.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId),"default"!==sinkId&&$("#largevideo")[0].setSinkId(sinkId).then((function(){$log.webrtc("[videoService] resetAudioOutputElement largevideo "+$("#largevideo")[0].sinkId)})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement largevideo error "+error)}))})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement largevideo error "+error)})),$("#p2pSecondVideo")[0]&&$("#p2pSecondVideo")[0].setSinkId(anotherSink).then((function(){"default"!==sinkId&&$("#p2pSecondVideo")[0].setSinkId(sinkId).then((function(){$log.webrtc("[videoService] resetAudioOutputElement p2pSecondVideo "+$("#p2pSecondVideo")[0].sinkId)})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+error)}))})).catch((function(error){$log.warn("[videoService] resetAudioOutputElement p2pSecondVideo error "+error)}))}),3e3,1)})).catch((function(){$log.webrtc("[videoService] resetAudioOutputElement getCurrentSpeaker error"),that.audioProfileChanging=!1}))):$log.warn("[videoService] resetAudioOutputElement -- missing global audio tag !"))},this.disableStreams=function(streams){if(streams&&streams.length)for(streams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null}));streams.length>0;){streams.pop();null}},this.disableAudioVideoMedia=function(session,sessionId){if(session?$log.webrtc("MEDIA   | disableAudioVideoMedia for session "+JSON.stringify({sid:session.sid})):sessionId?$log.webrtc("MEDIA   | disableAudioVideoMedia no session, sessionId: "+sessionId):$log.webrtc("MEDIA   | disableAudioVideoMedia no session, no session Id"),!session&&!sessionId){var localStreamsLength=that.localStreams.length;if(that.localStreams.length>0)for(that.localStreams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null}));that.localStreams.length>0;){that.localStreams.pop();null}$log.webrtc("MEDIA   | disableAudioVideoMedia : All local streams stopped and removed: "+localStreamsLength)}if(session){if(session.localStreams.length>0){var sessionStreamsLength=session.localStreams.length;for(session.localStreams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null})),that.localStreams=that.localStreams.filter((function(localStream){return!session.localStreams.includes(localStream)}));session.localStreams.length>0;){session.localStreams.pop();null}$log.webrtc("MEDIA   | disableAudioVideoMedia : Session streams stopped and removed: "+sessionStreamsLength+". Remaining local streams: "+that.localStreams.length)}}else if(sessionId){var streams=that.localStreams.filter((function(localStream){return localStream.callId===sessionId}));if(streams){sessionStreamsLength=streams.length;streams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),that.localStreams.splice(that.localStreams.indexOf(stream),1),stream=null})),$log.webrtc("MEDIA   | disableAudioVideoMedia : Locals streams for sessionId "+sessionId+" stopped and removed: "+sessionStreamsLength+". Remaining local streams: "+that.localStreams.length)}}that.statsInterval&&(window.clearInterval(that.statsInterval),that.statsinterval=null)},this.clearSrcObjectsFromElements=function(){this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.clearMediaStream(angular.element("#globalAudioTag"),null)},this.attachDistantMediaStreamsUnifiedPlan=function(call){var sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];sess?(sess.remoteStreamsObject[0]&&($log.webrtc("attachDistantMediaStreamsUnifiedPlan audio track for element globalAudioTag "+sess.remoteStreamsObject[0].id),this.RTC.attachMediaStream(angular.element("#globalAudioTag"),sess.remoteStreamsObject[0])),sess.remoteStreamsObject[1]&&sess.remoteStreamsObject[2]?(this.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sess.remoteStreamsObject[2],sess.remoteStreamsObject[2].id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),this.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),sess.remoteStreamsObject[1],sess.remoteStreamsObject[1].id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)):sess.remoteStreamsObject[1]?(this.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sess.remoteStreamsObject[1],sess.remoteStreamsObject[1].id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)):sess.remoteStreamsObject[2]&&(this.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sess.remoteStreamsObject[2],sess.remoteStreamsObject[2].id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0))):$log.warn("[videoService] attachDistantMediaStreamsUnifiedPlan -- missing session "+call.id)},this.attachDistantMediaStreams=function(attach,call){if(attach){if(that.alreadyAttaching)return;if(that.alreadyAttaching=!0,call.unifiedPlanActivated)return that.attachDistantMediaStreamsUnifiedPlan(call),void(that.alreadyAttaching=!1);var sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];if(null==sess)return void(that.alreadyAttaching=!1);if(sess.remoteStreams){var mainRemoteTrack,secondRemoteTrack;if(sess.remoteStreams.length>1)sess.remoteStreams[0].getAudioTracks().length?(secondRemoteTrack=sess.remoteStreams[0],mainRemoteTrack=sess.remoteStreams[1]):(mainRemoteTrack=sess.remoteStreams[0],secondRemoteTrack=sess.remoteStreams[1]),mainRemoteTrack.getVideoTracks().length>0&&($log.webrtc("attachDistantMediaStreams video track for element largevideo "+mainRemoteTrack.id),that.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),mainRemoteTrack,mainRemoteTrack.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0)),mainRemoteTrack.getAudioTracks().length>0&&($log.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+mainRemoteTrack.id),that.RTC.attachMediaStream(angular.element("#globalAudioTag"),mainRemoteTrack)),secondRemoteTrack.getVideoTracks().length>0&&($log.webrtc("attachDistantMediaStreams video track for element p2pSecondVideo "+secondRemoteTrack.id),that.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),secondRemoteTrack,secondRemoteTrack.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),secondRemoteTrack.getAudioTracks().length>0&&($log.webrtc("attachDistantMediaStreams audio track for element globalAudioTag "+secondRemoteTrack.id),that.RTC.attachMediaStream(angular.element("#globalAudioTag"),secondRemoteTrack));else sess.remoteStreams.forEach((function(track){track.getVideoTracks().length>0&&($log.webrtc("attachDistantMediaStreams video track"),that.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,track.id),angular.element("#largevideo")[0]&&(angular.element("#largevideo")[0].muted=!0,angular.element("#largevideo")[0].volume=0),that.RTC.attachMediaStreamIfNeeded(angular.element("#p2pSecondVideo"),track,track.id),angular.element("#p2pSecondVideo")[0]&&(angular.element("#p2pSecondVideo")[0].muted=!0,angular.element("#p2pSecondVideo")[0].volume=0)),track.getAudioTracks().length>0&&($log.webrtc("attachDistantMediaStreams audio track"),that.RTC.attachMediaStream(angular.element("#globalAudioTag"),track))}));that.alreadyAttaching=!1}}else that.isUserContactInCall()||(this.RTC.clearMediaStream(angular.element("#largevideo"),null),this.RTC.clearMediaStream(angular.element("#globalVideoTag"),null),this.RTC.clearMediaStream(angular.element("#globalAudioTag"),null))},this.attachLocalVideoOnlyStreamToElement=function(attach,element){$log.webrtc("attachLocalVideoOnlyStreamToElement "+attach),attach?(this.localStreams&&this.localStreams.length&&this.localStreams.forEach((function(track){track.getVideoTracks().length&&track.getAudioTracks().length||track.getVideoTracks().length&&that.RTC.attachMediaStreamIfNeeded(element,track,track.id)})),element[0]&&(element[0].volume=0)):this.RTC.clearMediaStream(element,null)},this.attachLocalAudioVideoStreamToElement=function(attach,element){$log.webrtc("attachLocalAudioVideoStreamToElement "+attach),attach?(this.localStreams&&this.localStreams.length&&this.localStreams.forEach((function(track){track.getVideoTracks().length&&track.getAudioTracks().length&&that.RTC.attachMediaStreamIfNeeded(element,track,track.id)})),element[0]&&(element[0].volume=0)):this.RTC.clearMediaStream(element,null)},this.attachLocalMediaStreams=function(attach){if($log.webrtc("attachLocalMediaStreams "+attach),attach){if(this.localStreams&&this.localStreams.length){var firstVideoStream=!1;this.localStreams.forEach((function(track){track.getVideoTracks().length&&track.getAudioTracks().length?(firstVideoStream?that.RTC.attachMediaStreamIfNeeded($("#minivideo2"),track,track.id):(firstVideoStream=!0,that.RTC.attachMediaStreamIfNeeded($("#minivideo"),track,track.id)),that.RTC.attachMediaStreamIfNeeded($("#callVideoPip"),track,track.id)):track.getVideoTracks().length&&(firstVideoStream?that.RTC.attachMediaStreamIfNeeded($("#minivideo2"),track,track.id):(firstVideoStream=!0,that.RTC.attachMediaStreamIfNeeded($("#minivideo"),track,track.id)),that.RTC.attachMediaStreamIfNeeded($("#callSharingPip"),track,track.id))}))}$("#callVideoPip")[0]&&($("#callVideoPip")[0].volume=0),$("#minivideo")[0]&&($("#minivideo")[0].volume=0),$("#minivideo2")[0]&&($("#minivideo2")[0].volume=0),$("#callSharingPip")[0]&&($("#callSharingPip")[0].volume=0)}else this.RTC.clearMediaStream($("#minivideo"),null),this.RTC.clearMediaStream($("#minivideo2"),null),this.RTC.clearMediaStream($("#callVideoPip"),null),this.RTC.clearMediaStream($("#callSharingPip"),null)},this.removeConferencePip=function(){return this.RTC.clearMediaStream($("#conferenceSharingPip"),null),this.RTC.clearMediaStream($("#conferenceVideoPip"),null),!0},this.pushInLocalStreams=function(stream,callId){stream.callId=callId,that.localStreams.push(stream)},this.openErrorPopup=function(msg){msg||(msg="cameraNotAvailable"),$rootScope.$broadcast("ON_WEBRTC_CALL_ERROR_EVENT",msg)},this.openCalendarBusyPopup=function(id){$rootScope.$broadcast("ON_WEBRTC_CALENDAR_BUSY_EVENT",id)},this.makeVideoCall=function(contact){that.makeCall(contact,"videoOnly")},this.makeCall=function(contact,theMedia,message){$log.webrtc("MEDIA   | makeCall to "+JSON.stringify({displayName:contact.nameForLog,resources:contact.resources})),that.makingCall?$log.info("MEDIA   | makeCall already making a call !"):(that.makingCall=!0,this.videoEventHandler.sendProposition(contact,theMedia,message))},this.makeJingleCall=function(call,mediaPillarJid,phoneNumber){$log.webrtc("MEDIA   | makeJingleCall"),that.setWebrtcConfiguration().then((function(){var localType="";call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO&&(localType="audio"),call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&(localType=localType?"audio+video":"video"),mediaPillarJid&&""!==mediaPillarJid&&$log.webrtc("MEDIA   | makeJingleCall in mediaPillar case for number : "+phoneNumber),mediaPillarJid&&""!==mediaPillarJid&&phoneNumber&&""!==phoneNumber?(localType="sip",_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.initiate(mediaPillarJid,_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jid,localType,that.localStreams,call.id,null,phoneNumber)):_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.initiate(call.fullJid,_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jid,localType,that.localStreams,call.id,null,null,call.unifiedPlanActivated),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.CONNECTING,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})).catch((function(error){$log.webrtc("MEDIA   | makeCall failure : "+JSON.stringify({error:error.message})),that.makingCall=!1,call&&that.removeCallObject(call),that.resetToSafeState()}))},this.makeJingleSharingCall=function(call){$log.webrtc("MEDIA   | makeJingleSharingCall - make desktop sharing call");var type="sharing";call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING&&(type="sharing-only"),that.setWebrtcConfiguration().then((function(){$log.webrtc("SHARING | getUserMedia success");var mediaPillarSession=that.getMediaPillarSession(),callStreams=mediaPillarSession?that.localStreams.filter((function(localStream){return!(mediaPillarSession.localStreams&&mediaPillarSession.localStreams.includes(localStream))})):that.localStreams;_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.initiate(call.fullJid,_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jid,type,callStreams,call.id,null,null,call.unifiedPlanActivated),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.CONNECTING,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})).catch((function(error){that.makingCall=!1,call&&that.removeCallObject(call),that.resetToSafeState(),$log.webrtc("MEDIA   | makeJingleSharingCall failure : "+JSON.stringify({error:error.message}))}))},this.startDesktopSharing=function(contact,media){that.makingCall?$log.info("MEDIA   | startDesktopSharing already making a call !"):(that.makingCall=!0,!that.askToStartSharing(contact.jid,media)&&that.makeDesktopSharingCall(contact,media))},this.startSharingCancelled=function(){that.makingCall=!1},this.makeDesktopSharingCall=function(contact,media){media||(media="sharing"),that.makingCall=!0,$log.webrtc("MEDIA   | makeDesktopSharingCall - trying to start a desktop sharing call with media "+media),this.videoEventHandler.sendProposition(contact,media),this.sendEvent("startHighlighting")},this.answerJingleCall=function(call){$log.webrtc("MEDIA   | answerJingleCall "+call.id);var mediaToGet=[],localType="audio";call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO&&mediaToGet.push("audio"),call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&(mediaToGet.push("video"),localType="audio+video"),call.localMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&(localType="video");var mediaConstraints={};call.isInConversationWithMobile()&&(mediaConstraints=that.getMobileMediaConstraints("video")),that.setWebrtcConfiguration().then((function(){that.getBrowserMedia(mediaToGet,mediaConstraints.fixedVideoWidth,mediaConstraints.fixedVideoHeight,mediaConstraints.fixedFrameRate).then((function(stream){var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];stream?(that.pushInLocalStreams(stream,call.id),session.addStream(that.localStreams[0]),session.localStreams.push(that.localStreams[0])):localType=null,session.localType=localType,session.sendAnswer(),session.accept(),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})).catch((function(error){$log.webrtc("MEDIA   | answerJingleCall failure for : "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")&&(that.releaseCall(call),that.openErrorPopup()),that.resetToSafeState()}))}))},this.answerCall=function(call,type){this.videoEventHandler.acceptProposition(call,type)},this.rejectCall=function(call,__reason){call?(that.makingCall=!1,that.autoreleaseTimeout&&$interval.cancel(that.autoreleaseTimeout),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id]?that.releaseCall(call):call.isInitiator?this.videoEventHandler.retractProposition(call):this.videoEventHandler.rejectProposition(call,__reason)):$log.webrtc("MEDIA   | rejectCall - trying to rejectCall a non existing call !")},this.onCallTransferredToConference=function(call){var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];this.disableAudioVideoMedia(session),this.autoreleaseTimeout&&$interval.cancel(this.autoreleaseTimeout),this.createOrUpdateStatisticsForCall(call.id),this.callsStats[call.id]&&delete this.callsStats[call.id],this.callsStatsSimplified[call.id]&&delete this.callsStatsSimplified[call.id],this.removeCallObject(call),this.displayWebRTCStats(call.id)},this.releaseCall=function(call,reason,text){call?(that.makingCall=!1,this.execute("releaseCall",(function(){$log.webrtc("MEDIA   | releaseCall : "+call);try{var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];that.disableAudioVideoMedia(session),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.resetBusyState(),that.autoreleaseTimeout&&$interval.cancel(that.autoreleaseTimeout),that.createOrUpdateStatisticsForCall(call.id),that.callsStats[call.id]&&delete that.callsStats[call.id],that.callsStatsSimplified[call.id]&&delete that.callsStatsSimplified[call.id],that.removeCallObject(call,reason,text),that.displayWebRTCStats(call.id),that.isUserContactInCall()||that.clearSrcObjectsFromElements()}catch(error){$log.webrtc("MEDIA   | releaseCall ERROR"),$log.error(error),that.createOrUpdateStatisticsForCall(call.id),that.callsStats[call.id]&&delete that.callsStats[call.id],that.callsStatsSimplified[call.id]&&delete that.callsStatsSimplified[call.id],that.resetToSafeState(),that.displayWebRTCStats(call.id),that.removeCallObject(call)}}))):$log.webrtc("MEDIA   | releaseCall - trying to release a non existing call !")},this.askToAddDesktopSharing=function(conversation){$log.webrtc("MEDIA   | askToAddDesktopSharing - Desktop sharing escalation"),!that.askToAddSharing(conversation.id)&&that.addSharingToCall(conversation.videoCall)},this.addAudioToCall=function(call,mediaModify){$log.webrtc("MEDIA   | addAudioToCall");var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];session.isRenegotiating=!0;this.getBrowserMedia(["audio"]).then((function(stream){that.stopActiveAudioVideoStreams(session),that.pushInLocalStreams(stream,call.id);for(var i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]);var type=mediaModify?"contentModify":"contentAdd";that.updateCurrentCall(call,session,"audio",type)})).catch((function(error){$log.webrtc("MEDIA   | addAudioToCall failure : "+error),that.releaseCall(call),that.resetToSafeState()}))},this.addSharingToCall=function(call){$log.webrtc("MEDIA   | addSharingToCall - Desktop sharing escalation");var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];session.isRenegotiating=!0;var mediaConstraints={};call.isInConversationWithMobile()&&(mediaConstraints=that.getMobileMediaConstraints("sharing")),this.getBrowserMedia(["sharing"],null,null,mediaConstraints.fixedFrameRate,call).then((function(stream){for(var i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]),session.localStreams[i]=null;session.localStreams=[],that.pushInLocalStreams(stream,call.id);for(i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]);that.updateCurrentCall(call,session,"sharing","contentAdd"),that.sendEvent("startHighlighting")})).catch((function(error){$log.webrtc("MEDIA   | addSharingToCall failure : "+error),session.isRenegotiating=!1,-1!==error.toString().indexOf("getUserMedia")&&that.openErrorPopup()}))},this.addVideoToCall=function(call,mediaModify){$log.webrtc("MEDIA   | addVideoToCall");var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];session.isRenegotiating=!0;var mediaConstraints={};call.isInConversationWithMobile()&&(mediaConstraints=that.getMobileMediaConstraints("video")),that.getBrowserMedia(["audio","video"],mediaConstraints.fixedVideoWidth,mediaConstraints.fixedVideoHeight,mediaConstraints.fixedFrameRate).then((function(stream){that.stopActiveAudioVideoStreams(session),that.pushInLocalStreams(stream,call.id);for(var i=0;i<that.localStreams.length;i++)session.removeStream(that.localStreams[i]);var type=mediaModify?"contentModify":"contentAdd";that.updateCurrentCall(call,session,"video",type),session.muteAudio(call.isMuted)})).catch((function(error){$log.webrtc("MEDIA   | addVideoToCall failure for : "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")?($log.info("addVideoToCall impossible, no webcam plugged"),that.openErrorPopup()):(that.releaseCall(call),that.resetToSafeState())}))},this.removeSharingFromCall=function(call){$log.webrtc("MEDIA   | removeSharingFromCall");var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];this.stopActiveSharingStream(session);session.isRenegotiating=!0,that.updateCurrentCall(call,session,"sharing","contentRemove"),that.sendEvent("stopHighlighting")},this.removeVideoFromCall=function(call){$log.webrtc("MEDIA   | removeVideoFromCall"),this.reverseAudioCallInitiated=!0;var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];this.stopActiveAudioVideoStreams(session),this.localStreams.forEach((function(stream){session.removeStream(stream)}));session.isRenegotiating=!0,that.getBrowserMedia(["audio"]).then((function(stream){that.pushInLocalStreams(stream,call.id),that.updateCurrentCall(call,session,"video","contentRemove"),session.muteAudio(call.isMuted)})).catch((function(error){$log.webrtc("MEDIA   | removeVideoFromCall failure for : "+call+" failure : "+error),-1!==error.toString().indexOf("getUserMedia")&&that.openErrorPopup(),that.releaseCall(call),that.resetToSafeState()}))},this.calculatePresenceMessage=function(call){var message="audio";return call&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&(message="video"),call&&call.remoteMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&(message="video"),call&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING&&(message="sharing"),message},this.calculateAudioState=function(data){var audioState=0;return data.availableIncomingAudioBandwidth&&(audioState=data.availableIncomingAudioBandwidth<15&&data.availableIncomingAudioBandwidth>0?1:data.availableIncomingAudioBandwidth>=15&&data.availableIncomingAudioBandwidth<30?2:3),audioState},this.calculateVideoState=function(data){var videoState=0;return data.availableIncomingVideoBandwidth&&(videoState=data.availableIncomingVideoBandwidth<300?1:data.availableIncomingVideoBandwidth>=300&&data.availableIncomingVideoBandwidth<500?2:3),videoState},this.execute=function(action,actionHandler,parameter){this.started||"releaseCall"===action?actionHandler(parameter):$log.webrtc("MEDIA   | "+action+" failure : videoService is not started")},this.getOrCreateCallByCallId=function(callId){var call=that.calls[callId];if(!call){var sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[callId],peerJid=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.getBareJidFromJid(sess.peerjid),contact=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.getContactByJid(peerJid);call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN,callId,_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Type.WEBRTC,contact),that.calls[call.id]=call}return call},this.getCallByContact=function(contact){for(var key in this.calls)if(this.calls.hasOwnProperty(key)){var call=that.calls[key];if(call.contact&&contact.jid===call.contact.jid)return call}return null},this.removeCallObject=function(call,reason,text){try{if(call){$log.debug("removeCallObject Call id: "+call.id),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.UNKNOWN,call.stopDuration();var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions?_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id]:null;that.disableAudioVideoMedia(session,call.id),delete that.calls[call.id],$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),session&&_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.terminate(call.id,reason,text),that.sendEvent("stopHighlighting")}}catch(error){$log.error("removeCallObject error "+error)}},this.updateRemoteTypeMedia=function(remoteType,call){switch(remoteType){case"audio":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO;break;case"video":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO;break;case"audio+video":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO;break;case"sharing":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO;break;case"sharing-only":call.remoteMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING;break;default:call.remoteMedia=null}$log.debug("REMOTE TYPE || REMOTE MEDIA  "+call.remoteMedia)},this.checkStreamAndStatus=function(stream,contact){return stream&&(0===stream.getAudioTracks().length&&0===stream.getVideoTracks().length||!1===stream.active)?(that.openErrorPopup(),!1):!(contact.capabilities&&!contact.capabilities.webRTC)||($log.webrtc("MEDIA   | initSharedDesktop failure : remote contact is no more available"),stream.stop&&stream.stop(),that.openErrorPopup("remoteUserNoMoreAvailable"),!1)},this.displayWebRTCStats=function(callId){try{var streams=null,i=0;if(gRTCStatsService.hasStatsForCall(callId)){if($log.webrtc("STATS   | Bundle policy used: "+gRTCStatsService.getBundlePolicyForCall(callId)),0===(streams=gRTCStatsService.getStreamsDetailsFromCall(callId)).length)$log.webrtc("STATS   | No channel information available for call "+callId);else for(i=0;i<streams.length;i++)$log.webrtc("STATS   | "+streams[i].id+": "+JSON.stringify(streams[i].streams));var codecs=gRTCStatsService.getCodecDetailsFromCall(callId);$log.webrtc("STATS   | codecs used: "+JSON.stringify(codecs)),gaService.trackCodecsUsed(codecs.codec.audio,codecs.codec.video)}else if(fRTCStatsService.hasStatsForCall(callId))if($log.webrtc("STATS   | Bundle policy used: "+fRTCStatsService.getBundlePolicyForCall(callId)),0===(streams=fRTCStatsService.getStreamsDetailsFromCall(callId)).length)$log.webrtc("STATS   | No channel information available for call "+callId);else for(i=0;i<streams.length;i++)$log.webrtc("STATS   | "+streams[i].id+": "+JSON.stringify(streams[i].streams))}catch(error){$log.error("[videoService] displayWebRTCStats error : "+error)}},this.muteAudio=function(conversation,state){var call=conversation.videoCall;if(call){$log.webrtc("MEDIA   | mute audio: "+call+" | state: "+state),conversation.isMutedAudio=state,call.isMuted=state;var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];session?(session.muteAudio(state),$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:conversation,call:call})):$log.webrtc("MEDIA   | muteAudio - trying to mute a non existing session !")}else $log.webrtc("MEDIA   | muteAudio - trying to mute a non existing call !")},this.referTo=function(session,confEndpointId,referTo){session?session.sendRefer(confEndpointId,referTo):$log.webrtc("MEDIA   | referTo - trying to transfer a non existing session !")},this.sendReferStatus=function(callId,status){var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[callId];session?($log.webrtc("MEDIA   | sendReferStatus - "+status),session.sendReferStatus(status)):$log.webrtc("MEDIA   | sendReferStatus - trying to transfer a non existing session !")},this.muteVideo=function(conversation,state){var call=conversation.videoCall;if(call){$log.webrtc("MEDIA   | muteVideo: "+call);var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];session&&(session.muteVideo(state),session.sendMute(state)),$rootScope.$broadcast("ON_CONVERSATION_CALL_MUTED_UPDATED_EVENT",{conversation:conversation,call:call})}else $log.webrtc("MEDIA   | muteVideo - trying to mute a non existing call !")},this.stopActiveSharingStream=function(session){if(that.localStreams.length>0){that.localStreams.forEach((function(stream){stream.getVideoTracks().length&&!stream.getAudioTracks().length&&(stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null)}));for(var i=0;i<that.localStreams.length;i++)if(that.localStreams[i]&&!that.localStreams[i].getAudioTracks().length&&that.localStreams[i].getVideoTracks().length){that.localStreams.splice(i,1);null}}session&&session.localStreams&&(session.localStreams.forEach((function(stream){stream.getVideoTracks().length&&!stream.getAudioTracks().length&&(stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop()),session.removeStream(stream)})),session.localStreams=[]),session&&_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.localStream&&session.removeStream(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.localStream)},this.stopAllActiveStreams=function(session){this.stopActiveAudioVideoStreams(session,!0)},this.stopActiveAudioVideoStreams=function(session,stopAll){if(that.localStreams.length>0)if(that.localStreams.forEach((function(stream){(stream.getAudioTracks().length||stopAll)&&(stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null)})),stopAll)for(;that.localStreams.length;){that.localStreams.pop();null}else for(var i=0;i<that.localStreams.length;i++)if(that.localStreams[i]&&that.localStreams[i].getAudioTracks().length){that.localStreams.splice(i,1);null}if(session&&session.localStreams){if(session.localStreams.forEach((function(stream){(stream.getAudioTracks().length||stopAll)&&(stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),session.removeStream(stream))})),stopAll)for(;session.localStreams.length;){session.localStreams.pop();null}session.localStreams=[]}session&&_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.localStream&&session.removeStream(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.localStream)},this.resetToSafeState=function(){$log.webrtc("MEDIA   | resetToSafeState"),that.autoreleaseTimeout&&$interval.cancel(that.autoreleaseTimeout),(that.localStream||that.localStreams.length)&&that.disableAudioVideoMedia(),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.resetBusyState()},this.vidRes={1080:[1920,1080],720:[1280,720],360:[640,360],180:[320,180],960:[960,720],640:[640,480],320:[320,240]},this.getMobileMediaConstraints=function(type){return this.mobileVideoQualityConfiguration[type]},this.setVideoQualityConfigurationForCompany=function(){this.companyConfig&&this.companyConfig.video&&(this.videoQualityConfiguration.video.fixedVideoHeight=this.companyConfig.video.height?this.companyConfig.video.height.ideal:this.videoQualityConfiguration.video.fixedVideoHeight,this.videoQualityConfiguration.video.fixedVideoWidth=this.companyConfig.video.width?this.companyConfig.video.width:this.videoQualityConfiguration.video.fixedVideoWidth,this.videoQualityConfiguration.video.fixedFrameRate=this.companyConfig.video.frameRate?this.companyConfig.video.frameRate:this.videoQualityConfiguration.video.fixedFrameRate)},this.videoQualityConfiguration={video:{fixedFrameRate:30,fixedVideoWidth:1280,fixedVideoHeight:720},sharing:{fixedFrameRate:10,fixedVideoWidth:1280,fixedVideoHeight:720}},this.mobileVideoQualityConfiguration={video:{fixedFrameRate:20,fixedVideoWidth:640,fixedVideoHeight:480},sharing:{fixedFrameRate:10,fixedVideoWidth:640,fixedVideoHeight:480}},this.minFirefoxWebRTCVersion=45,this.minChromeWebRTCVersion=42,this.minEdgeWebRTCVersion=25,this.firefoxPreferedSharing="screen",this.getBrowserMedia=function(userMedia,fixedVideoWidth,fixedVideoHeight,fixedFrameRate,call){return userMedia&&0!==userMedia.length?new Promise((function(resolve,reject){var deferred=$q.defer(),shouldGetDisplayMedia=!1,constraints={audio:!1,video:!1},width=fixedVideoWidth||that.videoQualityConfiguration.video.fixedVideoWidth,height=fixedVideoHeight||that.videoQualityConfiguration.video.fixedVideoHeight,promises=[];if(platformService.allowDevicesManagement()){if(userMedia.indexOf("audio")>=0){var microphoneDeferred=$q.defer();platformService.getCurrentMicrophone().then((function(microphone){constraints.audio=!microphone||{optional:[{sourceId:microphone.id}]},microphoneDeferred.resolve(constraints);var mic="default";microphone&&(mic="id - "+microphone.id+" and label "+microphone.label),$log.info("[VideoService] GetUserMedia for microphone "+mic)})),promises.push(microphoneDeferred.promise)}if(userMedia.indexOf("video")>=0){var frameRate=fixedFrameRate||that.videoQualityConfiguration.video.fixedFrameRate,cameraDeferred=$q.defer();platformService.getCurrentCamera().then((function(camera){camera&&"default"!==camera.id?constraints.video={width:width,height:height,frameRate:frameRate,deviceId:{exact:camera.id}}:constraints.video={width:width,height:height,frameRate:frameRate},cameraDeferred.resolve(constraints);var cam="default";camera&&(cam="id - "+camera.id+" and label "+camera.label),$log.info("[VideoService] GetUserMedia for camera "+cam)})),promises.push(cameraDeferred.promise)}}else userMedia.indexOf("audio")>=0&&(constraints.audio=!0),userMedia.indexOf("video")>=0&&(constraints.video={width:width,height:height});if(userMedia.indexOf("sharing")>=0){frameRate=fixedFrameRate||that.videoQualityConfiguration.sharing.fixedFrameRate,width=fixedVideoWidth||that.videoQualityConfiguration.sharing.fixedVideoWidth,height=fixedVideoHeight||that.videoQualityConfiguration.sharing.fixedVideoHeight;var isSharingScreen=!0;if(extensionSharingService.extensionFound)constraints.video={mandatory:{chromeMediaSource:"desktop",maxFrameRate:frameRate}},promises.push(extensionSharingService.getStreamToShareFromExtension(constraints));else if(that.isNativeApplication()||"chrome"!==adapter.default.browserDetails.browser)if("firefox"===adapter.default.browserDetails.browser)constraints.video={mediaSource:that.firefoxPreferedSharing};else{var sharingSources=that.getDesktopSharingSource(),chromeMediaSource=sharingSources&&sharingSources.chromeMediaSource?sharingSources.chromeMediaSource:"desktop",chromeMediaSourceId=sharingSources&&sharingSources.chromeMediaSourceId?sharingSources.chromeMediaSourceId:null;chromeMediaSourceId&&(isSharingScreen=-1!==chromeMediaSourceId.indexOf("screen")),constraints.video={mandatory:{chromeMediaSource:chromeMediaSource,maxFrameRate:frameRate}},chromeMediaSourceId&&(constraints.video.mandatory.chromeMediaSourceId=chromeMediaSourceId)}else shouldGetDisplayMedia=!0,constraints={},constraints={video:{chromeMediaSource:"desktop",frameRate:frameRate}}}call&&(call.isSharingScreen=isSharingScreen),$q.all(promises).then((function(){deferred.resolve(constraints)})).catch((function(){deferred.resolve()})),deferred.promise.then((function(constraint){if($log.info("[VideoService] GetUserMedia with constraint "+JSON.stringify(constraint)),constraint)try{shouldGetDisplayMedia?navigator.mediaDevices.getDisplayMedia(constraint).then((function(stream){$log.webrtc("MEDIA   | getDisplayMedia success"),stream.getVideoTracks().length&&$log.info("[videoService] getDisplayMedia video stream kind "+stream.getVideoTracks()[0].kind+", id "+stream.getVideoTracks()[0].id+", label "+stream.getVideoTracks()[0].label+", readyState "+stream.getVideoTracks()[0].readyState+", enabled "+stream.getVideoTracks()[0].enabled),stream&&(0===stream.getAudioTracks().length&&0===stream.getVideoTracks().length||!1===stream.active)&&($log.webrtc("Stream has no active audio or video tracks"),gaService.trackGetUserMediaErrorNoTrack(),reject(new Error("getDisplayMedia failure : Stream has no active audio or video tracks"))),stream.getVideoTracks()[0].onended=function(){$log.info("Stop screensharing in chrome has been triggered"),$rootScope.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")},resolve(stream),gaService.trackGetUserMediaSuccess()})).catch((function(error){$log.webrtc("MEDIA   | getDisplayMedia failure: "+error),gaService.trackGetUserMediaError(),$rootScope.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",error),reject(new Error("getDisplayMedia failure "+error))})):navigator.mediaDevices.getUserMedia(constraint).then((function(stream){$log.webrtc("MEDIA   | getUserMedia success"),stream.getAudioTracks().length&&$log.info("[videoService] getUserMedia audio stream kind "+stream.getAudioTracks()[0].kind+", id "+stream.getAudioTracks()[0].id+", label "+stream.getAudioTracks()[0].label+", readyState "+stream.getAudioTracks()[0].readyState+", enabled "+stream.getAudioTracks()[0].enabled),stream.getVideoTracks().length&&$log.info("[videoService] getUserMedia video stream kind "+stream.getVideoTracks()[0].kind+", id "+stream.getVideoTracks()[0].id+", label "+stream.getVideoTracks()[0].label+", readyState "+stream.getVideoTracks()[0].readyState+", enabled "+stream.getVideoTracks()[0].enabled),stream&&(0===stream.getAudioTracks().length&&0===stream.getVideoTracks().length||!1===stream.active)&&($log.webrtc("Stream has no active audio or video tracks"),gaService.trackGetUserMediaErrorNoTrack(),reject(new Error("getUserMedia failure : Stream has no active audio or video tracks"))),extensionSharingService.extensionFound&&userMedia.indexOf("sharing")>=0&&(stream.getVideoTracks()[0].onended=function(){$log.info("Stop screensharing in chrome has been triggered"),$rootScope.$broadcast("ON_CHROME_STOP_SCREEN_SHARING_TRIGGERED")}),stream&&stream.getAudioTracks().length&&(stream.getAudioTracks()[0].onended=function(event){$log.error("[videoService] getUserMedia -- audio stream track ended"),console.log(this),console.log(event)}),resolve(stream),gaService.trackGetUserMediaSuccess()})).catch((function(error){$log.webrtc("MEDIA   | getUserMedia failure: "+error),gaService.trackGetUserMediaError(),$rootScope.$broadcast("ON_WEBRTC_GETUSERMEDIA_ERROR",error),reject(new Error("getUserMedia failure "+error))}))}catch(err){$log.webrtc("MEDIA   | getUserMedia failure: "+err),gaService.trackGetUserMediaError(),reject(new Error("getUserMedia failure "+err))}else reject({message:"getUserMedia cancelled"})}))})):$q.when()},this.getBrowserMethodHandler=function(){var version="",returnValue=null;if(navigator.mozGetUserMedia&&$window.mozRTCPeerConnection){if(version=browserService.extractBrowserVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),$log.webrtc("BROWSER | Detect Firefox navigator (version "+version+")"),version<this.minFirefoxWebRTCVersion)return $log.webrtc("BROWSER | Firefox navigator is not WebRTC capable before version "+this.minFirefoxWebRTCVersion),returnValue;returnValue={browser:"firefox",attachMediaStream:function(element,stream){element&&element[0]&&(element[0].mozSrcObject=stream,element[0].srcObject=stream,element[0].play())},pc_constraints:{},clearMediaStream:function(element){try{angular.isDefined(element[0])&&(element[0].pause(),element[0].mozSrcObject=null,element[0].srcObject=null,element[0].uniqueId=null)}catch(err){$log.webrtc("BROWSER | clearMediaStream failure "+err)}},attachMediaStreamIfNeeded:function(element,stream,uniqueId){$log.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+uniqueId),element&&element[0]&&(element[0].uniqueId!==uniqueId||!element[0].mozSrcObject&&!element[0].srcObject)&&(element[0].uniqueId=uniqueId,that.RTC.attachMediaStream(element,stream))}}}else if(navigator.webkitGetUserMedia&&$window.webkitRTCPeerConnection){if(version=browserService.extractBrowserVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),$log.webrtc("BROWSER | Detect Chrome navigator (version "+version+")"),version<this.minChromeWebRTCVersion)return $log.webrtc("BROWSER | Chrome navigator is not WebRTC capable before version "+this.minChromeWebRTCVersion),returnValue;returnValue={browser:"chrome",attachMediaStream:function(element,stream){$log.webrtc("BROWSER | attachMediaStream to element"),element&&element[0]&&(element[0].srcObject=stream)},pc_constraints:{},clearMediaStream:function(element){angular.isDefined(element[0])&&(element[0].pause(),element[0].srcObject=null,element[0].uniqueId=null)},attachMediaStreamIfNeeded:function(element,stream,uniqueId){$log.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+uniqueId),!element||!element[0]||element[0].uniqueId===uniqueId&&element[0].srcObject||(element[0].uniqueId=uniqueId,that.RTC.attachMediaStream(element,stream))}}}else window.RTCPeerConnection&&navigator.userAgent.match(/AppleWebKit\/(\d+)\./)&&(returnValue={browser:"safari",attachMediaStream:function(element,stream){element&&element[0]&&(element[0].setAttribute("playsinline",!0),element[0].srcObject=stream,element[0].play())},pc_constraints:{},clearMediaStream:function(element){try{angular.isDefined(element[0])&&(element[0].pause(),element[0].srcObject=null,element[0].uniqueId=null)}catch(err){$log.webrtc("BROWSER | clearMediaStream failure "+err)}},attachMediaStreamIfNeeded:function(element,stream,uniqueId){$log.webrtc("BROWSER | attachMediaStreamIfNeeded for ID "+uniqueId),!element||!element[0]||element[0].uniqueId===uniqueId&&element[0].srcObject||(element[0].uniqueId=uniqueId,that.RTC.attachMediaStream(element,stream))}});return returnValue},this.getIceConfig=function(){return $q((function(resolve,reject){var geoip=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_3___default.a.getSetting("geoip"),geoipUrl="";geoip&&(geoipUrl="&geoip="+geoip);var portalURL=config.restServerUrl+"/api/rainbow/geolocation/v1.0/";$http({method:"GET",url:portalURL+"settings/iceservers?nbServers=2"+geoipUrl,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4___default.a.getRequestHeader()}).then((function(result){$log.info("[videoService] getIceConfig success"),that.ttl=result.data.ttl,that.ttl&&(that.ttlTimeout=$interval((function(){that.ttl=0,that.setWebrtcConfiguration()}),1e3*result.data.ttl,1));var iceServers=result.data.data,dc=[];iceServers.forEach((function(element){element.dc&&!dc.includes(element.dc)&&dc.push(element.dc),delete element.dc,delete element.id}),this),resolve({iceServers:iceServers,dc:dc})})).catch((function(error){$log.error("[videoService] getIceConfig failure -- "+error.message),reject(error)}))}))},this.getCompanyWebrtcConfig=function(){return $q((function(resolve,reject){var apiURL=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/webrtc";$http({method:"GET",url:apiURL,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4___default.a.getRequestHeader()}).then((function(result){$log.info("[videoService] getCompanyWebrtcConfig success");var config=result.data.data;resolve(config)})).catch((function(error){var msg=error&&error.data?error.data.errorDetails:"Unknown error";if(error&&error.data&&400100==error.data.errorDetailsCode)return $log.info("[videoService] getCompanyWebrtcConfig -- "+msg),resolve({});$log.error("[videoService] getCompanyWebrtcConfig failure -- "+msg),reject(error)}))}))},this.calculateNewCallType=function(call,session,type,action){var result=session.localType;return"contentAdd"===action&&("video"===type?(result=call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING?"sharing+video":"video",call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO):"sharing"===type?(result=call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO?"sharing+video":"sharing",call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING):"audio"===type&&(call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING?(result="sharing",call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO):(result="audio",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO))),"contentRemove"===action&&("video"===type?call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING?(result="sharing",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING):(result="audio",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO):"sharing"===type&&(call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO?(result="video",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO):(result="audio",call.localMedia=_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.AUDIO))),"contentModify"===action&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.VIDEO&&!(call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Media.SHARING)&&(result="video"),$log.info("[videoService] calculateNewCallType for type "+type+" and action "+action+" with result "+result),result},this.updateCurrentCall=function(call,session,type,action){$log.info("[videoService] updateCurrentCall for type "+type+" and action "+action);for(var newType=this.calculateNewCallType(call,session,type,action),i=0;i<that.localStreams.length;i++)"chrome"===adapter.default.browserDetails.browser?session.addStream(that.localStreams[i]):session.replaceStream(that.localStreams[i]),session.localStreams.push(that.localStreams[i]);switch(action){case"contentAdd":session.contentAdd(newType);break;case"contentRemove":session.contentRemove(newType);break;case"contentModify":session.contentModify(newType)}_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_7___default.a.setBusyState("dnd",that.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",call)},this.createOrUpdateStatisticsForCall=function(callId){var call=this.calls[callId];if(call){var metrics=[];if(this.callsStats[callId])return this.callsStats[callId].RainMetrics&&this.callsStats[callId].push(this.callsStats[callId].RainMetrics),metrics.push({connectionId:callId,stats:this.callsStats[callId]}),void this.updateStatisticsForCall(this.callsStats[callId].id,callId,call.contact.dbId,"ended",metrics);$log.info("[videoService] createOrUpdateStatisticsForCall "+callId),this.callsStats[callId]={},metrics.push({connectionId:callId,stats:this.callsStats[callId]}),this.createStatisticsForSession(callId,call.contact.dbId,"pending",metrics).then((function(id){that.callsStats[callId].id=id,$log.info("[videoService] createOrUpdateStatisticsForCall success for session "+callId+" with id "+id)})).catch((function(error){$log.error("[videoService] createOrUpdateStatisticsForCall "+error.message)}))}else $log.warn("[videoService] createOrUpdateStatisticsForCall -- missing call "+callId)},this.createStatisticsForSession=function(callId,peerId,callState,metrics){return $q((function(resolve,reject){$log.info("[videoService] createStatisticsForSession "+callId);var portalURL=config.restServerUrl+"/api/rainbow/metrics/v1.0/";$http({method:"POST",url:portalURL+"webrtcmetrics",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4___default.a.getRequestHeader(),data:{callId:callId,peerId:peerId,callState:callState}}).then((function(response){$log.info("[videoService] createStatisticsForSession success"),response&&response.data&&response.data.data&&response.data.data.id&&(that.callsStats[callId]||(that.callsStats[callId]={}),resolve(response.data.data.id))}),(function(response){$log.error("[videoService] createStatisticsForSession failure "+response.errorMsg),reject(new Error(response.errorMsg))}))}))},this.updateStatisticsForCall=function(id,callId,peerId,callState,metrics){if($log.info("[videoService] updateStatisticsForCall "+callId),id){var portalURL=config.restServerUrl+"/api/rainbow/metrics/v1.0/";$http({method:"POST",url:portalURL+"webrtcmetrics/"+id+"/metrics",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4___default.a.getRequestHeader(),data:{metrics:metrics}}).then((function(){$log.info("[videoService] updateStatisticsForCall success"),"ended"===callState&&($log.info("[videoService] updateStatisticsForCall -- update call state with "+callState),$http({method:"PUT",url:portalURL+"webrtcmetrics/"+id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_4___default.a.getRequestHeader(),data:{callState:callState}}).then((function(){$log.info("[videoService] updateStatisticsForCall -- update call state success")}),(function(response){$log.error("[videoService] updateStatisticsForCall failure "+response.errorMsg)})))}),(function(response){$log.error("[videoService] updateStatisticsForCall failure "+response.errorMsg)}))}else $log.warn("[videoService] updateStatisticsForCall -- missing id for callId "+callId)},this.sendDTMF=function(dialString,call,skipHandle){var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[call.id];if(session&&session.peerconnection){var audioDtmfSender=session.peerconnection.getSenders().find((function(sender){return sender.dtmf&&sender.track&&sender.track.enabled&&"audio"===sender.track.kind})),dtmfSender=audioDtmfSender?audioDtmfSender.dtmf:null;dtmfSender?($log.debug("[videoService] sendDTMF: dtmf sender found on webrtc session for call id "+call.id+" dialstring: "+dialString),dtmfSender.ontonechange=skipHandle?this.silentToneChangeEventHandle:this.handleToneChangeEvent,dtmfSender.insertDTMF(dialString)):$log.error("[videoService] sendDTMF: no dtmf sender found on webrtc session for call id "+call.id)}else $log.error("[videoService] sendDTMF: no webrtc session found for call id "+call.id)},this.handleToneChangeEvent=function(event){""!==event.tone&&($log.debug("[videoService] Dtmf Tone played: "+event.tone),$rootScope.$broadcast("ON_DTMF_SENT",event.tone))},this.silentToneChangeEventHandle=function(event){$log.debug("[videoService] Dtmf Tone played: "+event.tone)},angular.element(document).bind("transportreplace.jingle",(function(__event,callId){$log.webrtc("JINGLE  | transportreplace.jingle "+callId);var sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[callId];sess?sess.sendAnswer(void 0,"transport-accept"):$log.warn("JINGLE  | transportreplace.jingle no such session !")})),angular.element(document).bind("callactive.jingle",(function(__event,callId){$log.webrtc("JINGLE  | callactive "+callId)})),angular.element(document).bind("remotestreamadded.jingle",(function(__event,sid,hasAudioTracks){$log.webrtc("JINGLE  | remoteStreamadded "+sid);var sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[sid];if(sess&&sess.remoteStreams&&!sess.confId){var call=that.calls[sid];call&&that.attachDistantMediaStreams(!0,call),$rootScope.$broadcast("ON_WEBRTC_REMOTE_STREAM_ADDED",sess.remoteStreams)}hasAudioTracks&&that.resetAudioOutputElement()})),angular.element(document).bind("remotestreamremoved.jingle",(function(__event,sid){$log.webrtc("JINGLE  | remotestreamremoved "+sid);var call=that.calls[sid],sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[sid];call&&sess&&that.attachDistantMediaStreams(!0,call)})),angular.element(document).bind("callaccepted.jingle",(function(__event,sid){$log.webrtc("JINGLE  | callaccepted "+sid);var call=that.calls[sid],sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[sid];call&&sess&&(that.statsInterval&&($log.webrtc("JINGLE  | remove getStats interval"),window.clearInterval(that.statsInterval),that.statsinterval=null),that.createOrUpdateStatisticsForCall(call.id),$log.webrtc("JINGLE  | start getStats interval"),that.statsInterval=sess.getStats(3e3)),call&&call.status.key!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_2__.Call.Status.ACTIVE.key&&($log.webrtc("INFO    | call has been accepted. Set current call to ACTIVE state"),angular.element(document).trigger("callactive.jingle",[sid]))})),angular.element(document).bind("nostuncandidates.jingle",(function(__event,sid){$log.webrtc("JINGLE  | nostuncandidates "+sid),gaService.trackICENoSTUNCandidate()})),angular.element(document).bind("ringing.jingle",(function(__event,sid){$log.webrtc("JINGLE  | callremoteringing "+sid)})),angular.element(document).bind("mediafailure.jingle",(function(){$log.webrtc("JINGLE  | callmediafailure")})),angular.element(document).bind("mute.jingle",(function(__event,sid){$log.webrtc("JINGLE  | mute "+sid);var call=that.calls[sid];call.isRemoteVideoMuted=!0,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})),angular.element(document).bind("unmute.jingle",(function(__event,sid){$log.webrtc("JINGLE  | unmute "+sid);var call=that.calls[sid];call.isRemoteVideoMuted=!1,$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)})),angular.element(document).bind("hold.jingle",(function(__event,sid){$log.webrtc("JINGLE  | hold "+sid);var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[sid];session?(session.muteAudio(!0),$rootScope.$broadcast("ON_HOLD_TONE_EVENT","hold")):$log.webrtc("MEDIA   | hold - received on a non existing session !")})),angular.element(document).bind("unhold.jingle",(function(__event,sid){$log.webrtc("JINGLE  | unhold "+sid);var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_5___default.a.connection.jingle.sessions[sid];session?(session.muteAudio(!1),$rootScope.$broadcast("ON_HOLD_TONE_EVENT","unhold")):$log.webrtc("MEDIA   | unhold - received on a non existing session !")})),angular.element(document).bind("remoteIceFailed.jingle",(function(sid){$log.webrtc("JINGLE  | remoteIceFailed "+sid),that.openErrorPopup("IceConnectionFailed")})),angular.element(document).bind("mediamodified.jingle",(function(__event,sid,mediaType){$log.webrtc("JINGLE  | mediamodified "+sid),that.videoEventHandler.mediaModified(sid,mediaType)})),angular.element(document).bind("statsChrome.jingle",(function(__event,sid,items){for(var i=0;i<items.length;++i)switch(items[i].type){case"googComponent":gRTCStatsService.addStreamToCall(sid,items[i]);break;case"ssrc":gRTCStatsService.addSSRCToStream(sid,items[i])}})),angular.element(document).bind("statsFirefox.jingle",(function(__event,sid,items){for(var i=0;i<items.length;++i)switch(items[i].type){case"inboundrtp":case"outboundrtp":fRTCStatsService.addStreamToCall(sid,items[i]);break;case"candidatepair":fRTCStatsService.addCandidatePairToCall(sid,items[i])}})),angular.element(document).bind("webrtcFirefoxStats.jingle",(function(__event,sid,data){if(that.callsStats.sid||(that.callsStats.sid={}),that.callsStats[sid]||(that.callsStats[sid]={}),that.calls[sid]){var currentStats=that.callsStats[sid];currentStats&&(data.videoReceived?currentStats.video=data:currentStats.audio=data,that.callsStats[sid]=currentStats)}})),angular.element(document).bind("webrtcConnectionType.jingle",(function(__event,sid,connectionType){var activeCall=that.calls[sid];connectionType&&($log.webrtc("STATS   | Local candidate ("+connectionType.localAddress+") type is "+connectionType.localCandidateType),$log.webrtc("STATS   | Remote candidate  ("+connectionType.remoteAddress+") type is "+connectionType.remoteCandidateType),activeCall&&activeCall.isInitiator&&gaService.trackICEUsed(connectionType.localCandidateTypee,connectionType.remoteCandidateType),connectionType.networkType&&($log.webrtc("STATS   | Network type is "+connectionType.networkType),activeCall&&activeCall.isInitiator&&gaService.trackICETopology(connectionType.networkType)))})),angular.element(document).bind("webrtcSessionStats.jingle",(function(__event,sid,data){that.callsStats.sid||(that.callsStats.sid={}),that.callsStats[sid]||(that.callsStats[sid]={});var id=that.callsStats[sid].id;that.callsStats[sid]=data,that.callsStats[sid].id=id}))}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),uuid__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(27),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3__),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(14),_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5__);angular.module("rainbow").factory("VideoServiceEventHandler",["$q","$log","$rootScope","$interval","gaService",function($q,$log,$rootScope,$interval,gaService){function VideoServiceEventHandler(videoService){this.videoService=videoService,this.nameSpace="urn:xmpp:jingle-message:0"}return VideoServiceEventHandler.create=function(videoService){return new VideoServiceEventHandler(videoService)},VideoServiceEventHandler.prototype.setRemoteTypeMedia=function(remoteType,call){call.remoteMedia=0;for(var i=0;i<remoteType.length;i++)switch(remoteType[i]){case"audio":call.remoteMedia=call.remoteMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO;break;case"video":call.remoteMedia=call.remoteMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO;break;case"sharing":call.remoteMedia=call.remoteMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING;break;default:call.remoteMedia=null}$log.debug("REMOTE TYPE || REMOTE MEDIA  "+call.remoteMedia)},VideoServiceEventHandler.prototype.setLocalTypeMedia=function(localType,call){call.localMedia=0;for(var i=0;i<localType.length;i++)switch(localType[i]){case"audio":call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO;break;case"video":call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO;break;case"sharing":call.localMedia=call.localMedia|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING;break;default:call.localMedia=null}$log.debug("LOCAL TYPE || LOCAL MEDIA  "+call.localMedia)},VideoServiceEventHandler.prototype.sendProposition=function(contact,media,message){$log.info("[VideoServiceEventHandler]   | sendProposition to "+JSON.stringify({displayName:contact.nameForLog,resources:contact.resources}));var that=this,mediaToGet=["audio"],secondMediaToGet=[];"video"===media?mediaToGet.push("video"):"videoOnly"===media?mediaToGet=["video"]:"sharing"===media?(mediaToGet=["sharing"],secondMediaToGet=["audio"]):"sharingOnly"===media&&(mediaToGet=["sharing"]);var id="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__(),call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING,id,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.WEBRTC,contact);this.videoService.getBrowserMedia(mediaToGet,void 0,void 0,void 0,call).then((function(stream){that.videoService.getBrowserMedia(secondMediaToGet).then((function(extraStream){if(that.videoService.makingCall&&that.videoService.started){call.isInitiator=!0,stream.callId=id,that.videoService.localStreams.push(stream),extraStream&&(extraStream.callId=id,that.videoService.localStreams.push(extraStream),mediaToGet.push(secondMediaToGet.pop())),that.videoService.calls[call.id]=call,that.setLocalTypeMedia(mediaToGet,call);var idPropose="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__(),xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid,to:contact.jid,id:idPropose});xmppMessage.c("propose",{xmlns:that.nameSpace,id:id}),message&&xmppMessage.c("subject",{xmlns:"urn:xmpp:jingle-subject:0"}).t(message).up(),xmppMessage.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:mediaToGet[0]}).up(),mediaToGet[1]&&(xmppMessage=xmppMessage.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:mediaToGet[1]}).up()),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default.a.FeaturesEnum.WEBRTC_UNIFIED_PLAN)&&(xmppMessage=xmppMessage.c("unifiedplan",{xmlns:"urn:xmpp:jingle:apps:jsep:1"}).up()),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.send(xmppMessage),that.videoService.makingCall=!1,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.setBusyState("dnd",that.videoService.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){$log.webrtc("MEDIA   | send proposition : no response after 30 seconds : release the call"),call&&that.videoService.rejectCall(_call)}),3e4,1,!0,call)}else $log.warn("[VideoServiceEventHandler]   | sendProposition -- call should no longer be made !"),that.videoService.makingCall=!1,stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null,extraStream&&(extraStream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),extraStream.stop&&extraStream.stop(),extraStream=null)})).catch((function(error){$log.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:error.message})),that.videoService.makingCall=!1,-1!==error.toString().indexOf("getUserMedia")&&that.videoService.openErrorPopup(),that.videoService.removeCallObject(call),that.videoService.isUserContactInCall()||that.videoService.resetToSafeState(),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout)}))})).catch((function(error){$log.info("[VideoServiceEventHandler]   | sendProposition failure : "+JSON.stringify({error:error.message})),that.videoService.makingCall=!1,mediaToGet.indexOf("sharing")>=0||-1===error.toString().indexOf("getUserMedia")||that.videoService.openErrorPopup(),that.videoService.removeCallObject(call),that.videoService.isUserContactInCall()||that.videoService.resetToSafeState()}))},VideoServiceEventHandler.prototype.retractProposition=function(call){$log.info("[VideoServiceEventHandler]   | retractProposition for call "+call.id);var idRetract="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__(),xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid,to:call.contact.jid,id:idRetract}).c("retract",{xmlns:this.nameSpace,id:call.id});_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.send(xmppMessage),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState(),this.videoService.removeCallObject(call)},VideoServiceEventHandler.prototype.acceptProposition=function(call,type){if(call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ANSWERING){$log.info("[VideoServiceEventHandler]   | acceptProposition for call "+call.id),call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ANSWERING;var idAccept="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__(),xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid,to:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.jid,id:idAccept}).c("accept",{xmlns:this.nameSpace,id:call.id});_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.send(xmppMessage);var idProceed="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__();xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid,to:call.fullJid,id:idProceed}).c("proceed",{xmlns:this.nameSpace,id:call.id}),call.unifiedPlanActivated&&(xmppMessage=xmppMessage.c("unifiedplan",{xmlns:"urn:xmpp:jingle:apps:jsep:1"}).up(),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.connection.jingle.jid2session[call.fullJid]={unifiedPlan:!0}),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.send(xmppMessage);var mediaToGet=["audio"];type&&"video"===type&&mediaToGet.push("video"),call.remoteMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&(mediaToGet=["video"]),call.remoteMedia===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING&&(mediaToGet=[]),this.setLocalTypeMedia(mediaToGet,call),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.setBusyState("dnd",this.videoService.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call);var that=this;that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){_call&&(null!==call.getMediaPillarCall()?$log.warn("[webrtcgateway/VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call :"+_call.id):$log.webrtc("[VideoServiceEventHandler] | acceptProposition autoreleaseTimeout after 45 s : remove the call "+_call.id),that.videoService.removeCallObject(_call),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState())}),45e3,1,!0,call)}else $log.warn("[VideoServiceEventHandler]   | acceptProposition for call "+call.id+" -- ignored! Already answering")},VideoServiceEventHandler.prototype.rejectProposition=function(call,__reason){$log.info("[VideoServiceEventHandler]   | rejectProposition for call "+call.id);var idRejectToMe="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__(),xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid,to:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.jid,id:idRejectToMe}).c("reject",{xmlns:this.nameSpace,id:call.id});_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.send(xmppMessage);var mediaPillarContext=call.getMediaPillarCall(),otherJid=mediaPillarContext&&mediaPillarContext.mediaPillarJid?mediaPillarContext.mediaPillarJid:call.contact.jid,idRejectToDistant="web_"+uuid__WEBPACK_IMPORTED_MODULE_1__();otherJid?(xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid,to:otherJid,id:idRejectToDistant}).c("reject",{xmlns:this.nameSpace,id:call.id,reason:__reason}),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.send(xmppMessage)):$log.error("[VideoServiceEventHandler] | rejectProposition -- missing other JID !"),call&&(call.status=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,delete this.videoService.calls[call.id],$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),this.videoService.setWebrtcConfiguration(),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout)},VideoServiceEventHandler.prototype.onMessageReceived=function(stanza){var that=this;try{$rootScope.$apply((function(){$log.info("[VideoServiceEventHandler]   | onMessageReceived");var temp=$(stanza);temp.find("error").length>0||temp.find("delay").length>0||$(stanza).find("service-unavailable").length>0?that.onMessageReceivedError():temp.find("propose").length>0?that.onPropositionReceived(stanza):temp.find("retract").length>0?that.onRetractReceived(stanza):temp.find("reject").length>0?that.onRejectReceived(stanza):temp.find("accept").length>0?that.onAcceptReceived(stanza):temp.find("proceed").length>0&&that.onProceedReceived(stanza)}))}catch(error){return $log.error("[VideoServiceEventHandler]   | onMessageReceived error "+error),!0}return!0},VideoServiceEventHandler.prototype.onMessageReceivedError=function(stanza){$log.info("[VideoServiceEventHandler]   | onMessageReceivedError");var id=$(stanza).find("propose").attr("id"),call=this.videoService.calls[id];call&&$log.error("[VideoServiceEventHandler]   | onMessageReceivedError call is in "+call.status.value+" state")},VideoServiceEventHandler.prototype.getOrCreateContact=function(jid,stanza){if(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.isMediaPillarJid(jid)){$log.info("[VideoServiceEventHandler]   | getOrCreateContact for mediapillar jid "+jid);var mediapillarNode=$(stanza).find("mediapillar");if(mediapillarNode){var contact,callernumberNode=mediapillarNode.find("callernumber"),callernumber=callernumberNode?callernumberNode.text():void 0,displaynameNode=mediapillarNode.find("displayname"),displayname=displaynameNode?displaynameNode.text():void 0;$log.info("[VideoServiceEventHandler]   | getOrCreateContact MP for jid "+jid+" callernumber: "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default()(callernumber)+" displayname: "+_src_utils_anonymizer__WEBPACK_IMPORTED_MODULE_4___default()(displayname));var foundContactByNumber=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getContactByPhoneNumber(callernumber);return foundContactByNumber?contact=foundContactByNumber:(contact=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.createBasicContact(null,callernumber),displayname&&(contact.displayName=displayname)),$q.resolve(contact)}return _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid)}return $log.info("[VideoServiceEventHandler]   | getOrCreateContact for jid "+jid),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getOrCreateContact(jid)},VideoServiceEventHandler.prototype.onPropositionReceived=function(stanza){var id=$(stanza).find("propose").attr("id");$log.info("[VideoServiceEventHandler]   | onPropositionReceived for ID "+id);var call=this.videoService.calls[id],that=this;if(call){if($(stanza).find("subject").length>0){var subject=$(stanza).find("subject")[0];$log.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+subject.textContent),call.setSubject(subject.textContent)}call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),that.videoService.config&&that.videoService.config.unifiedPlan&&(call.unifiedPlanActivated=!0),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default.a.FeaturesEnum.WEBRTC_UNIFIED_PLAN)&&$(stanza).find("unifiedplan").length&&(call.unifiedPlanActivated=!0);remoteMedia=[];for(var length=$(stanza).find("description").length,i=0;i<length;i++){var description=$(stanza).find("description")[i];remoteMedia.push($(description).attr("media"))}this.setRemoteTypeMedia(remoteMedia,call),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){_call&&($log.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+_call.id),that.videoService.removeCallObject(_call))}),12e4,1,!0,call)}else{var jid=$(stanza).attr("from"),remoteMedia=[],peerJid=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.getBareJidFromJid(jid);(call=_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.create(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN,id,_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Type.WEBRTC)).fullJid=jid,that.videoService.calls[call.id]=call,that.videoService.config&&that.videoService.config.unifiedPlan&&(call.unifiedPlanActivated=!0),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_3___default.a.FeaturesEnum.WEBRTC_UNIFIED_PLAN)&&$(stanza).find("unifiedplan").length&&(call.unifiedPlanActivated=!0),that.getOrCreateContact(peerJid,stanza).then((function(contact){for(var length=$(stanza).find("description").length,i=0;i<length;i++){var description=$(stanza).find("description")[i];remoteMedia.push($(description).attr("media"))}if(that.videoService.calls[call.id]){if(call.contact=contact,$(stanza).find("subject").length>0){var subject=$(stanza).find("subject")[0];$log.debug("[VideoServiceEventHandler]   | onPropositionReceived subject Detected: "+subject.textContent),call.setSubject(subject.textContent)}call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING),that.setRemoteTypeMedia(remoteMedia,call),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),that.videoService.autoreleaseTimeout&&$interval.cancel(that.videoService.autoreleaseTimeout),that.videoService.autoreleaseTimeout=$interval((function(_call){_call&&($log.webrtc("[VideoServiceEventHandler]   | onPropositionReceived autoreleaseTimeout after 2 min : remove the call "+_call.id),that.videoService.removeCallObject(_call))}),12e4,1,!0,call)}})).catch((function(error){$log.error("[VideoServiceEventHandler]   | onPropositionReceived error "+error),that.videoService.removeCallObject(call)}))}},VideoServiceEventHandler.prototype.onRetractReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onRetractReceveid");var id=$(stanza).find("retract").attr("id"),call=this.videoService.calls[id];call&&(call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ANSWERING&&_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState(),this.videoService.removeCallObject(call)),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout)},VideoServiceEventHandler.prototype.onRejectReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onRejectReceived");var id=$(stanza).find("reject").attr("id"),call=this.videoService.calls[id],fullJid=$(stanza).attr("from"),calendarBusy="calendarBusy"===$(stanza).find("reject").attr("reason");this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout),call&&(call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RINGING_INCOMMING&&(null!==call.getMediaPillarCall()&&$rootScope.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",call),this.videoService.removeCallObject(call)),call.status===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.DIALING&&(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState(),this.videoService.removeCallObject(call)),call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING||call.fullJid&&call.fullJid===fullJid&&(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState(),this.videoService.removeCallObject(call))),calendarBusy&&this.videoService.openCalendarBusyPopup(call.contact.id)},VideoServiceEventHandler.prototype.onAcceptReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onAcceptReceived");var id=$(stanza).find("accept").attr("id"),call=this.videoService.calls[id],fullJid=$(stanza).attr("from");call&&fullJid!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid&&(null!==call.getMediaPillarCall()&&$rootScope.$broadcast("ON_MEDIAPILLAR_CALL_REMOTE_CTRL_EVENT",call),this.videoService.removeCallObject(call)),fullJid!==_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.userContact.fullJid&&this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout)},VideoServiceEventHandler.prototype.onProceedReceived=function(stanza){$log.info("[VideoServiceEventHandler]   | onProceedReceived"),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout);var id=$(stanza).find("proceed").attr("id"),call=this.videoService.calls[id],fullJid=$(stanza).attr("from");if(call.fullJid=fullJid,this.videoService.config&&this.videoService.config.unifiedPlan&&(call.unifiedPlanActivated=!0),$(stanza).find("unifiedplan").length&&(call.unifiedPlanActivated=!0),call.isInConversationWithMobile()&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO){var that=this,mediaToGet=[],mediaConstraints=that.videoService.getMobileMediaConstraints("video");mediaToGet=["audio","video"],call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO||(mediaToGet=["video"]),that.videoService.getBrowserMedia(mediaToGet,mediaConstraints.fixedVideoWidth,mediaConstraints.fixedVideoHeight,mediaConstraints.fixedFrameRate).then((function(stream){$log.info("[VideoServiceEventHandler]   | onProceedReceived --\x3e renegociate video quality"),call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO&&that.videoService.stopActiveAudioVideoStreams(null,!0),that.videoService.localStreams.push(stream),that.videoService.makeJingleCall(call)})).catch((function(error){$log.info("[VideoServiceEventHandler]   | onProceedReceived "+call+" failure : "+error.message),-1!==error.toString().indexOf("getUserMedia")?($log.info("onProceedReceived impossible, no webcam plugged"),that.videoService.openErrorPopup()):(that.videoService.releaseCall(call),that.videoService.resetToSafeState())}))}else call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING?this.videoService.makeJingleSharingCall(call):this.videoService.makeJingleCall(call)},VideoServiceEventHandler.prototype.incomingCall=function(callId){$log.info("[VideoServiceEventHandler] incomingCall "+callId);var that=this,call=null,sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.connection.jingle.sessions[callId];if(sess&&sess.peerjid){var peerJid=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.getBareJidFromJid(sess.peerjid),contact=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.getContactByJid(peerJid);call=this.videoService.getCallByJid(contact.jid,sess.peerjid)}call?(sess.sendRinging(),$interval((function(_call){that.videoService.answerJingleCall(_call)}),350,1,!0,call),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout),this.videoService.statsInterval&&($log.info("[VideoServiceEventHandler] remove getStats interval"),window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),that.videoService.createOrUpdateStatisticsForCall(call.id),$log.info("[VideoServiceEventHandler] start getStats interval"),this.videoService.statsInterval=sess.getStats(3e3)):($log.warn("[VideoServiceEventHandler] incomingCall no such call ! Terminate the session "),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState(),sess&&sess.terminate())},VideoServiceEventHandler.prototype.activeCall=function(callId){$log.info("[VideoServiceEventHandler] activeCall "+callId);var sess=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.connection.jingle.sessions[callId];this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout);var call=this.videoService.calls[callId];this.videoService.updateRemoteTypeMedia(sess.remoteType,call),call&&call.status.key!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.RELEASING.key&&call.status.key!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN.key&&(call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),call.startDuration(),this.videoService.attachDistantMediaStreams(!0,call)),call.isInitiator&&gaService.trackCallSuccessNumber(sess.localType)},VideoServiceEventHandler.prototype.terminatedCall=function(callId,callReason,doNotUpdatePresence){0===Object.keys(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.connection.jingle.sessions).length&&$log.webrtc("INFO    | all calls terminated");var call=this.videoService.calls[callId];call||0===this.videoService.calls.length?("busy"===callReason&&this.videoService.openErrorPopup("remoteUserNoMoreAvailable"),this.videoService.autoreleaseTimeout&&$interval.cancel(this.videoService.autoreleaseTimeout),this.videoService.disableAudioVideoMedia(null,callId),this.videoService.createOrUpdateStatisticsForCall(callId),this.videoService.callsStats[callId]&&delete this.videoService.callsStats[callId],call&&("cancel"!==callReason&&gaService.trackCallDuration((new Date).getTime()-call.startDate.getTime()),this.videoService.removeCallObject(call)),doNotUpdatePresence||$interval((function(){_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState()}),1e3,1,!0),this.videoService.statsInterval&&(window.clearInterval(this.videoService.statsInterval),this.videoService.statsinterval=null),this.videoService.displayWebRTCStats(callId),this.videoService.isUserContactInCall()||this.videoService.clearSrcObjectsFromElements()):$log.webrtc("INFO    | terminatedCall : no call with "+callId+" exists.")},VideoServiceEventHandler.prototype.onJingleError=function(sid){sid&&this.videoService.calls[sid]&&this.videoService.calls[sid].status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&(this.videoService.removeCallObject(this.calls[sid]),this.videoService.resetToSafeState(),this.videoService.openErrorPopup("IceConnectionFailed"))},VideoServiceEventHandler.prototype.iceConnectionStateChange=function(sid,sess){$log.info("[VideoServiceEventHandler] iceConnectionStateChange for "+sid);var that=this,activeCall=null,call=that.videoService.calls[sess.sid];try{if(sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"connected"===sess.peerconnection.iceConnectionState){$log.webrtc("INFO    | ICE Connection established successfully"),angular.element("#globalAudioTag")[0]&&$log.info("[VideoServiceEventHandler] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),that.videoService.reconnectCall=!1,(activeCall=that.videoService.calls[sid])&&activeCall.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&($log.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(sid)),sess.isRenegotiating&&($log.webrtc("INFO    | Renegotiating done"),sess.isRenegotiating=!1,$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",activeCall),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",activeCall)),sess.autoReconnectTimer&&($interval.cancel(sess.autoReconnectTimer),sess.autoReconnectTimer=null),gaService.endNegotiationTime();var negotiationTime=gaService.negotiationTime();negotiationTime&&($log.webrtc("INFO    | negotiation time: "+negotiationTime+"ms"),gaService.trackNegotiationTime()),activeCall&&activeCall.isInitiator&&gaService.trackICESuccess(sid)}sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"completed"===sess.peerconnection.iceConnectionState&&($log.webrtc("INFO    | ICE Connection completed successfully"),that.videoService.reconnectCall=!1,(activeCall=that.videoService.calls[sid])&&activeCall.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE&&($log.webrtc("INFO    | ICE Connection : call is active now !"),this.activeCall(sid)),sess.isRenegotiating&&($log.webrtc("INFO    | Renegotiating done"),sess.isRenegotiating=!1,$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",activeCall),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION_SUCCESS",activeCall))),sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"disconnected"===sess.peerconnection.iceConnectionState&&($log.webrtc("INFO    | signalingState disconnected"),call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&($log.webrtc("INFO    | iceConnectionStateChange go to connecting state"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call)),that.videoService.connected||(that.videoService.reconnectCall=!0),sess.autoReconnectTimer||(console.error("arm autoReconnectTimer"),sess.autoReconnectTimer=$interval((function(session){console.error("autoReconnectTimer -- execute"),that.videoService.connected&&(console.error("autoReconnectTimer -- network OK, proceed with reconnect"),session.reconnectSession())}),1e3,1,!0,sess))),sess.peerconnection&&"stable"===sess.peerconnection.signalingState&&"failed"===sess.peerconnection.iceConnectionState&&($log.webrtc("INFO    | signalingState FAILED"),call&&call.status!==_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.UNKNOWN&&($log.webrtc("INFO    | iceConnectionStateChange go to connecting state"),call.setStatus(_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.CONNECTING),$rootScope.$broadcast("ON_CALL_UPDATED_EVENT",call),$rootScope.$broadcast("ON_RECORDING_CNXLOST_EVENT")),that.videoService.connected||(that.videoService.reconnectCall=!0),that.videoService.connected&&(console.error("[videoServiceEventHandler] signalingState FAILED -- network OK, proceed with reconnect"),sess.reconnectSession()))}catch(error){try{$log.error("JINGLE  | iceconnectionstatechange error "+error),call?that.videoService.removeCallObject(call,"unsupported-applications"):_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.connection.jingle.terminate(null,"unsupported-applications"),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState()}catch(err){$log.error("JINGLE  | iceconnectionstatechange error "+err),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.resetBusyState()}}},VideoServiceEventHandler.prototype.mediaModified=function(sid,mediaType){$log.info("[VideoServiceEventHandler] mediaModified "+sid);var call=this.videoService.calls[sid];_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.connection.jingle.sessions[sid].isRenegotiating=!0,call.remoteMedia="sharing"===mediaType?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING:"video"===mediaType?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO:"sharing+video"===mediaType?_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.VIDEO|_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.SHARING:_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_5___default.a.setBusyState("dnd",this.videoService.calculatePresenceMessage(call)),$rootScope.$broadcast("ON_WEBRTC_CALL_ESCALATION",call)},VideoServiceEventHandler}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_models_call_model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(0),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__),uuid__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(27);angular.module("rainbow").service("webrtcServiceEventHandler",["$log","$q","$rootScope","videoService","webConferenceService",function($log,$q,$rootScope,videoService,webConferenceService){var service=this;this.nameSpace="urn:xmpp:jingle-message:0",this.messageHandlerRef=null,this.started=!1,this.start=function(){return this.started=!0,this.attachHandlers(),$q.when()},this.stop=function(){return this.started=!1,service.removeHandlers(),$q.when()},this.attachHandlers=function(){this.removeHandlers(),$log.info("[webrtcServiceEventHandler] attachHandlers"),this.messageHandlerRef||(this.messageHandlerRef=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.addHandler((function(stanza){try{return service.onMessageReceived(stanza),!0}catch(err){return $log.error("[webrtcServiceEventHandler] caught error "+err),!0}}),service.nameSpace,"message"))},this.removeHandlers=function(){$log.info("[webrtcServiceEventHandler] removeHandlers"),this.messageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.deleteHandler(this.messageHandlerRef),this.messageHandlerRef=null)},this.onMessageReceived=function(stanza){var fromJid=$(stanza).attr("from"),bareJid=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.getBareJidFromJid(fromJid),conferenceSessionId=$(stanza).find("propose").find("conference").attr("id");if(webConferenceService.getConferenceSessionById(conferenceSessionId))try{if($log.info("[webrtcServiceEventHandler]   | onMessageReceived"),$(stanza).find("propose").length>0){var id=$(stanza).find("propose").attr("id"),xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact.fullJid,to:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact.jid}).c("accept",{xmlns:this.nameSpace,id:id});_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.send(xmppMessage);xmppMessage=$msg({from:_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact.fullJid,to:bareJid}).c("proceed",{xmlns:this.nameSpace,id:id});return _src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.send(xmppMessage),!0}}catch(error){return videoService.videoEventHandler.onMessageReceived(stanza)}return videoService.videoEventHandler.onMessageReceived(stanza)},this.checkSessionAudioSentHealthStatus=function(sid){$log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- 0 audio packets sent !");var call=videoService.calls[sid];if(call&&!call.isInCallWithMediaPillar()){if(call.status.key===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE.key&&call.localMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&!call.isMuted){if(videoService.callsStatsSimplified[sid].numberOfErrorAudioSent+=1,videoService.callsStatsSimplified[sid].numberOfErrorAudioSent%2)return void $log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.jingle.sessions[call.id];session&&!session.isRenegotiating&&($log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego P2P call"),videoService.renegotiateCurrentCall(call)),$rootScope.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!0)}}else{var confSession=webConferenceService.getActiveConferenceSession();if(confSession&&confSession.id&&confSession.active&&"connected"===confSession.status){var audioSession=webConferenceService.getRemoteAudioSession(confSession.id);if(audioSession&&audioSession.sid===sid){if(videoService.callsStatsSimplified[sid].numberOfErrorAudioSent+=1,videoService.callsStatsSimplified[sid].numberOfErrorAudioSent%2)return void $log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- ingore");$log.info("[webrtcServiceEventHandler]   | checkSessionAudioSentHealthStatus --- renego SFU conference"),webConferenceService.onAudioProfileChangeEvent()}}}},this.checkSessionAudioReceivedHealthStatus=function(sid){$log.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- user hears nothing !");var call=videoService.calls[sid];if(call&&!call.isInCallWithMediaPillar())call.status.key===_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Status.ACTIVE.key&&call.remoteMedia&_src_models_call_model__WEBPACK_IMPORTED_MODULE_0__.Call.Media.AUDIO&&(videoService.callsStatsSimplified[sid].errorAudioReceived=1,$log.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- reset output device"),videoService.resetAudioOutputElement());else{var confSession=webConferenceService.getActiveConferenceSession();if(confSession&&confSession.id&&confSession.active&&"connected"===confSession.status){var audioSession=webConferenceService.getRemoteAudioSession(confSession.id);audioSession&&audioSession.sid===sid&&(videoService.callsStatsSimplified[sid].errorAudioReceived=1,$log.info("[webrtcServiceEventHandler]   | checkSessionAudioReceivedHealthStatus --- renego SFU conference"),videoService.resetAudioOutputElement())}}},angular.element(document).bind("callincoming.jingle",(function(__event,sessId){$log.webrtc("webrtcServiceEventHandler  | callincoming.jingle "+sessId);var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.jingle.sessions[sessId];session&&session.confId?webConferenceService.onIncomingCall(sessId):videoService.videoEventHandler.incomingCall(sessId)})),angular.element(document).bind("callterminated.jingle",(function(__event,sessId,reason){$rootScope.$apply((function(){var callReason=reason||"";if($log.webrtc("webrtcServiceEventHandler  | callterminated "+sessId+" reason: "+callReason),"multi-device"===reason)webConferenceService.onConferenceCallSwitched(sessId);else if(videoService.calls[sessId]){var hasActiveConference=webConferenceService.hasActiveConferenceSession();videoService.videoEventHandler.terminatedCall(sessId,callReason,hasActiveConference)}else webConferenceService.onTerminatedCall(sessId)}))})),angular.element(document).bind("iceconnectionstatechange.jingle",(function(__event,sid,sess){sess.peerconnection?($log.webrtc("JINGLE  | iceconnectionstatechange "+sid+" "+sess.peerconnection.iceConnectionState+"|"+sess.peerconnection.signalingState),videoService.calls[sid]?videoService.videoEventHandler.iceConnectionStateChange(sid,sess):webConferenceService.onIceConnectionStateChange(sid,sess)):$log.webrtc("JINGLE  | iceconnectionstatechange - peerConnection does not exist anymore !!!")})),angular.element(document).bind("error.jingle",(function(__event,obj){$log.error("JINGLE  | callerror"),obj&&obj.error&&$log.error(JSON.stringify(obj.error));var sid=obj.sid;sid&&(videoService.calls[sid]?videoService.videoEventHandler.onJingleError(sid):webConferenceService.onJingleError(sid))})),angular.element(document).bind("webrtcSessionBitRate.jingle",(function(__event,sid,data){videoService.config.debugWeRTC&&$rootScope.$broadcast("ON_WEBRTC_CALL_BITRATE",sid,data)})),angular.element(document).bind("webrtcSessionStatsSimplyfied.jingle",(function(__event,sid,data){videoService.callsStatsSimplified[sid]||(videoService.callsStatsSimplified[sid]={},videoService.callsStatsSimplified[sid].numberOfErrorAudioSent=0,videoService.callsStatsSimplified[sid].errorAudioReceived=0),data.numberOfErrorAudioSent=videoService.callsStatsSimplified[sid].numberOfErrorAudioSent,data.errorAudioReceived=videoService.callsStatsSimplified[sid].errorAudioReceived,data.networkQualityIteration=videoService.callsStatsSimplified[sid].networkQualityIteration,videoService.callsStatsSimplified[sid]=data,$log.info("[videoService] on webrtcSessionStatsSimplyfied for session "+sid+" : "+JSON.stringify(data)),"chrome"===adapter.default.browserDetails.browser&&adapter.default.browserDetails.version<71&&(0===data.packetsAudioSent||0===data.audioInputLevel?service.checkSessionAudioSentHealthStatus(sid):(videoService.callsStatsSimplified[sid].numberOfErrorAudioSent&&$rootScope.$broadcast("ON_WEBRTC_CALL_AUDIO_ISSUE",!1),videoService.callsStatsSimplified[sid].numberOfErrorAudioSent=0)),data.packetsAudioReceived&&0===data.audioOutputLevel&&0===data.errorAudioReceived&&service.checkSessionAudioReceivedHealthStatus(sid);var call=videoService.calls[sid];call?(videoService.callsStatsSimplified[sid].networkQualityFlag===call.networkQuality?(videoService.callsStatsSimplified[sid].networkQualityIteration=videoService.callsStatsSimplified[sid].networkQualityIteration?videoService.callsStatsSimplified[sid].networkQualityIteration+1:1,0===call.networkQuality&&videoService.callsStatsSimplified[sid].networkQualityIteration>=3&&call.publish("badNetworkQuality",call.networkQuality)):videoService.callsStatsSimplified[sid].networkQualityIteration=1,call.networkQuality=data.networkQualityFlag,call.publish("networkQuality",call.networkQuality)):webConferenceService.onNetworkQualityChange(sid)})),angular.element(document).bind("refer.jingle",(function(__event,sid,status,confEndpointId,referTo){$log.webrtc("JINGLE  | refer: "+sid+" - status: "+status+" - confEndpointId: "+confEndpointId+" - referTo: "+referTo);var session=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_1___default.a.connection.jingle.sessions[sid];if("complete"===status){var call=videoService.calls[sid];videoService.onCallTransferredToConference(call)}else session?webConferenceService.transferCall(session,referTo,confEndpointId,"web_"+uuid__WEBPACK_IMPORTED_MODULE_3__(),webConferenceService.MEDIATYPE.WEBRTC).then((function(confSession){videoService.sendReferStatus(sid,"complete")})):$log.error("JINGLE  | refer.jingle -- no session ")}))}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var crypto_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(18),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(26),_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(31),_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_3__),_src_services_core_country_service__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(63),_src_services_core_country_service__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_src_services_core_country_service__WEBPACK_IMPORTED_MODULE_4__),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_6___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_6__),_src_models_company_model__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(19);angular.module("rainbow").service("companyDirectoryService",["$rootScope","$q","$log","$http","errorHelperService","centralizedService","directoryContact",function($rootScope,$q,$log,$http,errorHelperService,centralizedService,directoryContact){var service=this,listeners=[];service.companies=[],service.start=function(stats){$log.info(""),$log.info("[companyDirectoryService] === STARTING ===");var startDate=performance.now();service.portalURL=config.restServerUrl+"/api/rainbow/directory/v1.0/";var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"companyDirectoryService",startDuration:startDuration}),$log.info("[companyDirectoryService] === STARTED ("+startDuration+" ms) ==="),$q.when()},service.stop=function(){var listener;for($log.info(""),$log.info("[companyDirectoryService] === STOPPING ===");listener=listeners.pop();)listener();return $log.info("[companyDirectoryService] === STOPPED ==="),$q.when()},service.getDirectoryContacts=function(companyId,page,pageSize,searchPattern,searchBy,format){return $q((function(resolve,reject){var url=service.portalURL+"entries?format="+(format||"full");if(url+="&companyId="+companyId,url+="&limit="+pageSize,page&&(url+="&offset="+pageSize*(page-1)),searchPattern)switch(searchBy){case"phoneNumbers":case"tags":url+="&"+searchBy+"="+encodeURIComponent(searchPattern);break;case"name":default:url+="&name="+encodeURIComponent(searchPattern)}$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[companyDirectoryService] getDirectoryContacts success (found "+response.data.total+" contact(s))");var data=response.data.data,contacts=[];data.forEach((function(contactData){var contact=directoryContact(contactData);contacts.push(contact)})),resolve({contacts:contacts,limit:response.data.limit,offset:response.data.offset,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"getDirectoryContacts"))}))}))},service.createDirectoryContact=function(entry){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"entries",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:entry}).then((function(response){var contact=directoryContact(response.data.data);$log.info("[companyDirectoryService] createDirectoryContact success"),$rootScope.$broadcast("ADMIN_DIRECTORY_CHANGE",contact),resolve(contact)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"createDirectoryContact"))}))}))},service.getDirectoryContact=function(id,format){return $q((function(resolve,reject){var url=service.portalURL+"entries/"+id+"?format="+(format||"full");$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[companyDirectoryService] getDirectoryContact success");var contact=directoryContact(response.data.data);resolve(contact)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"getDirectoryContact"))}))}))},service.updateDirectoryContact=function(entry){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"entries/"+entry.id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:entry}).then((function(response){var contact=directoryContact(response.data.data);$log.info("[companyDirectoryService] updateDirectoryContact success"),$rootScope.$broadcast("ADMIN_DIRECTORY_CHANGE",contact),resolve(contact)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"updateDirectoryContact"))}))}))},service.deleteDirectoryContact=function(id){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"entries/"+id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[companyDirectoryService] deleteDirectoryContact success"),$rootScope.$broadcast("ADMIN_DIRECTORY_CHANGE"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"deleteDirectoryContact"))}))}))},service.getTags=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"entries/tags";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[companyDirectoryService] getTags success"),resolve(response.data.data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"getTags"))}))}))},service.getTagsStats=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"entries/tags/stats";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var tagsStats=response.data.data.stats||[];$log.info("[companyDirectoryService] getTagsStats success (find "+tagsStats.length+"tags(s))"),resolve(tagsStats)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"getTagsStats"))}))}))},service.renameTag=function(tag,newTagName,companyId){return $q((function(resolve,reject){var url=service.portalURL+"entries/tags?tag="+encodeURIComponent(tag);companyId&&(url+="&companyId="+companyId),$http({method:"PUT",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:{newTagName:newTagName}}).then((function(response){$log.info("[companyDirectoryService] renameTag success => old tag: "+tag+" => new tag: "+newTagName+": found "+response.data.data.found+" occurence(s)"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"renameTag"))}))}))},service.deleteTag=function(tag,companyId){return $q((function(resolve,reject){var url=service.portalURL+"entries/tags?tag="+encodeURIComponent(tag);companyId&&(url+="&companyId="+companyId),$http({method:"DELETE",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[companyDirectoryService] deleteTag success (tag "+tag+": found "+response.data.data.found+" occurence(s)"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"deleteTag"))}))}))},service.search=function(searchPattern,companyId){return $q((function(resolve){var searchType=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_5___default.a.FeaturesEnum.SEARCH_BY_TAGS)?"search=":"name=",url=service.portalURL+"entries?format=full&"+searchType+encodeURIComponent(searchPattern);companyId&&(url+="&companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var companyContacts=response.data.data.map((function(contactData){return service.createAndUpdateContact(contactData)}));$log.info("[companyDirectoryService] search success "+companyContacts.length),resolve(companyContacts)}),(function(response){resolve([]),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"search"))}))}))},service.searchCompanies=function(searchPattern,companyId){return $q((function(resolve){var url=service.portalURL+"entries?format=full&companyName="+encodeURIComponent(searchPattern);companyId&&(url+="&companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[companyDirectoryService] searchCompanies success");var companies=response.data.data.map((function(directoryCompanyData){var company=_src_models_company_model__WEBPACK_IMPORTED_MODULE_7__.Company.create(directoryCompanyData.id,directoryCompanyData.companyName);return company.country=directoryCompanyData.country,service.getCompanyLogo(company),service.getCompanyBanner(company),service.companies[company.id]=company,company}));resolve(companies)}),(function(response){resolve([]),$log.error("[companyDirectoryService] "+errorHelperService.getErrorFullMessage(response,"searchCompanies"))}))}))},service.getCompanyLogo=function(company){return $q((function(resolve){var companyColor=_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_3___default.a.computeUserColor(company.name),companyInitials=company.name.substr(0,1);company.logo=_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_3___default.a.getAvatarImage(company.id,companyInitials,companyColor.color,130,company.lastAvatarUpdateDate),$rootScope.$broadcast("ON_COMPANY_LOGO_UPDATED",company.id),$log.info("[companyService] getCompanyLogo - "+company.getNameForLogs()+" - success"),company.sendChangeEvent("logo"),resolve(company)}))},service.getCompanyBanner=function(company){return $q((function(resolve){var image=new Image;image.onload=function(){company.banner=image,$rootScope.$broadcast("ON_COMPANY_BANNER_UPDATED",company.id),$log.info("[getCompanyBanner] - "+company.getNameForLogs()+" - success"),resolve(company)},image.onerror=function(){$log.error("[companyService] Load banner for "+company.getNameForLogs()+" failure"),resolve(company)};var imgSrc=window.rainbowSDK?null:"/cacheV2/images/company-banner-01.svg";if(company.lastBannerUpdateDate){var serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2___default.a.cdn&&(serverURL=_src_services_core_main_service__WEBPACK_IMPORTED_MODULE_2___default.a.cdnServer),imgSrc=serverURL+"/api/banner/"+company.id+"?size=831",imgSrc+="&update="+Object(crypto_js__WEBPACK_IMPORTED_MODULE_0__.MD5)(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Latin1.parse(company.lastBannerUpdateDate)).toString(crypto_js__WEBPACK_IMPORTED_MODULE_0__.enc.Hex)}image.src=imgSrc}))},service.getCompanyById=function(companyId){if(!companyId)throw new Error("missing companyId");var company=service.companies[companyId];return $log.info("[companyDirectoryService] getCompanyById (cache) "+companyId+" - success"),company},service.createAndUpdateContact=function(contactData){var contact=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_6___default.a.createBasicContact(contactData.id,null,!1);return contact.mobilePhones=contactData.mobilePhoneNumbers,contact.businessPhones=contactData.workPhoneNumbers,contact.email=contactData.eMail,contact.updateName(contactData.firstName,contactData.lastName),contact.getAvatar(),contact.companyDirectoryFlag=!0,contact.businessCompanyId=contactData.companyId,contact.companyName=contactData.companyName,contact.note1=contactData.custom1,contact.note2=contactData.custom2,contact.department=contactData.department,contact.jobTitle=contactData.jobTitle,contact.otherPhoneNumbers=contactData.otherPhoneNumbers,contact.tags=contactData.tags?contactData.tags:void 0,contact.city=contactData.city,contact.postalCode=contactData.postalCode,contact.street=contactData.street,contact.state=_src_services_core_country_service__WEBPACK_IMPORTED_MODULE_4___default.a.getStateName(contactData.country,contactData.state),contact.country=_src_services_core_country_service__WEBPACK_IMPORTED_MODULE_4___default.a.getCountryName(contactData.country),contact},service.getAllDirectoryContacts=function(companyId){return $q((function(resolve,reject){var result;service.getDirectoryContacts(companyId,1,1e3).then((function(response){if(result=response,response.total>response.limit){var totalPages=Math.ceil(response.total/1e3),pages=Array.apply(null,Array(totalPages-1));pages=pages.map((function(__unused,index){return index+2}));for(var chunks=[];pages.length>0;)chunks.push(pages.splice(0,5));return chunks.reduce((function(promiseChain,requests){return promiseChain.then((function(){var promisesArray=requests.map((function(page){return service.getDirectoryContacts(companyId,page,1e3).then((function(data){result.contacts=result.contacts.concat(data.contacts),result.limit+=data.limit}))}));return $q.all(promisesArray)}))}),$q.resolve())}})).then((function(){resolve(result)})).catch((function(error){reject(error)}))}))},service.buildDirectoryCsvBlob=function(companyId){return $q((function(resolve,reject){$log.info("[companyDirectoryService] === buildDirectoryCsvBlob ==="),service.getAllDirectoryContacts(companyId).then((function(result){var maxWorkPhoneNumbers=Math.max(1,result.contacts.reduce((function(max,contact){return Math.max(max,contact.workPhoneNumbers?contact.workPhoneNumbers.length:0)}),0)),maxMobilePhoneNumbers=Math.max(1,result.contacts.reduce((function(max,contact){return Math.max(max,contact.mobilePhoneNumbers?contact.mobilePhoneNumbers.length:0)}),0)),maxOtherPhoneNumbers=Math.max(1,result.contacts.reduce((function(max,contact){return Math.max(max,contact.otherPhoneNumbers?contact.otherPhoneNumbers.length:0)}),0)),csvWorkPhonesColumns=Array.apply(null,new Array(maxWorkPhoneNumbers)).map((function(val,i){return"workPhoneNumber"+i})),csvWorkPhonesExtraSeparators=Array.apply(null,new Array(maxWorkPhoneNumbers)).map((function(){return";"})),csvMobilePhonesColumns=Array.apply(null,new Array(maxMobilePhoneNumbers)).map((function(val,i){return"mobilePhoneNumber"+i})),csvMobilePhonesExtraSeparators=Array.apply(null,new Array(maxMobilePhoneNumbers)).map((function(){return";"})),csvOtherPhonesColumns=Array.apply(null,new Array(maxOtherPhoneNumbers)).map((function(val,i){return"otherPhoneNumber"+i})),csvOtherPhonesExtraSeparators=Array.apply(null,new Array(maxOtherPhoneNumbers)).map((function(){return";"})),csvDirectoryLines=[];csvDirectoryLines.push("firstName;lastName;companyName;department;street;city;postalCode;state;country;"+csvWorkPhonesColumns.join(";")+";"+csvMobilePhonesColumns.join(";")+";"+csvOtherPhonesColumns.join(";")+";jobTitle;eMail;custom1;custom2"),result.contacts.forEach((function(contact){var phoneNumbers,contactLine="";contactLine+=contact.firstName?contact.firstName:"",contactLine+=";",contactLine+=contact.lastName?contact.lastName:"",contactLine+=";",contactLine+=contact.companyName?contact.companyName:"",contactLine+=";",contactLine+=contact.department?contact.department:"",contactLine+=";",contactLine+=contact.street?contact.street:"",contactLine+=";",contactLine+=contact.city?contact.city:"",contactLine+=";",contactLine+=contact.postalCode?contact.postalCode:"",contactLine+=";",contactLine+=contact.state?contact.state:"",contactLine+=";",contactLine+=contact.country?contact.country:"",contactLine+=";",contactLine+=(phoneNumbers=contact.workPhoneNumbers&&contact.workPhoneNumbers.length>0?contact.workPhoneNumbers:[""]).map((function(number){return number})).join(";"),contactLine+=csvWorkPhonesExtraSeparators.slice(phoneNumbers.length).join(""),contactLine+=";",contactLine+=(phoneNumbers=contact.mobilePhoneNumbers&&contact.mobilePhoneNumbers.length>0?contact.mobilePhoneNumbers:[""]).map((function(number){return number})).join(";"),contactLine+=csvMobilePhonesExtraSeparators.slice(phoneNumbers.length).join(""),contactLine+=";",contactLine+=(phoneNumbers=contact.otherPhoneNumbers&&contact.otherPhoneNumbers.length>0?contact.otherPhoneNumbers:[""]).map((function(number){return number})).join(";"),contactLine+=csvOtherPhonesExtraSeparators.slice(phoneNumbers.length).join(""),contactLine+=";",contactLine+=contact.jobTitle?contact.jobTitle:"",contactLine+=";",contactLine+=contact.eMail?contact.eMail:"",contactLine+=";",contactLine+=contact.custom1?contact.custom1:"",contactLine+=";",contactLine+=contact.custom2?contact.custom2:"",csvDirectoryLines.push(contactLine)}));var directoryBlob=new Blob([csvDirectoryLines.join("\r\n")],{type:"text/csv; charset=utf-8"});resolve(directoryBlob)})).catch((function(error){reject(error)}))}))},service.exportDirectoryCsvFile=function(companyId){return $q((function(resolve,reject){$log.info("[companyDirectoryService] === exportDirectoryCsvFile ===");var fileBlob,csvFilename="directory_"+moment().format("YYYY-MM-DD_HH-mm")+".csv";service.buildDirectoryCsvBlob(companyId).then((function(blob){return fileBlob=blob,centralizedService.fileSaver.promptFolderPathAndSavePromise(csvFilename)})).then((function(){centralizedService.fileSaver.fileDownload(fileBlob,null,null,csvFilename,!0),resolve()})).catch((function(error){reject(error)}))}))}}])},function(module,exports){!function(){"use strict";angular.module("rainbow").service("browserService",[function(){this.extractBrowserVersion=function(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}}])}()},function(module,exports){angular.module("rainbow").service("gRTCStatsService",[function(){"use strict";var calls={};this.resetStatsForAllCalls=function(){calls={}},this.resetStatsForCall=function(callid){callid in calls&&delete calls[callid]},this.getCalls=function(){return calls},this.nbCalls=function(){return Object.keys(calls).length},this.hasStatsForCall=function(callid){return callid in calls},this.addStreamToCall=function(callid,stream){callid in calls||(calls[callid]={});var call=calls[callid];call[stream.id]={},call[stream.id].stream=stream},this.nbStreamsInACall=function(callid){return callid in calls?Object.keys(calls[callid]).length:0},this.getBundlePolicyForCall=function(callid){if(!(callid in calls))return"unknown";var call=calls[callid],nbActiveStream=0,nbTotalStreams=this.nbStreamsInACall(callid);for(var componentID in call)"selectedCandidatePairId"in call[componentID].stream&&nbActiveStream++;if(4===nbTotalStreams)switch(nbActiveStream){case 0:return"failed";case 1:return"max-bundle";case 2:return"balanced";case 4:return"max-compat";default:return"unknown"}else{if(2!==nbTotalStreams)return"unknown";switch(nbActiveStream){case 0:return"failed";case 1:return"max-bundle";case 2:return"max-compat";default:return"unknown"}}},this.addSSRCToStream=function(callid,ssrc){var call,stream=null;"ssrc"===ssrc.type&&callid in calls&&(call=calls[callid],ssrc.transportId in call&&((stream=call[ssrc.transportId]).ssrc||(stream.ssrc={}),stream.ssrc[ssrc.ssrc]=ssrc))},this.hasSSRCInStream=function(callid,streamid,ssrcid){var call,stream;return callid in calls&&(streamid in(call=calls[callid])&&(!!(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc))},this.getSSRCMediaType=function(callid,streamid,ssrcid){var call,stream;return callid in calls&&streamid in(call=calls[callid])&&(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc?stream.ssrc[ssrcid].mediaType:"unknown"},this.getSSRCDirection=function(callid,streamid,ssrcid){var call,stream,ssrc;return callid in calls&&streamid in(call=calls[callid])&&(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc?(ssrc=stream.ssrc[ssrcid],getDirection(ssrc.id)):"unknown"},this.getSSRCAudioCodecName=function(callid,streamid,ssrcid){var call,stream;return callid in calls&&streamid in(call=calls[callid])&&(stream=call[streamid]).ssrc&&ssrcid in stream.ssrc?stream.ssrc[ssrcid].googCodecName:"unknown"},this.isSSRCFlowing=function(callid,streamid,ssrcid){var call,stream,ssrc;if(!(callid in calls))return!1;if(!(streamid in(call=calls[callid])))return!1;if(!(stream=call[streamid]).ssrc)return!1;if(!(ssrcid in stream.ssrc))return!1;ssrc=stream.ssrc[ssrcid];return("IN"===getDirection(ssrc.id)?parseInt(ssrc.bytesReceived,10):parseInt(ssrc.bytesSent,10))>0},this.getStreamsDetailsFromCall=function(callid){var call=null,stream=null;if(!(callid in calls))return[];call=calls[callid];var streams=[];for(var streamid in call)if(call.hasOwnProperty(streamid)){stream=call[streamid];var audioResult="no",videoResult="no",hasAudioIN=!1,hasVideoIN=!1,hasAudioOUT=!1,hasVideoOUT=!1;for(var ssrcid in stream.ssrc)if(stream.ssrc&&stream.ssrc.hasOwnProperty&&stream.ssrc.hasOwnProperty(ssrcid)){var type=this.getSSRCMediaType(callid,streamid,ssrcid),direction=this.getSSRCDirection(callid,streamid,ssrcid),isFlowing=this.isSSRCFlowing(callid,streamid,ssrcid);"audio"===type&&"IN"===direction&&isFlowing?hasAudioIN=!0:"audio"===type&&"OUT"===direction&&isFlowing?hasAudioOUT=!0:"video"===type&&"IN"===direction&&isFlowing?hasVideoIN=!0:"video"===type&&"OUT"===direction&&isFlowing&&(hasVideoOUT=!0)}hasAudioIN&&hasAudioOUT?audioResult="IN|OUT":hasAudioIN?audioResult="IN":hasAudioOUT&&(audioResult="OUT"),hasVideoIN&&hasVideoOUT?videoResult="IN|OUT":hasVideoIN?videoResult="IN":hasVideoOUT&&(videoResult="OUT"),hasAudioIN||hasAudioOUT||hasVideoIN||hasVideoOUT?streams.push({id:streamid,streams:{audio:audioResult,video:videoResult}}):streams.push({id:streamid,streams:{}})}return streams},this.getCodecDetailsFromCall=function(callid){var call=null,stream=null,audioCodec="-",videoCodec="-",codecs={codec:{audio:audioCodec,video:videoCodec}};if(!(callid in calls))return codecs;for(var streamid in call=calls[callid])if(call.hasOwnProperty(streamid))for(var ssrcid in(stream=call[streamid]).ssrc)"audio"===stream.ssrc[ssrcid].mediaType&&(audioCodec=this.getSSRCAudioCodecName(callid,streamid,ssrcid)),"video"===stream.ssrc[ssrcid].mediaType&&(videoCodec=this.getSSRCAudioCodecName(callid,streamid,ssrcid));return codecs.codec.audio=audioCodec,codecs.codec.video=videoCodec,codecs};var getDirection=function(id){return id.indexOf("recv")>-1?"IN":"OUT"}}])},function(module,exports){angular.module("rainbow").service("fRTCStatsService",[function(){"use strict";var calls={};this.getCalls=function(){return calls},this.nbCalls=function(){return Object.keys(calls).length},this.addStreamToCall=function(callid,stream){if(!stream.isRemote){callid in calls||(calls[callid]={});var call=calls[callid];call.streams||(call.streams={}),call.streams[stream.id]={},call.streams[stream.id]=stream}},this.nbStreamsInACall=function(callid){return callid in calls?Object.keys(calls[callid].streams).length:0},this.resetStatsForAllCalls=function(){calls={}},this.resetStatsForCall=function(callid){callid in calls&&delete calls[callid]},this.hasStatsForCall=function(callid){return callid in calls},this.hasSSRCInStream=function(callid,streamid,ssrcid){var call;return callid in calls&&(!!(call=calls[callid]).streams&&(streamid in call.streams&&call.streams[streamid].ssrc===ssrcid))},this.hasStreamInCall=function(callid,streamid){return callid in calls&&streamid in calls[callid].streams},this.getSSRCMediaType=function(callid,streamid){var call;return callid in calls&&streamid in(call=calls[callid]).streams?call.streams[streamid].mediaType:"unknown"},this.getStreamsDetailsFromCall=function(callid){var call=null;if(!(callid in calls))return[];call=calls[callid];var streams=[];for(var streamid in call.streams)if(call.streams.hasOwnProperty(streamid)){var type=this.getSSRCMediaType(callid,streamid),direction=getDirection(streamid);"audio"===type?streams.push({id:streamid,streams:{audio:direction}}):"video"===type&&streams.push({id:streamid,streams:{video:direction}})}return streams},this.addCandidatePairToCall=function(callid,candidatePair){var call=null,hasAlreadyThisCandidatePair=!1;if(callid in calls){(call=calls[callid]).candidatesPairs||(call.candidatesPairs=[]);for(var i=0;i<call.candidatesPairs.length;i++)if(call.candidatesPairs[i].id===candidatePair.id){hasAlreadyThisCandidatePair=!0;break}!hasAlreadyThisCandidatePair&&"succeeded"===candidatePair.state&&candidatePair.selected&&call.candidatesPairs.push(candidatePair)}},this.getNbCandidatePairs=function(callid){var call,nbCandidatePairs=0;return callid in calls?((call=calls[callid]).candidatesPairs&&(nbCandidatePairs=call.candidatesPairs.length),nbCandidatePairs):nbCandidatePairs},this.getBundlePolicyForCall=function(callid){var policy="unknown";if(!(callid in calls))return policy;switch(this.getNbCandidatePairs(callid)){case 0:policy="failed";break;case 1:policy="max-bundle";break;case 2:policy=this.nbStreamsInACall(callid)>2?"balanced":"max-compat";break;default:policy="max-compat"}return policy};var getDirection=function(id){return id.indexOf("inbound")>-1?"IN":"OUT"}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(5),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0__),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2__);angular.module("rainbow").service("platformService",["$log","$rootScope","$window","$interval","$q","$filter","$http","errorHelperService",function($log,$rootScope,$window,$interval,$q,$filter,$http,errorHelperService){var service=this,listeners=[],xmppConnectionSubscription=null;service.$q=$q,this.isWin=navigator.platform.toUpperCase().indexOf("WIN")>=0,service.start=function(stats){return $q((function(resolve,__reject){var startDate=performance.now();$log.info(""),$log.info("[platformService] === STARTING ==="),service.languages=["en","fr","es","de"],listeners.push($rootScope.$on("$translateChangeSuccess",(function(){service.fixDeviceLabels()}))),listeners.push($rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",onAudioInputChange)),listeners.push($rootScope.$on("ON_OUTPUT_DEVICE_CHANGED_EVENT",updateOutputDevice)),xmppConnectionSubscription=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_2___default.a.subscribeToConnectionEvents((function(event){service.onAuthenticationStatusChangedEvent(event)})),service.isAskingMedia=!1,service.hasAudioPermission=!1,service.hasVideoPermission=!1,service.stopWatcher(),$interval(service.startWatcher,2e3,1);var startDuration=Math.round(performance.now()-startDate);stats.push({service:"platformService",startDuration:startDuration}),$log.info("[platformService] === STARTED ("+startDuration+" ms) ==="),resolve()}))},service.stop=function(){return $log.info("[platformService] === STOPPING ==="),listeners.forEach((function(listener){listener()})),xmppConnectionSubscription&&xmppConnectionSubscription.unsubscribe(),service.stopWatcher(),this.mediaDevicesLength=0,this.mediaDevices=[],$log.info("[platformService] === STOPPED ==="),$q.when()},service.onAuthenticationStatusChangedEvent=function(event){"ON_XMPP_CONNECTED"===event.name&&(!service.allowDevicesManagement()||!$("#globalAudioTag")[0]||$("#globalAudioTag")[0].sinkId&&"default"!==$("#globalAudioTag")[0].sinkId||($log.info("[platformService] onAuthenticationStatusChangedEvent -- update global audio tag"),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)}))),service.testGetUserMedia())},this.audioDevices=0,this.videoDevices=0,this.detectRTCLoaded=function(){service.hasAudioPermission=DetectRTC.isWebsiteHasMicrophonePermissions,service.hasVideoPermission=DetectRTC.isWebsiteHasWebcamPermissions,service.fixDeviceLabels();var shouldAskAudio=!1,shouldAskVideo=!1,shouldAskMedia=service.shouldAskGetUserMedia();(DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length||DetectRTC.audioOutputDevices&&DetectRTC.audioOutputDevices.length)&&(!service.hasAudioPermission||shouldAskMedia.audio?shouldAskAudio=!0:_isWebsiteHasMicrophonePermissions=!0),DetectRTC.videoInputDevices&&DetectRTC.videoInputDevices.length&&(!service.hasVideoPermission||shouldAskMedia.video?shouldAskVideo=!0:_isWebsiteHasWebcamPermissions=!0),shouldAskAudio||shouldAskVideo?service.isAskingMedia||(service.isAskingMedia=!0,service.getUserMedia(shouldAskAudio,shouldAskVideo)):(service.fixDeviceLabels(),updateHeadsetDevices().then((function(){service.updateNewDesktopDevicesIds(),updateAvailability(),service.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(service.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,service.audioMediaDeviceUpdated()),service.videoDevices!==DetectRTC.videoInputDevices.length&&(service.videoDevices=DetectRTC.videoInputDevices.length,service.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&$log.info("[PlatformService] DetectRTC.MediaDevices device "+mediaDevice.id+" with kind "+mediaDevice.kind+" with label "+mediaDevice.label)})),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})),service.newDevice&&service.checkAndUpdateHandFreeProfile(),service.startWatcher()})))},this.testGetUserMedia=function(){if(service.hasAudioPermission){var startDate=performance.now();service.getCurrentMicrophone().then((function(microphone){var constraints={},mic="default";microphone?(constraints.audio={optional:[{sourceId:microphone.id}]},mic="id - "+microphone.id+" and label "+microphone.label):constraints.audio=!0,$log.info("[PlatformService] testGetUserMedia -- getUserMedia for Mic "+mic),navigator.mediaDevices.getUserMedia(constraints).then((function(stream){var completeStartDuration=Math.round(performance.now()-startDate);$log.info("[PlatformService] testGetUserMedia -- getUserMedia success for time : "+completeStartDuration+" ms"),angular.forEach(stream.getTracks(),(function(mediaStreamTrack){$log.info("[PlatformService] testGetUserMedia mediaStreamTrack -- "+mediaStreamTrack.label),mediaStreamTrack.stop()})),_isWebsiteHasMicrophonePermissions=!0,service.isAskingMedia=!1})).catch((function(error){$log.info("[PlatformService] testGetUserMedia -- getUserMedia error "+error),service.isAskingMedia=!1}))}))}else $log.info("[PlatformService] testGetUserMedia -- no audio permission given")},this.shouldAskGetUserMedia=function(){var result={audio:!1,video:!1};return angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&mediaDevice.label&&-1!==mediaDevice.label.indexOf("invoke getUserMedia")&&("audioinput"===mediaDevice.kind||"audiooutput"===mediaDevice.kind?result.audio=!0:result.video=!0)})),$log.info("[platformService] shouldAskGetUserMedia : audio "+result.audio+" and video "+result.video),result},this.updateNewDesktopDevicesIds=function(){var handFreeInputDeviceName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("handFreeInputDeviceName"),handFreeOutputDeviceName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("handFreeOutputDeviceName"),headsetDeviceName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("headsetDeviceName"),customMicrophoneName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("customMicrophoneName"),customSpeakerName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("customSpeakerName"),cameraUsed=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("cameraUsed"),secondRinging=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("ringingSpeakerName");(handFreeInputDeviceName||handFreeOutputDeviceName||headsetDeviceName||customMicrophoneName||customSpeakerName)&&angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){"audioinput"===mediaDevice.kind?(mediaDevice.normalizedLabel===headsetDeviceName&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("headsetMicrophone",mediaDevice.id),mediaDevice.normalizedLabel===handFreeInputDeviceName&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("microphone",mediaDevice.id),mediaDevice.normalizedLabel===customMicrophoneName&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("customMicrophone",mediaDevice.id)):"audiooutput"===mediaDevice.kind&&(mediaDevice.normalizedLabel===headsetDeviceName&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("headsetSpeaker",mediaDevice.id),mediaDevice.normalizedLabel===handFreeOutputDeviceName&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("speaker",mediaDevice.id),mediaDevice.normalizedLabel===customSpeakerName&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("customSpeaker",mediaDevice.id))})),cameraUsed&&angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){"videoinput"===mediaDevice.kind&&mediaDevice.label===cameraUsed&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("camera",mediaDevice.id)})),secondRinging&&angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){"audiooutput"===mediaDevice.kind&&mediaDevice.normalizedLabel===secondRinging&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("ringingSpeaker",mediaDevice.id)}))},this.mediaDevicesLength=0,this.mediaDevices=[],this.newDevice=null,this.devicesWatcher=function(){navigator&&navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices().then((function(devices){(service.mediaDevicesLength!==devices.length||service.checkForIdChange(devices))&&($log.debug("[platformService] MediaDevices count changed ! from "+service.mediaDevicesLength+" to "+devices.length),$log.debug("[platformService] MediaDevices brut devices list "+JSON.stringify(devices)),devices.length-service.mediaDevicesLength==1?service.newDevice=service.getNewDevice(service.mediaDevices,devices):service.newDevice=null,service.mediaDevicesLength=devices.length,service.mediaDevices=devices,service.stopWatcher(),DetectRTC.load(service.detectRTCLoaded))}))},service.checkAndUpdateHandFreeProfile=function(){$log.info("[platformService] checkAndUpdateHandFreeProfile");var activeProfile=service.getActiveAudioProfile();1===activeProfile.key&&!0===activeProfile.available&&service.getCurrentSpeaker().then((function(speaker){speaker&&speaker.groupId===service.newDevice.groupId&&($log.info("[platformService] checkAndUpdateHandFreeProfile -- should update the Jack Mic"),$rootScope.$broadcast("ON_HANDFREE_JACK_MICROPHONE_EVENT",service.newDevice))}))},service.checkForIdChange=function(devices){var changed=!1;return service.mediaDevices.length&&angular.forEach(service.mediaDevices,(function(device){if("default"!==device.deviceId&&"communications"!==device.deviceId){for(var found=!1,i=0;i<devices.length;i++)device.deviceId===devices[i].deviceId&&(found=!0);found||(changed=!0)}})),changed&&$log.info("[platformService] checkForIdChange "+changed),changed},service.getNewDevice=function(oldDevices,newDevices){var newDevice=null;return newDevices.length&&angular.forEach(newDevices,(function(device){if("default"!==device.deviceId&&"communications"!==device.deviceId){for(var found=!1,i=0;i<oldDevices.length;i++)device.deviceId===oldDevices[i].deviceId&&(found=!0);found||"audioinput"!==device.kind||(newDevice=device)}})),newDevice},service.tryToGetUserMediaForEachDevice=function(){if($log.info("[platformService] tryToGetUserMediaForEachDevice"),DetectRTC.audioInputDevices&&DetectRTC.audioInputDevices.length){for(var chain=$q.when(),i=0;i<DetectRTC.audioInputDevices.length;i++)!function(index){var device=DetectRTC.audioInputDevices[index];chain=chain.then((function(){return service.getUserMediaForAudioDevice(device.id)}))}(i);chain=chain.finally((function(){if($log.info("[platformService] tryToGetUserMediaForEachDevice finally -- has audio permission "+service.hasAudioPermission),service.hasAudioPermission)service.loadDetectRTC();else{_isWebsiteHasMicrophonePermissions=!1,_isWebsiteHasWebcamPermissions=!1,service.isAskingMedia=!1;$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"information",popupBody:"devicePermission",okLabel:"ok"}),service.startWatcher()}}))}else $log.warn("[platformService] tryToGetUserMediaForEachDevice -- no audio devices found, restart the watcher"),service.isAskingMedia=!1,service.startWatcher()},service.getUserMediaForAudioDevice=function(id){return $q((function(resolve){if(service.hasAudioPermission)return $log.info("[platformService] getUserMediaForAudioDevice for id: "+id+" no longer needed !"),void resolve();if(!id)return $log.info("[platformService] getUserMediaForAudioDevice missing id !"),void resolve();$log.info("[platformService] getUserMediaForAudioDevice for id: "+id);var constraints={};constraints.audio={optional:[{sourceId:id}]},navigator.mediaDevices.getUserMedia(constraints).then((function(stream){$log.info("[platformService] getUserMediaForAudioDevice for id: "+id+" success"),angular.forEach(stream.getAudioTracks(),(function(mediaStreamTrack){mediaStreamTrack.stop()})),service.hasAudioPermission=!0,_isWebsiteHasMicrophonePermissions=!0,service.hasVideoPermission=!0,_isWebsiteHasWebcamPermissions=!0,resolve()})).catch((function(error){$log.info("[platformService] getUserMediaForAudioDevice for id: "+id+" failed with error "+error),resolve()}))}))},service.getUserMedia=function(audio,video){$log.info("[platformService] getUserMedia audio: "+audio+" and video: "+video),navigator.mediaDevices.getUserMedia({audio:audio,video:video}).then((function(stream){$log.info("[platformService] getUserMedia audio: "+audio+" and video: "+video+" -- success!"),angular.forEach(stream.getAudioTracks(),(function(mediaStreamTrack){mediaStreamTrack.stop()})),angular.forEach(stream.getVideoTracks(),(function(mediaStreamTrack){mediaStreamTrack.stop()})),audio&&(service.hasAudioPermission=!0,_isWebsiteHasMicrophonePermissions=!0),video&&(service.hasVideoPermission=!0,_isWebsiteHasWebcamPermissions=!0),stream=null,service.loadDetectRTC()})).catch((function(error){$log.error("[platformService] getUserMedia -- error -- "+error),service.tryToGetUserMediaForEachDevice()}))},service.loadDetectRTC=function(){DetectRTC.load((function(){service.fixDeviceLabels(),updateHeadsetDevices().then((function(){service.updateNewDesktopDevicesIds(),updateAvailability(),service.isAskingMedia=!1,service.audioDevices!==DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length&&(service.audioDevices=DetectRTC.audioInputDevices.length+DetectRTC.audioOutputDevices.length,service.audioMediaDeviceUpdated()),service.videoDevices!==DetectRTC.videoInputDevices.length&&(service.videoDevices=DetectRTC.videoInputDevices.length,service.videoMediaDeviceUpdated()),angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&$log.info("[PlatformService] DetectRTC.MediaDevices device "+mediaDevice.id+" with kind "+mediaDevice.kind+" with label "+mediaDevice.label)})),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})),service.startWatcher()}))}))},service.getWhatsNew=function(){return $q((function(resolve){var url=config.restServerUrl+"/api/rainbow/enduser/v1.0/settings/changelogs";$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminPlatformService] getWhatsNew -- success");var data=response.data.data.changeLog.split("%"),whatsNew={};data.forEach((function(markdown,index){whatsNew[service.languages[index]]=markdown})),Object.keys(whatsNew).forEach((function(key){0===whatsNew[key].length&&(whatsNew[key]=whatsNew.en)})),whatsNew.en||(whatsNew={en:"",fr:"",es:"",de:""}),resolve(whatsNew)}),(function(response){resolve({en:"",fr:"",es:"",de:""}),$log.error("[adminPlatformService] "+errorHelperService.getErrorFullMessage(response,"getWhatsNew"))}))}))},service.getAvailableLanguage=function(lang){var mainLang=lang.split("-")[0],realLang=service.languages.find((function(language){return language===mainLang}));return realLang||"en"},this.isDesktop=function(){return navigator.userAgent.indexOf(" Rainbow/")>=0},this.allowDevicesManagement=function(){return $window.chrome||this.isDesktop()};var _isWebsiteHasWebcamPermissions=!1;this.isWebsiteHasWebcamPermissions=function(){return!!service.allowDevicesManagement()&&_isWebsiteHasWebcamPermissions};var _isWebsiteHasMicrophonePermissions=!1;this.isWebsiteHasMicrophonePermissions=function(){return!!service.allowDevicesManagement()&&_isWebsiteHasMicrophonePermissions};var audioProfile={HANDFREE:{key:1,value:"handfree",available:!1},HEADSET:{key:2,value:"headset",available:!1},SPEAKERPHONE:{key:3,value:"speakerphone",available:!1},CUSTOM:{key:4,value:"custom",available:!1}};this.audioProfileEnum=audioProfile,this.getAudioProfiles=function(){return audioProfile},this.currentAudioProfile=audioProfile.HANDFREE,this.getCurrentAudioProfile=function(){var profile=null;switch(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("audioProfile")){case audioProfile.HEADSET.value:profile=audioProfile.HEADSET;break;case audioProfile.HANDFREE.value:profile=audioProfile.HANDFREE;break;case audioProfile.SPEAKERPHONE.value:profile=audioProfile.SPEAKERPHONE;break;case audioProfile.CUSTOM.value:profile=audioProfile.CUSTOM;break;default:profile=audioProfile.HANDFREE,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("audioProfile",profile.value)}return profile},this.getActiveAudioProfile=function(){var profile=this.getCurrentAudioProfile();return profile.key===audioProfile.HANDFREE.key||profile.available?profile:audioProfile.HANDFREE},this.setCurrentAudioProfile=function(profile){profile&&(service.currentAudioProfile=profile)},this.isHandfreeAvailable=function(){return service.isHandfreeMicrophoneAvailable()&&service.isHandfreeSpeakerAvailable()},this.isHeadsetAvailable=function(){return service.isHeadsetMicrophoneAvailable()&&service.isHeadsetSpeakerAvailable()},this.isSpeakerphoneAvailable=function(){return service.isSpeakerphoneMicrophoneAvailable()&&service.isSpeakerphoneSpeakerAvailable()},this.isCustomAvailable=function(){return service.isCustomMicrophoneAvailable()&&service.isCustomSpeakerAvailable()},this.getCurrentMicrophone=function(){if("sdk"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("apiMode")){var microphone=service.getMicrophoneForSDK();if(microphone)return microphone}switch(service.getActiveAudioProfile()){case audioProfile.SPEAKERPHONE:return service.getSpeakerphoneMicrophone();case audioProfile.CUSTOM:return service.getCustomMicrophone();case audioProfile.HEADSET:return service.getHeadsetMicrophone();default:return service.getHandfreeMicrophone()}},this.getMicrophoneForSDK=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("microphone")))})),deferred.promise},this.getSecondRingerStatusFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("hasSecondRinger")},this.setSecondRingerStatusFromSettings=function(val){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("hasSecondRinger",val)},this.getHandfreeMicrophoneFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("microphone")},this.getHandfreeMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHandfreeMicrophoneFromSettings()))})),deferred.promise},this.getHeadsetMicrophoneFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("headsetMicrophone")},this.getHeadsetMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHeadsetMicrophoneFromSettings()))})),deferred.promise},this.getHeadsetDeviceName=function(){var deferred=$q.defer();return deferred.resolve(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("headsetDeviceName")),deferred.promise},this.getSpeakerphoneMicrophoneFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("speakerphoneMicrophone")},this.getSpeakerphoneMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getSpeakerphoneMicrophoneFromSettings()))})),deferred.promise},this.getSpeakerphoneDeviceName=function(){var deferred=$q.defer();return deferred.resolve(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("speakerphoneDeviceName")),deferred.promise},this.getCustomMicrophoneFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("customMicrophone")},this.getCustomMicrophone=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getCustomMicrophoneFromSettings()))})),deferred.promise},this.getMicrophones=function(){var deferred=$q.defer();return this.allowDevicesManagement()||deferred.resolve([]),service.getAudioInputDevices().then((function(devices){deferred.resolve(devices&&devices.constructor===Array&&_isWebsiteHasMicrophonePermissions?devices:[])})).catch((function(error){return $log.info("[PlatformService] === SERVICES FAILURE === : "+error.message),deferred.reject(error),deferred.promise})),deferred.promise},this.isHandfreeMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHandfreeMicrophoneFromSettings(),"audioinput")},this.isHeadsetMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHeadsetMicrophoneFromSettings(),"audioinput")},this.isSpeakerphoneMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getSpeakerphoneMicrophoneFromSettings(),"audioinput")},this.isCustomMicrophoneAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getCustomMicrophoneFromSettings(),"audioinput")},this.getCurrentSpeaker=function(){if("sdk"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("apiMode")){var speaker=service.getSpeakerForSDK();if(speaker)return speaker}switch(service.getActiveAudioProfile()){case audioProfile.SPEAKERPHONE:return service.getSpeakerphoneSpeaker();case audioProfile.CUSTOM:return service.getCustomSpeaker();case audioProfile.HEADSET:return service.getHeadsetSpeaker();default:return service.getHandfreeSpeaker()}},this.getSpeakerForSDK=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("speaker")))})),deferred.promise},this.getHandfreeSpeakerFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("speaker")},this.getHandfreeSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHandfreeSpeakerFromSettings(),!0))})),deferred.promise},this.getHeadsetSpeakerFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("headsetSpeaker")},this.getHeadsetSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getHeadsetSpeakerFromSettings()))})),deferred.promise},this.getSpeakerphoneSpeakerFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("speakerphoneSpeaker")},this.getSpeakerphoneSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getSpeakerphoneSpeakerFromSettings()))})),deferred.promise},this.getCustomSpeakerFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("customSpeaker")},this.getCustomSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getCustomSpeakerFromSettings()))})),deferred.promise},this.getRingingSpeakerFromSettings=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("ringingSpeaker")},this.getRingingSpeaker=function(){var deferred=$q.defer();return service.getSpeakers().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,service.getRingingSpeakerFromSettings()))})),deferred.promise},this.setSpeakerForElement=function(element,sinkId){var defered=$q.defer();if(!element||!element.setSinkId)return $log.warn("[platformService] setSpeakerForElement -- missing element"),$q.when();if(this.allowDevicesManagement()){if(sinkId===element.sinkId)return $q.when();element.id&&$log.log("[platformService] setSpeakerForElement "+element.id+" with "+sinkId),element.setSinkId(sinkId).then((function(){$log.log("[platformService] Success, audio output device attached: "+sinkId),angular.element("#globalAudioTag")[0]&&$log.log("[platformService] sinkId for globalAudioTag is "+angular.element("#globalAudioTag")[0].sinkId),defered.resolve()})).catch((function(error){var errorMessage=error;"SecurityError"===error.name&&(errorMessage="[platformService] You need to use HTTPS for selecting audio output device: "+error),$log.error("[platformService] "+errorMessage),defered.resolve()}))}else $log.warn("[platformService] Browser does not support output device selection."),defered.resolve();return defered.promise},this.getSpeakers=function(){var deferred=$q.defer();return service.allowDevicesManagement()||deferred.resolve([]),service.getAudioOutputDevices().then((function(devices){deferred.resolve(devices&&devices.constructor===Array&&_isWebsiteHasMicrophonePermissions?devices:[])})).catch((function(error){return $log.info("[PlatformService] === SERVICES FAILURE === : "+error.message),deferred.reject(error),deferred.promise})),deferred.promise},this.isHandfreeSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHandfreeSpeakerFromSettings(),"audiooutput")};var _handfreeAvailibilityStatus=!1;this.isHeadsetSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getHeadsetSpeakerFromSettings(),"audiooutput")};var _headsetAvailibilityStatus=null;this.isSpeakerphoneSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getSpeakerphoneSpeakerFromSettings(),"audiooutput")};var _speakerphoneAvailibilityStatus=!1;this.isCustomSpeakerAvailable=function(){return service.isDeviceAvailable(service.mediaDevices,service.getCustomSpeakerFromSettings(),"audiooutput")};var _customAvailibilityStatus=!1;function onAudioInputChange(){updateAvailability(),service.isAskingMedia?$log.info("[PlatformService] onAudioInputChange -- already asking media -- ignore"):(service.isAskingMedia=!0,$interval(service.testGetUserMedia,2e3,1))}function updateAvailability(){var isAvailable;isAvailable=service.isHandfreeAvailable(),_handfreeAvailibilityStatus!==isAvailable&&($log.info("[PlatformService] Handfree is now "+(isAvailable?"available":"unavailable")),_handfreeAvailibilityStatus=isAvailable,audioProfile.HANDFREE.available=isAvailable,$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),isAvailable||service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)}))),function(isAvailable){if(_headsetAvailibilityStatus!==isAvailable){if($log.info("[PlatformService] Headset is now "+(isAvailable?"available":"unavailable")),_headsetAvailibilityStatus=isAvailable,audioProfile.HEADSET.available=isAvailable,isAvailable)_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("audioProfile")===audioProfile.HANDFREE.value&&(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("audioProfile",audioProfile.HEADSET.value),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})));else _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("audioProfile")===audioProfile.HEADSET.value&&_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("audioProfile",audioProfile.HANDFREE.value),service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)}));$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT")}}(service.isHeadsetAvailable()),function(isAvailable){_speakerphoneAvailibilityStatus!==isAvailable&&($log.info("[PlatformService] Speakerphone is now "+(isAvailable?"available":"unavailable")),_speakerphoneAvailibilityStatus=isAvailable,audioProfile.SPEAKERPHONE.available=isAvailable,$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),isAvailable||service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})))}(service.isSpeakerphoneAvailable()),function(isAvailable){_customAvailibilityStatus!==isAvailable&&($log.info("[PlatformService] Custom is now "+(isAvailable?"available":"unavailable")),_customAvailibilityStatus=isAvailable,audioProfile.CUSTOM.available=isAvailable,$rootScope.$broadcast("ON_AUDIO_PROFILE_CHANGED_EVENT",isAvailable),$rootScope.$broadcast("ON_INPUT_DEVICE_CHANGED_EVENT"),isAvailable||service.getCurrentSpeaker().then((function(device){device&&device.id&&updateCurrentOutputDevice(device.id)})))}(service.isCustomAvailable())}function updateOutputDevice(__event,device_id){updateAvailability(),$log.info("[PlatformService] updateOutputDevice "+device_id),service.allowDevicesManagement()&&device_id&&updateCurrentOutputDevice(device_id)}var currentUpdatingDeviceId="";function updateCurrentOutputDevice(device_id){$log.info("[PlatformService] updateCurrentOutputDevice "+device_id),angular.element("#globalAudioTag")[0]&&angular.element("#globalAudioTag")[0].sinkId!==device_id&&currentUpdatingDeviceId!==device_id?(currentUpdatingDeviceId=device_id,$log.info("[PlatformService] updateCurrentOutputDevice current ID "+angular.element("#globalAudioTag")[0].sinkId+" new id "+device_id),service.setSpeakerForElement(angular.element("#globalAudioTag")[0],"default").then((function(){service.setSpeakerForElement(angular.element("#globalAudioTag")[0],device_id),currentUpdatingDeviceId=""})).catch((function(){currentUpdatingDeviceId=""}))):$log.info("[PlatformService] updateCurrentOutputDevice -- ignored ")}var microphones=[],speakers=[],allDevices=[],headsetDevices=[],speakerphoneDevices=[],firstDeviceUpdateHeadset=!0,handfreeSupportedDevices=["realtek","soundmax","high definition audio","nomachine"];service.arrayContains=function(array,textSearched){return array.some((function(element){return textSearched.indexOf(element)>-1}))},service.getDeviceType=function(deviceLabel){return deviceLabel=deviceLabel.toLowerCase(),service.arrayContains(handfreeSupportedDevices,deviceLabel)?audioProfile.HANDFREE:audioProfile.HEADSET},this.normalizeAnyLabel=function(anyDevice){return anyDevice?("default"===anyDevice.id||"communications"===anyDevice.id||anyDevice.normalizedLabel||(service.isWin?-1!==anyDevice.label.indexOf("Realtek Audio")||-1!==anyDevice.label.indexOf("Realtek(R) Audio")?anyDevice.normalizedLabel=anyDevice.label:anyDevice.normalizedLabel=anyDevice.label.substring(anyDevice.label.indexOf("(")+1,anyDevice.label.indexOf(")")):anyDevice.normalizedLabel=anyDevice.label),anyDevice):null};var updateHeadsetDevices=function(){var deferred=$q.defer();return service.getMicrophones().then((function(devices){return microphones=devices,service.getSpeakers()})).then((function(devices){speakers=devices;var _headsetDevices=[];angular.forEach(microphones,(function(microphone){"default"!==microphone.id&&"communications"!==microphone.id&&(microphone=service.normalizeAnyLabel(microphone),_headsetDevices.some((function(device){return device.microphone.normalizedLabel===microphone.normalizedLabel}))||angular.forEach(speakers,(function(speaker){if(speaker=service.normalizeAnyLabel(speaker),microphone.normalizedLabel===speaker.normalizedLabel&&service.getDeviceType(microphone.normalizedLabel)===audioProfile.HEADSET){var _device={label:microphone.normalizedLabel,microphone:microphone,speaker:speaker};_headsetDevices.push(_device),firstDeviceUpdateHeadset&&allDevices.push(_device)}})))}));var headSetName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("headsetDeviceName");headSetName&&"null"!==headSetName||!_headsetDevices.length||(headSetName=_headsetDevices[0].label,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("headsetDeviceName",_headsetDevices[0].label),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("headsetMicrophone",_headsetDevices[0].microphone.id),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("headsetSpeaker",_headsetDevices[0].speaker.id));var ringingSpeakerName=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("ringingSpeakerName");if((!ringingSpeakerName||"null"===ringingSpeakerName)&&speakers.length)for(var i=0;i<speakers.length;i++)if("default"!==speakers[i].id&&"communications"!==speakers[i].id){_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("ringingSpeakerName",speakers[i].normalizedLabel),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("ringingSpeaker",speakers[i].id);break}var newHeadsetDevices=[];firstDeviceUpdateHeadset||(angular.forEach(_headsetDevices,(function(newDevice){headsetDevices.some((function(oldDevice){return oldDevice.label===newDevice.label}))||(newHeadsetDevices.push(newDevice),allDevices.push(newDevice))})),newHeadsetDevices.length>0&&($log.info("[PlatformService] hotplugged headset(s): "+(newHeadsetDevices.length>1?newHeadsetDevices.reduce((function(deviceA,deviceB){return{label:deviceA.Label+", "+deviceB.Label}})).label:newHeadsetDevices[0].label)),$rootScope.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:newHeadsetDevices,action:"add"})));var disconnectedDevices=[];!firstDeviceUpdateHeadset&&headsetDevices.length>_headsetDevices.length&&(angular.forEach(headsetDevices,(function(newDevice){if(!_headsetDevices.some((function(oldDevice){return oldDevice.label===newDevice.label}))){disconnectedDevices.push(newDevice);var index=allDevices.map((function(dev){return dev.label})).indexOf(newDevice.label);allDevices.splice(index,1)}})),disconnectedDevices.length>0&&($log.info("[PlatformService] unplugged headset(s): "+(disconnectedDevices.length>1?disconnectedDevices.reduce((function(deviceA,deviceB){return{label:deviceA.Label+", "+deviceB.Label}})).label:disconnectedDevices[0].label)),$rootScope.$broadcast("ON_AUDIO_HOTPLUG_DEVICES_CHANGED_EVENT",{devices:disconnectedDevices,action:"remove"}))),firstDeviceUpdateHeadset=!1,headsetDevices=_headsetDevices,deferred.resolve(_headsetDevices)})),deferred.promise};this.getHeadsetDevices=function(){return headsetDevices};var watcher;this.getSpeakerphoneDevices=function(){return speakerphoneDevices},this.getAllDevices=function(){return allDevices},this.getHandFreeDevice=function(){var deferred=$q.defer();return service.getHandfreeMicrophone().then((function(microphone){var curMic=microphone;service.getHandfreeSpeaker().then((function(speaker){var curSpeak=speaker;(!service.handFreeDevice||service.handFreeDevice.microphone&&service.handFreeDevice.microphone.id!==curMic.id||service.handFreeDevice.speaker&&service.handFreeDevice.speaker.id!==curSpeak.id)&&(service.handFreeDevice={label:"",microphone:curMic,speaker:curSpeak,profile:audioProfile.HANDFREE}),deferred.resolve(service.handFreeDevice)}))})),deferred.promise},this.getCustomDevice=function(){var deferred=$q.defer();return service.getCustomMicrophone().then((function(microphone){var curMic=microphone;service.getCustomSpeaker().then((function(speaker){var curSpeak=speaker;(!service.customDevice||service.customDevice.microphone&&service.customDevice.microphone.id!==curMic.id||service.customDevice.speaker&&service.customDevice.speaker.id!==curSpeak.id)&&(service.customDevice={label:"",microphone:curMic,speaker:curSpeak,profile:audioProfile.CUSTOM}),deferred.resolve(service.customDevice)}))})),deferred.promise},this.getAvailableDevices=function(){var deferred=$q.defer(),res=[];return service.getHandFreeDevice().then((function(device){res.push(device),headsetDevices.forEach((function(elem){elem.profile=audioProfile.HEADSET,res.push(elem)})),speakerphoneDevices.forEach((function(elem){elem.profile=audioProfile.SPEAKERPHONE,res.push(elem)})),service.getCustomDevice().then((function(customDevice){res.push(customDevice),deferred.resolve(res)}))})),deferred.promise},this.getStoredDeviceList=function(){return _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("deviceList")},this.saveDeviceList=function(devices){for(var deviceLabelList=[],i=0;i<devices.length;i++)deviceLabelList[i]=devices[i].label;_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.setSetting("deviceList",angular.toJson(deviceLabelList))},this.getCurrentCamera=function(){var deferred=$q.defer();return service.getCameras().then((function(devices){deferred.resolve(service.getDeviceWithId(devices,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("camera")))})),deferred.promise},this.getCameraForSDK=function(){return{id:_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getSetting("camera")}},this.getCameras=function(){var deferred=$q.defer();return this.allowDevicesManagement()||deferred.resolve([]),service.getVideoInputDevices().then((function(devices){deferred.resolve(devices&&devices.constructor===Array&&_isWebsiteHasWebcamPermissions?devices:[])})).catch((function(error){return $log.info("[PlatformService] === SERVICES FAILURE === : "+error.message),deferred.reject(error),deferred.promise})),deferred.promise},this.isDeviceAvailable=function(devices,id,kind){var current_device=devices.find((function(device){return device.kind===kind&&device.deviceId===id}));return angular.isDefined(current_device)},this.getDeviceWithId=function(devices,id,isSpeaker){if(devices.constructor!==Array)return null;var current_device=null;"default"!==id&&"communications"!==id||(isSpeaker?(default_device=service.mediaDevices.find((function(device){return device.deviceId===id&&"audioinput"===device.kind})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId}))):(default_device=devices.find((function(device){return device.id===id})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId}))));if(current_device)return current_device;if(!(current_device=devices.find((function(device){return device.id===id})))){var default_device;if(isSpeaker)(default_device=service.mediaDevices.find((function(device){return"default"===device.deviceId&&"audioinput"===device.kind})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId})));current_device||(default_device=devices.find((function(device){return"default"===device.id})))&&(current_device=devices.find((function(device){return"default"!==device.id&&"communications"!==device.id&&default_device.groupId===device.groupId})))}return current_device||(devices.length>0?devices[0]:null)},this.startWatcher=function(){if(service.allowDevicesManagement()){if(angular.isDefined(watcher))return;watcher=$interval(service.devicesWatcher,1e3)}},this.stopWatcher=function(){angular.isDefined(watcher)&&($interval.cancel(watcher),watcher=void 0)},this.capitalizeFirstLetter=function(string){return string.charAt(0).toUpperCase()+string.slice(1)},this.fixDeviceLabels=function(){angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&mediaDevice.id&&("default"!==mediaDevice.id||mediaDevice.label&&"Default"!==mediaDevice.label?mediaDevice.id.length<64&&"Please invoke getUserMedia once."===mediaDevice.label&&(mediaDevice.label=service.capitalizeFirstLetter(mediaDevice.id)):mediaDevice.label=service.findAndUpdateDefaultDeviceLabel(mediaDevice.kind,mediaDevice.groupId),$log.info("[PlatformService] fixDeviceLabels || update device "+mediaDevice.id+" with kind "+mediaDevice.kind+" with label "+mediaDevice.label))}))},this.findAndUpdateDefaultDeviceLabel=function(kind,groupId){for(var label="audioinput"===kind?$filter("translate")("yourComputerMicrophoneDevice"):$filter("translate")("yourComputerSpeakerDevice"),i=0;i<DetectRTC.MediaDevices.length;i++)if("default"!==DetectRTC.MediaDevices[i].id&&DetectRTC.MediaDevices[i].kind===kind&&DetectRTC.MediaDevices[i].groupId===groupId){label=label+" - "+DetectRTC.MediaDevices[i].label;break}return label},this.updatePermissions=function(){var result=!1;return angular.forEach(DetectRTC.MediaDevices,(function(mediaDevice){mediaDevice&&mediaDevice.id&&mediaDevice.id.length>=64&&("Please invoke getUserMedia once."===mediaDevice.label?result=!0:("videoinput"!==mediaDevice.kind||_isWebsiteHasWebcamPermissions||(_isWebsiteHasWebcamPermissions=!0),"audioinput"!==mediaDevice.kind||_isWebsiteHasMicrophonePermissions||(_isWebsiteHasMicrophonePermissions=!0)))})),result},this.isGetUserMediaRequested=function(){return(!_isWebsiteHasWebcamPermissions||!_isWebsiteHasMicrophonePermissions)&&service.updatePermissions(DetectRTC.MediaDevices)},this.audioMediaDeviceUpdated=function(){service.fixDeviceLabels(),$rootScope.$broadcast("ON_USER_AUDIO_MEDIA_CHANGED_EVENT")},this.videoMediaDeviceUpdated=function(){service.fixDeviceLabels(),$rootScope.$broadcast("ON_USER_VIDEO_MEDIA_CHANGED_EVENT")};var removeDuplicates=function(devices){var result=[];return angular.forEach(devices,(function(device){result.some((function(item){return item.id===device.id}))||result.push(device)})),result};this.getAudioInputDevices=function(){return $q.when(removeDuplicates(DetectRTC.audioInputDevices))},this.getAudioOutputDevices=function(){var deferred=$q.defer();return deferred.resolve(removeDuplicates(DetectRTC.audioOutputDevices)),deferred.promise},this.getVideoInputDevices=function(){var deferred=$q.defer();return deferred.resolve(removeDuplicates(DetectRTC.videoInputDevices)),deferred.promise}}])},function(module,exports){angular.module("rainbow").service("gaService",[function(){"use strict";var analytics_ICEFailed={category:"webrtc",action:"CallsSuccessRate",label:"error_failed"},analytics_ICESuccess={category:"webrtc",action:"CallsSuccessRate",label:"success"},analytics_ICENoSTUNCandidate={category:"webrtc",action:"CallsSuccessRate",label:"error_no_stun_candidate"},analytics_ICEUsed={category:"webrtc",action:"ICEDistribution"},analytics_ICETopology={category:"webrtc",action:"ICETopology"},analytics_NegotiationTime={category:"webrtc",action:"ICENegotiation",label:"DurationMs"},analytics_GetUserMedia={category:"webrtc",action:"GetUserMediaRate",label:"success"},analytics_GetUserMediaErrorNoTrack={category:"webrtc",action:"GetUserMediaRate",label:"error_no_Track"},analytics_GetUserMediaError={category:"webrtc",action:"GetUserMediaRate",label:"error"},analytics_CodecsUsed={category:"webrtc",action:"CodecsDistribution"},analytics_NbSuccessCall={category:"webrtc",action:"CallsDistribution"},analytics_CallsDuration={category:"webrtc",action:"CallsDurationRange"},analytics_DragAndDrop={category:"ux",action:"dragAndDrop"},analytics_InviteFromProvider={category:"invitations",action:"inviteFromProvider"},_startNegotiationTime=null,_endNegotiationTime=null,_pendingComputation=!1,_lastICESuccessTracked=null,_lastICEFailedTracked=null,_ga=null;this.provideGA=function(ga){_ga=ga},this.hasGA=function(){return null!==_ga},this.trackICEUsed=function(local,remote){if(_ga){var localICEUsed="",remoteICEUsed="";switch(local){case"local":localICEUsed="host";break;case"peerreflexive":case"prflx":case"serverreflexive":localICEUsed="stun";break;case"relayed":localICEUsed="relay";break;default:localICEUsed=local}switch(remote){case"local":remoteICEUsed="host";break;case"peerreflexive":case"prflx":case"serverreflexive":remoteICEUsed="stun";break;case"relayed":remoteICEUsed="relay";break;default:remoteICEUsed=remote}_ga.send("event",analytics_ICEUsed.category,analytics_ICEUsed.action,localICEUsed+"|"+remoteICEUsed)}},this.trackICEFailed=function(sid){_ga&&sid&&_lastICEFailedTracked!==sid&&(_ga.send("event",analytics_ICEFailed.category,analytics_ICEFailed.action,analytics_ICEFailed.label),_lastICEFailedTracked=sid)},this.trackICESuccess=function(sid){_ga&&sid&&_lastICESuccessTracked!==sid&&(_ga.send("event",analytics_ICESuccess.category,analytics_ICESuccess.action,analytics_ICESuccess.label),_lastICESuccessTracked=sid)},this.trackICENoSTUNCandidate=function(){_ga&&_ga.send("event",analytics_ICENoSTUNCandidate.category,analytics_ICENoSTUNCandidate.action,analytics_ICENoSTUNCandidate.label)},this.trackICETopology=function(topology){_ga&&_ga.send("event",analytics_ICETopology.category,analytics_ICETopology.action,topology)},this.trackGetUserMediaSuccess=function(){_ga&&_ga.send("event",analytics_GetUserMedia.category,analytics_GetUserMedia.action,analytics_GetUserMedia.label)},this.trackGetUserMediaErrorNoTrack=function(){_ga&&_ga.send("event",analytics_GetUserMediaErrorNoTrack.category,analytics_GetUserMediaErrorNoTrack.action,analytics_GetUserMediaErrorNoTrack.label)},this.trackGetUserMediaError=function(){_ga&&_ga.send("event",analytics_GetUserMediaError.category,analytics_GetUserMediaError.action,analytics_GetUserMediaError.label)},this.trackCodecsUsed=function(audioCodec,videoCodec){_ga&&_ga.send("event",analytics_CodecsUsed.category,analytics_CodecsUsed.action,audioCodec+"|"+videoCodec)},this.negotiationTime=function(){return _endNegotiationTime&&_startNegotiationTime?_endNegotiationTime<_startNegotiationTime?null:_endNegotiationTime-_startNegotiationTime:null},this.startNegotiationTime=function(time){_startNegotiationTime=time||(new Date).getTime(),_pendingComputation=!0},this.endNegotiationTime=function(time){_pendingComputation&&(_endNegotiationTime=time||(new Date).getTime(),_pendingComputation=!1)},this.trackNegotiationTime=function(){if(_ga){var duration=this.negotiationTime();duration&&_ga.send("event",analytics_NegotiationTime.category,analytics_NegotiationTime.action,analytics_NegotiationTime.label,duration),_endNegotiationTime=null,_startNegotiationTime=null}},this.resetProvider=function(){_ga=null},this.trackCallSuccessNumber=function(type){type&&type.length>0&&_ga&&_ga.send("event",analytics_NbSuccessCall.category,analytics_NbSuccessCall.action,type)},this.trackCallDuration=function(durationMs){if(_ga&&angular.isDefined(durationMs)&&durationMs>=0){var durationCategoryLabel="",durationInSeconds=Math.round(durationMs/1e3);durationCategoryLabel=durationInSeconds<15?"very_short_less_15s":durationInSeconds<30?"very_short_less_30s":durationInSeconds<60?"short_less_60s":durationInSeconds<120?"short_less_120s":durationInSeconds<300?"short_less_300s":durationInSeconds<600?"normal_less_600s":durationInSeconds<1200?"normal_less_1200s":durationInSeconds<1800?"normal_less_1800s":durationInSeconds<3600?"long_less_3600s":"long_more_3600s",_ga.send("event",analytics_CallsDuration.category,analytics_CallsDuration.action,durationCategoryLabel)}},this.trackDragAndDrop=function(type){_ga&&_ga.send("event",analytics_DragAndDrop.category,analytics_DragAndDrop.action,type)},this.inviteContactsFromProvider=function(provider,number){_ga&&_ga.send("event",analytics_InviteFromProvider.category,analytics_InviteFromProvider.action,provider,number)}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0__);angular.module("rainbow").service("usersService",["$q","$log",function($q,$log){var that=this;this.started=!1,this.start=function(stats){$log.info("[usersService] === STARTING ==="),that.started=!0;var startDate=performance.now();$log.info("[usersService] start"),that.contactsInRoster=that.getAllRosterContacts(),that.lastNameList=that.orderContacts("lastname"),that.firstNameList=that.orderContacts("firstname"),that.companyNameList=that.orderContacts("company"),that.contactServiceSubscription=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default.a.subscribe((function(event){"ON_CONTACT_ROSTER_UPDATE_EVENT"===event.name&&that.onContactUpdatedEvent()}));var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"usersService",startDuration:startDuration}),$log.info("[usersService] === STARTED ("+startDuration+" ms) ==="),$q.when()},this.stop=function(){return $log.info("[usersService] === STOPPING ==="),that.started&&(that.started=!1),that.contactServiceSubscription&&that.contactServiceSubscription.unsubscribe(),$log.info("[usersService] === STOPPED ==="),$q.when()},this.onContactUpdatedEvent=function(){$log.info("[usersService] onContactUpdatedEvent");var newRosterList=that.getAllRosterContacts();newRosterList.length-that.contactsInRoster.length!=0&&($log.info("[usersService] onContactUpdatedEvent - update all user lists"),that.contactsInRoster=newRosterList,that.lastNameList=that.orderContacts("lastname"),that.firstNameList=that.orderContacts("firstname"),that.companyNameList=that.orderContacts("company"))},this.getLastNameList=function(){return that.lastNameList},this.getFirstNameList=function(){return that.firstNameList},this.getCompanyNameList=function(){return that.companyNameList},this.getAllRosterContacts=function(){return _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default.a.getContacts().filter((function(contact){return contact.displayName&&contact.roster}))},this.addSeparators=function(users,sortByMember){var result=[],label="",index=0,paramExtractor=null;return paramExtractor="company"!==sortByMember?function(user){return user[sortByMember].charAt(0)}:function(user){return user.company.name},users.forEach((function(user){var sortString=paramExtractor(user).toUpperCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"");label!==sortString&&(label=sortString,result.push({value:label,type:"separator",id:label,index:index++})),user.index=index++,result.push(user)})),result},this.orderContacts=function(criteria){var orderedUsers=that.getOrderedUsers(that.contactsInRoster,criteria);return that.addSeparators(orderedUsers,criteria)},this.getFilterAndOrderUsersGroupedByOrderLabel=function(users,orderType,filterType,isGroup){isGroup=Boolean(!0&isGroup);var listOrderUsers=that.getFilterAndOrderUsers(users,orderType,filterType,isGroup);return"firstname"===orderType?that.addSeparators(listOrderUsers,"firstname"):"company"===orderType?that.addSeparators(listOrderUsers,"company"):that.addSeparators(listOrderUsers,"lastname")},this.getFilterAndOrderUsersGroupedByOrderLabelAndUpdateActivity=function(users,orderType,filterType,isGroup){isGroup=Boolean(!0&isGroup);var listOrderUsers=that.getFilterAndOrderUsers(users,orderType,filterType,isGroup);return"firstname"===orderType?that.addSeparators(listOrderUsers,"firstname"):"company"===orderType?that.addSeparators(listOrderUsers,"company"):that.addSeparators(listOrderUsers,"lastname")},this.getFilterAndOrderUsers=function(users,orderType,filterType,isGroup){var listFilteredUsers=that.getFilteredUsers(users,filterType,isGroup);return that.getOrderedUsers(listFilteredUsers,orderType)},this.getFilteredUsers=function(contactList,filter,isGroup){var contacts;return contacts=(contacts=contactList.filter((function(contact){if("separator"===contact.type)return!0;var isExistingContact=contact.displayName&&contact.roster||isGroup,isContactOnline="offline"!==contact.status&&"wait"!==contact.status&&"xa"!==contact.status&&"unknown"!==contact.status,isContactPending="wait"===contact.status,isContactTerminated=contact.isTerminated;return"online"===filter?isExistingContact&&isContactOnline:"offline"===filter?isExistingContact&&!isContactOnline&&!isContactTerminated:"pending"===filter?isExistingContact&&isContactPending:"all"===filter?isExistingContact&&!isContactTerminated:isExistingContact}))).filter((function(contact,index){return!!("separator"!==contact.type||contacts[index+1]&&"separator"!==contacts[index+1].type)}))},this.getOrderedUsers=function(contactList,orderType){return contactList.sort((function(aa,bb){var sortName;if("lastname"===orderType)return 0===(sortName=aa.lastname.localeCompare(bb.lastname))?aa.firstname.localeCompare(bb.firstname):sortName;if("firstname"===orderType)return 0===(sortName=aa.firstname.localeCompare(bb.firstname))?aa.lastname.localeCompare(bb.lastname):sortName;if("company"===orderType){var sortCompany=aa.company.name.localeCompare(bb.company.name);return 0===sortCompany?aa.lastname.localeCompare(bb.lastname):sortCompany}return 0}))}}])},function(module,exports,__webpack_require__){"use strict";(function(Buffer){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.FileServerService=exports.LocalImage=void 0;const crypto_js_1=__webpack_require__(18),crypto_js_2=__webpack_require__(18),fileDescriptor_1=__webpack_require__(65),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),logger_service_1=__webpack_require__(15),fileStorage_service_1=__webpack_require__(25),moment=__webpack_require__(3);class LocalImage{constructor(fd,blob){blob&&(this.url=URL.createObjectURL(blob)),this.fd=fd}release(){URL.revokeObjectURL(this.url)}}exports.LocalImage=LocalImage;class FileServerService{constructor($q,$http,TransfertPromiseQueue,FileDescriptorEventHandler,errorHelperService,$rootScope){this.$q=$q,this.$http=$http,this.TransfertPromiseQueue=TransfertPromiseQueue,this.FileDescriptorEventHandler=FileDescriptorEventHandler,this.errorHelperService=errorHelperService,this.$rootScope=$rootScope,this.ONE_KILOBYTE=1024,this.ONE_MEGABYTE=1048576,this.ONE_GIGABYTE=1073741824,this.started=!1,this.thumbnailPromises=[],this.thumbnailPreviewPromises=[],this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.logger=logger_service_1.default,this.fileStorageService=fileStorage_service_1.default}start(stats){return __awaiter(this,void 0,void 0,(function*(){try{this.logger.info("[FileServerService] === STARTING ==="),"caches"in self&&(this.cache=yield caches.open("RainbowImageCache"));const startDate=performance.now();this.started=!1,this.portalURL=config.restServerUrl+"/api/rainbow/fileserver/v1.0/files",yield this.getServercapabilities(),this.attachHandlers(),this.transfertPromiseQueue=this.TransfertPromiseQueue.create();const startDuration=Math.round(performance.now()-startDate);stats.push({service:"FileServerService",startDuration:startDuration}),this.logger.info("[FileServerService] === STARTED ("+startDuration+" ms) ===")}catch(error){this.logger.error("[FileServerService] === STARTING FAILURE === "+error.message)}}))}stop(){return __awaiter(this,void 0,void 0,(function*(){this.logger.info("[FileServerService] === STOPPING ==="),this.started&&(this.started=!1),this.logger.info("[FileServerService] === STOPPED ===")}))}attachHandlers(){this.removeHandlers(),this.fileDescriptorEventHandler=this.FileDescriptorEventHandler.create(this),this.fileMessageHandlerRef||(this.fileMessageHandlerRef=this.xmppService.addHandler(stanza=>(setTimeout(()=>{this.fileDescriptorEventHandler.onManagementMessageReceived(stanza)},250),!0),null,"message","management"))}removeHandlers(){this.fileDescriptorEventHandler=void 0,this.fileMessageHandlerRef=void 0}getFileRange(){return 4*this.ONE_MEGABYTE}getFileDescriptorPublicUrl(fileDescriptor){return __awaiter(this,void 0,void 0,(function*(){try{const serverUrl=new URL(this.portalURL+"/"+fileDescriptor.id+"/temporary-url"),headers=this.authService.getRequestHeader();headers["Content-Type"]="application/json";const response=yield fetch(serverUrl.href,{method:"GET",headers:headers});if(response.ok){const responseData=yield response.json();fileDescriptor.publicUrl=responseData.data.url;const mdate=moment(responseData.data.expirationDate);return mdate.isValid()&&(fileDescriptor.publicUrlExpirationDate=mdate.toDate()),this.logger.info("Get PublicUrl Success"),fileDescriptor.publicUrl}return null}catch(err){this.logger.error("stopPstnConference - ERROR");throw this.errorHelperService.handleError(err)}}))}getFileDescriptorUrl(fileDescriptor,thumbnail=!1,cacheEnabled=!1){return __awaiter(this,void 0,void 0,(function*(){try{let blob=null;const cacheRequest=new Request(`/rainbowImages/${thumbnail?"thumbnail/":""}${fileDescriptor.id}`);if(cacheEnabled&&this.cache){const cacheResponse=yield this.cache.match(cacheRequest);cacheResponse&&(blob=yield cacheResponse.blob())}return blob||(thumbnail?blob=fileDescriptor.previewBlob?fileDescriptor.previewBlob:yield this.getBlobThumbnailFromFileDescriptor(fileDescriptor):(blob=yield this.getBlobFromFileDescriptor(fileDescriptor,!1,null),!fileDescriptor.orientation&&fileDescriptor.isImage()&&(yield this.setImageOrientationForFileDescriptor(fileDescriptor,blob).catch(()=>{}))),cacheEnabled&&this.cache&&this.cache.put(cacheRequest,new Response(blob))),URL.createObjectURL(blob)}catch(error){throw new Error(`getFileDescriptorUrl(${fileDescriptor.id}, ${thumbnail}) -- failure -- ${error}`)}}))}removeFileDescriptorFromCache(fileDescriptor){this.cache&&(this.cache.delete("/rainbowImages/thumbnail/"+fileDescriptor.id),this.cache.delete("/rainbowImages/"+fileDescriptor.id))}clearCache(){return __awaiter(this,void 0,void 0,(function*(){this.cache&&(yield caches.delete("RainbowImageCache"),this.cache=yield caches.open("RainbowImageCache"))}))}getLocalImage(fileDescriptorId,thumbnail,forced=!0){return __awaiter(this,void 0,void 0,(function*(){try{let fileDescriptor=this.fileStorageService.getFileDescriptorById(fileDescriptorId);fileDescriptor||(fileDescriptor=yield this.fileStorageService.retrieveAndStoreOneFileDescriptor(fileDescriptorId)),fileDescriptor.fileName.includes("__rboriginal__")&&(thumbnail=!1);let blob=null;return blob=thumbnail&&fileDescriptor.previewBlob&&!forced?fileDescriptor.previewBlob:thumbnail?yield this.getLargeBlobThumbnail(fileDescriptor):yield this.getBlobFromFileDescriptor(fileDescriptor,!1,null),new LocalImage(fileDescriptor,blob)}catch(error){return new LocalImage(null,null).url="/resources/skins/rainbow/images/wizard/chrome.png",this.logger.warn(`[fileServerService] getFileLocalURL -- no file descriptor found with ${fileDescriptorId} + " id.`),null}}))}getLargeBlobThumbnail(fileDescriptor){const url=fileDescriptor.url+"?thumbnail500=true";return this.getBlobFileDescriptorFromUrl(url,fileDescriptor)}getPartialDataFromServer(fileDescriptor,url,minRange,maxRange,index,cancelable,currentLoadingRef){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:url,headers:this.authService.getRequestHeaderWithRange("bytes="+minRange+"-"+maxRange),responseType:"arraybuffer",timeout:fileDescriptor.cancelTransfertDefer.promise,eventHandlers:{progress:event=>{if(fileDescriptor.loadingRef!==currentLoadingRef)return void this.logger.info("[FileServerService] This load has been canceled - NTIA");const percentChunk=Math.floor(100*event.loaded/event.total);fileDescriptor&&(fileDescriptor.chunkPercentArray[index]=percentChunk,this.logger.info("[FileServerService] getPartialDataFromServer ProgressChunk: "+percentChunk),fileDescriptor.updateProgressInfo())}}}).then(response=>{resolve({data:response.data,index:index})},errorResponse=>{const error=this.errorHelperService.handleError(errorResponse),errorDataObj=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(errorResponse.data))),translatedErrorMessage=this.errorHelperService.getLocalizedError(errorDataObj.errorDetailsCode);this.logger.error(translatedErrorMessage),reject(error)})})}getFileStorageService(){return this.fileStorageService}getBlobThumbnailFromFileDescriptor(fileDescriptor){if(fileDescriptor.thumbnail.isThumbnailAvailable()||fileDescriptor.isImage()){const defered=this.$q.defer();let fullImage=!1,url=fileDescriptor.url;if(fileDescriptor.thumbnail.isThumbnailAvailable()){if(this.thumbnailPreviewPromises[fileDescriptor.id])return this.logger.info("[FileServerService] getBlobThumbnailFromFileDescriptor preview for "+fileDescriptor.id+" already lauched"),this.thumbnailPreviewPromises[fileDescriptor.id].promise;this.thumbnailPreviewPromises[fileDescriptor.id]=defered,url+="?thumbnail500=true"}else{if(this.thumbnailPromises[fileDescriptor.id])return this.logger.info("[FileServerService] getBlobThumbnailFromFileDescriptor full image update for "+fileDescriptor.id+" already lauched"),this.thumbnailPromises[fileDescriptor.id].promise;this.thumbnailPromises[fileDescriptor.id]=defered,fileDescriptor.uploadedDate&&(url+="?update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(fileDescriptor.uploadedDate)).toString(crypto_js_2.enc.Hex)),fullImage=!0}return this.getBlobFileDescriptorFromUrl(url,fileDescriptor).then(blob=>__awaiter(this,void 0,void 0,(function*(){(fileDescriptor=this.fileStorageService.getFileDescriptorById(fileDescriptor.id)).previewBlob?fileDescriptor.previewBlob&&!fullImage&&(fileDescriptor.previewBlob=blob):fileDescriptor.previewBlob=blob,fullImage||(fileDescriptor.previewDownloaded=!0),!fileDescriptor.orientation&&fileDescriptor.isImage()&&fullImage&&(yield this.setImageOrientationForFileDescriptor(fileDescriptor,blob).catch(()=>{})),fileDescriptor.previewBlobSubject.next(fileDescriptor.previewBlob),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"download",fileDesc:fileDescriptor});const promiseArray=fullImage?this.thumbnailPromises:this.thumbnailPreviewPromises;promiseArray[fileDescriptor.id]&&promiseArray[fileDescriptor.id].resolve(fileDescriptor.previewBlob),delete promiseArray[fileDescriptor.id],defered.resolve(blob)}))).catch(error=>{this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:error.message,fileDesc:fileDescriptor});delete(fullImage?this.thumbnailPromises:this.thumbnailPreviewPromises)[fileDescriptor.id],defered.reject(error)}),defered.promise}return this.$q.reject("No available thumbnail")}getBlobFromFileDescriptor(fileDescriptor,cancelable=!0,actionOnPartialResponse=null){if(!fileDescriptor)return this.logger.warn("[FileServerService] getBlobFromFileDescriptor : missing file descriptor"),this.$q.reject();if(this.logger.info("[FileServerService] getBlobFromFileDescriptor: "+fileDescriptor.id),"uploaded"!==fileDescriptor.state)return this.logger.warn("[FileServerService] getBlobFromFileDescriptor : file is not in uploaded state="+fileDescriptor.state),this.$q.reject();let url=fileDescriptor.url;fileDescriptor.uploadedDate&&(url+="?update="+crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(fileDescriptor.uploadedDate)).toString(crypto_js_2.enc.Hex));let range=this.getFileRange();if(this.capabilities.maxChunkSizeDownload&&0!==fileDescriptor.size&&fileDescriptor.size>range){fileDescriptor.size>=100*range&&(range=fileDescriptor.size/100+this.ONE_KILOBYTE,this.logger.debug("[FileServerService] changing chunk size: "+range));const defered=this.$q.defer(),blobArray=new Array,promiseArray=[];fileDescriptor.state="downloading",fileDescriptor.chunkTotalNumber=Math.ceil(fileDescriptor.size/range),fileDescriptor.chunkPerformedPercent=0,fileDescriptor.chunkWrittenInDisk=-1,fileDescriptor.chunkPercentArray=new Array(fileDescriptor.chunkTotalNumber),fileDescriptor.chunkPercentArray.fill(0);const currentLoadingRef=++fileDescriptor.loadingRef;fileDescriptor.cancelTransfertDefer=this.$q.defer(),fileDescriptor.updateProgressInfo(),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:fileDescriptor,cancelable:cancelable}),this.logger.info("[FileServerService] getBlobFromFileDescriptor: need to download "+fileDescriptor.chunkTotalNumber+" chunks");for(let i=0,minRange=0,maxRange=range-1,repetition=Math.ceil(fileDescriptor.size/range);repetition>0;i++,repetition--,minRange+=range,maxRange+=range)maxRange=maxRange<fileDescriptor.size?maxRange:fileDescriptor.size,promiseArray.push(()=>{var promiseArrayDeferred=this.$q.defer();return this.getPartialDataFromServer(fileDescriptor,url,minRange,maxRange,i,cancelable,currentLoadingRef).then(response=>{if(fileDescriptor.loadingRef===currentLoadingRef)return fileDescriptor.updateProgressInfo(),this.logger.info("[FileServerService] getBlobFromFileDescriptor : chunk"+i+" downloaded"),this.logger.debug("[FileServerService] refreshFilePercent: chunkPerformedPercent="+fileDescriptor.chunkPerformedPercent),blobArray[response.index]=response.data,this.writeAvailableChunksInDisk(fileDescriptor,blobArray),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:fileDescriptor,cancelable:cancelable}),actionOnPartialResponse?actionOnPartialResponse(response,fileDescriptor.id).then(()=>promiseArrayDeferred.resolve(response.data)):promiseArrayDeferred.resolve(response);this.logger.info("[FileServerService] This load has been canceled - NTIA")}).catch(error=>{this.logger.info("[FileServerService] error on chunk download="+error),promiseArrayDeferred.reject(error)}),promiseArrayDeferred.promise});let promisesCompletion=()=>{if(fileDescriptor.loadingRef!==currentLoadingRef)return void this.logger.info("[FileServerService] This load has been canceled - NTIA");this.logger.info("[FileServerService] getBlobFromFileDescriptor: promisesCompletion");const blob=new Blob(blobArray,{type:fileDescriptor.typeMIME});this.logger.info("[FileServerService] getBlobFromFileDescriptor success"),fileDescriptor.setState("uploaded"),fileDescriptor.chunkTotalNumber=0,fileDescriptor.chunkPerformedPercent=0,fileDescriptor.updateProgressInfo(),this.writeAvailableChunksInDisk(fileDescriptor,blobArray),fileDescriptor.writeStream&&(this.logger.info("[FileServerService] Close WriteStream"),fileDescriptor.writeStream.end()),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{type:"download",fileDesc:fileDescriptor}),defered.resolve(blob)},promisesReject=errorResponse=>{if(fileDescriptor.loadingRef!==currentLoadingRef)return void this.logger.info("[FileServerService] This load has been canceled - NTIA");let error=this.errorHelperService.handleError(errorResponse);fileDescriptor.setState("uploaded"),fileDescriptor.chunkTotalNumber=0,fileDescriptor.chunkPerformedPercent=0;let errorDataObj=JSON.parse(String.fromCharCode.apply(null,new Uint8Array(errorResponse.data))),translatedErrorMessage=this.errorHelperService.getLocalizedError(errorDataObj.errorDetailsCode);this.logger.error(translatedErrorMessage),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"download",message:translatedErrorMessage||error.message,fileDesc:fileDescriptor}),defered.reject(error)};return this.transfertPromiseQueue.addPromiseArray(fileDescriptor.id,promiseArray,promisesCompletion,promisesReject),defered.promise}return fileDescriptor.state="downloading",this.getBlobFileDescriptorFromUrl(url,fileDescriptor).then(blob=>(this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor}),this.$q.resolve(blob))).catch(error=>(fileDescriptor.state="uploaded",this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor}),this.logger.info("[FileServerService] arrayPromise : error "+error.message),this.$q.reject(error)))}writeAvailableChunksInDisk(fd,blobArray){if(this.logger.debug("[FileServerService] >writeAvailableChunksInDisk"),!fd.writeStream)return;const start=fd.chunkWrittenInDisk+1;this.logger.debug("[FileServerService] >writeAvailableChunksInDisk : We start at "+start);for(let index=start;index<blobArray.length;index++){if(!blobArray[index]){this.logger.debug("[FileServerService] >writeAvailableChunksInDisk : Blob "+index+" NOT available");break}this.logger.debug("[FileServerService] >writeAvailableChunksInDisk : Blob "+index+" available"),fd.chunkWrittenInDisk=index,fd.writeStream.write(new Buffer(blobArray[index])),blobArray[index]=null}}getBlobFileDescriptorFromUrl(url,fileDescriptor){return this.$q((resolve,reject)=>{this.logger.debug("[FileServerService] >getBlobFileDescriptorFromUrl: "+url),fileDescriptor.chunkTotalNumber=1,fileDescriptor.chunkPerformedPercent=0,fileDescriptor.chunkPercentArray=new Array(fileDescriptor.chunkTotalNumber),fileDescriptor.chunkPercentArray.fill(0);const currentLoadingRef=++fileDescriptor.loadingRef;fileDescriptor.cancelTransfertDefer=this.$q.defer(),fileDescriptor.updateProgressInfo(),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!1}),this.$http({method:"GET",url:url,headers:this.authService.getRequestHeader(),responseType:"arraybuffer",timeout:fileDescriptor.cancelTransfertDefer.promise,eventHandlers:{progress:event=>{fileDescriptor.loadingRef===currentLoadingRef?(fileDescriptor.chunkPercentArray[0]=Math.floor(100*event.loaded/event.total),fileDescriptor.updateProgressInfo()):this.logger.info("[FileServerService] This load has been canceled - NTIA")}}}).then(response=>{if(fileDescriptor.loadingRef!==currentLoadingRef)return void this.logger.info("[FileServerService] This load has been canceled - NTIA");const blob=new Blob([response.data],{type:fileDescriptor.typeMIME});fileDescriptor.state="uploaded",fileDescriptor.chunkPerformedPercent=0,fileDescriptor.updateProgressInfo(),this.logger.debug("[FileServerService] getBlobFileDescriptorFromUrl success"),resolve(blob)},errorResponse=>{if(fileDescriptor.loadingRef!==currentLoadingRef)return void this.logger.info("[FileServerService] This load has been canceled - NTIA");fileDescriptor.state=fileDescriptor_1.FileState.UPLOADED;const error=this.errorHelperService.handleError(errorResponse);this.logger.error("[FileServerService] "+error.translatedMessage),reject(error)})})}getBlobUrlAndOrientationByFileDescriptorId(id){return this.$q((resolve,reject)=>{const fileDescriptor=this.fileStorageService.getFileDescriptorById(id);fileDescriptor?this.getBlobFromFileDescriptor(fileDescriptor,!1,null).then(blob=>{const result={id:id,blob:blob,blobUrl:URL.createObjectURL(blob)};if(fileDescriptor.orientation)return result.orientation=fileDescriptor.orientation,fileDescriptor.blobOrientationSubject.next(result),void resolve(result);this.setImageOrientationForFileDescriptor(fileDescriptor,blob).then(orientation=>{result.orientation=orientation,fileDescriptor.blobOrientationSubject.next(result),resolve(result)}).catch(()=>{fileDescriptor.blobOrientationSubject.next(result),resolve(result)})}).catch(error=>{reject(error)}):(this.logger.error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found for ID "+id),reject(new Error("[FileServerService] getBlobUrlAndOrientationById no file descriptor found")))})}setImageOrientationForFileDescriptor(fileDescriptor,blob){return new Promise((resolve,reject)=>{if(!fileDescriptor||!fileDescriptor.isImage())return void reject();const reader=new FileReader;reader.onload=e=>{fileDescriptor.orientation=1;const arrayBuffer=e.target.result,view=new DataView(arrayBuffer);if(65496!==view.getUint16(0,!1))return void reject();const length=view.byteLength;let offset=2;for(;offset<length;){if(view.getUint16(offset+2,!1)<=8)return void reject();const marker=view.getUint16(offset,!1);if(offset+=2,65505===marker){if(1165519206!==view.getUint32(offset+=2,!1))return void reject();const little=18761===view.getUint16(offset+=6,!1);offset+=view.getUint32(offset+4,little);const tags=view.getUint16(offset,little);offset+=2;for(let i=0;i<tags;i++)if(274===view.getUint16(offset+12*i,little)){const orientation=view.getUint16(offset+12*i+8,little);return fileDescriptor.orientation=orientation,void resolve(orientation)}}else{if(65280!=(65280&marker))break;offset+=view.getUint16(offset,!1)}}reject()},reader.readAsArrayBuffer(blob)})}uploadAFile(fileId,file,mime){return this.$q((resolve,reject)=>{const fileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);fileDescriptor&&fileDescriptor.setState("uploading"),fileDescriptor.chunkPercentArray=new Array(fileDescriptor.chunkTotalNumber),fileDescriptor.chunkPercentArray.fill(0),fileDescriptor.cancelTransfertDefer=this.$q.defer(),this.$http({method:"PUT",url:this.portalURL+"/"+fileId,headers:this.authService.getPostHeader("application/octet-stream"),data:file,timeout:fileDescriptor.cancelTransfertDefer.promise,eventHandlers:{progress:event=>{const percentChunk=Math.floor(100*event.loaded/event.total);fileDescriptor&&(fileDescriptor.chunkPercentArray[0]=percentChunk,fileDescriptor.updateProgressInfo())}}}).then(response=>{const newFileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);newFileDescriptor&&(newFileDescriptor.setState("uploaded"),fileDescriptor.updateProgressInfo()),this.logger.info("[FileServerService] uploadAFile success"),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",fileDesc:newFileDescriptor}),this.fileStorageService.orderDocuments(),resolve(newFileDescriptor)},errorResponse=>{const error=this.errorHelperService.handleError(errorResponse);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:fileDescriptor}),reject(error),this.logger.error("[FileServerService] "+error.message)})})}sendPartialDataToServer(fileDescriptor,filePart,minRange,maxRange,index,message,progressCallback){return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.portalURL+"/"+fileDescriptor.id+"/parts/"+index,headers:this.authService.getPostHeaderWithRange("bytes "+minRange+"-"+maxRange+"/"+fileDescriptor.size,"application/octet-stream"),data:filePart,timeout:fileDescriptor.cancelTransfertDefer.promise,uploadEventHandlers:{progress:event=>{const percentChunk=Math.floor(100*event.loaded/event.total);fileDescriptor&&(fileDescriptor.chunkPercentArray[index]=percentChunk,fileDescriptor.updateProgressInfo())}}}).then(response=>{const chunkResponse=response.data.data;this.logger.info("[FileServerService] sendPartialDataToServer success"),this.calculateMd5(filePart,blobChecksum=>{if(this.logger.info("[FileServerService] sendPartialDataToServer calculated checksum="+blobChecksum),this.logger.info("[FileServerService] sendPartialDataToServer md5sum="+chunkResponse.md5sum),chunkResponse.md5sum.localeCompare(blobChecksum)){this.logger.error("[FileServerService] Wrong Checksum for chunk detected: "+chunkResponse.md5sum+"/"+blobChecksum);reject({errorDetailsCode:500,message:"Wrong Checksum for chunk"})}else fileDescriptor.updateProgressInfo(),progressCallback&&progressCallback(message,fileDescriptor),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!0}),resolve(chunkResponse)})},errorResponse=>{const error=this.errorHelperService.handleError(errorResponse);reject(error),this.logger.error("[FileServerService] "+error.message)})})}calculateMd5(blob,callback){const reader=new FileReader;reader.readAsBinaryString(blob),reader.onloadend=()=>{callback(crypto_js_1.MD5(crypto_js_2.enc.Latin1.parse(reader.result)).toString(crypto_js_2.enc.Hex))}}uploadAFileByChunk(fileDescriptor,file,message,progressCallback){this.logger.info("[FileServerService] >uploadAFileByChunk");let range=this.getFileRange();if(range<file.size){file.size>=100*range&&(range=Math.round(file.size/100+this.ONE_KILOBYTE),this.logger.debug("[FileServerService] changing chunk size: "+range));const defered=this.$q.defer();fileDescriptor.chunkTotalNumber=Math.ceil(file.size/range),fileDescriptor.chunkPerformedPercent=0,fileDescriptor.chunkPercentArray=new Array(fileDescriptor.chunkTotalNumber),fileDescriptor.chunkPercentArray.fill(0),fileDescriptor.state="uploading",fileDescriptor.cancelTransfertDefer=this.$q.defer(),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{fileDesc:fileDescriptor,cancelable:!0});const promiseArray=[];for(let index=0,minRange=0,maxRange=range-1,repetition=Math.ceil(file.size/range);repetition>0;index++,repetition--,minRange+=range,maxRange+=range){const max=maxRange<file.size?maxRange:file.size,blob=file.slice(minRange,max+1);promiseArray.push(()=>this.sendPartialDataToServer(fileDescriptor,blob,minRange,max,index,message,progressCallback))}const promisesCompletion=()=>{this.$http({method:"PUT",url:this.portalURL+"/"+fileDescriptor.id+"/parts/end",headers:this.authService.getPostHeader("application/octet-stream")}).then(response=>{this.logger.info("[FileServerService] uploadAFileByChunk success"),fileDescriptor.setState("uploaded"),fileDescriptor.chunkPerformed=0,fileDescriptor.chunkTotalNumber=0,fileDescriptor.chunkPerformedPercent=0,progressCallback&&progressCallback(message,fileDescriptor),this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"success",type:"upload",fileDesc:fileDescriptor}),this.fileStorageService.orderDocuments(),this.fileStorageService.retrieveUserConsumption(),defered.resolve(fileDescriptor)},errorResponse=>{const error=this.errorHelperService.handleError(errorResponse);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:fileDescriptor}),defered.reject(error)})},promisesReject=errorResponse=>{const error=this.errorHelperService.handleError(errorResponse);this.$rootScope.$broadcast("ON_FILE_TRANSFER_EVENT",{result:"failure",type:"upload",fileDesc:fileDescriptor}),defered.reject(error)};return this.transfertPromiseQueue.addPromiseArray(fileDescriptor.id,promiseArray,promisesCompletion,promisesReject),defered.promise}return progressCallback&&progressCallback(message,fileDescriptor),this.uploadAFile(fileDescriptor.id,file,fileDescriptor.typeMIME).then(response=>(this.logger.info("[FileServerService] uploadAFile success"),progressCallback&&progressCallback(message,fileDescriptor),this.fileStorageService.retrieveUserConsumption(),this.$q.resolve(fileDescriptor)))}isTransferInProgress(){return this.transfertPromiseQueue&&this.transfertPromiseQueue.isTransferInProgress()}cancelAllTransfers(){this.transfertPromiseQueue&&this.transfertPromiseQueue.cancelAllTransfers()}cancelCurrentFiletransfer(id){const fileDesc=this.fileStorageService.getFileDescriptorById(id);fileDesc&&(fileDesc.cancelTransfertDefer&&fileDesc.cancelTransfertDefer.resolve(),fileDesc.state="uploaded",fileDesc.progressSubject.next({})),this.transfertPromiseQueue&&this.transfertPromiseQueue.cancelCurrentFiletransfer(id)}getServercapabilities(){return this.$q((resolve,reject)=>{this.$http({method:"GET",url:config.restServerUrl+"/api/rainbow/fileserver/v1.0/capabilities",headers:this.authService.getRequestHeader()}).then(response=>{this.logger.info("[FileServerService] getServercapabilities -- success"),this.capabilities=response.data.data,resolve(this.capabilities)},errorResponse=>{const error=this.errorHelperService.handleError(errorResponse);this.logger.error("[FileServerService] getServercapabilities "+error.message),reject(error)})})}}exports.FileServerService=FileServerService,FileServerService.$inject=["$q","$http","TransfertPromiseQueue","FileDescriptorEventHandler","errorHelperService","$rootScope"],angular.module("rainbow").service("fileServerService",FileServerService)}).call(this,__webpack_require__(56).Buffer)},function(module,exports,__webpack_require__){"use strict";exports.byteLength=function(b64){var lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1];return 3*(validLen+placeHoldersLen)/4-placeHoldersLen},exports.toByteArray=function(b64){var tmp,i,lens=getLens(b64),validLen=lens[0],placeHoldersLen=lens[1],arr=new Arr(function(b64,validLen,placeHoldersLen){return 3*(validLen+placeHoldersLen)/4-placeHoldersLen}(0,validLen,placeHoldersLen)),curByte=0,len=placeHoldersLen>0?validLen-4:validLen;for(i=0;i<len;i+=4)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[curByte++]=tmp>>16&255,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp;2===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[curByte++]=255&tmp);1===placeHoldersLen&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[curByte++]=tmp>>8&255,arr[curByte++]=255&tmp);return arr},exports.fromByteArray=function(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,parts=[],i=0,len2=len-extraBytes;i<len2;i+=16383)parts.push(encodeChunk(uint8,i,i+16383>len2?len2:i+16383));1===extraBytes?(tmp=uint8[len-1],parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"="));return parts.join("")};for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(b64){var len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var validLen=b64.indexOf("=");return-1===validLen&&(validLen=len),[validLen,validLen===len?0:4-validLen%4]}function encodeChunk(uint8,start,end){for(var tmp,num,output=[],i=start;i<end;i+=3)tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(255&uint8[i+2]),output.push(lookup[(num=tmp)>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]);return output.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63},function(module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},function(module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0__);angular.module("rainbow").factory("FileDescriptorEventHandler",["$log","$rootScope",function($log,$rootScope){function FileDescriptorEventHandler(fileServerService){var that=this;this.fileServerService=fileServerService,this.fileStorageService=fileServerService.getFileStorageService(),that.onManagementMessageReceived=function(stanza){try{var stanzaElem=$(stanza);return stanzaElem.find("file").length>0?this.manageFileStanzaData(stanzaElem.find("file")):stanzaElem.find("thumbnail").length>0?this.manageThumbnailStanzaData(stanzaElem.find("thumbnail")):$log.info("[FileDescriptorEventHandler] onManagementMessageReceived  -- ignore the message"),!0}catch(error){return $log.error("[FileDescriptorEventHandler] onManagementMessageReceived ERROR "+error),!0}},that.manageFileStanzaData=function(stanza){for(var action=$(stanza).attr("action"),filesId=$(stanza).find("fileid"),updateConsumption=!1,i=0;i<filesId.length;i++){var fileId=$(filesId[i]).text(),fileDescriptor=this.fileStorageService.getFileDescriptorById(fileId);switch($log.info("[FileDescriptorEventHandler] manageFileStanzaData -- "+action+" fileDescriptor "+fileId),action){case"create":$log.debug("[FileDescriptorEventHandler] fileDescriptor "+fileId+" created on server -- do nothing");break;case"delete":fileDescriptor&&(fileDescriptor.ownerId===_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default.a.userContact.dbId&&"deleted"!==fileDescriptor.state&&(updateConsumption=!0),this.fileStorageService.deleteFileDescriptorFromCache(fileId),this.fileStorageService.deleteVoiceMessageFileDescriptor(fileId),$rootScope.$broadcast("ON_FILE_REMOVED_FROM_STORE_EVENT",{fileId:fileId}));break;case"update":that.fileStorageService.retrieveAndStoreOneFileDescriptor(fileId,!0).then((function(fileDesc){$log.info("[FileDescriptorEventHandler] fileDescriptor retrieved"),!fileDesc.ownerId===_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_0___default.a.userContact.dbId&&this.fileStorageService.retrieveUserConsumption(),!fileDesc.previewBlob&&fileDesc.isThumbnailPossible()&&that.fileServerService.getBlobThumbnailFromFileDescriptor(fileDesc).then((function(blob){fileDesc.previewBlob=blob,fileDesc.previewBlobSubject.next(fileDesc.previewBlob),$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDesc.id})})).catch((function(error){$log.error("[FileDescriptorEventHandler] fileDescriptor retrieve error : ",error)}))})),that.fileStorageService.retrieveAndStoreOneVoiceMessageFileDescriptor(fileId)}}updateConsumption&&this.fileStorageService.retrieveUserConsumption()},that.manageThumbnailStanzaData=function(stanza){var action=$(stanza).attr("action"),fileId=$(stanza).find("fileid").text(),fileUrl=$(stanza).find("url").text(),fileMime=$(stanza).find("mime").text(),fileSize=$(stanza).find("size").text(),md5sum=$(stanza).find("md5sum").text(),originalWidth=$(stanza).find("originalWidth").text(),originalHeight=$(stanza).find("originalHeight").text();$log.info("[FileDescriptorEventHandler] manageThumbnailStanzaData -- "+action+" fileDescriptor "+fileId),$log.debug("[FileDescriptorEventHandler]   fileUrl="+fileUrl),$log.debug("[FileDescriptorEventHandler]   fileMime="+fileMime),$log.debug("[FileDescriptorEventHandler]   fileSize="+fileSize),$log.debug("[FileDescriptorEventHandler]   md5sum="+md5sum),$log.debug("[FileDescriptorEventHandler]   fileId="+fileId),"create"!==action&&"update"!==action||this.fileStorageService.retrieveAndStoreOneFileDescriptor(fileId).then((function(){var fileDescriptor=that.fileStorageService.getFileDescriptorById(fileId);fileDescriptor?($log.debug("[FileDescriptorEventHandler] updating Thumbnail of found FileDescriptor "+fileId),fileDescriptor.previewBlob&&!fileDescriptor.previewDownloaded||!fileDescriptor.previewBlob?($rootScope.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",fileDescriptor.id),fileDescriptor.thumbnail.availableThumbnail=!0,fileDescriptor.thumbnail.md5sum=md5sum,fileDescriptor.thumbnail.size=fileSize,originalWidth&&originalHeight&&fileDescriptor.setOriginalImageDimensions(originalWidth,originalHeight),$log.info("[FileDescriptorEventHandler] preview not already downloaded for "+fileId+" -- download it"),that.fileServerService.getBlobThumbnailFromFileDescriptor(fileDescriptor).then((function(){$rootScope.$broadcast("ON_FILE_DESCRIPTOR_RECEIVED_EVENT",{fileId:fileDescriptor.id})}))):($rootScope.$broadcast("ON_FILE_DESCRIPTOR_THUMBNAIL_READY",fileDescriptor.id),$log.info("[FileDescriptorEventHandler] preview already downloaded for "+fileId+" -- do nothing"))):$log.error("[FileDescriptorEventHandler] FileDescriptor not found and we do nothing and its not OK")})).catch((function(){$log.error("[FileDescriptorEventHandler] FileDescriptor was not found on server...")}))}}return FileDescriptorEventHandler.create=function(fileServerService){return new FileDescriptorEventHandler(fileServerService)},FileDescriptorEventHandler}])},function(module,exports){angular.module("rainbow").service("extensionSharingService",["$q","$log","$rootScope",function($q,$log,$rootScope){"use strict";var that=this;this.extensionFound=!1,this.minVersion="1.5.1",this.port=null,this.currentStreamId="screen",this.start=function(){this.extensionId=this.extensionId||this.getExtensionId(config.webservices.server);var defered=$q.defer();return $log.info("[extensionService] === STARTING ==="),window.chrome&&window.chrome.runtime?($log.info("[extensionService] Chrome extension - try to ping...",this.extensionId),chrome.runtime.sendMessage(this.extensionId,{type:"ping",data:null},null,(function(extensionMessageResponse){extensionMessageResponse&&"pong"===extensionMessageResponse.type?($log.info("[extensionService] Chrome extension - pong received"),$log.info("[extensionService] Chrome extension - extension installed and detected"),$log.info("[extensionService] Chrome extension - try to connect..."),that.port=chrome.runtime.connect(that.extensionId),that.port?($log.info("[extensionService] Chrome extension - port created"),that.port.onDisconnect.addListener((function(){$log.info("Extension DISCONNECTED"),that.extensionFound=!1,that.port=null})),that.port.onMessage.addListener((function(msg){switch($log.info("[extensionService] Chrome extension - connected"),msg.type){case"loginResponse":that.extensionFound=!0,$log.info("[extensionService] Chrome extension - ready!"),$log.info("[extensionService] === STARTED ==="),$rootScope.$broadcast("ON_EXTENSION_SHARING_READY"),defered.resolve();break;case"getVersionResponse":0===msg.code&&msg.version?($rootScope.$broadcast("ON_EXTENSION_VERSION_UPDATED",msg.version),$log.info("[extensionService] Chrome extension - Detected version "+msg.version)):($rootScope.$broadcast("ON_EXTENSION_VERSION_UPDATED",null),$log.error("[extensionService] Chrome extension - No version received"));break;case"startsharingResponse":0===msg.code&&msg.streamID?($log.info("[extensionService] Chrome extension - stream ID received "+msg.streamID),$rootScope.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",msg.streamID)):($log.info("[extensionService] Chrome extension - No stream ID received"),$rootScope.$broadcast("ON_EXTENSION_SHARING_STREAM_FOUND",null));break;case"endsharingResponse":$log.info("[extensionService] Chrome extension - end sharing session received")}})),that.port.postMessage({type:"login",data:null})):($log.info("[extensionService] Chrome extension - can't create port to contact the extension!!!"),$log.info("[extensionService] === STARTED ==="),defered.resolve())):($log.info("[extensionService] Chrome extension - not found"),chrome.runtime.lastError&&$log.info("[extensionService] Chrome extension - error "+chrome.runtime.lastError),defered.resolve())}))):($log.info("[extensionService] Not in chrome"),$log.info("[extensionService] === STARTED ==="),defered.resolve()),defered.promise},this.stop=function(){return $log.info("[extensionService] === STOPPING ==="),$log.info("[extensionService] === STOPPED ==="),$q.when()},this.getExtensionId=function(domain){return $log.info("Detected domain : "+domain),-1!==domain.indexOf("openrainbow.net")?"koefhabbjedbiecnldkolbijjfjinogj":-1!==domain.indexOf("openrainbow.org")?"ehamhlkmecdnidihfedapmplddlbidee":(-1!==domain.indexOf("openrainbow.com")||$log.error("Unkown domain, extension may not be available"),"mgneongoclkopahpapenfhbbeckhdmnj")},this.setExtensionId=function(extensionId){$log.info("set extensionId to : "+extensionId),this.extensionId=extensionId},this.getStreamToShareFromExtension=function(constraints){var defered=$q.defer(),callback=$rootScope.$on("ON_EXTENSION_SHARING_STREAM_FOUND",(function(__event,streamid){that.currentStreamId=streamid,callback(),streamid?(constraints.video.mandatory.chromeMediaSourceId=streamid,defered.resolve()):defered.reject()}));return this.port.postMessage({type:"startsharing",data:null}),defered.promise},this.getStreamId=function(){return this.currentStreamId},this.isExtensionInstalled=function(){var defered=$q.defer();return this.extensionFound?defered.resolve(!0):this.start().then((function(){defered.resolve(that.extensionFound)})),defered.promise},this.getExtensionVersion=function(){var defered=$q.defer(),callback=$rootScope.$on("ON_EXTENSION_VERSION_UPDATED",(function(__event,version){callback(),version?defered.resolve(version):defered.reject()}));return this.port.postMessage({type:"getVersion",data:null}),defered.promise},this.checkExtensionStatus=function(){var defered=$q.defer();return"chrome"!==adapter.default.browserDetails.browser?defered.resolve("notNeeded"):this.isExtensionInstalled().then((function(isInstalled){isInstalled?that.checkVersion().then((function(isUpToDate){isUpToDate?defered.resolve("good"):defered.resolve("needUpdate")})):defered.resolve("notInstalled")})),defered.promise},this.checkVersion=function(){var defered=$q.defer();return this.getExtensionVersion().then((function(version){defered.resolve(that.cmpVersions(version,that.minVersion)>=0)})),defered.promise},this.cmpVersions=function(curVersion,minVersion){var i,diff,regExStrip0=/(\.0+)+$/,segmentsA=curVersion.replace(regExStrip0,"").split("."),segmentsB=minVersion.replace(regExStrip0,"").split("."),length=Math.min(segmentsA.length,segmentsB.length);for(i=0;i<length;i++)if(diff=parseInt(segmentsA[i],10)-parseInt(segmentsB[i],10))return diff;return segmentsA.length-segmentsB.length}}])},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0});const uuid4=__webpack_require__(27),contact_service_1=__webpack_require__(1),settings_service_1=__webpack_require__(5),auth_service_1=__webpack_require__(2),rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),room_service_1=__webpack_require__(33);class WebConferenceService{constructor($q,$rootScope,$log,$http,$interval,videoService,errorHelperService,ConferenceSession,platformService,Conference,$translate,$injector){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.$http=$http,this.$interval=$interval,this.videoService=videoService,this.errorHelperService=errorHelperService,this.ConferenceSession=ConferenceSession,this.platformService=platformService,this.Conference=Conference,this.$translate=$translate,this.$injector=$injector,this.MEDIATYPE={WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly",PSTNAUDIO:"pstnAudio"},this.xmppConnectionSubscription=null,this.started=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.mozaicViewModeValue=!0,this.connected=!1,this.disconnecting=!1,this.reconnecting={},this.audioProfileChanging=!1,this.activeSpeaker=!1,this.addingMedia=!1,this.settingsService=settings_service_1.default,this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.profileService=profile_service_1.default,this.contactService=contact_service_1.default,this.roomService=room_service_1.default,this.conferenceEndpoints={},this.conferenceSessions={},this.rxSubject=new rxjs_1.Subject,this.attachLocalMediaStream=(attach,conferenceSession)=>{if(attach){let hasRemoteSessions=!1;if((conferenceSession.hasLocalVideo||conferenceSession.hasLocalSharing)&&(hasRemoteSessions=this.hasRemoteVideoOrSharingSession(conferenceSession.id)),conferenceSession.hasLocalVideo){let session=conferenceSession.sessions[conferenceSession.localVideoSessionId];if(session){let stream=conferenceSession.localStreams[session.localStreamId];hasRemoteSessions||conferenceSession.hasLocalSharing||this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),stream,session.sid),this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceVideoPip"),stream,session.sid)}}if(conferenceSession.hasLocalSharing){let session=conferenceSession.sessions[conferenceSession.localSharingSessionId];if(session){let stream=conferenceSession.localStreams[session.localStreamId];hasRemoteSessions?this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#conferenceSharingPip"),stream,session.sid):this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),stream,session.sid)}}}else this.videoService.RTC.clearMediaStream(angular.element("#minivideo"),null)}}start(stats){return this.contactService.userContact&&!this.contactService.userContact.roomsEnabled?(this.$log.info("[WebConferenceService] === start skipped - roomsEnabled : "+this.contactService.userContact.roomsEnabled),this.$q.when()):this.$q(resolve=>{let startDate=performance.now();this.$log.info("[WebConferenceService] === STARTING ==="),this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.conferenceEndpoints={},this.conferenceSessions={},this.listeners=[],this.statsIntervals=[],this.connected=!0,this.disconnecting=!1,this.webConferenceRoom=null,this.webrtcConferenceId=null,this.webrtcSharingOnlyRoom=null,this.webrtcSharingOnlyConferenceId=null,this.jingleJid=null,this.makingCall=!1,this.videoGalleryElements=[],this.activeSpeaker=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.BUBBLE_ACTIVE_SPEAKER),this.attachHandlers(),this.videoGalleryElementsNumber=5,this.started=!0;const startDuration=Math.round(performance.now()-startDate);stats.push({service:"WebConferenceService",startDuration:startDuration}),this.$log.info("[WebConferenceService] === STARTED ("+startDuration+" ms) ==="),resolve()})}stop(){return this.contactService.userContact&&!this.contactService.userContact.roomsEnabled?(this.$log.info("[WebConferenceService] === stop skipped - roomsEnabled : "+this.contactService.userContact.roomsEnabled),this.$q.when()):(this.$log.info("[WebConferenceService] === STOPPING ==="),this.started=!1,this.makingCall=!1,this.xmppConnectionSubscription&&this.xmppConnectionSubscription.unsubscribe(),this.listeners&&this.listeners.forEach(listenerDestroy=>{listenerDestroy()}),this.$log.info("[WebConferenceService] === STOPPED ==="),this.$q.when())}attachHandlers(){this.listeners.push(this.$rootScope.$on("ON_INPUT_DEVICE_CHANGED_EVENT",()=>{this.onAudioProfileChangeEvent()})),this.xmppConnectionSubscription=this.xmppService.subscribeToConnectionEvents(event=>{this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : "+event.name);try{if("ON_XMPP_DISCONNECTED"===event.name)this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : disconnected"),this.connected=!1;else if("ON_XMPP_CONNECTED"===event.name){this.$log.info("[WebConferenceService] onConnectionStateChangeEvent : connected"),this.connected=!0;for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];if("reconnecting"===conferenceSession.status)for(let sessId in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(sessId)){let session=conferenceSession.sessions[sessId];"audio"===session.localType&&this.sendTransportReplaceForSession(session,1e4)}this.$interval(confSession=>{if(this.connected&&confSession.isActive()&&confSession.haveJoined){if(confSession.videoGallery||(this.createVideoGalleryElements(confSession.conferenceView),confSession.videoGallery=this.videoGalleryElements),!this.isAlreadySubscribedToDynamicFeed(confSession.id)){let publisher=null;for(let pub of confSession.publishers)if("video"===pub.mediaType){publisher=pub;break}this.subscribeToDynamicFeed(confSession.id,publisher,confSession.videoGallery[0].id,"2",!0)}this.subscribeToPublishers(confSession)}},5e3,1,!0,conferenceSession)}}}catch(error){this.$log.info("[WebConferenceService] onConnectionStateChangeEvent error : "+error)}})}subscribe(handler){return this.rxSubject.subscribe(handler)}sendEvent(name,data=null){this.rxSubject.next(event_model_1.RBEvent.create(name,data))}retrieveWebConferences(mediaType=this.MEDIATYPE.WEBRTC){return this.$log.info("[WebConferenceService] retrieveWebConferences with mediaType="+mediaType),this.$q((resolve,reject)=>{if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED)&&mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.warn("[WebConferenceService] retrieveWebConferences - user is not allowed"),void reject(new Error("notAllowed"));let urlQueryParameters="?scheduled=false&format=full&userId="+this.contactService.userContact.dbId;this.$http({method:"GET",url:this.confProvPortalURL+"conferences"+urlQueryParameters,headers:this.authService.getRequestHeader()}).then(response=>{let conferencesProvisionData=response.data.data;this.$log.info("[WebConferenceService] retrieveWebConferences successfully");for(let conferenceData of conferencesProvisionData)switch(conferenceData.mediaType){case this.MEDIATYPE.WEBRTC:case this.MEDIATYPE.WEBRTCSHARINGONLY:this.updateOrCreateWebConferenceEndpoint(conferenceData);break;case this.MEDIATYPE.PSTNAUDIO:}resolve(conferencesProvisionData)},response=>{let errorMessage="retrieveWebConferences failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}updateSubstreamLevelForPublisher(confId,participantId,subStreamLevel,galleryElement){return confId&&participantId&&subStreamLevel&&galleryElement&&galleryElement.publisherId?(this.$log.info("[WebConferenceService] updateSubstreamLevelForPublisher(confId="+confId+" participantId="+participantId+" publisherId="+galleryElement.publisherId+" level="+subStreamLevel+")"),galleryElement.simulcast&&galleryElement.subStreamLevel!==subStreamLevel?this.$q((resolve,reject)=>{if(!this.conferenceSessions[confId])return this.$log.error("[WebConferenceService] updateSubstreamLevelForPublisher - no corresponding conference session to update"),void reject();let data={option:"update",mediaType:"webrtc",publisherId:galleryElement.publisherId,subStreamLevel:subStreamLevel};this.$http({method:"PUT",url:this.confPortalURL+confId+"/participants/"+participantId,headers:this.authService.getRequestHeader(),data:data}).then(response=>{let status=response.data;galleryElement.subStreamLevel=subStreamLevel,this.$log.info("[WebConferenceService] updateSubstreamLevelForPublisher( confId="+confId+" participantId="+participantId+" publisherId="+galleryElement.publisherId+" level="+subStreamLevel+") successfully"),resolve(status)},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="updateSubstreamLevelForPublisher( confId="+confId+" participantId="+participantId+") failure: "+msg;this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.$log.info("[WebConferenceService] updateSubstreamLevelForPublisher - already at same level (or no simulcast proposed)"),this.$q.resolve())):(this.$log.error("[WebConferenceService] updateSubstreamLevelForPublisher - missing a parameter"),this.$q.reject())}updateConference(confEndpointId,confData){return this.$log.info("[WebConferenceService] updateConference"),this.$q((resolve,reject)=>{if(confEndpointId)this.$http({method:"PUT",url:this.confProvPortalURL+"conferences/"+confEndpointId,headers:this.authService.getRequestHeader(),data:confData}).then(response=>{let conferenceData=response.data.data,conference=this.Conference.createFromData(conferenceData);conferenceData.hasOwnProperty("id")&&(this.conferenceEndpoints[conferenceData.id]&&delete this.conferenceEndpoints[conferenceData.id],this.conferenceEndpoints[conferenceData.id]=conference),this.$log.info("[WebConferenceService] updateConference successfully"),resolve(conference)},response=>{let errorMessage="updateConference failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))});else{let errorMessage="updateConference failure: No confEndpoint";this.$log.error("[WebConferenceService] updateConference failure : No confEndpoint"),reject(new Error(errorMessage))}})}createVideoGalleryElements(conferenceView="gallery_view"){this.videoGalleryElements=[];let index=0;if(index=conferenceView===this.ConferenceSession.ConferenceView.SpeakerView?0:conferenceView===this.ConferenceSession.ConferenceView.GalleryView?this.videoGalleryElementsNumber:12,this.activeSpeaker){const obj={state:"free",sessionId:"",id:"videoGallery_0",publisherId:"",subStreamLevel:null,activeSpeaker:!0,hold:!1};this.videoGalleryElements.push(obj)}for(let i=1;i<=index;i++){let item={state:"free",sessionId:"",id:"videoGallery_"+i,publisherId:"",publisherJid:"",subStreamLevel:null,hold:!1};this.videoGalleryElements.push(item)}if(this.activeSpeaker&&this.mozaicViewModeValue)for(let i=index+1;i<=12;i++){let item={state:"busy",sessionId:"",id:"videoGallery_"+i,publisherId:"",publisherJid:"",subStreamLevel:null,hold:!1};this.videoGalleryElements.push(item)}}updateVideoGalleryElementsState(conferenceSession,videoGalleryElements,conferenceView){if(!this.activeSpeaker)return videoGalleryElements;let startIndex=0,endIndex=0;conferenceView===this.ConferenceSession.ConferenceView.SpeakerView?(startIndex=0,endIndex=0):conferenceView===this.ConferenceSession.ConferenceView.GalleryView?(startIndex=0,endIndex=this.videoGalleryElementsNumber):(startIndex=1,endIndex=12);for(let i=0;i<startIndex;i++)if("free"===videoGalleryElements[i].state)videoGalleryElements[i].state="busy";else if("busy"===videoGalleryElements[i].state&&videoGalleryElements[i].sessionId&&!videoGalleryElements[i].hold){const session=conferenceSession.sessions[videoGalleryElements[i].sessionId];session&&session.sendHold(!0),videoGalleryElements[i].hold=!0}for(let i=startIndex;i<=endIndex;i++)if("busy"!==videoGalleryElements[i].state||videoGalleryElements[i].sessionId||videoGalleryElements[i].publisherId){if("busy"===videoGalleryElements[i].state&&videoGalleryElements[i].sessionId&&videoGalleryElements[i].hold){videoGalleryElements[i].hold=!1;const session=conferenceSession.sessions[videoGalleryElements[i].sessionId];session&&session.sendHold(!1)}}else videoGalleryElements[i].state="free";for(let i=endIndex+1;i<=12;i++)if("free"===videoGalleryElements[i].state)videoGalleryElements[i].state="busy";else if("busy"===videoGalleryElements[i].state&&videoGalleryElements[i].sessionId&&!videoGalleryElements[i].hold){videoGalleryElements[i].hold=!0;const session=conferenceSession.sessions[videoGalleryElements[i].sessionId];session&&session.sendHold(!0)}return videoGalleryElements}holdOrUnholdHiddenSessions(conferenceSession,videoGalleryElements,hold){if(!this.activeSpeaker)return videoGalleryElements;const endIndex=this.videoGalleryElementsNumber;for(let i=1;i<=endIndex;i++)if("busy"!==videoGalleryElements[i].state||videoGalleryElements[i].sessionId||videoGalleryElements[i].publisherId||(videoGalleryElements[i].state="free"),hold&&"busy"===videoGalleryElements[i].state&&videoGalleryElements[i].sessionId&&!videoGalleryElements[i].hold&&!videoGalleryElements[i].pinned){videoGalleryElements[i].hold=!0;const session=conferenceSession.sessions[videoGalleryElements[i].sessionId];session&&session.sendHold(!0)}else if(!hold&&"busy"===videoGalleryElements[i].state&&videoGalleryElements[i].sessionId&&videoGalleryElements[i].hold){videoGalleryElements[i].hold=!1;const session=conferenceSession.sessions[videoGalleryElements[i].sessionId];session&&session.sendHold(!1)}return videoGalleryElements}setVideoGalleryElementsNumber(number){this.videoGalleryElementsNumber=number}setActiveSpeakerValue(value){this.activeSpeaker=value}setMozaicViewModeValue(value){this.mozaicViewModeValue=value}isActiveSpeakerEnabled(){return this.activeSpeaker}getConferenceSessions(){return this.conferenceSessions}getConferenceEndpoints(){return this.conferenceEndpoints}addConferenceEndpoint(conferenceEndpointId,conferenceEndpoint){conferenceEndpointId?this.conferenceEndpoints[conferenceEndpointId]=conferenceEndpoint:this.$log.warn("[WebConferenceService] addConferenceEndpoint - missing conferenceEndpointId")}getConferenceIdToUse(room,mediaType=this.MEDIATYPE.WEBRTC){let webPontConferenceId=this.getPontConfIdForRoom(room,mediaType);if(webPontConferenceId)return webPontConferenceId;switch(mediaType){case this.MEDIATYPE.WEBRTC:if(room.isUserModerator(this.contactService.userContact)&&this.webrtcConferenceId)return this.webrtcConferenceId;break;case this.MEDIATYPE.WEBRTCSHARINGONLY:if(room.owner&&this.webrtcSharingOnlyConferenceId)return this.webrtcSharingOnlyConferenceId}return""}isMyConference(conferenceId){return conferenceId&&(this.webrtcConferenceId&&conferenceId===this.webrtcConferenceId||this.webrtcSharingOnlyConferenceId&&conferenceId===this.webrtcSharingOnlyConferenceId)}bubbleDeclineInvitationForWebConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] bubbleDeclineInvitationForWebConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}let webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTC);if(!webPontConferenceId){let error=new Error("[webConferenceService] bubbleDeclineInvitationForWebConference error - no available pont conference");return this.$log.error(error.message),void reject(error)}this.$http({method:"PUT",url:this.confPortalURL+webPontConferenceId+"/reject",headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:room.dbId}}).then(()=>{this.$log.debug("[webConferenceService] bubbleDeclineInvitationForWebConference - success -- "),resolve()},errorResponse=>{this.makingCall=!1;this.$log.error("[webConferenceService] bubbleDeclineInvitationForWebConference - error on server"),reject(this.errorHelperService.handleError(errorResponse))})})}bubbleStartOrJoinWebConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] bubbleStartOrJoinWebConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}const webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTC);this.isMyConference(webPontConferenceId)?this.bubbleStartWebConference(room).then(()=>{resolve()}).catch(()=>{reject()}):this.bubbleJoinWebConference(room).then(()=>{resolve()}).catch(err=>{reject(err)})})}bubbleStartWebConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] bubbleStartWebConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}let webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTC);if(!webPontConferenceId){let error=new Error("[webConferenceService] bubbleStartWebConference error - no available pont conference");return this.$log.error(error.message),void reject(error)}if(this.makingCall)return this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve();this.$log.info("[WebConferenceService] bubbleStartWebConference "+webPontConferenceId),this.makingCall=!0;let confSession=this.conferenceSessions[webPontConferenceId];if(confSession&&confSession.active)return this.$log.info("[webConferenceService] bubbleStartWebConference - No need to start an already active conference"),void resolve(this.joinWebConference(webPontConferenceId,"moderator",!1));let conferenceSession=this.ConferenceSession.createFromData(webPontConferenceId,[],!1,"webrtc");conferenceSession.status="ringing",conferenceSession.roomId=room.dbId,conferenceSession.isMyConference=!0,this.conferenceSessions[webPontConferenceId]=conferenceSession,this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]),this.$http({method:"PUT",url:this.confPortalURL+webPontConferenceId+"/start",headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:room.dbId}}).then(()=>(this.$log.info("[webConferenceService] startWebConference - success -- now joining the conference"),resolve(this.joinWebConference(webPontConferenceId,"moderator",!1))),errorResponse=>{this.makingCall=!1;let errorMsg="[webConferenceService] startWebConference - error on server, can't start conference -- ",msg="startMeetingFailure";errorResponse&&((403620===errorResponse.errorDetailsCode||errorResponse.data&&403620===errorResponse.data.errorDetailsCode)&&(msg="startMeetingConflict"),errorResponse.errorDetailsLabel?errorMsg+=errorResponse.errorDetailsLabel:errorResponse.data&&(errorMsg+=errorResponse.data.errorDetailsCode+" "+errorResponse.data.errorMsg)),this.$log.error(errorMsg),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:msg,okLabel:"ok"}),this.leaveWebConference(webPontConferenceId),this.removeConferenceSession(webPontConferenceId),reject(this.errorHelperService.handleError(errorResponse)),this.$log.error("[webConferenceService] startWebConference "+this.errorHelperService.getErrorFullMessage(errorResponse))})})}bubbleJoinWebConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] bubbleJoinWebConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}let webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTC);if(!webPontConferenceId){let error=new Error("[webConferenceService] bubbleJoinWebConference error - no available pont conference");return this.$log.error(error.message),void reject(error)}if(this.makingCall)return this.$log.warn("[webConferenceService] already joining a conference"),this.$q.resolve();this.$log.info("[WebConferenceService] bubbleJoinWebConference "+webPontConferenceId),this.makingCall=!0,this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",room);let confSession=this.conferenceSessions[webPontConferenceId];confSession||(confSession=this.ConferenceSession.createFromData(webPontConferenceId,[],!1,"webrtc")),confSession.status="ringing",confSession.roomId=room.dbId,this.conferenceSessions[webPontConferenceId]=confSession,this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]);let role=this.isMyConference(webPontConferenceId)?"moderator":"member";this.joinWebConference(webPontConferenceId,role).then(()=>{resolve()}).catch(()=>{reject()})})}startOrJoinWebConference(room){return this.$q((resolve,reject)=>{if(!room){let error=new Error("[webConferenceService] startOrJoinWebConference error - missing parameters for room");return this.$log.error(error.message),void reject(error)}let webPontConferenceId=this.getConferenceIdToUse(room,this.MEDIATYPE.WEBRTC);if(!webPontConferenceId){let error=new Error("[webConferenceService] startOrJoinWebConference error - no available pont conference");return this.$log.error(error.message),void reject(error)}if(this.$log.info("[WebConferenceService] startOrJoinWebConference -- "+webPontConferenceId),this.makingCall)return this.$log.warn("[webConferenceService] already starting a conference"),this.$q.resolve();this.makingCall=!0,this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTC).then(()=>{let conferenceSession=this.conferenceSessions[webPontConferenceId];if(!(this.isMyConference(webPontConferenceId)||conferenceSession&&conferenceSession.active)){let error=new Error("[webConferenceService] startOrJoinWebConference error - no active conference to join");return this.$log.error(error.message),reject(error),void(this.makingCall=!1)}let role=this.isMyConference(webPontConferenceId)?"moderator":"member";conferenceSession&&conferenceSession.active?(this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",room),resolve(this.joinWebConference(webPontConferenceId,role))):resolve(this.startWebConference(room,webPontConferenceId))},()=>{this.makingCall=!1;let error=new Error("[webConferenceService] startOrJoinWebConference error on snapshot");this.$log.error(error.message),reject(error)})})}startWebConference(room,webPontConferenceId,shouldSnapshotBeforeStart=!1){return webPontConferenceId&&room?(this.makingCall=!0,this.$log.info("[webConferenceService] startWebConference wtih ID "+webPontConferenceId),this.$q(resolve=>{shouldSnapshotBeforeStart?(this.$log.debug("[webConferenceService] startWebConference - trigger snapshot for "+webPontConferenceId),resolve(this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTC))):resolve()}).then(()=>this.conferenceSessions[webPontConferenceId].active?(this.$log.info("[webConferenceService] startWebConference - No need to start an already active conference"),this.joinWebConference(webPontConferenceId,"moderator",!1)):(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]),this.$http({method:"PUT",url:this.confPortalURL+webPontConferenceId+"/start",headers:this.authService.getRequestHeader(),data:{mediaType:this.MEDIATYPE.WEBRTC,roomId:room.dbId}}).then(()=>(this.$log.info("[webConferenceService] startWebConference - success -- now joining the conference"),this.joinWebConference(webPontConferenceId,"moderator",!1)),errorResponse=>{throw this.makingCall=!1,this.$log.error("[webConferenceService] startWebConference wtih ID "+webPontConferenceId+" failure ... -- "+this.errorHelperService.getErrorFullMessage(errorResponse)),this.leaveWebConference(webPontConferenceId),this.removeConferenceSession(webPontConferenceId),this.errorHelperService.handleError(errorResponse)}))).catch(err=>{this.makingCall=!1;let errorMsg="[webConferenceService] startWebConference - error on server, can't start conference -- ",msg="startMeetingFailure";return err&&(403620===err.errorDetailsCode&&(msg="startMeetingConflict"),err.errorDetailsLabel&&(errorMsg+=err.errorDetailsLabel)),this.$log.error(errorMsg),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:msg,okLabel:"ok"}),this.$q.reject(err)})):(this.$log.error("[startWebConference] No webPontConferenceId or Room!"),this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"startConference",popupBody:"startMeetingFailure",okLabel:"ok"}),this.$q.reject())}joinWebConference(webPontConferenceId,role,shouldSnapshotBeforeJoin=!1){return this.$log.info("[webConferenceService] joinWebConference with ID "+webPontConferenceId+" and role "+role),webPontConferenceId?this.$q(resolve=>{shouldSnapshotBeforeJoin?(this.$log.debug("[webConferenceService] joinWebConference - trigger snapshot for "+webPontConferenceId),resolve(this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTC))):resolve()}).then(()=>this.$q((resolve,reject)=>{this.makingCall=!0,this.createVideoGalleryElements(this.conferenceSessions[webPontConferenceId].conferenceView),this.conferenceSessions[webPontConferenceId].videoGallery=this.videoGalleryElements,"ringing"!==this.conferenceSessions[webPontConferenceId].status&&(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]));let id="web_"+uuid4(),delegateCapability=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED),url=this.confPortalURL+webPontConferenceId+"/join",params={participant:{role:role,type:"unmuted"},mediaType:this.MEDIATYPE.WEBRTC,delegateCapability:delegateCapability};this.videoService.config&&this.videoService.config.dc&&(params.dc=this.videoService.config.dc),this.getUserMediaForSession(webPontConferenceId).then(sessId=>{this.$http({method:"POST",url:url,headers:this.authService.getRequestHeader(),data:params}).then(response=>{let data=response.data.data;this.jingleJid=data.jingleJid;const forceTurn=data.transportTurn;this.initCall(this.jingleJid,webPontConferenceId,id,this.MEDIATYPE.WEBRTC,forceTurn),this.conferenceSessions[webPontConferenceId].haveJoined=!0,this.makingCall=!1,resolve()},errorResponse=>{if(errorResponse){const msg=errorResponse.data?errorResponse.data.errorDetails:errorResponse.data,errorMessage="joinWebConference( confId="+webPontConferenceId+") failure: "+msg;this.$log.error("[webConferenceService] "+errorMessage)}this.makingCall=!1;const data={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};errorResponse&&errorResponse.data&&403615===errorResponse.data.errorDetailsCode&&(data.popupBody="maximumNumberConferenceParticipantsReach"),errorResponse&&errorResponse.data&&403060===errorResponse.data.errorDetailsCode&&(data.popupBody="lockedConferenceError"),this.leaveWebConference(webPontConferenceId),delete this.conferenceSessions[webPontConferenceId],this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",data),reject(this.errorHelperService.handleError(errorResponse))})}).catch(reason=>{this.$log.error("[webConferenceService] joinWebConference - getUserMediaForSession reject -- "+reason),this.makingCall=!1,"ignore"!==reason&&this.leaveWebConference(webPontConferenceId),reject()})})).catch(()=>(this.makingCall=!1,this.$log.error("[webConferenceService] joinWebConference - error on server, can't join conference"),this.$q.reject())):(this.$log.error("[webConferenceService] joinWebConference - No webPontConferenceId !"),this.$q.reject())}joinSharingOnlyConference(webPontConferenceId,role,shouldSnapshotBeforeJoin=!0){return this.$log.info("[webConferenceService] joinSharingOnlyConference with ID "+webPontConferenceId+" and role "+role),webPontConferenceId?this.$q(resolve=>{shouldSnapshotBeforeJoin?(this.$log.debug("[webConferenceService] joinSharingOnlyConference - trigger snapshot for "+webPontConferenceId),resolve(this.makeSnapshotForConfId(webPontConferenceId,this.MEDIATYPE.WEBRTCSHARINGONLY))):resolve()}).then(()=>this.$q((resolve,reject)=>{this.makingCall=!0,this.createVideoGalleryElements(),this.conferenceSessions[webPontConferenceId].videoGallery=this.videoGalleryElements,"ringing"!==this.conferenceSessions[webPontConferenceId].status&&(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[webPontConferenceId]));uuid4();let url=this.confPortalURL+webPontConferenceId+"/join",params={participant:{role:role,type:"muted"},mediaType:this.MEDIATYPE.WEBRTCSHARINGONLY};this.$http({method:"POST",url:url,headers:this.authService.getRequestHeader(),data:params}).then(response=>{let data=response.data.data;this.jingleJid=data.jingleJid,this.$log.info("[webConferenceService] joinSharingOnlyConference with ID success - jingleJid: "+this.jingleJid),this.conferenceSessions[webPontConferenceId].jingleJid=this.jingleJid,this.conferenceSessions[webPontConferenceId].haveJoined=!0,this.makingCall=!1,resolve()},errorResponse=>{if(errorResponse){let msg=errorResponse.data?errorResponse.data.errorDetails:errorResponse.data,errorMessage="joinSharingOnlyConference( confId="+webPontConferenceId+") failure: "+msg;this.$log.error("[conferenceService] "+errorMessage)}this.makingCall=!1;let data={popupTitle:"warning",popupBody:"joinMeetingFailure",okLabel:"ok"};errorResponse&&errorResponse.data&&403615===errorResponse.data.errorDetailsCode&&(data.popupBody="maximumNumberConferenceParticipantsReach"),this.leaveWebConference(webPontConferenceId),delete this.conferenceSessions[webPontConferenceId],reject(this.errorHelperService.handleError(errorResponse))})})).catch(()=>(this.makingCall=!1,this.$log.error("[webConferenceService] joinSharingOnlyConference - error on server, can't join conference"),this.$q.reject())):(this.$log.error("[webConferenceService] joinSharingOnlyConference - No webPontConferenceId !"),this.$q.reject())}getFreeVideoGalleryElement(confId){this.$log.info("[webConferenceService] getFreeVideoGalleryElement "+confId);let confSession=this.conferenceSessions[confId],result=null;if(confSession){confSession.videoGallery||(this.createVideoGalleryElements(confSession.conferenceView),confSession.videoGallery=this.videoGalleryElements);for(let i=0;i<confSession.videoGallery.length;i++)if("free"===confSession.videoGallery[i].state){result=confSession.videoGallery[i];break}}return result}askToAddSharingToConferenceSession(conversation,conferenceSession){!this.videoService.askToAddSharing(conversation.id,"sharing")&&this.addMediaToConferenceSession(conferenceSession,"sharing")}addMediaToConferenceSession(conferenceSession,mediaType,existingStream=null){if(!conferenceSession)return;if(this.addingMedia)return;if("true"===this.settingsService.getSetting("sfuJoinBundle")&&"video"===mediaType)return void this.addBundleMediaToConferenceSession(conferenceSession);this.addingMedia=!0;let mediaToGet=[mediaType],simulcast=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_SIMULCAST),frameRate=17,videoWidth=simulcast?1280:640,videoHeight=simulcast?720:480;"video"!==mediaType&&(frameRate=10,videoWidth=1280,videoHeight=720),"sharing"===mediaType&&this.contactService.setBusyState("dnd","sharing");const callBackFunction=existingStream?this.$q.when(existingStream):this.videoService.getBrowserMedia(mediaToGet,videoWidth,videoHeight,frameRate);this.$log.info("[webConferenceService] addMediaToConferenceSession to session "+conferenceSession.id+" with media "+mediaType),callBackFunction.then(stream=>{this.addingMedia=!1;let streams=[stream],unifiedPlan=this.videoService.config.unifiedPlan,session=this.xmppService.connection.jingle.initiate(conferenceSession.jingleJid,this.xmppService.connection.jid,mediaType,streams,null,conferenceSession.id,null,unifiedPlan);conferenceSession.sessions[session.sid]=session,conferenceSession.localStreams.push(stream),session.localStreamId=conferenceSession.localStreams.length-1,"video"===mediaType?(conferenceSession.hasLocalVideo=!0,conferenceSession.localVideoSessionId=session.sid):(conferenceSession.hasLocalSharing=!0,conferenceSession.localSharingSessionId=session.sid,this.sendEvent("startHighlighting")),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.videoService.callsStats[session.sid]={},this.updateStatisticsForSession(conferenceSession.id,session.sid),this.statsIntervals.push(session.getStats(5e3))}).catch(()=>{this.addingMedia=!1})}removeMediaFromConferenceSession(conferenceSession,mediaType){if(!conferenceSession)return;"sharing"===mediaType&&this.contactService.setBusyState("dnd","audio"),"webrtcSharingOnly"===conferenceSession.type&&this.contactService.resetBusyState(),this.$log.info("[webConferenceService] removeMediaFromConferenceSession from session "+conferenceSession.id);let sessionId="video"===mediaType?conferenceSession.localVideoSessionId:conferenceSession.localSharingSessionId;if(conferenceSession.sessions[sessionId]){let session=conferenceSession.sessions[sessionId];this.updateStatisticsForSession(conferenceSession.id,sessionId),this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid),delete conferenceSession.sessions[sessionId],delete conferenceSession.localStreams[session.localStreamId],delete this.videoService.callsStats[sessionId],"video"===mediaType?(conferenceSession.hasLocalVideo=!1,conferenceSession.localVideoSessionId=null):(conferenceSession.hasLocalSharing=!1,conferenceSession.localSharingSessionId=null,this.sendEvent("stopHighlighting"))}this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession)}dropRemoteVideoSession(conferenceSession,sessionId){if(conferenceSession){if(this.$log.info("[webConferenceService] dropRemoteVideoSession fom conference "+conferenceSession.id+" and session "+sessionId),conferenceSession.sessions[sessionId]){let session=conferenceSession.sessions[sessionId];this.updateStatisticsForSession(conferenceSession.id,sessionId),this.xmppService.connection.jingle.terminate(session.sid),delete conferenceSession.sessions[sessionId],delete this.videoService.callsStats[sessionId]}this.removeSessionFromVideoGallery(conferenceSession,sessionId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession)}}getUserMediaForSession(webPontConferenceId){return this.$q((resolve,reject)=>{let conference=this.conferenceSessions[webPontConferenceId];if(!conference)return void reject();"ringing"!==conference.status&&(this.conferenceSessions[webPontConferenceId].status="ringing",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conference)),conference.haveJoined=!0;this.videoService.getBrowserMedia(["audio"]).then(stream=>{this.$log.info("[webConferenceService] getUserMediaForSession -- sucess");let conf=this.conferenceSessions[webPontConferenceId];if(!conf||"ended"===conf.status)return this.$log.info("[webConferenceService] getUserMediaForSession -- missing conference"),this.disableMediaStream(stream),void reject("conference does not exist anymore");if(!this.makingCall)return this.$log.info("[webConferenceService] getUserMediaForSession -- already in the conference -- ignore"),this.disableMediaStream(stream),void reject("ignore");let streams=[stream];conf.localStreams=streams,resolve()}).catch(()=>{this.$log.error("[webConferenceService] getUserMediaForSession error -- getUserMedia failed");this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"devicePermission",okLabel:"ok"}),reject("failed to get user media")})})}disableMediaStream(stream){stream&&(stream.getTracks().forEach(track=>{track.enabled=!1,track.stop(),track=null}),stream.stop&&stream.stop(),stream=null)}initCall(jid,webPontConferenceId,callId,type,forceTurn=!1){let conference=this.conferenceSessions[webPontConferenceId];return this.$q(resolve=>{conference||(this.$log.warn("[webConferenceService] initCall - no conferenceSession as though we are trying to init call"),resolve(this.makeSnapshotForConfId(webPontConferenceId,type))),resolve()}).then(()=>__awaiter(this,void 0,void 0,(function*(){yield this.videoService.setWebrtcConfiguration().catch(()=>{this.$log.error("[webConferenceService] initCall - setWebrtcConfiguration failed")});const unifiedPlan=!!this.videoService.config&&this.videoService.config.unifiedPlan;let media="audio";"true"===this.settingsService.getSetting("sfuJoinBundle")&&(media="audio+video");const session=this.xmppService.connection.jingle.initiate(jid,this.xmppService.connection.jid,media,conference.localStreams,callId,webPontConferenceId,null,unifiedPlan,forceTurn);return conference.jingleJid=jid,conference.sessions[session.sid]=session,conference.status="ringing",this.createStatisticsForSession(webPontConferenceId,session.sid),this.statsIntervals.push(session.getStats(3e3)),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conference),conference})))}transferCall(oldSession,jid,webPontConferenceId,callId,type,myConference=!1,roomDbId){return __awaiter(this,void 0,void 0,(function*(){try{this.makingCall=!0,this.$log.info("[webConferenceService] transferCall to "+webPontConferenceId),yield this.makeSnapshotForConfId(webPontConferenceId,type,!0),yield this.videoService.setWebrtcConfiguration().catch(()=>{this.$log.error("[webConferenceService] transferCall - setWebrtcConfiguration failed")});const unifiedPlan=!!this.videoService.config&&this.videoService.config.unifiedPlan;yield this.getUserMediaForSession(webPontConferenceId);const conference=this.conferenceSessions[webPontConferenceId];conference.participants&&conference.participants.forEach(participant=>{myConference&&participant.jid_im!==this.contactService.userContact.jid?participant.role="member":myConference||participant.jid_im!==this.contactService.userContact.jid||(participant.role="member")});let media="audio";"true"===this.settingsService.getSetting("sfuJoinBundle")&&(media="audio+video");const session=this.xmppService.connection.jingle.initiate(jid,this.xmppService.connection.jid,media,conference.localStreams,callId,webPontConferenceId,null,unifiedPlan,!1);if(conference.jingleJid=jid,conference.haveJoined=!0,conference.sessions[session.sid]=session,conference.status="ringing",conference.roomId=roomDbId,conference.isMyConference=myConference,this.createVideoGalleryElements(conference.conferenceView),conference.videoGallery=this.videoGalleryElements,!roomDbId){const rooms=this.roomService.findRoomsWithConfId(webPontConferenceId);rooms&&rooms[0]&&(conference.roomId=rooms[0].dbId)}this.conferenceSessions[webPontConferenceId]=conference,this.makingCall=!1,this.createStatisticsForSession(webPontConferenceId,session.sid),this.statsIntervals.push(session.getStats(3e3));try{if(oldSession&&-1!==oldSession.localType.indexOf("sharing")){const sharingStream=oldSession.localStreams[oldSession.localStreams.length-1].clone();this.$interval(webPontConferenceId=>{this.addMediaToConferenceSession(this.conferenceSessions[webPontConferenceId],"sharing",sharingStream)},1500,1,!0,webPontConferenceId)}return oldSession&&-1!==oldSession.localType.indexOf("video")&&this.$interval(webPontConferenceId=>{this.addMediaToConferenceSession(this.conferenceSessions[webPontConferenceId],"video")},1500,1,!0,webPontConferenceId),oldSession&&oldSession.isMuted&&this.$interval(webPontConferenceId=>{const webConferenceParticipant=this.conferenceSessions[webPontConferenceId].getConnectedParticipantByJid(this.contactService.userContact.jid);webConferenceParticipant&&this.muteParticipant(webPontConferenceId,webConferenceParticipant.participantId,"mute")},1e3,1,!0,webPontConferenceId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conference),conference}catch(err){return this.$log.error("[webConferenceService] transferCall error on duplicate stream -- "+err),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conference),conference}}catch(error){this.makingCall=!1,this.$log.error("[webConferenceService] transferCall error -- "+error)}}))}muteParticipant(confId,participantId,option){return this.$log.info("[ConferenceService] muteParticipant( confId="+confId+"participantId="+participantId+" option="+option+")"),confId&&participantId&&option?this.$q((resolve,reject)=>{if(!this.conferenceSessions[confId])return this.$log.error("[ConferenceService] muteParticipant - no corresponding conference session to update"),void reject();let data={option:option,mediaType:"webrtc"};this.$http({method:"PUT",url:this.confPortalURL+confId+"/participants/"+participantId,headers:this.authService.getRequestHeader(),data:data}).then(response=>{let status=response.data;this.$log.info("[ConferenceService] muteParticipant( confId="+confId+"participantId="+participantId+") successfully"),resolve(status)},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="muteParticipant( confId="+confId+"participantId="+participantId+") failure: "+msg;this.$log.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.$log.error("[ConferenceService] muteParticipant - missing a parameter"),this.$q.reject())}createStatisticsForSession(webConfId,sessionId){if(this.$log.info("[webConferenceService] createStatisticsForSession for conf "+webConfId+" and session "+sessionId),!webConfId||!sessionId)return void this.$log.warn("[webConferenceService] createStatisticsForSession -- missing parameters");this.videoService.callsStats[sessionId]={};let metrics=[];metrics.push({connectionId:sessionId,stats:this.videoService.callsStats[sessionId]}),this.videoService.createStatisticsForSession(webConfId,webConfId,"pending",metrics).then(id=>{this.$log.info("[webConferenceService] createStatisticsForSession success "+id),this.videoService.callsStats[sessionId].id=id,this.conferenceSessions[webConfId].metricsId=id,this.conferenceSessions[webConfId].metricsState="pending"}).catch(error=>{this.$log.error("[webConferenceService] createStatisticsForSession error for conf "+webConfId)})}updateStatisticsForSession(webConfId,sessionId){if(this.$log.info("[webConferenceService] updateStatisticsForSession for conf "+webConfId+" and session "+sessionId),!webConfId||!sessionId)return void this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing parameters");let webConference=this.conferenceSessions[webConfId];if(!webConference||!webConference.metricsId)return void this.$log.warn("[webConferenceService] updateStatisticsForSession -- missing webConference or no metricsId");webConference.metricsState||(webConference.metricsState="pending");let metrics=[];this.videoService.callsStats[sessionId]&&Object.keys(this.videoService.callsStats[sessionId]).length&&(this.videoService.callsStats[sessionId].RainMetrics&&this.videoService.callsStats[sessionId].push(this.videoService.callsStats[sessionId].RainMetrics),metrics.push({connectionId:sessionId,stats:this.videoService.callsStats[sessionId]}),this.videoService.updateStatisticsForCall(webConference.metricsId,webConfId,webConfId,webConference.metricsState,metrics))}leaveWebConference(confId){if(this.$log.info("[WebConferenceService] leaveWebConference - "+confId),this.contactService.resetBusyState(),!confId)return;let statsInterval,webConference=this.conferenceSessions[confId];if(this.sendEvent("stopHighlighting"),webConference){webConference.metricsState="ended";for(let property in webConference.sessions)if(webConference.sessions.hasOwnProperty(property)){let session=webConference.sessions[property];this.updateStatisticsForSession(webConference.id,session.sid),this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid),delete this.videoService.callsStats[session.sid]}for(this.videoService.disableStreams(webConference.localStreams),webConference.cleanupSessionData(),this.createVideoGalleryElements(webConference.conferenceView),webConference.videoGallery=this.videoGalleryElements,webConference.sessions={};this.statsIntervals.length;)statsInterval=this.statsIntervals.pop(),statsInterval&&(window.clearInterval(statsInterval),statsInterval=null);this.makingCall=!1,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",webConference),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference),this.videoService.clearSrcObjectsFromElements(),this.contactService.userContact.guestMode&&this.$rootScope.$broadcast("ON_OPEN_POPUP","concludeInvitation")}else this.$log.warn("[WebConferenceService] leaveWebConference - webConference does not exist")}attachDistantMediaStream(attach,conferenceSession){if(attach){let bundleSession=this.getRemoteAudioVideoBundleSession(conferenceSession.id);if(bundleSession)return void this.attachDistantBundleSession(bundleSession);let sessions=this.getRemoteVideoSessions(conferenceSession.id),remoteSharingSession=this.getRemoteSharingSession(conferenceSession.id),updatedMainSession=!1;if(remoteSharingSession&&!remoteSharingSession.showOnSecondPip||(updatedMainSession=this.updateMainSessionIfNeeded(conferenceSession,sessions)),this.$log.info("[WebConferenceService] attachDistantMediaStream for session "+conferenceSession.id),remoteSharingSession&&!remoteSharingSession.showOnSecondPip&&(remoteSharingSession.remoteStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,remoteSharingSession.sid)}),remoteSharingSession.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),remoteSharingSession.remoteStreamsObject[0],remoteSharingSession.sid)),sessions.length)for(let sessionId in sessions)if(sessions.hasOwnProperty(sessionId)&&(sessions[sessionId].remoteStreams&&sessions[sessionId].remoteStreams.forEach(track=>{if(track.getVideoTracks().length>0){remoteSharingSession&&!remoteSharingSession.showOnSecondPip||!sessions[sessionId].mainSession||this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,sessions[sessionId].sid);for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].sessionId===sessions[sessionId].sid){this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+conferenceSession.videoGallery[i].id),track,conferenceSession.videoGallery[i].sessionId);break}}}),sessions[sessionId].remoteStreamsObject[0])){remoteSharingSession&&!remoteSharingSession.showOnSecondPip||!sessions[sessionId].mainSession||this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),sessions[sessionId].remoteStreamsObject[0],sessions[sessionId].sid);for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].sessionId===sessions[sessionId].sid){this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#"+conferenceSession.videoGallery[i].id),sessions[sessionId].remoteStreamsObject[0],conferenceSession.videoGallery[i].sessionId);break}}let audioSession=this.getRemoteAudioSession(conferenceSession.id);audioSession&&audioSession.remoteStreams&&audioSession.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track)}),audioSession&&audioSession.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),audioSession.remoteStreamsObject[0]),updatedMainSession&&this.updateSubStreamLevelsForConferenceSession(conferenceSession.id)}}attachGalleryMediaStreams(conferenceSession){let sessions=this.getRemoteVideoSessions(conferenceSession.id);sessions.length&&sessions.forEach(session=>{for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].sessionId===session.sid){this.attachSessionVideoToHtmlElement(session,conferenceSession.videoGallery[i].id);break}})}attachMozaicVideos(conferenceSession,mozaicElements){const sessions=this.getRemoteVideoSessions(conferenceSession.id);sessions.length&&sessions.forEach(session=>{mozaicElements.forEach((element,index)=>{element.videoSessionId===session.sid&&this.attachSessionVideoToHtmlElement(session,"mozaic_videoGallery_"+index)})});const sharingSession=this.getRemoteSharingSession(conferenceSession.id);sharingSession&&this.attachSessionVideoToHtmlElement(sharingSession,"mozaicSharingVideo")}attachLocalPipVideo(conferenceSession){if(conferenceSession.hasLocalVideo){let session=conferenceSession.sessions[conferenceSession.localVideoSessionId];session&&this.attachSessionVideoToHtmlElement(session,"conferenceVideoPip")}}attachActiveTalkerLocalAndRemoteMediaStreams(conferenceSession){this.attachRemoteAudioStream(conferenceSession);let bundleSession=this.getRemoteAudioVideoBundleSession(conferenceSession.id);if(bundleSession)return void this.attachDistantBundleSession(bundleSession);let sessions=this.getRemoteVideoSessions(conferenceSession.id),remoteSharingSession=this.getRemoteSharingSession(conferenceSession.id);this.updateMainSessionIfNeededToDynamicFeed(conferenceSession,sessions),this.$log.info("[WebConferenceService] attachLocalAndRemoteMediaStreams for session "+conferenceSession.id);let mainScreenBusy=!1,hasSharingSession=!1;if(remoteSharingSession&&!remoteSharingSession.showOnSecondPip?(hasSharingSession=!0,this.attachSessionVideoToHtmlElement(remoteSharingSession,"largevideo"),mainScreenBusy=!0):remoteSharingSession&&remoteSharingSession.showOnSecondPip&&(hasSharingSession=!0,this.attachSessionVideoToHtmlElement(remoteSharingSession,"sfuActiveSpeakerSecondVideo")),conferenceSession.hasLocalSharing){let session=conferenceSession.sessions[conferenceSession.localSharingSessionId];session&&(hasSharingSession=!0,session.showOnSecondPip?this.attachSessionVideoToHtmlElement(session,"sfuActiveSpeakerSecondVideo"):(this.attachSessionVideoToHtmlElement(session,"largevideo"),mainScreenBusy=!0))}if(sessions.length&&sessions.forEach(session=>{session.mainSession&&!mainScreenBusy?(mainScreenBusy=!0,this.attachSessionVideoToHtmlElement(session,"largevideo")):(session.mainSession&&mainScreenBusy||!session.mainSession&&session.activeSpeaker&&!hasSharingSession)&&this.attachSessionVideoToHtmlElement(session,"sfuActiveSpeakerSecondVideo")}),conferenceSession.hasLocalVideo){let session=conferenceSession.sessions[conferenceSession.localVideoSessionId];session&&this.attachSessionVideoToHtmlElement(session,"conferenceVideoPip")}}attachRemoteAudioStream(conferenceSession){let audioSession=this.getRemoteAudioSession(conferenceSession.id);audioSession&&audioSession.remoteStreams&&audioSession.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track)}),audioSession&&audioSession.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),audioSession.remoteStreamsObject[0])}attachMainMediaStream(session){session&&(this.$log.info("[webConferenceService] attachMainMediaStream"),session.remoteStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,session.sid)}),session&&session.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStream(angular.element("#largevideo"),session.remoteStreamsObject[0]))}attachDistantBundleSession(session){session&&(this.$log.info("[webConferenceService] attachDistantBundleSession"),session.remoteStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element("#largevideo"),track,session.sid),track.getAudioTracks().length>0&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track)}),session&&session.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),session.remoteStreamsObject[0]),session&&session.remoteStreamsObject[1]&&this.videoService.RTC.attachMediaStream(angular.element("#largevideo"),session.remoteStreamsObject[1]))}attachSessionVideoToHtmlElement(session,elementId){let tag="#"+elementId;session&&elementId?(this.$log.info("[webConferenceService] attachSessionVideoToHtmlElement"),session.remoteStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element(tag),track,session.sid)}),session&&session.remoteStreamsObject[0]&&this.videoService.RTC.attachMediaStream(angular.element(tag),session.remoteStreamsObject[0]),session.localStreams.forEach(track=>{track.getVideoTracks().length>0&&this.videoService.RTC.attachMediaStreamIfNeeded(angular.element(tag),track,session.sid)})):!session&&elementId&&this.videoService.RTC.clearMediaStream(angular.element(tag),null)}updateMainSessionIfNeededToDynamicFeed(conferenceSession,sessions){this.$log.info("[webConferenceService] updateMainSessionIfNeededToDynamicFeed");let shouldUpdateMainScreen=!0;if(sessions&&sessions.length){let dynamicFeedSession=null,firstSession=null;Object.keys(sessions).forEach(key=>{const session=sessions[key];session&&(firstSession||(firstSession=session),!dynamicFeedSession&&session.activeSpeaker&&(dynamicFeedSession=session),session.mainSession&&(session.pinned||session.activeSpeaker)&&(shouldUpdateMainScreen=!1))}),shouldUpdateMainScreen&&(dynamicFeedSession?(dynamicFeedSession.mainSession=!0,dynamicFeedSession.pinned=!1,conferenceSession.videoGallery.forEach(element=>{element.pinned=!1,element.mainSession=!1})):firstSession&&(firstSession.mainSession=!0,firstSession.pinned=!1,conferenceSession.videoGallery.forEach(element=>{element.pinned=!1,element.sessionId===firstSession.sid?element.mainSession=!0:element.mainSession=!1})))}return shouldUpdateMainScreen}updateMainSessionIfNeeded(conferenceSession,sessions){this.$log.info("[webConferenceService] updateMainSessionIfNeeded");let shouldUpdateMainScreen=!0;if(sessions&&sessions.length){let firstSession=null;for(let property in sessions)sessions.hasOwnProperty(property)&&(firstSession||(firstSession=sessions[property]),sessions[property].mainSession&&(shouldUpdateMainScreen=!1));shouldUpdateMainScreen&&(firstSession.mainSession=!0,firstSession.pinned=!1,conferenceSession.videoGallery.forEach(element=>{element.pinned=!1,element.sessionId===firstSession.sid?element.mainSession=!0:element.mainSession=!1}))}return shouldUpdateMainScreen}getRelatedRoomToActiveConferenceSession(){return this.webConferenceRoom}getRelatedRoomToActiveSharingOnlyConferenceSession(){return this.webrtcSharingOnlyRoom}getConferenceBySessionId(sessionId){let result=null;for(let webConference in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(webConference)&&this.conferenceSessions[webConference].sessions)for(let session in this.conferenceSessions[webConference].sessions)if(this.conferenceSessions[webConference].sessions.hasOwnProperty(session)&&this.conferenceSessions[webConference].sessions[session].sid===sessionId)return result=this.conferenceSessions[webConference],result;return result}getPontConfIdForRoom(room,mediaType=this.MEDIATYPE.WEBRTC){if(room.confEndpoints&&room.confEndpoints.length)for(let i=0;i<room.confEndpoints.length;i++)if(room.confEndpoints[i].mediaType===mediaType)return room.confEndpoints[i].confEndpointId;return""}getConferenceSessionById(confId){return this.conferenceSessions[confId]}getSfuConferenceSessionForRoom(room){var confSession=null;return room&&(confSession=this.conferenceSessions[room.getSFUConfEndpointId()]),confSession}updateWebConferenceInfos(endpoints){this.$log.info("[WebConferenceService] updateWebConferenceInfos"),Object.assign(this.conferenceEndpoints,endpoints),this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.webrtcConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(conferenceRoom=>{let name="nothing";conferenceRoom&&(name=conferenceRoom.name),this.webConferenceRoom=conferenceRoom,this.$log.info("[WebConferenceService] === updateWebConferenceInfos : webrtcConferenceId is currently attached to "+name)},()=>{this.$log.info("[WebConferenceService] === updateWebConferenceInfos FAILURE ===")})}updateWebSharingOnlyConferenceInfos(endpoints){this.$log.info("[WebConferenceService] updateWebSharingOnlyConferenceInfos"),Object.assign(this.conferenceEndpoints,endpoints),this.webrtcSharingOnlyConferenceId=this.getWebRtcSharingOnlyConfEndpointId(),this.webrtcSharingOnlyConferenceId&&this.roomService.getRoomByConferenceEndpointId(this.webrtcSharingOnlyConferenceId).then(conferenceRoom=>{let name=conferenceRoom&&conferenceRoom.name?conferenceRoom.name:"nothing";this.webrtcSharingOnlyRoom=conferenceRoom,this.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos : webrtcSharingOnlyConferenceId is currently attached to "+name)},()=>{this.$log.info("[WebConferenceService] === updateWebSharingOnlyConferenceInfos FAILURE ===")})}updateWebConferenceRoom(){return this.webrtcConferenceId=this.getWebRtcConfEndpointId(),this.$q((resolve,reject)=>{this.roomService.getRoomByConferenceEndpointId(this.webrtcConferenceId).then(conferenceRoom=>{let name="nothing";conferenceRoom&&(name=conferenceRoom.name),this.webConferenceRoom=conferenceRoom,this.$log.info("[WebConferenceService] === updateWebConferenceRoom : room is currently attached to "+name),resolve()},()=>{this.$log.info("[WebConferenceService] === updateWebConferenceRoom FAILURE==="),reject()})})}getWebRtcConfEndpointId(){for(let property in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(property)&&this.conferenceEndpoints[property].mediaType===this.MEDIATYPE.WEBRTC)return this.conferenceEndpoints[property].id;return null}getWebRtcSharingOnlyConfEndpointId(){for(let property in this.conferenceEndpoints)if(this.conferenceEndpoints.hasOwnProperty(property)&&this.conferenceEndpoints[property].mediaType===this.MEDIATYPE.WEBRTCSHARINGONLY)return this.conferenceEndpoints[property].id;return null}isJoinWebConferenceAllowed(){return!0}getWebConference(confId){if(confId)return this.conferenceSessions[confId]}removeConferenceSession(confId){if(!confId)return;let statsInterval;for(this.removeAllJingleSessionsForConferenceSession(confId),delete this.conferenceSessions[confId];this.statsIntervals.length;)statsInterval=this.statsIntervals.pop(),statsInterval&&(window.clearInterval(statsInterval),statsInterval=null);this.makingCall=!1}removeAllJingleSessionsForConferenceSession(confId){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession){conferenceSession.metricsState="ended";for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];this.updateStatisticsForSession(conferenceSession.id,session.sid),delete this.videoService.callsStats[session.sid],this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid)}conferenceSession.sessions=[]}}hasActiveConferenceSession(){for(let property in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[property].isActive()&&this.conferenceSessions[property].haveJoined)return!0;return!1}hasActiveConferenceSessionWithAnyDevice(){for(let property in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[property].isActive()&&(this.conferenceSessions[property].haveJoined||this.conferenceSessions[property].joinedFromOtherDevice))return!0;return!1}getActiveConferenceSession(){let result=null;for(let property in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTC&&this.conferenceSessions[property].isActive()&&this.conferenceSessions[property].haveJoined&&(result=this.conferenceSessions[property]);return result}hasActiveSharingOnlyConferenceSession(){for(let property in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[property].isActive())return!0;return!1}getActiveSharingOnlyConferenceSession(){let result=null;for(let property in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(property)&&this.conferenceSessions[property].type===this.MEDIATYPE.WEBRTCSHARINGONLY&&this.conferenceSessions[property].isActive()&&(result=this.conferenceSessions[property]);return result}hasIncomingVideoStream(confId){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&("video"===session.remoteType||"sharing"===session.remoteType))return!0}return!1}getRemoteSessionsWithVideoOrSharingStreams(confId){let result=[];if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];session.isInitiator||"video"!==session.remoteType&&"sharing"!==session.remoteType&&"audio+video"!==session.remoteType||result.push(session)}return result}getRemoteSharingSession(confId){let result=null;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&"sharing"===session.remoteType){result=session;break}}return result}getSharingSession(confId){let result=null;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if("sharing"===session.remoteType||"sharing"===session.localType){result=session;break}}return result}hasRemoteVideoOrSharingSession(confId){let result=!1;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&("video"===session.remoteType||"sharing"===session.remoteType||"audio+video"===session.remoteType)){result=!0;break}}return result}getRemoteVideoSessions(confId){let result=[];if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];session.isInitiator||"video"!==session.remoteType||result.push(session)}return result}getRemoteAudioVideoBundleSession(confId){let result;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&"audio+video"===session.remoteType){result=session;break}}return result}getRemoteAudioSession(confId){let result;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if("audio"===session.localType){result=session;break}}return result}getRemoteMainVideoSession(confId){let sess;if(!confId)return sess;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if(!session.isInitiator&&"video"===session.remoteType&&session.mainSession){sess=session;break}}return sess}isAlreadySubscribedToDynamicFeed(confId){if(!confId)return!1;let result=!1,conferenceSession=this.conferenceSessions[confId];return conferenceSession&&conferenceSession.videoGallery&&"videoGallery_0"===conferenceSession.videoGallery[0].id&&"busy"===conferenceSession.videoGallery[0].state&&(result=!0),result}isAlreadySubscribedToPublisher(confId,publisherId){if(!confId||!publisherId)return!1;let result=!1,conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(!conferenceSession.videoGallery[i].activeSpeaker&&conferenceSession.videoGallery[i].publisherId===publisherId){result=!0;break}return result}getSessionIdForParticipantByPublisherId(confId,publisherId){let result="";if(!confId||!publisherId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].publisherId===publisherId){result=conferenceSession.videoGallery[i].sessionId;break}return result}relatePublisherToElement(confId,publisher,elementId,subStreamLevel,activeSpeaker=!1){if(!confId||!publisher||!elementId)return!1;this.$log.info("[WebConferenceService] relatePublisherToElement");let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)if(activeSpeaker)conferenceSession.videoGallery[0].state="busy",conferenceSession.videoGallery[0].publisherId="",conferenceSession.videoGallery[0].simulcast=publisher.simulcast,conferenceSession.videoGallery[0].subStreamLevel=subStreamLevel;else for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].id===elementId){conferenceSession.videoGallery[i].state="busy",conferenceSession.videoGallery[i].publisherId=publisher.participantId,conferenceSession.videoGallery[i].publisherJidIm=publisher.jid_im,conferenceSession.videoGallery[i].displayName=publisher.participantId,conferenceSession.videoGallery[i].simulcast=publisher.simulcast,conferenceSession.videoGallery[i].subStreamLevel=subStreamLevel;let contact=this.contactService.getContact(publisher.jid_im);contact&&(conferenceSession.videoGallery[i].displayName=contact.displayName);break}this.updateSubStreamLevelsForConferenceSession(confId)}getRelatedPublisherToElement(confId,elementId){if(!confId||!elementId)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");let result=null,conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(elementId===conferenceSession.videoGallery[i].id&&conferenceSession.videoGallery[i].publisherId){result=conferenceSession.videoGallery[i];break}return result}getRelatedElementToPublisher(confId,publisherId){if(!confId||!publisherId)return null;this.$log.info("[WebConferenceService] getRelatedPublisherToElement");let element=null,conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.videoGallery)for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].publisherId===publisherId){element=conferenceSession.videoGallery[i];break}return element}relateSessionToPublisher(confId,publisherId,sessionId){if(!confId||!publisherId||!sessionId)return!1;this.$log.info("[WebConferenceService] relateSessionToPublisher pubId "+publisherId+" sessionId "+sessionId);let result=!1,conferenceSession=this.conferenceSessions[confId];if(conferenceSession){for(let i=0;i<conferenceSession.videoGallery.length;i++)if(publisherId===conferenceSession.videoGallery[i].publisherId&&!conferenceSession.videoGallery[i].sessionId){conferenceSession.videoGallery[i].sessionId=sessionId,result=!0,"videoGallery_0"===conferenceSession.videoGallery[i].id&&(conferenceSession.sessions[sessionId].activeSpeaker=!0,conferenceSession.videoGallery[i].publisherId="");break}this.$log.info(conferenceSession.videoGallery)}return result}removeSessionFromVideoGallery(conferenceSession,sessionId){if(conferenceSession&&sessionId){conferenceSession.videoGallery||(this.createVideoGalleryElements(conferenceSession.conferenceView),conferenceSession.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] removeSessionFromVideoGallery for conference "+conferenceSession.id+" sessionId "+sessionId);for(let i=0;i<conferenceSession.videoGallery.length;i++)conferenceSession.videoGallery[i].sessionId===sessionId&&(conferenceSession.videoGallery[i].sessionId="",conferenceSession.videoGallery[i].state="free",conferenceSession.videoGallery[i].publisherId="",conferenceSession.videoGallery[i].publisherJidIm="",conferenceSession.videoGallery[i].displayName="",conferenceSession.videoGallery[i].simulcast=null,conferenceSession.videoGallery[i].subStreamLevel=null,conferenceSession.videoGallery[i].mainSession=!1,conferenceSession.videoGallery[i].pinned=!1,conferenceSession.videoGallery[i].hold=!1);conferenceSession.videoGallery=this.updateVideoGalleryElementsState(conferenceSession,conferenceSession.videoGallery,conferenceSession.conferenceView)}}reInitialiseVideoGalleryElementById(conferenceSession,elementId){if(conferenceSession&&elementId){conferenceSession.videoGallery||(this.createVideoGalleryElements(conferenceSession.conferenceView),conferenceSession.videoGallery=this.videoGalleryElements),this.$log.info("[WebConferenceService] reInitialiseVideoGalleryElementById for conference "+conferenceSession.id+" elementId "+elementId);for(let i=0;i<conferenceSession.videoGallery.length;i++)conferenceSession.videoGallery[i].id===elementId&&(conferenceSession.videoGallery[i].sessionId&&this.dropRemoteVideoSession(conferenceSession,conferenceSession.videoGallery[i].sessionId),conferenceSession.videoGallery[i].sessionId="",conferenceSession.videoGallery[i].state="free",conferenceSession.videoGallery[i].publisherId="",conferenceSession.videoGallery[i].publisherJidIm="",conferenceSession.videoGallery[i].displayName="",conferenceSession.videoGallery[i].subStreamLevel=null,conferenceSession.videoGallery[i].simulcast=null,conferenceSession.videoGallery[i].hold=!1,conferenceSession.videoGallery[i].reconnecting=!1);conferenceSession.videoGallery=this.updateVideoGalleryElementsState(conferenceSession,conferenceSession.videoGallery,conferenceSession.conferenceView)}}updateMainScreenSession(confId,element=null){if(!confId)return;this.$log.info("[WebConferenceService] updateMainScreenSession");let conferenceSession=this.conferenceSessions[confId];if(conferenceSession){for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let sess=conferenceSession.sessions[property];element&&element.sessionId===sess.sid?(sess.mainSession=!0,sess.pinned=!0):(sess.mainSession=!1,sess.pinned=!1)}return conferenceSession.videoGallery.forEach(galleryElement=>{element&&galleryElement.id===element.id?(galleryElement.mainSession=!0,galleryElement.pinned=!0):(galleryElement.mainSession=!1,galleryElement.pinned=!1)}),conferenceSession}}updateSubStreamLevelsForConferenceSession(confId){this.$log.info("[WebConferenceService] updateSubStreamLevelsForConferenceSession");let conferenceSession=this.conferenceSessions[confId],webConferenceParticipant=conferenceSession.getConnectedParticipantByJid(this.contactService.userContact.jid),remoteSharingSession=this.getRemoteSharingSession(conferenceSession.id);remoteSharingSession&&!remoteSharingSession.showOnSecondPip?conferenceSession.videoGallery.forEach(element=>{element.simulcast&&"videoGallery_0"!==element.id&&this.updateSubstreamLevelForPublisher(conferenceSession.id,webConferenceParticipant.participantId,"0",element)}):conferenceSession.videoGallery.forEach(element=>{if(element.simulcast&&"videoGallery_0"!==element.id){let session=conferenceSession.sessions[element.sessionId];if(session){let level=session.mainSession?"2":"0";this.updateSubstreamLevelForPublisher(conferenceSession.id,webConferenceParticipant.participantId,level,element)}}})}getListOfAvailableRemoteVideoPublishers(confId){if(!confId)return;this.$log.info("[WebConferenceService] getListOfAvailableRemoteVideoPublishers");let conferenceSession=this.conferenceSessions[confId],publishers=[];return conferenceSession&&(conferenceSession.videoGallery||(this.createVideoGalleryElements(conferenceSession.conferenceView),conferenceSession.videoGallery=this.videoGalleryElements),publishers=conferenceSession.getListOfRemoteVideoPublishers(),publishers=publishers.filter(publisher=>{for(let i=0;i<conferenceSession.videoGallery.length;i++)if(conferenceSession.videoGallery[i].publisherId===publisher.participantId)return!1;return!0})),publishers}getListOfPublishersForElementsOnHold(confId){if(!confId)return;this.$log.info("[WebConferenceService] getListOfPublishersForElementsOnHold");let conferenceSession=this.conferenceSessions[confId],publishers=[];if(conferenceSession){conferenceSession.videoGallery||(this.createVideoGalleryElements(conferenceSession.conferenceView),conferenceSession.videoGallery=this.videoGalleryElements);const remotePublishers=conferenceSession.getListOfRemoteVideoPublishers();for(let i=0;i<conferenceSession.videoGallery.length;i++)conferenceSession.videoGallery[i].publisherId&&conferenceSession.videoGallery[i].hold&&remotePublishers.forEach(pub=>{pub.participantId===conferenceSession.videoGallery[i].publisherId&&publishers.push(pub)})}return publishers}sendTransportReplaceForSession(sess,timeout){sess?this.reconnecting[sess.id]?this.$log.warn("[WebConferenceService] sendTransportReplaceForSession already reconnecting for session "+sess.id):(this.reconnecting[sess.id]=!0,timeout||(timeout=1e3),this.$interval(session=>{if(this.reconnecting[session.id]=!1,delete this.reconnecting[session.id],this.connected&&session&&session.peerconnection&&"stable"===session.peerconnection.signalingState&&("failed"===session.peerconnection.iceConnectionState||"disconnected"===session.peerconnection.iceConnectionState)&&(this.$log.info("[WebConferenceService] sendTransportReplaceForSession for session "+session.sid),session.connection=this.xmppService.connection,session.reconnectSession(),session.type!==this.MEDIATYPE.WEBRTCSHARINGONLY)){var state=session.hasLocalSharing?"sharing":"audio";this.contactService.setBusyState("dnd",state)}},timeout,1,!0,sess)):this.$log.warn("[WebConferenceService] sendTransportReplaceForSession missing session !")}onAudioProfileChangeEvent(){if(this.$log.info("[WebConferenceService] onAudioProfileChangeEvent"),this.audioProfileChanging)this.$log.info("[WebConferenceService] onAudioProfileChangeEvent -- already changing");else for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];for(let sessId in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(sessId)){let session=conferenceSession.sessions[sessId];"audio"===session.localType&&(this.audioProfileChanging=!0,this.$interval(sess=>{this.audioProfileChanging=!1;this.videoService.getBrowserMedia(["audio"]).then(stream=>{sess.removeStream(sess.localStreams[0]),this.videoService.stopActiveAudioVideoStreams(sess),sess.localStreams.push(stream),sess.addStream(sess.localStreams[0]),sess.sendTransportReplace()})},500,1,!0,session))}}}onJingleError(sessionId){this.$log.info("[WebConferenceService] onJingleError -- "+sessionId);let webConference=this.getConferenceBySessionId(sessionId);if(webConference&&webConference.sessions){"audio"===webConference.sessions[sessionId].localType?this.leaveWebConference(webConference.id):(this.updateStatisticsForSession(webConference.id,sessionId),webConference.localVideoSessionId===sessionId?this.removeMediaFromConferenceSession(webConference,"video"):webConference.localSharingSessionId===sessionId?this.removeMediaFromConferenceSession(webConference,"sharing"):(this.removeSessionFromVideoGallery(webConference,sessionId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference)))}}onIceConnectionDisconnectedForSession(conferenceSession,sessionId){if(this.$log.info("[WebConferenceService] onIceConnectionDisconnectedForSession -- "+sessionId),conferenceSession&&conferenceSession.sessions){let session=conferenceSession.sessions[sessionId];"audio"===session.localType?(conferenceSession.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.connected&&this.sendTransportReplaceForSession(session,1e3)):conferenceSession.localVideoSessionId!==sessionId&&conferenceSession.localSharingSessionId!==sessionId||this.connected&&this.sendTransportReplaceForSession(session,1e3)}}onIceConnectionFailedForSession(conferenceSession,sessionId){if(this.$log.info("[WebConferenceService] onIceConnectionFailedForSession -- "+sessionId),conferenceSession&&conferenceSession.sessions){let session=conferenceSession.sessions[sessionId];"audio"===session.localType?(conferenceSession.status="reconnecting",this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.connected&&this.sendTransportReplaceForSession(session,500)):conferenceSession.localVideoSessionId===sessionId||conferenceSession.localSharingSessionId===sessionId?this.connected&&this.sendTransportReplaceForSession(session,500):"video"===session.remoteType?(this.xmppService.connection.jingle.terminate(sessionId),this.updateStatisticsForSession(conferenceSession.id,sessionId),delete this.videoService.callsStats[sessionId],conferenceSession.videoGallery.forEach(element=>{element.sessionId===sessionId&&(element.sessionId="")}),delete conferenceSession.sessions[sessionId],this.connected&&this.resubscribeToSessions(conferenceSession)):(this.xmppService.connection.jingle.terminate(sessionId,"icefailed"),this.updateStatisticsForSession(conferenceSession.id,sessionId),delete this.videoService.callsStats[sessionId],this.removeSessionFromVideoGallery(conferenceSession,sessionId),delete conferenceSession.sessions[sessionId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession))}}onIncomingCall(sessionId){this.$log.info("[WebConferenceService] onIncomingCall -- "+sessionId);let session=this.xmppService.connection.jingle.sessions[sessionId],pontConfId=session.confId,conferenceSession=this.conferenceSessions[pontConfId];if(conferenceSession){if(conferenceSession.sessions[sessionId]=session,session.localType=session.remoteType,session.sendAnswer(),session.accept(),"video"===session.remoteType)if(!this.activeSpeaker||session.publisherId&&conferenceSession.videoGallery[0].sessionId!==session.sid){if(!this.relateSessionToPublisher(pontConfId,session.publisherId,session.sid)){this.$log.info("[WebConferenceService] no gallery element related to session, attach to first available");let element=this.getFreeVideoGalleryElement(pontConfId);element&&!this.isAlreadySubscribedToPublisher(conferenceSession.id,session.publisherId)&&(element.state="busy",element.publisherId=session.publisherId,element.sessionId=session.sid)}}else conferenceSession.videoGallery[0].publisherId="",session.activeSpeaker=!0;"sharing"===session.remoteType&&(this.updateSubStreamLevelsForConferenceSession(pontConfId),this.updateConferenceViewIfNeeded(pontConfId)),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.videoService.callsStats[session.sid]={},this.updateStatisticsForSession(conferenceSession.id,session.sid),this.statsIntervals.push(session.getStats(5e3))}else this.$log.error("[WebConferenceService] onIncomingCall no such conferenceSession "+pontConfId)}onTerminatedCall(sessionId){this.$log.info("[WebConferenceService] onTerminatedCall -- "+sessionId);let session=this.xmppService.connection.jingle.sessions[sessionId];if(!session){let conferenceSession=this.getActiveConferenceSession()?this.getActiveConferenceSession():this.getActiveSharingOnlyConferenceSession();if(conferenceSession&&conferenceSession.sessions){let sess=conferenceSession.sessions[sessionId];sess&&(conferenceSession.metricsState="ended"),sess&&"audio"===sess.localType?this.leaveWebConference(conferenceSession.id):conferenceSession.localVideoSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"video"):conferenceSession.localSharingSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"sharing"):(this.removeSessionFromVideoGallery(conferenceSession,sessionId),this.videoService.disableAudioVideoMedia(conferenceSession.sessions[sessionId]),delete conferenceSession.sessions[sessionId],delete this.videoService.callsStats[sessionId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession),this.updateSubStreamLevelsForConferenceSession(conferenceSession.id))}return}let pontConfId=session.confId,conferenceSession=this.conferenceSessions[pontConfId];conferenceSession?(this.updateStatisticsForSession(conferenceSession.id,sessionId),session&&"audio"===session.localType&&this.leaveWebConference(conferenceSession.id),conferenceSession.localVideoSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"video"):conferenceSession.localSharingSessionId===sessionId?this.removeMediaFromConferenceSession(conferenceSession,"sharing"):(this.removeSessionFromVideoGallery(conferenceSession,sessionId),this.videoService.disableAudioVideoMedia(session),this.xmppService.connection.jingle.terminate(session.sid),delete conferenceSession.sessions[session.sid],delete this.videoService.callsStats[sessionId],this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession))):this.$log.error("[WebConferenceService] onTerminatedCall no such conferenceSession "+pontConfId)}onConferenceCallSwitched(sessionId){this.$log.info("[WebConferenceService] onConferenceCallSwitched -- "+sessionId);let conferenceSession=this.getActiveConferenceSession();conferenceSession&&this.leaveWebConference(conferenceSession.id)}onIceConnectionStateChange(sessionId,session){this.$log.info("[WebConferenceService] onIceConnectionStateChange for session "+sessionId);let webConference=this.getConferenceBySessionId(sessionId);try{if(webConference&&session.peerconnection){if("stable"===session.peerconnection.signalingState&&"connected"===session.peerconnection.iceConnectionState){this.$log.info("[WebConferenceService] ICE Connection established successfully");let webConferenceParticipant=webConference.getConnectedParticipantByJid(this.contactService.userContact.jid);"connected"!==webConference.status&&webConferenceParticipant&&webConferenceParticipant.mute&&this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",this.$translate.instant("youMuted")),webConference.status="connected",webConference.startDuration(),session.remoteStreams&&session.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&(this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",webConference)}"stable"===session.peerconnection.signalingState&&"completed"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection completed successfully"),"connected"!==webConference.status&&(webConference.status="connected",webConference.startDuration(),session.remoteStreams&&session.remoteStreams.forEach(track=>{track.getAudioTracks().length>0&&(this.videoService.RTC.attachMediaStream(angular.element("#globalAudioTag"),track),this.videoService.resetAudioOutputElement(!0))}),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",webConference),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",webConference))),"stable"===session.peerconnection.signalingState&&"disconnected"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State disconnected"),this.onIceConnectionDisconnectedForSession(webConference,sessionId)),"stable"===session.peerconnection.signalingState&&"failed"===session.peerconnection.iceConnectionState&&(this.$log.info("[WebConferenceService] ICE Connection State failed"),this.onIceConnectionFailedForSession(webConference,sessionId))}}catch(error){this.$log.error("[WebConferenceService] onIceConnectionStateChange error "+error)}}updateOrCreateConferenceSession(confId,snapshotData,type="webrtc"){if(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession for "+confId),!confId||!snapshotData||!snapshotData.data)return this.$log.error("[webConferenceService] updateOrCreateConferenceSession - Not enough data"),null;let conferenceSession=this.conferenceSessions[confId];return conferenceSession?snapshotData.data.active!==conferenceSession.active&&(this.$log.debug("active"),conferenceSession.updateActiveState(snapshotData.data.active),snapshotData.data.active?this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession):this.leaveWebConference(confId)):(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - create new conferencesession with id "+confId+"and data: \n"+JSON.stringify(snapshotData.data)),conferenceSession=this.ConferenceSession.createFromData(confId,[],snapshotData.data.active,type),this.conferenceSessions[confId]=conferenceSession,this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession)),snapshotData.data.participants&&(this.$log.debug("[webConferenceService] updateOrCreateConferenceSession - (is active : "+conferenceSession.active+") update participants for "+confId+" with:\n"+JSON.stringify(snapshotData.data.participants)),conferenceSession.updateParticipants(snapshotData.data.participants).then(()=>{this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession)})),conferenceSession}updateOrCreateWebConferenceEndpoint(conferenceData){if(this.$log.info("[WebConferenceService] updateOrCreateWebConferenceEndpoint for "+conferenceData.id),!conferenceData)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - no conference data !"),null;if(conferenceData.mediaType!==this.MEDIATYPE.WEBRTC&&conferenceData.mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY)return this.$log.error("[WebConferenceService] updateOrCreateWebConferenceEndpoint - wrong mediaType:"+conferenceData.mediaType),null;let conference=this.Conference.createFromData(conferenceData);return this.conferenceEndpoints[conferenceData.id]=conference,conference.mediaType===this.MEDIATYPE.WEBRTC?this.updateWebConferenceInfos([conference]):this.updateWebSharingOnlyConferenceInfos([conference]),this.conferenceEndpoints[conferenceData.id]}makeSnapshotForConfId(confId=null,mediaType="webrtc",force=!1){if(!confId){let errorMsg="[webConferenceService] makeSnapshotForConfId - No confId !!";return this.$log.error(errorMsg),this.$q.reject(errorMsg)}let confSession=this.conferenceSessions[confId];return!force&&confSession&&confSession.active&&confSession.haveJoined?(this.$log.debug("[WebConferenceService] makeSnapshotForConfId skipped, already joined"),this.$q.resolve(confSession)):!force&&confSession&&this.makingCall?(this.$log.debug("[WebConferenceService] makeSnapshotForConfId skipped, we're currently joining the conference"),this.$q.resolve(confSession)):this.$q((resolve,reject)=>{this.$http({method:"GET",url:this.confPortalURL+confId+"/snapshot?mediaType=webrtc",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[webConferenceService] makeSnapshotForConfId success for confId "+confId);let snapshotData=response.data;this.updateOrCreateConferenceSession(confId,snapshotData,mediaType),resolve(snapshotData.data)}).catch(errorResponse=>{this.$log.info("[webConferenceService] makeSnapshotForConfId failure for confID "+confId),404===errorResponse.status?this.$log.error("[webConferenceService] makeSnapshotForConfId - confId "+confId+" not found on server"):this.$log.error("[webConferenceService] makeSnapshotForConfId - inconsistent object on server"),this.conferenceSessions[confId]&&this.removeConferenceSession(confId),reject()})})}refreshConferenceSessions(){return this.$log.info("[webConferenceService] refreshConferenceSessions"),this.$q((resolve,reject)=>{let promiseArray=[];for(let key in this.conferenceSessions)if(this.conferenceSessions.hasOwnProperty(key)){let conferenceSession=this.conferenceSessions[key];promiseArray.push(this.makeSnapshotForConfId(conferenceSession.id,conferenceSession.type))}this.$q.all(promiseArray).then(()=>{this.$log.info("[webConferenceService] refreshConferenceSessions -- success"),resolve()}).catch(()=>{this.$log.error("[webConferenceService] refreshConferenceSessions -- error -- cleaning up all sessions"),this.removeAllConferenceSessions(),reject()})})}removeAllConferenceSessions(){this.$log.info("[webConferenceService] removeAllConferenceSessions");for(let key in this.conferenceSessions)this.conferenceSessions.hasOwnProperty(key)&&this.removeConferenceSession(key)}getConferenceSessionForRoom(roomConfEndpoints){let sfuSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].mediaType!==this.MEDIATYPE.WEBRTC&&roomConfEndpoints[i].mediaType!==this.MEDIATYPE.WEBRTCSHARINGONLY||(sfuSession=this.conferenceSessions[roomConfEndpoints[i].confEndpointId]);return sfuSession}removeVideoGalleryVideos(conferenceSession){conferenceSession&&conferenceSession.videoGallery&&conferenceSession.videoGallery.forEach(element=>{let session=conferenceSession.sessions[element.sessionId];session&&(this.updateStatisticsForSession(conferenceSession.id,session.sid),this.videoService.disableAudioVideoMedia(session),delete conferenceSession.sessions[session.sid],delete conferenceSession.localStreams[session.localStreamId],delete this.videoService.callsStats[session.sid],this.xmppService.connection.jingle.terminate(session.sid))})}relateSessionToActiveSpeakerElement(confId,sessionId){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];conferenceSession&&conferenceSession.videoGallery&&(conferenceSession.videoGallery[0].sessionId=sessionId,conferenceSession.videoGallery[0].publisherId="")}resubscribeToSessions(conferenceSession){conferenceSession&&conferenceSession.publishers.length&&conferenceSession.videoGallery.forEach(element=>{"videoGallery_0"!==element.id||"busy"!==element.state||element.reconnecting||element.sessionId?"busy"!==element.state||element.reconnecting||element.sessionId||!element.publisherId||(element.reconnecting=!0,this.subscribeToPublisher(conferenceSession.id,element.publisherId,element.id,element.subStreamLevel).then(()=>{this.$log.info("[ConferenceService] resubscribeToSession for element "+element.id+" and publisher id "+element.publisherId+" -- success"),element.reconnecting=!1}).catch(()=>{this.$log.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+element.id),this.reInitialiseVideoGalleryElementById(conferenceSession,element.id)})):(element.reconnecting=!0,this.subscribeToPublisher(conferenceSession.id,conferenceSession.publishers[0],element.id,"2",!0).then(()=>{this.$log.info("[ConferenceService] resubscribeToSession dynamic feed for element "+element.id+" -- success"),element.reconnecting=!1}).catch(()=>{this.$log.error("[ConferenceService] subscribe to publisher dynamic feed failed, reset the video gallery element with id "+element.id),this.reInitialiseVideoGalleryElementById(conferenceSession,element.id)}))})}subscribeToPublishers(conferenceSession){conferenceSession&&conferenceSession.publishers.length&&conferenceSession.publishers.forEach(publisher=>{if("video"===publisher.mediaType&&!this.isAlreadySubscribedToPublisher(conferenceSession.id,publisher.participantId)){let element=this.getFreeVideoGalleryElement(conferenceSession.id);if(element){element.state="busy",element.publisherId=publisher.participantId;let subStreamLevel=publisher.simulcast?"0":null;this.subscribeToPublisher(conferenceSession.id,publisher,element.id,subStreamLevel).catch(()=>{this.$log.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+element.id),this.reInitialiseVideoGalleryElementById(conferenceSession,element.id)})}}})}updateConferenceViewIfNeeded(confId){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];conferenceSession&&conferenceSession.conferenceView===this.ConferenceSession.ConferenceView.GridView&&this.modifyConferenceView(confId,this.ConferenceSession.ConferenceView.GalleryView)}modifyConferenceView(confId,conferenceView){if(!confId)return;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession&&conferenceSession.conferenceView!==conferenceView){if(conferenceSession.conferenceView=conferenceView,conferenceView===this.ConferenceSession.ConferenceView.GalleryView){if(conferenceSession.videoGallery=this.updateVideoGalleryElementsState(conferenceSession,conferenceSession.videoGallery,conferenceView),!this.isAlreadySubscribedToDynamicFeed(conferenceSession.id)){let publisher=null;for(let pub of conferenceSession.publishers)if("video"===pub.mediaType){publisher=pub;break}this.subscribeToDynamicFeed(conferenceSession.id,publisher,conferenceSession.videoGallery[0].id,"2",!0)}this.subscribeToPublishers(conferenceSession)}else if(conferenceView===this.ConferenceSession.ConferenceView.SpeakerView){if(conferenceSession.videoGallery=this.updateVideoGalleryElementsState(conferenceSession,conferenceSession.videoGallery,conferenceView),!this.isAlreadySubscribedToDynamicFeed(conferenceSession.id)){let publisher=null;for(let pub of conferenceSession.publishers)if("video"===pub.mediaType){publisher=pub;break}this.subscribeToDynamicFeed(conferenceSession.id,publisher,conferenceSession.videoGallery[0].id,"2",!0)}}else conferenceView===this.ConferenceSession.ConferenceView.GridView&&(conferenceSession.videoGallery=this.updateVideoGalleryElementsState(conferenceSession,conferenceSession.videoGallery,conferenceView),this.subscribeToPublishers(conferenceSession));console.error(conferenceSession.videoGallery),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession)}}getActiveSpeakerSession(confId){let result=null;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];if(conferenceSession)for(let sessId in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(sessId)){let session=conferenceSession.sessions[sessId];if(session.activeSpeaker){result=session;break}}return result}getPinnedGalleryElement(confId){let result=null;if(!confId)return result;let conferenceSession=this.conferenceSessions[confId];return conferenceSession&&conferenceSession.videoGallery&&conferenceSession.videoGallery.forEach(element=>{element.pinned&&(result=element)}),result}subscribeToDynamicFeed(confId="",publisher=null,elementId="",subStreamLevel=null,activeSpeaker=!1){return this.$q((resolve,reject)=>{if(!confId||!publisher)return this.$log.warn("[WebConferenceService] subscribeToDynamicFeed missing parameters !! Ignore !"),void resolve();if(!this.activeSpeaker)return this.$log.warn("[WebConferenceService] subscribeToDynamicFeed -- feature not activated"),void resolve();if(this.conferenceSessions[confId].videoGallery[0].state="busy",this.conferenceSessions[confId].conferenceView===this.ConferenceSession.ConferenceView.GalleryView&&!this.isAlreadySubscribedToPublisher(confId,publisher.participantId)){let element=this.getFreeVideoGalleryElement(confId);element&&(element.state="busy",element.publisherId=publisher.participantId,this.$interval((confId,newPublisher,elemToSubscribe)=>{this.subscribeToPublisher(confId,newPublisher,elemToSubscribe,"0")},2500,1,!0,confId,publisher,element.id))}return this.subscribeToPublisher(confId,publisher,elementId,subStreamLevel,activeSpeaker)})}subscribeToPublisher(confId="",publisher=null,elementId="",subStreamLevel=null,activeSpeaker=!1){return this.$q((resolve,reject)=>{if(!confId||!publisher)return this.$log.warn("[WebConferenceService] subscribeToPublisher missing parameters !! Ignore !"),void resolve();this.$log.info("[WebConferenceService] subscribeToPublisher for confId "+confId+" and publisher "+publisher.participantId),elementId&&this.relatePublisherToElement(confId,publisher,elementId,subStreamLevel,activeSpeaker);let params=subStreamLevel?{subStreamLevel:subStreamLevel}:{};activeSpeaker&&(params.dynamicFeed=!0),this.$http({method:"POST",url:this.confPortalURL+confId+"/participants/"+publisher.participantId+"/subscribe",headers:this.authService.getRequestHeader(),data:params}).then(response=>{this.$log.info("[WebConferenceService] subscribeToPublisher successfully"),activeSpeaker&&this.relateSessionToActiveSpeakerElement(confId,response.data.data.sid),resolve(response.data)},response=>{let errorMessage="subscribeToPublisher failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}onNetworkQualityChange(sessionId){let webConference=this.getConferenceBySessionId(sessionId);if(webConference&&webConference.sessions){let session=webConference.sessions[sessionId];session&&"audio"===session.localType&&(this.videoService.callsStatsSimplified[sessionId].networkQualityFlag===webConference.networkQuality?(this.videoService.callsStatsSimplified[sessionId].networkQualityIteration=this.videoService.callsStatsSimplified[sessionId].networkQualityIteration?this.videoService.callsStatsSimplified[sessionId].networkQualityIteration+1:1,0===webConference.networkQuality&&this.videoService.callsStatsSimplified[sessionId].networkQualityIteration>=3&&this.$rootScope.$broadcast("ON_CONFERENCE_NETWORK_UPDATE_EVENT",webConference,"badNetworkQuality",webConference.networkQuality)):this.videoService.callsStatsSimplified[sessionId].networkQualityIteration=1,webConference.networkQuality=this.videoService.callsStatsSimplified[sessionId].networkQualityFlag,this.$rootScope.$broadcast("ON_CONFERENCE_NETWORK_UPDATE_EVENT",webConference,"networkQuality",webConference.networkQuality))}}delegateConferenceToParticipant(confId,participantId){return this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.confPortalURL+confId+"/participants/"+participantId+"/delegate",headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[WebConferenceService] delegateConferenceToParticipant successfully"),resolve(response.data)},response=>{let errorMessage="delegateConferenceToParticipant failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}onConferenceDelegated(oldConfId,newConfId){this.$log.info("[WebConferenceService] onConferenceDelegated from "+oldConfId+" to "+newConfId),this.conferenceSessions[newConfId]=this.conferenceSessions[oldConfId],this.conferenceSessions[newConfId].id=newConfId,this.isMyConference(newConfId)&&(this.conferenceSessions[newConfId].isMyConference=!0,this.conferenceSessions[newConfId].participants&&this.conferenceSessions[newConfId].participants.length&&this.conferenceSessions[newConfId].participants.forEach(participant=>{participant.jid_im!==this.contactService.userContact.jid?participant.role="member":participant.jid_im===this.contactService.userContact.jid&&(participant.role="moderator")})),delete this.conferenceSessions[oldConfId],this.roomService.updateRoomConfEndpoint(oldConfId,newConfId),this.$rootScope.$broadcast("ON_CONFERENCE_DELEGATED_EVENT",oldConfId,newConfId),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",this.conferenceSessions[newConfId]),this.isMyConference(oldConfId)||this.isMyConference(newConfId)||this.$interval(confId=>__awaiter(this,void 0,void 0,(function*(){let confInfos=yield this.getConferenceEndpointInfos(confId);if(confInfos&&confInfos.data&&confInfos.data.userId){const user=this.contactService.getContactById(confInfos.data.userId);user&&this.conferenceSessions[newConfId].participants&&this.conferenceSessions[newConfId].participants.length&&this.conferenceSessions[newConfId].participants.forEach(participant=>{participant.jid_im===user.jid&&(participant.role="moderator")}),this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",this.conferenceSessions[newConfId])}})),1e3,1,!0,newConfId)}getConferenceEndpointInfos(confEndpointId,format="small"){return this.$q((resolve,reject)=>{if(!confEndpointId)return this.$log.error("[WebConferenceService] getConferenceEndpointInfos -- missing endpointId "),void reject("[WebConferenceService] getConferenceEndpointInfos -- missing endpointId ");this.$http({method:"GET",url:this.confProvPortalURL+"conferences/"+confEndpointId+"?format="+format,headers:this.authService.getRequestHeader()}).then(response=>{this.$log.info("[WebConferenceService] getConferenceEndpointInfos successfully"),resolve(response.data)},response=>{let errorMessage="getConferenceEndpointInfos failure: "+(response.data?response.data.errorDetails:response.data);this.$log.error("[WebConferenceService] "+errorMessage),reject(new Error(errorMessage))})})}addBundleMediaToConferenceSession(conferenceSession){let audioSession;if(this.$log.info("[WebConferenceService] addBundleMediaToConferenceSession"),conferenceSession)for(let property in conferenceSession.sessions)if(conferenceSession.sessions.hasOwnProperty(property)){let session=conferenceSession.sessions[property];if("audio"===session.localType||"audio+video"===session.localType){audioSession=session;break}}if(audioSession){this.addingMedia=!0;let mediaToGet=["audio","video"],simulcast=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_SIMULCAST),frameRate=17,videoWidth=simulcast?1280:640,videoHeight=simulcast?720:480;this.videoService.getBrowserMedia(mediaToGet,videoWidth,videoHeight,frameRate).then(stream=>{this.addingMedia=!1,this.videoService.stopActiveAudioVideoStreams(audioSession),audioSession.removeStream(conferenceSession.localStreams[0]),audioSession.localStreams=[],conferenceSession.localStreams[0]=stream,audioSession.localStreams.push(stream),audioSession.addStream(conferenceSession.localStreams[0],!0),audioSession.contentAdd("video",!0),conferenceSession.hasLocalVideo=!0,conferenceSession.localVideoSessionId=audioSession.sid,audioSession.localStreamId=0,this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession)}).catch(()=>{this.addingMedia=!1})}}}WebConferenceService.$inject=["$q","$rootScope","$log","$http","$interval","videoService","errorHelperService","ConferenceSession","platformService","Conference","$translate","$injector"],angular.module("rainbow").service("webConferenceService",WebConferenceService)},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConferenceService=void 0;const conference_stats_model_1=__webpack_require__(392),rxjs_1=__webpack_require__(10),event_model_1=__webpack_require__(24),utilities_service_1=__webpack_require__(393),contact_service_1=__webpack_require__(1),auth_service_1=__webpack_require__(2),xmpp_service_1=__webpack_require__(4),profile_service_1=__webpack_require__(8),pgiConference_service_1=__webpack_require__(57),room_service_1=__webpack_require__(33),logger_service_1=__webpack_require__(15),errorHelper_service_1=__webpack_require__(39);class ConferenceService{constructor($q,$rootScope,$interval,$translate,$http,webConferenceService){this.$q=$q,this.$rootScope=$rootScope,this.$interval=$interval,this.$translate=$translate,this.$http=$http,this.webConferenceService=webConferenceService,this.MEDIATYPE={PSTNAUDIO:"pstnAudio",WEBRTC:"webrtc",WEBRTCSHARINGONLY:"webrtcSharingOnly"},this.started=!1,this.rxUpdateSubject=new rxjs_1.Subject,this.hasConferenceRights=!1,this.maxNumberOfUsersSFU=0,this.authService=auth_service_1.default,this.xmppService=xmpp_service_1.default,this.profileService=profile_service_1.default,this.contactService=contact_service_1.default,this.roomService=room_service_1.default,this.pgiConferenceService=pgiConference_service_1.default,this.utilitiesService=utilities_service_1.default,this.logger=logger_service_1.default,this.errorHelperService=errorHelper_service_1.default,this.listeners=[],this.conferenceRef=null}start(stats){return this.contactService.userContact&&!this.contactService.userContact.roomsEnabled?(this.logger.info("[ConferenceService] === start skipped - roomsEnabled : "+this.contactService.userContact.roomsEnabled),this.$q.when()):this.$q(resolve=>{let startDate=performance.now();return this.logger.info("[ConferenceService] === STARTING ==="),this.hasConferenceRights=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_ALLOWED),this.maxNumberOfUsersSFU=this.profileService.getFeatureLimitMax(this.profileService.FeaturesEnum.WEBRTC_CONFERENCE_PARTICIPANT_COUNT),this.maxNumberOfUsersSFU||(this.maxNumberOfUsersSFU=20),this.confProvPortalURL=config.restServerUrl+"/api/rainbow/confprovisioning/v1.0/",this.confPortalURL=config.restServerUrl+"/api/rainbow/conference/v1.0/conferences/",this.attachHandlers(),this.webConferenceService.retrieveWebConferences(this.MEDIATYPE.WEBRTC).then(()=>this.webConferenceService.retrieveWebConferences(this.MEDIATYPE.WEBRTCSHARINGONLY)).then(()=>this.makeSnapshots()).then(()=>{this.started=!0;let startDuration=Math.round(performance.now()-startDate);stats.push({service:"conferenceService",startDuration:startDuration}),this.logger.info("[ConferenceService] === STARTED ("+startDuration+" ms) ==="),resolve()}).catch(error=>{this.logger.info("[ConferenceService] === STARTING FAILURE === "+error.message),resolve()})})}stop(){return this.contactService.userContact&&!this.contactService.userContact.roomsEnabled?(this.logger.info("[ConferenceService] === stop skipped - roomsEnabled : "+this.contactService.userContact.roomsEnabled),this.$q.when()):this.$q(resolve=>{this.logger.info(""),this.logger.info("[ConferenceService] === STOPPING ==="),this.listeners&&this.listeners.forEach(listener=>{listener()}),this.started=!1,this.logger.info("[ConferenceService] === STOPPED ==="),resolve()})}attachHandlers(){this.logger.info("[ConferenceService] attachHandlers"),this.conferenceRef&&(this.xmppService.connection.deleteHandler(this.conferenceRef),this.conferenceRef=null),this.conferenceRef=this.xmppService.connection.addHandler(stanza=>this.onConferenceUpdate(stanza),"jabber:iq:conference","message",null)}reconnectService(){!this.contactService.userContact||this.contactService.userContact.roomsEnabled?(this.logger.info("[ConferenceService] reconnectService"),this.attachHandlers(),this.refreshConferenceSessions()):this.logger.info("[ConferenceService] === reconnectService skipped - roomsEnabled : "+this.contactService.userContact.roomsEnabled)}subscribe(eventType,callback){return"update"===eventType?this.rxUpdateSubject.subscribe(callback):null}getWebConferenceEndpoints(){return this.webConferenceService.conferenceEndpoints}makeSnapshotsForList(confEndpointsList){return this.$q(resolve=>{if(this.logger.info("[ConferenceService] makeSnapshotsForList"),!confEndpointsList||!confEndpointsList.length)return void resolve();let promiseArray=[];for(let i=0;i<confEndpointsList.length;i++)confEndpointsList[i].mediaType===this.MEDIATYPE.PSTNAUDIO?promiseArray.push(this.pgiConferenceService.makeSnapshotForConfId(confEndpointsList[i].confEndpointId)):promiseArray.push(this.webConferenceService.makeSnapshotForConfId(confEndpointsList[i].confEndpointId,confEndpointsList[i].mediaType));this.$q.all(promiseArray).finally(()=>{resolve(this.getConferenceSessionForRoom(confEndpointsList))})})}getConferenceSessionForRoom(roomConfEndpoints){let pstnSession=null,sfuSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].mediaType===this.MEDIATYPE.PSTNAUDIO?pstnSession=this.pgiConferenceService.getConferenceSessionById(roomConfEndpoints[i].confEndpointId):sfuSession=this.webConferenceService.conferenceSessions[roomConfEndpoints[i].confEndpointId];return pstnSession||sfuSession}getMatchingConferenceSession(roomConfEndpoints,id){let confSession=null;if(roomConfEndpoints&&roomConfEndpoints.length)for(let i=0;i<roomConfEndpoints.length;i++)roomConfEndpoints[i].confEndpointId===id&&(confSession=roomConfEndpoints[i].mediaType===this.MEDIATYPE.PSTNAUDIO?this.pgiConferenceService.getConferenceSessionById(id):this.webConferenceService.conferenceSessions[id]);return confSession}makeSnapshots(){return this.logger.info("[ConferenceService] makeSnapshots"),this.$q(resolve=>{let snapshotPromiseList=[];for(let property in this.webConferenceService.conferenceEndpoints)if(this.webConferenceService.conferenceEndpoints.hasOwnProperty(property)){let pontConf=this.webConferenceService.conferenceEndpoints[property];snapshotPromiseList.push(this.webConferenceService.makeSnapshotForConfId(pontConf.id,pontConf.mediaType))}this.$q.all(snapshotPromiseList).finally(()=>{this.logger.info("[ConferenceService] makeSnapshots done"),resolve()})})}onConferenceUpdate(stanza){this.logger.info("[ConferenceService] onConferenceUpdate message: "+stanza.innerHTML);let conferenceId=$(stanza).find("conference-id").text(),action=$(stanza).find("conference-info").length?$(stanza).find("conference-info").attr("action"):"",conferenceSession=this.webConferenceService.conferenceSessions[conferenceId];if("reject"===action){let rooms=this.roomService.findRoomsWithConfId(conferenceId);return rooms&&rooms.length&&this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",rooms[0]),!0}if("delegate"===action){let newConfId=$(stanza).find("new-conference-id").text();return this.webConferenceService.onConferenceDelegated(conferenceId,newConfId),!0}return conferenceSession?conferenceSession.haveJoined?this.updateConferenceSession(stanza,conferenceSession):(this.updateConferenceSessionActiveState(stanza,conferenceSession),this.checkIfUserHasJoinedConferenceFromOtherDevice(stanza,conferenceId,conferenceSession)):this.checkIfUserHasJoinedConferenceFromOtherDevice(stanza,conferenceId),!0}checkIfUserHasJoinedConferenceFromOtherDevice(stanza,conferenceId,conferenceSession=null){try{let participants=$(stanza).find("participants");conferenceSession&&(conferenceSession.joinedFromOtherDevice=!1),participants&&participants.length&&participants.find("participant").each((__index,participant)=>{if($(participant).find("jid-im").text()===this.contactService.userContact.jid){let rooms=this.roomService.findRoomsWithConfId(conferenceId);rooms&&rooms.length&&this.$rootScope.$broadcast("ON_CONFERENCE_ENDED_INVITATION",rooms[0]),conferenceSession&&(conferenceSession.joinedFromOtherDevice=!0)}})}catch(__error){return}}updateConferenceSession(stanza,conferenceSession){this.logger.info("[ConferenceService] updateConferenceSession");const stanzaElem=$(stanza),conferenceStateElem=stanzaElem.find("conference-state");if(conferenceStateElem.length){const isConferenceActive="true"===conferenceStateElem.find("active").text(),isTalkerActive="true"===conferenceStateElem.find("talker-active").text(),isRecordingStarted="true"===conferenceStateElem.find("recording-started").text(),isLock="true"===conferenceStateElem.find("lock").text();let lockedBy=conferenceStateElem.find("locked-by").text();lockedBy||(lockedBy=conferenceStateElem.find("unlocked-by").text());let reason="";!isConferenceActive&&conferenceStateElem.find("reason")&&(reason=conferenceStateElem.find("reason").text()),this.updateState(conferenceSession,isConferenceActive,isTalkerActive,isRecordingStarted,isLock,lockedBy,reason)}const talkersElem=stanzaElem.find("talkers");if(talkersElem.length){const talkers=[];talkersElem.find("participant-id").each((__index,talker)=>{let talkerParticipantId=$(talker).text();talkers.push(talkerParticipantId)});stanzaElem.find("conference-id").text();this.updateTalkers(conferenceSession,talkers)}let participantsElem=stanzaElem.find("participants");if(0===participantsElem.length&&(participantsElem=stanzaElem.find("updated-participants")),participantsElem.length||(participantsElem=stanzaElem.find("added-participants")),participantsElem.length){let participants=[];participantsElem.find("participant").each((__index,participant)=>{let participantElem=$(participant),participantId=participantElem.find("participant-id").text(),jid_im=participantElem.find("jid-im").text(),phoneNumber=participantElem.find("phone-number").text(),role=participantElem.find("role").text(),mute=participantElem.find("mute").text(),hold=participantElem.find("hold").text(),cnxState=participantElem.find("cnx-state").text(),delegateCapability=participantElem.find("delegate-capability").text();participants.push({participantId:participantId,jid_im:jid_im,phoneNumber:phoneNumber,participantRole:role,mute:"on"===mute,held:"on"===hold,participantState:cnxState,delegateCapability:"true"===delegateCapability})}),participants.length>0&&(conferenceSession.conferenceStats&&(conferenceSession.conferenceStats.isUpdate=!1),this.createOrUpdateParticipants(conferenceSession,participants))}let removedParticipantsElem=stanzaElem.find("removed-participants");if(removedParticipantsElem.length){let removedParticipants=[];if(removedParticipantsElem.find("participant-id").each((__index,removedParticipant)=>{let removedParticipantId=$(removedParticipant).text();removedParticipants.push(removedParticipantId)}),this.removeParticipants(conferenceSession,removedParticipants),conferenceSession.participants.length<=1){stanzaElem.find("conference-id").text();this.updateTalkers(conferenceSession,[])}conferenceSession.conferenceStats&&(conferenceSession.conferenceStats.isUpdate=!1)}let updatedPublishers=stanzaElem.find("added-publishers");updatedPublishers.length&&(updatedPublishers.find("publisher").each((__index,publisher)=>{let publisherElem=$(publisher),publisherId=publisherElem.find("publisher-id").text(),mediaType=publisherElem.find("media-type").text(),jid_im=publisherElem.find("jid-im").text(),simulcast="true"===publisherElem.find("simulcast").text();this.addPublisher(conferenceSession,publisherId,mediaType,jid_im,simulcast)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",conferenceSession));let removedPublishers=stanzaElem.find("removed-publishers");removedPublishers.length&&(removedPublishers.find("publisher").each((__index,publisher)=>{let publisherElem=$(publisher),publisherId=publisherElem.find("participant-id").text(),mediaType=publisherElem.find("media-type").text();for(let i=0;i<conferenceSession.publishers.length;i++){let pub=conferenceSession.publishers[i];if(pub.participantId===publisherId&&pub.mediaType===mediaType){conferenceSession.publishers.splice(i,1);break}}if("video"===mediaType&&this.webConferenceService.isAlreadySubscribedToPublisher(conferenceSession.id,publisherId)){this.logger.info("[ConferenceService] removed-publishers : subscribed to this publisher, so re-init the element");let element=this.webConferenceService.getRelatedElementToPublisher(conferenceSession.id,publisherId);element&&this.webConferenceService.reInitialiseVideoGalleryElementById(conferenceSession,element.id)}}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",conferenceSession));const publishers=stanzaElem.find("publishers");return publishers.length&&(publishers.find("publisher").each((__index,publisher)=>{const publisherElem=$(publisher),publisherId=publisherElem.find("publisher-id").text(),mediaType=publisherElem.find("media-type").text(),jidIm=publisherElem.find("jid-im").text(),simulcast="true"===publisherElem.find("simulcast").text();this.addPublisher(conferenceSession,publisherId,mediaType,jidIm,simulcast)}),this.$rootScope.$broadcast("ON_CONFERENCE_PUBLISHER_UPDATED",conferenceSession)),!0}updateConferenceSessionActiveState(stanza,conferenceSession){let conferenceStateElem=$(stanza).find("conference-state");if(conferenceStateElem.length){this.logger.info("[ConferenceService] updateConferenceSessionActiveState");let isConferenceActive="true"===conferenceStateElem.find("active").text(),isTalkerActive="true"===conferenceStateElem.find("talker-active").text(),isRecordingStarted="true"===conferenceStateElem.find("recording-started").text(),reason="";!isConferenceActive&&conferenceStateElem.find("reason")&&(reason=conferenceStateElem.find("reason").text()),this.updateState(conferenceSession,isConferenceActive,isTalkerActive,isRecordingStarted,null,null,reason)}}updateState(conferenceSession,isConferenceActive,isTalkerActive,isRecordingStarted,lock=!1,lockedBy="",reason=""){if(isConferenceActive||this.contactService.resetBusyState(),conferenceSession.active&&!isConferenceActive){if(this.contactService.userContact.guestMode&&conferenceSession.type!==this.MEDIATYPE.WEBRTCSHARINGONLY)this.$rootScope.$broadcast("ON_OPEN_POPUP","concludeInvitation");else{let rooms=this.roomService.findRoomsWithConfId(conferenceSession.id);if(rooms&&rooms.length&&!rooms[0].owner)switch(conferenceSession.type){case this.MEDIATYPE.WEBRTCSHARINGONLY:break;case this.MEDIATYPE.PSTNAUDIO:case this.MEDIATYPE.WEBRTC:default:if(conferenceSession.isParticipantConnectedByJid(this.contactService.userContact.dbId)){const displayName=_escape(rooms[0].ownerContact.displayName),roomName=_escape(rooms[0].name),message=this.$translate.instant("meetingEndBy",{owner:displayName,meeting:roomName});this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}}}conferenceSession.participants=[],conferenceSession.status="ended",reason&&"noOwnerFound"===reason&&this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"conference",popupBody:"autoDelegationNotPossible",okLabel:"ok"})}conferenceSession.updateStateFromData(isConferenceActive,isTalkerActive,isRecordingStarted,lock),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",conferenceSession),lockedBy&&this.$rootScope.$broadcast("ON_CONFERENCE_LOCKED_EVENT",lock,lockedBy),isConferenceActive||this.$rootScope.$broadcast("ON_CONVERSATIONS_UPDATED_EVENT")}updateTalkers(conferenceSession,talkers){conferenceSession.updateTalkers(talkers),this.$rootScope.$broadcast("ON_CONFERENCE_TALKER_EVENT",conferenceSession)}getServerConferenceStats(sessionId){return __awaiter(this,void 0,void 0,(function*(){try{const url=`${config.restServerUrl}/api/rainbow/conference/v1.0/conferences/${sessionId}/talkingtime`,headers=this.authService.getRequestHeader(),response=yield fetch(url,{method:"GET",headers:headers});if(!response.ok)throw response;const responseData=yield response.json();if(0===responseData.data.participants.length)return null;const stats=new conference_stats_model_1.ConferenceStats;if(yield this.utilitiesService.asyncForEach(responseData.data.participants,participant=>__awaiter(this,void 0,void 0,(function*(){if(participant.talkingTime>0){const statsParticipant=new conference_stats_model_1.ConferenceStatsParticipant(participant.userId);statsParticipant.contact=yield this.contactService.getContactByDBId(participant.userId),statsParticipant.talkDuration=1e3*participant.talkingTime,stats.participants.push(statsParticipant),stats.talkDuration+=statsParticipant.talkDuration}}))),stats.participants=stats.participants.sort((p1,p2)=>p2.talkDuration-p1.talkDuration),stats.participants.length>0){const maxPartTalkDuration=stats.participants[0].talkDuration;stats.participants.forEach(participant=>{participant.talkDisplay=Math.trunc(100*participant.talkDuration/maxPartTalkDuration)})}return stats}catch(error){const errorInfo=yield this.errorHelperService.getErrorInfo(error,"getServerConferenceStats");throw this.logger.error("[ConferenceService] "+errorInfo.message),errorInfo.error}}))}createOrUpdateParticipants(conferenceSession,participants){conferenceSession.updateParticipants(participants).then(newParticipant=>{if(conferenceSession.participants.find(participant=>participant.jid_im===this.contactService.userContact.id&&"disconnected"!==participant.state)&&conferenceSession.type===this.MEDIATYPE.WEBRTC){var state=conferenceSession.hasLocalSharing?"sharing":"audio";this.contactService.setBusyState("dnd",state)}this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession),"webrtc"===conferenceSession.type&&newParticipant&&this.$rootScope.$broadcast("ON_WEB_CONFENRECE_PARTICIPANT_JOINED_EVENT",conferenceSession,newParticipant)})}removeParticipants(conferenceSession,removedParticipants){if(conferenceSession.removeParticipants(removedParticipants),!conferenceSession.participants.find(participant=>participant.jid_im===this.contactService.userContact.id))switch(this.contactService.resetBusyState(),conferenceSession.type){case this.MEDIATYPE.WEBRTC:if(this.webConferenceService.removeAllJingleSessionsForConferenceSession(conferenceSession.id),conferenceSession.active){let room=this.roomService.findRoomsWithConfId(conferenceSession.id);if(room.length&&!this.webConferenceService.isMyConference(conferenceSession.id)){let name=_escape(room[0].name),message=this.$translate.instant("meetingDisconnect",{meeting:name});this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}}conferenceSession.cleanupSessionData(),this.$rootScope.$broadcast("ON_CONFERENCE_UPDATED_EVENT",conferenceSession);break;case this.MEDIATYPE.WEBRTCSHARINGONLY:this.webConferenceService.removeAllJingleSessionsForConferenceSession(conferenceSession.id),conferenceSession.cleanupSessionData()}this.$rootScope.$broadcast("ON_CONFERENCE_PARTICIPANT_EVENT",conferenceSession)}addPublisher(conferenceSession,publisherId,mediaType,jid,simulcast=!1){let toAdd=!0;for(let i=0;i<conferenceSession.publishers.length;i++){let pub=conferenceSession.publishers[i];if(pub.participantId===publisherId&&pub.mediaType===mediaType){toAdd=!1;break}}let publisher={participantId:publisherId,mediaType:mediaType,jid_im:jid,simulcast:simulcast};if(toAdd&&conferenceSession.publishers.push(publisher),toAdd&&"video"===mediaType){let element=this.webConferenceService.getFreeVideoGalleryElement(conferenceSession.id),firstVideo=!1;this.webConferenceService.isActiveSpeakerEnabled()&&element&&"videoGallery_0"===element.id&&(firstVideo=!0),element&&!this.webConferenceService.isAlreadySubscribedToPublisher(conferenceSession.id,publisher.participantId)&&(this.logger.info("[ConferenceService] will subscribe to publisher "+conferenceSession.id+" for id "+publisherId+"and element id "+element.id+" in few moments"),element.state="busy",element.publisherId=publisher.participantId,this.$interval((confSession,newPublisher,elemToSubscribe,isFirstVideo)=>{if("busy"===elemToSubscribe.state&&elemToSubscribe.publisherId===newPublisher.participantId){this.logger.info("[ConferenceService] subscribe to publisher "+confSession.id+" for id "+newPublisher.participantId+"and element id "+elemToSubscribe.id);let subStreamLevel=null;newPublisher.simulcast&&(isFirstVideo?(subStreamLevel="2",elemToSubscribe.publisherId=""):subStreamLevel="0"),isFirstVideo?this.webConferenceService.subscribeToDynamicFeed(confSession.id,newPublisher,elemToSubscribe.id,subStreamLevel,isFirstVideo).catch(()=>{this.logger.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+elemToSubscribe.id),this.webConferenceService.reInitialiseVideoGalleryElementById(confSession,elemToSubscribe.id)}):this.webConferenceService.subscribeToPublisher(confSession.id,newPublisher,elemToSubscribe.id,subStreamLevel,isFirstVideo).catch(()=>{this.logger.error("[ConferenceService] subscribe to publisher failed, reset the video gallery element with id "+elemToSubscribe.id),this.webConferenceService.reInitialiseVideoGalleryElementById(confSession,elemToSubscribe.id)})}},1500,1,!0,conferenceSession,publisher,element,firstVideo))}}stopConference(confId="",type=this.MEDIATYPE.WEBRTC,roomId=""){if(this.logger.info("[ConferenceService] stopConference( confId="+confId+", type="+type+")"),!confId||!roomId&&type!==this.MEDIATYPE.PSTNAUDIO)return this.logger.warn("[ConferenceService] stopConference missing conf ID or roomID"),this.$q.reject();let conferenceSession=this.webConferenceService.conferenceSessions[confId];return conferenceSession&&conferenceSession.isActive()?this.$q((resolve,reject)=>{this.$http({method:"PUT",url:this.confPortalURL+confId+"/stop",headers:this.authService.getPostHeader(),data:{mediaType:type,roomId:roomId}}).then(()=>{this.contactService.resetBusyState();let session=this.webConferenceService.conferenceSessions[confId];session&&(this.updateState(session,!1,!1,!1),session.cleanupSessionData(),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",session)),this.logger.info("[ConferenceService] stopConference( confId="+confId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="stopConference( confId="+confId+") failure: "+msg;if(this.logger.error("[ConferenceService] "+errorMessage),404e3!==response.data.errorDetailsCode)this.$rootScope.$broadcast("ON_OPEN_GLOBAL_POPUP",{popupTitle:"warning",popupBody:"stopMeetingFailure",okLabel:"ok"});else{let session=this.webConferenceService.conferenceSessions[confId];session&&(session.active=!1,session.participants=[],this.removeConferenceSession(session),this.$rootScope.$broadcast("ON_CONFERENCE_STATE_EVENT",session))}reject(new Error(errorMessage))})}):(this.logger.warn("[ConferenceService] stopConference - no active conference session to stop"),this.$q.reject())}removeConferenceSession(conferenceSession=null){conferenceSession&&(conferenceSession.type===this.MEDIATYPE.WEBRTC||conferenceSession.type===this.MEDIATYPE.WEBRTCSHARINGONLY?(this.webConferenceService.leaveWebConference(conferenceSession.id),this.webConferenceService.removeConferenceSession(conferenceSession.id)):this.pgiConferenceService.removeConferenceSession(conferenceSession.id))}disconnectsParticipant(confId,participantId,mediaType=this.MEDIATYPE.PSTNAUDIO){return confId&&participantId?this.$q((resolve,reject)=>{this.logger.info("[ConferenceService] disconnectsParticipant( confId="+confId+"participantId="+participantId+")"),this.$http({method:"DELETE",url:this.confPortalURL+confId+"/participants/"+participantId+"?mediaType="+mediaType,headers:this.authService.getRequestHeader()}).then(()=>{this.logger.info("[ConferenceService] disconnectsParticipant( confId="+confId+"participantId="+participantId+") successfully"),resolve()},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="disconnectsParticipant( confId="+confId+"participantId="+participantId+") failure: "+msg;this.logger.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.logger.warn("[ConferenceService] disconnectsParticipant missing conf ID or participantId"),this.$q.reject())}updateConference(confEndpointId,confData,mediaType=this.MEDIATYPE.PSTNAUDIO){return mediaType===this.MEDIATYPE.PSTNAUDIO?this.pgiConferenceService.updateConference(confEndpointId,confData):this.webConferenceService.updateConference(confEndpointId,confData)}updateConferenceState(confId,option,mediaType=this.MEDIATYPE.PSTNAUDIO){return this.logger.info("[ConferenceService] updateConferenceState( confId="+confId+", option="+option+" mediaType="+mediaType+")"),confId&&option?this.$q((resolve,reject)=>{let conferenceSession=null;if(conferenceSession=mediaType===this.MEDIATYPE.PSTNAUDIO?this.pgiConferenceService.getConferenceSessionById(confId):this.webConferenceService.conferenceSessions[confId],!conferenceSession)return this.logger.error("[ConferenceService] updateConferenceState - no corresponding conference session to update"),void reject();this.$http({method:"PUT",url:this.confPortalURL+confId+"/update",headers:this.authService.getRequestHeader(),data:{option:option,mediaType:conferenceSession.type}}).then(response=>{let conferenceData=response.data.data;this.logger.info("[ConferenceService] updateConferenceState( confId="+confId+") successfully"),resolve(conferenceData)},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="updatsConferenceState( confId="+confId+") failure: "+msg;this.logger.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.logger.error("[ConferenceService] updateConferenceState - missing a parameter"),this.$q.reject())}updateParticipantState(confId,participantId,option,mediaType=this.MEDIATYPE.PSTNAUDIO,media=null,bitRate=null,subStreamLevel=null,publisherId=null){return this.logger.info("[ConferenceService] updateParticipantState( confId="+confId+"participantId="+participantId+" option="+option+" mediaType="+mediaType+")"),confId&&participantId&&option?this.$q((resolve,reject)=>{let conferenceSession=null;if(conferenceSession=mediaType===this.MEDIATYPE.PSTNAUDIO?this.pgiConferenceService.getConferenceSessionById(confId):this.webConferenceService.conferenceSessions[confId],!conferenceSession)return this.logger.error("[ConferenceService] updateParticipantState - no corresponding conference session to update"),void reject();let data={option:option,mediaType:conferenceSession.type};media&&(data.media=media),bitRate&&(data.bitRate=bitRate),publisherId&&(data.publisherId=publisherId),subStreamLevel&&(data.subStreamLevel=subStreamLevel),this.$http({method:"PUT",url:this.confPortalURL+confId+"/participants/"+participantId,headers:this.authService.getRequestHeader(),data:data}).then(response=>{let status=response.data;this.logger.info("[ConferenceService] updateParticipantState( confId="+confId+"participantId="+participantId+") successfully"),resolve(status)},response=>{let msg=response.data?response.data.errorDetails:response.data,errorMessage="updateParticipantState( confId="+confId+"participantId="+participantId+") failure: "+msg;this.logger.error("[ConferenceService] "+errorMessage),reject(new Error(errorMessage))})}):(this.logger.error("[ConferenceService] updateParticipantState - missing a parameter"),this.$q.reject())}isUserContactInCall(){for(let property in this.webConferenceService.conferenceSessions)if(this.webConferenceService.conferenceSessions.hasOwnProperty(property)){if(this.webConferenceService.conferenceSessions[property].isParticipantConnectedByJid(this.contactService.userContact.jid))return!0}return!1}refreshConferenceSessions(){let promoseArray=[];return promoseArray.push(this.webConferenceService.refreshConferenceSessions()),this.$q.all(promoseArray)}computeJoinStartForSFUConference(conversation,confSession=null){let result={showStartButton:!1,showJoinButton:!1,isActionDisabled:!1,startOrJoinTooltip:""},me=conversation.room.getUserByJid(this.contactService.userContact.jid);if(me&&"unsubscribed"===me.status)return this.rxUpdateSubject.next(new event_model_1.RBEvent("CONFERENCE_BUTTON_STATUS",result)),result;if(!conversation.room.isMeetingRoom()&&!this.contactService.userContact.webrtcAudioEnabled)return result.showStartButton=!1,result.showJoinButton=!1,result;let conferenceSession=confSession||this.webConferenceService.getConferenceSessionForRoom(conversation.room.confEndpoints);if(conferenceSession&&conferenceSession.status&&"ended"!==conferenceSession.status)result.showStartButton=!1,result.showJoinButton=!1;else if(conferenceSession&&conferenceSession.isActive()&&!conferenceSession.haveJoined)result.showStartButton=!1,result.showJoinButton=!0;else if(conversation.room.isUserModerator(this.contactService.userContact)){if(result.showStartButton=!0,!this.hasConferenceRights)return result.isActionDisabled=!0,result.startOrJoinTooltip="startConferenceNoRights",this.rxUpdateSubject.next(new event_model_1.RBEvent("CONFERENCE_BUTTON_STATUS",result)),result;let filteredUsers=conversation.room.users.filter(user=>user.contact&&user.contact.initialized&&!user.contact.isAnonymousGuest()&&!user.contact.isBadGuest()&&!user.contact.isTerminated&&("invited"===user.status||"accepted"===user.status)),guestsUsersLength=0;return conversation.room.guestEmails&&(guestsUsersLength=conversation.room.guestEmails.length),filteredUsers.length+guestsUsersLength>this.maxNumberOfUsersSFU?(result.isActionDisabled=!0,result.startOrJoinTooltip=this.$translate.instant("disabledStartConference",{number:this.maxNumberOfUsersSFU}),this.rxUpdateSubject.next(new event_model_1.RBEvent("CONFERENCE_BUTTON_STATUS",result)),result):(result.isActionDisabled=!1,result.startOrJoinTooltip="startConference",this.rxUpdateSubject.next(new event_model_1.RBEvent("CONFERENCE_BUTTON_STATUS",result)),result)}return this.rxUpdateSubject.next(new event_model_1.RBEvent("CONFERENCE_BUTTON_STATUS",result)),result}}exports.ConferenceService=ConferenceService,ConferenceService.$inject=["$q","$rootScope","$interval","$translate","$http","webConferenceService"],angular.module("rainbow").service("conferenceService",ConferenceService)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ConferenceStatsParticipant=exports.ConferenceStats=void 0;exports.ConferenceStats=class{constructor(){this.participants=[],this.talkDuration=0}};exports.ConferenceStatsParticipant=class{constructor(talkerId){this.talkerId=null,this.contact=null,this.talkDuration=0,this.activeSince=null,this.talkDisplay=0,this.talkerId=talkerId}}},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.UtilitiesService=void 0;class UtilitiesService{constructor(){this.rtlDirCheck=new RegExp("^[^---]*?[---]")}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.utilitiesService||(win.rainbow.utilitiesService=new UtilitiesService),win.rainbow.utilitiesService}emojiShortnameToImage(text,link=!0){let raw=text,html="";if(link){const LINKY_URL_REGEXP=/((ftp|https?):\/\/|(mailto:)?[A-Za-z0-9._%+-]+@)\S*[^\s.;,(){}<>]/,MEET_URL_FORMAT=(config.webservices.protocol+"://meet."+config.webservices.server).replace(".red",".com")+"/",MAILTO_REGEXP=/^mailto:/;let match=null;for(;match=raw.match(LINKY_URL_REGEXP);){let url=match[0];match[2]===match[3]&&(url="mailto:"+url);const nolinkText=emojione.shortnameToImage(raw.substr(0,match.index));url.match(MEET_URL_FORMAT)?html+=`${nolinkText}<span class="publiclink" >${match[0].replace(MAILTO_REGEXP,"")}</span>`:html+=`${nolinkText}<a target="_blank" href="${url}">${match[0].replace(MAILTO_REGEXP,"")}</a>`,raw=raw.substring(match.index+match[0].length)}}return html+=emojione.shortnameToImage(raw),html}asyncForEach(array,callback){return __awaiter(this,void 0,void 0,(function*(){for(let i=0;i<array.length;i++)yield callback(array[i],i,array)}))}isRTL(str){return this.rtlDirCheck.test(str.charAt(0))}}exports.UtilitiesService=UtilitiesService,exports.default=UtilitiesService.getInstance()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var rxjs__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(23),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(4),_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3__),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(8),_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4__);function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}angular.module("rainbow").service("calendarService",["$q","$rootScope","$log","$http","$interval","contactService","errorHelperService","conversationService",function($q,$rootScope,$log,$http,$interval,contactService,errorHelperService,conversationService){var that=this;this.intervalID=null,this.subscriptions=[],this.start=function(stats){$log.info(""),$log.info("[calendarService] === STARTING ===");var startDate=performance.now();that.eventSubject=new rxjs__WEBPACK_IMPORTED_MODULE_0__.a,that.serviceActivated=!1,that.serviceState=null,that.calendarState=null,that.autorizationLink="",that.calendaRejectIfBusyActivated=!1,$log.info("[calendarService] listen 'out of office' status for roster contacts"),$interval(that.getAutoReplyForEachContact,15e3,1),that.intervalID=$interval(that.updateAutoReplyForEachContact,9e5),that.officeCalendarPresenceEnabled=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4___default.a.FeaturesEnum.MSO365_CALENDAR_PRESENCE),that.googleCalendarPresenceEnabled=_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4___default.a.isFeatureEnabled(_src_services_core_profile_service__WEBPACK_IMPORTED_MODULE_4___default.a.FeaturesEnum.GOOGLE_CALENDAR_PRESENCE),that.calendarPresenceEnabled=that.officeCalendarPresenceEnabled||that.googleCalendarPresenceEnabled,$log.info("[calendarService] calendar presence status from profileService : "+that.calendarPresenceEnabled),that.disableCalendarPresencePrompt="true"===_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_1___default.a.getSetting("disableCalendarPresence"),$log.info("[calendarService] calendar presence prompt status from userSettings : "+!that.disableCalendarPresencePrompt);var startDuration=Math.round(performance.now()-startDate);return stats.push({service:"calendarService",startDuration:startDuration}),$log.info("[calendarService] === STARTED ("+startDuration+" ms) ==="),that.calendarPresenceEnabled&&!contactService.userContact.guestMode&&(that.attachHandlers(),that.xmppConnectionSubscription=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3___default.a.subscribeToConnectionEvents((function(event){that.onConnectionStateChange(event)})),that.subscriptions.push(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3___default.a.subscribeToContactEvents((function(event){"ON_CONTACT_PRESENCE_EVENT"===event.name&&that.onCalendarPresenceChange(event.data)}))),that.getCalendarState().then((function(){"enabled"===that.serviceState&&that.handleEnableState()})).catch((function(error){that.serviceActivated=!1,that.serviceState="failed",$log.error("[calendarService] === STARTING FAILURE === "+error.message)}))),$q.when()},this.attachHandlers=function(){$log.info("[calendarService] attachHandlers"),that.messageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3___default.a.deleteHandler(that.messageHandlerRef),that.messageHandlerRef=null),that.messageHandlerRef=_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3___default.a.addHandler((function(stanza){return that.onUpdateMessageReceived(stanza),!0}),"jabber:iq:configuration","message",null)},this.stop=function(){return $log.info("[calendarService] === STOPPING ==="),that.serviceActivated=!1,that.subscriptions&&that.subscriptions.forEach((function(subscription){subscription.unsubscribe()})),that.xmppConnectionSubscription&&that.xmppConnectionSubscription.unsubscribe(),that.messageHandlerRef&&(_src_services_core_xmpp_service__WEBPACK_IMPORTED_MODULE_3___default.a.deleteHandler(that.messageHandlerRef),that.messageHandlerRef=null),that.intervalID&&$interval.cancel(that.intervalID),$log.info("[calendarService] === STOPPED ==="),$q.when()},this.onConnectionStateChange=function(event){"ON_XMPP_CONNECTED"===event.name&&($log.info("[calendarService] onConnectionStateChange state:"+event.name),that.getCalendarState().then((function(){"enabled"===that.serviceState&&that.handleEnableState(),"consent_required"===that.serviceState&&that.handleConsentRequiredState()})).catch((function(error){that.serviceActivated=!1,that.serviceState="failed",$log.error("[calendarService] === FAILURE === "+error.message)})))},this.handleEnableState=function(){var date=this.calendarState.until?new Date(this.calendarState.until):null,status=this.calendarState.busy?"dnd":"online",message=this.calendarState.busy?"busy":"";that.updateCalendarPresenceForUser(contactService.userContact.jid,status,date,message)},this.handleConsentRequiredState=_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var registrationParams;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,that.getRegistrationParams(!1);case 2:registrationParams=_context.sent,$rootScope.$broadcast("ON_OPEN_CALENDARSELECTION_POPUP",registrationParams);case 4:case"end":return _context.stop()}}),_callee)}))),this.onUpdateMessageReceived=function(stanza){var info=$(stanza).find("calendar");return info.length&&(that.serviceState=info.attr("status"),that.serviceActivated="enabled"===that.serviceState,that.eventSubject.next({action:"ON_CALENDAR_STATUS_CHANGE",data:that.serviceActivated}),$log.info("[calendarService] onUpdateMessageReceived with state : "+that.serviceState),"consent_required"===that.serviceState&&that.handleConsentRequiredState()),!0},this.onCalendarPresenceChange=function(attr){if(contactService.isTelJid(attr.jid)&&"calendar"===contactService.getResourceFromJid(attr.jid)){var jid_im=contactService.getImJid(attr.jid);jid_im&&($log.info("[calendarService] onCalendarPresenceChange -- status: "+attr.status+" -- until: "+attr.until+" -- message: "+attr.message),that.updateCalendarPresenceForUser(jid_im,attr.status,attr.until,attr.message))}},this.updateAutoReplyForEachContact=function(){that.getAutoReplyInfoForContact(contactService.userContact),that.getAutoReplyForEachContact()},this.getAutoReplyForEachContact=function(){$log.info("[calendarService] getAutoReplyForEachContact"),conversationService.getConversations().forEach((function(conversation){null!==conversation.contact&&that.getAutoReplyInfoForContact(conversation.contact)}))},this.getAutoReplyInfoForContact=function(contact){return $q((function(resolve,reject){if(!contact.calendarState.status)return $log.info("[calendarService] getAutoReplyInfoForContact user has no calendar state"),void resolve();if(contact.calendarState.lastUpdate){var duration=moment.duration(contact.calendarState.lastUpdate.diff(moment()));if(Math.abs(Math.floor(duration.asMinutes()))<15)return $log.info("[calendarService] getAutoReplyInfoForContact state has been updated in the last 15min"),void resolve()}contact.calendarState.lastUpdate=moment(),$http({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/automatic_reply?userid="+contact.dbId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2___default.a.getRequestHeader()}).then((function(response){that.treatOutOfOfficeState(response.data,contact),$log.info("[calendarService] getAutoReplyInfoForContact success for contact "+contact.dbId),resolve()}),(function(response){var err=errorHelperService.handleError(response);$log.error("[calendarService] "+errorHelperService.getErrorFullMessage(response,"getAutoReplyInfoForContact")),reject(err)}))}))},this.getCalendarState=function(){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2___default.a.getRequestHeader()}).then((function(response){var successMessage="[calendarService] getCalendarState success -- ",calendarInfo=response.data;"busy"===calendarInfo.status||"free"===calendarInfo.status||"out_of_office"===calendarInfo.status?(that.serviceState="enabled",that.calendarState=calendarInfo,successMessage+=that.serviceState+" "+that.calendarState.status):(that.serviceState=calendarInfo.status,that.calendarState=null,successMessage+=that.serviceState),$log.info(successMessage),resolve(response.data)}),(function(){$log.error("[calendarService] getCalendarState failure -- CalendarService portal not responding"),reject()}))}))},this.getRegistrationParams=function(fromSettings){return $q((function(resolve){$log.info("[calendarService] getRegistrationParams");var promiseArray=[];that.officeCalendarPresenceEnabled&&promiseArray.push(that.getCalendarRegistrationInfo("office365")),that.googleCalendarPresenceEnabled&&promiseArray.push(that.getCalendarRegistrationInfo("googleCalendar")),$q.all(promiseArray).finally((function(){that.autorizationGoogleLink||that.autorizationMicrosoftLink?($log.info("[calendarService] getRegistrationParams -- show registration popup or tooltip"),resolve({authentMicrosoftUrl:that.autorizationMicrosoftLink,authentGoogleUrl:that.autorizationGoogleLink,fromSettings:fromSettings})):($log.error("[calendarService] getRegistrationParams -- no calendar provider response"),resolve())}))}))},this.getCalendarRegistrationInfo=function(type){var calendarRedirect="o365",calendarType="office365";return"googleCalendar"===type&&(calendarRedirect="gcal",calendarType="google"),$q((function(resolve,reject){var lang=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_1___default.a.getAppliLanguage().code;$http({method:"POST",url:config.restServerUrl+"/api/rainbow/calendar/v1.0/register",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2___default.a.getRequestHeader(),data:{type:calendarType,callback:window.location.origin+"/redirectO365.html?provider="+calendarRedirect+"&lang="+lang}}).then((function(response){$log.info("[calendarService] getCalendarRegistrationInfo for "+type+" -- success"),that.autorizationLink=response.data.url,"googleCalendar"===type?that.autorizationGoogleLink=that.autorizationLink:that.autorizationMicrosoftLink=that.autorizationLink,resolve(that.autorizationLink)}),(function(response){$log.error("[calendarService] getCalendarRegistrationInfo failure"),$log.error(response),reject()}))}))},this.deactivateCalendar=function(){return $log.info("[calendarService] deactivateCalendar"),$q((function(resolve,reject){$http({method:"DELETE",url:config.restServerUrl+"/api/rainbow/calendar/v1.0",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_2___default.a.getRequestHeader()}).then((function(){$log.info("[calendarService] deactivateCalendar success"),that.serviceActivated=!1,that.eventSubject.next({action:"ON_CALENDAR_STATUS_CHANGE",data:that.serviceActivated}),resolve()}),(function(response){$log.error("[calendarService] deactivateCalendar failure"),$log.error(response),reject()}))}))},this.updateCalendarPresenceForUser=function(jid,status,date,message){contactService.getOrCreateContact(jid).then((function(contact){contact.calendarState.status=status,contact.calendarState.message=message;var mdate=null;"online"===status||date||(date=new Date),date&&(mdate=moment(date)),contact.calendarState.mdate=mdate,mdate?mdate.isSame(moment(),"d")?(contact.calendarState.until=mdate.format("LT"),contact.calendarState.untilDate=!1):(contact.calendarState.until=mdate.format("ll"),contact.calendarState.untilDate=!0):(date||(date=new Date),contact.calendarState.until=date,contact.calendarState.untilDate=!1),contactService.isUserContact(contact)?($log.info("[calendarService] updateCalendarPresenceForUser for my user : "+status+" until "+date),that.serviceActivated||"offline"===status||(that.serviceActivated=!0,that.eventSubject.next({action:"ON_CALENDAR_STATUS_CHANGE",data:that.serviceActivated})),that.getAutoReplyInfoForContact(contactService.userContact)):$log.info("[calendarService] updateCalendarPresenceForUser for user : "+jid+" with : "+status+" until "+date),$rootScope.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",contact)})).catch((function(error){$log.error("[calendarService] updateCalendarPresenceForUser failure for user "+jid+" with error : "+error)}))},this.treatOutOfOfficeState=function(data,contact){if($log.info("[calendarService] treatOutOfOfficeState for user : "+contact.jid+" with data enabled "+data.enabled+" and date end "+data.end),data.enabled){if(contact.calendarState.autoReplyOn=!0,contact.calendarState.autoReplyInfos={},data.message_text&&(contact.calendarState.autoReplyInfos.message=data.message_text),data.end){var mdate=moment(data.end);contact.calendarState.autoReplyInfos.mdate=mdate,mdate?mdate.isSame(moment(),"d")?(contact.calendarState.autoReplyInfos.until=mdate.format("LT"),contact.calendarState.autoReplyInfos.untilDate=!1):(contact.calendarState.autoReplyInfos.until=mdate.format("ll"),contact.calendarState.autoReplyInfos.untilDate=!0):(contact.calendarState.autoReplyInfos.until=data.end,contact.calendarState.autoReplyInfos.untilDate=!0)}}else contact.calendarState.autoReplyOn=!1,contact.calendarState.autoReplyInfos={};$rootScope.$broadcast("ON_CONTACT_CALENDAR_STATUS_CHANGE",contact),that.eventSubject.next({action:"ON_CALENDAR_STATUS_CHANGE",data:that.serviceActivated})},this.calendarCancelCallback=function(){that.serviceActivated=!1,_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_1___default.a.setSetting("disableCalendarPresence",!0),contactService.setUserSettings({promptForCalendarPresence:!1}),that.eventSubject.next({action:"ON_CALENDAR_STATUS_CHANGE",data:that.serviceActivated})},this.calendarLaterCallback=function(){that.serviceActivated=!1,that.eventSubject.next({action:"ON_CALENDAR_STATUS_CHANGE",data:!1})},this.setCalendarRejectIfBusy=function(state){that.calendaRejectIfBusyActivated=!1},this.getCalendarRejectIfBusy=function(){return that.calendaRejectIfBusyActivated}}])},function(module,exports,__webpack_require__){"use strict";(function(Buffer){var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CallAreaRecordContext=void 0;const ts_ebml_1=__webpack_require__(396),call_model_1=__webpack_require__(0),moment=__webpack_require__(3),rxjs_1=__webpack_require__(10),xmpp_service_1=__webpack_require__(4),fileStorage_service_1=__webpack_require__(25);class CallAreaRecordContext{constructor(callType,recordingFeature){this.callType="",this.recordingFeature=!1,this.conversation=null,this.webrtcCallRef=null,this.isRecorded=!1,this.displayRecordTime=null,this.pauseRecord=null,this.recorder=null,this.updateTimer=null,this.actualRecordTime=0,this.durationTimer=null,this.callType=callType,this.recordingFeature=recordingFeature}static create(callType,recordingFeature){return new CallAreaRecordContext(callType,recordingFeature)}getWebrtcCallRef(){return this.webrtcCallRef}setWebrtcCallRef(webrtcCallRef){this.webrtcCallRef=webrtcCallRef}getConversation(){return this.conversation}setConversation(conversation){this.conversation=conversation}}exports.CallAreaRecordContext=CallAreaRecordContext;class RecordsService{constructor($q,$rootScope,$log,fileServerService,centralizedService,ringingService,conversationService,$interval,$translate,$window){this.$q=$q,this.$rootScope=$rootScope,this.$log=$log,this.fileServerService=fileServerService,this.centralizedService=centralizedService,this.ringingService=ringingService,this.conversationService=conversationService,this.$interval=$interval,this.$translate=$translate,this.$window=$window,this.started=!1,this.recording=!1,this.upload=!1,this.filename="",this.recordStopOrigin="LOCAL",this.xmppService=xmpp_service_1.default,this.fileStorageService=fileStorage_service_1.default,this.durationTimer=null,this.metadataBuf=new ArrayBuffer(0),this.last_duration=0,this.clusterPtrs=[],this.recordedStartedEvent=null,this.conversationEndedEvent=null,this.tempUploadedFileDescriptor=null}start(){return this.started=!1,this.recording=!1,this.recorder=null,this.chunk=null,this.writeStream=null,this.data=new Blob([],{type:"video/webm"}),this.audioContext=null,this.recordFile=null,this.decoder=new ts_ebml_1.Decoder,this.initConversationRecordContext(),this.recordedStartedEvent&&this.recordedStartedEvent(),this.conversationEndedEvent&&this.conversationEndedEvent(),this.recordedStartedEvent=this.$rootScope.$on("ON_RECORDING_START_MSG_RECEIVED",()=>{this.ringingService.playRecordTone()}),this.conversationEndedEvent=this.$rootScope.$on("ON_CONVERSATION_CALL_UPDATED_EVENT",(evt,conversationCallEvent)=>{this.conversationRecordContext&&conversationCallEvent.conversation&&this.conversationRecordContext.conversationId===conversationCallEvent.conversation.id&&conversationCallEvent.conversation.videoCall&&"Unknown"===conversationCallEvent.conversation.videoCall.status.value&&(this.setRecordStopOrigin("LOCAL"),this.stopRecording(),this.conversationService.sendRecordingMessage(conversationCallEvent.conversation,"stop"))}),this.$log.info("[RecordsService] start"),this.$q.when()}stop(){return this.$log.info("[RecordsService stop"),this.started&&(this.started=!1),this.recordedStartedEvent&&this.recordedStartedEvent(),this.conversationEndedEvent&&this.conversationEndedEvent(),this.$q.when()}onDataAvailable(event){return __awaiter(this,void 0,void 0,(function*(){if(this.$log.info("[RecordsService] >onDataAvailable: size = "+event.data.size),event.data.size>0){if(this.chunk=event.data,this.writeStream){this.writeStream.on("finish",()=>{this.$log.info("[RecordsService] WriteStream finish event")});const chunkArrayBuffer=yield this.chunk.arrayBuffer(),chunkBuffer=Buffer.from(chunkArrayBuffer),result=this.writeStream.write(chunkBuffer);this.writeStream.end(),this.$log.info("[RecordsService] write result = "+result)}this.data=new Blob([this.data,this.chunk],{type:this.chunk.type}),this.chunk=null}}))}canRecord(){try{return!!MediaRecorder}catch(e){return!1}}onStop(){return __awaiter(this,void 0,void 0,(function*(){this.durationTimer=rxjs_1.interval(1e3).subscribe(()=>__awaiter(this,void 0,void 0,(function*(){if(this.$log.info("[RecordsService] On stop recording"),this.durationTimer.unsubscribe(),this.durationTimer=null,this.data&&this.data.size>1e7){const message=this.$translate.instant("recordingInProgress");this.$rootScope.$broadcast("GLOBAL_NOTIFY_MESSAGE_EVENT",message)}if(this.writeStream)this.durationTimer=rxjs_1.interval(3e3).subscribe(()=>__awaiter(this,void 0,void 0,(function*(){this.$log.info("[RecordsService] Destroy WriteStream"),this.writeStream.destroy(),this.writeStream=null,this.durationTimer.unsubscribe(),this.durationTimer=null,this.updatedBlob=yield this.injectMetadata(this.data),this.onStopCreateFileFromBlob(this.updatedBlob)})));else if(navigator.mediaDevices.getUserMedia&&this.$window.mozRTCPeerConnection)this.onStopCreateFileFromBlob(this.data);else if(navigator.mediaDevices.getUserMedia&&this.$window.webkitRTCPeerConnection){this.$log.info("[RecordsService] On stop recording for Chrome with size "+this.data.size),this.recordFile={name:this.filename,extension:"mp4",size:this.data.size};try{this.tempUploadedFileDescriptor=yield this.createBackupFile(),this.$log.info("[RecordsService] backup created"),this.updatedBlob=yield this.injectMetadata(this.data),this.onStopCreateFileFromBlob(this.updatedBlob)}catch(_err){this.updatedBlob=yield this.injectMetadata(this.data),this.onStopCreateFileFromBlob(this.updatedBlob)}}})))}))}onCreateFileFromBlobForSafari(blob){this.updatedBlob=blob,this.$log.info("[RecordsService] Size of updatedBlob : "+blob.size),this.filename=this.filename.replace("mp4","wav"),this.recordFile={name:this.filename,extension:"wav",size:blob.size},this.recording=!1,this.recorder=null,this.chunk=null,this.$rootScope.$broadcast("ON_OPEN_RECORDINGFILESTORAGE_POPUP",this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_SAVED",this.recordFile,blob,this.recordStopOrigin),this.recordStopOrigin="LOCAL"}onStopCreateFileFromBlob(blob){this.$log.info("[RecordsService] Size of updatedBlob : "+blob.size),this.recordFile={name:this.filename,extension:"mp4",size:blob.size},this.centralizedService.fileSystem&&this.centralizedService.fileSystem.unlink&&this.centralizedService.fileSystem.unlink(this.fullFileName+".temp"),this.tempUploadedFileDescriptor&&(this.fileStorageService.deleteFileDescriptor(this.tempUploadedFileDescriptor.id),this.tempUploadedFileDescriptor=null),this.recording=!1,this.recorder=null,this.chunk=null,this.$rootScope.$broadcast("ON_OPEN_RECORDINGFILESTORAGE_POPUP",this.recordFile,this.recordStopOrigin),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_SAVED",this.recordFile,blob,this.recordStopOrigin),this.recordStopOrigin="LOCAL"}readAsArrayBuffer(blob){return new Promise((resolve,reject)=>{const reader=new FileReader;reader.readAsArrayBuffer(blob),reader.onloadend=()=>{resolve(reader.result)},reader.onerror=()=>{reject()}})}injectMetadata(blob){return __awaiter(this,void 0,void 0,(function*(){this.$log.info("[RecordsService] injectMetadata");const type=blob.type,buffer=yield this.readAsArrayBuffer(blob);return blob=null,this.data=null,this.injectMetadataFromArrayBuffer(buffer,type)}))}injectMetadataFromArrayBuffer(arrayBuf,type){this.$log.info("[RecordsService] injectMetadataFromArrayBuffer");const decoder=new ts_ebml_1.Decoder,reader=new ts_ebml_1.Reader;reader.logging=!1,reader.drop_default_duration=!1;decoder.decode(arrayBuf).forEach(elm=>{reader.read(elm)}),reader.stop();const refinedMetadataBuf=ts_ebml_1.tools.makeMetadataSeekable(reader.metadatas,reader.duration,reader.cues),body=arrayBuf.slice(reader.metadataSize);return new Blob([refinedMetadataBuf,body],{type:type})}closeAudioContext(){this.audioContext&&(this.audioContext.destination&&this.audioContext.destination.disconnect(),"closed"!==this.audioContext.state&&(this.audioContext.close(),this.audioContext=null))}cleanRecord(){!1!==this.recording?this.$log.error("[RecordsService] Unexpected record cleaning while recording not stopped"):(this.updatedBlob=null,this.recordFile=null,this.data=null)}onError(event){this.$log.error("[RecordsService] error : "+event.message||false),this.recording=!1,this.stopConvTimer(),this.$rootScope.$broadcast("ON_WEBRTC_RECORD_ERROR")}createRecord(callID,callID2,sourceStream="REMOTE",upload=!1,filename="",onlyAudio=!1,mimeType){let options=null,localStreams=null,remoteStreams=null,stream=null,videoStream=null,audioStream=null;const tracks=[];this.recorder=null,this.upload=upload,this.filename=filename;let streamsAvailable=!1,localIndexSharing=null,localIndexAudioVideo=null,remoteIndexSharing=null,remoteIndexAudioVideo=null;const isSafari="safari"===adapter.default.browserDetails.browser;if(this.decoder=new ts_ebml_1.Decoder,this.data=new Blob([],{type:"video/webm"}),isSafari&&(mimeType="audio/wave"),mimeType&&MediaRecorder.isTypeSupported(mimeType)?options={mimeType:mimeType}:onlyAudio?MediaRecorder.isTypeSupported("audio/webm")&&(options={mimeType:"audio/webm"}):MediaRecorder.isTypeSupported("video/webm;codecs=vp8")?options={mimeType:"video/webm; codecs=vp8"}:MediaRecorder.isTypeSupported("video/webm;codecs=vp9")?options={mimeType:"video/webm; codecs=vp9"}:MediaRecorder.isTypeSupported("video/webm;codecs=h264")?options={mimeType:"video/webm; codecs=h264"}:MediaRecorder.isTypeSupported("video/mpeg")&&(options={mimeType:"video/mpeg"}),null===options)return this.$log.error("[RecordsService] Codecs : "+mimeType+" are not available for the navigator"),!1;{this.$log.info("[RecordsService] createRecord -- mimeType used "+options.mimeType);let sess=null;if(callID){if(sess=this.xmppService.connection.jingle.sessions[callID],sess&&(localStreams=this.xmppService.connection.jingle.sessions[callID].localStreams,sess.remoteStreams&&sess.remoteStreams.length?remoteStreams=sess.remoteStreams:sess.remoteStreams&&sess.remoteStreams.length||!sess.remoteStreamsObject||(remoteStreams=Object.values(sess.remoteStreamsObject))),callID2){var sess2=this.xmppService.connection.jingle.sessions[callID2];localStreams=localStreams?localStreams.concat(this.xmppService.connection.jingle.sessions[callID2].localStreams):this.xmppService.connection.jingle.sessions[callID2].localStreams,sess2.remoteStream&&sess2.remoteStreams.length?remoteStreams=remoteStreams?remoteStreams.concat(sess2.remoteStreams):sess2.remoteStreams:sess2.remoteStreams&&sess2.remoteStreams.length||!sess2.remoteStreamsObject||(remoteStreams=remoteStreams?remoteStreams.concat(Object.values(sess2.remoteStreamsObject)):Object.values(sess2.remoteStreamsObject))}}else{if(!callID2)return this.$log.error("[RecordsService] no callId"),!1;sess=this.xmppService.connection.jingle.sessions[callID2],localStreams=this.xmppService.connection.jingle.sessions[callID2].localStreams,sess.remoteStream&&sess.remoteStreams.length?remoteStreams=sess.remoteStreams:sess.remoteStreams&&sess.remoteStreams.length||!sess.remoteStreamsObject||(remoteStreams=Object.values(sess.remoteStreamsObject))}if(streamsAvailable=localStreams&&localStreams.length&&null!==localStreams[0]||remoteStreams&&remoteStreams.length&&null!==remoteStreams[0],null!==this.recorder||!streamsAvailable)return this.$log.error("[RecordsService] Cannot get Stream"),!1;{let i,tmpIndexSharing=null;for(i=0;i<remoteStreams.length;i++)remoteStreams[i]&&null!==remoteStreams[i]&&(tmpIndexSharing=i,remoteStreams[i].getAudioTracks().forEach(element=>{tracks.push(element),remoteIndexAudioVideo=i,tmpIndexSharing=null}),null!==tmpIndexSharing&&(remoteIndexSharing=tmpIndexSharing));for(tmpIndexSharing=null,i=0;i<localStreams.length;i++)localStreams[i]&&null!==localStreams[i]&&(tmpIndexSharing=i,localStreams[i].getAudioTracks().forEach(element=>{tracks.push(element),localIndexAudioVideo=i,tmpIndexSharing=null}),null!==tmpIndexSharing&&(localIndexSharing=tmpIndexSharing));if(this.audioContext&&(this.$log.error("[RecordsService] anomaly audio Context not previously released"),this.closeAudioContext()),tracks.length)if(isSafari)audioStream=new MediaStream,tracks.forEach(track=>{audioStream.addTrack(track)});else{this.audioContext=new AudioContext;const sources=tracks.map(t=>this.audioContext.createMediaStreamSource(new MediaStream([t]))),dest=this.audioContext.createMediaStreamDestination();sources.forEach(source=>source.connect(dest)),audioStream=dest.stream}if(!onlyAudio&&!isSafari)if(videoStream=new MediaStream,"LOCAL"===sourceStream&&null!==localIndexSharing){localStreams[localIndexSharing].getVideoTracks().forEach(element=>{videoStream.addTrack(element)})}else null!==remoteIndexSharing?remoteStreams[remoteIndexSharing].getVideoTracks().forEach(element=>{videoStream.addTrack(element)}):remoteStreams[remoteIndexAudioVideo].getVideoTracks().forEach(element=>{videoStream.addTrack(element)});stream=audioStream&&videoStream?new MediaStream([...audioStream.getTracks(),...videoStream.getTracks()]):audioStream&&!videoStream?audioStream:videoStream,this.centralizedService.fileSystem&&this.centralizedService.fileSystem.createWriteStream&&this.centralizedService.fileSystem.unlink&&(this.fullFileName=this.centralizedService.fileSaver.getFolderPath()+"/"+filename,this.centralizedService.fileSystem.createWriteStream(this.fullFileName+".temp").then(writeStream=>{this.writeStream=writeStream,this.writeStream.on("error",()=>{this.$log.info("[RecordsService] WriteStream error event")}),this.writeStream.on("drain",()=>{this.$log.info("[RecordsService] WriteStream drain event")})})),isSafari?(this.recorder=new MediaRecorder(stream),this.recorder.addEventListener("dataavailable",function(error){this.onCreateFileFromBlobForSafari(error.data)}.bind(this)),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this)):(this.recorder=new MediaRecorder(stream,options),this.recorder.ondataavailable=this.onDataAvailable.bind(this),this.recorder.onstop=this.onStop.bind(this),this.recorder.onerror=this.onError.bind(this))}}return!0}createBackupFile(){return this.$q((resolve,reject)=>{const buffer=this.data,file=this.recordFile;let UploadError="";return!1!==this.recording?(this.$log.error("[RecordsService] createBackupFile Unexpected uploading file when recording not stopped"),UploadError="recording not stopped pb",void reject(UploadError)):0===file.size?(this.$log.error("[RecordsService] createBackupFile error uploading empty file"),UploadError="empty file pb",void reject(UploadError)):void this.fileStorageService.createFileDescriptor(file.name,file.extension,file.size).then(fileDescriptor=>{this.fileServerService.uploadAFileByChunk(fileDescriptor,buffer,()=>{}).then(()=>(this.$log.info("[RecordsService] createBackupFile success"),resolve(fileDescriptor))).catch(errorUpload=>(this.$log.error("[RecordsService] createBackupFile Unexpected error while uploading file",errorUpload),UploadError="server pb",reject(UploadError)))}).catch(error=>{this.$log.error("[RecordsService] createBackupFile Unexpected error while creating file descriptor!",error),UploadError="file descriptor pb",reject(UploadError)})})}uploadFile(){return this.$q((resolve,reject)=>{const buffer=this.updatedBlob,file=this.recordFile;let UploadError="";return!1!==this.recording?(this.$log.error("[RecordsService] Unexpected uploading file when recording not stopped"),UploadError="recording not stopped pb",void reject(UploadError)):0===file.size?(this.$log.error("[RecordsService] error uploading empty file"),UploadError="empty file pb",void reject(UploadError)):void this.fileStorageService.createFileDescriptor(file.name,file.extension,file.size).then(fileDescriptor=>{this.fileServerService.uploadAFileByChunk(fileDescriptor,buffer,void 0,()=>{}).then(()=>{this.$log.info("[RecordsService] uploadFile success"),this.cleanRecord(),resolve()}).catch(errorUpload=>{this.$log.error("[RecordsService] Unexpected error while uploading file",errorUpload),UploadError="server pb",reject(UploadError)})}).catch(error=>{this.$log.error("[RecordsService] Unexpected error while creating file descriptor!",error),UploadError="file descriptor pb",reject(UploadError)})})}setRecordStopOrigin(recordStopSource){recordStopSource&&""!==recordStopSource&&(this.recordStopOrigin=recordStopSource)}localSaveFile(){const buffer=this.updatedBlob,file=this.recordFile;!1===this.recording?(this.downloadFile(buffer,null,null,file.name,!0),this.cleanRecord()):this.$log.error("[RecordsService] Unexpected file local storage when recording not stopped")}downloadFile(blob,conversationId,messageId,filename,browse){this.$log.info("[RecordsService] downloadFile -- default function"),this.centralizedService.fileSaver&&this.centralizedService.fileSaver.fileDownload(blob,conversationId,messageId,filename,browse)}startRecording(timeslice){null!==this.recorder&&(timeslice?this.recorder.start(timeslice):this.recorder.start(),this.recording=!0,this.startConvTimer())}stopRecording(){null!==this.recorder&&(this.recorder.stop(),this.recording=!1,this.closeAudioContext()),this.stopConvTimer(),this.initConversationRecordContext()}pauseResumeRecording(){null!==this.recorder&&("recording"===this.recorder.state?(this.recorder.pause(),this.conversationRecordContext.pause=!0,this.stopConvTimer()):(this.recorder.resume(),this.conversationRecordContext.pause=!1,this.startConvTimer()))}setOnDataAvailableCallback(callback){null!==this.recorder&&(this.recorder.ondataavailable=callback)}setOnErrorCallback(callback){null!==this.recorder&&(this.recorder.onerror=callback)}setOnPauseCallback(callback){null!==this.recorder&&(this.recorder.onpause=callback)}setOnResumeCallback(callback){null!==this.recorder&&(this.recorder.onresume=callback)}setOnStartCallback(callback){null!==this.recorder&&(this.recorder.onstart=callback)}setOnStopCallback(callback){null!==this.recorder&&(this.recorder.onstop=callback)}initConversationRecordContext(){this.conversationRecordContext={conversationId:"",recorder:!1,pause:!1,actualRecordTime:0,updateTimer:null,recordStopSource:"LOCAL"}}getConversationRecordContext(conversationId){return conversationId===this.conversationRecordContext.conversationId?this.conversationRecordContext:null}setConversationRecordContext(conversationId,recorder,pause,actualRecordTime,recordStopSource){conversationId&&""!==conversationId&&(this.conversationRecordContext.conversationId=conversationId,this.conversationRecordContext.recorder=recorder&&this.recording,this.conversationRecordContext.pause=pause,this.conversationRecordContext.actualRecordTime=actualRecordTime,this.conversationRecordContext.recordStopSource=recordStopSource)}startConvTimer(){this.conversationRecordContext.updateTimer=this.$interval(()=>{this.conversationRecordContext.actualRecordTime++},1e3)}stopConvTimer(){null!==this.conversationRecordContext.updateTimer&&(this.$interval.cancel(this.conversationRecordContext.updateTimer),this.conversationRecordContext.updateTimer=null)}getDurationTime(durationTime){if(!durationTime)return"";let tempTime=durationTime;const tempDisplay={};return tempDisplay.hour=Math.trunc(tempTime/3600),tempTime-=3600*tempDisplay.hour,tempDisplay.minute=Math.trunc(tempTime/60),tempTime-=60*tempDisplay.minute,tempDisplay.seconde=tempTime,0===tempDisplay.hour?moment(tempDisplay.minute+":"+tempDisplay.seconde,"mm:ss").format("mm:ss"):moment(tempDisplay.hour+":"+tempDisplay.minute+":"+tempDisplay.seconde,"HH:mm:ss").format("HH:mm:ss")}initRecordTimer(callAreaRecordContext){callAreaRecordContext.updateTimer=this.$interval(()=>{callAreaRecordContext.actualRecordTime++,callAreaRecordContext.displayRecordTime=this.getDurationTime(callAreaRecordContext.actualRecordTime)},1e3)}stopRecordTimer(callAreaRecordContext){null!==callAreaRecordContext.updateTimer&&(this.$interval.cancel(callAreaRecordContext.updateTimer),callAreaRecordContext.updateTimer=null)}handleRecordPauseResume(callAreaRecordContext){const recordContext=this.getConversationRecordContext(callAreaRecordContext.conversation.id);callAreaRecordContext.recorder&&recordContext&&(callAreaRecordContext.pauseRecord=recordContext.pause,callAreaRecordContext.pauseRecord?(this.$interval.cancel(callAreaRecordContext.updateTimer),callAreaRecordContext.updateTimer=null):callAreaRecordContext.updateTimer||this.initRecordTimer(callAreaRecordContext))}pauseOrResumeRecording(callAreaRecordContext){callAreaRecordContext.recorder&&this.pauseResumeRecording()}startRecord(callAreaRecordContext,buttons){if(!callAreaRecordContext.recorder){callAreaRecordContext.recorder=!0;const conv=callAreaRecordContext.conversation;let filename,videoCallId=null,MPCallId=null;if("PHONE_MP"===callAreaRecordContext.callType){const contactTel=callAreaRecordContext.getConversation().contact;filename="conv_"+contactTel.firstname.substr(0,1)+"_"+contactTel.lastname+"_"+moment().format("DD-MM-YYYY_H_mm_ss")+".mp4"}else filename="conv_"+conv.contact.firstname.substr(0,1)+"_"+conv.contact.lastname+"_"+moment().format("DD-MM-YYYY_H_mm_ss")+".mp4";const sourceStream=conv.videoCall.localMedia&call_model_1.Call.Media.SHARING?"LOCAL":"REMOTE";if(conv.videoCall&&conv.videoCall.id&&(videoCallId=conv.videoCall.id),callAreaRecordContext.webrtcCallRef&&callAreaRecordContext.webrtcCallRef.id&&(MPCallId=callAreaRecordContext.webrtcCallRef.id),!videoCallId&&!MPCallId)return void(callAreaRecordContext.recorder=!1);this.createRecord(videoCallId,MPCallId,sourceStream,!0,filename)?(this.startRecording(),this.setConversationRecordContext(conv.id,callAreaRecordContext.recorder,!1,0,"LOCAL"),this.manageRecordButtons(callAreaRecordContext,buttons),this.conversationService.sendRecordingMessage(conv,"start")):callAreaRecordContext.recorder=!1}}stopRecord(callAreaRecordContext,buttons,origin="LOCAL"){callAreaRecordContext.recorder&&(this.setRecordStopOrigin(origin),this.stopRecording(),callAreaRecordContext.recorder=!1,this.manageRecordButtons(callAreaRecordContext,buttons),callAreaRecordContext.displayRecordTime=null,callAreaRecordContext.updateTimer&&(this.stopRecordTimer(callAreaRecordContext),callAreaRecordContext.updateTimer=null),this.conversationService.sendRecordingMessage(callAreaRecordContext.conversation,"stop"))}manageActiveRecorder(callAreaRecordContext){if(!callAreaRecordContext.updateTimer){this.setOnPauseCallback(()=>{this.handleRecordPauseResume(callAreaRecordContext)}),this.setOnResumeCallback(()=>{this.handleRecordPauseResume(callAreaRecordContext)});const recordContext=this.getConversationRecordContext(callAreaRecordContext.conversation.id);recordContext&&recordContext.recorder&&(callAreaRecordContext.pauseRecord=recordContext.pause,callAreaRecordContext.actualRecordTime=recordContext.actualRecordTime,callAreaRecordContext.updateTimer=null,callAreaRecordContext.pauseRecord||this.initRecordTimer(callAreaRecordContext),callAreaRecordContext.displayRecordTime=this.getDurationTime(callAreaRecordContext.actualRecordTime))}}manageRecordButtons(callAreaRecordContext,buttons){if(!callAreaRecordContext.recordingFeature)return;if(!callAreaRecordContext.conversation)return;"WEBRTC"===callAreaRecordContext.callType&&callAreaRecordContext.conversation.videoCall&&(callAreaRecordContext.isRecorded=callAreaRecordContext.conversation.videoCall.isRecorded);if("PHONE_MP"===callAreaRecordContext.callType){const recordContext=this.getConversationRecordContext(callAreaRecordContext.conversation.id);recordContext&&recordContext.recorder?(callAreaRecordContext.recorder=recordContext.recorder,buttons.stopRecord=!0,buttons.startRecord=!1,this.manageActiveRecorder(callAreaRecordContext)):(buttons.stopRecord=!1,buttons.startRecord=!0)}}}RecordsService.$inject=["$q","$rootScope","$log","fileServerService","centralizedService","ringingService","conversationService","$interval","$translate","$window"],angular.module("rainbow").service("recordsService",RecordsService)}).call(this,__webpack_require__(56).Buffer)},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var EBMLDecoder_1=__webpack_require__(397);exports.Decoder=EBMLDecoder_1.default;var EBMLEncoder_1=__webpack_require__(231);exports.Encoder=EBMLEncoder_1.default;var EBMLReader_1=__webpack_require__(402);exports.Reader=EBMLReader_1.default;var tools=__webpack_require__(48);exports.tools=tools;var version=__webpack_require__(404).version;exports.version=version},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var State,tools_1=__webpack_require__(48),int64_buffer_1=__webpack_require__(230),tools=__webpack_require__(48),byEbmlID=__webpack_require__(232).byEbmlID;!function(State){State[State.STATE_TAG=1]="STATE_TAG",State[State.STATE_SIZE=2]="STATE_SIZE",State[State.STATE_CONTENT=3]="STATE_CONTENT"}(State||(State={}));var EBMLDecoder=function(){function EBMLDecoder(){this._buffer=new tools_1.Buffer(0),this._tag_stack=[],this._state=State.STATE_TAG,this._cursor=0,this._total=0,this._schema=byEbmlID,this._result=[]}return EBMLDecoder.prototype.decode=function(chunk){this.readChunk(chunk);var diff=this._result;return this._result=[],diff},EBMLDecoder.prototype.readChunk=function(chunk){for(this._buffer=tools.concat([this._buffer,new tools_1.Buffer(chunk)]);this._cursor<this._buffer.length&&(this._state!==State.STATE_TAG||this.readTag())&&(this._state!==State.STATE_SIZE||this.readSize())&&(this._state!==State.STATE_CONTENT||this.readContent()););},EBMLDecoder.prototype.getSchemaInfo=function(tagNum){return this._schema[tagNum]||{name:"unknown",level:-1,type:"unknown",description:"unknown"}},EBMLDecoder.prototype.readTag=function(){if(this._cursor>=this._buffer.length)return!1;var tag=tools_1.readVint(this._buffer,this._cursor);if(null==tag)return!1;var tagNum=this._buffer.slice(this._cursor,this._cursor+tag.length).reduce((function(o,v,i,arr){return o+v*Math.pow(16,2*(arr.length-1-i))}),0),schema=this.getSchemaInfo(tagNum),tagObj={EBML_ID:tagNum.toString(16),schema:schema,type:schema.type,name:schema.name,level:schema.level,tagStart:this._total,tagEnd:this._total+tag.length,sizeStart:this._total+tag.length,sizeEnd:null,dataStart:null,dataEnd:null,dataSize:null,data:null};return this._tag_stack.push(tagObj),this._cursor+=tag.length,this._total+=tag.length,this._state=State.STATE_SIZE,!0},EBMLDecoder.prototype.readSize=function(){if(this._cursor>=this._buffer.length)return!1;var size=tools_1.readVint(this._buffer,this._cursor);if(null==size)return!1;var tagObj=this._tag_stack[this._tag_stack.length-1];return tagObj.sizeEnd=tagObj.sizeStart+size.length,tagObj.dataStart=tagObj.sizeEnd,tagObj.dataSize=size.value,-1===size.value?(tagObj.dataEnd=-1,"m"===tagObj.type&&(tagObj.unknownSize=!0)):tagObj.dataEnd=tagObj.sizeEnd+size.value,this._cursor+=size.length,this._total+=size.length,this._state=State.STATE_CONTENT,!0},EBMLDecoder.prototype.readContent=function(){var tagObj=this._tag_stack[this._tag_stack.length-1];if("m"===tagObj.type){if(tagObj.isEnd=!1,this._result.push(tagObj),this._state=State.STATE_TAG,0===tagObj.dataSize){var elm=Object.assign({},tagObj,{isEnd:!0});this._result.push(elm),this._tag_stack.pop()}return!0}if(this._buffer.length<this._cursor+tagObj.dataSize)return!1;var data=this._buffer.slice(this._cursor,this._cursor+tagObj.dataSize);switch(this._buffer=this._buffer.slice(this._cursor+tagObj.dataSize),tagObj.data=data,tagObj.type){case"u":tagObj.value=data.readUIntBE(0,data.length);break;case"i":tagObj.value=data.readIntBE(0,data.length);break;case"f":tagObj.value=4===tagObj.dataSize?data.readFloatBE(0):8===tagObj.dataSize?data.readDoubleBE(0):(console.warn("cannot read "+tagObj.dataSize+" octets float. failback to 0"),0);break;case"s":tagObj.value=data.toString("ascii");break;case"8":tagObj.value=data.toString("utf8");break;case"b":tagObj.value=data;break;case"d":tagObj.value=tools_1.convertEBMLDateToJSDate(new int64_buffer_1.Int64BE(data).toNumber())}if(null===tagObj.value)throw new Error("unknown tag type:"+tagObj.type);for(this._result.push(tagObj),this._total+=tagObj.dataSize,this._state=State.STATE_TAG,this._cursor=0,this._tag_stack.pop();this._tag_stack.length>0;){var topEle=this._tag_stack[this._tag_stack.length-1];if(topEle.dataEnd<0)return this._tag_stack.pop(),!0;if(this._total<topEle.dataEnd)break;if("m"!==topEle.type)throw new Error("parent element is not master element");elm=Object.assign({},topEle,{isEnd:!0});this._result.push(elm),this._tag_stack.pop()}return!0},EBMLDecoder}();exports.default=EBMLDecoder},function(module,exports,__webpack_require__){(function(Buffer){var tools={readVint:function(buffer,start){start=start||0;for(var length=1;length<=8&&!(buffer[start]>=Math.pow(2,8-length));length++);if(length>8)throw new Error("Unrepresentable length: "+length+" "+buffer.toString("hex",start,start+length));if(start+length>buffer.length)return null;for(var value=buffer[start]&(1<<8-length)-1,i=1;i<length;i++){if(7===i&&value>=Math.pow(2,45)&&buffer[start+7]>0)return{length:length,value:-1};value*=Math.pow(2,8),value+=buffer[start+i]}return{length:length,value:value}},writeVint:function(value){if(value<0||value>Math.pow(2,53))throw new Error("Unrepresentable value: "+value);for(var length=1;length<=8&&!(value<Math.pow(2,7*length)-1);length++);for(var buffer=new Buffer(length),i=1;i<=length;i++){var b=255&value;buffer[length-i]=b,value-=b,value/=Math.pow(2,8)}return buffer[0]=buffer[0]|1<<8-length,buffer}};module.exports=tools}).call(this,__webpack_require__(56).Buffer)},function(module,exports,__webpack_require__){var BufferReader=__webpack_require__(400);module.exports=function(buffer){var block={},reader=new BufferReader(buffer);block.trackNumber=reader.nextUIntV(),block.timecode=reader.nextInt16BE();var flags=reader.nextUInt8();block.invisible=!!(8&flags),block.keyframe=!!(128&flags),block.discardable=!!(1&flags);var lacing=(6&flags)>>1;return block.frames=function(reader,lacing){if(!lacing)return[reader.nextBuffer()];var i,frameSize,frames=[],framesNum=reader.nextUInt8()+1;if(2===lacing){if(reader.length%framesNum!=0)throw new Error("Fixed-Size Lacing Error");for(frameSize=reader.length/framesNum,i=0;i<framesNum;i++)frames.push(reader.nextBuffer(frameSize));return frames}var frameSizes=[];if(1===lacing)for(i=0;i<framesNum-1;i++){var val;frameSize=0;do{val=reader.nextUInt8(),frameSize+=val}while(255===val);frameSizes.push(frameSize)}else if(3===lacing)for(frameSize=reader.nextUIntV(),frameSizes.push(frameSize),i=1;i<framesNum-1;i++)frameSize+=reader.nextIntV(),frameSizes.push(frameSize);for(i=0;i<framesNum-1;i++)frames.push(reader.nextBuffer(frameSizes[i]));return frames.push(reader.nextBuffer()),frames}(reader,lacing),block}},function(module,exports,__webpack_require__){var vint=__webpack_require__(401);function BufferReader(buffer){this.buffer=buffer,this.offset=0}BufferReader.prototype.nextInt16BE=function(){var value=this.buffer.readInt16BE(this.offset);return this.offset+=2,value},BufferReader.prototype.nextUInt8=function(){var value=this.buffer.readUInt8(this.offset);return this.offset+=1,value},BufferReader.prototype.nextUIntV=function(){var v=vint(this.buffer,this.offset);return this.offset+=v.length,v.value},BufferReader.prototype.nextIntV=function(){var v=vint(this.buffer,this.offset,!0);return this.offset+=v.length,v.value},BufferReader.prototype.nextBuffer=function(length){var buffer=length?this.buffer.slice(this.offset,this.offset+length):this.buffer.slice(this.offset);return this.offset+=length||this.length,buffer},Object.defineProperty(BufferReader.prototype,"length",{get:function(){return this.buffer.length-this.offset}}),module.exports=BufferReader},function(module,exports){module.exports=function(buffer,start,signed){start=start||0;for(var length=1;length<=8&&!(buffer[start]>=Math.pow(2,8-length));length++);if(length>8)throw new Error("Unrepresentable length: "+length+" "+buffer.toString("hex",start,start+length));if(start+length>buffer.length)return null;var i,value=buffer[start]&(1<<8-length)-1;for(i=1;i<length;i++){if(7===i&&value>=Math.pow(2,45)&&buffer[start+7]>0)return{length:length,value:-1};value*=Math.pow(2,8),value+=buffer[start+i]}return signed&&(value-=Math.pow(2,7*length-1)-1),{length:length,value:value}}},function(module,exports,__webpack_require__){"use strict";var extendStatics,__extends=this&&this.__extends||(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)});Object.defineProperty(exports,"__esModule",{value:!0});var events_1=__webpack_require__(403),tools=__webpack_require__(48),EBMLReader=function(_super){function EBMLReader(){var _this=_super.call(this)||this;return _this.logGroup="",_this.hasLoggingStarted=!1,_this.metadataloaded=!1,_this.chunks=[],_this.stack=[],_this.segmentOffset=0,_this.last2SimpleBlockVideoTrackTimecode=[0,0],_this.last2SimpleBlockAudioTrackTimecode=[0,0],_this.lastClusterTimecode=0,_this.lastClusterPosition=0,_this.timecodeScale=1e6,_this.metadataSize=0,_this.metadatas=[],_this.cues=[],_this.firstVideoBlockRead=!1,_this.firstAudioBlockRead=!1,_this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null},_this.trackTypes=[],_this.trackDefaultDuration=[],_this.trackCodecDelay=[],_this.trackInfo={type:"nothing"},_this.ended=!1,_this.logging=!1,_this.use_duration_every_simpleblock=!1,_this.use_webp=!1,_this.use_segment_info=!0,_this.drop_default_duration=!0,_this}return __extends(EBMLReader,_super),EBMLReader.prototype.stop=function(){for(this.ended=!0,this.emit_segment_info();this.stack.length;)this.stack.pop(),this.logging&&console.groupEnd();this.logging&&this.hasLoggingStarted&&this.logGroup&&console.groupEnd()},EBMLReader.prototype.emit_segment_info=function(){var data=this.chunks;if(this.chunks=[],this.metadataloaded){if(!this.use_segment_info)return;var timecode=this.lastClusterTimecode,duration=this.duration,timecodeScale=this.timecodeScale;this.emit("cluster",{timecode:timecode,data:data}),this.emit("duration",{timecodeScale:timecodeScale,duration:duration})}else{this.metadataloaded=!0,this.metadatas=data;var videoTrackNum=this.trackTypes.indexOf(1),audioTrackNum=this.trackTypes.indexOf(2);if(this.trackInfo=videoTrackNum>=0&&audioTrackNum>=0?{type:"both",trackNumber:videoTrackNum}:videoTrackNum>=0?{type:"video",trackNumber:videoTrackNum}:audioTrackNum>=0?{type:"audio",trackNumber:audioTrackNum}:{type:"nothing"},!this.use_segment_info)return;this.emit("metadata",{data:data,metadataSize:this.metadataSize})}},EBMLReader.prototype.read=function(elm){var _this=this,drop=!1;if(!this.ended){if("m"===elm.type)if(elm.isEnd)this.stack.pop();else{var parent_1=this.stack[this.stack.length-1];if(null!=parent_1&&parent_1.level>=elm.level){this.stack.pop(),this.logging&&console.groupEnd(),parent_1.dataEnd=elm.dataEnd,parent_1.dataSize=elm.dataEnd-parent_1.dataStart,parent_1.unknownSize=!1;var o=Object.assign({},parent_1,{name:parent_1.name,type:parent_1.type,isEnd:!0});this.chunks.push(o)}this.stack.push(elm)}if("m"===elm.type&&"Segment"==elm.name)0!=this.segmentOffset&&console.warn("Multiple segments detected!"),this.segmentOffset=elm.dataStart,this.emit("segment_offset",this.segmentOffset);else if("b"===elm.type&&"SimpleBlock"===elm.name){var _a=tools.ebmlBlock(elm.data),timecode=_a.timecode,trackNumber=_a.trackNumber,frames_1=_a.frames;if(1===this.trackTypes[trackNumber]){if(!this.firstVideoBlockRead&&(this.firstVideoBlockRead=!0,"both"===this.trackInfo.type||"video"===this.trackInfo.type)){var CueTime=this.lastClusterTimecode+timecode;this.cues.push({CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime}),this.emit("cue_info",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode}),this.emit("cue",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime})}this.last2SimpleBlockVideoTrackTimecode=[this.last2SimpleBlockVideoTrackTimecode[1],timecode]}else if(2===this.trackTypes[trackNumber]){if(!this.firstAudioBlockRead&&(this.firstAudioBlockRead=!0,"audio"===this.trackInfo.type)){CueTime=this.lastClusterTimecode+timecode;this.cues.push({CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime}),this.emit("cue_info",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:this.lastClusterTimecode}),this.emit("cue",{CueTrack:trackNumber,CueClusterPosition:this.lastClusterPosition,CueTime:CueTime})}this.last2SimpleBlockAudioTrackTimecode=[this.last2SimpleBlockAudioTrackTimecode[1],timecode]}this.use_duration_every_simpleblock&&this.emit("duration",{timecodeScale:this.timecodeScale,duration:this.duration}),this.use_webp&&frames_1.forEach((function(frame){if("9d012a"===frame.slice(3,6).toString("hex")){var webpBuf=tools.VP8BitStreamToRiffWebPBuffer(frame),webp=new Blob([webpBuf],{type:"image/webp"}),currentTime=_this.duration;_this.emit("webp",{currentTime:currentTime,webp:webp})}}))}else"m"===elm.type&&"Cluster"===elm.name&&!1===elm.isEnd?(this.firstVideoBlockRead=!1,this.firstAudioBlockRead=!1,this.emit_segment_info(),this.emit("cluster_ptr",elm.tagStart),this.lastClusterPosition=elm.tagStart):"u"===elm.type&&"Timecode"===elm.name?this.lastClusterTimecode=elm.value:"u"===elm.type&&"TimecodeScale"===elm.name?this.timecodeScale=elm.value:"m"===elm.type&&"TrackEntry"===elm.name?elm.isEnd?(this.trackTypes[this.currentTrack.TrackNumber]=this.currentTrack.TrackType,this.trackDefaultDuration[this.currentTrack.TrackNumber]=this.currentTrack.DefaultDuration,this.trackCodecDelay[this.currentTrack.TrackNumber]=this.currentTrack.CodecDelay):this.currentTrack={TrackNumber:-1,TrackType:-1,DefaultDuration:null,CodecDelay:null}:"u"===elm.type&&"TrackType"===elm.name?this.currentTrack.TrackType=elm.value:"u"===elm.type&&"TrackNumber"===elm.name?this.currentTrack.TrackNumber=elm.value:"u"===elm.type&&"CodecDelay"===elm.name?this.currentTrack.CodecDelay=elm.value:"u"===elm.type&&"DefaultDuration"===elm.name?this.drop_default_duration?(console.warn("DefaultDuration detected!, remove it"),drop=!0):this.currentTrack.DefaultDuration=elm.value:"unknown"===elm.name&&console.warn(elm);!this.metadataloaded&&elm.dataEnd>0&&(this.metadataSize=elm.dataEnd),drop||this.chunks.push(elm),this.logging&&this.put(elm)}},Object.defineProperty(EBMLReader.prototype,"duration",{get:function(){if("nothing"===this.trackInfo.type)return console.warn("no video, no audio track"),0;var defaultDuration=0,codecDelay=0,lastTimecode=0,_defaultDuration=this.trackDefaultDuration[this.trackInfo.trackNumber];if("number"==typeof _defaultDuration)defaultDuration=_defaultDuration;else if("both"===this.trackInfo.type)this.last2SimpleBlockAudioTrackTimecode[1]>this.last2SimpleBlockVideoTrackTimecode[1]?(defaultDuration=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackTypes.indexOf(2)])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockAudioTrackTimecode[1]):(defaultDuration=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackTypes.indexOf(1)])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockVideoTrackTimecode[1]);else if("video"===this.trackInfo.type){defaultDuration=(this.last2SimpleBlockVideoTrackTimecode[1]-this.last2SimpleBlockVideoTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackInfo.trackNumber])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockVideoTrackTimecode[1]}else if("audio"===this.trackInfo.type){var delay;defaultDuration=(this.last2SimpleBlockAudioTrackTimecode[1]-this.last2SimpleBlockAudioTrackTimecode[0])*this.timecodeScale,"number"==typeof(delay=this.trackCodecDelay[this.trackInfo.trackNumber])&&(codecDelay=delay),lastTimecode=this.last2SimpleBlockAudioTrackTimecode[1]}var duration=((this.lastClusterTimecode+lastTimecode)*this.timecodeScale+defaultDuration-codecDelay)/this.timecodeScale;return Math.floor(duration)},enumerable:!0,configurable:!0}),EBMLReader.prototype.addListener=function(event,listener){return _super.prototype.addListener.call(this,event,listener)},EBMLReader.prototype.put=function(elm){this.hasLoggingStarted||(this.hasLoggingStarted=!0,this.logging&&this.logGroup&&console.groupCollapsed(this.logGroup)),"m"===elm.type?elm.isEnd?console.groupEnd():console.group(elm.name+":"+elm.tagStart):"b"===elm.type?console.log(elm.name,elm.type):console.log(elm.name,elm.tagStart,elm.type,elm.value)},EBMLReader}(events_1.EventEmitter);exports.default=EBMLReader},function(module,exports,__webpack_require__){"use strict";var ReflectOwnKeys,R="object"==typeof Reflect?Reflect:null,ReflectApply=R&&"function"==typeof R.apply?R.apply:function(target,receiver,args){return Function.prototype.apply.call(target,receiver,args)};ReflectOwnKeys=R&&"function"==typeof R.ownKeys?R.ownKeys:Object.getOwnPropertySymbols?function(target){return Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))}:function(target){return Object.getOwnPropertyNames(target)};var NumberIsNaN=Number.isNaN||function(value){return value!=value};function EventEmitter(){EventEmitter.init.call(this)}module.exports=EventEmitter,EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(listener){if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener)}function _getMaxListeners(that){return void 0===that._maxListeners?EventEmitter.defaultMaxListeners:that._maxListeners}function _addListener(target,type,listener,prepend){var m,events,existing,warning;if(checkListener(listener),void 0===(events=target._events)?(events=target._events=Object.create(null),target._eventsCount=0):(void 0!==events.newListener&&(target.emit("newListener",type,listener.listener?listener.listener:listener),events=target._events),existing=events[type]),void 0===existing)existing=events[type]=listener,++target._eventsCount;else if("function"==typeof existing?existing=events[type]=prepend?[listener,existing]:[existing,listener]:prepend?existing.unshift(listener):existing.push(listener),(m=_getMaxListeners(target))>0&&existing.length>m&&!existing.warned){existing.warned=!0;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+String(type)+" listeners added. Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning",w.emitter=target,w.type=type,w.count=existing.length,warning=w,console&&console.warn&&console.warn(warning)}return target}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(target,type,listener){var state={fired:!1,wrapFn:void 0,target:target,type:type,listener:listener},wrapped=onceWrapper.bind(state);return wrapped.listener=listener,state.wrapFn=wrapped,wrapped}function _listeners(target,type,unwrap){var events=target._events;if(void 0===events)return[];var evlistener=events[type];return void 0===evlistener?[]:"function"==typeof evlistener?unwrap?[evlistener.listener||evlistener]:[evlistener]:unwrap?function(arr){for(var ret=new Array(arr.length),i=0;i<ret.length;++i)ret[i]=arr[i].listener||arr[i];return ret}(evlistener):arrayClone(evlistener,evlistener.length)}function listenerCount(type){var events=this._events;if(void 0!==events){var evlistener=events[type];if("function"==typeof evlistener)return 1;if(void 0!==evlistener)return evlistener.length}return 0}function arrayClone(arr,n){for(var copy=new Array(n),i=0;i<n;++i)copy[i]=arr[i];return copy}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return defaultMaxListeners},set:function(arg){if("number"!=typeof arg||arg<0||NumberIsNaN(arg))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+arg+".");defaultMaxListeners=arg}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(n){if("number"!=typeof n||n<0||NumberIsNaN(n))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+n+".");return this._maxListeners=n,this},EventEmitter.prototype.getMaxListeners=function(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function(type){for(var args=[],i=1;i<arguments.length;i++)args.push(arguments[i]);var doError="error"===type,events=this._events;if(void 0!==events)doError=doError&&void 0===events.error;else if(!doError)return!1;if(doError){var er;if(args.length>0&&(er=args[0]),er instanceof Error)throw er;var err=new Error("Unhandled error."+(er?" ("+er.message+")":""));throw err.context=er,err}var handler=events[type];if(void 0===handler)return!1;if("function"==typeof handler)ReflectApply(handler,this,args);else{var len=handler.length,listeners=arrayClone(handler,len);for(i=0;i<len;++i)ReflectApply(listeners[i],this,args)}return!0},EventEmitter.prototype.addListener=function(type,listener){return _addListener(this,type,listener,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(type,listener){return _addListener(this,type,listener,!0)},EventEmitter.prototype.once=function(type,listener){return checkListener(listener),this.on(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.prependOnceListener=function(type,listener){return checkListener(listener),this.prependListener(type,_onceWrap(this,type,listener)),this},EventEmitter.prototype.removeListener=function(type,listener){var list,events,position,i,originalListener;if(checkListener(listener),void 0===(events=this._events))return this;if(void 0===(list=events[type]))return this;if(list===listener||list.listener===listener)0==--this._eventsCount?this._events=Object.create(null):(delete events[type],events.removeListener&&this.emit("removeListener",type,list.listener||listener));else if("function"!=typeof list){for(position=-1,i=list.length-1;i>=0;i--)if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener,position=i;break}if(position<0)return this;0===position?list.shift():function(list,index){for(;index+1<list.length;index++)list[index]=list[index+1];list.pop()}(list,position),1===list.length&&(events[type]=list[0]),void 0!==events.removeListener&&this.emit("removeListener",type,originalListener||listener)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function(type){var listeners,events,i;if(void 0===(events=this._events))return this;if(void 0===events.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==events[type]&&(0==--this._eventsCount?this._events=Object.create(null):delete events[type]),this;if(0===arguments.length){var key,keys=Object.keys(events);for(i=0;i<keys.length;++i)"removeListener"!==(key=keys[i])&&this.removeAllListeners(key);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(listeners=events[type]))this.removeListener(type,listeners);else if(void 0!==listeners)for(i=listeners.length-1;i>=0;i--)this.removeListener(type,listeners[i]);return this},EventEmitter.prototype.listeners=function(type){return _listeners(this,type,!0)},EventEmitter.prototype.rawListeners=function(type){return _listeners(this,type,!1)},EventEmitter.listenerCount=function(emitter,type){return"function"==typeof emitter.listenerCount?emitter.listenerCount(type):listenerCount.call(emitter,type)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]}},function(module){module.exports=JSON.parse('{"_from":"ts-ebml@^2.0.2","_id":"ts-ebml@2.0.2","_inBundle":false,"_integrity":"sha512-V/HdlCn3FITQrFHQlVE02XtfMiRLab2QB/YOCfkbJWqiFYG/j5v7gHKV+wem6g0PD6/uxXs5oxMQfDXILmts/Q==","_location":"/ts-ebml","_phantomChildren":{},"_requested":{"type":"range","registry":true,"raw":"ts-ebml@^2.0.2","name":"ts-ebml","escapedName":"ts-ebml","rawSpec":"^2.0.2","saveSpec":null,"fetchSpec":"^2.0.2"},"_requiredBy":["/"],"_resolved":"https://registry.npmjs.org/ts-ebml/-/ts-ebml-2.0.2.tgz","_shasum":"5e2c65b35ee6f1c030f51668666f3c018f4d9578","_spec":"ts-ebml@^2.0.2","_where":"/Users/konradhyzy/p/oldSDK/dependencies_otliteclient","author":{"name":"legokichi duckscallion"},"bin":{"ts-ebml":"lib/cli.js"},"bugs":{"url":"https://github.com/legokichi/ts-ebml/issues"},"bundleDependencies":false,"dependencies":{"buffer":"^5.0.7","commander":"^2.11.0","ebml":"^2.2.1","ebml-block":"^1.1.0","events":"^1.1.1","int64-buffer":"^0.1.9","matroska":"^2.2.3"},"deprecated":false,"description":"ebml decoder and encoder","devDependencies":{"@types/commander":"^2.9.1","@types/qunit":"^2.0.31","browserify":"^13.1.0","empower":"^1.2.3","espower-cli":"^1.1.0","power-assert":"^1.4.4","power-assert-formatter":"^1.4.1","qunit-tap":"^1.5.1","qunitjs":"^2.4.0","tslint":"^3.15.1","typedoc":"^0.5.3","typescript":"^2.4.2","watchify":"^3.7.0"},"homepage":"https://github.com/legokichi/ts-ebml#readme","keywords":["ebml","webm","mkv","matrosika","webp"],"license":"MIT","main":"./lib/index.js","name":"ts-ebml","repository":{"type":"git","url":"git+https://github.com/legokichi/ts-ebml.git"},"scripts":{"browserify":"browserify lib/index.js --standalone EBML -o dist/EBML.js","build":"npm run clean   && tsc    -p .; npm run browserify","check":"tsc -w --noEmit -p ./","clean":"rm -rf lib/* dist/* test/*.js; mkdir -p dist","doc":"typedoc --mode modules --out doc --disableOutputCheck","example":"tsc; browserify lib/example_seekable.js -o test/example_seekable.js","examples":"tsc; for file in `find lib -name \'example_*.js\' -type f -printf \'%f\\\\n\'`; do browserify lib/$file -o test/$file; done","examples_bsd":"tsc; for file in `find lib -name \'example_*.js\' -type f -print`; do browserify lib/$(basename $file) -o test/$(basename $file); done","init":"npm run update; npm run mkdir; npm run build","lint":"tslint -c ./tslint.json --project ./tsconfig.json --type-check","mkdir":"mkdir lib dist 2>/dev/null","reset":"rm -rf node_modules","setup":"npm install -g http-server;","start":"http-server . -s & tsc -w -p .& watchify lib/example_seekable.js -o test/example_seekable.js","stop":"killall -- node */tsc -w -p","test":"tsc; espower lib/test.js > lib/test.tmp; mv -f lib/test.tmp lib/test.js; browserify lib/test.js -o test/test.js","update":"npm run reset; npm update","watchify":"watchify lib/index.js --standalone EBML -o dist/EBMl.js -v"},"typings":"./lib/index.d.ts","version":"2.0.2"}')},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(5),_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0__),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_company_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(58),_src_services_core_company_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_company_service__WEBPACK_IMPORTED_MODULE_2__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3__),_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(19);function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(iter))return Array.from(iter)}(arr)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}angular.module("rainbow").service("adminCompanyService",["$q","$log","$http","$rootScope","errorHelperService","Site","CompanyInvitation","pushImageHelperService","CompanyRequest","Bot",function($q,$log,$http,$rootScope,errorHelperService,Site,CompanyInvitation,pushImageHelperService,CompanyRequest,Bot){var service=this;service.start=function(){return $log.info("[adminCompanyService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",$log.info("[adminCompanyService] === STARTED ==="),$q.when()},service.stop=function(){return $log.info("[adminCompanyService] === STOPPING ==="),$log.info("[adminCompanyService] === STOPPED ==="),$q.when()},service.getCompanies=function(organisationId,page,pageSize,searchName,format,bpId,status,isBP,bpType,offerCanBeSold,searchReference,noLogo){var defered=$q.defer(),adminContact=_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.userContact;if(!(adminContact.isSuperadmin()||adminContact.isBusinessAdmin()||adminContact.isBPAdmin()||adminContact.isOrganizationAdmin()))return service.getCompany(adminContact.company.id).then((function(company){return{companies:[company]}}));var url=service.portalURL+"companies?format="+(format||"full");return organisationId&&(url+="&organisationId="+organisationId),page&&pageSize&&(url+="&offset="+pageSize*(page-1)),pageSize&&(url+="&limit="+pageSize),searchName&&(url+="&name="+encodeURIComponent(searchName)),bpId&&(url+="&bpId="+bpId),status&&(Array.isArray(status)?status.forEach((function(value){url+="&status="+value})):url+="&status="+status),null!=isBP&&(url+="&isBP="+isBP),bpType&&(url+="&bpType="+bpType),offerCanBeSold&&(url+="&offerCanBeSold="+offerCanBeSold),searchReference&&(url+="&externalReference="+encodeURIComponent(searchReference)),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminCompanyService] getCompanies success");var companies=[];data.forEach((function(orgData){var company=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.createFromData(orgData);!angular.isUndefined(noLogo)&&noLogo||_src_services_core_company_service__WEBPACK_IMPORTED_MODULE_2___default.a.getCompanyLogo(company),companies.push(company)})),defered.resolve({companies:companies,limit:response.data.limit,offset:response.data.offset,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanies"))})),defered.promise},service.getAllCompaniesSmall=function(organisationId,bpId,status,isBP,bpType){return service.getAllCompanies(organisationId,bpId,status,isBP,bpType,"small")},service.getAllCompanies=function(organisationId,bpId,status,isBP,bpType,format){return $q((function(resolve,reject){var result;service.getCompanies(organisationId,1,1e3,null,format,bpId,status,isBP,bpType).then((function(response){if(result=response,response.total>response.limit){var totalPages=Math.ceil(response.total/1e3),pages=Array.apply(void 0,_toConsumableArray(Array(totalPages-1)));pages=pages.map((function(__unused,index){return index+2}));for(var chunks=[];pages.length>0;)chunks.push(pages.splice(0,5));return chunks.reduce((function(promiseChain,requests){return promiseChain.then((function(){var promisesArray=requests.map((function(page){return service.getCompanies(organisationId,page,1e3,null,format,bpId,status,isBP,bpType).then((function(next){response.companies=response.companies.concat(next.companies),response.limit+=next.limit}))}));return $q.all(promisesArray)}))}),$q.resolve())}return $q.resolve()})).then((function(){resolve(result)})).catch((function(error){reject(error)}))}))},service.getCompany=function(companyId,format){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"?format="+(format||"full"),headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompany success");var data=response.data.data,company=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.createFromData(data);_src_services_core_company_service__WEBPACK_IMPORTED_MODULE_2___default.a.getCompanyLogo(company),_src_services_core_company_service__WEBPACK_IMPORTED_MODULE_2___default.a.getCompanyBanner(company),resolve(company)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompany"))}))}))},service.getDefaultCompany=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/default",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getDefaultCompany success");var data=response.data.data,company=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.createFromData(data);resolve(company)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getDefaultCompany"))}))}))},service.searchCompanies=function(searchValue){var defered=$q.defer(),searchValueLC=searchValue.toLowerCase();return service.getCompanies().then((function(result){var filteredCompanies=result.companies.filter((function(company){return company.name.toLowerCase().indexOf(searchValueLC)>-1}));defered.resolve(filteredCompanies)})),defered.promise},service.createCompany=function(company){var companyData=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.prune(company,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.userContact),defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:companyData}).then((function(response){$log.info("[adminCompanyService] createCompany success");var newcompany=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.createFromData(response.data.data);$rootScope.$broadcast("ADMIN_COMPANIES_CHANGE"),defered.resolve(newcompany)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createCompany"))})),defered.promise},service.createCompanyEndUser=function(company){var companyData=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.prune(company,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.userContact),defered=$q.defer();return $http({method:"POST",url:config.restServerUrl+"/api/rainbow/enduser/v1.0/companies",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:companyData}).then((function(response){$log.info("[adminCompanyService] createCompany success");var data=response.data.data,newcompany=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.createFromData(data);defered.resolve(newcompany)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createCompanyEndUser"))})),defered.promise},service.updateCompany=function(company){var companyData=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.prune(company,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_3___default.a.userContact),defered=$q.defer();return $http({method:"PUT",url:service.portalURL+"companies/"+company.id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:companyData}).then((function(response){$log.info("[adminCompanyService] updateCompany success");var data=response.data.data,updatedCompany=_src_models_company_model__WEBPACK_IMPORTED_MODULE_4__.Company.createFromData(data);defered.resolve(updatedCompany),$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",company.id)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"updateCompany"))})),defered.promise},service.addVisibility=function(companyId,visibleByCompany){var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies/"+companyId+"/visible-by/"+visibleByCompany,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] addVisibility success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"addVisibility"))})),defered.promise},service.removeVisibility=function(companyId,visibleByCompany){var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/visible-by/"+visibleByCompany,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] removeVisibility success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"removeVisibility"))})),defered.promise},service.getAllSiteCompany=function(companyId){var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"companies/"+companyId+"/sites",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getAllSiteCompany success");var data=response.data.data,sites=[];data.forEach((function(element){var site=Site.createFromData(element);sites.push(site)})),defered.resolve(sites)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getAllSiteCompany"))})),defered.promise},service.getCompanyAdministrators=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/administrators",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanyAdministrators success");var data=response.data.data,adminUsers=[];data.forEach((function(adminUserData){var adminUser={id:adminUserData.id};adminUsers.push(adminUser)})),resolve(adminUsers)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyAdministrators"))}))}))},service.deleteCompany=function(companyId){var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"companies/"+companyId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompany success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteCompany"))})),defered.promise},service.pushLogo=function(companyId,logoImg,shape){return $q((function(resolve,reject){var pushServiceURL=service.portalURL+"companies/"+companyId+"/avatar";(angular.isDefined(logoImg)&&null!==logoImg?pushImageHelperService.pushImage(pushServiceURL,logoImg):$q.resolve()).then((function(){return service.getCompany(companyId)})).then((function(company){return company.avatarShape=shape,service.updateCompany(company)})).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),$log.info("[adminCompanyService] pushLogo success"),resolve()})).catch((function(error){reject(error)}))}))},service.deleteLogo=function(companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/avatar",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),service.getCompany(companyId).then((function(company){return company.avatarShape="circle",service.updateCompany(company)})).then((function(){$log.info("[adminCompanyService] deleteLogo success"),resolve()})).catch((function(error){reject(error)}))}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteLogo"))}))}))},service.pushBanner=function(companyId,bannerImg,params){return $q((function(resolve,reject){var pushServiceURL=service.portalURL+"companies/"+companyId+"/banner";return pushImageHelperService.pushImage(pushServiceURL,bannerImg,params).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),resolve()})).catch((function(error){reject(error)}))}))},service.deleteBanner=function(companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/banner",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$rootScope.$broadcast("ON_COMPANY_CHANGE_EVENT",companyId),$log.info("[adminCompanyService] deleteBanner success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteBanner"))}))}))},service.getCompanySupportBot=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"bots/rainbow-support";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[companyService] getCompanySupportBot success");var supportBot=Bot.create(response.data.data);resolve(supportBot)})).catch((function(response){var errorMessage="getCompanySupportBot failure "+response.data.errorDetails+" with status "+response.status;$log.error("[companyService] "+errorMessage),reject(new Error(errorMessage))}))}))},service.pushCompanyBotAvatar=function(botId,companyId,avatarImg){return $q((function(resolve,reject){var pushServiceURL=service.portalURL+"bots/"+botId+"/companies/"+companyId+"/avatar";(angular.isDefined(avatarImg)&&null!==avatarImg?pushImageHelperService.pushImage(pushServiceURL,avatarImg):$q.resolve()).then((function(){$log.info("[adminCompanyService] pushCompanyBotAvatar success"),resolve()})).catch((function(error){reject(error)}))}))},service.deleteCompanyBotAvatar=function(botId,companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"bots/"+botId+"/companies/"+companyId+"/avatar",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompanyBotAvatar success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[botService] "+errorHelperService.getErrorFullMessage(response,"deleteCompanyBotAvatar"))}))}))},service.getCompanyInvitations=function(companyId,page,pageSize){return $q((function(resolve,reject){var url=service.portalURL+"companies/"+companyId+"/join-companies/invitations?format=medium&status=pending declined&limit="+pageSize;page&&(url+="&offset="+pageSize*(page-1)),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var invitations=[];response.data.data.forEach((function(invitationData){var invitation=CompanyInvitation.createFromData(invitationData);invitations.push(invitation)})),$log.info("[adminCompanyService] getCompanyInvitations success (found "+invitations.length+" invitation(s))"),resolve({invitations:invitations,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyInvitations"))}))}))},service.joinCompanyInvitation=function(companyId,email,invitedUserId,customMessage,invitedToBeCompanyAdmin,invitedToBeBpAdmin){var defered=$q.defer(),data={lang:_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getAppliLanguageCodeForServer()};return customMessage&&(data.customMessage=customMessage),invitedUserId?data.invitedUserId=invitedUserId:email&&(data.email=email),invitedToBeCompanyAdmin&&(data.invitedToBeCompanyAdmin=invitedToBeCompanyAdmin),invitedToBeBpAdmin&&(data.invitedToBeBpAdmin=invitedToBeBpAdmin),$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/invitations",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:data}).then((function(){$log.info("[adminCompanyService] joinCompanyInvitation success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"joinCompanyInvitation"))})),defered.promise},service.cancelJoinCompanyInvitation=function(companyId,invitationId){var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/invitations/"+invitationId+"/cancel",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var invitation=CompanyInvitation.createFromData(response.data.data);$log.info("[adminCompanyService] cancelJoinCompanyInvitation success"),defered.resolve(invitation)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"cancelJoinCompanyInvitation"))})),defered.promise},service.resendJoinCompanyInvitation=function(companyId,invitationId){var defered=$q.defer();return $http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/invitations/"+invitationId+"/re-send",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var invitation=CompanyInvitation.createFromData(response.data.data);$log.info("[adminCompanyService] resendJoinCompanyInvitation success"),defered.resolve(invitation)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"resendJoinCompanyInvitation"))})),defered.promise},service.getCompanyJoinRequests=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/join-companies/requests?format=medium&status=pending",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var companyRequests=[];response.data.data.forEach((function(companyRequestData){var companyRequest=CompanyRequest.createFromData(companyRequestData);companyRequests.push(companyRequest)})),$log.info("[adminCompanyService] getCompanyJoinRequests success (found "+response.data.total+" invitation(s))"),resolve({companyRequests:companyRequests,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyJoinRequests"))}))}))},service.getJoinCompanyRequest=function(companyId,joinCompanyRequestId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/join-companies/requests/"+joinCompanyRequestId+"?status=pending",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var joinCompanyRequest=CompanyRequest.createFromData(response.data.data);$log.info("[adminCompanyService] getJoinCompanyRequest success"),resolve(joinCompanyRequest)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getJoinCompanyRequest"))}))}))},service.acceptCompanyJoinRequests=function(companyId,joinCompanyRequestId){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/requests/"+joinCompanyRequestId+"/accept",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var joinCompanyRequest=CompanyRequest.createFromData(response.data.data);$log.info("[adminCompanyService] acceptCompanyJoinRequests success"),resolve(joinCompanyRequest)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"acceptCompanyJoinRequests")),reject(error)}))}))},service.declineCompanyJoinRequests=function(companyId,joinCompanyRequestId){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/join-companies/requests/"+joinCompanyRequestId+"/decline",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var joinCompanyRequest=CompanyRequest.createFromData(response.data.data);$log.info("[adminCompanyService] declineCompanyJoinRequests success"),resolve(joinCompanyRequest)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"declineCompanyJoinRequests")),reject(error)}))}))},service.getOAuthConsentUrl=function(){var lang=_src_services_core_settings_service__WEBPACK_IMPORTED_MODULE_0___default.a.getAppliLanguage().code;return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/office365/v1.0/consent?callback="+window.location.origin+"/redirectO365.html?provider=o365AD&lang="+lang,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){var consentUrl=response.data.url;$log.info("[adminCompanyService] getOAuthConsentUrl success: "+consentUrl),resolve(consentUrl)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getOAuthConsentUrl")),reject(error)}))}))},service.getCompanyConferenceSettings=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/conferences",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanyConferenceSettings success");var data=response.data.data;resolve(data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyConferenceSettings"))}))}))},service.setCompanyConferenceSettings=function(companyId,confDialOutEnabled){return $q((function(resolve,reject){var conferenceSettingData={confDialOutDisabled:!confDialOutEnabled};$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/conferences",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:conferenceSettingData}).then((function(response){$log.info("[adminCompanyService] setCompanyConferenceSettings success");var data=response.data.data;resolve(data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"setCompanyConferenceSettings"))}))}))},service.getCompanySAMLConfigurationFile=function(companyId){return $q((function(resolve,reject){_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getCompanySAMLConfiguration(companyId).then((function(data){var blob=new Blob([data],{type:"application/xml"});resolve(blob)})).catch((function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanySAMLConfigurationFile"))}))}))},service.createCompanySingleSignOnServerConfig=function(companyId,singleSignOnType,config){return $q((function(resolve,reject){config.type=singleSignOnType,$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/settings/sso",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:config}).then((function(response){$log.info("[adminCompanyService] createCompanySingleSignOnServerConfig success");var updatedConfig=response.data.data;resolve(updatedConfig)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createCompanySingleSignOnServerConfig"))}))}))},service.deleteCompanySingleSignOnServerConfig=function(companyId,singleSignOnType){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/settings/sso/"+singleSignOnType,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompanySingleSignOnServerConfig success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteCompanySingleSignOnServerConfig"))}))}))},service.getCompanySingleSignOnServerConfig=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/sso",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanySingleSignOnServerConfig success");var configArray=response.data.data?response.data.data:response.data;resolve(configArray)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanySingleSignOnServerConfig"))}))}))},service.updateCompanySingleSignOnServerConfig=function(companyId,singleSignOnType,config){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/sso/"+singleSignOnType,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:config}).then((function(response){$log.info("[adminCompanyService] updateCompanySingleSignOnConfig success");var updatedConfig=response.data.data;resolve(updatedConfig)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"updateCompanySingleSignOnConfig"))}))}))},service.getCompanySingleSignOnSAMLOptions=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/sso/SAML/shared-options",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanySingleSignOnSAMLOptions success"),resolve(response.data.data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanySingleSignOnSAMLOptions"))}))}))},service.updateCompanySingleSignOnSAMLOptions=function(companyId,options){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/sso/SAML/shared-options",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:options}).then((function(response){$log.info("[adminCompanyService] updateCompanySingleSignOnSAMLOptions success"),resolve(response.data.data)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"updateCompanySingleSignOnSAMLOptions"))}))}))},service.deleteCompanySingleSignOnSAMLOptions=function(companyId){return $q((function(resolve,reject){$http({method:"DELETE",url:service.portalURL+"companies/"+companyId+"/settings/sso/SAML/shared-options",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(){$log.info("[adminCompanyService] deleteCompanySingleSignOnSAMLOptions success"),resolve()}),(function(response){var error=errorHelperService.handleError(response);404===error.status?(resolve(),$log.info("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteCompanySingleSignOnSAMLOptions"))):(reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"deleteCompanySingleSignOnSAMLOptions")))}))}))},service.getCompanyBpBusinessTypes=function(){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/bpbusinesstypes",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getCompanyBpBusinessTypes success");var config=response.data.data;resolve(config)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getCompanyBpBusinessTypes"))}))}))},service.getVoIPSettingsForCompany=function(companyId){return $q((function(resolve,reject){$http({method:"GET",url:service.portalURL+"companies/"+companyId+"/settings/webrtcs",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader()}).then((function(response){$log.info("[adminCompanyService] getVoIPSettingsForCompany success");var settings=response.data.data;resolve(settings)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"getVoIPSettingsForCompany"))}))}))},service.createVoIPSettingsForCompany=function(companyId,settings){return $q((function(resolve,reject){$http({method:"POST",url:service.portalURL+"companies/"+companyId+"/settings/webrtcs",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:settings}).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createVoIPSettingsForCompany")),reject(error)}))}))},service.updateVoIPSettingsForCompany=function(companyId,settingsId,settings){return $q((function(resolve,reject){$http({method:"PUT",url:service.portalURL+"companies/"+companyId+"/settings/webrtcs/"+settingsId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_1___default.a.getRequestHeader(),data:settings}).then((function(){resolve()}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminCompanyService] "+errorHelperService.getErrorFullMessage(response,"createVoIPSettingsForCompany")),reject(error)}))}))}}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(2),_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0__),_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(31),_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_1__),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1),_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2__),_src_models_company_model__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(19);angular.module("rainbow").service("adminUserService",["$q","$log","$http","errorHelperService","User","Site","Organisation","PhoneNumber",function($q,$log,$http,errorHelperService,User,Site,Organisation,PhoneNumber){var service=this;service.start=function(){return $log.info("[adminUserService] === STARTING ==="),service.portalURL=config.restServerUrl+"/api/rainbow/admin/v1.0/",$log.info("[adminUserService] === STARTED ==="),$q.when()},service.stop=function(){return $log.info("[adminUserService] === STOPPING ==="),$log.info("[adminUserService] === STOPPED ==="),$q.when()},service.getUsersByEmail=function(source,email){return $q((function(resolve,reject){var url=service.portalURL+"users?format=full";source&&source instanceof Organisation&&(url+="&organisationId="+source.id),source&&source instanceof _src_models_company_model__WEBPACK_IMPORTED_MODULE_3__.Company&&(url+="&companyId="+source.id),source&&source instanceof Site&&(url+="&siteId="+source.id),email&&(url+="&email="+encodeURIComponent(email)),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminUserService] getUsersByEmail success (find "+response.data.total+" user(s))");var users=[];data.forEach((function(userData){var user=User.createFromData(userData);users.push(user)})),resolve({users:users,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUsersByEmail"))}))}))},service.getUsers=function(source,page,pageSize,searchPattern,isTerminated,isAdministrator,noDefaultValues,searchByTag,isActivated){return $q((function(resolve,reject){var url=service.portalURL+"users?format=full&limit="+pageSize;"string"==typeof source&&(url+="&companyId="+source),source&&source instanceof _src_models_company_model__WEBPACK_IMPORTED_MODULE_3__.Company&&(url+="&companyId="+source.id),source&&source instanceof Organisation&&(url+="&organisationId="+source.id),source&&source instanceof Site&&(url+="&siteId="+source.id),page&&(url+="&offset="+pageSize*(page-1)),searchPattern&&!searchByTag&&(url+="&displayName="+encodeURIComponent(searchPattern)+"&useEmails=true"),searchPattern&&searchByTag&&(url+="&tags="+encodeURIComponent(searchPattern)),null!=isTerminated&&(url+="&isTerminated="+isTerminated),isAdministrator&&(url+="&roles=admin&roles=bp_admin&roles=bp_finance&roles=superadmin&roles=business_admin"),angular.isDefined(isActivated)&&(url+="&isActivated="+isActivated),$http({method:"GET",url:url+="&sortField=reverseDisplayName",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminUserService] getUsers success (find "+response.data.total+" user(s))");var users=[];data.forEach((function(userData){var user=User.createFromData(userData,noDefaultValues);users.push(user)})),resolve({users:users,limit:response.data.limit,offset:response.data.offset,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUsers"))}))}))},service.searchUsers=function(source,page,pageSize,searchPattern){return $q((function(resolve,reject){var url=config.restServerUrl+"/api/rainbow/search/v1.0/users?limit="+pageSize;source&&(url+="&companyId="+source.id),page&&(url+="&offset="+pageSize*(page-1)),searchPattern&&(url+="&displayName="+encodeURIComponent(searchPattern)),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){var data=response.data.data;$log.info("[adminUserService] searchUsers success (find "+response.data.total+" user(s))");var users=[];data.forEach((function(userData){var user=User.createFromData(userData);users.push(user)})),resolve({users:users,total:response.data.total})}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"searchUsers"))}))}))},service.getUser=function(userId){var defered=$q.defer();return $http({method:"GET",url:service.portalURL+"users/"+userId,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){$log.info("[adminUserService] getUser success");var data=response.data.data,user=User.createFromData(data);defered.resolve(user)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUser"))})),defered.promise},service.createUser=function(user,options){var userData=User.prune(user,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact),url=service.portalURL+"users";options&&null!=options.sendInvitationEmail&&(url+="?sendInvitationEmail="+options.sendInvitationEmail);var defered=$q.defer();return $http({method:"POST",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader(),data:userData}).then((function(response){var newuser=User.createFromData(response.data.data);$log.info("[adminUserService] createUser success"),defered.resolve(newuser)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"createUser"))})),defered.promise},service.deleteUser=function(user){var defered=$q.defer();return $http({method:"DELETE",url:service.portalURL+"users/"+user.id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(){$log.info("[adminUserService] deleteUser success"),defered.resolve()}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"deleteUser"))})),defered.promise},service.updateUser=function(user){var userData=User.prune(user,_src_services_core_contact_service__WEBPACK_IMPORTED_MODULE_2___default.a.userContact),defered=$q.defer();return $http({method:"PUT",url:service.portalURL+"users/"+user.id,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader(),data:userData}).then((function(response){$log.info("[adminUserService] updateUser success");var updateduser=User.createFromData(response.data.data);defered.resolve(updateduser)}),(function(response){var error=errorHelperService.handleError(response);defered.reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"updateUser"))})),defered.promise},service.getUserAvatar=function(user){var color=_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_1___default.a.computeUserColor(user.firstName+" "+user.lastName).color;user.image=_src_services_core_userInfo_service__WEBPACK_IMPORTED_MODULE_1___default.a.getAvatarImage(user.id,user.initials,color,50,user.lastAvatarUpdateDate)},service.expandTelephonyInfo=function(user){var result={};return user.phoneNumbers&&user.phoneNumbers.forEach((function(phoneNumber){var number=phoneNumber.number,numberCan=phoneNumber.numberE164,deviceType=phoneNumber.deviceType;switch(phoneNumber.type){case"work":"landline"===deviceType&&(phoneNumber.isCloudPbxDDI||phoneNumber.isOxoPbxDDI?(result.phonePro=phoneNumber.number,result.phoneProCan=phoneNumber.numberE164,result.phoneProDdiNumber=PhoneNumber.createFromData(phoneNumber)):result.phoneProNumber&&result.phoneProNumber.systemId||(result.phoneProDdiNumber||(result.phonePro=number,result.phoneProCan=numberCan),result.phoneProExt=phoneNumber.shortNumber,result.phoneProIsMonitored=phoneNumber.isMonitored,result.phoneProNumber=PhoneNumber.createFromData(phoneNumber))),"mobile"===deviceType&&(result.mobilePro=number,result.mobileProCan=numberCan);break;case"home":"landline"===deviceType&&(result.phonePerso=number,result.phonePersoCan=numberCan),"mobile"===deviceType&&(result.mobilePerso=number,result.mobilePersoCan=numberCan);break;case"rainbow":result.rainbowPhoneNumber=number}})),result},service.getAllUsers=function(source,noDefaultValues){return $q((function(resolve,reject){var result;service.getUsers(source,1,1e3,void 0,void 0,void 0,noDefaultValues).then((function(response){if(result=response,response.total>response.limit){var totalPages=Math.ceil(response.total/1e3),pages=Array.apply(null,Array(totalPages-1));pages=pages.map((function(__unused,index){return index+2}));for(var chunks=[];pages.length>0;)chunks.push(pages.splice(0,5));return chunks.reduce((function(promiseChain,requests){return promiseChain.then((function(){var promisesArray=requests.map((function(page){return service.getUsers(source,page,1e3,void 0,void 0,void 0,noDefaultValues).then((function(data){result.users=result.users.concat(data.users),result.limit+=data.limit}))}));return $q.all(promisesArray)}))}),$q.resolve())}})).then((function(){resolve(result)})).catch((function(error){reject(error)}))}))},service.getUserTags=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){var tags=response.data.data.tags||[];$log.info("[adminUserService] getUserTags success (find "+tags.length+"tags(s))"),resolve(tags)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUserTags"))}))}))},service.getTagsStats=function(companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags/stats";companyId&&(url+="?companyId="+companyId),$http({method:"GET",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){var tagsStats=response.data.data.stats||[];$log.info("[adminUserService] getTagsStats success (find "+tagsStats.length+"tags(s))"),resolve(tagsStats)}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getTagsStats"))}))}))},service.renameTag=function(tag,newTagName,companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags?tag="+encodeURIComponent(tag);companyId&&(url+="&companyId="+companyId),$http({method:"PUT",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader(),data:{newTagName:newTagName}}).then((function(response){$log.info("[adminUserService] renameTag success => old tag: "+tag+" => new tag: "+newTagName+": found "+response.data.data.found+" occurence(s)"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"renameTag"))}))}))},service.deleteTag=function(tag,companyId){return $q((function(resolve,reject){var url=service.portalURL+"users/tags?tag="+encodeURIComponent(tag);companyId&&(url+="&companyId="+companyId),$http({method:"DELETE",url:url,headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){$log.info("[adminUserService] deleteTag success (tag "+tag+": found "+response.data.data.found+" occurence(s)"),resolve()}),(function(response){var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"deleteTag"))}))}))},service.getUserProfilesFeatures=function(userId){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/admin/v1.0/users/"+userId+"/profiles/features",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){var features={};response.data.data.forEach((function(featureData){$log.debug("[adminUserService] getUserProfilesFeatures === response ==="+JSON.stringify(featureData)),featureData.hasOwnProperty("featureUniqueRef")&&(features[featureData.featureUniqueRef]=featureData)})),resolve(features)}),(function(response){if(404===response.status)$log.debug("[adminUserService] getUserProfilesFeatures : features found for user: "+userId),resolve();else{var error=errorHelperService.handleError(response);reject(error),$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUserProfilesFeatures"))}}))}))},service.getUserPresenceInformation=function(userId){return $q((function(resolve,reject){$http({method:"GET",url:config.restServerUrl+"/api/rainbow/admin/v1.0/users/"+userId+"/presences",headers:_src_services_core_auth_service__WEBPACK_IMPORTED_MODULE_0___default.a.getRequestHeader()}).then((function(response){$log.debug("[adminUserService] getUserPresenceInformation for user Id "+userId+" === response === "+JSON.stringify(response.data.data));var resources={};response.data.data.jid_im.forEach((function(presence){resources[presence.resource]={},resources[presence.resource].show=presence.show?presence.show:"online",resources[presence.resource].status=presence.status?presence.status:"",resources[presence.resource].stamp=presence.date,resources[presence.resource].type="jid_im"})),response.data.data.jid_tel.forEach((function(presence){"calendar"!==presence.resource&&(resources[presence.resource]={},resources[presence.resource].show=presence.show?presence.show:"online",resources[presence.resource].stamp=presence.date,resources[presence.resource].type="phone")}));var result=service.calculatePresenceFromUserResources(resources);resolve(result)}),(function(response){var error=errorHelperService.handleError(response);$log.error("[adminUserService] "+errorHelperService.getErrorFullMessage(response,"getUserPresenceInformation")),reject(error)}))}))},service.calculatePresenceFromUserResources=function(resources){var on_the_phone=!1,manual_invisible=!1,manual_dnd=!1,manual_away=!1,in_presentation_mode=!1,in_webrtc_mode=!1,webrtc_reason="",is_online=!1,is_online_mobile=!1,auto_away=!1,presence="offline",status="";for(var key in resources)if(resources.hasOwnProperty(key)){var resource=resources[key];"phone"!==resource.type?"xa"===resource.show&&""===resource.status?manual_invisible=!0:"dnd"===resource.show&&""===resource.status?manual_dnd=!0:"xa"===resource.show&&"away"===resource.status?manual_away=!0:"dnd"===resource.show&&"presentation"===resource.status?in_presentation_mode=!0:"dnd"===resource.show&&resource.status?(in_webrtc_mode=!0,webrtc_reason=resource.status):""!==resource.show&&"online"!==resource.show||""!==resource.status&&"mode=auto"!==resource.status?"away"===resource.show&&""===resource.status&&(auto_away=!0):-1!==key.indexOf("mobile_")?is_online_mobile=!0:is_online=!0:on_the_phone="EVT_SERVICE_INITIATED"===resource.status||"EVT_ESTABLISHED"===resource.status}return on_the_phone?(presence="busy",status="phone"):manual_invisible?(presence="xa",status=""):manual_dnd?(presence="dnd",status=""):manual_away?(presence="away",status=""):in_presentation_mode?(presence="dnd",status="presentation"):in_webrtc_mode?(presence="busy",status=webrtc_reason):is_online?(presence="online",status=""):is_online_mobile?(presence="online-mobile",status=""):auto_away&&(presence="away",status=""),{presence:presence,status:status}}}])},function(module,exports){angular.module("rainbow").filter("emojione",(function(){return function(input){return input}})),angular.module("rainbow").filter("emojiUnicodeToShort",(function(){return function(input){return input}})),angular.module("rainbow").filter("emojiShortToUnicode",(function(){return function(input){return input}}))},function(module,exports){angular.module("rainbow").service("centralizedService",(function(){})),angular.module("rainbow").service("translateService",(function(){}))},function(module,exports){angular.module("rainbow").factory("TransfertPromiseQueue",["$log","$q",function($log,$q){function TransfertPromiseQueue(){var that=this;that.fileQueue=[],that.clearContext=function(){that.currentId=null,that.currentQueue=[],that.promiseCompletion=void 0,that.promiseReject=void 0,that.initialQueueSize=0,that.promisesDone=0,that.chunkErrorCounter=0,that.currentPromise=void 0},that.clearContext(),that.addPromiseArray=function(id,promiseArray,promiseCompletion,promiseReject){$log.debug("[TransfertPromiseQueue] adding promiseArray");var promiseInfos={};return promiseInfos.id=id,promiseInfos.promiseArray=promiseArray,promiseInfos.promiseCompletion=promiseCompletion,promiseInfos.promiseReject=promiseReject,0!==that.fileQueue.length||that.currentPromise?(that.fileQueue.push(promiseInfos),$log.debug("[TransfertPromiseQueue] adding PromiseArray in FileQueue: "+that.fileQueue.length)):($log.debug("[TransfertPromiseQueue] configuring file to transfert: "+promiseInfos.promiseArray.length),that.fileQueue.push(promiseInfos),that.popFileQueue()),$log.debug("[TransfertPromiseQueue] adding promise on FileQueue: "+that.fileQueue.length),$q},that.popFileQueue=function(){if(that.fileQueue.length>0){$log.debug("[TransfertPromiseQueue] go to next file");var promiseInfos=that.fileQueue.shift();that.currentId=promiseInfos.id,that.currentQueue=promiseInfos.promiseArray,that.promiseCompletion=promiseInfos.promiseCompletion,that.promiseReject=promiseInfos.promiseReject,that.initialQueueSize=that.currentQueue.length,that.promisesDone=0,that.chunkErrorCounter=0,that.currentPromise=[];for(var counter=0;counter<10&&that.currentQueue.length>0;counter++)that.currentPromise.push(that.currentQueue.shift()());that.execute()}else $log.debug("[TransfertPromiseQueue] no more file to transfert"),that.clearContext()},that.execute=function(){$log.debug("[TransfertPromiseQueue] execute"),that.currentPromise?$q.all(that.currentPromise).then((function(){if($log.debug("[TransfertPromiseQueue] promise success go to next one"),that.chunkErrorCounter=0,0===that.currentQueue.length)that.promiseCompletion&&that.promiseCompletion(),that.popFileQueue();else{that.currentPromise=[];for(var counter=0;counter<10&&that.currentQueue.length>0;counter++)that.currentPromise.push(that.currentQueue.shift()());that.execute()}})).catch((function(error){var errorMessage=error&&error.message?error.message:"Unknown error";if($log.error("[TransfertPromiseQueue] failure executing promise -- "+errorMessage),that.chunkErrorCounter++,error&&error.errorDetailsCode>=500&&that.chunkErrorCounter<=3&&that.currentPromise){var oldPromises=that.currentPromise;that.currentPromise=[],oldPromises.forEach((function(promise){that.currentPromise.push(promise())})),that.execute()}else $log.error("[TransfertPromiseQueue] 3 chunk failed - ABORT File Upload"),that.promiseReject(error),that.popFileQueue()})):($log.debug("[TransfertPromiseQueue] no promise to perform"),that.currentPromise=void 0)},that.isTransferInProgress=function(){return $log.debug("[TransfertPromiseQueue] >isTransferInProgress: "+that.fileQueue.length+"/"+that.currentQueue.length),that.fileQueue.length>0||that.currentQueue.length>0||that.currentPromise},that.cancelAllTransfers=function(){$log.debug("[TransfertPromiseQueue] cancelAllTransfers"),that.fileQueue=[],that.currentQueue=[]},that.cancelCurrentFiletransfer=function(id){if($log.debug("[TransfertPromiseQueue] cancelCurrentFiletransfer"),that.currentId===id)$log.debug("[TransfertPromiseQueue] cancelling current promise"),that.popFileQueue();else{var promiseFound=that.fileQueue.find((function(currentPromiseInfos){return currentPromiseInfos.id===id}));if(promiseFound){var promisePos=that.fileQueue.indexOf(promiseFound);$log.debug("[TransfertPromiseQueue] promise to remove at position="+promisePos),that.fileQueue.splice(promisePos,1)}}}}return TransfertPromiseQueue.create=function(){return $log.debug("[TransfertPromiseQueue] >create"),new TransfertPromiseQueue},TransfertPromiseQueue}])},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),window.sdk=angular.module("sdk",["pascalprecht.translate","ngSanitize","ngFileSaver","rainbow","rainbowAdmin"],(function(){})),__webpack_exports__.default={sdk:sdk}},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _sdkConfig__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(38);sdk.remoteConsole={debug:!1,log:!1,info:!1,warn:!1,error:!1},sdk.hasVerboseLog=!1,sdk.hasBeenLaunchedFromConfig=!1,sdk.key={appID:"",appSecret:"",host:"openrainbow.com"},sdk.config(["consoleLogsProvider","$provide","$httpProvider","$translateProvider",function(consoleLogsProvider,$provide,$httpProvider,$translateProvider){var utc=function(now){return now.toDateString()+" "+("0"+now.getHours()).slice(-2)+":"+("0"+now.getMinutes()).slice(-2)+":"+("0"+now.getSeconds()).slice(-2)};$provide.decorator("$log",["$delegate",function($delegate){var origDebug=$delegate.debug;$delegate.debug=function(){var args=[].slice.call(arguments);sdk.remoteConsole.debug&&console.re.debug(args[0]),_sdkConfig__WEBPACK_IMPORTED_MODULE_0__.sdkConfig.verboseLog&&origDebug.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"debug : "+args+"\n")};var origLog=$delegate.log;$delegate.log=function(){var args=[].slice.call(arguments);sdk.remoteConsole.log&&console.re.log(args[0]),_sdkConfig__WEBPACK_IMPORTED_MODULE_0__.sdkConfig.verboseLog&&origLog.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"log : "+args+"\n")};var origInfo=$delegate.info;$delegate.info=function(){var args=[].slice.call(arguments);sdk.remoteConsole.info&&console.re.info(args[0]),_sdkConfig__WEBPACK_IMPORTED_MODULE_0__.sdkConfig.verboseLog&&origInfo.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"info : "+args+"\n")};var origWarn=$delegate.warn;$delegate.warn=function(){var args=[].slice.call(arguments);sdk.remoteConsole.warn&&console.re.warn(args[0]),origWarn.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"warn : "+args+"\n")};var origError=$delegate.error;return $delegate.error=function(){var args=[].slice.call(arguments);sdk.remoteConsole.error&&console.re.error(args[0]),origError.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+"error : "+args+"\n")},$delegate.webrtc=function(){var args=[].slice.call(arguments),logs="rtcweb : "+args[0];args[0]="%c "+utc(new Date)+" | RTCWEB | "+args[0],args[args.length]="color:green",sdk.remoteConsole.log&&console.re.log(args[0]),origDebug.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+logs+"\n")},$delegate.sdk=function(){var args=[].slice.call(arguments),logs="RBW-SDK : "+args[0];args[0]="%c "+utc(new Date)+" | RBW-SDK | "+args[0],args[args.length]="color:green",sdk.remoteConsole.log&&console.re.log(args[0]),origDebug.apply(null,args),consoleLogsProvider.setLogs(["["+utc(new Date)+"]"]+logs+"\n")},$delegate}]),$httpProvider.defaults.useXDomain=!0,$translateProvider.useSanitizeValueStrategy(null)}]),sdk.run([function(){}]),sdk.provider("consoleLogs",[function(){this.logsBuffer=[],this.logsMaxLength=2e6,this.$get=function(){var logsBuffer=this.logsBuffer;return{getLogs:function(){return logsBuffer}}},this.cleanBuffer=function(){this.logsBuffer.length>this.logsMaxLength&&(this.logsBuffer=this.logsBuffer.slice(-this.logsMaxLength))},this.setLogs=function(logs){1e3===this.logsBuffer&&this.logsBuffer.shift(),this.logsBuffer.push(logs)}}])},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Invitation=void 0;const userInfo_service_1=__webpack_require__(31);class Invitation{constructor(id,invitedUserId,invitedUserEmail,invitingUserId,invitingUserEmail,requestNotificationLanguage,invitingDate,lastNotificationDate,status,type,inviteToJoinMeeting,invitedPhoneNumber=null){this.id=id,this.invitedUserId=invitedUserId,this.invitedUserEmail=invitedUserEmail,this.invitedPhoneNumber=invitedPhoneNumber,this.invitingUserId=invitingUserId,this.invitingUserEmail=invitingUserEmail,this.requestNotificationLanguage=requestNotificationLanguage,this.invitingDate=invitingDate,this.lastNotificationDate=lastNotificationDate,this.status=status,this.type=type,this.defaultAvatar=null,this.inviteToJoinMeeting=inviteToJoinMeeting}static create(id,invitedUserId,invitedUserEmail,invitingUserId,invitingUserEmail,requestNotificationLanguage,invitingDate,lastNotificationDate,status,type,inviteToJoinMeeting){return new Invitation(id,invitedUserId,invitedUserEmail,invitingUserId,invitingUserEmail,requestNotificationLanguage,invitingDate,lastNotificationDate,status,type,inviteToJoinMeeting)}static createFromData(invitationData){const invitation=new Invitation(invitationData.id,invitationData.invitedUserId,invitationData.invitedUserEmail,invitationData.invitingUserId,invitationData.invitingUserEmail,invitationData.requestNotificationLanguage,invitationData.invitingDate,invitationData.lastNotificationDate,invitationData.status,invitationData.type,invitationData.inviteToJoinMeeting,invitationData.invitedPhoneNumber);return invitation.createDefaultAvatar(),invitation}createDefaultAvatar(){if(!this.defaultAvatar&&this.invitedUserEmail){const color=userInfo_service_1.default.computeUserColor(this.invitedUserEmail),initials=this.invitedUserEmail.substring(0,2).toUpperCase();this.defaultAvatar=userInfo_service_1.default.createDefaultAvatarImage(initials,color)}}}exports.Invitation=Invitation},function(module,exports,__webpack_require__){"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Office365AdService=void 0;const logger_service_1=__webpack_require__(15),event_service_1=__webpack_require__(32),company_model_1=__webpack_require__(19),crypto_js_1=__webpack_require__(18),auth_service_1=__webpack_require__(2),main_service_1=__webpack_require__(26),userInfo_service_1=__webpack_require__(31),profile_service_1=__webpack_require__(8),contact_service_1=__webpack_require__(1);class Office365AdService{constructor(){this.isOffice365AdSearchAllowed=!1,this.isOffice365ContactSearchAllowed=!1,this.url=config.restServerUrl+"/api/rainbow/office365/v1.0/users",this.companies={},this.eventService=event_service_1.default,this.logger=logger_service_1.default,this.authService=auth_service_1.default,this.mainService=main_service_1.default,this.userInfoService=userInfo_service_1.default,this.profileService=profile_service_1.default,this.contactService=contact_service_1.default,this.isOffice365AdSearchAllowed=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.MSO365_DIRECTORY_SEARCH),this.isOffice365ContactSearchAllowed=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.MSO365_CONTACT_SEARCH)}static getInstance(){const win=window;return win.rainbow||(win.rainbow={}),win.rainbow.office365AdService||(win.rainbow.office365AdService=new Office365AdService),win.rainbow.office365AdService}search(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(!this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.MSO365_CONTACT_SEARCH))return[];this.logger.info("search office365 Contact from Ad with pattern "+searchPattern);try{const headers=this.authService.getPostHeader();let responseData;responseData=this.profileService.isFeatureEnabled(this.profileService.FeaturesEnum.SEARCH_BY_TAGS)?yield fetch(this.url+"/search",{method:"POST",mode:"cors",headers:headers,body:JSON.stringify({search:searchPattern,includeContacts:this.isOffice365ContactSearchAllowed})}):yield fetch(this.url+"/search",{method:"POST",mode:"cors",headers:headers,body:JSON.stringify({name:searchPattern,includeContacts:this.isOffice365ContactSearchAllowed})});const office365ContactsData=(yield responseData.json()).data;return office365ContactsData.map(office365ContactData=>{const contact=this.contactService.createBasicContact(office365ContactData.oid,null,!1);return this.updateContactWithData(contact,office365ContactData),contact})}catch(error){return this.logger.error(`search office365 Contact from Ad with pattern ${searchPattern} --- FAILURE --- ${error.message}`),[]}}))}searchCompanies(searchPattern){return __awaiter(this,void 0,void 0,(function*(){if(!this.isOffice365AdSearchAllowed)return[];this.logger.info("search office365 Company from Ad with pattern "+searchPattern);try{const headers=this.authService.getPostHeader(),responseData=yield fetch(this.url+"/search",{method:"POST",mode:"cors",headers:headers,body:JSON.stringify({companyName:searchPattern,includeContacts:!1})}),office365CompaniesData=(yield responseData.json()).data;return office365CompaniesData.map(office365CompanyData=>{const company=company_model_1.Company.create(office365CompanyData.oid,office365CompanyData.companyName);return this.getCompanyLogo(company),this.getCompanyBanner(company),this.companies[company.id]=company,company})}catch(error){return this.logger.error(`search office365 Company from Ad with pattern ${searchPattern} --- FAILURE --- ${error.message}`),[]}}))}getCompanyLogo(company){return __awaiter(this,void 0,void 0,(function*(){try{const companyColor=this.userInfoService.computeUserColor(company.name),companyInitials=company.name.substr(0,1);return company.logo=this.userInfoService.getAvatarImage(company.id,companyInitials,companyColor.color,130,company.lastAvatarUpdateDate),this.eventService.publish("ON_COMPANY_LOGO_UPDATED",company.id),this.logger.info("[getCompanyLogo] - "+company.getNameForLogs()+" - success"),company.sendChangeEvent("logo"),company}catch(error){throw new Error("getCompanyLogo -- FAILURE -- "+error.message)}}))}getCompanyBanner(company){return __awaiter(this,void 0,void 0,(function*(){return new Promise(resolve=>{const image=new Image;image.onload=()=>{company.banner=image,this.eventService.publish("ON_COMPANY_BANNER_UPDATED",company.id),this.logger.info("[getCompanyBanner] - "+company.getNameForLogs()+" - success"),resolve(company)},image.onerror=()=>{this.logger.error("[companyService] Load banner for "+company.getNameForLogs()+" failure"),resolve(company)};let imgSrc="/cacheV2/images/company-banner-01.svg";if(company.lastBannerUpdateDate){let serverURL=config.webservices.protocol+"://"+config.webservices.currentServer;this.mainService.cdn&&(serverURL=this.mainService.cdnServer),imgSrc=serverURL+"/api/banner/"+company.id+"?size=831",imgSrc+="&update="+crypto_js_1.MD5(crypto_js_1.CryptoJSEnc.Latin1.parse(company.lastBannerUpdateDate)).toString(crypto_js_1.CryptoJSEnc.Hex)}image.src=imgSrc})}))}getCompanyById(companyId){if(!companyId)throw new Error("missing companyId");const company=this.companies[companyId];return this.logger.info("[office365adService] getCompanyById (cache) "+companyId+" - success"),company}getUserDetails(contact){return __awaiter(this,void 0,void 0,(function*(){if(this.isOffice365AdSearchAllowed&&contact.o365Flag){this.logger.info("getUserDetails for "+contact.oid);try{const headers=this.authService.getRequestHeader(),url=`${this.url}/details/${encodeURIComponent(contact.id)}`,responseData=yield fetch(url,{method:"GET",mode:"cors",headers:headers});if(!responseData.ok)throw this.logger.debug(`Request ${responseData.headers.get("x-rainbow-request-id")} failed with status ${responseData.status}`),new Error(responseData.statusText);const office365ContactData=yield responseData.json();this.updateContactWithOffice365Data(contact,office365ContactData)}catch(error){this.logger.error("getUserDetails -- FAILURE -- "+error.message)}}}))}updateContactWithData(contact,data){contact.o365Flag=!0,contact.updateName(data.firstName,data.lastName),contact.companyName=this.contactService.userContact.company.name,contact.jobTitle=data.jobTitle,contact.department=data.department,contact.webAddress=data.mySite,contact.mobilePhones=data.mobilePhonesE164,contact.businessPhones=data.businessPhonesE164,contact.email=data.mail,contact.isContact=data.isContact}updateContactWithOffice365Data(contact,data){contact.o365Flag=!0,contact.updateName(data.givenName,data.surname),contact.companyName=this.contactService.userContact.company.name,contact.jobTitle=data.jobTitle,contact.department=data.department,contact.webAddress=data.mySite,contact.email=data.mail,contact.isContact?(contact.street=data.addresses[0]&&data.addresses[0].street?data.addresses[0].street:"",contact.city=data.addresses[0]&&data.addresses[0].city?data.addresses[0].city:"",contact.country=data.addresses[0]&&data.addresses[0].countryOrRegion?data.addresses[0].countryOrRegion:"",contact.postCode=data.addresses[0]&&data.addresses[0].postalCode?data.addresses[0].postalCode:"",contact.state=data.addresses[0]&&data.addresses[0].state?data.addresses[0].state:""):(contact.street=data.streetAddress,contact.city=data.city,contact.country=data.country,contact.postCode=data.postalCode,contact.state=data.state)}}exports.Office365AdService=Office365AdService,exports.default=Office365AdService.getInstance()},function(module,exports){Strophe.addNamespace("RSM","http://jabber.org/protocol/rsm"),Strophe.RSM=function(options){if(this.attribs=["max","first","last","after","before","index","count"],void 0!==options.xml)this.fromXMLElement(options.xml);else for(var ii=0;ii<this.attribs.length;ii++){var attrib=this.attribs[ii];this[attrib]=options[attrib]}},Strophe.RSM.prototype={toXML:function(){for(var xml=$build("set",{xmlns:Strophe.NS.RSM}),ii=0;ii<this.attribs.length;ii++){var attrib=this.attribs[ii];void 0!==this[attrib]&&(xml=xml.c(attrib).t(this[attrib].toString()).up())}return xml.tree()},next:function(max){return new Strophe.RSM({max:max,after:this.last})},previous:function(max){return new Strophe.RSM({max:max,before:this.first})},fromXMLElement:function(xmlElement){for(var ii=0;ii<this.attribs.length;ii++){var attrib=this.attribs[ii],elem=xmlElement.getElementsByTagName(attrib)[0];null!=elem&&(this[attrib]=Strophe.getText(elem),"first"==attrib&&(this.index=elem.getAttribute("index")))}}}},function(module,exports){Strophe.addConnectionPlugin("ping",{_c:null,init:function(conn){this._c=conn,Strophe.addNamespace("PING","urn:xmpp:ping")},ping:function(jid,success,error,timeout){var id=this._c.getUniqueId("ping"),iq=$iq({type:"get",to:jid,id:id}).c("ping",{xmlns:Strophe.NS.PING});this._c.sendIQ(iq,success,error,timeout)},pong:function(ping){var from=ping.getAttribute("from"),id=ping.getAttribute("id"),iq=$iq({type:"result",to:from,id:id});this._c.sendIQ(iq)},addPingHandler:function(handler){return this._c.addHandler(handler,Strophe.NS.PING,"iq","get")}})},function(module,exports){!function(){"use strict";Strophe.addConnectionPlugin("lastactivity",{_c:null,_n:0,init:function(conn){this._c=conn,Strophe.addNamespace("LAST_ACTIVITY","jabber:iq:last")},query:function(jid,options){var attr={type:"get",id:"lastActivityId"+this._n++,from:this._c.jid,to:jid},lastActivityAttr={xmlns:Strophe.NS.LAST_ACTIVITY},iq=$iq(attr).c("query",lastActivityAttr),onResponse=options.onResponse;return delete options.onResponse,this._c.addHandler(null,Strophe.NS.LAST_ACTIVITY,"message",null),this._c.sendIQ(iq,onResponse)}})}()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _RainbowLogger__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(9);Strophe.addConnectionPlugin("jingle",{connection:null,sessions:{},jid2session:{},ice_config:{iceServers:[]},company_config:{},pc_constraints:{rtcpMuxPolicy:"require",bundlePolicy:"max-bundle"},media_constraints:{},localStream:null,connectionRef:null,jingleIqTimeout:15e3,init:function(conn){for(var key in this.connection=conn,this.connection.disco&&(this.connection.disco.addFeature("urn:xmpp:jingle:1"),this.connection.disco.addFeature("urn:xmpp:jingle:apps:rtp:1"),this.connection.disco.addFeature("urn:xmpp:jingle:transports:ice-udp:1"),this.connection.disco.addFeature("urn:xmpp:jingle:apps:rtp:audio"),this.connection.disco.addFeature("urn:xmpp:jingle:apps:rtp:video"),this.connection.disco.addFeature("urn:ietf:rfc:5761")),this.connectionRef&&(this.connection.deleteHandler(this.connectionRef),this.connectionRef=null),config&&config.jingleIqTimeout?this.jingleIqTimeout=config.jingleIqTimeout:this.jingleIqTimeout=15e3,this.connectionRef=this.connection.addHandler(this.onJingle.bind(this),"urn:xmpp:jingle:1","iq","set",null,null),this.sessions)if(this.sessions.hasOwnProperty(key)){var session=this.sessions[key];session.connection=this.connection,null!==session.statsinterval&&(window.clearInterval(session.statsinterval),session.statsinterval=null)}},attachHandlers:function(){this.connectionRef&&(this.connection.deleteHandler(this.connectionRef),this.connectionRef=null),this.connectionRef=this.connection.addHandler(this.onJingle.bind(this),"urn:xmpp:jingle:1","iq","set",null,null)},onJingle:function(iq){_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] onJingle");try{var sid=$(iq).find("jingle").attr("sid"),action=$(iq).find("jingle").attr("action"),ack=$iq({type:"result",to:iq.getAttribute("from"),id:iq.getAttribute("id")}),sess=this.sessions[sid];if("session-initiate"!=action){if(null==sess)return ack.type="error",ack.c("error",{type:"cancel"}).c("item-not-found",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up().c("unknown-session",{xmlns:"urn:xmpp:jingle:errors:1"}),this.connection.send(ack),$(document).trigger("callterminated.jingle",[sid]),!0;if(Strophe.getBareJidFromJid(iq.getAttribute("from"))!=Strophe.getBareJidFromJid(sess.peerjid))return console.warn("[Strophe.jingle] jid mismatch for session id",sid,iq.getAttribute("from"),sess.peerjid),ack.type="error",ack.c("error",{type:"cancel"}).c("item-not-found",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up().c("unknown-session",{xmlns:"urn:xmpp:jingle:errors:1"}),this.connection.send(ack),!0}else if(void 0!==sess)return ack.type="error",ack.c("error",{type:"cancel"}).c("service-unavailable",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up(),console.warn("[Strophe.jingle] duplicate session id",sid),this.connection.send(ack),!0;switch("transport-replace"!==action&&this.connection.send(ack),action){case"session-initiate":var remoteType=$(iq).find("jingle").attr("localType");_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || "+remoteType),(sess=new JingleSession($(iq).attr("to"),$(iq).find("jingle").attr("sid"),this.connection,this.jingleIqTimeout)).media_constraints=this.media_constraints,sess.pc_constraints=this.pc_constraints,sess.ice_config=this.ice_config,sess.company_config=this.company_config,this.jid2session[$(iq).attr("from")]&&this.jid2session[$(iq).attr("from")].unifiedPlan&&(sess.unifiedPlanActivated=!0),sess.initiate($(iq).attr("from"),!1),sess.remoteType=remoteType,sess.confId=$(iq).find("jingle").attr("confId"),sess.publisherId=$(iq).find("conference").attr("publisherId");var conference_id=$(iq).find("conference").attr("id");conference_id&&(sess.conference_id=conference_id),sess.setRemoteDescription($(iq).find(">jingle"),"offer"),this.sessions[sess.sid]=sess,this.jid2session[sess.peerjid]=sess,$(document).trigger("callincoming.jingle",[sess.sid]);break;case"transport-replace":sess.isReconnecting=!0,_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[strophe jingle] Transport replace");remoteType=$(iq).find("jingle").attr("localType");_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || "+remoteType),sess.media_constraints=this.media_constraints,sess.pc_constraints=this.pc_constraints,sess.ice_config=this.ice_config,sess.company_config=this.company_config,sess.remoteType=remoteType,this.sessions[sess.sid]=sess,this.jid2session[sess.peerjid]=sess,sess.hasSentTransportReplace?(_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[strophe jingle] Transport replace -- put on hold"),sess.saveIncomingTransportReplace($(iq).find(">jingle"),"offer",ack)):(_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[strophe jingle] Transport replace is accepted"),this.connection.send(ack),sess.setRemoteDescription($(iq).find(">jingle"),"offer"),$(document).trigger("transportreplace.jingle",[sess.sid]));break;case"session-accept":sess.setRemoteDescription($(iq).find(">jingle"),"answer");remoteType=$(iq).find(">jingle").attr("localType");sess.remoteType=remoteType,_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || session-accept remoteType "+sess.remoteType),_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || session-accept localType "+sess.localType),sess.accept(),$(document).trigger("callaccepted.jingle",[sess.sid]);break;case"transport-accept":sess.setRemoteDescription($(iq).find(">jingle"),"answer"),sess.isReconnecting=!1;remoteType=$(iq).find(">jingle").attr("localType");sess.remoteType=remoteType,_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || transport-accept remoteType "+sess.remoteType),_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || transport-accept localType "+sess.localType),$(document).trigger("callaccepted.jingle",[sess.sid]);break;case"session-terminate":sess.terminate(),this.terminate(sess.sid),$(iq).find(">jingle>conference").length&&$(iq).find(">jingle>conference").attr("reason")?$(document).trigger("callterminated.jingle",[sess.sid,"multi-device"]):$(iq).find(">jingle>reason").length?$(document).trigger("callterminated.jingle",[sess.sid,$(iq).find(">jingle>reason>:first")[0].tagName,$(iq).find(">jingle>reason>text").text()]):$(document).trigger("callterminated.jingle",[sess.sid]);break;case"transport-info":_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[JINGLE] transport-info"),sess.addIceCandidate($(iq).find(">jingle>content"));break;case"session-info":var affected;$(iq).find('>jingle>ringing[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?$(document).trigger("ringing.jingle",[sess.sid]):$(iq).find('>jingle>mute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?(affected=$(iq).find('>jingle>mute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').attr("name"),$(document).trigger("mute.jingle",[sess.sid,affected])):$(iq).find('>jingle>unmute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?(affected=$(iq).find('>jingle>unmute[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').attr("name"),$(document).trigger("unmute.jingle",[sess.sid,affected])):$(iq).find('>jingle>iceFailed[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?$(document).trigger("remoteIceFailed.jingle",[sess.sid]):$(iq).find('>jingle>hold[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length?$(document).trigger("hold.jingle",[sess.sid]):$(iq).find('>jingle>unhold[xmlns="urn:xmpp:jingle:apps:rtp:info:1"]').length&&$(document).trigger("unhold.jingle",[sess.sid]);break;case"content-add":_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe Jingle] Content-add");var mediaType=$(iq).find(">jingle").attr("mediaType");sess.remoteType=mediaType,_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || content-add remoteType "+sess.remoteType),_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || content-add localType "+sess.localType),sess.setRemoteDescription($(iq).find(">jingle"),"offer"),sess.mediaModified(),$(document).trigger("mediamodified.jingle",[sess.sid,mediaType]);break;case"content-modify":_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe Jingle] Content-modify");mediaType=$(iq).find(">jingle").attr("mediaType");sess.remoteType=mediaType,_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || content-modify remoteType "+sess.remoteType),_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("REMOTE TYPE || content-modify localType "+sess.localType),sess.setRemoteDescription($(iq).find(">jingle"),"offer"),sess.mediaModified(),$(document).trigger("mediamodified.jingle",[sess.sid,mediaType]);break;case"content-remove":_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe Jingle] Content-remove");mediaType=$(iq).find(">jingle").attr("mediaType");sess.remoteType=mediaType,sess.setRemoteDescription($(iq).find(">jingle"),"offer"),sess.mediaModified(!0),$(document).trigger("mediamodified.jingle",[sess.sid,mediaType]);break;case"content-accept":_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe Jingle] Content-accept"),sess.setRemoteDescription($(iq).find(">jingle"),"answer");break;case"addsource":sess.addSource($(iq).find(">jingle>content"));break;case"removesource":sess.removeSource($(iq).find(">jingle>content"));break;default:console.warn("[Strophe.jingle] jingle action not implemented",action)}}catch(error){return console.error("[Strophe.jingle] On Jingle error catch: "+error),!0}return!0},initiate:function(peerjid,myjid,localType,streams,sid,confid,phoneNumber,unifiedPlanActivated){var id=sid||Math.random().toString(36).substr(2,12),sess=new JingleSession(myjid||this.connection.jid,id,this.connection,this.jingleIqTimeout);if(streams&&streams.length)for(var i=0;i<streams.length;i++)sess.localStreams.push(streams[i]);return sess.media_constraints=this.media_constraints,sess.ice_config=this.ice_config,sess.company_config=this.company_config,localType&&(sess.localType=localType),void 0!==confid&&(sess.conference_id=confid),sess.calledNumber=phoneNumber&&""!==phoneNumber?phoneNumber:null,unifiedPlanActivated&&(sess.unifiedPlanActivated=!0),sess.initiate(peerjid,!0),this.sessions[sess.sid]=sess,this.jid2session[sess.peerjid]=sess,sess.sendOffer(!0),sess},terminate:function(sid,reason,text){if(null==sid)for(sid in this.sessions)"ended"!=this.sessions[sid].state&&(this.sessions[sid].sendTerminate(reason||(this.sessions[sid].active()?null:"cancel"),text),this.sessions[sid].terminate()),delete this.jid2session[this.sessions[sid].peerjid],delete this.sessions[sid];else this.sessions.hasOwnProperty(sid)&&("ended"!=this.sessions[sid].state&&(this.sessions[sid].sendTerminate(reason||(this.sessions[sid].active()?null:"cancel"),text),this.sessions[sid].terminate()),delete this.jid2session[this.sessions[sid].peerjid],delete this.sessions[sid])},terminateByJid:function(jid){if(this.jid2session.hasOwnProperty(jid)){var sess=this.jid2session[jid];sess&&(sess.terminate(),delete this.sessions[sess.sid],delete this.jid2session[jid],$(document).trigger("callterminated.jingle",[sess.sid,"gone"]))}}})},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var _RainbowLogger__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(9);window.SDP=function(sdp){this.media=sdp.split("\r\nm=");for(var i=1;i<this.media.length;i++)this.media[i]="m="+this.media[i],i!=this.media.length-1&&(this.media[i]+="\r\n");this.session=this.media.shift()+"\r\n",this.raw=this.session+this.media.join("")},SDP.prototype.mangle=function(){var i,j,mline,lines,rtpmap,newdesc;for(i=0;i<this.media.length;i++)if((lines=this.media[i].split("\r\n")).pop(),"audio"==(mline=SDPUtil.parse_mline(lines.shift())).media){for(newdesc="",mline.fmt.length=0,j=0;j<lines.length;j++)if("a=rtpmap:"==lines[j].substr(0,9)){if("CN"==(rtpmap=SDPUtil.parse_rtpmap(lines[j])).name||"ISAC"==rtpmap.name)continue;mline.fmt.push(rtpmap.id),newdesc+=lines[j]+"\r\n"}else newdesc+=lines[j]+"\r\n";this.media[i]=SDPUtil.build_mline(mline)+"\r\n",this.media[i]+=newdesc}this.raw=this.session+this.media.join("")},SDP.prototype.removeSessionLines=function(prefix){var self=this,lines=SDPUtil.find_lines(this.session,prefix);return lines.forEach((function(line){self.session=self.session.replace(line+"\r\n","")})),this.raw=this.session+this.media.join(""),lines},SDP.prototype.removeMediaLines=function(mediaindex,prefix){var self=this,lines=SDPUtil.find_lines(this.media[mediaindex],prefix);return lines.forEach((function(line){self.media[mediaindex]=self.media[mediaindex].replace(line+"\r\n","")})),this.raw=this.session+this.media.join(""),lines},SDP.prototype.toJingle=function(elem,thecreator,confId){var i,j,k,mline,ssrc,rtpmap,tmp,lines,simulcast;if(SDPUtil.find_line(this.session,"a=group:"))for(lines=SDPUtil.find_lines(this.session,"a=group:"),i=0;i<lines.length;i++){var semantics=(tmp=lines[i].split(" ")).shift().substr(8);for(elem.c("group",{xmlns:"urn:xmpp:jingle:apps:grouping:0",semantics:semantics}),j=0;j<tmp.length;j++)elem.c("content",{name:tmp[j]}).up();elem.up()}for(SDPUtil.find_line(this.session,"a=group:BUNDLE")&&SDPUtil.find_line(this.session,"a=group:BUNDLE ").split(" ").shift(),i=0;i<this.media.length;i++)if("audio"==(mline=SDPUtil.parse_mline(this.media[i].split("\r\n")[0])).media||"video"==mline.media){if(ssrc=!!SDPUtil.find_line(this.media[i],"a=ssrc:")&&SDPUtil.find_line(this.media[i],"a=ssrc:").substring(7).split(" ")[0],simulcast=!!SDPUtil.find_line(this.media[i],"a=simulcast:")&&SDPUtil.find_line(this.media[i],"a=simulcast:").substring(12).trim(),elem.c("content",{creator:thecreator,name:mline.media}),SDPUtil.find_line(this.media[i],"a=mid:")){var mid=SDPUtil.parse_mid(SDPUtil.find_line(this.media[i],"a=mid:"));elem.attrs({name:mid})}if(SDPUtil.find_line(this.media[i],"a=rtpmap:").length){for(elem.c("description",{xmlns:"urn:xmpp:jingle:apps:rtp:1",media:mline.media}),ssrc&&elem.attrs({ssrc:ssrc}),j=0;j<mline.fmt.length;j++){if(rtpmap=SDPUtil.find_line(this.media[i],"a=rtpmap:"+mline.fmt[j]),elem.c("payload-type",SDPUtil.parse_rtpmap(rtpmap)),SDPUtil.find_line(this.media[i],"a=fmtp:"+mline.fmt[j]))for(tmp=SDPUtil.parse_fmtp(SDPUtil.find_line(this.media[i],"a=fmtp:"+mline.fmt[j])),k=0;k<tmp.length;k++)elem.c("parameter",tmp[k]).up();this.RtcpFbToJingle(i,elem,mline.fmt[j]),elem.up()}if(SDPUtil.find_line(this.media[i],"a=crypto:",this.session))elem.c("encryption",{required:1}),SDPUtil.find_lines(this.media[i],"a=crypto:",this.session).forEach((function(line){elem.c("crypto",SDPUtil.parse_crypto(line)).up()})),elem.up();if(ssrc)elem.c("source",{ssrc:ssrc,xmlns:"urn:xmpp:jingle:apps:rtp:ssma:0"}),SDPUtil.find_lines(this.media[i],"a=ssrc:").forEach((function(line){idx=line.indexOf(" ");var linessrc=line.substr(0,idx).substr(7);linessrc!=ssrc&&(elem.up(),ssrc=linessrc,elem.c("source",{ssrc:ssrc,xmlns:"urn:xmpp:jingle:apps:rtp:ssma:0"}));var kv=line.substr(idx+1);elem.c("parameter"),-1==kv.indexOf(":")?elem.attrs({name:kv}):(elem.attrs({name:kv.split(":",2)[0]}),elem.attrs({value:kv.split(":",2)[1]})),elem.up()})),elem.up();if(simulcast)elem.c("simulcast",{rids:simulcast,xmlns:"urn:xmpp:jingle:apps:rtp:sim:0"}),SDPUtil.find_lines(this.media[i],"a=rid:").forEach((function(line){var idx=line.indexOf(" "),ridName=line.substr(0,idx).substr(6);elem.c("rid",{xmlns:"urn:xmpp:jingle:apps:rtp:rid:0",name:ridName}),elem.up()})),elem.up();if(SDPUtil.find_lines(this.media[i],"a=ssrc-group").forEach((function(line){var idx=line.indexOf(" "),semantics=line.substr(0,idx).substr(13);elem.c("ssrc-group",{xmlns:"urn:xmpp:jingle:apps:rtp:ssma:0",semantics:semantics});for(var kv=line.substr(idx+1);kv.length>0;){var ssrc_gr;(idx=kv.indexOf(" "))>0?(ssrc_gr=kv.substr(0,idx),kv=kv.substr(idx+1)):(ssrc_gr=kv.substr(0,kv.length),kv=""),elem.c("source",{ssrc:ssrc_gr}).up()}elem.up()})),SDPUtil.find_line(this.media[i],"a=rtcp-mux")&&elem.c("rtcp-mux").up(),this.RtcpFbToJingle(i,elem,"*"),SDPUtil.find_line(this.media[i],"a=extmap:"))for(lines=SDPUtil.find_lines(this.media[i],"a=extmap:"),j=0;j<lines.length;j++){if(tmp=SDPUtil.parse_extmap(lines[j]),elem.c("rtp-hdrext",{xmlns:"urn:xmpp:jingle:apps:rtp:rtp-hdrext:0",uri:tmp.uri,id:tmp.value}),tmp.hasOwnProperty("direction"))switch(tmp.direction){case"sendonly":elem.attrs({senders:"responder"});break;case"recvonly":elem.attrs({senders:"initiator"});break;case"sendrecv":elem.attrs({senders:"both"});break;case"inactive":elem.attrs({senders:"none"})}elem.up()}elem.up()}this.TransportToJingle(i,elem),SDPUtil.find_line(this.media[i],"a=sendrecv",this.session)?elem.attrs({senders:"both"}):SDPUtil.find_line(this.media[i],"a=sendonly",this.session)?elem.attrs({senders:"initiator"}):SDPUtil.find_line(this.media[i],"a=recvonly",this.session)?elem.attrs({senders:"responder"}):SDPUtil.find_line(this.media[i],"a=inactive",this.session)&&elem.attrs({senders:"none"}),"0"!=mline.port||SDPUtil.find_line(this.media[i],"a=bundle-only",this.session)||elem.attrs({senders:"rejected"}),elem.up()}return confId&&-1!==confId&&(elem.c("conference",{xmlns:"urn:xmpp:janus:1",id:confId}),elem.up()),elem.up(),elem},SDP.prototype.TransportToJingle=function(mediaindex,elem){var tmp,self=this;(elem.c("transport"),SDPUtil.find_lines(this.media[mediaindex],"a=fingerprint:",this.session).forEach((function(line){(tmp=SDPUtil.parse_fingerprint(line)).xmlns="urn:xmpp:jingle:apps:dtls:0",elem.c("fingerprint").t(tmp.fingerprint),delete tmp.fingerprint,(line=SDPUtil.find_line(self.media[mediaindex],"a=setup:",self.session))&&(tmp.setup=line.substr(8)),elem.attrs(tmp),elem.up()})),tmp=SDPUtil.iceparams(this.media[mediaindex],this.session))&&(tmp.xmlns="urn:xmpp:jingle:transports:ice-udp:1",elem.attrs(tmp),SDPUtil.find_line(this.media[mediaindex],"a=candidate:",this.session)&&SDPUtil.find_lines(this.media[mediaindex],"a=candidate:",this.session).forEach((function(line){elem.c("candidate",SDPUtil.candidateToJingle(line)).up()})));elem.up()},SDP.prototype.RtcpFbToJingle=function(mediaindex,elem,payloadtype){SDPUtil.find_lines(this.media[mediaindex],"a=rtcp-fb:"+payloadtype).forEach((function(line){var tmp=SDPUtil.parse_rtcpfb(line);"trr-int"==tmp.type?(elem.c("rtcp-fb-trr-int",{xmlns:"urn:xmpp:jingle:apps:rtp:rtcp-fb:0",value:tmp.params[0]}),elem.up()):(elem.c("rtcp-fb",{xmlns:"urn:xmpp:jingle:apps:rtp:rtcp-fb:0",type:tmp.type}),tmp.params.length>0&&elem.attrs({subtype:tmp.params[0]}),elem.up())}))},SDP.prototype.RtcpFbFromJingle=function(elem,payloadtype){var media="",tmp=elem.find('>rtcp-fb-trr-int[xmlns="urn:xmpp:jingle:apps:rtp:rtcp-fb:0"]');return tmp.length&&(media+="a=rtcp-fb:* trr-int ",tmp.attr("value")?media+=tmp.attr("value"):media+="0",media+="\r\n"),(tmp=elem.find('>rtcp-fb[xmlns="urn:xmpp:jingle:apps:rtp:rtcp-fb:0"]')).each((function(){media+="a=rtcp-fb:"+payloadtype+" "+$(this).attr("type"),$(this).attr("subtype")&&(media+=" "+$(this).attr("subtype")),media+="\r\n"})),media},SDP.prototype.fromJingle=function(jingle){var self=this;if(this.raw="v=0\r\no=- 1923518516 2 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n",$(jingle).find('>group[xmlns="urn:xmpp:jingle:apps:grouping:0"]').length)$(jingle).find('>group[xmlns="urn:xmpp:jingle:apps:grouping:0"]').each((function(idx,group){var contents=$(group).find(">content").map((function(idx,content){return content.getAttribute("name")})).get();contents.length>0&&(self.raw+="a=group:"+(group.getAttribute("semantics")||group.getAttribute("type"))+" "+contents.join(" ")+"\r\n")}));else if($(jingle).find('>group[xmlns="urn:ietf:rfc:5888"]').length)$(jingle).find('>group[xmlns="urn:ietf:rfc:5888"]').each((function(idx,group){var contents=$(group).find(">content").map((function(idx,content){return content.getAttribute("name")})).get();null!==group.getAttribute("type")&&contents.length>0&&(self.raw+="a=group:"+group.getAttribute("type")+" "+contents.join(" ")+"\r\n")}));else{var bundle=$(jingle).find(">content").filter((function(idx,content){return $(content).find(">bundle").length>0})).map((function(idx,content){return content.getAttribute("name")})).get();bundle.length&&(this.raw+="a=group:BUNDLE "+bundle.join(" ")+"\r\n")}this.raw+="a=ice-options:trickle\r\n",this.session=this.raw,jingle.find(">content").each((function(){var m=self.jingle2media($(this));self.media.push(m)}));var msid=SDPUtil.parse_ssrc(this.raw);msid.hasOwnProperty("mslabel")&&msid.mslabel&&(this.session+="a=msid-semantic: WMS "+msid.mslabel+"\r\n"),this.raw=this.session+this.media.join("")},SDP.prototype.jingle2media=function(content){var tmp,media="",desc=content.find("description"),self=(desc.attr("ssrc"),this);if((tmp={media:desc.attr("media")}).port="1","rejected"==content.attr("senders")&&(tmp.port="0"),content.find(">transport>fingerprint").length||desc.find("encryption").length?tmp.proto="RTP/SAVPF":tmp.proto="RTP/AVPF",tmp.fmt=desc.find("payload-type").map((function(){return this.getAttribute("id")})).get(),media+=SDPUtil.build_mline(tmp)+"\r\n",media+="c=IN IP4 0.0.0.0\r\n",media+="a=rtcp:1 IN IP4 0.0.0.0\r\n",(tmp=content.find('>transport[xmlns="urn:xmpp:jingle:transports:ice-udp:1"]')).length&&(tmp.attr("ufrag")&&(media+=SDPUtil.build_iceufrag(tmp.attr("ufrag"))+"\r\n"),tmp.attr("pwd")&&(media+=SDPUtil.build_icepwd(tmp.attr("pwd"))+"\r\n"),tmp.find(">fingerprint").each((function(){media+="a=fingerprint:"+this.getAttribute("hash"),media+=" "+$(this).text(),media+="\r\n",this.getAttribute("setup")&&(media+="a=setup:"+this.getAttribute("setup")+"\r\n")}))),(tmp=content.find('description>simulcast[xmlns="urn:xmpp:jingle:apps:rtp:sim:0"]')).length){var rids=tmp.attr("rids");rids&&(media+="a=simulcast: "+rids+"\r\n"),tmp.find(">rid").each((function(){media+="a=rid:"+this.getAttribute("name")+" recv",media+="\r\n"}))}switch(content.attr("senders")){case"initiator":media+="a=sendonly\r\n";break;case"responder":media+="a=recvonly\r\n";break;case"none":media+="a=inactive\r\n";break;case"both":media+="a=sendrecv\r\n"}return media+="a=mid:"+content.attr("name")+"\r\n",desc.find("rtcp-mux").length&&(media+="a=rtcp-mux\r\n"),desc.find("encryption").length&&desc.find("encryption>crypto").each((function(){media+="a=crypto:"+this.getAttribute("tag"),media+=" "+this.getAttribute("crypto-suite"),media+=" "+this.getAttribute("key-params"),this.getAttribute("session-params")&&(media+=" "+this.getAttribute("session-params")),media+="\r\n"})),desc.find("payload-type").each((function(){media+=SDPUtil.build_rtpmap(this)+"\r\n",$(this).find(">parameter").length&&(media+="a=fmtp:"+this.getAttribute("id")+" ",media+=$(this).find("parameter").map((function(){return(this.getAttribute("name")?this.getAttribute("name")+"=":"")+this.getAttribute("value")})).get().join(";"),media+="\r\n"),media+=self.RtcpFbFromJingle($(this),this.getAttribute("id"))})),media+=self.RtcpFbFromJingle(desc,"*"),(tmp=desc.find('>rtp-hdrext[xmlns="urn:xmpp:jingle:apps:rtp:rtp-hdrext:0"]')).each((function(){media+="a=extmap:"+this.getAttribute("id")+" "+this.getAttribute("uri")+"\r\n"})),content.find('>transport[xmlns="urn:xmpp:jingle:transports:ice-udp:1"]>candidate').each((function(){media+=SDPUtil.candidateFromJingle(this)})),(tmp=content.find('description>source[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]')).each((function(){var ssrc=this.getAttribute("ssrc");$(this).find(">parameter").each((function(){this.getAttribute("name")&&this.getAttribute("name").length&&this.getAttribute("value")&&this.getAttribute("value").length&&(media+="a=ssrc:"+ssrc+" "+this.getAttribute("name")+":"+this.getAttribute("value")),media+="\r\n"}))})),(tmp=content.find('description>ssrc-group[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]')).each((function(){var semantics=this.getAttribute("semantics");media+="a=ssrc-group:"+semantics,$(this).find(">source").each((function(){media+=" "+this.getAttribute("ssrc")})),media+="\r\n"})),media},window.SDPUtil={iceparams:function(mediadesc,sessiondesc){var data=null;return SDPUtil.find_line(mediadesc,"a=ice-ufrag:",sessiondesc)&&SDPUtil.find_line(mediadesc,"a=ice-pwd:",sessiondesc)&&(data={ufrag:SDPUtil.parse_iceufrag(SDPUtil.find_line(mediadesc,"a=ice-ufrag:",sessiondesc)),pwd:SDPUtil.parse_icepwd(SDPUtil.find_line(mediadesc,"a=ice-pwd:",sessiondesc))}),data},parse_iceufrag:function(line){return line.substring(12)},build_iceufrag:function(frag){return"a=ice-ufrag:"+frag},parse_icepwd:function(line){return line.substring(10)},build_icepwd:function(pwd){return"a=ice-pwd:"+pwd},parse_mid:function(line){return line.substring(6)},parse_mline:function(line){var parts=line.substring(2).split(" "),data={};return data.media=parts.shift(),data.port=parts.shift(),data.proto=parts.shift(),""===parts[parts.length-1]&&parts.pop(),data.fmt=parts,data},build_mline:function(mline){return"m="+mline.media+" "+mline.port+" "+mline.proto+" "+mline.fmt.join(" ")},parse_rtpmap:function(line){var parts=line.substring(9).split(" "),data={};return data.id=parts.shift(),parts=parts[0].split("/"),data.name=parts.shift(),data.clockrate=parts.shift(),data.channels=parts.length?parts.shift():"1",data},build_rtpmap:function(el){var line="a=rtpmap:"+el.getAttribute("id")+" "+el.getAttribute("name")+"/"+el.getAttribute("clockrate");return el.getAttribute("channels")&&"1"!=el.getAttribute("channels")&&(line+="/"+el.getAttribute("channels")),line},parse_simulcast:function(line){var parts=line.substr(13).split(" "),data={};return data.direction=parts.shift(),data.rid=parts.shift().substr(4),data},parse_crypto:function(line){var parts=line.substring(9).split(" "),data={};return data.tag=parts.shift(),data["crypto-suite"]=parts.shift(),data["key-params"]=parts.shift(),parts.length&&(data["session-params"]=parts.join(" ")),data},parse_fingerprint:function(line){var parts=line.substring(14).split(" "),data={};return data.hash=parts.shift(),data.fingerprint=parts.shift(),data},parse_fmtp:function(line){var i,key,value,parts=line.split(" "),data=[];for(parts.shift(),parts=parts.join(" ").split(";"),i=0;i<parts.length;i++){for(key=parts[i].split("=")[0];key.length&&" "==key[0];)key=key.substring(1);value=parts[i].split("=")[1],key&&value?data.push({name:key,value:value}):key&&data.push({name:"",value:key})}return data},parse_icecandidate:function(line){_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] jingle.sdp.parse_icecandidate "+line);var candidate={},elems=line.split(" ");candidate.foundation=elems[0].substring(12),candidate.component=elems[1],candidate.protocol=elems[2].toLowerCase(),candidate.priority=elems[3],candidate.ip=elems[4],candidate.port=elems[5],candidate.type=elems[7],candidate.generation=0;for(var i=8;i<elems.length;i+=2)switch(elems[i]){case"raddr":candidate["rel-addr"]=elems[i+1];break;case"rport":candidate["rel-port"]=elems[i+1];break;case"generation":candidate.generation=elems[i+1];break;case"tcptype":candidate.tcptype=elems[i+1];break;default:_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk('[Strophe.jingle] parse_icecandidate not translating "'+elems[i]+'" = "'+elems[i+1]+'"')}return candidate.network="1",candidate.id=Math.random().toString(36).substr(2,10),candidate},build_icecandidate:function(cand){var line=["a=candidate:"+cand.foundation,cand.component,cand.protocol,cand.priority,cand.ip,cand.port,"typ",cand.type].join(" ");switch(line+=" ",cand.type){case"srflx":case"prflx":case"relay":cand.hasOwnAttribute("rel-addr")&&cand.hasOwnAttribute("rel-port")&&(line+="raddr",line+=" ",line+=cand["rel-addr"],line+=" ",line+="rport",line+=" ",line+=cand["rel-port"],line+=" ")}return cand.hasOwnAttribute("tcptype")&&(line+="tcptype",line+=" ",line+=cand.tcptype,line+=" "),line+="generation",line+=" ",line+=cand.hasOwnAttribute("generation")?cand.generation:"0",_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] jingle.sdp.build_icecandidate "+line),line},parse_ssrc:function(desc){for(var lines=desc.split("\r\n"),data={},i=0;i<lines.length;i++)if("a=ssrc:"==lines[i].substring(0,7)){var _idx=lines[i].indexOf(" ");data[lines[i].substr(_idx+1).split(":",2)[0]]=lines[i].substr(_idx+1).split(":",2)[1]}return data},parse_rtcpfb:function(line){var parts=line.substr(10).split(" "),data={};return data.pt=parts.shift(),data.type=parts.shift(),data.params=parts,data},parse_extmap:function(line){var parts=line.substr(9).split(" "),data={};return data.value=parts.shift(),-1!=data.value.indexOf("/")?(data.direction=data.value.substr(data.value.indexOf("/")+1),data.value=data.value.substr(0,data.value.indexOf("/"))):data.direction="both",data.uri=parts.shift(),data.params=parts,data},find_line:function(haystack,needle,sessionpart){for(var lines=haystack.split("\r\n"),i=0;i<lines.length;i++)if(lines[i].substring(0,needle.length)==needle)return lines[i];if(!sessionpart)return!1;lines=sessionpart.split("\r\n");for(var j=0;j<lines.length;j++)if(lines[j].substring(0,needle.length)==needle)return lines[j];return!1},find_lines:function(haystack,needle,sessionpart){for(var lines=haystack.split("\r\n"),needles=[],i=0;i<lines.length;i++)lines[i].substring(0,needle.length)==needle&&needles.push(lines[i]);if(needles.length||!sessionpart)return needles;lines=sessionpart.split("\r\n");for(var j=0;j<lines.length;j++)lines[j].substring(0,needle.length)==needle&&needles.push(lines[j]);return needles},candidateToJingle:function(line){if(_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] !!! jingle.sdp.candidateToJingle "+line),0===line.indexOf("candidate:"))line="a="+line;else if("a=candidate:"!=line.substring(0,12))return _RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] parseCandidate called with a line that is not a candidate line"),_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] "+line),null;"\r\n"==line.substring(line.length-2)&&(line=line.substring(0,line.length-2));var i,candidate={},elems=line.split(" ");if("typ"!=elems[6])return _RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] did not find typ in the right place"),_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk("[Strophe.jingle] "+line),null;for(candidate.foundation=elems[0].substring(12),candidate.component=elems[1],candidate.protocol=elems[2].toLowerCase(),candidate.priority=elems[3],candidate.ip=elems[4],candidate.port=elems[5],candidate.type=elems[7],candidate.generation="0",i=8;i<elems.length;i+=2)switch(elems[i]){case"raddr":candidate["rel-addr"]=elems[i+1];break;case"rport":candidate["rel-port"]=elems[i+1];break;case"generation":candidate.generation=elems[i+1];break;case"tcptype":candidate.tcptype=elems[i+1];break;case"network-cost":candidate.cost=elems[i+1];break;case"network-id":candidate.network=elems[i+1];break;default:_RainbowLogger__WEBPACK_IMPORTED_MODULE_0__.rainbowLogger.sdk('[Strophe.jingle] not translating "'+elems[i]+'" = "'+elems[i+1]+'"')}return candidate.id=Math.random().toString(36).substr(2,10),candidate},candidateFromJingle:function(cand,ufrag,pwd){var parts=["a=candidate:"+cand.getAttribute("foundation"),cand.getAttribute("component"),cand.getAttribute("protocol"),cand.getAttribute("priority"),cand.getAttribute("ip"),cand.getAttribute("port"),"typ",cand.getAttribute("type")];switch(cand.getAttribute("type")){case"srflx":case"prflx":case"relay":cand.getAttribute("rel-addr")&&cand.getAttribute("rel-port")&&(parts.push("raddr"),parts.push(cand.getAttribute("rel-addr")),parts.push("rport"),parts.push(cand.getAttribute("rel-port")))}return parts.push("generation"),parts.push(cand.getAttribute("generation")||"0"),cand.getAttribute("network")&&(parts.push("network-id"),parts.push(cand.getAttribute("network"))),cand.getAttribute("cost")&&(parts.push("network-cost"),parts.push(cand.getAttribute("cost"))),ufrag&&(parts.push("ufrag"),parts.push(ufrag)),pwd&&(parts.push("pwd"),parts.push(pwd)),parts.join(" ")+"\r\n"}}},function(module,exports){window.idx=-1,window.JingleSession=function(me,sid,connection,jingleIqTimeout){this.me=me,this.sid=sid,this.connection=connection,this.initiator=null,this.responder=null,this.isInitiator=null,this.peerjid=null,this.state=null,this.peerconnection=null,this.remoteStream=null,this.localSDP=null,this.remoteSDP=null,this.localStreams=[],this.localTransceivers=[],this.remoteStreams=[],this.remoteStreamsObject={},this.startTime=null,this.stopTime=null,this.media_constraints=null,this.pc_constraints=null,this.ice_config={},this.company_config={},this.hadstuncandidate=!1,this.hadturncandidate=!1,this.statsinterval=null,this.reason=null,this.addssrc=[],this.removessrc=[],this.pendingop=null,this.wait=!0,this.isRenegotiating=!1,this.remoteType=null,this.localType=null,this.videoSender=null,this.jingleIqTimeout=15e3,jingleIqTimeout&&(this.jingleIqTimeout=jingleIqTimeout),this.conference_id=-1,this.calledNumber=null,this.DTX=!1,this.unifiedPlanActivated=!1,this.hasSentTransportReplace=!1,this.iceFilterList=[]},JingleSession.prototype.initiate=function(peerjid,isInitiator){Strophe.log("","[Strophe.jingle] initiate");var self=this;if(null===this.state){this.isInitiator=isInitiator,this.initiator=isInitiator?this.me:peerjid,this.responder=isInitiator?peerjid:this.me,this.peerjid=peerjid;var constraints={};if(this.ice_config.sdpSemantics="plan-b",adapter&&adapter.default&&"chrome"===adapter.default.browserDetails.browser&&adapter.default.browserDetails.version>=70){var sdkVersion=function(peerjid){var version=null;if(peerjid){var index=peerjid.indexOf("web_sdk");if(-1!==index){version=peerjid.substr(index+10,2);version=parseInt(version,10)}}return version}(peerjid);sdkVersion&&sdkVersion<53&&(Strophe.log("","[Strophe.jingle] Unified plan activated"),this.ice_config.sdpSemantics="unified-plan")}this.unifiedPlanActivated&&(this.ice_config.sdpSemantics="unified-plan"),Strophe.log("","[Strophe.jingle] SDP activated: "+this.ice_config.sdpSemantics),this.ice_config.unifiedPlan&&(this.unifiedPlanActivated=!0,Strophe.log("","[Strophe.jingle] FORCED Unified plan activated"),this.ice_config.sdpSemantics="unified-plan"),this.ice_config.enableDSCP&&(Strophe.log("","[Strophe.jingle] googDscp activated"),constraints={optional:[{googDscp:!0}]}),this.ice_config.dtx&&(Strophe.log("","[Strophe.jingle] Discontinuous Transmission (DTX) activated"),this.DTX=!0),this.company_config&&this.company_config.negotiation&&this.company_config.negotiation.iceFiltering&&(this.iceFilterList=this.company_config.negotiation.iceFiltering.length?this.company_config.negotiation.iceFiltering:[]);try{this.peerconnection=new window.RTCPeerConnection(this.ice_config,constraints)}catch(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] Failed to create PeerConnection, exception: ",e.message),Strophe.log(Strophe.LogLevel.ERROR,e);try{this.peerconnection=new window.RTCPeerConnection,this.peerconnection.setConfiguration&&this.peerconnection.setConfiguration(this.ice_config)}catch(error){return Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] Failed to create PeerConnection, exception: ",e.message),void Strophe.log(Strophe.LogLevel.ERROR,error)}}this.peerconnection.onicecandidate=function(event){window.isRenegotiating?Strophe.log("","[Strophe.jingle] onicecandidate not added due to renegotiation"):self.sendIceCandidate(event.candidate)};this.peerconnection.onaddstream=function(event){if(!self.unifiedPlanActivated){Strophe.log("","[Strophe.jingle] onAddStream");var stream=event.stream;if(self.remoteStream=stream,"audio"===self.remoteType||"video"===self.remoteType)for(;self.remoteStreams.length>0;)self.remoteStreams.pop();else for(var i=0;i<self.remoteStreams.length&&self.remoteStreams[i];i++)self.remoteStreams[i].active?stream.getAudioTracks().length?self.remoteStreams[i].getAudioTracks().length&&self.remoteStreams.splice(i,1):!self.remoteStreams[i].getAudioTracks().length&&self.remoteStreams[i].getVideoTracks().length&&self.remoteStreams.splice(i,1):self.remoteStreams.splice(i,1);self.remoteStreams.push(stream),Strophe.log("",self.remoteStreams),Strophe.log("","[Strophe.jingle] peer.onaddstream",stream.id,stream),stream.hasOwnProperty("active")&&Strophe.log("","[Strophe.jingle] stream active ? ",stream.active),Strophe.log("","[Strophe.jingle] audio Tracks: "+stream.getAudioTracks().length+" | Video Tracks: "+stream.getVideoTracks().length);for(i=0;i<stream.getAudioTracks().length;i++){var track=stream.getAudioTracks()[i];Strophe.log("","[Strophe.jingle] audio Track: "+track.id+" | "+track.kind+" | "+track.enabled+" | "+track.readyState,track)}for(i=0;i<stream.getVideoTracks().length;i++){track=stream.getVideoTracks()[i];Strophe.log("","[Strophe.jingle] video Track: "+track.id+" | "+track.kind+" | "+track.enabled+" | "+track.readyState,track)}stream.onactive=function(){Strophe.log("","[Strophe.jingle] stream.onactive",stream)},stream.onaddtrack=function(evt){Strophe.log("","[Strophe.jingle] stream.onaddtrack: "+evt.track.id+" | "+evt.track.kind+" | "+evt.track.enabled+" | "+evt.track.readyState,evt.track)},stream.onremovetrack=function(evt){Strophe.log("","[Strophe.jingle] stream.onremovetrack: "+evt.track.id+" | "+evt.track.kind+" | "+evt.track.enabled+" | "+evt.track.readyState,evt.track)},stream.oninactive=function(){Strophe.log("","[Strophe.jingle] stream.oninactive",stream)},$(document).trigger("remotestreamadded.jingle",[self.sid,stream.getAudioTracks().length])}},this.peerconnection.ontrack=function(trackEvent){self.unifiedPlanActivated&&(window.conference_id&&-1!==window.conference_id?self.createRemoteStreamForConference(trackEvent.transceiver):self.createOrUpdateRemoteStreams(trackEvent.transceiver))},this.peerconnection.onremovetrack=function(trackEvent){self.unifiedPlanActivated},this.peerconnection.onremovestream=function(event){Strophe.log("","[Strophe.jingle] peer.onremovestream"),$(document).trigger("remotestreamremoved.jingle",[event,self.sid])},this.peerconnection.onsignalingstatechange=function(event){self&&self.peerconnection&&$(document).trigger("iceconnectionstatechange.jingle",[self.sid,self])},this.peerconnection.oniceconnectionstatechange=function(event){if(self&&self.peerconnection){switch(self.peerconnection.iceConnectionState){case"connected":this.startTime=new Date,Strophe.log("","[Strophe.jingle] iceConnectionState is connected, try to update the RTP Sender ");break;case"closed":case"disconnected":this.stopTime=new Date}$(document).trigger("iceconnectionstatechange.jingle",[self.sid,self])}},this.localStreams.forEach((function(stream){self.unifiedPlanActivated?self.addStream(stream):self.peerconnection.addStream(stream)}))}else Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] attempt to initiate on session "+this.sid+"in state "+this.state)},JingleSession.prototype.createRemoteStreamForConference=function(transceiver){var stream=new MediaStream;stream.addTrack(transceiver.receiver.track),this.remoteStreamsObject[0]=stream},JingleSession.prototype.createOrUpdateRemoteStreams=function(transceiver){var mid=parseInt(transceiver.mid),stream=new MediaStream;this.remoteStreamsObject[mid]?(this.remoteStreamsObject[mid].removeTrack(this.remoteStreamsObject[mid].getTracks()[0]),this.remoteStreamsObject[mid].addTrack(transceiver.receiver.track)):(stream.addTrack(transceiver.receiver.track),this.remoteStreamsObject[mid]=stream)},JingleSession.prototype.updateRemoteStreams=function(){var self=this;this.localTransceivers.forEach((function(transceiver){transceiver.currentDirection&&"sendonly"!==transceiver.currentDirection&&"inactive"!==transceiver.currentDirection||(self.remoteStreamsObject[transceiver.mid]=null)}))},JingleSession.prototype.addStream=function(stream){if(this.unifiedPlanActivated){if(this.conference_id&&-1!==this.conference_id){var type=stream.getAudioTracks().length?"audio":"video";return this.localTransceivers[0]||(this.localTransceivers[0]=this.peerconnection.addTransceiver(type)),this.localTransceivers[0].sender.replaceTrack("audio"===type?stream.getAudioTracks()[0]:stream.getVideoTracks()[0]),void(this.localTransceivers[0].direction="sendrecv")}return stream.getAudioTracks().length>0&&(this.localTransceivers[0]||(this.localTransceivers[0]=this.peerconnection.addTransceiver("audio")),this.localTransceivers[0].sender.replaceTrack(stream.getAudioTracks()[0]),this.localTransceivers[0].direction="sendrecv"),stream.getVideoTracks().length>0&&stream.getAudioTracks().length>0&&(this.localTransceivers[0]||(this.localTransceivers[0]=this.peerconnection.addTransceiver("audio",{direction:"recvonly"})),this.localTransceivers[1]||(this.localTransceivers[1]=this.peerconnection.addTransceiver("video")),this.localTransceivers[1].sender.replaceTrack(stream.getVideoTracks()[0]),this.localTransceivers[1].direction="sendrecv"),void(stream.getVideoTracks().length>0&&!stream.getAudioTracks().length&&(this.localTransceivers[0]||(this.localTransceivers[0]=this.peerconnection.addTransceiver("audio",{direction:"recvonly"})),this.localTransceivers[1]||this.localTransceivers.push(this.peerconnection.addTransceiver("video",{direction:"recvonly"})),"videoOnly"===this.localType?(this.localTransceivers[1].sender.replaceTrack(stream.getVideoTracks()[0]),this.localTransceivers[1].direction="sendrecv"):(this.localTransceivers[2]||this.localTransceivers.push(this.peerconnection.addTransceiver("video")),this.localTransceivers[2].sender.replaceTrack(stream.getVideoTracks()[0]),this.localTransceivers[2].direction="sendrecv")))}switch(adapter.default.browserDetails.browser){case"chrome":case"edge":this.peerconnection.addStream(stream);break;case"firefox":case"safari":stream.getAudioTracks().length>0&&this.peerconnection.addTrack(stream.getAudioTracks()[0],stream),stream.getVideoTracks().length>0&&this.peerconnection.addTrack(stream.getVideoTracks()[0],stream)}},JingleSession.prototype.removeStream=function(stream,RTC){if(Strophe.log("","[Strophe.jingle] detected WebRTC browser is "+adapter.default.browserDetails.browser),this.unifiedPlanActivated)return this.peerconnection.getTransceivers().forEach((function(transceiver){transceiver.sender.replaceTrack(null),transceiver.direction="recvonly"})),void(this.localTransceivers=this.peerconnection.getTransceivers());switch(adapter.default.browserDetails.browser){case"chrome":case"edge":this.peerconnection.removeStream(stream)}},JingleSession.prototype.addTrack=function(stream){stream.getAudioTracks().length>0&&this.peerconnection.addTrack(stream.getAudioTracks()[0],stream),stream.getVideoTracks().length>0&&this.peerconnection.addTrack(stream.getVideoTracks()[0],stream)},JingleSession.prototype.replaceStream=function(stream){switch(Strophe.log("","[Strophe.jingle] detected WebRTC browser is "+adapter.default.browserDetails.browser),adapter.default.browserDetails.browser){case"chrome":break;case"firefox":case"safari":if(this.unifiedPlanActivated)return void this.addStream(stream);var yourAudioTrack=stream.getAudioTracks()[0],yourVideoTrack=stream.getVideoTracks()[0];Strophe.log(Strophe.LogLevel.ERROR,yourAudioTrack),Strophe.log(Strophe.LogLevel.ERROR,yourVideoTrack);var videoAlreadyReplaced=!1,audioAlreadyReplaced=!1;if(this.peerconnection.getSenders().forEach((function(rtpSender){yourVideoTrack&&rtpSender.track&&"video"===rtpSender.track.kind&&(rtpSender.replaceTrack(yourVideoTrack),Strophe.log("","[Strophe.jingle] replaceTrack video "+rtpSender),videoAlreadyReplaced=!0),yourAudioTrack&&rtpSender.track&&"audio"===rtpSender.track.kind&&(Strophe.log("","[Strophe.jingle] replaceTrack audio "+rtpSender),rtpSender.replaceTrack(yourAudioTrack),audioAlreadyReplaced=!0)})),yourVideoTrack&&!videoAlreadyReplaced)Strophe.log("","[Strophe.jingle] addTrack yourVideoTrack"),this.videoSender=this.peerconnection.addTrack(yourVideoTrack,stream);else if(this.videoSender){Strophe.log("","[Strophe.jingle] removeTrack yourVideoTrack");try{this.peerconnection.removeTrack(this.videoSender),this.videoSender=null}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] removeTrack error "+error)}}yourAudioTrack&&!audioAlreadyReplaced&&(Strophe.log("","[Strophe.jingle] add new audio track"),this.peerconnection.addTrack(yourAudioTrack,stream))}},JingleSession.prototype.addConferenceInfo=function(stanza){-1!==this.conference_id&&(stanza.c("conference",{xmlns:"urn:xmpp:janus:1",id:this.conference_id}),stanza.up())},JingleSession.prototype.accept=function(){try{var self=this;this.state="active";var pranswer=this.peerconnection.localDescription;if(!pranswer||"pranswer"!=pranswer.type)return;for(Strophe.log("","[Strophe.jingle] going from pranswer to answer");SDPUtil.find_line(pranswer.sdp,"a=inactive");)pranswer.sdp=pranswer.sdp.replace("a=inactive","a=sendrecv");pranswer=this.hackMsLabelSDP(pranswer);var prsdp=new SDP(pranswer.sdp),accept=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-accept",initiator:this.initiator,responder:this.responder,sid:this.sid,localType:this.localType});prsdp.toJingle(accept,this.initiator==this.me?"initiator":"responder",this.conference_id,this.calledNumber),this.connection.sendIQ(accept,(function(){var ack={source:"answer"};$(document).trigger("ack.jingle",[self.sid,ack])}),(function(stanza){var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};error.source="answer",$(document).trigger("error.jingle",{sid:self.sid,error:error})}),this.jingleIqTimeout);for(var sdp=this.peerconnection.localDescription.sdp;SDPUtil.find_line(sdp,"a=inactive");)sdp=sdp.replace("a=inactive","a=sendrecv");this.peerconnection.setLocalDescription(new window.RTCSessionDescription({type:"answer",sdp:sdp}),(function(){$(document).trigger("setLocalDescription.jingle",[self.sid]),Strophe.log("","[Strophe.jingle] setLocalDescription success, try to update the RTP Sender "),self.ice_config.enableDSCP&&self.peerconnection.getSenders().forEach((function(rtpSender){if(rtpSender.getParameters&&rtpSender.setParameters){var params=rtpSender.getParameters();params.encodings.forEach((function(encoding){encoding.priority="high",encoding.networkPriority="high"})),rtpSender.setParameters(params),Strophe.log("","[Strophe.jingle] RTP Sender parameters are updated "+rtpSender.getParameters())}}))}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setLocalDescription failed",e)}))}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.accept failed: "+error)}},JingleSession.prototype.terminate=function(reason){this.state="ended",this.reason=reason,this.peerconnection&&"closed"!==this.peerconnection.signalingState&&this.peerconnection.close(),Strophe.log("","[Strophe.jingle] Clear peerconnection"),this.peerconnection=null,null!==this.statsinterval&&(window.clearInterval(this.statsinterval),this.statsinterval=null),this.localStreams&&this.localStreams.length&&this.localStreams.forEach((function(stream){stream.getTracks().forEach((function(track){track.enabled=!1,track.stop(),track=null})),stream.stop&&stream.stop(),stream=null}))},JingleSession.prototype.active=function(){return"active"==this.state},JingleSession.prototype.sendIceCandidate=function(candidate){if(candidate&&this.iceFilterList&&this.iceFilterList.length&&-1!==this.iceFilterList.indexOf(candidate.type))Strophe.log("","[Strophe.jingle] ICE candidate "+candidate.type+" is filtered");else if(candidate){Strophe.log("","[Strophe.jingle] sendIceCandidate "+candidate);var ice=SDPUtil.iceparams(this.localSDP.media[candidate.sdpMLineIndex],this.localSDP.session),jcand=SDPUtil.candidateToJingle(candidate.candidate);if(!ice||!jcand)return void Strophe.log("","[Strophe.jingle] failed to get ice && jcand");ice.xmlns="urn:xmpp:jingle:transports:ice-udp:1",Strophe.log("","[Strophe.jingle] sending single candidate"),this.isRenegotiating?Strophe.log("","[Strophe.jingle] NOT sending candidate due to Renegotiation"):this.sendIceCandidates([candidate])}},JingleSession.prototype.sendIceCandidates=function(candidates){try{Strophe.log("","[Strophe.jingle] sendIceCandidates",candidates);for(var cand=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"transport-info",initiator:this.initiator,sid:this.sid,localType:this.localType}),mid=0;mid<this.localSDP.media.length;mid++){var cands=candidates.filter((function(el){return el.sdpMLineIndex==mid})),mline=SDPUtil.parse_mline(this.localSDP.media[mid].split("\r\n")[0]);if(cands.length>0){var ice=SDPUtil.iceparams(this.localSDP.media[mid],this.localSDP.session);ice.xmlns="urn:xmpp:jingle:transports:ice-udp:1",cand.c("content",{creator:this.initiator==this.me?"initiator":"responder",name:cands[0].sdpMid?cands[0].sdpMid:mline.media}).c("transport",ice);for(var i=0;i<cands.length;i++)cand.c("candidate",SDPUtil.candidateToJingle(cands[i].candidate)).up();if(SDPUtil.find_line(this.localSDP.media[mid],"a=fingerprint:",this.localSDP.session)){var _tmp=SDPUtil.parse_fingerprint(SDPUtil.find_line(this.localSDP.media[mid],"a=fingerprint:",this.localSDP.session));_tmp.required=!0,cand.c("fingerprint").t(_tmp.fingerprint),delete _tmp.fingerprint,cand.attrs(_tmp),cand.up()}cand.up(),cand.up()}}if(config.turnOn&&!(cand.node.innerHTML.indexOf('type="relay')>-1))return void Strophe.log("","[Strophe.jingle] Debug flag turnOn : Ignore candidate");Strophe.log("","[Strophe.jingle] try to send ack(transportinfo)..."),this.connection.sendIQ(cand,(function(){var ack={source:"transportinfo"};Strophe.log("","Sent session initiate (ACK, transportinfo)..."),$(document).trigger("ack.jingle",[window.sid,ack])}),(function(stanza){var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};error.source="transportinfo",$(document).trigger("error.jingle",{sid:this.sid,error:error})}),this.jingleIqTimeout)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.sendIceCandidates failed: "+error)}},JingleSession.prototype.hackOfferSDP=function(offer){return"firefox"!==adapter.default.browserDetails.browser&&(offer.sdp=offer.sdp.replace(/a=sendonly/g,"a=sendrecv")),-1!==this.conference_id&&"video"===this.localType&&(offer.sdp=offer.sdp.replace(/a=sendrecv/g,"a=sendonly")),navigator.platform.toUpperCase().indexOf("MAC")>=0&&(offer.sdp=this.forceCodecTo(offer.sdp,"H264/90000","video")),this.ice_config.simulcast&&-1!==this.conference_id&&"video"===this.localType&&adapter&&adapter.default&&"chrome"===adapter.default.browserDetails.browser&&adapter.default.browserDetails.version>=70&&(Strophe.log("","[Strophe.jingle] Enabling Simulcasting for Chrome (sdp munging)"),offer.sdp=this.mungeSdpForSimulcasting(offer.sdp)),offer},JingleSession.prototype.hackMsLabelSDP=function(offer){for(var res=offer.sdp.split("\r\n"),i=0;i<res.length;i++)if("a=ssrc:"==res[i].substring(0,7)){var idx=res[i].indexOf(" ");!res[i].substr(idx+1).split(":",2)[0]||void 0!==res[i].substr(idx+1).split(":",2)[1]&&""!==res[i].substr(idx+1).split(":",2)[1]||res.splice(i,1)}return offer.sdp=res.join("\r\n"),offer},JingleSession.prototype.sendTransportReplace=function(){Strophe.log("","[Strophe.jingle] sendTransportReplace");var self=this,options={iceRestart:!0};self.isReconnecting?Strophe.log("","[Strophe.jingle] sendTransportReplace ignored because we're already connecting"):(self.isReconnecting=!0,this.peerconnection.createOffer((function(sdp){self.createdOffer(sdp,"transport-replace")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] createOffer failed",e)}),options))},JingleSession.prototype.reconnectSession=function(){Strophe.log("","[Strophe.jingle] reconnectSession");var self=this,options={iceRestart:!0};self.isReconnecting?Strophe.log("","[Strophe.jingle] reconnectSession ignored because we're already connecting"):(self.isReconnecting=!0,self.hasSentTransportReplace=!0,this.peerconnection.createOffer((function(sdp){self.sendCreatedOfferWithAckWait(sdp,"transport-replace")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] createOffer failed",e)}),options))},JingleSession.prototype.saveIncomingTransportReplace=function(elem,desctype,ack){Strophe.log("","[Strophe.jingle] saveIncomingTransportReplace"),this.savedIncomingTransportReplace={elem:elem,desctype:desctype,ack:ack}},JingleSession.prototype.acceptSavedIncomingTransportReplace=function(){Strophe.log("","[Strophe.jingle] acceptSavedIncomingTransportReplace"),this.connection.send(this.savedIncomingTransportReplace.ack),this.setRemoteDescription(this.savedIncomingTransportReplace.elem,this.savedIncomingTransportReplace.desctype),$(document).trigger("transportreplace.jingle",[this.sid]),this.savedIncomingTransportReplace=null},JingleSession.prototype.rejectSavedIncomingTransportReplace=function(){if(Strophe.log("","[Strophe.jingle] rejectSavedIncomingTransportReplace"),this.savedIncomingTransportReplace&&this.savedIncomingTransportReplace.ack){var ack=this.savedIncomingTransportReplace.ack;ack.type="error",ack.c("error",{type:"reject"}),this.connection.send(ack)}this.savedIncomingTransportReplace=null},JingleSession.prototype.sendCreatedOfferWithAckWait=function(offer,actionName){try{offer=this.hackOfferSDP(offer),offer=this.hackMsLabelSDP(offer);var self=this;this.localSDP=new SDP(offer.sdp);var action=actionName||"session-initiate";Strophe.log("","[Strophe.jingle] sendCreatedOfferWithAckWait with SDP : "+offer.sdp+" and action : "+action);var init=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:action,initiator:this.initiator,sid:this.sid,localType:this.localType});this.calledNumber&&""!==this.calledNumber&&((init=init.c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("callednumber").t(this.calledNumber)).up(),init.up()),this.localSDP.toJingle(init,this.initiator==this.me?"initiator":"responder",this.conference_id),this.connection.sendIQ(init,(function(stanza){if(stanza&&$(stanza).find("error").length)return Strophe.log("","[Strophe.jingle] sendCreatedOfferWithAckWait -- IQ ACK with error"),self.hasSentTransportReplace=!1,void(self.savedIncomingTransportReplace&&self.acceptSavedIncomingTransportReplace());if(Strophe.log("","[Strophe.jingle] sendCreatedOfferWithAckWait -- IQ ACK received, set local description"),self.hasSentTransportReplace=!1,self.savedIncomingTransportReplace){if(!self.isInitiator)return void self.acceptSavedIncomingTransportReplace();self.rejectSavedIncomingTransportReplace()}offer.sdp=self.localSDP.raw,self.peerconnection.setLocalDescription(offer,(function(){$(document).trigger("setLocalDescription.jingle",[self.sid]),Strophe.log("","[Strophe.jingle] setLocalDescription success")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setLocalDescription failed",e)}))}),(function(){Strophe.log("","[Strophe.jingle] sendCreatedOfferWithAckWait -- IQ rejected"),self.hasSentTransportReplace=!1,self.savedIncomingTransportReplace?self.acceptSavedIncomingTransportReplace():self.isReconnecting=!1}),this.jingleIqTimeout)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.createdOffer failed: "+error)}},JingleSession.prototype.sendOffer=function(restart){Strophe.log("","[Strophe.jingle] sendOffer");var self=this;if(restart){Strophe.log("","ice restart");var options={};if((-1===this.conference_id&&!this.calledNumber||"video"!==this.localType)&&(options.iceRestart=!0),this.ice_config.simulcast&&-1!==this.conference_id&&"video"===this.localType&&adapter&&adapter.default&&"firefox"===adapter.default.browserDetails.browser){Strophe.log("","[Strophe.jingle] Enabling Simulcasting for Firefox (RID)");var sender=this.peerconnection.getSenders().find((function(s){return"video"==s.track.kind}));if(sender){var parameters=sender.getParameters();parameters||(parameters={}),parameters.encodings=[{rid:"h",active:!0,maxBitrate:9e5},{rid:"m",active:!0,maxBitrate:3e5,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:1e5,scaleResolutionDownBy:4}],sender.setParameters(parameters)}}this.peerconnection.createOffer((function(offer){self.createdOffer(offer)}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] createOffer failed",e)}),options)}else this.peerconnection.createOffer((function(offer){self.createdOffer(offer)}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] createOffer failed",e)}),this.media_constraints)},JingleSession.prototype.createdOffer=function(offer,actionName){try{offer=this.hackOfferSDP(offer),offer=this.hackMsLabelSDP(offer);var self=this;this.localSDP=new SDP(offer.sdp);var action=actionName||"session-initiate";Strophe.log("","[Strophe.jingle] createdOffer with SDP : "+offer.sdp+" and action : "+action);var init=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:action,initiator:this.initiator,sid:this.sid,localType:this.localType});this.calledNumber&&""!==this.calledNumber&&((init=init.c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("callednumber").t(this.calledNumber)).up(),init.up()),this.localSDP.toJingle(init,this.initiator==this.me?"initiator":"responder",this.conference_id),this.connection.sendIQ(init,(function(){var ack={source:"offer"};$(document).trigger("ack.jingle",[self.sid,ack])}),(function(stanza){self.state="error",self.peerconnection&&"closed"!==self.peerconnection.signalingState&&(Strophe.log("","[Strophe.jingle] Clear peerconnection"),self.peerconnection.close(),self.peerconnection=null);var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};error.source="offer",$(document).trigger("error.jingle",{sid:self.sid,error:error})}),this.jingleIqTimeout),offer.sdp=this.localSDP.raw,this.peerconnection.setLocalDescription(offer,(function(){$(document).trigger("setLocalDescription.jingle",[self.sid]),Strophe.log("","[Strophe.jingle] setLocalDescription success")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setLocalDescription failed",e)}))}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.createdOffer failed: "+error)}},JingleSession.prototype.contentRemove=function(streamType){Strophe.log("","[Strophe.jingle] contentRemove");var self=this;this.peerconnection.createOffer((function(sdp){self.contentUpdateOffer(sdp,streamType,"remove")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] contentRemove failed",e)}),this.media_constraints)},JingleSession.prototype.contentAdd=function(streamType){Strophe.log("","[Strophe.jingle] contentAdd");var self=this;this.peerconnection.createOffer((function(sdp){self.contentUpdateOffer(sdp,streamType,"add")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] contentAdd failed",e)}),this.media_constraints)},JingleSession.prototype.contentModify=function(streamType){Strophe.log("","[Strophe.jingle] contentModify");var self=this;this.peerconnection.createOffer((function(sdp){self.contentUpdateOffer(sdp,streamType,"modify")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] contentModify failed",e)}),this.media_constraints)},JingleSession.prototype.contentUpdateOffer=function(sdp,streamType,actionType){try{Strophe.log("","[Strophe.jingle] contentUpdateOffer",sdp.sdp);var self=this;sdp=this.hackMsLabelSDP(sdp),this.localSDP=new SDP(sdp.sdp),"audio"===streamType?self.localType="audio":"video"===streamType?self.localType="audio+video":"sharing"===streamType?self.localType="sharing":"sharing+video"===streamType&&(self.localType="sharing+video");var init=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"content-"+actionType,initiator:this.initiator,sid:this.sid,mediaType:streamType});this.calledNumber&&""!==this.calledNumber&&((init=init.c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("callednumber").t(this.calledNumber)).up(),init.up()),this.localSDP.toJingle(init,this.initiator==this.me?"initiator":"responder",this.conference_id),this.connection.sendIQ(init,(function(){var ack={source:"offer"};$(document).trigger("ack.jingle",[self.sid,ack])}),(function(stanza){self.state="error",self.peerconnection&&(Strophe.log("","[Strophe.jingle] Clear peerconnection"),self.peerconnection.close(),self.peerconnection=null);var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};error.source="offer",$(document).trigger("error.jingle",{sid:self.sid,error:error})}),this.jingleIqTimeout),sdp.sdp=this.localSDP.raw,this.peerconnection.setLocalDescription(sdp,(function(){$(document).trigger("setLocalDescription.jingle",[self.sid]),Strophe.log("","[Strophe.jingle] setLocalDescription success")}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setLocalDescription failed",e)}))}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.contentUpdateOffer failed: "+error)}},JingleSession.prototype.contentChangeAnswer=function(sdp,updateStreams){try{Strophe.log("","[Strophe.jingle] contentChangeAnswer",sdp.sdp);var self=this;sdp=this.hackMsLabelSDP(sdp),this.localSDP=new SDP(sdp.sdp);var init=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"content-accept",initiator:this.initiator,sid:this.sid});this.calledNumber&&""!==this.calledNumber&&((init=init.c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("callednumber").t(this.calledNumber)).up(),init.up()),this.localSDP.toJingle(init,this.initiator==this.me?"initiator":"responder",this.conference_id),this.connection.sendIQ(init,(function(){var ack={source:"offer"};$(document).trigger("ack.jingle",[self.sid,ack])}),(function(stanza){self.state="error",self.peerconnection&&(Strophe.log("","[Strophe.jingle] Clear peerconnection"),self.peerconnection.close(),self.peerconnection=null);var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};error.source="offer",$(document).trigger("error.jingle",{sid:self.sid,error:error})}),this.jingleIqTimeout),sdp.sdp=this.localSDP.raw,this.peerconnection.setLocalDescription(sdp,(function(){$(document).trigger("setLocalDescription.jingle",[self.sid]),Strophe.log("","[Strophe.jingle] setLocalDescription success"),self.unifiedPlanActivated&&updateStreams&&self.updateRemoteStreams()}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setLocalDescription failed",e)}))}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.contentChangeAnswer failed: "+error)}},JingleSession.prototype.updateBandwidthRestriction=function(sdp,isConference,isMobile){var bandwidth=isConference||isMobile?500:1200;if("audio"===this.localType||isConference)return Strophe.log("","[Strophe.jingle] do not updateBandwidthRestriction"),sdp;"sharing"!==this.localType&&"sharing"!==this.remoteType||(bandwidth=isConference||isMobile?800:1500),"sharing+video"===this.localType&&(bandwidth=isMobile?1300:2700);var modifier="AS";if("firefox"===adapter.default.browserDetails.browser&&(bandwidth=1e3*(bandwidth>>>0),modifier="TIAS"),bandwidth>0)if(-1===sdp.indexOf("b="+modifier+":")){var indexOfVideo=sdp.indexOf("m=video");if(indexOfVideo>0){var videoDesc=sdp.substring(indexOfVideo);videoDesc=videoDesc.replace(/c=IN (.*)\r\n/,"c=IN $1\r\nb="+modifier+":"+bandwidth+"\r\n"),sdp=sdp.substring(0,indexOfVideo)+videoDesc}}else sdp=sdp.replace(new RegExp("b="+modifier+":.*\r\n"),"b="+modifier+":"+bandwidth+"\r\n");else sdp.replace(new RegExp("b="+modifier+":.*\r\n"),"");return Strophe.log("","[Strophe.jingle] updateBandwidthRestriction to ",bandwidth),sdp},JingleSession.prototype.setRemoteDescription=function(elem,desctype){Strophe.log("","[Strophe.jingle] setRemoteDescription ",desctype);var self=this;if(this.remoteSDP=new SDP(""),this.remoteSDP.fromJingle(elem),this.isInitiator?this.remoteSDP.raw=this.remoteSDP.raw.replace(/a=setup:passive/g,"a=setup:active"):this.remoteSDP.raw=this.remoteSDP.raw.replace(/a=setup:active/g,"a=setup:passive"),navigator.platform.toUpperCase().indexOf("MAC")>=0&&(this.remoteSDP.raw=this.forceCodecTo(this.remoteSDP.raw,"H264/90000","video")),-1!==this.conference_id||this.confId||this.publisherId)this.remoteSDP.raw=this.updateBandwidthRestriction(this.remoteSDP.raw,!0);else{var isMobile=!1;this.peerjid&&(isMobile=-1!==this.peerjid.indexOf("mobile_android")||-1!==this.peerjid.indexOf("mobile_ios")||-1!==this.peerjid.indexOf("deskphone")),this.remoteSDP.raw=this.updateBandwidthRestriction(this.remoteSDP.raw,!1,isMobile)}this.DTX&&(Strophe.log("","[Strophe.jingle] activate Discontinuous Transmission (DTX)"),this.remoteSDP.raw=this.remoteSDP.raw.replace("useinbandfec=1","useinbandfec=1;usedtx=1")),Strophe.log("","[Strophe.jingle] setRemoteDescription after parsing "+this.remoteSDP.raw);var remotedesc=new window.RTCSessionDescription({type:desctype,sdp:this.remoteSDP.raw});Strophe.log("","[Strophe.jingle] setRemoteDescription object ",remotedesc),this.peerconnection.setRemoteDescription(remotedesc,(function(){Strophe.log("","[Strophe.jingle] setRemoteDescription success"),self.unifiedPlanActivated&&(self.localTransceivers=self.peerconnection.getTransceivers())}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setRemoteDescription error "+e)})),Strophe.log("","[Strophe.jingle] setRemoteDescription is setting, try to update the RTP Sender "),this.ice_config.enableDSCP&&this.peerconnection.getSenders().forEach((function(rtpSender){if(console.error(rtpSender),rtpSender.getParameters&&rtpSender.setParameters){var params=rtpSender.getParameters();console.error(params),params.encodings.forEach((function(encoding){encoding.priority="high",encoding.networkPriority="high"})),rtpSender.setParameters(params),console.error(rtpSender.getParameters())}}))},JingleSession.prototype.addIceCandidate=function(elem){Strophe.log("","[Strophe.jingle] addIceCandidate");var self=this;elem.each((function(){var i,idx=-1;for(i=0;i<self.remoteSDP.media.length;i++)if(SDPUtil.find_line(self.remoteSDP.media[i],"a=mid:"+$(this).attr("name"))||0===self.remoteSDP.media[i].indexOf("m="+$(this).attr("name"))){idx=i;break}if(-1==idx)for(i=0;i<self.localSDP.media.length;i++)if(SDPUtil.find_line(self.localSDP.media[i],"a=mid:"+$(this).attr("name"))||0===self.localSDP.media[i].indexOf("m="+$(this).attr("name"))){idx=i;break}var ufrag,pwd,name=$(this).attr("name");$(this).find("content>transport").each((function(){ufrag=this.getAttribute("ufrag"),pwd=this.getAttribute("pwd")})),$(this).find("transport>candidate").each((function(){var line,candidate;line=SDPUtil.candidateFromJingle(this,ufrag,pwd),candidate=new window.RTCIceCandidate({sdpMLineIndex:idx,sdpMid:name,candidate:line});try{if(candidate&&self.iceFilterList&&self.iceFilterList.length&&-1!==self.iceFilterList.indexOf(candidate.type))return void Strophe.log("","[Strophe.jingle] Received ICE candidate "+candidate.type+" is filtered");self.peerconnection.addIceCandidate(candidate)}catch(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] addIceCandidate failed",e.toString(),line)}}))}))},JingleSession.prototype.sendAnswer=function(provisional,type){Strophe.log("","[Strophe.jingle] sendAnswer",provisional);var self=this;this.peerconnection.createAnswer((function(sdp){self.createdAnswer(sdp,provisional,type)}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] createAnswer failed",e)}),this.media_constraints)},JingleSession.prototype.createdAnswer=function(sdp,provisional,type){try{Strophe.log("","[Strophe.jingle] createdAnswer");var self=this;sdp=this.hackMsLabelSDP(sdp),this.localSDP=new SDP(sdp.sdp),this.usepranswer=!0===provisional;var action=type||"session-accept";type&&(self.isReconnecting=!1),Strophe.log("","sdp is "+sdp.sdp);var accept=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:action,initiator:this.initiator,responder:this.responder,sid:this.sid,localType:this.localType});this.calledNumber&&""!==this.calledNumber&&((accept=accept.c("mediapillar",{xmlns:"urn:xmpp:janus:1"}).c("callednumber").t(this.calledNumber)).up(),accept.up()),this.localSDP.toJingle(accept,this.initiator==this.me?"initiator":"responder",this.conference_id),this.connection.sendIQ(accept,(function(){var ack={source:"answer"};$(document).trigger("ack.jingle",[self.sid,ack])}),(function(stanza){var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};error.source="answer",$(document).trigger("error.jingle",{sid:self.sid,error:error})}),this.jingleIqTimeout),sdp.sdp=this.localSDP.raw,this.peerconnection.setLocalDescription(sdp,(function(){$(document).trigger("setLocalDescription.jingle",[self.sid]),Strophe.log("","[Strophe.jingle] createdAnswer -- setLocalDescription success, try to update the RTP Sender "),self.ice_config.enableDSCP&&self.peerconnection.getSenders().forEach((function(rtpSender){if(rtpSender.getParameters&&rtpSender.setParameters){var params=rtpSender.getParameters();params.encodings.forEach((function(encoding){encoding.priority="high",encoding.networkPriority="high"})),rtpSender.setParameters(params),Strophe.log("","[Strophe.jingle] RTP Sender parameters are updated "+rtpSender.getParameters())}}))}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] setLocalDescription failed",e)}));for(var cands=SDPUtil.find_lines(this.localSDP.raw,"a=candidate:"),j=0;j<cands.length;j++){var cand=SDPUtil.parse_icecandidate(cands[j]);"srflx"==cand.type?this.hadstuncandidate=!0:"relay"==cand.type&&(this.hadturncandidate=!0)}}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.createdAnswer failed: "+error)}},JingleSession.prototype.sendTerminate=function(reason,text){try{var self=this,term=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-terminate",initiator:this.initiator,sid:this.sid}).c("reason").c(reason||"success");text&&term.up().c("text").t(text),this.connection.sendIQ(term,(function(){!self.peerconnection||"closed"===self.peerconnection.signalingState&&"undefined"!=self.peerconnection.signalingState||(self.peerconnection.close(),self.terminate()),Strophe.log("","[Strophe.jingle] Clear peerconnection"),self.peerconnection=null;var ack={source:"terminate"};$(document).trigger("ack.jingle",[self.sid,ack])}),(function(stanza){var error=$(stanza).find("error").length?{code:$(stanza).find("error").attr("code"),reason:$(stanza).find("error :first")[0].tagName}:{};$(document).trigger("ack.jingle",[self.sid,error])}),this.jingleIqTimeout),null!==this.statsinterval&&(window.clearInterval(this.statsinterval),this.statsinterval=null)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.sendTerminate failed: "+error)}},JingleSession.prototype.mediaModified=function(updateStreams){var self=this;this.peerconnection.createAnswer((function(sdp){self.contentChangeAnswer(sdp,updateStreams)}),(function(e){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] contentChange failed",e)}),this.media_constraints)},JingleSession.prototype.addSource=function(elem){Strophe.log("","[Strophe.jingle] addssrc",(new Date).getTime()),Strophe.log("","[Strophe.jingle] ice",this.peerconnection.iceConnectionState);var sdp=new SDP(this.peerconnection.remoteDescription.sdp),self=this;$(elem).each((function(idx,content){var name=$(content).attr("name"),lines="";tmp=$(content).find('>source[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]'),tmp.each((function(){var ssrc=$(this).attr("ssrc");$(this).find(">parameter").each((function(){lines+="a=ssrc:"+ssrc+" "+$(this).attr("name"),$(this).attr("value")&&$(this).attr("value").length&&(lines+=":"+$(this).attr("value")),lines+="\r\n"}))})),sdp.media.forEach((function(media,idx){SDPUtil.find_line(media,"a=mid:"+name)&&(sdp.media[idx]+=lines,self.addssrc[idx]||(self.addssrc[idx]=""),self.addssrc[idx]+=lines)})),sdp.raw=sdp.session+sdp.media.join("")})),this.modifySources()},JingleSession.prototype.removeSource=function(elem){Strophe.log("","[Strophe.jingle] removessrc",(new Date).getTime()),Strophe.log("","[Strophe.jingle] ice",this.peerconnection.iceConnectionState);var sdp=new SDP(this.peerconnection.remoteDescription.sdp),self=this;$(elem).each((function(idx,content){var name=$(content).attr("name"),lines="";tmp=$(content).find('>source[xmlns="urn:xmpp:jingle:apps:rtp:ssma:0"]'),tmp.each((function(){var ssrc=$(this).attr("ssrc");$(this).find(">parameter").each((function(){lines+="a=ssrc:"+ssrc+" "+$(this).attr("name"),$(this).attr("value")&&$(this).attr("value").length&&(lines+=":"+$(this).attr("value")),lines+="\r\n"}))})),sdp.media.forEach((function(media,idx){SDPUtil.find_line(media,"a=mid:"+name)&&(sdp.media[idx]+=lines,self.addssrc[idx]||(self.removessrc[idx]=""),self.removessrc[idx]+=lines)})),sdp.raw=sdp.session+sdp.media.join("")})),this.modifySources()},JingleSession.prototype.modifySources=function(){var self=this;if(this.peerconnection&&"closed"!=this.peerconnection.signalingState&&(this.addssrc.length||this.removessrc.length||null!==this.pendingop)){if(!this.wait&&("stable"!=this.peerconnection.signalingState||"connected"!=this.peerconnection.iceConnectionState&&"completed"!=this.peerconnection.iceConnectionState))return console.warn("[Strophe.jingle] modifySources not yet",this.peerconnection.signalingState,this.peerconnection.iceConnectionState),this.wait=!0,void window.setTimeout((function(){self.modifySources()}),1500);if(this.wait)return window.setTimeout((function(){self.modifySources()}),2500),void(this.wait=!1);var sdp=new SDP(this.peerconnection.remoteDescription.sdp);this.addssrc.forEach((function(lines,idx){sdp.media[idx]+=lines})),this.addssrc=[],this.removessrc.forEach((function(lines,idx){(lines=lines.split("\r\n")).pop(),lines.forEach((function(line){sdp.media[idx]=sdp.media[idx].replace(line+"\r\n","")}))})),this.removessrc=[],sdp.raw=sdp.session+sdp.media.join(""),this.peerconnection.setRemoteDescription(new window.RTCSessionDescription({type:"offer",sdp:sdp.raw}),(function(){self.peerconnection.createAnswer((function(modifiedAnswer){if(null!==self.pendingop){var _sdp=new SDP(modifiedAnswer.sdp);if(_sdp.media.length>1){switch(self.pendingop){case"mute":_sdp.media[1]=_sdp.media[1].replace("a=sendrecv","a=recvonly");break;case"unmute":_sdp.media[1]=_sdp.media[1].replace("a=recvonly","a=sendrecv")}_sdp.raw=_sdp.session+_sdp.media.join(""),modifiedAnswer.sdp=_sdp.raw}self.pendingop=null}self.peerconnection.setLocalDescription(modifiedAnswer,(function(){$(document).trigger("setLocalDescription.jingle",[self.sid])}),(function(error){Strophe.log("","[Strophe.jingle] modified setLocalDescription failed")}))}),(function(error){Strophe.log("","[Strophe.jingle] modified answer failed")}))}),(function(error){Strophe.log("","[Strophe.jingle] modify failed")}))}},JingleSession.prototype.hardMuteVideo=function(muted){this.connection.jingle.localStream&&(this.pendingop=muted?"mute":"unmute",this.modifySources(),this.connection.jingle.localStream.getVideoTracks().forEach((function(track){track.enabled=!muted})))},JingleSession.prototype.mute=function(muted){this.connection.jingle.localStream&&(this.pendingop=muted?"mute":"unmute",this.modifySources(),this.connection.jingle.localStream.getVideoTracks().forEach((function(track){track.enabled=!muted})),this.connection.jingle.localStream.getAudioTracks().forEach((function(track){track.enabled=!muted})))},JingleSession.prototype.muteVideo=function(muted){this.connection.jingle.localStream&&(this.pendingop=muted?"mute":"unmute",this.modifySources(),this.connection.jingle.localStream.getVideoTracks().forEach((function(track){track.enabled=!muted})))},JingleSession.prototype.muteAudio=function(muted){this.connection.jingle.localStream&&this.connection.jingle.localStream.getAudioTracks().forEach((function(track){track.enabled=!muted})),this.localStreams.length>=1&&this.localStreams.forEach((function(stream){stream.getAudioTracks().forEach((function(track){track.enabled=!muted}))}))},JingleSession.prototype.sendMute=function(muted,content){try{var info=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-info",initiator:this.initiator,sid:this.sid});info.c(muted?"mute":"unmute",{xmlns:"urn:xmpp:jingle:apps:rtp:info:1"}),info.attrs({creator:this.me==this.initiator?"creator":"responder"}),content&&info.attrs({name:content}),this.connection.sendIQ(info)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.sendMute failed: "+error)}},JingleSession.prototype.sendHold=function(hold){try{var info=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-info",initiator:this.initiator,sid:this.sid});info.c(hold?"hold":"unhold",{xmlns:"urn:xmpp:jingle:apps:rtp:info:1"}),this.connection.sendIQ(info)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.sendMute failed: "+error)}},JingleSession.prototype.sendIceFailed=function(){try{var info=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-info",initiator:this.initiator,sid:this.sid});info.c("iceFailed",{xmlns:"urn:xmpp:jingle:apps:rtp:info:1"}),this.connection.sendIQ(info)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.sendIceFailed failed: "+error)}},JingleSession.prototype.sendRinging=function(){try{var info=$iq({to:this.peerjid,type:"set"}).c("jingle",{xmlns:"urn:xmpp:jingle:1",action:"session-info",initiator:this.initiator,sid:this.sid});info.c("ringing",{xmlns:"urn:xmpp:jingle:apps:rtp:info:1"}),this.connection.sendIQ(info)}catch(error){Strophe.log(Strophe.LogLevel.ERROR,"[Strophe.jingle] JingleSession.prototype.sendRinging failed: "+error)}},JingleSession.prototype.forceCodecTo=function(sdp,codecToForce,media){for(var from,to,codecName,indexFound,j,splittedSDP=sdp.split("\r\n"),indexVideo=-1,indexPos=-1,codec=[],list=[],i=0,l=splittedSDP.length;i<l;i++){var line=splittedSDP[i];if(line.indexOf("m="+media)>-1&&(indexVideo=i,indexPos=line.indexOf("RTP/SAVPF")+10,list=line.substring(indexPos).split(" ")),line.indexOf(codecToForce)>-1){for(from=line.indexOf(":"),to=line.indexOf(" "),codecName=line.substring(from+1,to),indexFound=-1,codec.push(codecName),j=0;j<list.length;j++)if(list[j]===codecName){indexFound=j;break}indexFound>-1&&list.splice(indexFound,1)}if("PCMU/8000"===codecToForce&&line.indexOf("PCMA/8000")>-1){for(from=line.indexOf(":"),to=line.indexOf(" "),codecName=line.substring(from+1,to),indexFound=-1,codec.push(codecName),j=0;j<list.length;j++)if(list[j]===codecName){indexFound=j;break}indexFound>-1&&list.splice(indexFound,1)}}if(-1!==indexVideo){splittedSDP[indexVideo]=splittedSDP[indexVideo].substr(0,indexPos-1);for(var k=0;k<codec.length;k++)splittedSDP[indexVideo]+=" "+codec[k];list.length>0&&(splittedSDP[indexVideo]+=" "+list.join(" ")),sdp=splittedSDP.join("\r\n")}return sdp},JingleSession.prototype.mungeSdpForSimulcasting=function(sdp){for(var lines=sdp.split("\r\n"),video=!1,ssrc=[-1],ssrc_fid=[-1],cname=null,msid=null,mslabel=null,label=null,insertAt=-1,i=0;i<lines.length;i++){if(mline=lines[i].match(/m=(\w+) */)){if("video"===mline[1]){if(!(ssrc[0]<0)){insertAt=i;break}video=!0}else if(ssrc[0]>-1){insertAt=i;break}}else if(video){var fid=lines[i].match(/a=ssrc-group:FID (\d+) (\d+)/);if(fid)ssrc[0]=fid[1],ssrc_fid[0]=fid[2],lines.splice(i,1),i--;else{if(ssrc[0]){if((match=lines[i].match("a=ssrc:"+ssrc[0]+" cname:(.+)"))&&(cname=match[1]),(match=lines[i].match("a=ssrc:"+ssrc[0]+" msid:(.+)"))&&(msid=match[1]),(match=lines[i].match("a=ssrc:"+ssrc[0]+" mslabel:(.+)"))&&(mslabel=match[1]),(match=lines[i].match("a=ssrc:"+ssrc[0]+" label:(.+)"))&&(label=match[1]),0===lines[i].indexOf("a=ssrc:"+ssrc_fid[0])){lines.splice(i,1),i--;continue}if(0===lines[i].indexOf("a=ssrc:"+ssrc[0])){lines.splice(i,1),i--;continue}}0!=lines[i].length||(lines.splice(i,1),i--)}}}if(ssrc[0]<0){insertAt=-1,video=!1;for(i=0;i<lines.length;i++){var mline;if(mline=lines[i].match(/m=(\w+) */)){if("video"===mline[1]){if(!(ssrc[0]<0)){insertAt=i;break}video=!0}else if(ssrc[0]>-1){insertAt=i;break}}else if(video){if(ssrc[0]<0){var value=lines[i].match(/a=ssrc:(\d+)/);if(value){ssrc[0]=value[1],lines.splice(i,1),i--;continue}}else{var match;if((match=lines[i].match("a=ssrc:"+ssrc[0]+" cname:(.+)"))&&(cname=match[1]),(match=lines[i].match("a=ssrc:"+ssrc[0]+" msid:(.+)"))&&(msid=match[1]),(match=lines[i].match("a=ssrc:"+ssrc[0]+" mslabel:(.+)"))&&(mslabel=match[1]),(match=lines[i].match("a=ssrc:"+ssrc[0]+" label:(.+)"))&&(label=match[1]),0===lines[i].indexOf("a=ssrc:"+ssrc_fid[0])){lines.splice(i,1),i--;continue}if(0===lines[i].indexOf("a=ssrc:"+ssrc[0])){lines.splice(i,1),i--;continue}}0!=lines[i].length||(lines.splice(i,1),i--)}}}if(ssrc[0]<0)return Janus.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),sdp;insertAt<0&&(insertAt=lines.length),ssrc[1]=Math.floor(4294967295*Math.random()),ssrc[2]=Math.floor(4294967295*Math.random()),ssrc_fid[1]=Math.floor(4294967295*Math.random()),ssrc_fid[2]=Math.floor(4294967295*Math.random());for(i=0;i<ssrc.length;i++)cname&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" cname:"+cname),insertAt++),msid&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" msid:"+msid),insertAt++),mslabel&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" mslabel:"+mslabel),insertAt++),label&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc[i]+" label:"+label),insertAt++),cname&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" cname:"+cname),insertAt++),msid&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" msid:"+msid),insertAt++),mslabel&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" mslabel:"+mslabel),insertAt++),label&&(lines.splice(insertAt,0,"a=ssrc:"+ssrc_fid[i]+" label:"+label),insertAt++);return lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[2]+" "+ssrc_fid[2]),lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[1]+" "+ssrc_fid[1]),lines.splice(insertAt,0,"a=ssrc-group:FID "+ssrc[0]+" "+ssrc_fid[0]),lines.splice(insertAt,0,"a=ssrc-group:SIM "+ssrc[0]+" "+ssrc[1]+" "+ssrc[2]),(sdp=lines.join("\r\n")).endsWith("\r\n")||(sdp+="\r\n"),sdp},JingleSession.prototype.getStats=function(interval){var self=this,recv={audio:0,video:0},lost={audio:0,video:0},lastrecv={audio:0,video:0},lastlost={audio:0,video:0},bytesSent={audio:0,video:0},bytesReceived={audio:0,video:0},sec=interval/1e3,isFirstTime=!0,lastNumberPacketsLostAudio=0,lastNumberPacketsReceivedAudio=0,iteration=0,globalMOS=0,globalRTT=0,globalJitter=0,globalJitterDepth=0,maxRTT=0,maxJitter=0,maxJitterDepth=0,candidatePair="",newStat={bitrate:{}},networkType="",localCandidateIp="";return this.statsinterval&&(window.clearInterval(this.statsinterval),this.statsinterval=null),this.ice_config.debugWebRTC&&(interval=1e3),this.statsinterval=window.setInterval((function(){self&&self.peerconnection?navigator.mozGetUserMedia?self.peerconnection.getStats().then((function(res){var items=[];res.forEach((function(result){items.push(result)})),function(items){$(document).trigger("statsFirefox.jingle",[self.sid,items]);for(var localCandidateId,remoteCandidateId,data=new Object,audioKBReceived=0,videoKBReceived=0,stats=[],i=0;i<items.length;++i){if("audio"==items[i].mediaType&&items[i].bytesReceived){bytesReceived.audio||(bytesReceived.audio=items[i].bytesReceived);var bytes=items[i].bytesReceived-bytesReceived.audio;bytesReceived.audio=items[i].bytesReceived,audioKBReceived=8*bytes/(1024*sec),data.audioReceived={bytesReceived:bytesReceived.audio,packetsLost:items[i].packetsLost,packetsReceived:items[i].packetsReceived}}else if("audio"==items[i].mediaType&&items[i].bytesSent)data.audioSent={bytesSent:items[i].bytesSent,packetsSent:items[i].packetsSent};else if("video"==items[i].mediaType&&items[i].bytesReceived){bytesReceived.video||(bytesReceived.video=items[i].bytesReceived);bytes=items[i].bytesReceived-bytesReceived.video;bytesReceived.video=items[i].bytesReceived,videoKBReceived=bytes?8*bytes/(1024*sec):0,data.videoReceived={bytesReceived:bytesReceived.video,packetsLost:items[i].packetsLost,packetsReceived:items[i].packetsReceived}}else"video"==items[i].mediaType&&items[i].bytesSent&&(data.videoSent={bytesSent:items[i].bytesSent,packetsSent:items[i].packetsSent});"candidate-pair"===items[i].type&&"succeeded"===items[i].state&&!0===items[i].selected&&(localCandidateId=items[i].localCandidateId,remoteCandidateId=items[i].remoteCandidateId),isFirstTime&&"localcandidate"===items[i].type&&items[i].id===localCandidateId&&(data.connectionType||(data.connectionType={}),data.connectionType.local={candidateType:items[i].candidateType,ipAddress:items[i].ipAddress+":"+items[i].portNumber,transport:items[i].transport}),isFirstTime&&"remotecandidate"===items[i].type&&items[i].id===remoteCandidateId&&(data.connectionType||(data.connectionType={}),data.connectionType.remote={candidateType:items[i].candidateType,ipAddress:items[i].ipAddress+":"+items[i].portNumber}),("candidate-pair"!==items[i].type||items[i].selected)&&("local-candidate"===items[i].type&&items[i].id!==localCandidateId||"remote-candidate"===items[i].type&&items[i].id!==remoteCandidateId||stats.push(items[i]));var res=items[i],inStats=!1;if(("video"===res.mediaType||res.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===res.type&&res.id.indexOf("rtcp")<0?inStats=!0:"ssrc"!=res.type||!res.bytesReceived||"VP8"!==res.googCodecName&&""!==res.googCodecName||(inStats=!0),inStats)if(newStat.bitrate.bsnow=res.bytesReceived,newStat.bitrate.tsnow=res.timestamp,void 0===newStat.bitrate.bsbefore||void 0===newStat.bitrate.tsbefore)newStat.bitrate.bsbefore=newStat.bitrate.bsnow,newStat.bitrate.tsbefore=newStat.bitrate.tsnow;else{var timePassed=newStat.bitrate.tsnow-newStat.bitrate.tsbefore;"safari"==adapter.default.browserDetails.browser&&(timePassed/=1e3);var bitRate=Math.round(8*(newStat.bitrate.bsnow-newStat.bitrate.bsbefore)/timePassed);"safari"===adapter.default.browserDetails.browser&&(bitRate=parseInt(bitRate/1e3)),newStat.bitrate.value=bitRate+" kbits/sec",newStat.bitrate.bsbefore=newStat.bitrate.bsnow,newStat.bitrate.tsbefore=newStat.bitrate.tsnow,$(document).trigger("webrtcSessionBitRate.jingle",[self.sid,newStat.bitrate])}}data.availableIncomingAudioBandwidth=audioKBReceived,data.availableIncomingVideoBandwidth=videoKBReceived,data.connectionType&&(isFirstTime=!1,$(document).trigger("webrtcConnectionType.jingle",[self.sid,data.connectionType])),$(document).trigger("webrtcFirefoxStats.jingle",[self.sid,data])}(items)})):self.peerconnection.getStats?self.peerconnection.getStats((function(res){var items=[];res.result().forEach((function(result){var item={};result.names().forEach((function(name){item[name]=result.stat(name)})),item.id=result.id,item.type=result.type,item.timestamp=result.timestamp,items.push(item)})),function(items){$(document).trigger("statsChrome.jingle",[self.sid,items]);for(var d,R,packetsAudioSent=0,packetsVideoSent=0,packetsAudioReceived=0,packetsVideoReceived=0,packetsAudioReveicedLost=0,packetsVideoReveicedLost=0,data=new Object,stats=[],audioInputLevel=0,audioOutputLevel=0,googRTTAudio=0,googJitterBufferMsAudio=0,googJitterReceived=0,mosPacketsReceivedAudio=0,mosPacketsLostAudio=0,Rx=0,Ry=0,MOS=0,currentDelay=0,E_Ipl=0,flagSendAudio=!1,flagSendVideo=!1,flagRecvAudio=!1,flagRecvVideo=!1,i=items.length-1;i>=0;i--){if("ssrc"==items[i].type)if(-1!==items[i].id.indexOf("send"))if("opus"!==items[i].googCodecName&&"PCMA"!==items[i].googCodecName&&"PCMU"!==items[i].googCodecName||flagSendAudio){if("VP8"==items[i].googCodecName&&!flagSendVideo){flagSendVideo=!0,packetsVideoSent=items[i].packetsSent,items[i].packetsLost,items[i].googFrameRateSent&&items[i].googFrameRateSent,bytesSent.video||(bytesSent.video=items[i].bytesSent),items[i].googRtt&&!googRTTAudio&&(googRTTAudio=parseInt(items[i].googRtt,10));bytes=items[i].bytesSent-bytesSent.video;bytesSent.video=items[i].bytesSent,8*bytes/(1024*sec)}}else{flagSendAudio=!0,packetsAudioSent=items[i].packetsSent,items[i].packetsLost,audioInputLevel=items[i].audioInputLevel,items[i].googRtt&&!googRTTAudio&&(googRTTAudio=parseInt(items[i].googRtt,10)),bytesSent.audio||(bytesSent.audio=items[i].bytesSent);var bytes=items[i].bytesSent-bytesSent.audio;bytesSent.audio=items[i].bytesSent,8*bytes/(1024*sec)}else if("opus"!==items[i].googCodecName&&"PCMA"!==items[i].googCodecName||flagRecvAudio){if("VP8"==items[i].googCodecName&&!flagRecvVideo){flagRecvVideo=!0,packetsVideoReceived=items[i].packetsReceived,packetsVideoReveicedLost+=items[i].packetsLost,items[i].googFrameRateReceived&&items[i].googFrameRateReceived,lastlost.video=lost.video,lastrecv.video=recv.video,recv.video=parseInt(packetsVideoReceived,10),lost.video=parseInt(packetsVideoReveicedLost,10),bytesReceived.video||(bytesReceived.video=items[i].bytesReceived);bytes=items[i].bytesReceived-bytesReceived.video;bytesReceived.video=items[i].bytesReceived,8*bytes/(1024*sec)}}else{flagRecvAudio=!0,packetsAudioReceived=items[i].packetsReceived,packetsAudioReveicedLost+=items[i].packetsLost,audioOutputLevel=items[i].audioOutputLevel,lastlost.audio=lost.audio,lastrecv.audio=recv.audio,recv.audio=parseInt(packetsAudioReceived,10),lost.audio=parseInt(packetsAudioReveicedLost,10),googJitterBufferMsAudio=parseInt(items[i].googJitterBufferMs,10),googJitterReceived=parseInt(items[i].googJitterReceived,10),mosPacketsReceivedAudio=parseInt(items[i].packetsReceived,10)-lastNumberPacketsReceivedAudio,lastNumberPacketsReceivedAudio=parseInt(items[i].packetsReceived,10),mosPacketsReceivedAudio<0&&(mosPacketsReceivedAudio=0),mosPacketsLostAudio=parseInt(items[i].packetsLost,10)-lastNumberPacketsLostAudio,lastNumberPacketsLostAudio=parseInt(items[i].packetsLost,10),mosPacketsLostAudio<0&&(mosPacketsLostAudio=0),E_Ipl=mosPacketsLostAudio/(50*sec)*100,currentDelay=items[i].googCurrentDelayMs,bytesReceived.audio||(bytesReceived.audio=items[i].bytesReceived);var bytes=items[i].bytesReceived-bytesReceived.audio;bytesReceived.audio=items[i].bytesReceived,8*bytes/(1024*sec)}"googCandidatePair"==items[i].type&&"true"===items[i].googWritable&&isFirstTime&&(data.localCandidateType=items[i].googLocalCandidateType,data.localAddress=items[i].googLocalAddress,data.localTransportType=items[i].googTransportType,data.remoteCandidateType=items[i].googRemoteCandidateType,data.remoteAddress=items[i].googRemoteAddress,localCandidateIp=items[i].googLocalAddress.split(":")[0],items[i].googRemoteAddress.split(":")[0],candidatePair=data.localAddress+" [ "+data.localCandidateType+" ] <-> "+data.remoteAddress+" [ "+data.remoteCandidateType+" ] || "+data.localTransportType),"localcandidate"===items[i].type&&items[i].ipAddress===localCandidateIp&&(data.networkType=items[i].networkType,networkType=data.networkType),"googCandidatePair"===items[i].type&&"0"===items[i].requestsReceived||"remotecandidate"===items[i].type||"localcandidate"===items[i].type||"googCertificate"===items[i].type||"googComponent"===items[i].type||"googTrack"===items[i].type||"googLibjingleSession"===items[i].type||"VideoBwe"===items[i].type||stats.push(items[i]);var res=items[i],inStats=!1;if(("video"===res.mediaType||res.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===res.type&&res.id.indexOf("rtcp")<0?inStats=!0:"ssrc"!=res.type||!res.bytesReceived||"VP8"!==res.googCodecName&&""!==res.googCodecName||(inStats=!0),inStats)if(newStat.bitrate.bsnow=res.bytesReceived,newStat.bitrate.tsnow=res.timestamp,void 0===newStat.bitrate.bsbefore||void 0===newStat.bitrate.tsbefore)newStat.bitrate.bsbefore=newStat.bitrate.bsnow,newStat.bitrate.tsbefore=newStat.bitrate.tsnow;else{var timePassed=newStat.bitrate.tsnow-newStat.bitrate.tsbefore;"safari"==adapter.default.browserDetails.browser&&(timePassed/=1e3);var bitRate=Math.round(8*(newStat.bitrate.bsnow-newStat.bitrate.bsbefore)/timePassed);"safari"===adapter.default.browserDetails.browser&&(bitRate=parseInt(bitRate/1e3)),newStat.bitrate.value=bitRate+" kbits/sec",newStat.bitrate.bsbefore=newStat.bitrate.bsnow,newStat.bitrate.tsbefore=newStat.bitrate.tsnow,$(document).trigger("webrtcSessionBitRate.jingle",[self.sid,newStat.bitrate])}}mosPacketsReceivedAudio&&(Ry=.18*(Rx=93.2-E_Ipl)*Rx-27.9*Rx+1126.62),MOS=(R=Ry-(.024*(d=currentDelay)+.11*(d-177.3)*(d-177.3<0?0:1)))<0?1:R>100?4.5:1+.035*R+R*(R-60)*(100-R)*7*1e-6;var currentFlag=0;R>=80?currentFlag=2:R<80&&R>=60&&(currentFlag=1),data.googRTTAudio=googRTTAudio,data.googJitterBufferMsAudio=googJitterBufferMsAudio,data.googJitterReceived=googJitterReceived,data.mosPacketsReceivedAudio=mosPacketsReceivedAudio,data.mosPacketsLostAudio=mosPacketsLostAudio,data.MOS=MOS,data.candidatePair=candidatePair,MOS&&(iteration+=1,globalMOS+=MOS,globalRTT+=googRTTAudio,globalJitter+=googJitterReceived,globalJitterDepth+=googJitterBufferMsAudio,data.iteration=iteration,data.currentDelay=d,data.MOS=MOS,data.networkQualityFlag=currentFlag,data.meanMOS=globalMOS/iteration,maxRTT=maxRTT<googRTTAudio?googRTTAudio:maxRTT,maxJitter=maxJitter<googJitterReceived?googJitterReceived:maxJitter,maxJitterDepth=maxJitterDepth<googJitterBufferMsAudio?googJitterBufferMsAudio:maxJitterDepth),data.packetsAudioSent=parseInt(packetsAudioSent,10),data.packetsAudioReceived=parseInt(packetsAudioReceived,10),data.audioInputLevel=parseInt(audioInputLevel,10),data.audioOutputLevel=parseInt(audioOutputLevel,10),data.packetsVideoSent=parseInt(packetsVideoSent,10),data.packetsVideoReceived=parseInt(packetsVideoReceived,10),data.bytesSent=bytesSent,data.bytesReceived=bytesReceived,data.localCandidateType&&(isFirstTime=!1,$(document).trigger("webrtcConnectionType.jingle",[self.sid,data])),stats.RainMetrics={type:"mscore",meanRTT:globalRTT/iteration,maxRTT:maxRTT,meanJitter:globalJitter/iteration,maxJitter:maxJitter,meanJitterDepth:globalJitterDepth/iteration,maxJitterDepth:maxJitterDepth,candidatePair:data.candidatePair,networkType:networkType,meanMOS:data.meanMOS},$(document).trigger("webrtcSessionStats.jingle",[self.sid,stats]),$(document).trigger("webrtcSessionStatsSimplyfied.jingle",[self.sid,data]),data&&Strophe.log("","[Strophe.jingle] webrtcChromeStats audio packets received : "+data.packetsAudioReceived+" / audio packets sent : "+data.packetsAudioSent+" / for session "+self.sid)}(items)})):Strophe.log("","[Strophe.jingle] getStats does not exist..."):Strophe.log("","[Strophe.jingle] getStats no peerconnection")}),interval||1e3),this.statsinterval}},function(module,exports){Strophe.addConnectionPlugin("mam",{_c:null,_p:["with","start","end"],init:function(conn){this._c=conn,Strophe.addNamespace("MAM","urn:xmpp:mam:1")},query:function(jid,options){var _p=this._p,attr={type:"set",id:jid},mamAttr={xmlns:Strophe.NS.MAM};options.queryid&&(mamAttr.queryid=options.queryid,delete options.queryid);var i,iq=$iq(attr).c("query",mamAttr).c("x",{xmlns:"jabber:x:data",type:"submit"});for(iq.c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("urn:xmpp:mam:1").up().up(),i=0;i<this._p.length;i++){var pn=_p[i],p=options[pn];delete options[pn],p&&iq.c("field",{var:pn}).c("value").t(p).up().up()}iq.up(),delete options.onMessage;var onComplete=options.onComplete;return delete options.onComplete,iq.cnode(new Strophe.RSM(options).toXML()),this._c.sendIQ(iq,onComplete)},querymuc:function(jid,to,options){var _p=this._p,attr={to:to,type:"set",id:jid},mamAttr={xmlns:Strophe.NS.MAM};options.queryid&&(mamAttr.queryid=options.queryid,delete options.queryid);var i,iq=$iq(attr).c("query",mamAttr).c("x",{xmlns:"jabber:x:data",type:"submit"});for(iq.c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t(Strophe.NS.MAM).up().up(),i=0;i<this._p.length;i++){var pn=_p[i],p=options[pn];delete options[pn],p&&iq.c("field",{var:pn}).c("value").t(p).up().up()}iq.up();var onComplete=options.onComplete;return delete options.onComplete,iq.cnode(new Strophe.RSM(options).toXML()),this._c.sendIQ(iq,onComplete)},delete:function(queryId,options){var _p=this._p,attr={type:"set",id:queryId},mamAttr={xmlns:Strophe.NS.MAM};options.queryid&&(mamAttr.queryid=options.queryid,delete options.queryid);var i,iq=$iq(attr).c("delete",mamAttr).c("x",{xmlns:"jabber:x:data",type:"submit"});for(iq.c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t(Strophe.NS.MAM).up().up(),i=0;i<this._p.length;i++){var attribKey=_p[i],attribValue=options[attribKey];attribValue&&iq.c("field",{var:attribKey}).c("value").t(attribValue).up().up()}iq.up(),delete options.onMessage;var onComplete=options.onComplete;return delete options.onComplete,iq.cnode(new Strophe.RSM(options).toXML()),this._c.sendIQ(iq,onComplete)}})},function(module,exports){!function(){"use strict";Strophe.addConnectionPlugin("calllog",{_c:null,_p:["with"],init:function(conn){this._c=conn,Strophe.addNamespace("CALLLOG","jabber:iq:telephony:call:log")},query:function(jid,options){var i,_p=this._p,attr={type:"set",id:130,from:jid},mamAttr={xmlns:Strophe.NS.CALLLOG},iq=$iq(attr).c("query",mamAttr).c("x",{xmlns:"jabber:x:data",type:"submit"});for(iq.c("field",{var:"FORM_TYPE",type:"hidden"}).c("value").t("jabber:iq:telephony:call:log").up().up(),i=0;i<this._p.length;i++){var pn=_p[i],p=options[pn];delete options[pn],p&&iq.c("field",{var:pn}).c("value").t(p).up().up()}iq.up();options.onMessage;delete options.onMessage;var onComplete=options.onComplete;return delete options.onComplete,iq.cnode(new Strophe.RSM(options).toXML()),this._c.sendIQ(iq,onComplete)}})}()},function(module,exports){!function(){"use strict";function noop(){}function inVals(stanza,ns){var ok=!1;return $('si feature x field[var="stream-method"] value',stanza).each((function(i,m){$(m).text()===ns&&(ok=!0)})),ok}Strophe.addConnectionPlugin("si_filetransfer",{_c:null,_cb:null,init:function(c){this._c=c,Strophe.addNamespace("SI","http://jabber.org/protocol/si"),Strophe.addNamespace("SI_FILE_TRANSFER",Strophe.NS.SI+"/profile/file-transfer"),Strophe.addNamespace("FEATURE_NEG","http://jabber.org/protocol/feature-neg"),c.addHandler(this._receive.bind(this),Strophe.NS.SI,"iq","set")},_receive:function(m){var $m=$(m),from=$m.attr("from"),id=$m.attr("id"),sid=$("si",$m).attr("id");if(Object.hasOwnProperty.call(this._c,"ibb")&&inVals(m,Strophe.NS.IBB))var $file=$("file",$m);var filename=$file.attr("name"),size=$file.attr("size"),mime=$("si",$m).attr("mime-type"),desc=$("desc",$m).text();return"function"==typeof this._cb&&this._cb(from,sid,filename,size,mime,id,desc),!0},_success:function(cb,stanza){var err;inVals(stanza,Strophe.NS.IBB)||(err=new Error("In-Band Bytestream not supported")),cb(err)},_fail:function(cb,stanza){var err="timed out";stanza&&(err=stanza),cb(new Error(err))},_send:function(iq,success,fail){this._c.sendIQ(iq,success,fail,18e4)},send:function(to,sid,filename,size,mime,description,cb){if(Object.hasOwnProperty.call(this._c,"ibb")){var iq=$iq({type:"set",to:to,id:this._c.getUniqueId("si-filetransfer")}).c("si",{xmlns:Strophe.NS.SI,id:sid,profile:Strophe.NS.SI_FILE_TRANSFER,"mime-type":mime}).c("file",{xmlns:Strophe.NS.SI_FILE_TRANSFER,name:filename,size:size}).c("desc").t(description).up().c("feature",{xmlns:Strophe.NS.FEATURE_NEG}).c("x",{xmlns:"jabber:x:data",type:"form"}).c("field",{var:"stream-method",type:"list-single"}).c("option").c("value").t(Strophe.NS.IBB);this._send(iq,this._success.bind(this,cb),this._fail.bind(this,cb))}else Strophe.warn("The In-Band Bytestream plugin is required.")},responseOk:function(to,sid,id){var iq=$iq({type:"result",to:to,id:id}).c("si",{xmlns:Strophe.NS.SI,id:sid}).c("file",{xmlns:Strophe.NS.SI_FILE_TRANSFER}).up().c("feature",{xmlns:Strophe.NS.FEATURE_NEG}).c("x",{xmlns:"jabber:x:data",type:"submit"}).c("field",{var:"stream-method"});iq.c("value").t(Strophe.NS.IBB),this._send(iq,noop,noop)},responseError:function(to,sid,id,errorCode){var iq=$iq({type:"error",to:to,id:id}).c("error",{code:errorCode,type:"cancel"}).c("forbidden",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"}).up().c("text",{xmlns:"urn:ietf:params:xml:ns:xmpp-stanzas"});iq.c("value").t(Strophe.NS.IBB),this._send(iq,noop,noop)},addFileHandler:function(fn){this._cb=fn}})}()},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var chrome_shim_namespaceObject={};__webpack_require__.r(chrome_shim_namespaceObject),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetUserMedia",(function(){return shimGetUserMedia})),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetDisplayMedia",(function(){return shimGetDisplayMedia})),__webpack_require__.d(chrome_shim_namespaceObject,"shimMediaStream",(function(){return shimMediaStream})),__webpack_require__.d(chrome_shim_namespaceObject,"shimOnTrack",(function(){return shimOnTrack})),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetSendersWithDtmf",(function(){return shimGetSendersWithDtmf})),__webpack_require__.d(chrome_shim_namespaceObject,"shimGetStats",(function(){return shimGetStats})),__webpack_require__.d(chrome_shim_namespaceObject,"shimSenderReceiverGetStats",(function(){return shimSenderReceiverGetStats})),__webpack_require__.d(chrome_shim_namespaceObject,"shimAddTrackRemoveTrackWithNative",(function(){return shimAddTrackRemoveTrackWithNative})),__webpack_require__.d(chrome_shim_namespaceObject,"shimAddTrackRemoveTrack",(function(){return shimAddTrackRemoveTrack})),__webpack_require__.d(chrome_shim_namespaceObject,"shimPeerConnection",(function(){return shimPeerConnection})),__webpack_require__.d(chrome_shim_namespaceObject,"fixNegotiationNeeded",(function(){return fixNegotiationNeeded}));var edge_shim_namespaceObject={};__webpack_require__.r(edge_shim_namespaceObject),__webpack_require__.d(edge_shim_namespaceObject,"shimGetUserMedia",(function(){return getusermedia_shimGetUserMedia})),__webpack_require__.d(edge_shim_namespaceObject,"shimGetDisplayMedia",(function(){return getdisplaymedia_shimGetDisplayMedia})),__webpack_require__.d(edge_shim_namespaceObject,"shimPeerConnection",(function(){return edge_shim_shimPeerConnection})),__webpack_require__.d(edge_shim_namespaceObject,"shimReplaceTrack",(function(){return shimReplaceTrack}));var firefox_shim_namespaceObject={};__webpack_require__.r(firefox_shim_namespaceObject),__webpack_require__.d(firefox_shim_namespaceObject,"shimGetUserMedia",(function(){return firefox_getusermedia_shimGetUserMedia})),__webpack_require__.d(firefox_shim_namespaceObject,"shimGetDisplayMedia",(function(){return firefox_getdisplaymedia_shimGetDisplayMedia})),__webpack_require__.d(firefox_shim_namespaceObject,"shimOnTrack",(function(){return firefox_shim_shimOnTrack})),__webpack_require__.d(firefox_shim_namespaceObject,"shimPeerConnection",(function(){return firefox_shim_shimPeerConnection})),__webpack_require__.d(firefox_shim_namespaceObject,"shimSenderGetStats",(function(){return shimSenderGetStats})),__webpack_require__.d(firefox_shim_namespaceObject,"shimReceiverGetStats",(function(){return shimReceiverGetStats})),__webpack_require__.d(firefox_shim_namespaceObject,"shimRemoveStream",(function(){return shimRemoveStream})),__webpack_require__.d(firefox_shim_namespaceObject,"shimRTCDataChannel",(function(){return shimRTCDataChannel})),__webpack_require__.d(firefox_shim_namespaceObject,"shimAddTransceiver",(function(){return shimAddTransceiver})),__webpack_require__.d(firefox_shim_namespaceObject,"shimGetParameters",(function(){return shimGetParameters})),__webpack_require__.d(firefox_shim_namespaceObject,"shimCreateOffer",(function(){return shimCreateOffer})),__webpack_require__.d(firefox_shim_namespaceObject,"shimCreateAnswer",(function(){return shimCreateAnswer}));var safari_shim_namespaceObject={};__webpack_require__.r(safari_shim_namespaceObject),__webpack_require__.d(safari_shim_namespaceObject,"shimLocalStreamsAPI",(function(){return shimLocalStreamsAPI})),__webpack_require__.d(safari_shim_namespaceObject,"shimRemoteStreamsAPI",(function(){return shimRemoteStreamsAPI})),__webpack_require__.d(safari_shim_namespaceObject,"shimCallbacksAPI",(function(){return shimCallbacksAPI})),__webpack_require__.d(safari_shim_namespaceObject,"shimGetUserMedia",(function(){return safari_shim_shimGetUserMedia})),__webpack_require__.d(safari_shim_namespaceObject,"shimConstraints",(function(){return shimConstraints})),__webpack_require__.d(safari_shim_namespaceObject,"shimRTCIceServerUrls",(function(){return shimRTCIceServerUrls})),__webpack_require__.d(safari_shim_namespaceObject,"shimTrackEventTransceiver",(function(){return shimTrackEventTransceiver})),__webpack_require__.d(safari_shim_namespaceObject,"shimCreateOfferLegacy",(function(){return shimCreateOfferLegacy})),__webpack_require__.d(safari_shim_namespaceObject,"shimAudioContext",(function(){return shimAudioContext}));var common_shim_namespaceObject={};__webpack_require__.r(common_shim_namespaceObject),__webpack_require__.d(common_shim_namespaceObject,"shimRTCIceCandidate",(function(){return shimRTCIceCandidate})),__webpack_require__.d(common_shim_namespaceObject,"shimMaxMessageSize",(function(){return shimMaxMessageSize})),__webpack_require__.d(common_shim_namespaceObject,"shimSendThrowTypeError",(function(){return shimSendThrowTypeError})),__webpack_require__.d(common_shim_namespaceObject,"shimConnectionState",(function(){return shimConnectionState})),__webpack_require__.d(common_shim_namespaceObject,"removeAllowExtmapMixed",(function(){return removeAllowExtmapMixed}));var adapter_core_namespaceObject={};__webpack_require__.r(adapter_core_namespaceObject),__webpack_require__.d(adapter_core_namespaceObject,"default",(function(){return adapter_core}));let logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(uastring,expr,pos){const match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}function wrapPeerConnectionEvent(window,eventNameToWrap,wrapper){if(!window.RTCPeerConnection)return;const proto=window.RTCPeerConnection.prototype,nativeAddEventListener=proto.addEventListener;proto.addEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap)return nativeAddEventListener.apply(this,arguments);const wrappedCallback=e=>{const modifiedEvent=wrapper(e);modifiedEvent&&(cb.handleEvent?cb.handleEvent(modifiedEvent):cb(modifiedEvent))};return this._eventMap=this._eventMap||{},this._eventMap[eventNameToWrap]||(this._eventMap[eventNameToWrap]=new Map),this._eventMap[eventNameToWrap].set(cb,wrappedCallback),nativeAddEventListener.apply(this,[nativeEventName,wrappedCallback])};const nativeRemoveEventListener=proto.removeEventListener;proto.removeEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap||!this._eventMap||!this._eventMap[eventNameToWrap])return nativeRemoveEventListener.apply(this,arguments);if(!this._eventMap[eventNameToWrap].has(cb))return nativeRemoveEventListener.apply(this,arguments);const unwrappedCb=this._eventMap[eventNameToWrap].get(cb);return this._eventMap[eventNameToWrap].delete(cb),0===this._eventMap[eventNameToWrap].size&&delete this._eventMap[eventNameToWrap],0===Object.keys(this._eventMap).length&&delete this._eventMap,nativeRemoveEventListener.apply(this,[nativeEventName,unwrappedCb])},Object.defineProperty(proto,"on"+eventNameToWrap,{get(){return this["_on"+eventNameToWrap]},set(cb){this["_on"+eventNameToWrap]&&(this.removeEventListener(eventNameToWrap,this["_on"+eventNameToWrap]),delete this["_on"+eventNameToWrap]),cb&&this.addEventListener(eventNameToWrap,this["_on"+eventNameToWrap]=cb)},enumerable:!0,configurable:!0})}function disableLog(bool){return"boolean"!=typeof bool?new Error("Argument type: "+typeof bool+". Please use a boolean."):(logDisabled_=bool,bool?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings(bool){return"boolean"!=typeof bool?new Error("Argument type: "+typeof bool+". Please use a boolean."):(deprecationWarnings_=!bool,"adapter.js deprecation warnings "+(bool?"disabled":"enabled"))}function log(){if("object"==typeof window){if(logDisabled_)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function deprecated(oldMethod,newMethod){deprecationWarnings_&&console.warn(oldMethod+" is deprecated, please use "+newMethod+" instead.")}function detectBrowser(window){const{navigator:navigator}=window,result={browser:null,version:null};if(void 0===window||!window.navigator)return result.browser="Not a browser.",result;if(navigator.mozGetUserMedia)result.browser="firefox",result.version=extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1);else if(navigator.webkitGetUserMedia||!1===window.isSecureContext&&window.webkitRTCPeerConnection&&!window.RTCIceGatherer)result.browser="chrome",result.version=extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))result.browser="edge",result.version=extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!window.RTCPeerConnection||!navigator.userAgent.match(/AppleWebKit\/(\d+)\./))return result.browser="Not a supported browser.",result;result.browser="safari",result.version=extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1),result.supportsUnifiedPlan=window.RTCRtpTransceiver&&"currentDirection"in window.RTCRtpTransceiver.prototype}return result}function isObject(val){return"[object Object]"===Object.prototype.toString.call(val)}function compactObject(data){return isObject(data)?Object.keys(data).reduce((function(accumulator,key){const isObj=isObject(data[key]),value=isObj?compactObject(data[key]):data[key],isEmptyObject=isObj&&!Object.keys(value).length;return void 0===value||isEmptyObject?accumulator:Object.assign(accumulator,{[key]:value})}),{}):data}function filterStats(result,track,outbound){const streamStatsType=outbound?"outbound-rtp":"inbound-rtp",filteredResult=new Map;if(null===track)return filteredResult;const trackStats=[];return result.forEach(value=>{"track"===value.type&&value.trackIdentifier===track.id&&trackStats.push(value)}),trackStats.forEach(trackStat=>{result.forEach(stats=>{stats.type===streamStatsType&&stats.trackId===trackStat.id&&function walkStats(stats,base,resultSet){base&&!resultSet.has(base.id)&&(resultSet.set(base.id,base),Object.keys(base).forEach(name=>{name.endsWith("Id")?walkStats(stats,stats.get(base[name]),resultSet):name.endsWith("Ids")&&base[name].forEach(id=>{walkStats(stats,stats.get(id),resultSet)})}))}(result,stats,filteredResult)})}),filteredResult}const getusermedia_logging=log;function shimGetUserMedia(window){const navigator=window&&window.navigator;if(!navigator.mediaDevices)return;const browserDetails=detectBrowser(window),constraintsToChrome_=function(c){if("object"!=typeof c||c.mandatory||c.optional)return c;const cc={};return Object.keys(c).forEach(key=>{if("require"===key||"advanced"===key||"mediaSource"===key)return;const r="object"==typeof c[key]?c[key]:{ideal:c[key]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const oldname_=function(prefix,name){return prefix?prefix+name.charAt(0).toUpperCase()+name.slice(1):"deviceId"===name?"sourceId":name};if(void 0!==r.ideal){cc.optional=cc.optional||[];let oc={};"number"==typeof r.ideal?(oc[oldname_("min",key)]=r.ideal,cc.optional.push(oc),oc={},oc[oldname_("max",key)]=r.ideal,cc.optional.push(oc)):(oc[oldname_("",key)]=r.ideal,cc.optional.push(oc))}void 0!==r.exact&&"number"!=typeof r.exact?(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_("",key)]=r.exact):["min","max"].forEach(mix=>{void 0!==r[mix]&&(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_(mix,key)]=r[mix])})}),c.advanced&&(cc.optional=(cc.optional||[]).concat(c.advanced)),cc},shimConstraints_=function(constraints,func){if(browserDetails.version>=61)return func(constraints);if((constraints=JSON.parse(JSON.stringify(constraints)))&&"object"==typeof constraints.audio){const remap=function(obj,a,b){a in obj&&!(b in obj)&&(obj[b]=obj[a],delete obj[a])};remap((constraints=JSON.parse(JSON.stringify(constraints))).audio,"autoGainControl","googAutoGainControl"),remap(constraints.audio,"noiseSuppression","googNoiseSuppression"),constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&"object"==typeof constraints.video){let face=constraints.video.facingMode;face=face&&("object"==typeof face?face:{ideal:face});const getSupportedFacingModeLies=browserDetails.version<66;if(face&&("user"===face.exact||"environment"===face.exact||"user"===face.ideal||"environment"===face.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode||getSupportedFacingModeLies)){let matches;if(delete constraints.video.facingMode,"environment"===face.exact||"environment"===face.ideal?matches=["back","rear"]:"user"!==face.exact&&"user"!==face.ideal||(matches=["front"]),matches)return navigator.mediaDevices.enumerateDevices().then(devices=>{let dev=(devices=devices.filter(d=>"videoinput"===d.kind)).find(d=>matches.some(match=>d.label.toLowerCase().includes(match)));return!dev&&devices.length&&matches.includes("back")&&(dev=devices[devices.length-1]),dev&&(constraints.video.deviceId=face.exact?{exact:dev.deviceId}:{ideal:dev.deviceId}),constraints.video=constraintsToChrome_(constraints.video),getusermedia_logging("chrome: "+JSON.stringify(constraints)),func(constraints)})}constraints.video=constraintsToChrome_(constraints.video)}return getusermedia_logging("chrome: "+JSON.stringify(constraints)),func(constraints)},shimError_=function(e){return browserDetails.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(navigator.getUserMedia=function(constraints,onSuccess,onError){shimConstraints_(constraints,c=>{navigator.webkitGetUserMedia(c,onSuccess,e=>{onError&&onError(shimError_(e))})})}.bind(navigator),navigator.mediaDevices.getUserMedia){const origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,c=>origGetUserMedia(c).then(stream=>{if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length)throw stream.getTracks().forEach(track=>{track.stop()}),new DOMException("","NotFoundError");return stream},e=>Promise.reject(shimError_(e))))}}}function shimGetDisplayMedia(window,getSourceId){window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||window.navigator.mediaDevices&&("function"==typeof getSourceId?window.navigator.mediaDevices.getDisplayMedia=function(constraints){return getSourceId(constraints).then(sourceId=>{const widthSpecified=constraints.video&&constraints.video.width,heightSpecified=constraints.video&&constraints.video.height,frameRateSpecified=constraints.video&&constraints.video.frameRate;return constraints.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId,maxFrameRate:frameRateSpecified||3}},widthSpecified&&(constraints.video.mandatory.maxWidth=widthSpecified),heightSpecified&&(constraints.video.mandatory.maxHeight=heightSpecified),window.navigator.mediaDevices.getUserMedia(constraints)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function shimMediaStream(window){window.MediaStream=window.MediaStream||window.webkitMediaStream}function shimOnTrack(window){if("object"==typeof window&&window.RTCPeerConnection&&!("ontrack"in window.RTCPeerConnection.prototype)){Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(f){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=f)},enumerable:!0,configurable:!0});const origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=e=>{e.stream.addEventListener("addtrack",te=>{let receiver;receiver=window.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(r=>r.track&&r.track.id===te.track.id):{track:te.track};const event=new Event("track");event.track=te.track,event.receiver=receiver,event.transceiver={receiver:receiver},event.streams=[e.stream],this.dispatchEvent(event)}),e.stream.getTracks().forEach(track=>{let receiver;receiver=window.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(r=>r.track&&r.track.id===track.id):{track:track};const event=new Event("track");event.track=track,event.receiver=receiver,event.transceiver={receiver:receiver},event.streams=[e.stream],this.dispatchEvent(event)})},this.addEventListener("addstream",this._ontrackpoly)),origSetRemoteDescription.apply(this,arguments)}}else wrapPeerConnectionEvent(window,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function shimGetSendersWithDtmf(window){if("object"==typeof window&&window.RTCPeerConnection&&!("getSenders"in window.RTCPeerConnection.prototype)&&"createDTMFSender"in window.RTCPeerConnection.prototype){const shimSenderWithDtmf=function(pc,track){return{track:track,get dtmf(){return void 0===this._dtmf&&("audio"===track.kind?this._dtmf=pc.createDTMFSender(track):this._dtmf=null),this._dtmf},_pc:pc}};if(!window.RTCPeerConnection.prototype.getSenders){window.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function(track,stream){let sender=origAddTrack.apply(this,arguments);return sender||(sender=shimSenderWithDtmf(this,track),this._senders.push(sender)),sender};const origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function(sender){origRemoveTrack.apply(this,arguments);const idx=this._senders.indexOf(sender);-1!==idx&&this._senders.splice(idx,1)}}const origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){this._senders=this._senders||[],origAddStream.apply(this,[stream]),stream.getTracks().forEach(track=>{this._senders.push(shimSenderWithDtmf(this,track))})};const origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){this._senders=this._senders||[],origRemoveStream.apply(this,[stream]),stream.getTracks().forEach(track=>{const sender=this._senders.find(s=>s.track===track);sender&&this._senders.splice(this._senders.indexOf(sender),1)})}}else if("object"==typeof window&&window.RTCPeerConnection&&"getSenders"in window.RTCPeerConnection.prototype&&"createDTMFSender"in window.RTCPeerConnection.prototype&&window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){const origGetSenders=window.RTCPeerConnection.prototype.getSenders;window.RTCPeerConnection.prototype.getSenders=function(){const senders=origGetSenders.apply(this,[]);return senders.forEach(sender=>sender._pc=this),senders},Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimGetStats(window){if(!window.RTCPeerConnection)return;const origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){const[selector,onSucc,onErr]=arguments;if(arguments.length>0&&"function"==typeof selector)return origGetStats.apply(this,arguments);if(0===origGetStats.length&&(0===arguments.length||"function"!=typeof selector))return origGetStats.apply(this,[]);const fixChromeStats_=function(response){const standardReport={};return response.result().forEach(report=>{const standardStats={id:report.id,timestamp:report.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[report.type]||report.type};report.names().forEach(name=>{standardStats[name]=report.stat(name)}),standardReport[standardStats.id]=standardStats}),standardReport},makeMapStats=function(stats){return new Map(Object.keys(stats).map(key=>[key,stats[key]]))};if(arguments.length>=2){const successCallbackWrapper_=function(response){onSucc(makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,selector])}return new Promise((resolve,reject)=>{origGetStats.apply(this,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}).then(onSucc,onErr)}}function shimSenderReceiverGetStats(window){if(!("object"==typeof window&&window.RTCPeerConnection&&window.RTCRtpSender&&window.RTCRtpReceiver))return;if(!("getStats"in window.RTCRtpSender.prototype)){const origGetSenders=window.RTCPeerConnection.prototype.getSenders;origGetSenders&&(window.RTCPeerConnection.prototype.getSenders=function(){const senders=origGetSenders.apply(this,[]);return senders.forEach(sender=>sender._pc=this),senders});const origAddTrack=window.RTCPeerConnection.prototype.addTrack;origAddTrack&&(window.RTCPeerConnection.prototype.addTrack=function(){const sender=origAddTrack.apply(this,arguments);return sender._pc=this,sender}),window.RTCRtpSender.prototype.getStats=function(){const sender=this;return this._pc.getStats().then(result=>filterStats(result,sender.track,!0))}}if(!("getStats"in window.RTCRtpReceiver.prototype)){const origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;origGetReceivers&&(window.RTCPeerConnection.prototype.getReceivers=function(){const receivers=origGetReceivers.apply(this,[]);return receivers.forEach(receiver=>receiver._pc=this),receivers}),wrapPeerConnectionEvent(window,"track",e=>(e.receiver._pc=e.srcElement,e)),window.RTCRtpReceiver.prototype.getStats=function(){const receiver=this;return this._pc.getStats().then(result=>filterStats(result,receiver.track,!1))}}if(!("getStats"in window.RTCRtpSender.prototype)||!("getStats"in window.RTCRtpReceiver.prototype))return;const origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof window.MediaStreamTrack){const track=arguments[0];let sender,receiver,err;return this.getSenders().forEach(s=>{s.track===track&&(sender?err=!0:sender=s)}),this.getReceivers().forEach(r=>(r.track===track&&(receiver?err=!0:receiver=r),r.track===track)),err||sender&&receiver?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):sender?sender.getStats():receiver?receiver.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return origGetStats.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(window){window.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(streamId=>this._shimmedLocalStreams[streamId][0])};const origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function(track,stream){if(!stream)return origAddTrack.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const sender=origAddTrack.apply(this,arguments);return this._shimmedLocalStreams[stream.id]?-1===this._shimmedLocalStreams[stream.id].indexOf(sender)&&this._shimmedLocalStreams[stream.id].push(sender):this._shimmedLocalStreams[stream.id]=[stream,sender],sender};const origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){this._shimmedLocalStreams=this._shimmedLocalStreams||{},stream.getTracks().forEach(track=>{if(this.getSenders().find(s=>s.track===track))throw new DOMException("Track already exists.","InvalidAccessError")});const existingSenders=this.getSenders();origAddStream.apply(this,arguments);const newSenders=this.getSenders().filter(newSender=>-1===existingSenders.indexOf(newSender));this._shimmedLocalStreams[stream.id]=[stream].concat(newSenders)};const origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[stream.id],origRemoveStream.apply(this,arguments)};const origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function(sender){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},sender&&Object.keys(this._shimmedLocalStreams).forEach(streamId=>{const idx=this._shimmedLocalStreams[streamId].indexOf(sender);-1!==idx&&this._shimmedLocalStreams[streamId].splice(idx,1),1===this._shimmedLocalStreams[streamId].length&&delete this._shimmedLocalStreams[streamId]}),origRemoveTrack.apply(this,arguments)}}function shimAddTrackRemoveTrack(window){if(!window.RTCPeerConnection)return;const browserDetails=detectBrowser(window);if(window.RTCPeerConnection.prototype.addTrack&&browserDetails.version>=65)return shimAddTrackRemoveTrackWithNative(window);const origGetLocalStreams=window.RTCPeerConnection.prototype.getLocalStreams;window.RTCPeerConnection.prototype.getLocalStreams=function(){const nativeStreams=origGetLocalStreams.apply(this);return this._reverseStreams=this._reverseStreams||{},nativeStreams.map(stream=>this._reverseStreams[stream.id])};const origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},stream.getTracks().forEach(track=>{if(this.getSenders().find(s=>s.track===track))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[stream.id]){const newStream=new window.MediaStream(stream.getTracks());this._streams[stream.id]=newStream,this._reverseStreams[newStream.id]=stream,stream=newStream}origAddStream.apply(this,[stream])};const origRemoveStream=window.RTCPeerConnection.prototype.removeStream;function replaceInternalStreamId(pc,description){let sdp=description.sdp;return Object.keys(pc._reverseStreams||[]).forEach(internalId=>{const externalStream=pc._reverseStreams[internalId],internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(internalStream.id,"g"),externalStream.id)}),new RTCSessionDescription({type:description.type,sdp:sdp})}function replaceExternalStreamId(pc,description){let sdp=description.sdp;return Object.keys(pc._reverseStreams||[]).forEach(internalId=>{const externalStream=pc._reverseStreams[internalId],internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(externalStream.id,"g"),internalStream.id)}),new RTCSessionDescription({type:description.type,sdp:sdp})}window.RTCPeerConnection.prototype.removeStream=function(stream){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},origRemoveStream.apply(this,[this._streams[stream.id]||stream]),delete this._reverseStreams[this._streams[stream.id]?this._streams[stream.id].id:stream.id],delete this._streams[stream.id]},window.RTCPeerConnection.prototype.addTrack=function(track,stream){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const streams=[].slice.call(arguments,1);if(1!==streams.length||!streams[0].getTracks().find(t=>t===track))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const alreadyExists=this.getSenders().find(s=>s.track===track);if(alreadyExists)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const oldStream=this._streams[stream.id];if(oldStream)oldStream.addTrack(track),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const newStream=new window.MediaStream([track]);this._streams[stream.id]=newStream,this._reverseStreams[newStream.id]=stream,this.addStream(newStream)}return this.getSenders().find(s=>s.track===track)},["createOffer","createAnswer"].forEach((function(method){const nativeMethod=window.RTCPeerConnection.prototype[method],methodObj={[method](){const args=arguments;return arguments.length&&"function"==typeof arguments[0]?nativeMethod.apply(this,[description=>{const desc=replaceInternalStreamId(this,description);args[0].apply(null,[desc])},err=>{args[1]&&args[1].apply(null,err)},arguments[2]]):nativeMethod.apply(this,arguments).then(description=>replaceInternalStreamId(this,description))}};window.RTCPeerConnection.prototype[method]=methodObj[method]}));const origSetLocalDescription=window.RTCPeerConnection.prototype.setLocalDescription;window.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=replaceExternalStreamId(this,arguments[0]),origSetLocalDescription.apply(this,arguments)):origSetLocalDescription.apply(this,arguments)};const origLocalDescription=Object.getOwnPropertyDescriptor(window.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(window.RTCPeerConnection.prototype,"localDescription",{get(){const description=origLocalDescription.get.apply(this);return""===description.type?description:replaceInternalStreamId(this,description)}}),window.RTCPeerConnection.prototype.removeTrack=function(sender){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!sender._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(sender._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let stream;this._streams=this._streams||{},Object.keys(this._streams).forEach(streamid=>{this._streams[streamid].getTracks().find(track=>sender.track===track)&&(stream=this._streams[streamid])}),stream&&(1===stream.getTracks().length?this.removeStream(this._reverseStreams[stream.id]):stream.removeTrack(sender.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection(window){const browserDetails=detectBrowser(window);if(!window.RTCPeerConnection&&window.webkitRTCPeerConnection&&(window.RTCPeerConnection=window.webkitRTCPeerConnection),!window.RTCPeerConnection)return;const addIceCandidateNullSupported=0===window.RTCPeerConnection.prototype.addIceCandidate.length;browserDetails.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(method){const nativeMethod=window.RTCPeerConnection.prototype[method],methodObj={[method](){return arguments[0]=new("addIceCandidate"===method?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)}};window.RTCPeerConnection.prototype[method]=methodObj[method]}));const nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function(){return addIceCandidateNullSupported||arguments[0]?browserDetails.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():nativeAddIceCandidate.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function fixNegotiationNeeded(window){const browserDetails=detectBrowser(window);wrapPeerConnectionEvent(window,"negotiationneeded",e=>{const pc=e.target;if(!(browserDetails.version<72||pc.getConfiguration&&"plan-b"===pc.getConfiguration().sdpSemantics)||"stable"===pc.signalingState)return e})}var rtcpeerconnection=__webpack_require__(234),rtcpeerconnection_default=__webpack_require__.n(rtcpeerconnection);function getusermedia_shimGetUserMedia(window){const navigator=window&&window.navigator,origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function getdisplaymedia_shimGetDisplayMedia(window){"getDisplayMedia"in window.navigator&&window.navigator.mediaDevices&&(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||(window.navigator.mediaDevices.getDisplayMedia=window.navigator.getDisplayMedia.bind(window.navigator)))}function edge_shim_shimPeerConnection(window){const browserDetails=detectBrowser(window);if(window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(args){return args}),window.RTCSessionDescription||(window.RTCSessionDescription=function(args){return args}),browserDetails.version<15025)){const origMSTEnabled=Object.getOwnPropertyDescriptor(window.MediaStreamTrack.prototype,"enabled");Object.defineProperty(window.MediaStreamTrack.prototype,"enabled",{set(value){origMSTEnabled.set.call(this,value);const ev=new Event("enabled");ev.enabled=value,this.dispatchEvent(ev)}})}window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)&&Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new window.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),window.RTCDtmfSender&&!window.RTCDTMFSender&&(window.RTCDTMFSender=window.RTCDtmfSender);const RTCPeerConnectionShim=rtcpeerconnection_default()(window,browserDetails.version);window.RTCPeerConnection=function(config){return config&&config.iceServers&&(config.iceServers=function(iceServers,edgeVersion){let hasTurn=!1;return(iceServers=JSON.parse(JSON.stringify(iceServers))).filter(server=>{if(server&&(server.urls||server.url)){var urls=server.urls||server.url;server.url&&!server.urls&&deprecated("RTCIceServer.url","RTCIceServer.urls");const isString="string"==typeof urls;return isString&&(urls=[urls]),urls=urls.filter(url=>{if(0===url.indexOf("stun:"))return!1;const validTurn=url.startsWith("turn")&&!url.startsWith("turn:[")&&url.includes("transport=udp");return validTurn&&!hasTurn?(hasTurn=!0,!0):validTurn&&!hasTurn}),delete server.url,server.urls=isString?urls[0]:urls,!!urls.length}})}(config.iceServers,browserDetails.version),log("ICE servers after filtering:",config.iceServers)),new RTCPeerConnectionShim(config)},window.RTCPeerConnection.prototype=RTCPeerConnectionShim.prototype}function shimReplaceTrack(window){window.RTCRtpSender&&!("replaceTrack"in window.RTCRtpSender.prototype)&&(window.RTCRtpSender.prototype.replaceTrack=window.RTCRtpSender.prototype.setTrack)}function firefox_getusermedia_shimGetUserMedia(window){const browserDetails=detectBrowser(window),navigator=window&&window.navigator,MediaStreamTrack=window&&window.MediaStreamTrack;if(navigator.getUserMedia=function(constraints,onSuccess,onError){deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)},!(browserDetails.version>55&&"autoGainControl"in navigator.mediaDevices.getSupportedConstraints())){const remap=function(obj,a,b){a in obj&&!(b in obj)&&(obj[b]=obj[a],delete obj[a])},nativeGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);if(navigator.mediaDevices.getUserMedia=function(c){return"object"==typeof c&&"object"==typeof c.audio&&(c=JSON.parse(JSON.stringify(c)),remap(c.audio,"autoGainControl","mozAutoGainControl"),remap(c.audio,"noiseSuppression","mozNoiseSuppression")),nativeGetUserMedia(c)},MediaStreamTrack&&MediaStreamTrack.prototype.getSettings){const nativeGetSettings=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){const obj=nativeGetSettings.apply(this,arguments);return remap(obj,"mozAutoGainControl","autoGainControl"),remap(obj,"mozNoiseSuppression","noiseSuppression"),obj}}if(MediaStreamTrack&&MediaStreamTrack.prototype.applyConstraints){const nativeApplyConstraints=MediaStreamTrack.prototype.applyConstraints;MediaStreamTrack.prototype.applyConstraints=function(c){return"audio"===this.kind&&"object"==typeof c&&(c=JSON.parse(JSON.stringify(c)),remap(c,"autoGainControl","mozAutoGainControl"),remap(c,"noiseSuppression","mozNoiseSuppression")),nativeApplyConstraints.apply(this,[c])}}}}function firefox_getdisplaymedia_shimGetDisplayMedia(window,preferredMediaSource){window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||window.navigator.mediaDevices&&(window.navigator.mediaDevices.getDisplayMedia=function(constraints){if(!constraints||!constraints.video){const err=new DOMException("getDisplayMedia without video constraints is undefined");return err.name="NotFoundError",err.code=8,Promise.reject(err)}return!0===constraints.video?constraints.video={mediaSource:preferredMediaSource}:constraints.video.mediaSource=preferredMediaSource,window.navigator.mediaDevices.getUserMedia(constraints)})}function firefox_shim_shimOnTrack(window){"object"==typeof window&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)&&Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function firefox_shim_shimPeerConnection(window){const browserDetails=detectBrowser(window);if("object"!=typeof window||!window.RTCPeerConnection&&!window.mozRTCPeerConnection)return;if(!window.RTCPeerConnection&&window.mozRTCPeerConnection&&(window.RTCPeerConnection=window.mozRTCPeerConnection),browserDetails.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(method){const nativeMethod=window.RTCPeerConnection.prototype[method],methodObj={[method](){return arguments[0]=new("addIceCandidate"===method?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)}};window.RTCPeerConnection.prototype[method]=methodObj[method]})),browserDetails.version<68){const nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():nativeAddIceCandidate.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const modernStatsTypes={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},nativeGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){const[selector,onSucc,onErr]=arguments;return nativeGetStats.apply(this,[selector||null]).then(stats=>{if(browserDetails.version<53&&!onSucc)try{stats.forEach(stat=>{stat.type=modernStatsTypes[stat.type]||stat.type})}catch(e){if("TypeError"!==e.name)throw e;stats.forEach((stat,i)=>{stats.set(i,Object.assign({},stat,{type:modernStatsTypes[stat.type]||stat.type}))})}return stats}).then(onSucc,onErr)}}function shimSenderGetStats(window){if("object"!=typeof window||!window.RTCPeerConnection||!window.RTCRtpSender)return;if(window.RTCRtpSender&&"getStats"in window.RTCRtpSender.prototype)return;const origGetSenders=window.RTCPeerConnection.prototype.getSenders;origGetSenders&&(window.RTCPeerConnection.prototype.getSenders=function(){const senders=origGetSenders.apply(this,[]);return senders.forEach(sender=>sender._pc=this),senders});const origAddTrack=window.RTCPeerConnection.prototype.addTrack;origAddTrack&&(window.RTCPeerConnection.prototype.addTrack=function(){const sender=origAddTrack.apply(this,arguments);return sender._pc=this,sender}),window.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(window){if("object"!=typeof window||!window.RTCPeerConnection||!window.RTCRtpSender)return;if(window.RTCRtpSender&&"getStats"in window.RTCRtpReceiver.prototype)return;const origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;origGetReceivers&&(window.RTCPeerConnection.prototype.getReceivers=function(){const receivers=origGetReceivers.apply(this,[]);return receivers.forEach(receiver=>receiver._pc=this),receivers}),wrapPeerConnectionEvent(window,"track",e=>(e.receiver._pc=e.srcElement,e)),window.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream(window){window.RTCPeerConnection&&!("removeStream"in window.RTCPeerConnection.prototype)&&(window.RTCPeerConnection.prototype.removeStream=function(stream){deprecated("removeStream","removeTrack"),this.getSenders().forEach(sender=>{sender.track&&stream.getTracks().includes(sender.track)&&this.removeTrack(sender)})})}function shimRTCDataChannel(window){window.DataChannel&&!window.RTCDataChannel&&(window.RTCDataChannel=window.DataChannel)}function shimAddTransceiver(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const origAddTransceiver=window.RTCPeerConnection.prototype.addTransceiver;origAddTransceiver&&(window.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const initParameters=arguments[1],shouldPerformCheck=initParameters&&"sendEncodings"in initParameters;shouldPerformCheck&&initParameters.sendEncodings.forEach(encodingParam=>{if("rid"in encodingParam){if(!/^[a-z0-9]{0,16}$/i.test(encodingParam.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in encodingParam&&!(parseFloat(encodingParam.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in encodingParam&&!(parseFloat(encodingParam.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const transceiver=origAddTransceiver.apply(this,arguments);if(shouldPerformCheck){const{sender:sender}=transceiver,params=sender.getParameters();"encodings"in params||(params.encodings=initParameters.sendEncodings,sender.sendEncodings=initParameters.sendEncodings,this.setParametersPromises.push(sender.setParameters(params).then(()=>{delete sender.sendEncodings}).catch(()=>{delete sender.sendEncodings})))}return transceiver})}function shimGetParameters(window){if("object"!=typeof window||!window.RTCRtpSender)return;const origGetParameters=window.RTCRtpSender.prototype.getParameters;origGetParameters&&(window.RTCRtpSender.prototype.getParameters=function(){var params=origGetParameters.apply(this,arguments);return"sendEncodings"in this?Object.assign({},{encodings:this.sendEncodings},params):params})}function shimCreateOffer(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>origCreateOffer.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):origCreateOffer.apply(this,arguments)}}function shimCreateAnswer(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const origCreateAnswer=window.RTCPeerConnection.prototype.createAnswer;window.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>origCreateAnswer.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):origCreateAnswer.apply(this,arguments)}}function shimLocalStreamsAPI(window){if("object"==typeof window&&window.RTCPeerConnection){if("getLocalStreams"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in window.RTCPeerConnection.prototype)){const _addTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addStream=function(stream){this._localStreams||(this._localStreams=[]),this._localStreams.includes(stream)||this._localStreams.push(stream),stream.getAudioTracks().forEach(track=>_addTrack.call(this,track,stream)),stream.getVideoTracks().forEach(track=>_addTrack.call(this,track,stream))},window.RTCPeerConnection.prototype.addTrack=function(track,...streams){return streams&&streams.forEach(stream=>{this._localStreams?this._localStreams.includes(stream)||this._localStreams.push(stream):this._localStreams=[stream]}),_addTrack.apply(this,arguments)}}"removeStream"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.removeStream=function(stream){this._localStreams||(this._localStreams=[]);const index=this._localStreams.indexOf(stream);if(-1===index)return;this._localStreams.splice(index,1);const tracks=stream.getTracks();this.getSenders().forEach(sender=>{tracks.includes(sender.track)&&this.removeTrack(sender)})})}}function shimRemoteStreamsAPI(window){if("object"==typeof window&&window.RTCPeerConnection&&("getRemoteStreams"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in window.RTCPeerConnection.prototype))){Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(f){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=f),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(stream=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(stream))return;this._remoteStreams.push(stream);const event=new Event("addstream");event.stream=stream,this.dispatchEvent(event)})})}});const origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){const pc=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(stream=>{if(pc._remoteStreams||(pc._remoteStreams=[]),pc._remoteStreams.indexOf(stream)>=0)return;pc._remoteStreams.push(stream);const event=new Event("addstream");event.stream=stream,pc.dispatchEvent(event)})}),origSetRemoteDescription.apply(pc,arguments)}}}function shimCallbacksAPI(window){if("object"!=typeof window||!window.RTCPeerConnection)return;const prototype=window.RTCPeerConnection.prototype,origCreateOffer=prototype.createOffer,origCreateAnswer=prototype.createAnswer,setLocalDescription=prototype.setLocalDescription,setRemoteDescription=prototype.setRemoteDescription,addIceCandidate=prototype.addIceCandidate;prototype.createOffer=function(successCallback,failureCallback){const options=arguments.length>=2?arguments[2]:arguments[0],promise=origCreateOffer.apply(this,[options]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.createAnswer=function(successCallback,failureCallback){const options=arguments.length>=2?arguments[2]:arguments[0],promise=origCreateAnswer.apply(this,[options]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise};let withCallback=function(description,successCallback,failureCallback){const promise=setLocalDescription.apply(this,[description]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise};prototype.setLocalDescription=withCallback,withCallback=function(description,successCallback,failureCallback){const promise=setRemoteDescription.apply(this,[description]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.setRemoteDescription=withCallback,withCallback=function(candidate,successCallback,failureCallback){const promise=addIceCandidate.apply(this,[candidate]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.addIceCandidate=withCallback}function safari_shim_shimGetUserMedia(window){const navigator=window&&window.navigator;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){const mediaDevices=navigator.mediaDevices,_getUserMedia=mediaDevices.getUserMedia.bind(mediaDevices);navigator.mediaDevices.getUserMedia=constraints=>_getUserMedia(shimConstraints(constraints))}!navigator.getUserMedia&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=function(constraints,cb,errcb){navigator.mediaDevices.getUserMedia(constraints).then(cb,errcb)}.bind(navigator))}function shimConstraints(constraints){return constraints&&void 0!==constraints.video?Object.assign({},constraints,{video:compactObject(constraints.video)}):constraints}function shimRTCIceServerUrls(window){if(!window.RTCPeerConnection)return;const OrigPeerConnection=window.RTCPeerConnection;window.RTCPeerConnection=function(pcConfig,pcConstraints){if(pcConfig&&pcConfig.iceServers){const newIceServers=[];for(let i=0;i<pcConfig.iceServers.length;i++){let server=pcConfig.iceServers[i];!server.hasOwnProperty("urls")&&server.hasOwnProperty("url")?(deprecated("RTCIceServer.url","RTCIceServer.urls"),server=JSON.parse(JSON.stringify(server)),server.urls=server.url,delete server.url,newIceServers.push(server)):newIceServers.push(pcConfig.iceServers[i])}pcConfig.iceServers=newIceServers}return new OrigPeerConnection(pcConfig,pcConstraints)},window.RTCPeerConnection.prototype=OrigPeerConnection.prototype,"generateCertificate"in OrigPeerConnection&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:()=>OrigPeerConnection.generateCertificate})}function shimTrackEventTransceiver(window){"object"==typeof window&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)&&Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy(window){const origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function(offerOptions){if(offerOptions){void 0!==offerOptions.offerToReceiveAudio&&(offerOptions.offerToReceiveAudio=!!offerOptions.offerToReceiveAudio);const audioTransceiver=this.getTransceivers().find(transceiver=>"audio"===transceiver.receiver.track.kind);!1===offerOptions.offerToReceiveAudio&&audioTransceiver?"sendrecv"===audioTransceiver.direction?audioTransceiver.setDirection?audioTransceiver.setDirection("sendonly"):audioTransceiver.direction="sendonly":"recvonly"===audioTransceiver.direction&&(audioTransceiver.setDirection?audioTransceiver.setDirection("inactive"):audioTransceiver.direction="inactive"):!0!==offerOptions.offerToReceiveAudio||audioTransceiver||this.addTransceiver("audio"),void 0!==offerOptions.offerToReceiveVideo&&(offerOptions.offerToReceiveVideo=!!offerOptions.offerToReceiveVideo);const videoTransceiver=this.getTransceivers().find(transceiver=>"video"===transceiver.receiver.track.kind);!1===offerOptions.offerToReceiveVideo&&videoTransceiver?"sendrecv"===videoTransceiver.direction?videoTransceiver.setDirection?videoTransceiver.setDirection("sendonly"):videoTransceiver.direction="sendonly":"recvonly"===videoTransceiver.direction&&(videoTransceiver.setDirection?videoTransceiver.setDirection("inactive"):videoTransceiver.direction="inactive"):!0!==offerOptions.offerToReceiveVideo||videoTransceiver||this.addTransceiver("video")}return origCreateOffer.apply(this,arguments)}}function shimAudioContext(window){"object"!=typeof window||window.AudioContext||(window.AudioContext=window.webkitAudioContext)}var sdp=__webpack_require__(52),sdp_default=__webpack_require__.n(sdp);function shimRTCIceCandidate(window){if(!window.RTCIceCandidate||window.RTCIceCandidate&&"foundation"in window.RTCIceCandidate.prototype)return;const NativeRTCIceCandidate=window.RTCIceCandidate;window.RTCIceCandidate=function(args){if("object"==typeof args&&args.candidate&&0===args.candidate.indexOf("a=")&&((args=JSON.parse(JSON.stringify(args))).candidate=args.candidate.substr(2)),args.candidate&&args.candidate.length){const nativeCandidate=new NativeRTCIceCandidate(args),parsedCandidate=sdp_default.a.parseCandidate(args.candidate),augmentedCandidate=Object.assign(nativeCandidate,parsedCandidate);return augmentedCandidate.toJSON=function(){return{candidate:augmentedCandidate.candidate,sdpMid:augmentedCandidate.sdpMid,sdpMLineIndex:augmentedCandidate.sdpMLineIndex,usernameFragment:augmentedCandidate.usernameFragment}},augmentedCandidate}return new NativeRTCIceCandidate(args)},window.RTCIceCandidate.prototype=NativeRTCIceCandidate.prototype,wrapPeerConnectionEvent(window,"icecandidate",e=>(e.candidate&&Object.defineProperty(e,"candidate",{value:new window.RTCIceCandidate(e.candidate),writable:"false"}),e))}function shimMaxMessageSize(window){if(!window.RTCPeerConnection)return;const browserDetails=detectBrowser(window);"sctp"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const sctpInDescription=function(description){if(!description||!description.sdp)return!1;const sections=sdp_default.a.splitSections(description.sdp);return sections.shift(),sections.some(mediaSection=>{const mLine=sdp_default.a.parseMLine(mediaSection);return mLine&&"application"===mLine.kind&&-1!==mLine.protocol.indexOf("SCTP")})},getRemoteFirefoxVersion=function(description){const match=description.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===match||match.length<2)return-1;const version=parseInt(match[1],10);return version!=version?-1:version},getCanSendMaxMessageSize=function(remoteIsFirefox){let canSendMaxMessageSize=65536;return"firefox"===browserDetails.browser&&(canSendMaxMessageSize=browserDetails.version<57?-1===remoteIsFirefox?16384:2147483637:browserDetails.version<60?57===browserDetails.version?65535:65536:2147483637),canSendMaxMessageSize},getMaxMessageSize=function(description,remoteIsFirefox){let maxMessageSize=65536;"firefox"===browserDetails.browser&&57===browserDetails.version&&(maxMessageSize=65535);const match=sdp_default.a.matchPrefix(description.sdp,"a=max-message-size:");return match.length>0?maxMessageSize=parseInt(match[0].substr(19),10):"firefox"===browserDetails.browser&&-1!==remoteIsFirefox&&(maxMessageSize=2147483637),maxMessageSize},origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===browserDetails.browser&&browserDetails.version>=76){const{sdpSemantics:sdpSemantics}=this.getConfiguration();"plan-b"===sdpSemantics&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(sctpInDescription(arguments[0])){const isFirefox=getRemoteFirefoxVersion(arguments[0]),canSendMMS=getCanSendMaxMessageSize(isFirefox),remoteMMS=getMaxMessageSize(arguments[0],isFirefox);let maxMessageSize;maxMessageSize=0===canSendMMS&&0===remoteMMS?Number.POSITIVE_INFINITY:0===canSendMMS||0===remoteMMS?Math.max(canSendMMS,remoteMMS):Math.min(canSendMMS,remoteMMS);const sctp={};Object.defineProperty(sctp,"maxMessageSize",{get:()=>maxMessageSize}),this._sctp=sctp}return origSetRemoteDescription.apply(this,arguments)}}function shimSendThrowTypeError(window){if(!window.RTCPeerConnection||!("createDataChannel"in window.RTCPeerConnection.prototype))return;function wrapDcSend(dc,pc){const origDataChannelSend=dc.send;dc.send=function(){const data=arguments[0],length=data.length||data.size||data.byteLength;if("open"===dc.readyState&&pc.sctp&&length>pc.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+pc.sctp.maxMessageSize+" bytes)");return origDataChannelSend.apply(dc,arguments)}}const origCreateDataChannel=window.RTCPeerConnection.prototype.createDataChannel;window.RTCPeerConnection.prototype.createDataChannel=function(){const dataChannel=origCreateDataChannel.apply(this,arguments);return wrapDcSend(dataChannel,this),dataChannel},wrapPeerConnectionEvent(window,"datachannel",e=>(wrapDcSend(e.channel,e.target),e))}function shimConnectionState(window){if(!window.RTCPeerConnection||"connectionState"in window.RTCPeerConnection.prototype)return;const proto=window.RTCPeerConnection.prototype;Object.defineProperty(proto,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(proto,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(cb){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),cb&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=cb)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(method=>{const origMethod=proto[method];proto[method]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const pc=e.target;if(pc._lastConnectionState!==pc.connectionState){pc._lastConnectionState=pc.connectionState;const newEvent=new Event("connectionstatechange",e);pc.dispatchEvent(newEvent)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),origMethod.apply(this,arguments)}})}function removeAllowExtmapMixed(window){if(!window.RTCPeerConnection)return;const browserDetails=detectBrowser(window);if("chrome"===browserDetails.browser&&browserDetails.version>=71)return;if("safari"===browserDetails.browser&&browserDetails.version>=605)return;const nativeSRD=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(desc){return desc&&desc.sdp&&-1!==desc.sdp.indexOf("\na=extmap-allow-mixed")&&(desc.sdp=desc.sdp.split("\n").filter(line=>"a=extmap-allow-mixed"!==line.trim()).join("\n")),nativeSRD.apply(this,arguments)}}var adapter_core=function({window:window}={},options={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const logging=log,browserDetails=detectBrowser(window),adapter={browserDetails:browserDetails,commonShim:common_shim_namespaceObject,extractVersion:extractVersion,disableLog:disableLog,disableWarnings:disableWarnings};switch(browserDetails.browser){case"chrome":if(!chrome_shim_namespaceObject||!shimPeerConnection||!options.shimChrome)return logging("Chrome shim is not included in this adapter release."),adapter;if(null===browserDetails.version)return logging("Chrome shim can not determine version, not shimming."),adapter;logging("adapter.js shimming chrome."),adapter.browserShim=chrome_shim_namespaceObject,shimGetUserMedia(window),shimMediaStream(window),shimPeerConnection(window),shimOnTrack(window),shimAddTrackRemoveTrack(window),shimGetSendersWithDtmf(window),shimGetStats(window),shimSenderReceiverGetStats(window),fixNegotiationNeeded(window),shimRTCIceCandidate(window),shimConnectionState(window),shimMaxMessageSize(window),shimSendThrowTypeError(window),removeAllowExtmapMixed(window);break;case"firefox":if(!firefox_shim_namespaceObject||!firefox_shim_shimPeerConnection||!options.shimFirefox)return logging("Firefox shim is not included in this adapter release."),adapter;logging("adapter.js shimming firefox."),adapter.browserShim=firefox_shim_namespaceObject,firefox_getusermedia_shimGetUserMedia(window),firefox_shim_shimPeerConnection(window),firefox_shim_shimOnTrack(window),shimRemoveStream(window),shimSenderGetStats(window),shimReceiverGetStats(window),shimRTCDataChannel(window),shimAddTransceiver(window),shimGetParameters(window),shimCreateOffer(window),shimCreateAnswer(window),shimRTCIceCandidate(window),shimConnectionState(window),shimMaxMessageSize(window),shimSendThrowTypeError(window);break;case"edge":if(!edge_shim_namespaceObject||!edge_shim_shimPeerConnection||!options.shimEdge)return logging("MS edge shim is not included in this adapter release."),adapter;logging("adapter.js shimming edge."),adapter.browserShim=edge_shim_namespaceObject,getusermedia_shimGetUserMedia(window),getdisplaymedia_shimGetDisplayMedia(window),edge_shim_shimPeerConnection(window),shimReplaceTrack(window),shimMaxMessageSize(window),shimSendThrowTypeError(window);break;case"safari":if(!safari_shim_namespaceObject||!options.shimSafari)return logging("Safari shim is not included in this adapter release."),adapter;logging("adapter.js shimming safari."),adapter.browserShim=safari_shim_namespaceObject,shimRTCIceServerUrls(window),shimCreateOfferLegacy(window),shimCallbacksAPI(window),shimLocalStreamsAPI(window),shimRemoteStreamsAPI(window),shimTrackEventTransceiver(window),safari_shim_shimGetUserMedia(window),shimAudioContext(window),shimRTCIceCandidate(window),shimMaxMessageSize(window),shimSendThrowTypeError(window),removeAllowExtmapMixed(window);break;default:logging("Unsupported browser!")}return adapter}({window:window}),connectionService=__webpack_require__(235),presenceService=__webpack_require__(236),userProfileService=__webpack_require__(237),contactsService=__webpack_require__(238),pbxService=__webpack_require__(239),conversationsService=__webpack_require__(240),imService=__webpack_require__(241),webRTCService=__webpack_require__(242),bubblesService=__webpack_require__(243),conferencesService=__webpack_require__(244),groupsService=__webpack_require__(245),callsLogService=__webpack_require__(246),favoritesService=__webpack_require__(247),filesStorageService=__webpack_require__(248),capabilitiesService=__webpack_require__(249),adminService=__webpack_require__(250),channelsService=__webpack_require__(251),sdkService=__webpack_require__(252),sdkConstant=__webpack_require__(28),call_model=__webpack_require__(0);__webpack_require__(253),__webpack_require__(254),__webpack_require__(255),window.adapter=adapter_core_namespaceObject,window.emojione=null,__webpack_require__(256),__webpack_require__(257),__webpack_require__(410),__webpack_require__(28),__webpack_require__(411),angular.module("sdk").service("connectionService",connectionService.ConnectionService),angular.module("sdk").service("presenceService",presenceService.PresenceService),angular.module("sdk").service("userProfileService",userProfileService.UserProfileService),angular.module("sdk").service("contactsService",contactsService.ContactsService),angular.module("sdk").service("pbxService",pbxService.PbxService),angular.module("sdk").service("conversationsService",conversationsService.ConversationsService),angular.module("sdk").service("imService",imService.ImService),angular.module("sdk").service("webRTCService",webRTCService.WebRTCService),angular.module("sdk").service("bubblesService",bubblesService.BubblesService),angular.module("sdk").service("conferencesService",conferencesService.ConferencesService),angular.module("sdk").service("groupsService",groupsService.GroupsService),angular.module("sdk").service("callsLogService",callsLogService.CallsLogService),angular.module("sdk").service("favoritesService",favoritesService.FavoritesService),angular.module("sdk").service("filesStorageService",filesStorageService.FilesStorageService),angular.module("sdk").service("capabilitiesService",capabilitiesService.CapabilitiesService),angular.module("sdk").service("adminService",adminService.AdminService),angular.module("sdk").service("channelsService",channelsService.ChannelsService),angular.module("sdk").service("rainbowSDK",sdkService.SdkService),angular.module("sdk")||angular.bootstrap(document,["sdk"]).get("rainbowSDK"),__webpack_require__(414),__webpack_require__(415),__webpack_require__(416),__webpack_require__(417),__webpack_require__(418),__webpack_require__(419),__webpack_require__(420),__webpack_require__(421),__webpack_require__(422);var rainbowSDK=angular.injector(["sdk"]).get("rainbowSDK");rainbowSDK.Call=call_model.Call,rainbowSDK.SDK=sdkConstant.SDK;__webpack_exports__.default=rainbowSDK}]);/* harmony default export */ __webpack_exports__["default"] = (rainbowSDK.default);

/***/ }),

/***/ "./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js":
/*!****************************************************************************!*\
  !*** ./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js ***!
  \****************************************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";


var isOldIE = function isOldIE() {
  var memo;
  return function memorize() {
    if (typeof memo === 'undefined') {
      // Test for IE <= 9 as proposed by Browserhacks
      // @see http://browserhacks.com/#hack-e71d8692f65334173fee715c222cb805
      // Tests for existence of standard globals is to allow style-loader
      // to operate correctly into non-standard environments
      // @see https://github.com/webpack-contrib/style-loader/issues/177
      memo = Boolean(window && document && document.all && !window.atob);
    }

    return memo;
  };
}();

var getTarget = function getTarget() {
  var memo = {};
  return function memorize(target) {
    if (typeof memo[target] === 'undefined') {
      var styleTarget = document.querySelector(target); // Special case to return head of iframe instead of iframe itself

      if (window.HTMLIFrameElement && styleTarget instanceof window.HTMLIFrameElement) {
        try {
          // This will throw an exception if access to iframe is blocked
          // due to cross-origin restrictions
          styleTarget = styleTarget.contentDocument.head;
        } catch (e) {
          // istanbul ignore next
          styleTarget = null;
        }
      }

      memo[target] = styleTarget;
    }

    return memo[target];
  };
}();

var stylesInDom = [];

function getIndexByIdentifier(identifier) {
  var result = -1;

  for (var i = 0; i < stylesInDom.length; i++) {
    if (stylesInDom[i].identifier === identifier) {
      result = i;
      break;
    }
  }

  return result;
}

function modulesToDom(list, options) {
  var idCountMap = {};
  var identifiers = [];

  for (var i = 0; i < list.length; i++) {
    var item = list[i];
    var id = options.base ? item[0] + options.base : item[0];
    var count = idCountMap[id] || 0;
    var identifier = "".concat(id, " ").concat(count);
    idCountMap[id] = count + 1;
    var index = getIndexByIdentifier(identifier);
    var obj = {
      css: item[1],
      media: item[2],
      sourceMap: item[3]
    };

    if (index !== -1) {
      stylesInDom[index].references++;
      stylesInDom[index].updater(obj);
    } else {
      stylesInDom.push({
        identifier: identifier,
        updater: addStyle(obj, options),
        references: 1
      });
    }

    identifiers.push(identifier);
  }

  return identifiers;
}

function insertStyleElement(options) {
  var style = document.createElement('style');
  var attributes = options.attributes || {};

  if (typeof attributes.nonce === 'undefined') {
    var nonce =  true ? __webpack_require__.nc : undefined;

    if (nonce) {
      attributes.nonce = nonce;
    }
  }

  Object.keys(attributes).forEach(function (key) {
    style.setAttribute(key, attributes[key]);
  });

  if (typeof options.insert === 'function') {
    options.insert(style);
  } else {
    var target = getTarget(options.insert || 'head');

    if (!target) {
      throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");
    }

    target.appendChild(style);
  }

  return style;
}

function removeStyleElement(style) {
  // istanbul ignore if
  if (style.parentNode === null) {
    return false;
  }

  style.parentNode.removeChild(style);
}
/* istanbul ignore next  */


var replaceText = function replaceText() {
  var textStore = [];
  return function replace(index, replacement) {
    textStore[index] = replacement;
    return textStore.filter(Boolean).join('\n');
  };
}();

function applyToSingletonTag(style, index, remove, obj) {
  var css = remove ? '' : obj.media ? "@media ".concat(obj.media, " {").concat(obj.css, "}") : obj.css; // For old IE

  /* istanbul ignore if  */

  if (style.styleSheet) {
    style.styleSheet.cssText = replaceText(index, css);
  } else {
    var cssNode = document.createTextNode(css);
    var childNodes = style.childNodes;

    if (childNodes[index]) {
      style.removeChild(childNodes[index]);
    }

    if (childNodes.length) {
      style.insertBefore(cssNode, childNodes[index]);
    } else {
      style.appendChild(cssNode);
    }
  }
}

function applyToTag(style, options, obj) {
  var css = obj.css;
  var media = obj.media;
  var sourceMap = obj.sourceMap;

  if (media) {
    style.setAttribute('media', media);
  } else {
    style.removeAttribute('media');
  }

  if (sourceMap && typeof btoa !== 'undefined') {
    css += "\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(sourceMap)))), " */");
  } // For old IE

  /* istanbul ignore if  */


  if (style.styleSheet) {
    style.styleSheet.cssText = css;
  } else {
    while (style.firstChild) {
      style.removeChild(style.firstChild);
    }

    style.appendChild(document.createTextNode(css));
  }
}

var singleton = null;
var singletonCounter = 0;

function addStyle(obj, options) {
  var style;
  var update;
  var remove;

  if (options.singleton) {
    var styleIndex = singletonCounter++;
    style = singleton || (singleton = insertStyleElement(options));
    update = applyToSingletonTag.bind(null, style, styleIndex, false);
    remove = applyToSingletonTag.bind(null, style, styleIndex, true);
  } else {
    style = insertStyleElement(options);
    update = applyToTag.bind(null, style, options);

    remove = function remove() {
      removeStyleElement(style);
    };
  }

  update(obj);
  return function updateStyle(newObj) {
    if (newObj) {
      if (newObj.css === obj.css && newObj.media === obj.media && newObj.sourceMap === obj.sourceMap) {
        return;
      }

      update(obj = newObj);
    } else {
      remove();
    }
  };
}

module.exports = function (list, options) {
  options = options || {}; // Force single-tag solution on IE6-9, which has a hard limit on the # of <style>
  // tags it will allow on a page

  if (!options.singleton && typeof options.singleton !== 'boolean') {
    options.singleton = isOldIE();
  }

  list = list || [];
  var lastIdentifiers = modulesToDom(list, options);
  return function update(newList) {
    newList = newList || [];

    if (Object.prototype.toString.call(newList) !== '[object Array]') {
      return;
    }

    for (var i = 0; i < lastIdentifiers.length; i++) {
      var identifier = lastIdentifiers[i];
      var index = getIndexByIdentifier(identifier);
      stylesInDom[index].references--;
    }

    var newLastIdentifiers = modulesToDom(newList, options);

    for (var _i = 0; _i < lastIdentifiers.length; _i++) {
      var _identifier = lastIdentifiers[_i];

      var _index = getIndexByIdentifier(_identifier);

      if (stylesInDom[_index].references === 0) {
        stylesInDom[_index].updater();

        stylesInDom.splice(_index, 1);
      }
    }

    lastIdentifiers = newLastIdentifiers;
  };
};

/***/ }),

/***/ "./video/res sync recursive ^\\.\\/.*$":
/*!*********************************!*\
  !*** ./video/res sync ^\.\/.*$ ***!
  \*********************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

var map = {
	"./appLogo.png": "./video/res/appLogo.png",
	"./bt_addvideomedia_blue.png": "./video/res/bt_addvideomedia_blue.png",
	"./bt_dropvideomedia_blue.png": "./video/res/bt_dropvideomedia_blue.png",
	"./bt_hangout.png": "./video/res/bt_hangout.png",
	"./bt_held_blue.png": "./video/res/bt_held_blue.png",
	"./bt_retreive_blue.png": "./video/res/bt_retreive_blue.png",
	"./dialer.png": "./video/res/dialer.png",
	"./progress.gif": "./video/res/progress.gif"
};


function webpackContext(req) {
	var id = webpackContextResolve(req);
	return __webpack_require__(id);
}
function webpackContextResolve(req) {
	if(!__webpack_require__.o(map, req)) {
		var e = new Error("Cannot find module '" + req + "'");
		e.code = 'MODULE_NOT_FOUND';
		throw e;
	}
	return map[req];
}
webpackContext.keys = function webpackContextKeys() {
	return Object.keys(map);
};
webpackContext.resolve = webpackContextResolve;
module.exports = webpackContext;
webpackContext.id = "./video/res sync recursive ^\\.\\/.*$";

/***/ }),

/***/ "./video/res/appLogo.png":
/*!*******************************!*\
  !*** ./video/res/appLogo.png ***!
  \*******************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/appLogo.png");

/***/ }),

/***/ "./video/res/bt_addvideomedia_blue.png":
/*!*********************************************!*\
  !*** ./video/res/bt_addvideomedia_blue.png ***!
  \*********************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/bt_addvideomedia_blue.png");

/***/ }),

/***/ "./video/res/bt_dropvideomedia_blue.png":
/*!**********************************************!*\
  !*** ./video/res/bt_dropvideomedia_blue.png ***!
  \**********************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/bt_dropvideomedia_blue.png");

/***/ }),

/***/ "./video/res/bt_hangout.png":
/*!**********************************!*\
  !*** ./video/res/bt_hangout.png ***!
  \**********************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/bt_hangout.png");

/***/ }),

/***/ "./video/res/bt_held_blue.png":
/*!************************************!*\
  !*** ./video/res/bt_held_blue.png ***!
  \************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/bt_held_blue.png");

/***/ }),

/***/ "./video/res/bt_retreive_blue.png":
/*!****************************************!*\
  !*** ./video/res/bt_retreive_blue.png ***!
  \****************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/bt_retreive_blue.png");

/***/ }),

/***/ "./video/res/dialer.png":
/*!******************************!*\
  !*** ./video/res/dialer.png ***!
  \******************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/dialer.png");

/***/ }),

/***/ "./video/res/progress.gif":
/*!********************************!*\
  !*** ./video/res/progress.gif ***!
  \********************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony default export */ __webpack_exports__["default"] = (__webpack_require__.p + "video/res/progress.gif");

/***/ }),

/***/ "./video/src/concatvideo.js":
/*!**********************************!*\
  !*** ./video/src/concatvideo.js ***!
  \**********************************/
/*! no exports provided */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ../../node_modules/rainbow-web-sdk/src/rainbow-sdk.min.js */ "./node_modules/rainbow-web-sdk/src/rainbow-sdk.min.js");
/* harmony import */ var _videostyles_css__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./videostyles.css */ "./video/src/videostyles.css");
/* harmony import */ var _videostyles_css__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(_videostyles_css__WEBPACK_IMPORTED_MODULE_1__);




angular.module("abs.teleconsultation.video", [
	'sdk',
	'ngResource',
    'ngSanitize',
    'satellizer',
    'ngAnimate',
    'ui.router'])
.config(function($stateProvider, $urlRouterProvider) {
    $urlRouterProvider.otherwise('/');
    $stateProvider.state('DoctorVideo', {
      url: '/videodoc/',
      templateUrl: '../video/src/views/videoview.html',
      controller: 'ExavideoController'
    })
	.state('DoctorChat', {
      url: '/chatdoc/',
      templateUrl: '../chat/src/views/chatview.html',
      controller: 'exachatController'
    });
});

angular.module('abs').requires.push('abs.teleconsultation.video');

angular.module('abs').controller("ExavideoController",['rainbowSDK',
	'$rootScope', function ($rootScope,rainbowSDK) {
    "use strict";

    /*********************************************************/
    /**                INITIALIZATION STUFF                 **/
    /*********************************************************/

    console.log("[Exadoctor] :: Teleconsultation Application");

    var appId = "16a2cce0ac1911ebbe33e9ed28980ec8";
    var appSecret = "ZphIJDzvCMURdQ61FssxmwpcMbougDmEpZwYuNRM1sro6hSkc861Vt3J8CDRyPUs"; 

    var ctrl = this;
	
    var onReady = function onReady() {
      console.log("[Exadoctor] :: Exadoctor SDK is ready!");
    };

	sdk
			.initialize(appId,appSecret)
			.then(function () {
				console.log("[Exadoctor] :: Exadoctor SDK is initialized!");
			})
		.catch(function () {
			console.log("[Exadoctor] :: Something went wrong with the SDK...");
		});

	this.initialize = function () {
      console.log("DEMO :: Rainbow Demo Application");

      document.addEventListener(rainbowSDK.RAINBOW_ONREADY, onReady);
    };

    this.initialize();
    return true;
	}	
	]);

angular.module('abs.teleconsultation.video').component('rbxConnection', {
  bindings: {
    name: '@',
  },
  controller: function rbcConnectionCtrl($rootScope, $scope) {
    $scope.isConnected = false;
	$scope.isloginPlaying=false;
	$scope.loginplaying="";
    $scope.isLoading = false;

    $scope.state = _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.getState();

    $scope.hosts = [
      {
        id: 0,
        value: 'sandbox',
        name: 'Rainbow Sandbox',
      },
      {
        id: 1,
        value: 'rainbow',
        name: 'Rainbow Official',
      },
    ];

    $scope.selectedItem = $scope.hosts[0];

    var handlers = [];

    $scope.signin = function () {
      $scope.isLoading = true;

      saveToStorage();

      switch ($scope.selectedItem.value) {
        case 'rainbow':
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection
            .signinOnRainbowOfficial($scope.user.name, $scope.user.password)
            .then(function (account) {
              console.log('[DEMO] :: Successfully signed!');
              $scope.isLoading = false;
              $scope.isConnected = true;
              $scope.$apply();
            })
            .catch(function (err) {
              console.log('[DEMO] :: Error when sign-in', err);
              $scope.isLoading = false;
              $scope.isConnected = false;
              $scope.$apply();
            });
          break;
        default:
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection
            .signin($scope.user.name, $scope.user.password)
            .then(function (account) {
              console.log('[DEMO] :: Successfully signed!');
              $scope.$apply(function () {
                $scope.isLoading = false;
                $scope.isConnected = true;
			  $scope.isloginPlaying=true;
			  $scope.loginplaying="test";
                $scope.$apply();
              });
            })
            .catch(function (err) {
              console.log('[DEMO] :: Error when sign-in', err);
              $scope.isLoading = false;
              $scope.isConnected = false;
			  $scope.isloginPlaying=false;
			  $scope.loginplaying="";
              $scope.$apply();
            });
          break;
      }
    };

    $scope.signout = function () {
      $scope.isLoading = true;
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.signout().then(function () {
        $scope.isLoading = false;
        $scope.isConnected = false;
      });
    };

    var saveToStorage = function () {
      sessionStorage.connection = angular.toJson($scope.user);
      sessionStorage.host = angular.toJson($scope.selectedItem);
    };

    var readFromStorage = function () {
      if (sessionStorage.connection) {
        $scope.user = angular.fromJson(sessionStorage.connection);
      } else {
        $scope.user = {name: '', password: ''};
      }

      if (sessionStorage.host) {
        $scope.selectedItem =
          $scope.hosts[angular.fromJson(sessionStorage.host).id];
      } else {
        $scope.selectedItem = $scope.hosts[0];
      }
    };

    var onConnectionStateChangeEvent = function onConnectionStateChangeEvent(
      event,
    ) {
      $scope.state = _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.getState();
      $scope.$apply();
    };

    this.$onInit = function () {
      // Subscribe to XMPP connection change
      handlers.push();
    };

    this.$onDestroy = function () {
      var handler = handlers.pop();
      while (handler) {
        handler();
        handler = handlers.pop();
      }
    };

    var initialize = function () {
      readFromStorage();
      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_ONCONNECTIONSTATECHANGED,
        onConnectionStateChangeEvent,
      );
    };

    initialize();
  },
  templateUrl: '../video/src/js/components/connection/connectionCmp.template.html',
});


angular.module("abs.teleconsultation.video").component("rbxContact", {
  bindings: {
    name: "@",
  },
  controller: function rbcConnectionCtrl($rootScope, $scope) {
    "use strict";

    var listeners = [];

    $scope.contacts = [
      {
        _displayName: "No recipient",
        id: "no",
        status: "offline",
        avatar: { src: null },
      },
    ];

    $scope.selectedItem = null;

    $scope.actionAudio = "Not available";
    $scope.actionVideo = "Not available";
    $scope.actionSharing = "Not available";

    $scope.presenceValue = "notAvailable";

    $scope.isAvailable = false;

    this.$onInit = function () {
      // Subscribe to XMPP connection change
      listeners.push(
        document.addEventListener(
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_ONSTARTED,
          onStart
        )
      );

      // Subscribe to XMPP connection change
      listeners.push(
        document.addEventListener(
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_ONCONNECTIONSTATECHANGED,
          onConnectionStateChangeEvent
        )
      );

      // Subscribe to contact change
      listeners.push(
        document.addEventListener(
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].contacts.RAINBOW_ONCONTACTINFORMATIONCHANGED,
          onContactsInformationChanged
        )
      );

      // Subscribe to contact change
      listeners.push(
        document.addEventListener(
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].contacts.RAINBOW_ONINFORMATIONCHANGED,
          onContactsInformationChanged
        )
      );
    };

    this.$onDestroy = function () {
      var listener = listeners.pop();
      while (listener) {
        listener();
        listener = listeners.pop();
      }
    };

    var onConnectionStateChangeEvent = function onConnectionStateChangeEvent(
      __event
    ) {
      var status = event.detail;

      if (status === _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_CONNECTIONCONNECTED) {
        $scope.isConnected = true;
      } else if (
        status === _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_CONNECTIONDISCONNECTED
      ) {
        $scope.isConnected = false;
        $scope.contacts = [
          {
            _displayName: "No recipient",
            id: "no",
            status: "offline",
            avatar: { src: null },
          },
        ];
        $scope.selectedItem = $scope.contacts[0];
        changeRecipientValue();
      }
    };

    var onStart = function onStart() {
      var contacts = _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].contacts.getAll();

      contacts = contacts.filter(function (contact) {
        return contact.id !== _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].contacts.getConnectedUser().id;
      });

      if (contacts && contacts.length) {
        $scope.contacts = contacts;
        $scope.selectedItem = $scope.contacts[0];
        changeRecipientValue();
      }
    };

    var onContactsInformationChanged = function onContactsInformationChanged(
      event
    ) {
      var contact = event.detail;
      if ($scope.selectedItem) {
        if ($scope.selectedItem.id === contact.id) {
          changeRecipientValue();
        }
      }
    };

    var changeRecipientValue = function changeRecipientValue() {
      if ($scope.selectedItem) {
        $scope.avatar = $scope.selectedItem.avatar.src;
        $scope.presenceValue = displayPresenceOfContact();
        $scope.actionAudio =
          $scope.presenceValue === "notAvailable"
            ? "Not Available"
            : $scope.presenceValue === "busy"
            ? "Busy"
            : "Audio call";
        $scope.actionVideo =
          $scope.presenceValue === "notAvailable"
            ? "Not Available"
            : $scope.presenceValue === "busy"
            ? "Busy"
            : "Call";
        $scope.actionSharing =
          $scope.presenceValue === "notAvailable"
            ? "Not Available"
            : $scope.presenceValue === "busy"
            ? "Busy"
            : "Sharing Call";
        $scope.isAvailable =
          $scope.presenceValue === "available" ? true : false;
      }
    };

    var displayPresenceOfContact = function displayPresenceOfContact() {
      switch ($scope.selectedItem.status) {
        case "online":
        case "away":
          return "available";
        case "busy":
        case "dnd":
          return "busy";
        case "offline":
        case "unknown":
        default:
          return "notAvailable";
      }
    };

    $scope.changeValue = function () {
      console.log("DEMO :: Selected recipient changed", $scope.selectedItem);
      changeRecipientValue();
    };

    $scope.callAudio = function callAudio() {
      if ($scope.selectedItem) {
        if (_node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.canMakeAudioVideoCall()) {
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.callInAudio($scope.selectedItem);
        } else {
          console.log("DEMO :: Your browser can't make audio and video call!");
        }
      }
    };

    $scope.callVideo = function callVideo() {
      if ($scope.selectedItem) {
        if (_node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.canMakeAudioVideoCall()) {
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.callInVideo($scope.selectedItem);
        } else {
          console.log("DEMO :: Your browser can't make audio and video call!");
        }
      }
    };

    $scope.callSharing = function callSharing() {
      if ($scope.selectedItem) {
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC
          .canMakeDesktopSharingCall()
          .then(function () {
            _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.callInSharing($scope.selectedItem);
          })
          .catch(function () {
            console.log("DEMO :: Your browser can't make sharing call!");
          });
      }
    };
  },
  templateUrl: "../video/src/js/components/contact/contactCmp.template.html",
});


angular.module("abs.teleconsultation.video").component("rbxController", {
  bindings: {
    name: "@",
  },
  templateUrl: "../video/src/js/components/controller/controllerCmp.template.html",
  controller:['Call',function rbcPhoneCtrl($rootScope, $scope,Call) {
    "use strict";
	scope.isPlaying=true;
	$scope.playing="testMe";
    $scope.isConnected = false;

    $scope.isInCommunication = false;

    $scope.isPIPDisplayed = true;

    $scope.isRemoteVideoDisplayed = true;

    $scope.isSpectrumDisplayed = false;

    $scope.hasLocalVideo = false; //Compute local

    $scope.hasRemoteVideo = false; // compute remote

    $scope.isCheckedDisplayed = true;

    $scope.title = "Please wait...";

    $scope.message = "The browser is checking your audio and video devices";

    var currentCall = null;

    this.$onInit = function () {
      // Subscribe to XMPP connection change
      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_ONCONNECTIONSTATECHANGED,
        onConnectionStateChangeEvent
      );

      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONWEBRTCCALLSTATECHANGED,
        onWebRTCCallChanged
      );

	
	   
	   
      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONWEBRTCTMEDIAERROROCCURED,
        onWebRTCGetUserMediaErrorOccured
      );

      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONWEBRTCTRACKCHANGED,
        onWebRTCTrackChanged
      );

      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONCONVERSATIONCHANGED,
        onConversationChanged
      );

      $rootScope.$on("DEMO_ON_CHECK_DEVICES_START", onDeviceCheckStart);

      $rootScope.$on("DEMO_ON_CHECK_DEVICES_END", onDeviceCheckEnd);

      $rootScope.$on("DEMO_ON_CHECK_DEVICES_FAILED", onDeviceCheckFailed);
    };

    this.$onDestroy = function () {};

    var onDeviceCheckStart = function onDeviceCheckStart() {
      console.log("[DEMO] :: Start checking devices...");
    };

    var onDeviceCheckEnd = function onDeviceCheckEnd() {
      $scope.$apply(function () {
        console.log("[DEMO] :: Devices checking finished!");
        $scope.isCheckedDisplayed = false;
      });
    };

    var onDeviceCheckFailed = function onDeviceCheckFailed() {
      $scope.title = "WARNING !";
      $scope.message =
        "This demo will not work on this browser (not compatible)";
    };

    var onConversationChanged = function onConversationChanged(event) {
      var conversation = event.detail;
      console.log("[DEMO] :: Conversation changed", conversation);
    };

    var onConnectionStateChangeEvent = function onConnectionStateChangeEvent(
      event
    ) {
      var status = event.detail;
      if (status === _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_CONNECTIONCONNECTED) {
        $scope.isConnected = true;
      } else if (
        status === _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_CONNECTIONDISCONNECTED
      ) {
        $scope.isConnected = false;
      }
    };

    var onWebRTCGetUserMediaErrorOccured = function onWebRTCGetUserMediaErrorOccured(
      event
    ) {
      var error = event.detail;
      console.log("[DEMO] :: WebRTC GetUserMedia error occurs", error);
    };

    var onWebRTCCallChanged = function onWebRTCCallChanged(event, call) {
      var call = event.detail;
      console.log(
        "[DEMO] :: WebRTC Call state changed to " + call.status.value,
        call
      );

      switch (call.status.value) {
        case Call.Status.RINGING_INCOMMING.value:
          if (call.remoteMedia & Call.Media.VIDEO) {
            answerInVideo(call);
          } else {
            answerInAudio(call);
          }
          break;

        case Call.Status.ACTIVE.value:
          if (call.remoteMedia & Call.Media.VIDEO) {
            displayRemoteVideo(call);
          } else {
            hideRemoteVideo(call);
          }

          if (call.localMedia & Call.Media.VIDEO) {
            displayLocalVideo(call);
          } else {
            hideLocalVideo(call);
          }
          $scope.isInCommunication = true;
          break;

        case Call.Status.UNKNOWN.value:
          hideLocalVideo();
          hideRemoteVideo(call);
          $scope.isInCommunication = false;
          break;

        default:
          console.log("[DEMO] :: Nothing to do with that event...");
          break;
      }

      currentCall = call;
    };

    var onWebRTCTrackChanged = function onWebRTCTrackChanged(event) {
      var call = event.detail;
      console.log(
        "[DEMO] :: WebRTC Track changed local|remote " +
          call.localMedia +
          "|" +
          call.remoteMedia
      );
      // Manage remote video
      if (call.remoteMedia & Call.Media.VIDEO) {
        displayRemoteVideo(call);
      } else {
        hideRemoteVideo(call);
      }
      // Manage local video
      if (call.localMedia & Call.Media.VIDEO) {
        displayLocalVideo(call);
      } else {
        hideLocalVideo(call);
      }
    };

    var answerInVideo = function answerInVideo(call) {
      console.log("[DEMO] :: Answer in video");
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.answerInVideo(call);
    };

    var answerInAudio = function answerInAudio(call) {
      console.log("[DEMO] :: Answer in audio");
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.answerInAudio(call);
    };

    var displayRemoteVideo = function displayRemoteVideo(call) {
      console.log("[DEMO] :: Display remote video");
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.showRemoteVideo(call);
      $scope.hasRemoteVideo = true;
    };

    var hideRemoteVideo = function hideRemoteVideo(call) {
      console.log("[DEMO] :: Hide remote video");
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.hideRemoteVideo(call);
      $scope.hasRemoteVideo = false;
    };

    var displayLocalVideo = function displayLocalVideo() {
      console.log("[DEMO] :: Display local video");
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.showLocalVideo();
      $scope.hasLocalVideo = true;
    };

    var hideLocalVideo = function hideLocalVideo() {
      console.log("[DEMO] :: Hide local video");
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.hideLocalVideo();
      $scope.hasLocalVideo = false;
    };

    $scope.hidePIP = function hidePIP() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.hideLocalVideo();
      $scope.isPIPDisplayed = false;
    };

    $scope.showPIP = function showPIP() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.showLocalVideo();
      $scope.isPIPDisplayed = true;
    };

    $scope.hideRemote = function hideRemote() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.hideRemoteVideo(currentCall);
      $scope.isRemoteVideoDisplayed = false;
    };

    $scope.showRemote = function showRemote() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.showRemoteVideo(currentCall);
      $scope.isRemoteVideoDisplayed = true;
    };

    $scope.addVideo = function addVideo() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.addVideoToCall(currentCall);
    };

    $scope.removeVideo = function removeVideo() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.removeVideoFromCall(currentCall);
    };

    $scope.release = function release() {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.release(currentCall);
    };

    $scope.showSpectrum = function showSpectrum() {
      $scope.isSpectrumDisplayed = true;
      $rootScope.$broadcast(
        "DEMO_ON_SPECTRUM_DISPLAY",
        $scope.isSpectrumDisplayed
      );
    };

    $scope.hideSpectrum = function hideSpectrum() {
      $scope.isSpectrumDisplayed = false;
      $rootScope.$broadcast(
        "DEMO_ON_SPECTRUM_DISPLAY",
        $scope.isSpectrumDisplayed
      );
    };

    $scope.mute = function mute() {
      var conversationId = currentCall.conversationId;
      var conversation = _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].conversations.getConversationById(
        conversationId
      );

      if (conversation) {
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.muteVideoCall(conversation);
        $scope.isMuted = true;
      }
    };

    $scope.unmute = function unmute() {
      var conversationId = currentCall.conversationId;
      var conversation = _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].conversations.getConversationById(
        conversationId
      );

      if (conversation) {
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.unmuteVideoCall(conversation);
        $scope.isMuted = false;
      }
    };
  }],
});


angular.module("abs.teleconsultation.video").component("rbxMedia", {
  bindings: {
    name: "@",
  },
  controller:function rbcPhoneCtrl($rootScope, $scope,$timeout) {
    "use strict";

    var listeners = [];

    $scope.microphones = [];

    $scope.speakers = [];

    $scope.cameras = [];

    $scope.isChrome = navigator.userAgent.toLowerCase().indexOf("chrome") > -1;
    $scope.isFirefox =
      navigator.userAgent.toLowerCase().indexOf("firefox") > -1;
    $scope.isOther = !($scope.isChrome || $scope.isFirefox);

    $timeout(function () {
      initialize();
    }, 1000);

    this.$onInit = function () {};

    var initialize = function initialize() {
      if ($scope.isChrome) {
        $rootScope.$broadcast("DEMO_ON_CHECK_DEVICES_START");

        // Enumerate the list of available media device
        navigator.mediaDevices
          .getUserMedia({ audio: true, video: true })
          .then(function (stream) {
            console.log("[DEMO] :: Get user media ok... Enumerate devices...");
            stream.getTracks().forEach(function (track) {
              track.stop();
            });
            navigator.mediaDevices
              .enumerateDevices()
              .then(gotDevices)
              .catch(handleError);
          })
          .catch(function (error) {
            console.log(
              "[DEMO] :: Unable to have access to media devices",
              error
            );
          });
      } else if ($scope.isFirefox) {
        $rootScope.$broadcast("DEMO_ON_CHECK_DEVICES_END");
      } else {
        $rootScope.$broadcast("DEMO_ON_CHECK_DEVICES_FAILED");
      }

      // Subscribe to WebRTC error
      listeners.push(
        document.addEventListener(
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONWEBRTCERRORHANDLED,
          onWebRTCErrorHandled
        )
      );
    };

    var onWebRTCErrorHandled = function onWebRTCErrorHandled(event) {
      var error = event.detail;
      console.log("[DEMO] :: WebRTC Error", error);
      $rootScope.$broadcast("DEMO_ON_CHECK_DEVICES_END");
    };

    var gotDevices = function gotDevices(devices) {
      devices.forEach(function (device) {
        switch (device.kind) {
          case "audioinput":
            $scope.microphones.push(device);
            break;
          case "audiooutput":
            $scope.speakers.push(device);
            break;
          case "videoinput":
            $scope.cameras.push(device);
            break;
          default:
            console.log("Strange...", device);
            break;
        }
      });

      if ($scope.microphones.length === 0) {
        $scope.microphones.push({
          deviceId: "default",
          groupId: "2029518264",
          kind: "audioinput",
          label: "No microphone",
        });
      }

      if ($scope.speakers.length === 0) {
        $scope.speakers.push({
          deviceId: "default",
          groupId: "2029518264",
          kind: "audioinput",
          label: "No speaker",
        });
      }

      if ($scope.cameras.length === 0) {
        $scope.cameras.push({
          deviceId: "default",
          groupId: "2029518264",
          kind: "audioinput",
          label: "No camera",
        });
      }
      $scope.$apply(function () {
        $scope.selectedMicrophone = $scope.microphones[0];
        $scope.selectedSpeaker = $scope.speakers[0];
        $scope.selectedCamera = $scope.cameras[0];
      });

      $rootScope.$broadcast("DEMO_ON_CHECK_DEVICES_END");
    };

    var handleError = function handleError(error) {
      console.log("[DEMO] :: Devices error", error);
      $rootScope.$broadcast("DEMO_ON_CHECK_DEVICES_END");
    };

    this.$onDestroy = function () {};

    $scope.changeMicrophone = function () {
      console.log(
        "[DEMO] :: Change microphone to " + $scope.selectedMicrophone.label
      );
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.useMicrophone($scope.selectedMicrophone.deviceId);
    };

    $scope.changeSpeaker = function () {
      console.log(
        "[DEMO] :: Change speaker to " + $scope.selectedSpeaker.label
      );
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.useSpeaker($scope.selectedSpeaker.deviceId);
    };

    $scope.changeCamera = function () {
      console.log("[DEMO] :: Change camera to " + $scope.selectedCamera.label);
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.useCamera($scope.selectedCamera.deviceId);
    };
  },
  templateUrl: "../video/src/js/components/media/mediaCmp.template.html",
});


angular.module("abs.teleconsultation.video").component("rbxSpectrum", {
  bindings: {},

  templateUrl: "../video/src/js/components/spectrum/spectrumCmp.template.html",

  controller:['Call', function rbcPhoneCtrl($rootScope, $scope, Call) {
    "use strict";

    var audioContext = new AudioContext();
    var ctx = null;
    var gradient = null;
    var javascriptNode = null;
    var remoteMediaStream = null;
    var analyser = null;
    var isSpectrumStarted = false;

    $scope.isInCommunication = false;
    $scope.isSpectrumDisplayed = false;

    this.$onInit = function () {
      // get the context from the canvas to draw on
      ctx = $("#canvasSound").get()[0].getContext("2d");

      // create a gradient for the fill. Note the strange
      // offset, since the gradient is calculated based on
      // the canvas, not the specific element we draw
      gradient = ctx.createLinearGradient(0, 0, 100, 0);

      gradient.addColorStop(1, "red");
      gradient.addColorStop(0.83, "orange");
      gradient.addColorStop(0.66, "yellow");
      gradient.addColorStop(0.5, "green");
      gradient.addColorStop(0.33, "blue");
      gradient.addColorStop(0.16, "indigo");
      gradient.addColorStop(0, "violet");

      // Subscribe to contact change
      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONWEBRTCCALLSTATECHANGED,
        onWebRTCCallChanged
      );

      document.addEventListener(
        _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].webRTC.RAINBOW_ONWEBRTCSTREAMADDED,
        onWebRTCStreamAdded
      );

      $rootScope.$on(
        "$destroy",
        $rootScope.$on("DEMO_ON_SPECTRUM_DISPLAY", onSpectrumDisplayChanged)
      );
    };

    this.$onDestroy = function () {};

    var onWebRTCStreamAdded = function onWebRTCStreamAdded(event) {
      var streams = event.detail;
      console.log("[DEMO] :: >>> WebRTC stream added", streams);
      if (!isSpectrumStarted) {
        startSpectrum(streams);
      }
    };

    var onSpectrumDisplayChanged = function onSpectrumDisplayChanged(
      __event,
      isDisplayed
    ) {
      $scope.isSpectrumDisplayed = isDisplayed;
    };

    var onWebRTCCallChanged = function onWebRTCCallChanged(event) {
      var call = event.detail;

      switch (call.status.value) {
        case Call.Status.RINGING_INCOMMING.value:
          break;

        case Call.Status.ACTIVE.value:
          $scope.isInCommunication = true;
          break;

        case Call.Status.UNKNOWN.value:
          $scope.isInCommunication = false;
          stopSpectrum();
          break;

        default:
          break;
      }
    };

    var drawSpectrum = function drawSpectrum(array) {
      for (var i = 0; i < array.length; i++) {
        var value = array[i];
        ctx.fillRect(0, i * 3, value / 2.56, 2);
      }
    };

    var stopSpectrum = function stopSpectrum() {
      isSpectrumStarted = false;

      if (javascriptNode) {
        javascriptNode.disconnect();
      }

      if (remoteMediaStream) {
        remoteMediaStream.disconnect();
      }

      if (analyser) {
        analyser.disconnect();
      }
    };

    var startSpectrum = function manageSpectrum(streams) {
      console.log("[DEMO] :: WebRTC manageSpectrum");

      var listOfRemoteStreams = streams;

      var nWhichStream = 0;

      // Error ?  Bad call ?
      if (listOfRemoteStreams.length > 0) {
        console.log(
          "[DEMO] :: WebRTC manageSpectrum streams",
          listOfRemoteStreams
        );

        // Which stream ?
        if (listOfRemoteStreams.length > 1) {
          // TODO
          nWhichStream = 0;
        }

        // check for the stream
        var audioTracks = listOfRemoteStreams[nWhichStream].getAudioTracks();

        console.log("[DEMO] :: WebRTC manageSpectrum streams", audioTracks);

        if (audioTracks && audioTracks.length === 1) {
          // Get the remote stream and use it in the Audio stream
          remoteMediaStream = audioContext.createMediaStreamSource(
            listOfRemoteStreams[nWhichStream]
          );
          javascriptNode = audioContext.createScriptProcessor(1024, 1, 1);

          remoteMediaStream.connect(javascriptNode);

          // setup a analyzer
          analyser = audioContext.createAnalyser();
          analyser.smoothingTimeConstant = 0.3;
          analyser.fftSize = 512;

          // create a buffer source node
          remoteMediaStream.connect(analyser);
          analyser.connect(javascriptNode);
          javascriptNode.connect(audioContext.destination);

          isSpectrumStarted = true;

          javascriptNode.onaudioprocess = function (__event) {
            // get the average for the first channel
            var array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array);

            // clear the current state
            //ctx.clearRect(0, 0, 500, 100);
            ctx.clearRect(0, 0, 100, 500);
            //ctx.fillRect(0, 0, 500, 20);

            // set the fill style
            ctx.fillStyle = gradient;
            drawSpectrum(array);
          };
        }
      } else {
        console.log("[DEMO] :: WebRTC manageSpectrum no stream found");
      }
    };
  }],
   
  
  
})
 
angular.module("abs.teleconsultation.video").component("rbxConversation", {
  bindings: {
    item: "=",
  },
  controller:  function ($rootScope, $scope) {
    var ctrl = $scope;

    var handlers = [];

    $scope.message = "";

    $scope.onSend = function () {
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].im.sendMessageToConversation(
        $scope.conversation,
        $scope.message
      );
      $scope.message = "";
    };

    var onConversationChanged = function onConversationChanged() {
      setTimeout(function () {
        var containerHeight = $(".conversation-" + ctrl.conversation.dbId)[0]
          .scrollHeight;
        var container = angular.element(
          ".conversation-" + ctrl.conversation.dbId
        );
        container.animate({ scrollTop: containerHeight }, 100);
      }, 100);
    };

    this.$onInit = function () {
      $scope.contact = this.item.contact;

      $scope.conversation = this.item;

      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].im
        .getMessagesFromConversation(this.item, 50)
        .then(function (__messages) {
          onConversationChanged();
        });

      // Subscribe to XMPP connection change
      handlers.push($rootScope.$on(this.item.id, onConversationChanged));

      var container = angular.element(
        ".conversation-" + ctrl.conversation.dbId
      );

      container.on("scroll", function (__event) {
        if (container.scrollTop() <= 0) {
          //Load older messages
          _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].im
            .getMessagesFromConversation($scope.conversation, 30)
            .then(function () {})
            .catch(function () {});
        }
      });
    };

    this.$onDestroy = function () {
      var handler = handlers.pop();
      while (handler) {
        handler();
        handler = handlers.pop();
      }
    };
  },
  templateUrl:"../chat/src/js/components/conversations/conversationCmp.template.html",
});



angular.module("abs.teleconsultation.video").component("rbxConversations", {
  bindings: {
    name: "@",
    conversations: "=",
  },
  controller:function rbcConnectionsCtrl($rootScope, $scope, $timeout) {
    $scope.conversations = [];

    var getAllOneToOneConversations = function getAllOneToOneConversations() {
      var conversations = _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].conversations.getAllConversations();

      var oneToOneConversations = [];

      conversations.forEach(function (conversation) {
        if (conversation.type === 0) {
          oneToOneConversations.push(conversation);
        }
      });

      return oneToOneConversations;
    };

    var onConnectionStateChangeEvent = function onConnectionStateChangeEvent(
      event,
      status
    ) {
      if (status === _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_CONNECTIONCONNECTED) {
        $scope.conversations = getAllOneToOneConversations();
      } else {
        $scope.conversations = [];
      }
    };

    var onConversationsListChanged = function onConversationsListChanged(
      event,
      conversation
    ) {
      $scope.conversations = $scope.conversations = getAllOneToOneConversations();
    };

    var onConversationChanged = function (__event, conversationID) {
      $rootScope.$broadcast(conversationID, null);
    };

    document.addEventListener(
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].conversations.RAINBOW_ONCONVERSATIONSCHANGED,
      onConversationsListChanged
    );

    document.addEventListener(
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].conversations.RAINBOW_ONCONVERSATIONREMOVED,
      onConversationsListChanged
    );

    document.addEventListener(
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].connection.RAINBOW_ONCONNECTIONSTATECHANGED,
      onConnectionStateChangeEvent
    );

    document.addEventListener(
      _node_modules_rainbow_web_sdk_src_rainbow_sdk_min_js__WEBPACK_IMPORTED_MODULE_0__["default"].conversations.RAINBOW_ONCONVERSATIONCHANGED,
      onConversationChanged
    );
  },
  templateUrl: "../chat/src/js/components/conversations/conversationsCmp.template.html",
});


angular.module("abs.teleconsultation.video").component("rbxMessage", {
  bindings: {
    item: "<",
  },
  controller: function ($rootScope,$scope,$interval) {
    var ctrl = $scope;

    this.$onInit = function () {
      var updateDateFields = function () {
        var mdate = moment($scope.$ctrl.item.date);

        if (moment().diff(mdate, "days") == 0) {
          return mdate.fromNow();
        } else {
          return mdate.format("lll");
        }
        return d;
      };

      $scope.date = updateDateFields();

      // Arm update date timer
      $interval(
        function ($scope) {
          ctrl.date = updateDateFields();
          ctrl.$apply();
        },
        30000,
        0,
        false
      );
    };
  },
  templateUrl: "../chat/src/js/components/conversations/messageCmp.template.html",
});

  

;




/***/ }),

/***/ "./video/src/videostyles.css":
/*!***********************************!*\
  !*** ./video/src/videostyles.css ***!
  \***********************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

var api = __webpack_require__(/*! ../../node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js */ "./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js");
            var content = __webpack_require__(/*! !../../node_modules/css-loader/dist/cjs.js!./videostyles.css */ "./node_modules/css-loader/dist/cjs.js!./video/src/videostyles.css");

            content = content.__esModule ? content.default : content;

            if (typeof content === 'string') {
              content = [[module.i, content, '']];
            }

var options = {};

options.insert = "head";
options.singleton = false;

var update = api(content, options);



module.exports = content.locals || {};

/***/ }),

/***/ 0:
/*!**************************************************************************!*\
  !*** multi ./app/scripts/app.js ./video/src/concatvideo.js ./copyres.js ***!
  \**************************************************************************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

__webpack_require__(/*! /Users/navneetkumar/Desktop/workspace/Pankaj/webpak/exaconsultationvideoconv/app/scripts/app.js */"./app/scripts/app.js");
__webpack_require__(/*! /Users/navneetkumar/Desktop/workspace/Pankaj/webpak/exaconsultationvideoconv/video/src/concatvideo.js */"./video/src/concatvideo.js");
module.exports = __webpack_require__(/*! /Users/navneetkumar/Desktop/workspace/Pankaj/webpak/exaconsultationvideoconv/copyres.js */"./copyres.js");


/***/ })

/******/ });
//# sourceMappingURL=mix.js.map